<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="xiaowu&#39;s blog">
<meta property="og:url" content="https://zhouxiaowu.coding.me/index.html">
<meta property="og:site_name" content="xiaowu&#39;s blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="xiaowu&#39;s blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhouxiaowu.coding.me/"/>





  <title>xiaowu's blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3da41265a1a0042eebe5413c0d6c76f5";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">xiaowu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/08/02/Spark原理案例及搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/02/Spark原理案例及搭建/" itemprop="url">Spark原理案例及搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-02T09:58:44+08:00">
                2019-08-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/08/02/Spark原理案例及搭建/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/08/02/Spark原理案例及搭建/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.3k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  10
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文基于Spark 2.3.1    scala 2.11</p>
<h1 id="RDD算子"><a href="#RDD算子" class="headerlink" title="RDD算子"></a>RDD算子</h1><p>a <em>resilient distributed dataset</em> (RDD), which is a collection of elements partitioned across the nodes of the cluster that can be operated on in parallel</p>
<p><img src="/2019/08/02/Spark原理案例及搭建/01.jpg" alt=""></p>
<h2 id="Transformation算子"><a href="#Transformation算子" class="headerlink" title="Transformation算子"></a>Transformation算子</h2><p><a href="http://spark.apache.org/docs/latest/rdd-programming-guide.html#transformations" target="_blank" rel="external">http://spark.apache.org/docs/latest/rdd-programming-guide.html#transformations</a></p>
<p>懒执行，返回值依然是RDD</p>
<ul>
<li>map</li>
<li>filter</li>
<li>flatMap</li>
<li>groupByKey</li>
<li>reduceByKey</li>
<li>mapValues</li>
<li>sort</li>
</ul>
<h2 id="Action算子"><a href="#Action算子" class="headerlink" title="Action算子"></a>Action算子</h2><p><a href="http://spark.apache.org/docs/latest/rdd-programming-guide.html#actions" target="_blank" rel="external">http://spark.apache.org/docs/latest/rdd-programming-guide.html#actions</a></p>
<p>触发真正执行，返回值不再是RDD</p>
<h3 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h3><p>不需要根据key分组，直接进行聚合，reduce双子没必要必须作用在KV格式的RDD上</p>
<h3 id="collect"><a href="#collect" class="headerlink" title="collect"></a>collect</h3><p>将RDD的元素收集回来，收集到一个集合中。<strong>慎用，一般在测试环境使用</strong></p>
<p><img src="/2019/08/02/Spark原理案例及搭建/02.jpg" alt=""></p>
<h3 id="count"><a href="#count" class="headerlink" title="count"></a>count</h3><h1 id="RDD持久化"><a href="#RDD持久化" class="headerlink" title="RDD持久化"></a>RDD持久化</h1><p><a href="http://spark.apache.org/docs/latest/rdd-programming-guide.html#rdd-persistence" target="_blank" rel="external">http://spark.apache.org/docs/latest/rdd-programming-guide.html#rdd-persistence</a></p>
<h3 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h3><ul>
<li>cache算子将数据保存到内存中</li>
<li><p>cache算子是懒加载算子，需要Action算子触发执行</p>
</li>
<li><p>cache 是 persist简化版</p>
</li>
</ul>
<p><code>StorageLevel</code> 半生对象</p>
<p>deseriliezd 不序列化的意思，</p>
<p>序列化，占用空间小</p>
<h3 id="persist"><a href="#persist" class="headerlink" title="persist"></a>persist</h3><h4 id="StorageLevel"><a href="#StorageLevel" class="headerlink" title="StorageLevel"></a>StorageLevel</h4><p>优先级</p>
<ul>
<li>MEMORY_ONLY   只放内存，不够放弃。释放：1.自动ttl，2.手动释放内存 unpersist。</li>
<li>MEMORY_ONLY_SER</li>
<li>MEMORY_AND_DISK_SER  内存放不了，再放磁盘</li>
<li>DISK_ONLY 不建议使用</li>
</ul>
<p>一个action算子，就是一个Job</p>
<h1 id="standlone部署"><a href="#standlone部署" class="headerlink" title="standlone部署"></a>standlone部署</h1><h2 id="spark-env-sh-修改"><a href="#spark-env-sh-修改" class="headerlink" title="spark-env.sh 修改"></a>spark-env.sh 修改</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># masterIP</span></span><br><span class="line"><span class="attr">SPARK_MASTER_HOST</span>=node01</span><br><span class="line"><span class="comment"># master通信端口</span></span><br><span class="line"><span class="attr">SPARK_MASTER_PORT</span>=<span class="number">7077</span></span><br><span class="line"><span class="comment"># 心跳超时时间</span></span><br><span class="line"><span class="attr">SPARK_MASTER_OPTS</span>=<span class="string">"-Dspark.worker.timeout=100"</span></span><br><span class="line"><span class="comment"># webUI端口</span></span><br><span class="line"><span class="attr">SPARK_MASTER_WEBUI_PORT</span>=<span class="number">8888</span></span><br><span class="line"><span class="comment"># 日志存放位置</span></span><br><span class="line"><span class="attr">SPARK_LOCAL_DIRS</span>=<span class="string">"/var/zfg/spark"</span></span><br><span class="line"><span class="comment"># worker进程所管理的核心数</span></span><br><span class="line"><span class="attr">SPARK_WORKER_CORES</span>=<span class="number">2</span></span><br><span class="line"><span class="comment"># worker进程所管理的内存数</span></span><br><span class="line"><span class="attr">SPARK_WORKER_MEMORY</span>=<span class="number">3</span>G</span><br><span class="line"><span class="comment"># 计算工作区</span></span><br><span class="line"><span class="attr">SPARK_WORKER_DIR</span>=<span class="string">"/var/zfg/spark/work"</span></span><br><span class="line"><span class="comment"># 工作区文件的有效期</span></span><br><span class="line"><span class="attr">SPARK_WORKER_OPTS</span>=<span class="string">"-Dspark.worker.cleanup.enabled=true -Dspark.worker.cleanup.appDataTtl=259200"</span></span><br></pre></td></tr></table></figure>
<h2 id="slave修改"><a href="#slave修改" class="headerlink" title="slave修改"></a>slave修改</h2><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">node02</span></span><br><span class="line"><span class="symbol">node03</span></span><br><span class="line"><span class="symbol">node04</span></span><br></pre></td></tr></table></figure>
<p>sbin的目录下的spark-config.sh 文件下添加</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">JAVA_HOME</span>=/usr/install/jdk/jdk1.8.0_171</span><br></pre></td></tr></table></figure>
<h2 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h2><p>配置环境变量，sbin bin添加到path</p>
<p>start-all.sh  改名start-spark.sh</p>
<h2 id="scp到node02-node03-node04"><a href="#scp到node02-node03-node04" class="headerlink" title="scp到node02 node03 node04"></a>scp到node02 node03 node04</h2><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>启动 start-spark.sh</p>
<p>访问 <a href="http://node01:8888" target="_blank" rel="external">http://node01:8888</a></p>
<h2 id="动态添加worker"><a href="#动态添加worker" class="headerlink" title="动态添加worker"></a>动态添加worker</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./sbin/<span class="keyword">start</span>-slave.sh &lt;<span class="keyword">master</span>-spark-<span class="keyword">URL</span>&gt;</span><br></pre></td></tr></table></figure>
<h1 id="spark-shell"><a href="#spark-shell" class="headerlink" title="spark shell"></a>spark shell</h1><p>集群方式</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/spark-shell --<span class="keyword">master</span> <span class="title">spark</span>://IP:PORT</span><br></pre></td></tr></table></figure>
<p>本地方式</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/spark-<span class="keyword">shell</span><span class="bash"></span></span><br></pre></td></tr></table></figure>
<h2 id="REPL"><a href="#REPL" class="headerlink" title="REPL"></a>REPL</h2><p>读、执行、打印、循环</p>
<h1 id="standalone-HA部署"><a href="#standalone-HA部署" class="headerlink" title="standalone HA部署"></a>standalone HA部署</h1><p><a href="http://spark.apache.org/docs/latest/spark-standalone.html#high-availability" target="_blank" rel="external">Spark Standalone Mode - Spark 2.4.3 Documentation</a></p>
<p><a href="http://spark.apache.org/docs/latest/configuration.html#deploy" target="_blank" rel="external">Configuration - Spark 2.4.3 Documentation</a></p>
<p><img src="/2019/08/02/Spark原理案例及搭建/03.jpg" alt=""></p>
<ul>
<li>处于active状态的master，会将收集的元信息放到zookeeper，包括worker个数，地址。</li>
<li>备用master监听zk，通知active挂了。备用master会从zk中读取元数据到内存，通知worker以后的主、心跳发送</li>
</ul>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>SPARK_DAEMON_JAVA_OPTS in spark-env by configuring <code>spark.deploy.recoveryMode</code> and related spark.deploy.zookeeper.* configurations.</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">SPARK_DAEMON_JAVA_OPTS</span>=<span class="string">"-Dspark.deploy.recoveryMode=ZOOKEEPER spark.deploy.zookeeper.url=node02:2181,node03:2181,node04:2181 -Dspark.deploy.zookeeper.dir=spark201908"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>将spark-env.sh 同步到其他节点</li>
<li>启动start-spark.sh，发现只有一个master</li>
<li>在node02中，修改<code>SPARK_MASTER_HOST=node02</code>，再 start-master启动</li>
</ul>
<p>备用 node02 start-master.sh<br>Master=node02</p>
<p>RECAVering 准备切换状态</p>
<h1 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h1><ul>
<li>Master(standalone)：资源管理的主节点(进程)</li>
<li>Cluster Manager：在集群上获取资源的外部服务(例如standalone,Mesos,Yarn )</li>
<li>Worker Node(standalone)：资源管理的从节点(进程) 或者说管理本机资源的进程</li>
<li><p>Application：基于Spark的⽤用户程序，包含了driver程序和运行在集群上的executor程序</p>
</li>
<li><p>Driver Program：用来连接工作进程（Worker）的程序</p>
</li>
<li><p>Executor：是在一个worker进程所管理的节点上为某Application启动的⼀一个进程，该进</p>
</li>
</ul>
<p>程负责运行任务，并且负责将数据存在内存或者磁盘上。每个应⽤用都有各自独⽴立的</p>
<p>executors</p>
<ul>
<li><p>Task：被送到某个executor上的工作单元</p>
</li>
<li><p>Job：包含很多任务(Task)的并行计算，可以看做和action对Job：包含很多任务(Task)的并行计算，可以看做和action对v应</p>
</li>
<li><p>Stage：⼀个Job会被拆分很多组任务，每组任务被称为Stage(就像Mapreduce分map task</p>
</li>
</ul>
<p>和reduce task一样)</p>
<h1 id="宽依赖"><a href="#宽依赖" class="headerlink" title="宽依赖"></a>宽依赖</h1><p><img src="/2019/08/02/Spark原理案例及搭建/04.jpg" alt=""></p>
<ul>
<li><p>宽依赖：父RDD的分区：子RDD的分区，1对多</p>
</li>
<li><p>导致宽依赖的算子: groupByKey</p>
</li>
<li>宽依赖和shuffle是一一对应的</li>
</ul>
<h1 id="窄依赖"><a href="#窄依赖" class="headerlink" title="窄依赖"></a>窄依赖</h1><ul>
<li>map fitler</li>
<li>union 不会导致宽依赖</li>
<li>窄依赖一般不会发生shuffle</li>
</ul>
<h1 id="Stage切割规则"><a href="#Stage切割规则" class="headerlink" title="Stage切割规则"></a>Stage切割规则</h1><p><img src="/2019/08/02/Spark原理案例及搭建/05.jpg" alt=""></p>
<ul>
<li>按宽依赖进行划分，连着的窄依赖为一个stage</li>
<li>正是有了宽窄依赖，才能将job切分成一个个stage</li>
<li>一个stage的task个数（并发数），以最后一个RDD的分区数为准</li>
</ul>
<h1 id="pipeline操作"><a href="#pipeline操作" class="headerlink" title="pipeline操作"></a>pipeline操作</h1><p><img src="/2019/08/02/Spark原理案例及搭建/06.jpg" alt=""></p>
<ul>
<li>一个stage内（都是窄依赖）进行pipeline操作</li>
<li>计算向数据移动，C、D、F的计算都可以移动到C操作</li>
<li>为什么有懒执行算子，就是为了构建pipeline，增加并行度</li>
</ul>
<h2 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h2><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">val <span class="attr">RDD</span> = sc.textFile(hdfs)</span><br><span class="line">val <span class="attr">filterRDD</span> = RDD.filter(<span class="attr">x</span> =&gt; x.contains(<span class="string">"Ab"</span>))</span><br><span class="line">val <span class="attr">mapRDD</span> = filterRDD.<span class="built_in">map</span>(<span class="attr">x</span> =&gt; x+<span class="string">"~"</span>)</span><br><span class="line">val <span class="attr">flatMapRDD</span> = mapRDD.flatMap(<span class="attr">x</span> =&gt; x.split(<span class="string">" "</span>))</span><br><span class="line">flatMapRDD.collect</span><br></pre></td></tr></table></figure>
<p><img src="/2019/08/02/Spark原理案例及搭建/07.jpg" alt=""></p>
<ul>
<li>task1最好在B1执行</li>
<li>task2最好在B2执行</li>
</ul>
<h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><p>管道中的数据什么时候持久化到磁盘</p>
<ol>
<li>shuttle 的write的阶段（stage和stage之间，shuttfle write 和 shuttfle read）</li>
<li>对一个RDD执行了持久化算子(persist)</li>
</ol>
<h1 id="任务调度"><a href="#任务调度" class="headerlink" title="任务调度"></a>任务调度</h1><p><img src="/2019/08/02/Spark原理案例及搭建/09.png" alt=""></p>
<h2 id="任务重试"><a href="#任务重试" class="headerlink" title="任务重试"></a>任务重试</h2><ul>
<li>默认值重试3次 ， 加上1次，一共4次。重试次数为4-1=3</li>
</ul>
<p><a href="http://spark.apache.org/docs/latest/configuration.html#scheduling" target="_blank" rel="external">http://spark.apache.org/docs/latest/configuration.html#scheduling</a></p>
<table>
<thead>
<tr>
<th>spark.task.maxFailures</th>
<th>4</th>
<th>Number of failures of any particular task before giving up on the job. The total number of failures spread across different tasks will not cause the job to fail; a particular task has to fail this number of attempts. Should be greater than or equal to 1. Number of allowed retries = this value - 1.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>1.代码配置</p>
<p>2.spark-default.xml配置文件</p>
<p>3.提交Application的时候，<strong>常用</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-submit --conf spark<span class="selector-class">.task</span><span class="selector-class">.maxFailures</span>=<span class="number">10</span></span><br></pre></td></tr></table></figure>
<h3 id="挣扎的任务"><a href="#挣扎的任务" class="headerlink" title="挣扎的任务"></a>挣扎的任务</h3><p>TaskScheduler负责任务的重试，和挣扎的任务(推测执行)</p>
<ul>
<li>推测过程</li>
</ul>
<p>75%的任务都执行完成后，会每隔100ms来鉴定一次剩余的task是否是挣扎的task。鉴定过程：25task的执行时间，按照执行时间来排序，取中位数10s，10s*1.5倍数=15s。25task中大于这个15s的任务就是挣扎的任务。</p>
<table>
<thead>
<tr>
<th><code>spark.speculation</code></th>
<th>false</th>
<th>If set to “true”, performs speculative execution of tasks. This means if one or more tasks are running slowly in a stage, they will be re-launched.</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>spark.speculation.interval</code></td>
<td>100ms</td>
<td>How often Spark will check for tasks to speculate.</td>
</tr>
<tr>
<td><code>spark.speculation.multiplier</code></td>
<td>1.5</td>
<td>How many times slower a task is than the median to be considered for speculation.</td>
</tr>
<tr>
<td><code>spark.speculation.quantile</code></td>
<td>0.75</td>
<td>Fraction of tasks which must be complete before speculation is enabled for a particular stage.</td>
</tr>
</tbody>
</table>
<h2 id="stage重试"><a href="#stage重试" class="headerlink" title="stage重试"></a>stage重试</h2><p>DAGScheduler负责重试stage，默认重试次数为4</p>
<table>
<thead>
<tr>
<th><code>spark.stage.maxConsecutiveAttempts</code></th>
<th>4</th>
<th>Number of consecutive stage attempts allowed before a stage is aborted.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="单机执行3h，Spark并行执行却要12h？？"><a href="#单机执行3h，Spark并行执行却要12h？？" class="headerlink" title="单机执行3h，Spark并行执行却要12h？？"></a>单机执行3h，Spark并行执行却要12h？？</h2><ul>
<li>可能发生数据倾斜，99task 100M，1task 1T-100M</li>
<li>可能开启了推测执行，那么很有可能1task为挣扎的task，那么TaskScheduler会新起一个task和挣扎的task比赛执行</li>
</ul>
<p>解决方案：</p>
<ol>
<li>关闭推测执行</li>
<li>解决数据倾斜问题</li>
</ol>
<h1 id="资源调度"><a href="#资源调度" class="headerlink" title="资源调度"></a>资源调度</h1><p><img src="/2019/08/02/Spark原理案例及搭建/08.png" alt=""></p>
<p>DAGScheduler taskshceduler  存在于driver中</p>
<ul>
<li><p>为了防止master压力过大，都要增加client</p>
</li>
<li><p>client spark-submit  通过执行Main函数，启动一个driver进程。创建sparkContext，同时创建两个对象，DAGScheduler,TaskScheduler。</p>
</li>
</ul>
<h2 id="资源调度过程"><a href="#资源调度过程" class="headerlink" title="资源调度过程"></a>资源调度过程</h2><ol>
<li><p>TaskScheduler创建成功后，会找master，给当前application申请资源。</p>
</li>
<li><p>master会查看自己的资源情况，告诉worker节点，启动一个executor进程。<strong>默认使用1G内存，所有核。</strong></p>
</li>
<li>excutor启动成功后，会反向注册给TaskScheduler</li>
<li><p>DAGScheduler，根据RDD的宽窄依赖切分stage，将一个个stage提交给taskSehduler</p>
</li>
<li><p>TaskScheduler，接收到stage之后，遍历拿到每个task，调用HDFS的方法，得到block位置。将task分发到数据节点执行。</p>
</li>
</ol>
<h3 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h3><ul>
<li><strong>完全一致部署，也不能避免数据移动。也有可能从其他节点拉取数据，在节点计算。</strong></li>
<li><strong>启动Exetor或者申请资源，不会考虑数据的位置。</strong></li>
</ul>
<p>对比</p>
<table>
<thead>
<tr>
<th></th>
<th>Spark</th>
<th>MR on YARN</th>
</tr>
</thead>
<tbody>
<tr>
<td>类型</td>
<td>粗粒度的资源调度</td>
<td>细粒度的资源调度</td>
</tr>
<tr>
<td>过程</td>
<td>在提交Application的时候，taskScheduler先去申请资源。然后taskScheduler分发任务，执行所有task执行完毕，才释放这部分资源。</td>
<td>在提交Applicaiton的时候，先向数据节点分发task，task自己去申请资源。如果申请到了资源，立即执行。否则一直等待。当task执行完毕，立即释放资源。</td>
</tr>
<tr>
<td>优点</td>
<td>1. 每一个task的等待时间变短了 2.可以资源复用</td>
<td>集群资源能充分利用</td>
</tr>
<tr>
<td>缺点</td>
<td>10000task  9999task 1task没执行完，无法充分利用集群资源</td>
<td>task的等待时间太长</td>
</tr>
</tbody>
</table>
<h2 id="源码解读"><a href="#源码解读" class="headerlink" title="源码解读"></a>源码解读</h2><p><img src="/2019/08/02/Spark原理案例及搭建/10.png" alt=""></p>
<ul>
<li>worker进程启动成功后，会向master注册，发送worker的管理的资源信息</li>
<li>当worker启动完毕后，会定期向master发送心跳，此时不会携带worker的资源信息，只会携带当前worker的id号。</li>
<li>默认情况下，每一个worker节点为当前的Application指定启动一个1executor，这个executor默认使用1G 所有的core</li>
</ul>
<ol>
<li>client指定driver不在本地执行，为Driver申请资源，1G 1core</li>
<li>master查询workers信息，随机指定worker2启动启动Driver进程。</li>
</ol>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-submit <span class="params">--class</span> org.apache.spark.examples.SparkPi <span class="params">--master</span> spark:<span class="string">//node01</span><span class="function">:7077</span> <span class="params">--deploy-mode</span> cluster <span class="params">--driver-memory</span> 1g <span class="params">--num-executors</span> 2 <span class="params">--executor-memory</span> 1g <span class="params">--executor-cores</span> 1 <span class="string">/opt/sxt/spark-2.3.1/examples/jars/spark-examples_2.11-2.3.1.jar</span></span><br></pre></td></tr></table></figure>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-submit <span class="params">--class</span> org.apache.spark.examples.SparkPi <span class="params">--master</span> spark:<span class="string">//node01</span><span class="function">:7077</span> <span class="params">--deploy-mode</span> cluster <span class="params">--total-executor-cores=6</span> <span class="params">--executor-memory</span> 1g <span class="params">--executor-cores</span> 1 <span class="string">/opt/sxt/spark-2.3.1/examples/jars/spark-examples_2.11-2.3.1.jar</span></span><br></pre></td></tr></table></figure>
<p>`</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark<span class="selector-class">.deploy</span><span class="selector-class">.spreadOut</span>=true</span><br></pre></td></tr></table></figure>
<ul>
<li><p>默认情况下（在提交Application的时候，没有指定–executor-cores），每一个worker节点为当前的Application只启动1个Executor，这个Executor使用所有的核</p>
</li>
<li><p>如果想要一个Worker节点上启动多个Executor，那么在提交Application的时候需要指定<code>--executor-cores</code>这个选项</p>
</li>
<li><p><code>spark.deploy.spreadOut</code>默认为true，表示轮询在workers启动executor</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-submit <span class="params">--class</span> org.apache.spark.examples.SparkPi <span class="params">--master</span> spark:<span class="string">//node01</span><span class="function">:7077</span> <span class="params">--deploy-mode</span> cluster <span class="params">--total-executor-cores=6</span> <span class="params">--executor-memory</span> 1g <span class="params">--executor-cores</span> 1 <span class="params">--spark</span>.<span class="keyword">deploy</span>.spreadOut <span class="literal">false</span> <span class="string">/opt/sxt/spark-2.3.1/examples/jars/spark-examples_2.11-2.3.1.jar</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>参考</p>
<blockquote>
<p><a href="https://spark.apache.org/docs/latest/spark-standalone.html" target="_blank" rel="external">https://spark.apache.org/docs/latest/spark-standalone.html</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/06/23/storm搭建及原理分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/23/storm搭建及原理分析/" itemprop="url">storm搭建及原理分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-23T11:44:50+08:00">
                2019-06-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/23/storm搭建及原理分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/06/23/storm搭建及原理分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  7
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><a href="http://storm.apache.org/" target="_blank" rel="external">http://storm.apache.org/</a></p>
</blockquote>
<h2 id="编程模型"><a href="#编程模型" class="headerlink" title="编程模型"></a>编程模型</h2><p><img src="/2019/06/23/storm搭建及原理分析/pic3.png" alt="pic1"></p>
<h3 id="DAG-（Topology）有向无环图"><a href="#DAG-（Topology）有向无环图" class="headerlink" title="DAG （Topology）有向无环图"></a>DAG （Topology）有向无环图</h3><h3 id="Spout-–-数据源"><a href="#Spout-–-数据源" class="headerlink" title="Spout – 数据源"></a>Spout – 数据源</h3><ul>
<li>nextTuple</li>
</ul>
<p>Spout中最核心的方法是nextTuple，该方法会被Storm线程不断调用、主动从数据源拉取数据，再通过emit方法将数据生成元组（Tuple）发送给之后的Bolt计算</p>
<ul>
<li>OutputFieldsDeclarer</li>
</ul>
<p>可先通过OutputFieldsDeclarer中的declare方法声明定义的不同数据流，发送数据时通过SpoutOutputCollector中的emit方法指定数据流Id（streamId）参数将数据发送出去</p>
<h3 id="Bolt-–-数据流处理组件"><a href="#Bolt-–-数据流处理组件" class="headerlink" title="Bolt – 数据流处理组件"></a>Bolt – 数据流处理组件</h3><p>Bolt：处理者，可以有多个。多个bolt可以并行执行。</p>
<p>一个Bolt可以发送多个数据流（Stream）</p>
<ul>
<li>OutputFieldsDeclarer</li>
</ul>
<p>可先通过OutputFieldsDeclarer中的declare方法声明定义的不同数据流，发送数据时通过SpoutOutputCollector中的emit方法指定数据流Id（streamId）参数将数据发送出去</p>
<ul>
<li>execute</li>
</ul>
<p>Bolt中最核心的方法是execute方法，该方法负责接收到一个元组（Tuple）数据、真正实现核心的业务逻辑</p>
<h3 id="Stream-Grouping-–-数据流分组（即数据分发策略）"><a href="#Stream-Grouping-–-数据流分组（即数据分发策略）" class="headerlink" title="Stream Grouping – 数据流分组（即数据分发策略）"></a>Stream Grouping – 数据流分组（即数据分发策略）</h3><h2 id="高可靠性"><a href="#高可靠性" class="headerlink" title="高可靠性"></a>高可靠性</h2><p>异常处理</p>
<p>消息可靠性保障机制(ACK)</p>
<h2 id="流式处理"><a href="#流式处理" class="headerlink" title="流式处理"></a>流式处理</h2><h3 id="异步方式"><a href="#异步方式" class="headerlink" title="异步方式"></a>异步方式</h3><ul>
<li>流式处理（异步 与 同步）</li>
</ul>
<p>客户端提交数据进行结算，并不会等待数据计算结果</p>
<ul>
<li>逐条处理</li>
</ul>
<p>例：ETL（数据清洗）extracted transform load</p>
<ul>
<li>统计分析</li>
</ul>
<p>例：计算PV、UV、访问热点 以及 某些数据的聚合、加和、平均等</p>
<p>​       客户端提交数据之后，计算完成结果存储到Redis、HBase、MySQL或者其他MQ当中，</p>
<p>​       客户端并不关心最终结果是多少。</p>
<p><img src="/2019/06/23/storm搭建及原理分析/pic1.png" alt="pic1"></p>
<h3 id="同步方式"><a href="#同步方式" class="headerlink" title="同步方式"></a>同步方式</h3><p>客户端提交数据请求之后，立刻取得计算结果并返回给客户端</p>
<p><img src="/2019/06/23/storm搭建及原理分析/pic2.png" alt="pic1"></p>
<p>客户端通过和DRPC server交互，立刻取得返回结果</p>
<h2 id="和MapReduce比较"><a href="#和MapReduce比较" class="headerlink" title="和MapReduce比较"></a>和MapReduce比较</h2><ul>
<li><p>Storm：进程、线程常驻内存运行，数据不进入磁盘，数据通过网络传递。</p>
</li>
<li><p>MapReduce：为TB、PB级别数据设计的批处理计算框架。</p>
</li>
</ul>
<h2 id="和Spark-Streaming比较"><a href="#和Spark-Streaming比较" class="headerlink" title="和Spark Streaming比较"></a>和Spark Streaming比较</h2><ul>
<li>Storm：纯流式处理，毫秒级</li>
</ul>
<p>专门为流式处理设计</p>
<p>数据传输模式更为简单，很多地方也更为高效</p>
<p>并不是不能做批处理，它也可以来做微批处理，来提高吞吐</p>
<ul>
<li>Spark Streaming：微批处理，秒级</li>
</ul>
<p>将RDD做的很小来用小的批处理来接近流式处理</p>
<p>基于内存和DAG可以把处理任务做的很快</p>
<h2 id="数据累加demo"><a href="#数据累加demo" class="headerlink" title="数据累加demo"></a>数据累加demo</h2><p>代码参考<code>eclipse-hadoop-workspace/ws</code></p>
<h2 id="集群安装"><a href="#集群安装" class="headerlink" title="集群安装"></a>集群安装</h2><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">python -V</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th></th>
<th>nimbus</th>
<th>supervisor</th>
<th>zookeeper</th>
</tr>
</thead>
<tbody>
<tr>
<td>node01</td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td>node02</td>
<td></td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td>node03</td>
<td></td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td>node04</td>
<td></td>
<td></td>
<td>*</td>
</tr>
</tbody>
</table>
<p>scp安装包到node01 <code>apache-storm-0.10.0.tar.gz</code></p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ vim conf/storm.yaml</span><br><span class="line">storm.zookeeper.servers:</span><br><span class="line">  -<span class="ruby"> <span class="string">"node02"</span></span></span><br><span class="line"><span class="ruby">  - <span class="string">"node03"</span></span></span><br><span class="line"><span class="ruby">  - <span class="string">"node04"</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">storm.local.<span class="symbol">dir:</span> <span class="string">"/tmp/storm"</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">nimbus.<span class="symbol">host:</span> <span class="string">"node01"</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby"><span class="comment"># slot 代表一个进程</span></span></span><br><span class="line"><span class="ruby">supervisor.slots.<span class="symbol">ports:</span></span></span><br><span class="line"><span class="ruby">    - <span class="number">6700</span></span></span><br><span class="line"><span class="ruby">    - <span class="number">6701</span></span></span><br><span class="line"><span class="ruby">    - <span class="number">6702</span></span></span><br><span class="line"><span class="ruby">    - <span class="number">6703</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -r apache-storm-<span class="number">0</span>.<span class="number">10.0</span> root<span class="variable">@node02</span><span class="symbol">:`pwd`</span></span><br><span class="line">scp -r apache-storm-<span class="number">0</span>.<span class="number">10.0</span> root<span class="variable">@node03</span><span class="symbol">:`pwd`</span></span><br></pre></td></tr></table></figure>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">环境变量配置</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">STORM_HOME</span>=/opt/sxt/storm</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="variable">$PATH</span>:$STORM_HOME/bin</span><br></pre></td></tr></table></figure>
<p>在storm目录中创建logs目录<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> <span class="variable">$STORM_HOME</span></span><br><span class="line"><span class="keyword">mkdir</span> logs</span><br></pre></td></tr></table></figure></p>
<p>node01上启动Nimbus<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">storm nimbus &gt;&gt; ./logs/nimbus<span class="selector-class">.out</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line">tail -f logs/nimbus.log</span><br><span class="line">storm ui &gt;&gt; ./logs/ui<span class="selector-class">.out</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line">tail -f logs/ui.log</span><br></pre></td></tr></table></figure></p>
<p>节点node2和node3启动supervisor，按照配置，每启动一个supervisor就有了4个slots<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> <span class="variable">$STORM_HOME</span></span><br><span class="line"><span class="keyword">mkdir</span> logs</span><br><span class="line">storm supervisor &gt;&gt; ./logs/supervisor.<span class="keyword">out</span> 2&gt;&amp;1 &amp;</span><br><span class="line">tail -f logs/supervisor.<span class="built_in">log</span></span><br></pre></td></tr></table></figure></p>
<h3 id="帮助命令"><a href="#帮助命令" class="headerlink" title="帮助命令"></a>帮助命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">storm <span class="built_in">help</span></span><br><span class="line">storm <span class="built_in">help</span> jar</span><br></pre></td></tr></table></figure>
<h3 id="kill"><a href="#kill" class="headerlink" title="kill"></a>kill</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storm <span class="built_in">kill</span> <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<h3 id="web运维页面"><a href="#web运维页面" class="headerlink" title="web运维页面"></a>web运维页面</h3><blockquote>
<p><a href="http://node01:8080/" target="_blank" rel="external">http://node01:8080/</a></p>
</blockquote>
<h3 id="集群提交"><a href="#集群提交" class="headerlink" title="集群提交"></a>集群提交</h3><p>提交任务到Storm集群当中运行：代码参考(eclipse-hadoop-workspace/wordcount)</p>
<p>src打包，test为参数表示集群方式运行，作为topology名称</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storm jar wordcount<span class="selector-class">.jar</span> com<span class="selector-class">.sxt</span><span class="selector-class">.storm</span><span class="selector-class">.test</span><span class="selector-class">.Test</span> test</span><br></pre></td></tr></table></figure>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">if</span> (args.length&gt;<span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">try</span> &#123;</span><br><span class="line">		StormSubmitter.submitTopology(args[<span class="number">0</span>], <span class="built_in">config</span>, tb.createTopology());</span><br><span class="line">	&#125; <span class="built_in">catch</span> (AlreadyAliveException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125; <span class="built_in">catch</span> (InvalidTopologyException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="built_in">else</span> &#123;</span><br><span class="line"></span><br><span class="line">	LocalCluster lc = <span class="keyword">new</span> LocalCluster();</span><br><span class="line">	lc.submitTopology(<span class="string">"wordcount"</span>, <span class="built_in">config</span>, tb.createTopology());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>流程：</p>
<p>spout —&gt; bolt(切分单词)—&gt; bolt(计数)</p>
<h2 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h2><p><img src="/2019/06/23/storm搭建及原理分析/pic4.png" alt="pic4"></p>
<h3 id="Nimbus"><a href="#Nimbus" class="headerlink" title="Nimbus"></a>Nimbus</h3><ul>
<li><p>资源调度</p>
</li>
<li><p>任务分配</p>
</li>
<li><p>接收jar包</p>
</li>
</ul>
<h3 id="Supervisor"><a href="#Supervisor" class="headerlink" title="Supervisor"></a>Supervisor</h3><ul>
<li><p>接收nimbus分配的任务</p>
</li>
<li><p>启动、停止自己管理的worker进程（当前supervisor上worker数量由配置文件设定）</p>
</li>
</ul>
<h3 id="Worker"><a href="#Worker" class="headerlink" title="Worker"></a>Worker</h3><ul>
<li><p>运行具体处理运算组件的进程（每个Worker对应执行一个Topology的子集）</p>
</li>
<li><p>worker任务类型，即spout任务、bolt任务两种</p>
</li>
<li><p>启动executor</p>
</li>
</ul>
<p>​    （executor即worker JVM进程中的一个java线程，一般默认每个executor负责执行一个task任务）</p>
<h3 id="与hadoop-yarn对比"><a href="#与hadoop-yarn对比" class="headerlink" title="与hadoop yarn对比"></a>与hadoop yarn对比</h3><table>
<thead>
<tr>
<th></th>
<th>Hadoop</th>
<th>Storm</th>
</tr>
</thead>
<tbody>
<tr>
<td>主节点</td>
<td>ResourceManager</td>
<td>Nimbus</td>
</tr>
<tr>
<td>从节点</td>
<td>NodeManager</td>
<td>Supervisor</td>
</tr>
<tr>
<td>应用程序</td>
<td>Job</td>
<td>Topology</td>
</tr>
<tr>
<td>工作进程</td>
<td>Child</td>
<td>Worker</td>
</tr>
<tr>
<td>计算模型</td>
<td>Map/Reduce(split,map,shuffle,reduce)</td>
<td>Spout/Bolt</td>
</tr>
</tbody>
</table>
<h3 id="运行过程"><a href="#运行过程" class="headerlink" title="运行过程"></a>运行过程</h3><ul>
<li>提交jar包到nimbus/inbox目录下</li>
<li>对topology进行校验处理</li>
<li>nimbus/stormdist/${topology-id}下，包含jar包、stormcode序列化方法、stormconf运行配置</li>
<li>nimbus初始化spout/bolt的task，写到zookeeper的/tasks节点下</li>
<li>nimbus创建/taskbeats的zk节点，监控task心跳</li>
<li>将任务分配信息，写到zk assignment/${topology-id}节点中，此时认为任务提交完毕</li>
<li>在zk的storms/${topology-id}下存放任务的运行时间、状态信息</li>
</ul>
<p><img src="/2019/06/23/storm搭建及原理分析/pic5.png" alt="pic4"></p>
<h3 id="本地目录树"><a href="#本地目录树" class="headerlink" title="本地目录树"></a>本地目录树</h3><p><img src="/2019/06/23/storm搭建及原理分析/pic7.png" alt="pic4"></p>
<h3 id="zookeeper目录树"><a href="#zookeeper目录树" class="headerlink" title="zookeeper目录树"></a>zookeeper目录树</h3><p><img src="/2019/06/23/storm搭建及原理分析/pic8.png" alt="pic4"></p>
<h2 id="Storm-DRPC"><a href="#Storm-DRPC" class="headerlink" title="Storm DRPC"></a>Storm DRPC</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><ul>
<li>DRPC (Distributed RPC)  remote procedure call</li>
</ul>
<p>分布式远程过程调用</p>
<ul>
<li>DRPC 是通过一个 DRPC 服务端(DRPC server)来实现分布式 RPC 功能的。</li>
</ul>
<p>DRPC Server 负责接收 RPC 请求，并将该请求发送到 Storm中运行的 Topology，等待接收 Topology 发送的处理结果，并将该结果返回给发送请求的客户端。</p>
<p>（其实，从客户端的角度来说，DPRC 与普通的 RPC 调用并没有什么区别。）</p>
<ul>
<li>DRPC设计目的：</li>
</ul>
<p>为了充分利用Storm的计算能力实现高密度的并行实时计算。</p>
<p>（Storm接收若干个数据流输入，数据在Topology当中运行完成，然后通过DRPC将结果进行输出。）</p>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">vi</span> <span class="selector-tag">storm</span><span class="selector-class">.yaml</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">drpc<span class="selector-class">.servers</span>:</span><br><span class="line">    - <span class="string">"node01"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp storm.yaml root<span class="variable">@node02</span><span class="symbol">:`pwd`</span></span><br><span class="line">scp storm.yaml root<span class="variable">@node03</span><span class="symbol">:`pwd`</span></span><br></pre></td></tr></table></figure>
<p>node01执行</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nohup storm nimbus &gt;&gt; ./logs/nimbus<span class="selector-class">.out</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line">tail -f logs/nimbus.log</span><br><span class="line">nohup storm drpc &gt;&gt; ./logs/drpc<span class="selector-class">.out</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line">tail -f logs/drpc.log</span><br><span class="line">nohup storm ui &gt;&gt; ./logs/ui<span class="selector-class">.out</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line">tail -f logs/ui.log</span><br></pre></td></tr></table></figure>
<p>node02 node03执行</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> <span class="variable">$STORM_HOME</span></span><br><span class="line">nohup storm supervisor &gt;&gt; ./logs/supervisor.<span class="keyword">out</span> 2&gt;&amp;1 &amp;</span><br><span class="line">tail -f logs/supervisor.<span class="built_in">log</span></span><br></pre></td></tr></table></figure>
<p>代码参考eclipse-hadoop-workspace/StormDemo</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp drpc.jar root<span class="variable">@node01</span><span class="symbol">:/root/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storm jar drpc<span class="selector-class">.jar</span> com<span class="selector-class">.sxt</span><span class="selector-class">.storm</span><span class="selector-class">.drpc</span><span class="selector-class">.BasicDRPCTopology</span> test</span><br></pre></td></tr></table></figure>
<p>客户端执行结果</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDRPCclient</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(String[] args) &#123;</span><br><span class="line">		DRPCClient <span class="keyword">client</span> = <span class="keyword">new</span> DRPCClient(<span class="string">"node01"</span>, <span class="number">3772</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			String result = <span class="keyword">client</span>.execute(<span class="string">"exclamation"</span>, <span class="string">"11,22"</span>);</span><br><span class="line"></span><br><span class="line">			System.out.println(result);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (TException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (DRPCExecutionException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Storm-容错机制"><a href="#Storm-容错机制" class="headerlink" title="Storm 容错机制"></a>Storm 容错机制</h2><h3 id="集群节点宕机"><a href="#集群节点宕机" class="headerlink" title="集群节点宕机"></a>集群节点宕机</h3><ul>
<li>Nimbus服务器</li>
</ul>
<p>单点故障<strong>？</strong></p>
<ul>
<li>非Nimbus服务器</li>
</ul>
<p>故障时，该节点上所有Task任务都会超时，Nimbus会将这些Task任务重新分配到其他服务器上运行</p>
<h3 id="进程挂掉"><a href="#进程挂掉" class="headerlink" title="进程挂掉"></a>进程挂掉</h3><h4 id="Worker-1"><a href="#Worker-1" class="headerlink" title="Worker"></a>Worker</h4><p>挂掉时，Supervisor会重新启动这个进程。如果启动过程中仍然一直失败，并且无法向Nimbus发送心跳，Nimbus会将该Worker重新分配到其他服务器上</p>
<h4 id="Supervisor-1"><a href="#Supervisor-1" class="headerlink" title="Supervisor"></a>Supervisor</h4><p>无状态（所有的状态信息都存放在Zookeeper中来管理）</p>
<p>快速失败（每当遇到任何异常情况，都会自动毁灭）</p>
<h4 id="Nimbus-1"><a href="#Nimbus-1" class="headerlink" title="Nimbus"></a>Nimbus</h4><p>无状态（所有的状态信息都存放在Zookeeper中来管理）</p>
<p>快速失败（每当遇到任何异常情况，都会自动毁灭）</p>
<h3 id="消息的完整性"><a href="#消息的完整性" class="headerlink" title="消息的完整性"></a>消息的完整性</h3><ul>
<li><p>从Spout中发出的Tuple，以及基于他所产生Tuple（例如上个例子当中Spout发出的句子，以及句子当中单词的tuple等）</p>
</li>
<li><p>由这些消息就构成了一棵tuple树</p>
</li>
<li><p>当这棵tuple树发送完成，并且树当中每一条消息都被正确处理，就表明spout发送消息被“完整处理”，即消息的完整性</p>
</li>
</ul>
<p><img src="/2019/06/23/storm搭建及原理分析/pic9.png" alt="pic4"></p>
<h2 id="中国移动项目"><a href="#中国移动项目" class="headerlink" title="中国移动项目"></a>中国移动项目</h2><p>代码参考<code>cmccstormjk02</code>  和<code>cmcc02_hbase</code></p>
<h3 id="hbase"><a href="#hbase" class="headerlink" title="hbase"></a>hbase</h3><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">create</span> <span class="string">'cell_monitor_table'</span>,<span class="string">'cf'</span></span><br></pre></td></tr></table></figure>
<p><img src="/2019/06/23/storm搭建及原理分析/中国移动项目架构图.jpg" alt="pic4"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/06/21/hadoop日志分析实战项目搭建及分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/21/hadoop日志分析实战项目搭建及分析/" itemprop="url">hadoop日志分析实战项目搭建及分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-21T14:42:19+08:00">
                2019-06-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/21/hadoop日志分析实战项目搭建及分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/06/21/hadoop日志分析实战项目搭建及分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  7.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  39
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="整体项目流程"><a href="#整体项目流程" class="headerlink" title="整体项目流程"></a>整体项目流程</h1><ul>
<li>js或者java sdk访问nginx提供的接口，nginx写入访问日志文件</li>
<li>flume <code>tail -F</code>监控日志文件，存储日志到hdfs</li>
<li>通过Mapper Reducer 任务，清洗日志为标准的数据，存储到hbase</li>
<li>通过map reduce 任务，按不同的维度，统计数据，写入到mysql。或者使用hive建立外部表，关联hbase，通过spoop，转换hive数据到mysql。</li>
</ul>
<p><img src="/2019/06/21/hadoop日志分析实战项目搭建及分析/数据流图.jpg" alt="数据流图"></p>
<h1 id="tengine安装"><a href="#tengine安装" class="headerlink" title="tengine安装"></a>tengine安装</h1><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><blockquote>
<p><a href="http://tengine.taobao.org/document/install.html" target="_blank" rel="external">http://tengine.taobao.org/document/install.html</a></p>
<p><a href="http://tengine.taobao.org/nginx_docs/cn/docs/" target="_blank" rel="external">Nginx文档</a><br><a href="http://tengine.taobao.org/nginx_docs/cn/docs/http/ngx_http_log_module.html" target="_blank" rel="external">ngx_http_log_module模块</a></p>
</blockquote>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> gcc openssl-devel pcre-devel zlib-devel -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索</span></span><br><span class="line">yum search</span><br></pre></td></tr></table></figure>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p><code>nginx.conf</code>的<code>http</code>模块下配置</p>
<figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log_format my_format '<span class="built_in">$remote</span>_addr<span class="symbol">^A</span><span class="built_in">$msec</span><span class="symbol">^A</span><span class="built_in">$http</span>_host<span class="symbol">^A</span><span class="built_in">$request</span>_uri'<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p><code>server</code>配置访问日志的格式和文件地址</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location = /<span class="built_in">log</span>.gif &#123;</span><br><span class="line">    default_type image/gif;</span><br><span class="line">    access_log /opt/<span class="keyword">data</span>/<span class="keyword">access</span>.<span class="built_in">log</span> my_format;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./<span class="built_in">n</span></span><br></pre></td></tr></table></figure>
<h1 id="flume安装"><a href="#flume安装" class="headerlink" title="flume安装"></a>flume安装</h1><h2 id="单节点"><a href="#单节点" class="headerlink" title="单节点"></a>单节点</h2><h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#a-simple-example" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#a-simple-example</a></p>
</blockquote>
<h3 id="上传解压"><a href="#上传解压" class="headerlink" title="上传解压"></a>上传解压</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp apache-flume-<span class="number">1.6</span>.<span class="number">0</span>-bin<span class="selector-class">.tar</span><span class="selector-class">.gz</span> root@node02:/root</span><br><span class="line">tar -zxvf apache-flume-<span class="number">1.6</span>.<span class="number">0</span>-bin<span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">mv apache-flume-<span class="number">1.6</span>.<span class="number">0</span>-bin/ /usr/install/</span><br></pre></td></tr></table></figure>
<h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export FLUME_HOME=/usr/<span class="keyword">install</span>/apache-flume<span class="number">-1.6</span><span class="number">.0</span>-<span class="keyword">bin</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">PATH</span>=$<span class="keyword">PATH</span>:$ZOOKEEPER_HOME/<span class="keyword">bin</span>:$HADOOP_HOME/<span class="keyword">bin</span>:$HADOOP_HOME/sbin:$HIVE_HOME/<span class="keyword">bin</span>:$HBASE_HOME/<span class="keyword">bin</span>:$FLUME_HOME/<span class="keyword">bin</span></span><br></pre></td></tr></table></figure>
<h3 id="修改conf-flume-env-sh-文件中的JDK目录"><a href="#修改conf-flume-env-sh-文件中的JDK目录" class="headerlink" title="修改conf/flume-env.sh  文件中的JDK目录"></a>修改conf/flume-env.sh  文件中的JDK目录</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp flume-env<span class="selector-class">.sh</span><span class="selector-class">.template</span> flume-env.sh</span><br><span class="line">vi flume-env.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">JAVA_HOME</span>=/usr/install/jdk/jdk1.8.0_171</span><br></pre></td></tr></table></figure>
<h3 id="验证安装是否成功"><a href="#验证安装是否成功" class="headerlink" title="验证安装是否成功"></a>验证安装是否成功</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng <span class="built_in">version</span></span><br></pre></td></tr></table></figure>
<h3 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> <span class="keyword">conf</span>/</span><br><span class="line"><span class="keyword">vi</span> simple.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Name the components on this agent</span></span><br><span class="line"><span class="built_in">a1</span>.sources = r1</span><br><span class="line"><span class="built_in">a1</span>.sinks = <span class="built_in">k1</span></span><br><span class="line"><span class="built_in">a1</span>.channels = c1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe/configure the source</span></span><br><span class="line"><span class="built_in">a1</span>.sources.r1.type = netcat</span><br><span class="line"><span class="built_in">a1</span>.sources.r1.<span class="keyword">bind </span>= node02</span><br><span class="line"><span class="built_in">a1</span>.sources.r1.port = <span class="number">44444</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe the sink</span></span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.type = logger</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use a channel which buffers events in memory</span></span><br><span class="line"><span class="built_in">a1</span>.channels.c1.type = memory</span><br><span class="line"><span class="built_in">a1</span>.channels.c1.capacity = <span class="number">1000</span></span><br><span class="line"><span class="built_in">a1</span>.channels.c1.transactionCapacity = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the source and sink to the channel</span></span><br><span class="line"><span class="built_in">a1</span>.sources.r1.channels = c1</span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>
<h3 id="启动flume"><a href="#启动flume" class="headerlink" title="启动flume"></a>启动flume</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent -n a1 -c conf -f simple<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h3 id="发送数据"><a href="#发送数据" class="headerlink" title="发送数据"></a>发送数据</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet node<span class="number">02 44444</span></span><br></pre></td></tr></table></figure>
<h2 id="两个flume做集群"><a href="#两个flume做集群" class="headerlink" title="两个flume做集群"></a>两个flume做集群</h2><h3 id="参考文档-1"><a href="#参考文档-1" class="headerlink" title="参考文档"></a>参考文档</h3><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#setting-multi-agent-flow" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#setting-multi-agent-flow</a></p>
</blockquote>
<h3 id="右侧节点-node03"><a href="#右侧节点-node03" class="headerlink" title="右侧节点(node03)"></a>右侧节点(node03)</h3><h4 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h4><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#avro-source" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#avro-source</a></p>
</blockquote>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> double-flume.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Name the components on this agent</span></span><br><span class="line"><span class="built_in">a1</span>.sources = r1</span><br><span class="line"><span class="built_in">a1</span>.sinks = <span class="built_in">k1</span></span><br><span class="line"><span class="built_in">a1</span>.channels = c1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe/configure the source</span></span><br><span class="line"><span class="built_in">a1</span>.sources.r1.type = avro</span><br><span class="line"><span class="built_in">a1</span>.sources.r1.<span class="keyword">bind </span>= node03</span><br><span class="line"><span class="built_in">a1</span>.sources.r1.port = <span class="number">60000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe the sink</span></span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.type = logger</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use a channel which buffers events in memory</span></span><br><span class="line"><span class="built_in">a1</span>.channels.c1.type = memory</span><br><span class="line"><span class="built_in">a1</span>.channels.c1.capacity = <span class="number">1000</span></span><br><span class="line"><span class="built_in">a1</span>.channels.c1.transactionCapacity = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the source and sink to the channel</span></span><br><span class="line"><span class="built_in">a1</span>.sources.r1.channels = c1</span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>
<h4 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent  -n a1 -c conf -f double-flume<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h3 id="左侧节点-node02"><a href="#左侧节点-node02" class="headerlink" title="左侧节点(node02)"></a>左侧节点(node02)</h3><h4 id="参考-2"><a href="#参考-2" class="headerlink" title="参考"></a>参考</h4><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#avro-sink" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#avro-sink</a></p>
</blockquote>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -r apache-flume-<span class="number">1.6</span>.<span class="number">0</span>-bin/ root<span class="variable">@node03</span><span class="symbol">:/usr/install</span></span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> double-flume.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">a1</span>.sources = r1</span><br><span class="line"><span class="built_in">a1</span>.sinks = <span class="built_in">k1</span></span><br><span class="line"><span class="built_in">a1</span>.channels = c1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe/configure the source</span></span><br><span class="line"><span class="built_in">a1</span>.sources.r1.type = netcat</span><br><span class="line"><span class="built_in">a1</span>.sources.r1.<span class="keyword">bind </span>= node02</span><br><span class="line"><span class="built_in">a1</span>.sources.r1.port = <span class="number">44444</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe the sink</span></span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.type = avro</span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.hostname = node03</span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.port = <span class="number">60000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use a channel which buffers events in memory</span></span><br><span class="line"><span class="built_in">a1</span>.channels.c1.type = memory</span><br><span class="line"><span class="built_in">a1</span>.channels.c1.capacity = <span class="number">1000</span></span><br><span class="line"><span class="built_in">a1</span>.channels.c1.transactionCapacity = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the source and sink to the channel</span></span><br><span class="line"><span class="built_in">a1</span>.sources.r1.channels = c1</span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>
<h4 id="启动-2"><a href="#启动-2" class="headerlink" title="启动"></a>启动</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent  -n a1 -c conf -f double-flume<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h3 id="发送数据-1"><a href="#发送数据-1" class="headerlink" title="发送数据"></a>发送数据</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet node<span class="number">02 44444</span></span><br></pre></td></tr></table></figure>
<h2 id="Exec-Source方式，监控文件tail命令"><a href="#Exec-Source方式，监控文件tail命令" class="headerlink" title="Exec Source方式，监控文件tail命令"></a>Exec Source方式，监控文件tail命令</h2><h3 id="参考-3"><a href="#参考-3" class="headerlink" title="参考"></a>参考</h3><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#exec-source" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#exec-source</a></p>
</blockquote>
<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> exec.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">a1.<span class="attr">sources</span> = r1</span><br><span class="line">a1.<span class="attr">sinks</span> = k1</span><br><span class="line">a1.<span class="attr">channels</span> = c1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe/configure the source</span></span><br><span class="line">a1.sources.r1.<span class="attr">type</span> = exec</span><br><span class="line">a1.sources.r1.<span class="attr">command</span> = tail -F /root/test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe the sink</span></span><br><span class="line">a1.sinks.k1.<span class="attr">type</span> = logger</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use a channel which buffers events in memory</span></span><br><span class="line">a1.channels.c1.<span class="attr">type</span> = memory</span><br><span class="line">a1.channels.c1.<span class="attr">capacity</span> = <span class="number">1000</span></span><br><span class="line">a1.channels.c1.<span class="attr">transactionCapacity</span> = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the source and sink to the channel</span></span><br><span class="line">a1.sources.r1.<span class="attr">channels</span> = c1</span><br><span class="line">a1.sinks.k1.<span class="attr">channel</span> = c1</span><br></pre></td></tr></table></figure>
<h3 id="启动-3"><a href="#启动-3" class="headerlink" title="启动"></a>启动</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent -n a1 -c conf -f exec<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h3 id="添加数据"><a href="#添加数据" class="headerlink" title="添加数据"></a>添加数据</h3><p>循环添加数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..50&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">"<span class="variable">$i</span> hi flume"</span> &gt;&gt; /root/test.txt ; sleep 0.1; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h2 id="Spooling-Directory-Source监控目录"><a href="#Spooling-Directory-Source监控目录" class="headerlink" title="Spooling Directory Source监控目录"></a>Spooling Directory Source监控目录</h2><h3 id="参考-4"><a href="#参考-4" class="headerlink" title="参考"></a>参考</h3><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#spooling-directory-source" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#spooling-directory-source</a></p>
</blockquote>
<h3 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> spool.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">a1.<span class="attr">sources</span> = r1</span><br><span class="line">a1.<span class="attr">sinks</span> = k1</span><br><span class="line">a1.<span class="attr">channels</span> = c1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe/configure the source</span></span><br><span class="line">a1.sources.r1.<span class="attr">type</span> = spooldir</span><br><span class="line">a1.sources.r1.<span class="attr">spoolDir</span> = /root/logs</span><br><span class="line">a1.sources.r1.<span class="attr">fileHeader</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe the sink</span></span><br><span class="line">a1.sinks.k1.<span class="attr">type</span> = logger</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use a channel which buffers events in memory</span></span><br><span class="line">a1.channels.c1.<span class="attr">type</span> = memory</span><br><span class="line">a1.channels.c1.<span class="attr">capacity</span> = <span class="number">1000</span></span><br><span class="line">a1.channels.c1.<span class="attr">transactionCapacity</span> = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the source and sink to the channel</span></span><br><span class="line">a1.sources.r1.<span class="attr">channels</span> = c1</span><br><span class="line">a1.sinks.k1.<span class="attr">channel</span> = c1</span><br></pre></td></tr></table></figure>
<h3 id="启动-4"><a href="#启动-4" class="headerlink" title="启动"></a>启动</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent -n a1 -c conf -f spool<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h3 id="拷贝文件演示"><a href="#拷贝文件演示" class="headerlink" title="拷贝文件演示"></a>拷贝文件演示</h3><pre><code>mkdir logs
mv aa logs/
</code></pre><h2 id="flume和kafka"><a href="#flume和kafka" class="headerlink" title="flume和kafka"></a>flume和kafka</h2><p>两者经常配对使用，谁在前后都可以</p>
<h2 id="hdfs-sink方式"><a href="#hdfs-sink方式" class="headerlink" title="hdfs sink方式"></a>hdfs sink方式</h2><h3 id="参考-5"><a href="#参考-5" class="headerlink" title="参考"></a>参考</h3><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#hdfs-sink" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#hdfs-sink</a></p>
</blockquote>
<h3 id="配置-3"><a href="#配置-3" class="headerlink" title="配置"></a>配置</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> hdfs-sink.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">a1.<span class="attr">sources</span> = r1</span><br><span class="line">a1.<span class="attr">sinks</span> = k1</span><br><span class="line">a1.<span class="attr">channels</span> = c1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe/configure the source</span></span><br><span class="line">a1.sources.r1.<span class="attr">type</span> = spooldir</span><br><span class="line">a1.sources.r1.<span class="attr">spoolDir</span> = /root/logs</span><br><span class="line">a1.sources.r1.<span class="attr">fileHeader</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe the sink 文件目录格式</span></span><br><span class="line">a1.sinks.k1.<span class="attr">type=hdfs</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">path=hdfs://mycluster/flume/%Y-%m-%d/%H%M</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##每隔60s或者文件大小超过10M的时候产生新文件，roll对文件设置</span></span><br><span class="line"><span class="comment"># hdfs有多少条消息时新建文件，0不基于消息个数</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">rollCount=0</span></span><br><span class="line"><span class="comment"># hdfs创建多长时间新建文件，0不基于时间</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">rollInterval=60</span></span><br><span class="line"><span class="comment"># hdfs多大时新建文件，0不基于文件大小</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">rollSize=10240</span></span><br><span class="line"><span class="comment"># 当目前被打开的临时文件在该参数指定的时间（秒）内，没有任何数据写入，则将该临时文件关闭并重命名成目标文件</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">idleTimeout=3</span></span><br><span class="line"></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">fileType=DataStream</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">useLocalTimeStamp=true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 每五分钟生成一个目录，round对目录设置</span></span><br><span class="line"><span class="comment"># 是否启用时间上的”舍弃”，这里的”舍弃”，类似于”四舍五入”，后面再介绍。如果启用，则会影响除了%t的其他所有时间表达式</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">round=true</span></span><br><span class="line"><span class="comment"># 时间上进行“舍弃”的值；</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">roundValue=5</span></span><br><span class="line"><span class="comment"># 时间上进行”舍弃”的单位，包含：second,minute,hour</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">roundUnit=minute</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use a channel which buffers events in memory</span></span><br><span class="line">a1.channels.c1.<span class="attr">type</span> = memory</span><br><span class="line">a1.channels.c1.<span class="attr">capacity</span> = <span class="number">1000</span></span><br><span class="line">a1.channels.c1.<span class="attr">transactionCapacity</span> = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the source and sink to the channel</span></span><br><span class="line">a1.sources.r1.<span class="attr">channels</span> = c1</span><br><span class="line">a1.sinks.k1.<span class="attr">channel</span> = c1</span><br></pre></td></tr></table></figure>
<h3 id="启动-5"><a href="#启动-5" class="headerlink" title="启动"></a>启动</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent -n a1 -c conf -f hdfs-sink<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h3 id="拷贝文件演示-1"><a href="#拷贝文件演示-1" class="headerlink" title="拷贝文件演示"></a>拷贝文件演示</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> logs</span><br><span class="line">mv aa logs/</span><br></pre></td></tr></table></figure>
<h1 id="tengine和flume集成"><a href="#tengine和flume集成" class="headerlink" title="tengine和flume集成"></a>tengine和flume集成</h1><h2 id="配置-4"><a href="#配置-4" class="headerlink" title="配置"></a>配置</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> tengine_project.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">a1.<span class="attr">sources</span> = r1</span><br><span class="line">a1.<span class="attr">sinks</span> = k1</span><br><span class="line">a1.<span class="attr">channels</span> = c1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 监听tengine的access log文件</span></span><br><span class="line">a1.sources.r1.<span class="attr">type</span> = exec</span><br><span class="line">a1.sources.r1.<span class="attr">command</span> = tail -F /opt/data/access.log</span><br><span class="line"></span><br><span class="line">a1.sinks.k1.<span class="attr">type=hdfs</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">path=hdfs://mycluster/log/%Y%m%d</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">rollCount=0</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">rollInterval=0</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">rollSize=10240</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">idleTimeout=5</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">fileType=DataStream</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">useLocalTimeStamp=true</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">callTimeout=40000</span></span><br><span class="line"></span><br><span class="line">a1.channels.c1.<span class="attr">type</span> = memory</span><br><span class="line">a1.channels.c1.<span class="attr">capacity</span> = <span class="number">1000</span></span><br><span class="line">a1.channels.c1.<span class="attr">transactionCapacity</span> = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">a1.sources.r1.<span class="attr">channels</span> = c1</span><br><span class="line">a1.sinks.k1.<span class="attr">channel</span> = c1</span><br></pre></td></tr></table></figure>
<h2 id="启动-6"><a href="#启动-6" class="headerlink" title="启动"></a>启动</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent -n a1 -c conf -f tengine_project<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h2 id="拷贝文件演示-2"><a href="#拷贝文件演示-2" class="headerlink" title="拷贝文件演示"></a>拷贝文件演示</h2><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> logs</span><br><span class="line">mv aa logs/</span><br></pre></td></tr></table></figure>
<h1 id="经过ETL清洗存储到hbase"><a href="#经过ETL清洗存储到hbase" class="headerlink" title="经过ETL清洗存储到hbase"></a>经过ETL清洗存储到hbase</h1><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><ul>
<li>过滤脏数据</li>
<li>分析IP，得到省、市区</li>
<li>分析useragent，得到浏览器版本</li>
</ul>
<h2 id="AnalyserLogDataRunner"><a href="#AnalyserLogDataRunner" class="headerlink" title="AnalyserLogDataRunner"></a>AnalyserLogDataRunner</h2><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sxt.etl.mr.ald;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.FileSystem;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.HBaseConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Put;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.mapreduce.TableMapReduceUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.Tool;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.ToolRunner;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sxt.common.EventLogConstants;</span><br><span class="line"><span class="keyword">import</span> com.sxt.common.GlobalConstants;</span><br><span class="line"><span class="keyword">import</span> com.sxt.util.TimeUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 编写mapreduce的runner类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> root</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnalyserLogDataRunner</span> <span class="keyword">implements</span> <span class="title">Tool</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = Logger</span><br><span class="line">			.getLogger(AnalyserLogDataRunner.class);</span><br><span class="line">	<span class="keyword">private</span> Configuration conf = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ToolRunner.run(<span class="keyword">new</span> Configuration(), <span class="keyword">new</span> AnalyserLogDataRunner(), args);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			logger.<span class="keyword">error</span>(<span class="string">"执行日志解析job异常"</span>, e);</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">setConf</span><span class="params">(Configuration conf)</span> </span>&#123;</span><br><span class="line">		conf.set(<span class="string">"fs.defaultFS"</span>, <span class="string">"hdfs://node01:8020"</span>);</span><br><span class="line"><span class="comment">//		conf.set("yarn.resourcemanager.hostname", "node3");</span></span><br><span class="line">		conf.set(<span class="string">"hbase.zookeeper.quorum"</span>, <span class="string">"node02,node03,node04"</span>);</span><br><span class="line">		<span class="keyword">this</span>.conf = HBaseConfiguration.create(conf);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function">Configuration <span class="title">getConf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.conf;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		Configuration conf = <span class="keyword">this</span>.getConf();</span><br><span class="line">		<span class="keyword">this</span>.processArgs(conf, args);</span><br><span class="line"></span><br><span class="line">		Job job = Job.getInstance(conf, <span class="string">"analyser_logdata"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 设置本地提交job，集群运行，需要代码</span></span><br><span class="line">		<span class="comment">// File jarFile = EJob.createTempJar("target/classes");</span></span><br><span class="line">		<span class="comment">// ((JobConf) job.getConfiguration()).setJar(jarFile.toString());</span></span><br><span class="line">		<span class="comment">// 设置本地提交job，集群运行，需要代码结束</span></span><br><span class="line"></span><br><span class="line">		job.setJarByClass(AnalyserLogDataRunner.class);</span><br><span class="line">		job.setMapperClass(AnalyserLogDataMapper.class);</span><br><span class="line">		job.setMapOutputKeyClass(NullWritable.class);</span><br><span class="line">		job.setMapOutputValueClass(Put.class);</span><br><span class="line">		<span class="comment">// 设置reducer配置</span></span><br><span class="line">		<span class="comment">// 1. 集群上运行，打成jar运行(要求addDependencyJars参数为true，默认就是true)</span></span><br><span class="line">		<span class="comment">// TableMapReduceUtil.initTableReducerJob(EventLogConstants.HBASE_NAME_EVENT_LOGS,</span></span><br><span class="line">		<span class="comment">// null, job);</span></span><br><span class="line">		<span class="comment">// 2. 本地运行，要求参数addDependencyJars为false</span></span><br><span class="line">		TableMapReduceUtil.initTableReducerJob(</span><br><span class="line">				EventLogConstants.HBASE_NAME_EVENT_LOGS, <span class="keyword">null</span>, job, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">				<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">		job.setNumReduceTasks(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 设置输入路径</span></span><br><span class="line">		<span class="keyword">this</span>.setJobInputPaths(job);</span><br><span class="line">		<span class="keyword">return</span> job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : -1;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 处理参数</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> conf</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">processArgs</span><span class="params">(Configuration conf, String[] args)</span> </span>&#123;</span><br><span class="line">		String date = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="string">"-d"</span>.equals(args[i])) &#123;</span><br><span class="line">				<span class="keyword">if</span> (i + <span class="number">1</span> &lt; args.length) &#123;</span><br><span class="line">					date = args[++i];</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		System.out.println(<span class="string">"-----"</span> + date);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 要求date格式为: yyyy-MM-dd</span></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isBlank(date) || !TimeUtil.isValidateRunningDate(date)) &#123;</span><br><span class="line">			<span class="comment">// date是一个无效时间数据</span></span><br><span class="line">			date = TimeUtil.getYesterday(); <span class="comment">// 默认时间是昨天</span></span><br><span class="line">			System.out.println(date);</span><br><span class="line">		&#125;</span><br><span class="line">		conf.set(GlobalConstants.RUNNING_DATE_PARAMES, date);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 设置job的输入路径</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> job</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">setJobInputPaths</span><span class="params">(Job job)</span> </span>&#123;</span><br><span class="line">		Configuration conf = job.getConfiguration();</span><br><span class="line">		FileSystem fs = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			fs = FileSystem.get(conf);</span><br><span class="line">			String date = conf.get(GlobalConstants.RUNNING_DATE_PARAMES);</span><br><span class="line">			<span class="comment">// Path inputPath = new Path("/flume/" +</span></span><br><span class="line">			<span class="comment">// TimeUtil.parseLong2String(TimeUtil.parseString2Long(date),</span></span><br><span class="line">			<span class="comment">// "MM/dd/"));</span></span><br><span class="line">			Path inputPath = <span class="keyword">new</span> Path(<span class="string">"/log/"</span></span><br><span class="line">					+ TimeUtil.parseLong2String(</span><br><span class="line">							TimeUtil.parseString2Long(date), <span class="string">"yyyyMMdd"</span>)</span><br><span class="line">					+ <span class="string">"/"</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (fs.exists(inputPath)) &#123;</span><br><span class="line">				FileInputFormat.addInputPath(job, inputPath);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"文件不存在:"</span> + inputPath);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"设置job的mapreduce输入路径出现异常"</span>, e);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (fs != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					fs.close();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">					<span class="comment">// nothing</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="AnalyserLogDataMapper"><a href="#AnalyserLogDataMapper" class="headerlink" title="AnalyserLogDataMapper"></a>AnalyserLogDataMapper</h2><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sxt.etl.mr.ald;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.CRC32;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Put;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.util.Bytes;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sxt.common.EventLogConstants;</span><br><span class="line"><span class="keyword">import</span> com.sxt.common.EventLogConstants.EventEnum;</span><br><span class="line"><span class="keyword">import</span> com.sxt.etl.util.LoggerUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义数据解析map类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @author root</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> class AnalyserLogDataMapper extends Mapper&lt;LongWritable, Text, NullWritable, Put&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Logger logger = Logger.getLogger(AnalyserLogDataMapper.class);</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">int</span> inputRecords, filterRecords, outputRecords; <span class="comment">// 主要用于标志，方便查看过滤数据</span></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">byte</span>[] family = Bytes.toBytes(EventLogConstants.EVENT_LOGS_FAMILY_NAME);</span><br><span class="line">	<span class="keyword">private</span> CRC32 crc32 = <span class="keyword">new</span> CRC32();</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="built_in">map</span>(LongWritable <span class="built_in">key</span>, Text value, Context context)</span><br><span class="line">			<span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">		<span class="keyword">this</span>.inputRecords++;</span><br><span class="line">		<span class="keyword">this</span>.logger.debug(<span class="string">"Analyse data of :"</span> + value);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// 解析日志</span></span><br><span class="line">			Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; clientInfo = LoggerUtil.handleLog(value.toString());</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 过滤解析失败的数据</span></span><br><span class="line">			<span class="keyword">if</span> (clientInfo.isEmpty()) &#123;</span><br><span class="line">				<span class="keyword">this</span>.filterRecords++;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 获取事件名称</span></span><br><span class="line">			<span class="keyword">String</span> eventAliasName = clientInfo.<span class="built_in">get</span>(EventLogConstants.LOG_COLUMN_NAME_EVENT_NAME);</span><br><span class="line">			EventEnum event = EventEnum.valueOfAlias(eventAliasName);</span><br><span class="line">			<span class="keyword">switch</span> (event) &#123;</span><br><span class="line">			<span class="keyword">case</span> LAUNCH:</span><br><span class="line">			<span class="keyword">case</span> PAGEVIEW:</span><br><span class="line">			<span class="keyword">case</span> CHARGEREQUEST:</span><br><span class="line">			<span class="keyword">case</span> CHARGEREFUND:</span><br><span class="line">			<span class="keyword">case</span> CHARGESUCCESS:</span><br><span class="line">			<span class="keyword">case</span> EVENT:</span><br><span class="line">				<span class="comment">// 处理数据</span></span><br><span class="line">				<span class="keyword">this</span>.handleData(clientInfo, event, context);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="keyword">this</span>.filterRecords++;</span><br><span class="line">				<span class="keyword">this</span>.logger.warn(<span class="string">"该事件没法进行解析，事件名称为:"</span> + eventAliasName);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">this</span>.filterRecords++;</span><br><span class="line">			<span class="keyword">this</span>.logger.error(<span class="string">"处理数据发出异常，数据:"</span> + value, e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> cleanup(Context context) <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">		<span class="keyword">super</span>.cleanup(context);</span><br><span class="line">		logger.info(<span class="string">"输入数据:"</span> + <span class="keyword">this</span>.inputRecords + <span class="string">"；输出数据:"</span> + <span class="keyword">this</span>.outputRecords</span><br><span class="line">				+ <span class="string">"；过滤数据:"</span> + <span class="keyword">this</span>.filterRecords);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 具体处理数据的方法</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param clientInfo</span></span><br><span class="line"><span class="comment">	 * @param context</span></span><br><span class="line"><span class="comment">	 * @param event</span></span><br><span class="line"><span class="comment">	 * @throws InterruptedException</span></span><br><span class="line"><span class="comment">	 * @throws IOException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> handleData(Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; clientInfo, EventEnum event,</span><br><span class="line">			Context context) <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">		<span class="keyword">String</span> uuid = clientInfo.<span class="built_in">get</span>(EventLogConstants.LOG_COLUMN_NAME_UUID);</span><br><span class="line">		<span class="keyword">String</span> memberId = clientInfo</span><br><span class="line">				.<span class="built_in">get</span>(EventLogConstants.LOG_COLUMN_NAME_MEMBER_ID);</span><br><span class="line">		<span class="keyword">String</span> serverTime = clientInfo</span><br><span class="line">				.<span class="built_in">get</span>(EventLogConstants.LOG_COLUMN_NAME_SERVER_TIME);</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isNotBlank(serverTime)) &#123;</span><br><span class="line">			<span class="comment">// 要求服务器时间不为空</span></span><br><span class="line">			clientInfo.remove(EventLogConstants.LOG_COLUMN_NAME_USER_AGENT); <span class="comment">// 浏览器信息去掉</span></span><br><span class="line">			<span class="keyword">String</span> rowkey = <span class="keyword">this</span>.generateRowKey(uuid, memberId, event.alias,</span><br><span class="line">					serverTime); <span class="comment">// timestamp</span></span><br><span class="line">									<span class="comment">// +</span></span><br><span class="line">									<span class="comment">// (uuid+memberid+event).crc</span></span><br><span class="line">			Put put = <span class="keyword">new</span> Put(Bytes.toBytes(rowkey));</span><br><span class="line">			<span class="keyword">for</span> (Map.Entry&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; entry : clientInfo.entrySet()) &#123;</span><br><span class="line">				<span class="keyword">if</span> (StringUtils.isNotBlank(entry.getKey())</span><br><span class="line">						&amp;&amp; StringUtils.isNotBlank(entry.getValue())) &#123;</span><br><span class="line">					put.<span class="built_in">add</span>(family, Bytes.toBytes(entry.getKey()),</span><br><span class="line">							Bytes.toBytes(entry.getValue()));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			context.write(NullWritable.<span class="built_in">get</span>(), put);</span><br><span class="line">			<span class="keyword">this</span>.outputRecords++;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.filterRecords++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 根据uuid memberid servertime创建rowkey</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param uuid</span></span><br><span class="line"><span class="comment">	 * @param memberId</span></span><br><span class="line"><span class="comment">	 * @param eventAliasName</span></span><br><span class="line"><span class="comment">	 * @param serverTime</span></span><br><span class="line"><span class="comment">	 * @return</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> generateRowKey(<span class="keyword">String</span> uuid, <span class="keyword">String</span> memberId,</span><br><span class="line">			<span class="keyword">String</span> eventAliasName, <span class="keyword">String</span> serverTime) &#123;</span><br><span class="line">		StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">		sb.<span class="built_in">append</span>(serverTime).<span class="built_in">append</span>(<span class="string">"_"</span>);</span><br><span class="line">		<span class="keyword">this</span>.crc32.reset();</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isNotBlank(uuid)) &#123;</span><br><span class="line">			<span class="keyword">this</span>.crc32.update(uuid.getBytes());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isNotBlank(memberId)) &#123;</span><br><span class="line">			<span class="keyword">this</span>.crc32.update(memberId.getBytes());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.crc32.update(eventAliasName.getBytes());</span><br><span class="line">		sb.<span class="built_in">append</span>(<span class="keyword">this</span>.crc32.getValue() % <span class="number">100000000</span>L);</span><br><span class="line">		<span class="keyword">return</span> sb.toString();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="map-reduce分析hbase的数据，落到mysql"><a href="#map-reduce分析hbase的数据，落到mysql" class="headerlink" title="map reduce分析hbase的数据，落到mysql"></a>map reduce分析hbase的数据，落到mysql</h1><p>经过不同维度</p>
<h2 id="mysql数据库准备"><a href="#mysql数据库准备" class="headerlink" title="mysql数据库准备"></a>mysql数据库准备</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> <span class="string">'result_db'</span>;</span><br></pre></td></tr></table></figure>
<p>使用<code>mysql_表设计.sql</code>创建表</p>
<h2 id="新用户模块"><a href="#新用户模块" class="headerlink" title="新用户模块"></a>新用户模块</h2><h3 id="NewInstallUserMapper"><a href="#NewInstallUserMapper" class="headerlink" title="NewInstallUserMapper"></a>NewInstallUserMapper</h3><p>经过1次map，输出多个维度，减少网络IO</p>
<p>输出的key <code>StatsUserDimension</code>，包含以下两个维度。分别是普通统计用户</p>
<p>新用户访问数据： 时间  访问平台(js浏览器)  访问浏览器</p>
<p>这样浏览器新用户KPI，可以经过笛卡尔积2*2，统计4个维度的信息。</p>
<table>
<thead>
<tr>
<th></th>
<th>当前浏览器(全部版本)</th>
<th>当前浏览器(版本1.0)</th>
</tr>
</thead>
<tbody>
<tr>
<td>当前平台(js浏览器端或者手机安卓)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>全部平台</td>
<td></td>
</tr>
</tbody>
</table>
<p>另外，只统计新用户KPI，平台信息支持输出，不带浏览器，有2种结果。这样4+2=6种结果。</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> StatsCommonDimension statsCommon = <span class="keyword">new</span> <span class="type">StatsCommonDimension</span>();</span><br><span class="line"><span class="keyword">private</span> BrowserDimension browser = <span class="keyword">new</span> <span class="type">BrowserDimension</span>();</span><br></pre></td></tr></table></figure>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> StatsUserDimension statsUserDimension = <span class="keyword">new</span> <span class="type">StatsUserDimension</span>();</span><br><span class="line"> <span class="keyword">private</span> TimeOutputValue timeOutputValue = <span class="keyword">new</span> <span class="type">TimeOutputValue</span>();</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">package com.sxt.transformer.mr.nu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Result;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.io.ImmutableBytesWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.mapreduce.TableMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.util.Bytes;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sxt.common.DateEnum;</span><br><span class="line"><span class="keyword">import</span> com.sxt.common.EventLogConstants;</span><br><span class="line"><span class="keyword">import</span> com.sxt.common.KpiType;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.dim.StatsCommonDimension;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.dim.StatsUserDimension;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.dim.base.BrowserDimension;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.dim.base.DateDimension;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.dim.base.KpiDimension;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.dim.base.PlatformDimension;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.value.map.TimeOutputValue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewInstallUserMapper</span> <span class="title">extends</span> <span class="title">TableMapper</span>&lt;<span class="title">StatsUserDimension</span>, <span class="title">TimeOutputValue</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> logger = <span class="type">Logger</span>.getLogger(<span class="type">NewInstallUserMapper</span>.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">StatsUserDimension</span> statsUserDimension = new <span class="type">StatsUserDimension</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">TimeOutputValue</span> timeOutputValue = new <span class="type">TimeOutputValue</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> byte[] family = <span class="type">Bytes</span>.toBytes(<span class="type">EventLogConstants</span>.<span class="type">EVENT_LOGS_FAMILY_NAME</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//代表用户分析模块的统计</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">KpiDimension</span> newInstallUserKpi = new <span class="type">KpiDimension</span>(<span class="type">KpiType</span>.<span class="type">NEW_INSTALL_USER</span>.name);</span><br><span class="line">    <span class="comment">//浏览器分析模块的统计</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">KpiDimension</span> newInstallUserOfBrowserKpi = new <span class="type">KpiDimension</span>(<span class="type">KpiType</span>.<span class="type">BROWSER_NEW_INSTALL_USER</span>.name);</span><br><span class="line"></span><br><span class="line">    @<span class="type">Override</span></span><br><span class="line">    protected void <span class="built_in">map</span>(<span class="type">ImmutableBytesWritable</span> key, <span class="type">Result</span> value, <span class="type">Context</span> context)</span><br><span class="line">    		<span class="keyword">throws</span> <span class="type">IOException</span>, <span class="type">InterruptedException</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="type">String</span> uuid = <span class="type">Bytes</span>.<span class="built_in">toString</span>(value.getValue(family, <span class="type">Bytes</span>.toBytes(<span class="type">EventLogConstants</span>.<span class="type">LOG_COLUMN_NAME_UUID</span>)));</span><br><span class="line">		<span class="type">String</span> serverTime = <span class="type">Bytes</span>.<span class="built_in">toString</span>(value.getValue(family, <span class="type">Bytes</span>.toBytes(<span class="type">EventLogConstants</span>.<span class="type">LOG_COLUMN_NAME_SERVER_TIME</span>)));</span><br><span class="line">		<span class="type">String</span> platform = <span class="type">Bytes</span>.<span class="built_in">toString</span>(value.getValue(family, <span class="type">Bytes</span>.toBytes(<span class="type">EventLogConstants</span>.<span class="type">LOG_COLUMN_NAME_PLATFORM</span>)));</span><br><span class="line"></span><br><span class="line">		<span class="type">System</span>.out.<span class="built_in">println</span>(uuid + <span class="string">"-"</span> + serverTime +<span class="string">"-"</span>+ platform);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="type">StringUtils</span>.isBlank(uuid) || <span class="type">StringUtils</span>.isBlank(serverTime) || <span class="type">StringUtils</span>.isBlank(platform)) &#123;</span><br><span class="line">			logger.warn(<span class="string">"uuid&amp;servertime&amp;platform不能为空"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		long longOfTime = <span class="type">Long</span>.valueOf(serverTime.trim());</span><br><span class="line">		timeOutputValue.setTime(longOfTime);</span><br><span class="line">		timeOutputValue.setId(uuid);</span><br><span class="line"></span><br><span class="line">		<span class="type">DateDimension</span> dateDimension = <span class="type">DateDimension</span>.buildDate(longOfTime, <span class="type">DateEnum</span>.<span class="type">DAY</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置date维度</span></span><br><span class="line">        <span class="type">StatsCommonDimension</span> statsCommonDimension = this.statsUserDimension.getStatsCommon();</span><br><span class="line">        statsCommonDimension.setDate(dateDimension);</span><br><span class="line"></span><br><span class="line">        <span class="type">List</span>&lt;<span class="type">PlatformDimension</span>&gt; platformDimensions = <span class="type">PlatformDimension</span>.buildList(platform);</span><br><span class="line"></span><br><span class="line">		<span class="type">String</span> browserName = <span class="type">Bytes</span>.<span class="built_in">toString</span>(value.getValue(family, <span class="type">Bytes</span>.toBytes(<span class="type">EventLogConstants</span>.<span class="type">LOG_COLUMN_NAME_BROWSER_NAME</span>)));</span><br><span class="line">		<span class="type">String</span> browserVersion = <span class="type">Bytes</span>.<span class="built_in">toString</span>(value.getValue(family, <span class="type">Bytes</span>.toBytes(<span class="type">EventLogConstants</span>.<span class="type">LOG_COLUMN_NAME_BROWSER_VERSION</span>)));</span><br><span class="line">		<span class="type">List</span>&lt;<span class="type">BrowserDimension</span>&gt; browserDimensions = <span class="type">BrowserDimension</span>.buildList(browserName, browserVersion);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//空浏览器维度，不考虑浏览器维度</span></span><br><span class="line">        <span class="type">BrowserDimension</span> defaultBrowser = new <span class="type">BrowserDimension</span>(<span class="string">""</span>, <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">PlatformDimension</span> pfDimension : platformDimensions) &#123;</span><br><span class="line">        	statsUserDimension.setBrowser(defaultBrowser);</span><br><span class="line"></span><br><span class="line">        	statsCommonDimension.setKpi(newInstallUserKpi);</span><br><span class="line">        	statsCommonDimension.setPlatform(pfDimension);</span><br><span class="line"></span><br><span class="line">        	context.write(statsUserDimension, timeOutputValue);</span><br><span class="line"></span><br><span class="line">        	<span class="keyword">for</span>(<span class="type">BrowserDimension</span> browserDimension : browserDimensions) &#123;</span><br><span class="line">            	statsUserDimension.setBrowser(browserDimension);</span><br><span class="line">            	statsCommonDimension.setKpi(newInstallUserOfBrowserKpi);</span><br><span class="line"></span><br><span class="line">            	context.write(statsUserDimension, timeOutputValue);</span><br><span class="line">        	&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="NewInstallUserReducer"><a href="#NewInstallUserReducer" class="headerlink" title="NewInstallUserReducer"></a>NewInstallUserReducer</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sxt.transformer.mr.nu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.dim.StatsUserDimension;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.value.<span class="built_in">map</span>.TimeOutputValue;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.value.reduce.MapWritableValue;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.MapWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</span><br><span class="line"><span class="keyword">import</span> com.sxt.common.KpiType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> class NewInstallUserReducer extends Reducer&lt;StatsUserDimension, TimeOutputValue, StatsUserDimension, MapWritableValue&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MapWritableValue outputValue = <span class="keyword">new</span> MapWritableValue();</span><br><span class="line">    <span class="keyword">private</span> Set&lt;<span class="keyword">String</span>&gt; unique = <span class="keyword">new</span> HashSet&lt;<span class="keyword">String</span>&gt;();</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> reduce(StatsUserDimension <span class="built_in">key</span>, Iterable&lt;TimeOutputValue&gt; values,</span><br><span class="line">			Reducer&lt;StatsUserDimension, TimeOutputValue, StatsUserDimension, MapWritableValue&gt;.Context context)</span><br><span class="line">			<span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">		<span class="keyword">this</span>.unique.<span class="built_in">clear</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span>(TimeOutputValue value : values) &#123;</span><br><span class="line">			<span class="keyword">this</span>.unique.<span class="built_in">add</span>(value.getId());</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		MapWritable <span class="built_in">map</span> = <span class="keyword">new</span> MapWritable();</span><br><span class="line">		<span class="built_in">map</span>.put(<span class="keyword">new</span> IntWritable(<span class="number">-1</span>), <span class="keyword">new</span> IntWritable(unique.<span class="built_in">size</span>()));</span><br><span class="line">		outputValue.setValue(<span class="built_in">map</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">String</span> kpiName  = <span class="built_in">key</span>.getStatsCommon().getKpi().getKpiName();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (KpiType.NEW_INSTALL_USER.name.equals(kpiName)) &#123;</span><br><span class="line">			outputValue.setKpi(KpiType.NEW_INSTALL_USER);</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span> (KpiType.BROWSER_NEW_INSTALL_USER.name.equals(kpiName)) &#123;</span><br><span class="line"></span><br><span class="line">			outputValue.setKpi(KpiType.BROWSER_NEW_INSTALL_USER);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		context.write(<span class="built_in">key</span>, outputValue);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意检查配置<code>jdbc:mysql://node01:3306/result_db</code>  zk配置  和 hdfs配置正确。</p>
<h3 id="TransformerOutputFormat"><a href="#TransformerOutputFormat" class="headerlink" title="TransformerOutputFormat"></a>TransformerOutputFormat</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sxt.transformer.mr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.util.<span class="keyword">HashMap</span>;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.JobContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.OutputCommitter;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.OutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.RecordWriter;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.TaskAttemptContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputCommitter;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sxt.common.GlobalConstants;</span><br><span class="line"><span class="keyword">import</span> com.sxt.common.KpiType;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.dim.base.BaseDimension;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.value.BaseStatsValueWritable;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.service.IDimensionConverter;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.service.impl.DimensionConverterImpl;</span><br><span class="line"><span class="keyword">import</span> com.sxt.util.JdbcManager;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义输出到mysql的outputformat类</span></span><br><span class="line"><span class="comment"> * BaseDimension:reducer输出的key</span></span><br><span class="line"><span class="comment"> * BaseStatsValueWritable：reducer输出的value</span></span><br><span class="line"><span class="comment"> * @author root</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> class TransformerOutputFormat extends OutputFormat&lt;BaseDimension, BaseStatsValueWritable&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = Logger.getLogger(TransformerOutputFormat.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义每条数据的输出格式，一条数据就是reducer任务每次执行write方法输出的数据。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @Override</span><br><span class="line">	<span class="keyword">public</span> RecordWriter&lt;BaseDimension, BaseStatsValueWritable&gt; getRecordWriter(TaskAttemptContext context) <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        Configuration conf = context.getConfiguration();</span><br><span class="line">        Connection conn = <span class="keyword">null</span>;</span><br><span class="line">        IDimensionConverter converter = <span class="keyword">new</span> DimensionConverterImpl();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            conn = JdbcManager.getConnection(conf, GlobalConstants.WAREHOUSE_OF_REPORT);</span><br><span class="line">            conn.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            logger.error(<span class="string">"获取数据库连接失败"</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"获取数据库连接失败"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TransformerRecordWriter(conn, conf, converter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> checkOutputSpecs(JobContext context) <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 检测输出空间，输出到mysql不用检测</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> OutputCommitter getOutputCommitter(TaskAttemptContext context) <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FileOutputCommitter(FileOutputFormat.getOutputPath(context), context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义具体数据输出writer</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @author root</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> class TransformerRecordWriter extends RecordWriter&lt;BaseDimension, BaseStatsValueWritable&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> Connection conn = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">private</span> Configuration conf = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">private</span> IDimensionConverter converter = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">private</span> Map&lt;KpiType, PreparedStatement&gt; <span class="built_in">map</span> = <span class="keyword">new</span> <span class="keyword">HashMap</span>&lt;KpiType, PreparedStatement&gt;();</span><br><span class="line">        <span class="keyword">private</span> Map&lt;KpiType, Integer&gt; batch = <span class="keyword">new</span> <span class="keyword">HashMap</span>&lt;KpiType, Integer&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> TransformerRecordWriter(Connection conn, Configuration conf, IDimensionConverter converter) &#123;</span><br><span class="line">            <span class="keyword">super</span>();</span><br><span class="line">            <span class="keyword">this</span>.conn = conn;</span><br><span class="line">            <span class="keyword">this</span>.conf = conf;</span><br><span class="line">            <span class="keyword">this</span>.converter = converter;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 当reduce任务输出数据是，由计算框架自动调用。把reducer输出的数据写到mysql中</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> write(BaseDimension <span class="built_in">key</span>, BaseStatsValueWritable value) <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">key</span> == <span class="keyword">null</span> || value == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                KpiType kpi = value.getKpi();</span><br><span class="line">                PreparedStatement pstmt = <span class="keyword">null</span>;<span class="comment">//每一个pstmt对象对应一个sql语句</span></span><br><span class="line">                <span class="built_in">int</span> count = <span class="number">1</span>;<span class="comment">//sql语句的批处理，一次执行10</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">map</span>.<span class="built_in">get</span>(kpi) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 使用kpi进行区分，返回sql保存到config中</span></span><br><span class="line">                    pstmt = <span class="keyword">this</span>.conn.prepareStatement(conf.<span class="built_in">get</span>(kpi.name));</span><br><span class="line">                    <span class="built_in">map</span>.put(kpi, pstmt);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    pstmt = <span class="built_in">map</span>.<span class="built_in">get</span>(kpi);</span><br><span class="line">                    count = batch.<span class="built_in">get</span>(kpi);</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">                batch.put(kpi, count); <span class="comment">// 批量次数的存储</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">String</span> collectorName = conf.<span class="built_in">get</span>(GlobalConstants.OUTPUT_COLLECTOR_KEY_PREFIX + kpi.name);</span><br><span class="line">                Class&lt;?&gt; clazz = Class.forName(collectorName);</span><br><span class="line">                IOutputCollector collector = (IOutputCollector) clazz.newInstance();<span class="comment">//把value插入到mysql的方法。由于kpi维度不一样。插入到不能表里面。</span></span><br><span class="line">                collector.collect(conf, <span class="built_in">key</span>, value, pstmt, converter);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (count % Integer.valueOf(conf.<span class="built_in">get</span>(GlobalConstants.JDBC_BATCH_NUMBER, GlobalConstants.DEFAULT_JDBC_BATCH_NUMBER)) == <span class="number">0</span>) &#123;</span><br><span class="line">                    pstmt.executeBatch();</span><br><span class="line">                    conn.commit();</span><br><span class="line">                    batch.put(kpi, <span class="number">0</span>); <span class="comment">// 对应批量计算删除</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                logger.error(<span class="string">"在writer中写数据出现异常"</span>, e);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> close(TaskAttemptContext context) <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;KpiType, PreparedStatement&gt; entry : <span class="keyword">this</span>.<span class="built_in">map</span>.entrySet()) &#123;</span><br><span class="line">                    entry.getValue().executeBatch();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                logger.error(<span class="string">"执行executeUpdate方法异常"</span>, e);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (conn != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        conn.commit(); <span class="comment">// 进行connection的提交动作</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="comment">// nothing</span></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (Map.Entry&lt;KpiType, PreparedStatement&gt; entry : <span class="keyword">this</span>.<span class="built_in">map</span>.entrySet()) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            entry.getValue().close();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                            <span class="comment">// nothing</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (conn != <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            conn.close();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            <span class="comment">// nothing</span></span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><p>run as java application 添加 运行参数  <code>-d 2019-06-15</code></p>
<p>跑出结果，<code>dimension_</code>开头为维度表，<code>stats_</code>开头为真正的统计数据</p>
<h1 id="hive和hbase整合"><a href="#hive和hbase整合" class="headerlink" title="hive和hbase整合"></a>hive和hbase整合</h1><h2 id="参考-6"><a href="#参考-6" class="headerlink" title="参考"></a>参考</h2><blockquote>
<p><a href="https://cwiki.apache.org/confluence/display/Hive/HBaseIntegration" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/HBaseIntegration</a></p>
</blockquote>
<h2 id="配置lib"><a href="#配置lib" class="headerlink" title="配置lib"></a>配置lib</h2><p>把hive-hbase-handler-1.2.1.jar  cp到hbase/lib 下</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp hive-hbase-handler-<span class="number">1.2</span>.<span class="number">1</span>.jar $HBASE_HOME/<span class="class"><span class="keyword">lib</span>/</span></span><br></pre></td></tr></table></figure>
<p>同时把hbase中的所有的jar，cp到hive/lib</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -r $HBASE_HOME/<span class="class"><span class="keyword">lib</span>/* ./</span></span><br></pre></td></tr></table></figure>
<h2 id="在hive的配置文件增加属性："><a href="#在hive的配置文件增加属性：" class="headerlink" title="在hive的配置文件增加属性："></a>在hive的配置文件增加属性：</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>node02,node03,node04<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="在hive中创建临时表"><a href="#在hive中创建临时表" class="headerlink" title="在hive中创建临时表"></a>在hive中创建临时表</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> tmp_order</span><br><span class="line">(<span class="keyword">key</span> <span class="keyword">string</span>, <span class="keyword">id</span> <span class="keyword">string</span>, user_id <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">STORED</span> <span class="keyword">BY</span> <span class="string">'org.apache.hadoop.hive.hbase.HBaseStorageHandler'</span></span><br><span class="line"><span class="keyword">WITH</span> SERDEPROPERTIES (<span class="string">"hbase.columns.mapping"</span> = <span class="string">":key,order:order_id,order:user_id"</span>)</span><br><span class="line">TBLPROPERTIES (<span class="string">"hbase.table.name"</span> = <span class="string">"t_order"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> hbasetbl(<span class="keyword">key</span> <span class="built_in">int</span>, <span class="keyword">value</span> <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">STORED</span> <span class="keyword">BY</span> <span class="string">'org.apache.hadoop.hive.hbase.HBaseStorageHandler'</span></span><br><span class="line"><span class="keyword">WITH</span> SERDEPROPERTIES (<span class="string">"hbase.columns.mapping"</span> = <span class="string">":key,cf1:val"</span>)</span><br><span class="line">TBLPROPERTIES (<span class="string">"hbase.table.name"</span> = <span class="string">"xyz"</span>, <span class="string">"hbase.mapred.output.outputtable"</span> = <span class="string">"xyz"</span>);</span><br></pre></td></tr></table></figure>
<h1 id="hive分析sqoop输出到mysql"><a href="#hive分析sqoop输出到mysql" class="headerlink" title="hive分析sqoop输出到mysql"></a>hive分析sqoop输出到mysql</h1><h2 id="在hive中创建hbase的event-log对应表"><a href="#在hive中创建hbase的event-log对应表" class="headerlink" title="在hive中创建hbase的event_log对应表"></a>在hive中创建hbase的event_log对应表</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> event_logs(</span><br><span class="line"><span class="keyword">key</span> <span class="keyword">string</span>, pl <span class="keyword">string</span>, en <span class="keyword">string</span>, s_time <span class="built_in">bigint</span>, p_url <span class="keyword">string</span>, u_ud <span class="keyword">string</span>, u_sd <span class="keyword">string</span></span><br><span class="line">) <span class="keyword">ROW</span> <span class="keyword">FORMAT</span> SERDE <span class="string">'org.apache.hadoop.hive.hbase.HBaseSerDe'</span></span><br><span class="line"><span class="keyword">STORED</span> <span class="keyword">BY</span> <span class="string">'org.apache.hadoop.hive.hbase.HBaseStorageHandler'</span></span><br><span class="line"><span class="keyword">with</span> serdeproperties(<span class="string">'hbase.columns.mapping'</span>=<span class="string">':key,log:pl,log:en,log:s_time,log:p_url,log:u_ud,log:u_sd'</span>)</span><br><span class="line">tblproperties(<span class="string">'hbase.table.name'</span>=<span class="string">'eventlog'</span>);</span><br></pre></td></tr></table></figure>
<h2 id="创建mysql在hive中的对应表"><a href="#创建mysql在hive中的对应表" class="headerlink" title="创建mysql在hive中的对应表"></a>创建mysql在hive中的对应表</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 2. 创建mysql在hive中的对应表，hive中的表，执行HQL之后分析的结果保存该表，然后通过sqoop工具导出到mysql</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`stats_view_depth`</span> (</span><br><span class="line">  <span class="string">`platform_dimension_id`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`data_dimension_id`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`kpi_dimension_id`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`pv1`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`pv2`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`pv3`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`pv4`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`pv5_10`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`pv10_30`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`pv30_60`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`pv60_plus`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`created`</span> <span class="keyword">string</span></span><br><span class="line">) <span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. hive创建临时表:把hql分析之后的中间结果存放到当前的临时表。</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`stats_view_depth_tmp`</span>(<span class="string">`pl`</span> <span class="keyword">string</span>, <span class="string">`date`</span> <span class="keyword">string</span>, <span class="string">`col`</span> <span class="keyword">string</span>, <span class="string">`ct`</span> <span class="built_in">bigint</span>);</span><br></pre></td></tr></table></figure>
<h2 id="编写UDF"><a href="#编写UDF" class="headerlink" title="编写UDF"></a>编写UDF</h2><p>编写<code>UDF(platformdimension &amp; datedimension)</code>需要注意，要删除<code>DimensionConvertClient</code>类中所有<code>FileSystem</code>关闭的操作</p>
<p>node03执行</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">hive</span></span><br></pre></td></tr></table></figure>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add</span><span class="bash"> jar /root/transform_date.jar;</span></span><br></pre></td></tr></table></figure>
<p>创建hive的function</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> date_convert <span class="keyword">as</span> <span class="string">'com.sxt.transformer.hive.DateDimensionUDF'</span>;</span><br></pre></td></tr></table></figure>
<h2 id="统计用户角度的浏览深度"><a href="#统计用户角度的浏览深度" class="headerlink" title="统计用户角度的浏览深度"></a>统计用户角度的浏览深度</h2><h3 id="分析得到临时表stats-view-depth-tmp"><a href="#分析得到临时表stats-view-depth-tmp" class="headerlink" title="分析得到临时表stats_view_depth_tmp"></a>分析得到临时表stats_view_depth_tmp</h3><ul>
<li>tmp表</li>
</ul>
<p>可以将tmp，拆分了看比较清晰。</p>
<p>统计每个用户、每个平台，在当天的访问次数</p>
<ul>
<li>stats_view_depth_tmp</li>
</ul>
<p>groupby pl,day,pv数，将u_ud distinct求和，得出当天的平台的某个pv数的用户数，即pv</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 7. hql编写(统计用户角度的浏览深度)&lt;注意：时间为外部给定&gt;</span></span><br><span class="line">from (</span><br><span class="line">  <span class="keyword">select</span></span><br><span class="line">    pl, from_unixtime(<span class="keyword">cast</span>(s_time/<span class="number">1000</span> <span class="keyword">as</span> <span class="built_in">bigint</span>),<span class="string">'yyyy-MM-dd'</span>) <span class="keyword">as</span> <span class="keyword">day</span>, u_ud,</span><br><span class="line">    (<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">count</span>(p_url) = <span class="number">1</span> <span class="keyword">then</span> <span class="string">"pv1"</span></span><br><span class="line">      <span class="keyword">when</span> <span class="keyword">count</span>(p_url) = <span class="number">2</span> <span class="keyword">then</span> <span class="string">"pv2"</span></span><br><span class="line">      <span class="keyword">when</span> <span class="keyword">count</span>(p_url) = <span class="number">3</span> <span class="keyword">then</span> <span class="string">"pv3"</span></span><br><span class="line">      <span class="keyword">when</span> <span class="keyword">count</span>(p_url) = <span class="number">4</span> <span class="keyword">then</span> <span class="string">"pv4"</span></span><br><span class="line">      <span class="keyword">when</span> <span class="keyword">count</span>(p_url) &gt;= <span class="number">5</span> <span class="keyword">and</span> <span class="keyword">count</span>(p_url) &lt;<span class="number">10</span> <span class="keyword">then</span> <span class="string">"pv5_10"</span></span><br><span class="line">      <span class="keyword">when</span> <span class="keyword">count</span>(p_url) &gt;= <span class="number">10</span> <span class="keyword">and</span> <span class="keyword">count</span>(p_url) &lt;<span class="number">30</span> <span class="keyword">then</span> <span class="string">"pv10_30"</span></span><br><span class="line">      <span class="keyword">when</span> <span class="keyword">count</span>(p_url) &gt;=<span class="number">30</span> <span class="keyword">and</span> <span class="keyword">count</span>(p_url) &lt;<span class="number">60</span> <span class="keyword">then</span> <span class="string">"pv30_60"</span></span><br><span class="line">      <span class="keyword">else</span> <span class="string">'pv60_plus'</span> <span class="keyword">end</span>) <span class="keyword">as</span> pv</span><br><span class="line">  <span class="keyword">from</span> event_logs</span><br><span class="line">  <span class="keyword">where</span></span><br><span class="line">    en=<span class="string">'e_pv'</span></span><br><span class="line">    <span class="keyword">and</span> p_url <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">    <span class="keyword">and</span> pl <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">    <span class="keyword">and</span> s_time &gt;= <span class="keyword">unix_timestamp</span>(<span class="string">'2019-06-15'</span>,<span class="string">'yyyy-MM-dd'</span>)*<span class="number">1000</span></span><br><span class="line">    <span class="keyword">and</span> s_time &lt; <span class="keyword">unix_timestamp</span>(<span class="string">'2019-06-16'</span>,<span class="string">'yyyy-MM-dd'</span>)*<span class="number">1000</span></span><br><span class="line">  <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    pl, from_unixtime(<span class="keyword">cast</span>(s_time/<span class="number">1000</span> <span class="keyword">as</span> <span class="built_in">bigint</span>),<span class="string">'yyyy-MM-dd'</span>), u_ud</span><br><span class="line">) <span class="keyword">as</span> tmp</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> stats_view_depth_tmp</span><br><span class="line">  <span class="keyword">select</span> pl,<span class="keyword">day</span>,pv,<span class="keyword">count</span>(<span class="keyword">distinct</span> u_ud) <span class="keyword">as</span> ct <span class="keyword">where</span> u_ud <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">group</span> <span class="keyword">by</span> pl,<span class="keyword">day</span>,pv;</span><br></pre></td></tr></table></figure>
<h3 id="多行转1行"><a href="#多行转1行" class="headerlink" title="多行转1行"></a>多行转1行</h3><p>平台 日期 pv1 用户数</p>
<p>展开转换为 pv2 pv5 pv10 等都为0</p>
<p>平台 日期 pv1 0 0 0 0 用户数</p>
<table>
<thead>
<tr>
<th>pl</th>
<th>date</th>
<th>pv1</th>
<th>pv2</th>
<th>pv3</th>
<th>pv4</th>
<th>pv5</th>
<th>pv10</th>
<th>pv30</th>
<th>pv60</th>
</tr>
</thead>
<tbody>
<tr>
<td>web_site</td>
<td>2019-06-15</td>
<td>5</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,ct <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus <span class="keyword">from</span> stats_view_depth_tmp <span class="keyword">where</span> <span class="keyword">col</span>=<span class="string">'pv1'</span></span><br></pre></td></tr></table></figure>
<p>这样之后，pv1到pv60，都合并求和。合并成1行。</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">--把临时表的多行数据，转换一行</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tmp <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,ct <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv1'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,ct <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv2'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,ct <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv3'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,ct <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv4'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,ct <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv5_10'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,ct <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv10_30'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,ct <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv30_60'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,ct <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv60_plus'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,ct <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv1'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,ct <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv2'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,ct <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv3'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,ct <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv4'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,ct <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv5_10'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,ct <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv10_30'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,ct <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv30_60'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,ct <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv60_plus'</span></span><br><span class="line">)</span><br><span class="line">from tmp</span><br><span class="line">insert overwrite table stats_view_depth</span><br><span class="line"><span class="keyword">select</span> <span class="number">2</span>,<span class="number">3</span>,<span class="number">6</span>,sum(pv1),sum(pv2),sum(pv3),sum(pv4),sum(pv5_10),sum(pv10_30),sum(pv30_60),sum(pv60_plus),<span class="string">'2019-06-15'</span> group by pl,date1;</span><br></pre></td></tr></table></figure>
<p>上面sql中的2，3，6要先计算出来，这里先手工填入。</p>
<h3 id="sqoop脚本编写-统计用户角度"><a href="#sqoop脚本编写-统计用户角度" class="headerlink" title="sqoop脚本编写(统计用户角度)"></a>sqoop脚本编写(统计用户角度)</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqoop export <span class="params">--connect</span> jdbc<span class="function">:mysql</span>:<span class="string">//node01</span><span class="function">:3306</span>/result_db <span class="params">--username</span> root <span class="params">--password</span> 123 <span class="params">--table</span> stats_view_depth <span class="params">--export-dir</span> <span class="string">/user/hive/warehouse/stats_view_depth/</span>* <span class="params">--input-fields-terminated-by</span> <span class="string">"\t"</span> <span class="params">--update-mode</span> allowinsert <span class="params">--update-key</span> platform_dimension_id,data_dimension_id,kpi_dimension_id</span><br></pre></td></tr></table></figure>
<p>–export-dir hive表对应的hdfs位置</p>
<p>–input-fields-terminated-by hive表的字段分隔符</p>
<p>–update-mode 更新模式</p>
<p>–update-key 更新key</p>
<p>成功输出到mysql</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span>	<span class="number">3</span>	<span class="number">6</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">1</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">2019</span><span class="number">-06</span><span class="number">-15</span></span><br></pre></td></tr></table></figure>
<h3 id="shell定时任务"><a href="#shell定时任务" class="headerlink" title="shell定时任务"></a>shell定时任务</h3><p>使用cron 定时执行sqoop命令</p>
<p>参考 ``</p>
<h2 id="统计会话角度的浏览深度"><a href="#统计会话角度的浏览深度" class="headerlink" title="统计会话角度的浏览深度"></a>统计会话角度的浏览深度</h2><h3 id="统计当天每个会话数段的"><a href="#统计当天每个会话数段的" class="headerlink" title="统计当天每个会话数段的"></a>统计当天每个会话数段的</h3><p>tmp表： group by pl,date , u_sd  每个会话id的 pv数</p>
<p>stats_view_depth_tmp： 每个会话数段的 会话数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 8. hql编写(统计会话角度的浏览深度)&lt;注意：时间为外部给定&gt;</span></span><br><span class="line">from (</span><br><span class="line"><span class="keyword">select</span> pl, from_unixtime(<span class="keyword">cast</span>(s_time/<span class="number">1000</span> <span class="keyword">as</span> <span class="built_in">bigint</span>),<span class="string">'yyyy-MM-dd'</span>) <span class="keyword">as</span> <span class="keyword">day</span>, u_sd, (<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">count</span>(p_url) = <span class="number">1</span> <span class="keyword">then</span> <span class="string">"pv1"</span> <span class="keyword">when</span> <span class="keyword">count</span>(p_url) = <span class="number">2</span> <span class="keyword">then</span> <span class="string">"pv2"</span> <span class="keyword">when</span> <span class="keyword">count</span>(p_url) = <span class="number">3</span> <span class="keyword">then</span> <span class="string">"pv3"</span> <span class="keyword">when</span> <span class="keyword">count</span>(p_url) = <span class="number">4</span> <span class="keyword">then</span> <span class="string">"pv4"</span> <span class="keyword">when</span> <span class="keyword">count</span>(p_url) &gt;= <span class="number">5</span> <span class="keyword">and</span> <span class="keyword">count</span>(p_url) &lt;<span class="number">10</span> <span class="keyword">then</span> <span class="string">"pv5_10"</span> <span class="keyword">when</span> <span class="keyword">count</span>(p_url) &gt;= <span class="number">10</span> <span class="keyword">and</span> <span class="keyword">count</span>(p_url) &lt;<span class="number">30</span> <span class="keyword">then</span> <span class="string">"pv10_30"</span> <span class="keyword">when</span> <span class="keyword">count</span>(p_url) &gt;=<span class="number">30</span> <span class="keyword">and</span> <span class="keyword">count</span>(p_url) &lt;<span class="number">60</span> <span class="keyword">then</span> <span class="string">"pv30_60"</span>  <span class="keyword">else</span> <span class="string">'pv60_plus'</span> <span class="keyword">end</span>) <span class="keyword">as</span> pv</span><br><span class="line"><span class="keyword">from</span> event_logs</span><br><span class="line"><span class="keyword">where</span> en=<span class="string">'e_pv'</span> <span class="keyword">and</span> p_url <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">and</span> pl <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">and</span> s_time &gt;= <span class="keyword">unix_timestamp</span>(<span class="string">'2019-06-15'</span>,<span class="string">'yyyy-MM-dd'</span>)*<span class="number">1000</span> <span class="keyword">and</span> s_time &lt; <span class="keyword">unix_timestamp</span>(<span class="string">'2019-06-16'</span>,<span class="string">'yyyy-MM-dd'</span>)*<span class="number">1000</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> pl, from_unixtime(<span class="keyword">cast</span>(s_time/<span class="number">1000</span> <span class="keyword">as</span> <span class="built_in">bigint</span>),<span class="string">'yyyy-MM-dd'</span>), u_sd</span><br><span class="line">) <span class="keyword">as</span> tmp</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> stats_view_depth_tmp <span class="keyword">select</span> pl,<span class="keyword">day</span>,pv,<span class="keyword">count</span>(<span class="keyword">distinct</span> u_sd) <span class="keyword">as</span> ct <span class="keyword">where</span> u_sd <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">group</span> <span class="keyword">by</span> pl,<span class="keyword">day</span>,pv;</span><br></pre></td></tr></table></figure>
<h3 id="多行转1行-1"><a href="#多行转1行-1" class="headerlink" title="多行转1行"></a>多行转1行</h3><p>date_convert 日期转换函数</p>
<p>platform_convert 平台转化函数</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">with</span> tmp <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> pl,date,ct <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv1'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,ct <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv2'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,ct <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv3'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,ct <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv4'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,ct <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv5_10'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,ct <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv10_30'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,ct <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv30_60'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,ct <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv60_plus'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,date,ct <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv1'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,ct <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv2'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,ct <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv3'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,ct <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv4'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,ct <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv5_10'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,ct <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv10_30'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,ct <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv30_60'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,ct <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv60_plus'</span></span><br><span class="line">)</span><br><span class="line">from tmp</span><br><span class="line">insert overwrite table stats_view_depth</span><br><span class="line"><span class="keyword">select</span> platform_convert(pl),date_convert(date),<span class="number">6</span>,sum(pv1),sum(pv2),sum(pv3),sum(pv4),sum(pv5_10),sum(pv10_30),sum(pv30_60),sum(pv60_plus),<span class="string">'2019-06-15'</span> group by pl,date;</span><br><span class="line"></span><br><span class="line">-- <span class="number">9</span>. sqoop脚步编写(统计会话角度)</span><br><span class="line">sqoop export --connect <span class="symbol">jdbc:</span><span class="symbol">mysql:</span>/<span class="regexp">/node01:3306/result</span>_db --username root --password <span class="number">123</span> --table stats_view_depth --export-dir /user/hive/warehouse/stats_view_depth/* --input-fields-terminated-by <span class="string">"\t"</span> --update-mode allowinsert --update-key platform_dimension_id,data_dimension_id,kpi_dimension_id</span><br><span class="line"></span><br><span class="line">-- <span class="number">10</span>. shell脚步编写</span><br></pre></td></tr></table></figure>
<h1 id="sqoop"><a href="#sqoop" class="headerlink" title="sqoop"></a>sqoop</h1><ul>
<li><p>将关系数据库（oracle、mysql、postgresql等）数据与hadoop数据进行转换的工具</p>
</li>
<li><p>sqoop由client端直接接入hadoop，任务通过解析生成对应的maprecue执行</p>
</li>
</ul>
<h2 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h2><p>node04中解压安装，注意下载完整版</p>
<blockquote>
<p><a href="http://www.apache.org/dyn/closer.lua/sqoop/1.4.7" target="_blank" rel="external">http://www.apache.org/dyn/closer.lua/sqoop/1.4.7</a></p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp /Users/zhouxiaowu/big-data/sqoop-<span class="number">1.4</span>.<span class="number">7</span><span class="selector-class">.bin__hadoop-2</span>.<span class="number">6.0</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span>  root@node04:/root/</span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv sqoop-<span class="number">1.4</span>.<span class="number">7</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span> /usr/install/</span><br><span class="line">tar -zxvf sqoop-<span class="number">1.4</span>.<span class="number">7</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br></pre></td></tr></table></figure>
<p>配置环境变量</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">SQOOP_HOME</span>=/usr/install/sqoop-1.4.7</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="variable">$PATH</span>:$JAVA_HOME/bin:$ZOOKEEPER_HOME/bin:$HADOOP_HOME/bin:$HADOOP_HOME/sbin:$HBASE_HOME/bin:$SQOOP_HOME/bin</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<p>添加数据库驱动包</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp <span class="regexp">/Users/</span>zhouxiaowu<span class="regexp">/big-data/</span>hadoop项目<span class="number">1</span><span class="regexp">/01资料/</span>mysql-connector-java<span class="number">-5.1</span><span class="number">.26</span>-bin.jar  root<span class="meta">@node</span><span class="number">04:</span><span class="regexp">/root/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv ~/mysql-connector-java<span class="number">-5.1</span><span class="number">.26</span>-bin.jar lib/</span><br></pre></td></tr></table></figure>
<p>重命名配置文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">mv</span> <span class="selector-tag">sqoop-env-template</span><span class="selector-class">.sh</span> <span class="selector-tag">sqoop-env</span><span class="selector-class">.sh</span></span><br></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sqoop </span><span class="string">version</span></span><br><span class="line"><span class="string">sqoop </span><span class="built_in">list-databases</span> -<span class="string">connect </span><span class="string">jdbc:mysql:</span>//<span class="string">node01:3306/</span> -<span class="string">username </span><span class="string">root </span>-<span class="string">password </span><span class="string">123</span></span><br></pre></td></tr></table></figure>
<p>去除警告</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">vi configure-sqoop</span></span><br></pre></td></tr></table></figure>
<p>去掉未安装服务相关内容， 例如（HBase、HCatalog、Accumulo）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">if</span> [ ! -d <span class="string">"<span class="variable">$&#123;HBASE_HOME&#125;</span>"</span> ]; <span class="keyword">then</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  <span class="built_in">echo</span> <span class="string">"Error: <span class="variable">$HBASE_HOME</span> does not exist!"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  <span class="built_in">echo</span> <span class="string">'Please set $HBASE_HOME to the root of your HBase installation.'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  <span class="built_in">exit</span> 1</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="http://sqoop.apache.org/docs/1.4.7/SqoopUserGuide.html" target="_blank" rel="external">http://sqoop.apache.org/docs/1.4.7/SqoopUserGuide.html</a></p>
</blockquote>
<h2 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h2><ul>
<li>命令行方式</li>
<li>文件配置方式</li>
</ul>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$</span> sqoop import --connect jdbc:mysql:<span class="comment">//localhost/db --username foo --table TEST</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">$</span> sqoop --<span class="keyword">options</span>-<span class="keyword">file</span> /users/homer/work/import.txt --<span class="keyword">table</span> TEST</span><br></pre></td></tr></table></figure>
<p>参考</p>
<blockquote>
<p><a href="http://sqoop.apache.org/docs/1.4.6/SqoopUserGuide.html#_literal_sqoop_import_literal" target="_blank" rel="external">http://sqoop.apache.org/docs/1.4.6/SqoopUserGuide.html#_literal_sqoop_import_literal</a></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_test</span><br><span class="line">(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">default</span> <span class="string">'0'</span> <span class="literal">null</span>,</span><br><span class="line">	<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">default</span> <span class="string">''</span> <span class="literal">null</span></span><br><span class="line">)</span><br><span class="line">;</span><br></pre></td></tr></table></figure>
<h3 id="mysql导入到hdfs"><a href="#mysql导入到hdfs" class="headerlink" title="mysql导入到hdfs"></a>mysql导入到hdfs</h3><p><code>vi option1</code></p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import</span><br><span class="line">-<span class="ruby">-connect</span></span><br><span class="line"><span class="ruby"><span class="symbol">jdbc:</span><span class="symbol">mysql:</span>/<span class="regexp">/node01:3306/test</span></span></span><br><span class="line"><span class="ruby">--username</span></span><br><span class="line"><span class="ruby">root</span></span><br><span class="line"><span class="ruby">--password</span></span><br><span class="line"><span class="ruby"><span class="number">123</span></span></span><br><span class="line"><span class="ruby">--as-textfile</span></span><br><span class="line"><span class="ruby">--columns</span></span><br><span class="line"><span class="ruby">id,name</span></span><br><span class="line"><span class="ruby">--table</span></span><br><span class="line"><span class="ruby">t_test</span></span><br><span class="line"><span class="ruby">--delete-target-dir</span></span><br><span class="line"><span class="ruby">--target-dir</span></span><br><span class="line"><span class="ruby">/sqoop/data</span></span><br><span class="line"><span class="ruby">-m</span></span><br><span class="line"><span class="ruby"><span class="number">1</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqoop --<span class="keyword">options</span>-<span class="keyword">file</span> <span class="regexp">/root/</span>sqoop_option<span class="regexp">/option1</span></span><br></pre></td></tr></table></figure>
<h3 id="mysql导入到hdfs，带查询"><a href="#mysql导入到hdfs，带查询" class="headerlink" title="mysql导入到hdfs，带查询"></a>mysql导入到hdfs，带查询</h3><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi optio<span class="symbol">n2</span></span><br></pre></td></tr></table></figure>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import</span><br><span class="line">-<span class="ruby">-connect</span></span><br><span class="line"><span class="ruby"><span class="symbol">jdbc:</span><span class="symbol">mysql:</span>/<span class="regexp">/node01/test</span></span></span><br><span class="line"><span class="ruby">--username</span></span><br><span class="line"><span class="ruby">root</span></span><br><span class="line"><span class="ruby">--password</span></span><br><span class="line"><span class="ruby"><span class="number">123</span></span></span><br><span class="line"><span class="ruby">--as-textfile</span></span><br><span class="line"><span class="ruby">--query</span></span><br><span class="line"><span class="ruby"><span class="string">'select id, name, msg from psn where id like "1%" and $CONDITIONS'</span></span></span><br><span class="line"><span class="ruby">--delete-target-dir</span></span><br><span class="line"><span class="ruby">--target-dir</span></span><br><span class="line"><span class="ruby">/sqoop/tmp</span></span><br><span class="line"><span class="ruby">-m</span></span><br><span class="line"><span class="ruby"><span class="number">1</span></span></span><br><span class="line"><span class="ruby">--hive-home</span></span><br><span class="line"><span class="ruby">/home/hive-<span class="number">1.2</span>.<span class="number">1</span></span></span><br><span class="line"><span class="ruby">--hive-import</span></span><br><span class="line"><span class="ruby">--create-hive-table</span></span><br><span class="line"><span class="ruby">--hive-table</span></span><br><span class="line"><span class="ruby">t_test</span></span><br></pre></td></tr></table></figure>
<h2 id="导出"><a href="#导出" class="headerlink" title="导出"></a>导出</h2><p>参考</p>
<blockquote>
<p><a href="http://sqoop.apache.org/docs/1.4.6/SqoopUserGuide.html#_literal_sqoop_export_literal" target="_blank" rel="external">http://sqoop.apache.org/docs/1.4.6/SqoopUserGuide.html#_literal_sqoop_export_literal</a></p>
</blockquote>
<p>创建mysql表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_test2</span><br><span class="line">(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">default</span> <span class="string">'0'</span> <span class="literal">null</span>,</span><br><span class="line">	<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">default</span> <span class="string">''</span> <span class="literal">null</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>创建命令配置</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi optio<span class="symbol">n3</span></span><br></pre></td></tr></table></figure>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">export</span><br><span class="line">-<span class="ruby">-connect</span></span><br><span class="line"><span class="ruby"><span class="symbol">jdbc:</span><span class="symbol">mysql:</span>/<span class="regexp">/node01/test</span></span></span><br><span class="line"><span class="ruby">--username</span></span><br><span class="line"><span class="ruby">root</span></span><br><span class="line"><span class="ruby">--password</span></span><br><span class="line"><span class="ruby"><span class="number">123</span></span></span><br><span class="line"><span class="ruby">-m</span></span><br><span class="line"><span class="ruby"><span class="number">1</span></span></span><br><span class="line"><span class="ruby">--columns</span></span><br><span class="line"><span class="ruby">id,name</span></span><br><span class="line"><span class="ruby">--export-dir</span></span><br><span class="line"><span class="ruby">/sqoop/data</span></span><br><span class="line"><span class="ruby">--table</span></span><br><span class="line"><span class="ruby">t_test2</span></span><br></pre></td></tr></table></figure>
<p>执行</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqoop --<span class="keyword">options</span>-<span class="keyword">file</span> <span class="regexp">/root/</span>sqoop_option<span class="regexp">/option3</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/06/12/java线程池设置指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/12/java线程池设置指南/" itemprop="url">java线程池设置指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-12T09:46:56+08:00">
                2019-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java基础/" itemprop="url" rel="index">
                    <span itemprop="name">java基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/12/java线程池设置指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/06/12/java线程池设置指南/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  273
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="线程数设置公式"><a href="#线程数设置公式" class="headerlink" title="线程数设置公式"></a>线程数设置公式</h2><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">最佳线程数目 = （（线程等待时间+线程<span class="meta">CPU</span>时间）/线程<span class="meta">CPU</span>时间 ）* <span class="meta">CPU</span>数目</span><br></pre></td></tr></table></figure>
<p><strong>服务器CPU核数为4核，一个任务线程cpu耗时为20ms，线程等待（网络IO、磁盘IO）耗时80ms，那最佳线程数目：( 80 + 20 )/20 * 4 = 20</strong>。也就是设置20个线程数最佳。</p>
<p>从这个公式上面我们就得出，<strong>线程的等待时间越大，线程数就要设置越大</strong>，这个正好符合我们上面的分析，可提升CPU利用率。那从另一个角度上面说，<strong>线程数设置多大，是根据我们自身的业务的，需要自己去压力测试，设置一个合理的数值。</strong></p>
<h2 id="常用标准设置"><a href="#常用标准设置" class="headerlink" title="常用标准设置"></a>常用标准设置</h2><p><strong>CPU密集型：</strong>操作内存处理的业务，一般线程数设置为：CPU核数 + 1 或者 CPU核数<em>2<br>核数为4的话，一般设置 5 或 8<br><em>*IO密集型：</em></em> 文件操作，网络操作，数据库操作，一般线程设置为：cpu核数 / (1-0.9)<br>核数为4的话，一般设置 40</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/06/11/jfr采集使用及jmc分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/11/jfr采集使用及jmc分析/" itemprop="url">jfr采集使用及jmc分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-11T10:49:20+08:00">
                2019-06-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/线上故障排查/" itemprop="url" rel="index">
                    <span itemprop="name">线上故障排查</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/11/jfr采集使用及jmc分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/06/11/jfr采集使用及jmc分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  195
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="找到java进程"><a href="#找到java进程" class="headerlink" title="找到java进程"></a>找到java进程</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ps</span> -ef | <span class="keyword">grep</span> java</span><br></pre></td></tr></table></figure>
<h2 id="解锁Java程序的商业特性"><a href="#解锁Java程序的商业特性" class="headerlink" title="解锁Java程序的商业特性"></a>解锁Java程序的商业特性</h2><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jcmd 12174 VM.check_commercial_features</span><br><span class="line"></span><br><span class="line">12174:</span><br><span class="line">Commercial Features <span class="keyword">are</span> <span class="keyword">locked</span>.</span><br></pre></td></tr></table></figure>
<h2 id="采集JFR"><a href="#采集JFR" class="headerlink" title="采集JFR"></a>采集JFR</h2><h3 id="固定时长采集"><a href="#固定时长采集" class="headerlink" title="固定时长采集"></a>固定时长采集</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jcmd <span class="variable">$pid</span> JFR.start <span class="attribute">name</span>=myrec <span class="attribute">settings</span>=temple <span class="attribute">delay</span>=20s <span class="attribute">duration</span>=2m <span class="attribute">filename</span>=/tmp/$pid.jfr</span><br><span class="line"></span><br><span class="line">jcmd 12174 JFR.start <span class="attribute">name</span>=10min.jfr <span class="attribute">settings</span>=profile <span class="attribute">delay</span>=3s <span class="attribute">duration</span>=5m</span><br></pre></td></tr></table></figure>
<h3 id="持续采集JFR"><a href="#持续采集JFR" class="headerlink" title="持续采集JFR"></a>持续采集JFR</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jcmd 12174 JFR.start <span class="attribute">name</span>=endless <span class="attribute">settings</span>=profile <span class="attribute">delay</span>=3s <span class="attribute">duration</span>=0  <span class="attribute">compress</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>对于这种持续采集的任务，我们需要手动转存：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jcmd 12174 JFR.dump <span class="attribute">recording</span>=3 <span class="attribute">filename</span>=<span class="string">"/Users/jianyuan/Personal/dump_endless.jfr"</span> <span class="attribute">compress</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="分析JFR文件"><a href="#分析JFR文件" class="headerlink" title="分析JFR文件"></a>分析JFR文件</h2><p>线下输入<code>jmc</code></p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">jmc</span></span><br></pre></td></tr></table></figure>
<p>打开<code>java mission control</code></p>
<p>选择打开导出的jfr文件</p>
<h3 id="分析角度"><a href="#分析角度" class="headerlink" title="分析角度"></a>分析角度</h3><p>一般来说可以从下面几个方式来入手：</p>
<ul>
<li>应用异常</li>
<li>热点线程和方法</li>
<li>不合预期的IO</li>
<li>过长的GC</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><blockquote>
<p><a href="https://blog.csdn.net/yue530tomtom/article/details/80805412" target="_blank" rel="external">https://blog.csdn.net/yue530tomtom/article/details/80805412</a></p>
<p><a href="http://www.manongjc.com/article/7589.html" target="_blank" rel="external">http://www.manongjc.com/article/7589.html</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/06/11/Arthas使用文档/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/11/Arthas使用文档/" itemprop="url">Arthas使用文档</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-11T09:51:12+08:00">
                2019-06-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/线上故障排查/" itemprop="url" rel="index">
                    <span itemprop="name">线上故障排查</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/11/Arthas使用文档/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/06/11/Arthas使用文档/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  92
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="手动安装推荐"><a href="#手动安装推荐" class="headerlink" title="手动安装推荐"></a>手动安装推荐</h2><p><a href="https://alibaba.github.io/arthas/manual-install.html" target="_blank" rel="external">https://alibaba.github.io/arthas/manual-install.html</a></p>
<h1 id="使用命令"><a href="#使用命令" class="headerlink" title="使用命令"></a>使用命令</h1><h2 id="watch-查看方法的返回值"><a href="#watch-查看方法的返回值" class="headerlink" title="watch 查看方法的返回值"></a>watch 查看方法的返回值</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">watch demo<span class="selector-class">.MathGame</span> primeFactors returnObj</span><br><span class="line">watch</span><br></pre></td></tr></table></figure>
<h2 id="stack-查看方法调用栈"><a href="#stack-查看方法调用栈" class="headerlink" title="stack 查看方法调用栈"></a>stack 查看方法调用栈</h2><p>参考</p>
<blockquote>
<p><a href="https://alibaba.github.io/arthas/stack.html" target="_blank" rel="external">https://alibaba.github.io/arthas/stack.html</a></p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stack demo<span class="selector-class">.MathGame</span> primeFactors</span><br></pre></td></tr></table></figure>
<h2 id="thread"><a href="#thread" class="headerlink" title="thread"></a>thread</h2><p>参考</p>
<blockquote>
<p><a href="https://alibaba.github.io/arthas/thread.html" target="_blank" rel="external">https://alibaba.github.io/arthas/thread.html</a></p>
</blockquote>
<h3 id="当前最忙的前N个线程"><a href="#当前最忙的前N个线程" class="headerlink" title="当前最忙的前N个线程"></a>当前最忙的前N个线程</h3><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">thread</span> -n <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h3 id="找出当前阻塞其他线程的线程"><a href="#找出当前阻塞其他线程的线程" class="headerlink" title="找出当前阻塞其他线程的线程"></a>找出当前阻塞其他线程的线程</h3><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">thread</span> -b</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/06/08/HBase原理案例及搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/08/HBase原理案例及搭建/" itemprop="url">HBase原理案例及搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-08T11:16:12+08:00">
                2019-06-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/08/HBase原理案例及搭建/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/06/08/HBase原理案例及搭建/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  8
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="HBase-数据模型"><a href="#HBase-数据模型" class="headerlink" title="HBase 数据模型"></a>HBase 数据模型</h1><table>
<thead>
<tr>
<th>Row   Key</th>
<th>Time   Stamp</th>
<th>CF1</th>
<th>CF2</th>
<th>CF3</th>
</tr>
</thead>
<tbody>
<tr>
<td>11248112</td>
<td>t6</td>
<td></td>
<td>CF2:q1=val1</td>
<td>CF3:q3=val3</td>
</tr>
<tr>
<td></td>
<td>t3</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>t2</td>
<td>CF1:q2=val2</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="ROW-KEY"><a href="#ROW-KEY" class="headerlink" title="ROW  KEY"></a>ROW  KEY</h2><ul>
<li>决定一行数据</li>
<li>按照字典顺序排序的。</li>
<li>Row key只能存储64k的字节数据</li>
</ul>
<h2 id="Column-Family列族"><a href="#Column-Family列族" class="headerlink" title="Column Family列族"></a>Column Family列族</h2><ul>
<li><p>HBase表中的每个列都归属于某个列族，列族必须作为表模式(schema)定义的一部分预先给出。如<code>create &#39;tbl&#39;, ‘cf’</code></p>
</li>
<li><p>列名以列族作为前缀，<code>cf:name</code></p>
</li>
<li><p>权限控制、存储以及调优都是在列族层面进行的；</p>
</li>
<li>HBase把同一列族里面的数据存储在同一目录下，由几个文件保存。</li>
</ul>
<h2 id="Timestamp时间戳"><a href="#Timestamp时间戳" class="headerlink" title="Timestamp时间戳"></a>Timestamp时间戳</h2><ul>
<li>在HBase每个cell存储单元对同一份数据有多个版本，根据唯一的时间戳来区分每个版本之间的差异，不同版本的数据按照时间倒序排序，最新的数据版本排在最前面。</li>
<li>时间戳的类型是 64位整型。</li>
<li>时间戳可以由HBase(在数据写入时自动)赋值，此时时间戳是精确到毫秒的当前系统时间。</li>
<li>时间戳也可以由客户显式赋值，如果应用程序要避免数据版本冲突，就必须自己生成具有唯一性的时间戳。</li>
</ul>
<h2 id="Cell单元格"><a href="#Cell单元格" class="headerlink" title="Cell单元格"></a>Cell单元格</h2><ul>
<li><p>由<code>{row key， column(&lt;family&gt; +&lt;qualifier&gt;)， version}</code>唯一确定的单元。</p>
</li>
<li><p>cell中的数据是没有类型的，全部是字节码形式存贮。</p>
</li>
</ul>
<h2 id="HLog-WAL-log"><a href="#HLog-WAL-log" class="headerlink" title="HLog(WAL log)"></a>HLog(WAL log)</h2><ul>
<li><p>HLog文件就是一个普通的Hadoop Sequence File，Sequence File 的Key是HLogKey对象，HLogKey中记录了写入数据的归属信息，除了table和region名字外，同时还包括 sequence number和timestamp，timestamp是” 写入时间”，sequence number的起始值为0，或者是最近一次存入文件系统中sequence number。</p>
</li>
<li><p>类似binlog</p>
</li>
</ul>
<h1 id="HBase-架构"><a href="#HBase-架构" class="headerlink" title="HBase 架构"></a>HBase 架构</h1><p><img src="/2019/06/08/HBase原理案例及搭建/01.png" alt="01"></p>
<h2 id="写流程"><a href="#写流程" class="headerlink" title="写流程"></a>写流程</h2><ul>
<li>client记录写入数据，到Hlog</li>
<li>memstore</li>
<li>memstore达到阈值,写入到store file</li>
</ul>
<h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><ul>
<li>包含访问HBase的接口并维护cache来加快对HBase的访问</li>
</ul>
<h2 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a>Zookeeper</h2><ul>
<li><p>保证任何时候，集群中只有一个master</p>
</li>
<li><p>存贮所有Region的寻址入口。</p>
</li>
<li><p>实时监控Region server的上线和下线信息。并实时通知Master</p>
</li>
<li><p>存储HBase的schema和table元数据</p>
</li>
</ul>
<h2 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h2><ul>
<li><p>为Region server分配region</p>
</li>
<li><p>负责Region server的负载均衡</p>
</li>
<li><p>发现失效的Region server并重新分配其上的region</p>
</li>
<li><p>管理用户对table的增删改操作</p>
</li>
</ul>
<h2 id="RegionServer"><a href="#RegionServer" class="headerlink" title="RegionServer"></a>RegionServer</h2><ul>
<li><p>Region server维护region，处理对这些region的IO请求</p>
</li>
<li><p>Region server负责切分在运行过程中变得过大的region</p>
</li>
</ul>
<h2 id="Region"><a href="#Region" class="headerlink" title="Region"></a>Region</h2><ul>
<li><p>HBase自动把表水平划分成多个区域(region)，每个region会保存一个表里面某段连续的数据</p>
</li>
<li><p>每个表一开始只有一个region，随着数据不断插入表，region不断增大，当增大到一个阀值的时候，region就会等分会两个新的region（裂变）</p>
</li>
<li>当table中的行不断增多，就会有越来越多的region。这样一张完整的表被保存在多个Regionserver 上。</li>
</ul>
<p><img src="/2019/06/08/HBase原理案例及搭建/02.png" alt="01"></p>
<ul>
<li><p>HRegion是HBase中分布式存储和负载均衡的最小单元。最小单元就表示不同的HRegion可以分布在不同的 HRegion server上。</p>
</li>
<li><p>HRegion由一个或者多个Store组成，每个store保存一个columns family。</p>
</li>
<li><p>每个Strore又由一个memStore和0至多个StoreFile组成。如图：StoreFile以HFile格式保存在HDFS上。</p>
</li>
</ul>
<h2 id="memstore-与-storefile"><a href="#memstore-与-storefile" class="headerlink" title="memstore 与 storefile"></a>memstore 与 storefile</h2><ul>
<li><p>一个region由多个store组成，一个store对应一个CF（列族）</p>
</li>
<li><p>store包括位于内存中的<strong>memstore</strong>和位于磁盘的<strong>storefile</strong>写操作<u>先写入memstore</u>，<u>当memstore中的数据达到某个阈值，hregionserver会启动flashcache进程写入storefile</u>，每次写入形成单独的一个storefile</p>
</li>
<li><p><u>当storefile文件的数量增长到一定阈值后，系统会进行合并</u>（minor、major compaction），在合并过程中会进行版本合并和删除工作（majar），形成更大的storefile</p>
</li>
<li><p>当一个region所有storefile的大小和数量超过一定阈值后，会把当前的region分割为两个，并由hmaster分配到相应的regionserver服务器，实现负载均衡</p>
</li>
<li><p>客户端检索数据，先在memstore找，找不到再找storefile</p>
</li>
</ul>
<p><img src="/2019/06/08/HBase原理案例及搭建/03.png" alt="01"></p>
<ul>
<li>SequeceFile的Value是HBase的KeyValue对象，即对应HFile中的KeyValue</li>
<li>StoreFile 等价于hdfs file</li>
</ul>
<h2 id="读顺序"><a href="#读顺序" class="headerlink" title="读顺序"></a>读顺序</h2><ul>
<li>1.读memstore，没有则下一步</li>
<li>2.读block cache，没有则下一步</li>
<li>3.读store file</li>
</ul>
<p>写顺序</p>
<ul>
<li>1.写memstore，达到阈值，下一步</li>
<li>2.写store file</li>
</ul>
<h1 id="HBase-完全HA分布式搭建"><a href="#HBase-完全HA分布式搭建" class="headerlink" title="HBase 完全HA分布式搭建"></a>HBase 完全HA分布式搭建</h1><table>
<thead>
<tr>
<th></th>
<th>zookeeper</th>
<th>master</th>
<th>region server</th>
<th>master backup</th>
</tr>
</thead>
<tbody>
<tr>
<td>node01</td>
<td></td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td>node02</td>
<td>*</td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td>node03</td>
<td>*</td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td>node04</td>
<td>*</td>
<td></td>
<td></td>
<td>*</td>
</tr>
</tbody>
</table>
<h3 id="hbase-env-sh-配置"><a href="#hbase-env-sh-配置" class="headerlink" title="hbase-env.sh 配置"></a>hbase-env.sh 配置</h3><p>conf中</p>
<ul>
<li>jdk地址</li>
<li>使用自己配置zk，不适用hbase自带内置的zk</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi hbase-env.sh</span><br><span class="line"></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">JAVA_HOME</span>=/usr/install/jdk/jdk1.8.0_171/</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">HBASE_MANAGES_ZK</span>=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h3 id="hbase-site-xml配置"><a href="#hbase-site-xml配置" class="headerlink" title="hbase-site.xml配置"></a>hbase-site.xml配置</h3><ul>
<li>hbase在hdfs的目录</li>
<li>是否分布式</li>
<li>zk地址</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vi hbase-site.xml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rootdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://mycluster/hbase<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.cluster.distributed<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>node02,node03,node04<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="regionservers配置"><a href="#regionservers配置" class="headerlink" title="regionservers配置"></a>regionservers配置</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">vi</span> regionservers</span><br><span class="line"></span><br><span class="line">node02 node03</span><br></pre></td></tr></table></figure>
<h3 id="backup-masters配置"><a href="#backup-masters配置" class="headerlink" title="backup-masters配置"></a>backup-masters配置</h3><p>添加 backup-masters</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">vi</span> <span class="keyword">backup-masters</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">node04</span></span><br></pre></td></tr></table></figure>
<h3 id="hdfs-site-xml复制"><a href="#hdfs-site-xml复制" class="headerlink" title="hdfs-site.xml复制"></a>hdfs-site.xml复制</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp <span class="regexp">/opt/</span>sxt<span class="regexp">/hadoop-2.6.5/</span>etc<span class="regexp">/hadoop/</span>hdfs-site.xml .<span class="regexp">/</span></span><br></pre></td></tr></table></figure>
<h3 id="环境变量配置"><a href="#环境变量配置" class="headerlink" title="环境变量配置"></a>环境变量配置</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">HBASE_HOME</span>=/root/hbase-0.98.12.1-hadoop2</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="variable">$PATH</span>:$ZOOKEEPER_HOME/bin:$HADOOP_HOME/bin:$HADOOP_HOME/sbin:$HBASE_HOME/bin</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<p>注意各节点的时间一致</p>
<h3 id="给其他节点scp一份"><a href="#给其他节点scp一份" class="headerlink" title="给其他节点scp一份"></a>给其他节点scp一份</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp -r hbase-<span class="number">0</span>.<span class="number">98.12</span>.<span class="number">1</span>-hadoop2 root<span class="variable">@node02</span><span class="symbol">:/root/</span></span><br><span class="line">scp -r hbase-<span class="number">0</span>.<span class="number">98.12</span>.<span class="number">1</span>-hadoop2 root<span class="variable">@node03</span><span class="symbol">:/root/</span></span><br><span class="line">scp -r hbase-<span class="number">0</span>.<span class="number">98.12</span>.<span class="number">1</span>-hadoop2 root<span class="variable">@node04</span><span class="symbol">:/root/</span></span><br></pre></td></tr></table></figure>
<h3 id="启动start-hbase-sh"><a href="#启动start-hbase-sh" class="headerlink" title="启动start-hbase.sh"></a>启动start-hbase.sh</h3><p>需要提前启动node02、03、04的zk，start-hdfs.sh服务</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">start</span>-hbase.sh</span><br></pre></td></tr></table></figure>
<h3 id="验证是否启动成功"><a href="#验证是否启动成功" class="headerlink" title="验证是否启动成功"></a>验证是否启动成功</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hbase <span class="keyword">shell</span><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="built_in">help</span></span></span><br><span class="line"><span class="bash">create <span class="string">'tbl'</span>,<span class="string">'cf'</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hbase(main)<span class="symbol">:023</span><span class="symbol">:0</span>&gt; scan 'tbl'</span><br><span class="line"><span class="built_in">ROW</span>                                <span class="built_in">COLUMN</span>+<span class="built_in">CELL</span></span><br><span class="line"> <span class="number">1111</span>                              <span class="built_in">column</span>=<span class="symbol">cf:ag</span>e, timestamp=<span class="number">1559984836555</span>, <span class="built_in">value</span>=<span class="number">12</span></span><br><span class="line"> <span class="number">1111</span>                              <span class="built_in">column</span>=<span class="symbol">cf:na</span>me, timestamp=<span class="number">1559984734803</span>, <span class="built_in">value</span>=zhangsan</span><br><span class="line"> <span class="number">2222</span>                              <span class="built_in">column</span>=<span class="symbol">cf:se</span>x, timestamp=<span class="number">1559984896283</span>, <span class="built_in">value</span>=boy</span><br><span class="line"><span class="number">2</span> <span class="built_in">row</span>(s) in <span class="number">0.0480</span> seconds</span><br></pre></td></tr></table></figure>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get 'tbl','<span class="number">1111</span>'</span><br></pre></td></tr></table></figure>
<ul>
<li>数据内容先写到memstore</li>
<li>执行<code>flush</code>，查看filestore</li>
</ul>
<blockquote>
<p><a href="http://node02:50070/explorer.html#/hbase/data/default/tbl/78a2935308b5f14d4c23a999ee797ed2/cf" target="_blank" rel="external">http://node02:50070/explorer.html#/hbase/data/default/tbl/78a2935308b5f14d4c23a999ee797ed2/cf</a></p>
</blockquote>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">flush</span> <span class="string">'tbl'</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="http://node02:50070/explorer.html#/hbase/data/default/tbl" target="_blank" rel="external">http://node02:50070/explorer.html#/hbase/data/default/tbl</a></p>
</blockquote>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">node01:</span><span class="number">60010</span></span><br></pre></td></tr></table></figure>
<h1 id="DDL操作"><a href="#DDL操作" class="headerlink" title="DDL操作"></a>DDL操作</h1><h2 id="进入client-shell"><a href="#进入client-shell" class="headerlink" title="进入client shell"></a>进入client shell</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hbase <span class="keyword">shell</span><span class="bash"></span></span><br></pre></td></tr></table></figure>
<h2 id="帮助"><a href="#帮助" class="headerlink" title="帮助"></a>帮助</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">help</span></span><br></pre></td></tr></table></figure>
<h2 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h2><p>列族数量2到3个</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">create</span> <span class="string">'tbl'</span>,<span class="string">'cf1'</span>,<span class="string">'cf2'</span></span><br></pre></td></tr></table></figure>
<h2 id="描述表"><a href="#描述表" class="headerlink" title="描述表"></a>描述表</h2><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">desc</span> <span class="string">'tbl'</span></span><br></pre></td></tr></table></figure>
<h3 id="列表list"><a href="#列表list" class="headerlink" title="列表list"></a>列表list</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">list</span></span><br></pre></td></tr></table></figure>
<h2 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">disable</span> <span class="string">'tbl'</span></span><br><span class="line">drop <span class="string">'tbl'</span></span><br></pre></td></tr></table></figure>
<h2 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h2><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">put 'tbl','<span class="number">1111</span>','cf:name','zhangsan'</span><br><span class="line">put 'tbl','<span class="number">1111</span>','cf:age','12'</span><br><span class="line">put 'tbl','<span class="number">2222</span>','cf:sex','boy'</span><br></pre></td></tr></table></figure>
<p>flush数据，memstore立即到store file，到hdfs中</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">flush</span> <span class="string">'tbl'</span></span><br></pre></td></tr></table></figure>
<h2 id="查看数据"><a href="#查看数据" class="headerlink" title="查看数据"></a>查看数据</h2><h3 id="查看全表"><a href="#查看全表" class="headerlink" title="查看全表"></a>查看全表</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">scan</span> <span class="string">'tbl'</span></span><br></pre></td></tr></table></figure>
<h3 id="查看单条"><a href="#查看单条" class="headerlink" title="查看单条"></a>查看单条</h3><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get 'tbl','<span class="number">1111</span>'</span><br></pre></td></tr></table></figure>
<h3 id="溢写数据"><a href="#溢写数据" class="headerlink" title="溢写数据"></a>溢写数据</h3><p><code>hbase shell</code>执行</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">flush</span> <span class="string">'eventlog'</span></span><br></pre></td></tr></table></figure>
<h3 id="查看hdfs的存储文件"><a href="#查看hdfs的存储文件" class="headerlink" title="查看hdfs的存储文件"></a>查看hdfs的存储文件</h3><p>hdfs查看目录 /hbase/data/default/eventlog/43169c43dc06d3e24836e3291149f8e5/log</p>
<p>直接服务器执行</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hbase hfile -p -f <span class="regexp">/hbase/</span>data<span class="regexp">/default/</span>eventlog<span class="regexp">/43169c43dc06d3e24836e3291149f8e5/</span>log<span class="regexp">/9bb18168d5e2437491a5adeaae62f864</span></span><br></pre></td></tr></table></figure>
<h1 id="hbase-java实战"><a href="#hbase-java实战" class="headerlink" title="hbase java实战"></a>hbase java实战</h1><h2 id="表创建"><a href="#表创建" class="headerlink" title="表创建"></a>表创建</h2><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> void createTable() &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		Configuration conf = <span class="keyword">new</span> <span class="type">Configuration</span>();</span><br><span class="line">		conf.<span class="keyword">set</span>(<span class="string">"hbase.zookeeper.quorum"</span>, <span class="string">"node02,node03,node04"</span>);</span><br><span class="line">		admin = <span class="keyword">new</span> <span class="type">HBaseAdmin</span>(conf);</span><br><span class="line"></span><br><span class="line">		HTableDescriptor desc = <span class="keyword">new</span> <span class="type">HTableDescriptor</span>(tableName);</span><br><span class="line">		HColumnDescriptor columnDescriptor = <span class="keyword">new</span> <span class="type">HColumnDescriptor</span>(<span class="string">"cf"</span>);</span><br><span class="line">		desc.addFamily(columnDescriptor);</span><br><span class="line">		admin.createTable(desc);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (admin != <span class="literal">null</span>) &#123;</span><br><span class="line">			admin.close();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> handle exception</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h2><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> insertTable() &#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">try</span> &#123;</span><br><span class="line">		Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">		conf.set(<span class="string">"hbase.zookeeper.quorum"</span>, <span class="string">"node02,node03,node04"</span>);</span><br><span class="line"></span><br><span class="line">		HTable hTable = <span class="keyword">new</span> HTable(conf, tableName);</span><br><span class="line"></span><br><span class="line">		Put <span class="built_in">put</span> = <span class="keyword">new</span> Put(<span class="string">"1111"</span>.getBytes());</span><br><span class="line">		<span class="built_in">put</span>.add(<span class="string">"cf"</span>.getBytes(), <span class="string">"name"</span>.getBytes(), <span class="string">"zhangsan"</span>.getBytes());</span><br><span class="line">		<span class="built_in">put</span>.add(<span class="string">"cf"</span>.getBytes(), <span class="string">"age"</span>.getBytes(), <span class="string">"12"</span>.getBytes());</span><br><span class="line">		<span class="built_in">put</span>.add(<span class="string">"cf"</span>.getBytes(), <span class="string">"sex"</span>.getBytes(), <span class="string">"boy"</span>.getBytes());</span><br><span class="line">		hTable.<span class="built_in">put</span>(<span class="built_in">put</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">if</span> (admin != null) &#123;</span><br><span class="line">			admin.<span class="built_in">close</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="built_in">catch</span> (Exception e) &#123;</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> handle exception</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> getTable() &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">			conf.<span class="built_in">set</span>(<span class="string">"hbase.zookeeper.quorum"</span>, <span class="string">"node02,node03,node04"</span>);</span><br><span class="line"></span><br><span class="line">			HTable hTable = <span class="keyword">new</span> HTable(conf, tableName);</span><br><span class="line"></span><br><span class="line">			Get <span class="built_in">get</span> = <span class="keyword">new</span> Get(<span class="string">"1111"</span>.getBytes());</span><br><span class="line">			<span class="comment">// define return columns in family</span></span><br><span class="line">			<span class="built_in">get</span>.addColumn(<span class="string">"cf"</span>.getBytes(), <span class="string">"name"</span>.getBytes());</span><br><span class="line">			<span class="built_in">get</span>.addColumn(<span class="string">"cf"</span>.getBytes(), <span class="string">"age"</span>.getBytes());</span><br><span class="line">			<span class="built_in">get</span>.addColumn(<span class="string">"cf"</span>.getBytes(), <span class="string">"sex"</span>.getBytes());</span><br><span class="line"></span><br><span class="line">			Result result = hTable.<span class="built_in">get</span>(<span class="built_in">get</span>);</span><br><span class="line">			Cell cell = result.getColumnLatestCell(<span class="string">"cf"</span>.getBytes(), <span class="string">"name"</span>.getBytes());</span><br><span class="line">			Cell cell2 = result.getColumnLatestCell(<span class="string">"cf"</span>.getBytes(), <span class="string">"age"</span>.getBytes());</span><br><span class="line">			Cell cell3 = result.getColumnLatestCell(<span class="string">"cf"</span>.getBytes(), <span class="string">"sex"</span>.getBytes());</span><br><span class="line"><span class="comment">//			System.out.println(new String( cell.getValue()));</span></span><br><span class="line">			System.out.<span class="built_in">println</span>(<span class="keyword">new</span> <span class="keyword">String</span>(CellUtil.cloneValue(cell)));</span><br><span class="line">			System.out.<span class="built_in">println</span>(<span class="keyword">new</span> <span class="keyword">String</span>(CellUtil.cloneValue(cell2)));</span><br><span class="line">			System.out.<span class="built_in">println</span>(<span class="keyword">new</span> <span class="keyword">String</span>(CellUtil.cloneValue(cell3)));</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (admin != <span class="keyword">null</span>) &#123;</span><br><span class="line">				admin.close();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="comment">// <span class="doctag">TODO:</span> handle exception</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Hbase出现ServerNotRunningYetException的解决方案"><a href="#Hbase出现ServerNotRunningYetException的解决方案" class="headerlink" title="Hbase出现ServerNotRunningYetException的解决方案"></a>Hbase出现ServerNotRunningYetException的解决方案</h1><p>因为hadoop处在安全模式下。所以hbase的操作会出现异常。</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">hadoop dfsadmin -safemode leave</span></span><br></pre></td></tr></table></figure>
<h1 id="hbase-shell中使用list命令报错"><a href="#hbase-shell中使用list命令报错" class="headerlink" title="hbase shell中使用list命令报错"></a>hbase shell中使用list命令报错</h1><blockquote>
<p><a href="https://blog.csdn.net/hll19950830/article/details/80022676" target="_blank" rel="external">https://blog.csdn.net/hll19950830/article/details/80022676</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/05/21/Hive原理案例及搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/21/Hive原理案例及搭建/" itemprop="url">Hive原理案例及搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-21T08:06:27+08:00">
                2019-05-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/05/21/Hive原理案例及搭建/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/05/21/Hive原理案例及搭建/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  11
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Hive搭建"><a href="#Hive搭建" class="headerlink" title="Hive搭建"></a>Hive搭建</h2><h3 id="in-memory-derby"><a href="#in-memory-derby" class="headerlink" title="in-memory derby"></a>in-memory derby</h3><p>内存数据库，实际不用</p>
<h3 id="远程服务器模式"><a href="#远程服务器模式" class="headerlink" title="远程服务器模式"></a>远程服务器模式</h3><ul>
<li>前面为hadoop部分</li>
<li>元数据 保存在MySQL</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>namenode 主备</th>
<th>ZKFC</th>
<th>datanode</th>
<th>zookeeper</th>
<th>JNN</th>
<th>mysql</th>
<th>hive Metastore Server</th>
<th>hive  client</th>
</tr>
</thead>
<tbody>
<tr>
<td>node01</td>
<td>*</td>
<td>*</td>
<td></td>
<td></td>
<td>*</td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td>node02</td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>*</td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td>node03</td>
<td></td>
<td></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td>node04</td>
<td></td>
<td></td>
<td>*</td>
<td>*</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Thrift MetaStore Server</p>
<h4 id="mysql安装"><a href="#mysql安装" class="headerlink" title="mysql安装"></a>mysql安装</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">解决无包可用，下载地址 http://repo.mysql.com/mysql-community-<span class="keyword">release</span>-el7<span class="number">-5.</span>noarch.rpm</span><br><span class="line">rpm -ivh mysql-community-<span class="keyword">release</span>-el7<span class="number">-5.</span>noarch.rpm</span><br><span class="line">yum <span class="keyword">install</span> -y mysql-<span class="keyword">server</span></span><br></pre></td></tr></table></figure>
<p>服务mysql启动</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysqld <span class="literal">start</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">databases</span></span><br><span class="line"><span class="keyword">use</span> mysql</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span></span><br><span class="line"><span class="keyword">desc</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure>
<p>修改授权用户密码</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> Host , User , Password from user;</span><br><span class="line">GRANT <span class="literal">ALL</span> PRIVILEGES <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'root'</span>@<span class="string">'%'</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">'123'</span> <span class="keyword">WITH</span> GRANT OPTION;</span><br><span class="line">delete from user <span class="keyword">where</span> Host != <span class="string">'%'</span>;</span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line">quit</span><br><span class="line">mysql <span class="params">-uroot</span> <span class="params">-p</span>;</span><br><span class="line"></span><br><span class="line">含义：<span class="literal">ALL</span> PRIVILEGES所有权限，*.*所有库所有表， %任何host  root用户名 <span class="number">123</span>密码</span><br></pre></td></tr></table></figure>
<h4 id="hive-Metastore-Server"><a href="#hive-Metastore-Server" class="headerlink" title="hive Metastore Server"></a>hive Metastore Server</h4><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">服务端需要连接mysql</span><br><span class="line">scp apache-hive-<span class="number">1.2</span>.<span class="number">1</span>-bin.tar.gz mysql-connector-java-<span class="number">5.1</span>.<span class="number">32</span>-bin.jar root@<span class="symbol">node02:</span>/root/</span><br><span class="line">tar zxvf apache-hive-<span class="number">1.2</span>.<span class="number">1</span>-bin.tar.gz</span><br><span class="line">cp mysql-connector-java-<span class="number">5.1</span>.<span class="number">32</span>-bin.jar apache-hive-<span class="number">1.2</span>.<span class="number">1</span>-bin/<span class="class"><span class="keyword">lib</span>/</span></span><br></pre></td></tr></table></figure>
<p>环境变量</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">HIVE_HOME</span>=/root/apache-hive-1.2.1-bin</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="variable">$PATH</span>:$ZOOKEEPER_HOME/bin:$HADOOP_HOME/bin:$HADOOP_HOME/sbin:$HIVE_HOME/bin</span><br><span class="line">source  /etc/profile</span><br></pre></td></tr></table></figure>
<p>配置文件</p>
<p>参考 <a href="https://cwiki.apache.org/confluence/display/Hive/AdminManual+Configuration" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/AdminManual+Configuration</a></p>
<p><a href="https://cwiki.apache.org/confluence/display/Hive/AdminManual+Metastore+Administration" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/AdminManual+Metastore+Administration</a></p>
<p><a href="https://cwiki.apache.org/confluence/display/Hive/AdminManual+Metastore+Administration#AdminManualMetastoreAdministration-RemoteMetastoreServer" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/AdminManual+Metastore+Administration#AdminManualMetastoreAdministration-RemoteMetastoreServer</a></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd conf/</span><br><span class="line">mv hive-default<span class="selector-class">.xml</span><span class="selector-class">.template</span> hive-site.xml</span><br><span class="line">vi hive-site.xml</span><br><span class="line">从当前行 &lt;configuration&gt;下面一行， 删除到倒数-<span class="number">1</span>行</span><br><span class="line">:.,$-<span class="number">1</span>d</span><br></pre></td></tr></table></figure>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">&lt;property&gt;</span>  </span><br><span class="line">  <span class="params">&lt;name&gt;</span>hive.metastore.warehouse.dir<span class="params">&lt;/name&gt;</span>  </span><br><span class="line">  <span class="params">&lt;value&gt;</span><span class="meta-keyword">/user/</span>hive/warehouse<span class="params">&lt;/value&gt;</span>  </span><br><span class="line"><span class="params">&lt;/property&gt;</span>  </span><br><span class="line">   </span><br><span class="line"><span class="params">&lt;property&gt;</span>  </span><br><span class="line">  <span class="params">&lt;name&gt;</span>javax.jdo.option.ConnectionURL<span class="params">&lt;/name&gt;</span>  </span><br><span class="line">  <span class="params">&lt;value&gt;</span>jdbc:mysql:<span class="comment">//node01:3306/hive?createDatabaseIfNotExist=true&lt;/value&gt;  </span></span><br><span class="line"><span class="params">&lt;/property&gt;</span>  </span><br><span class="line">   </span><br><span class="line"><span class="params">&lt;property&gt;</span>  </span><br><span class="line">  <span class="params">&lt;name&gt;</span>javax.jdo.option.ConnectionDriverName<span class="params">&lt;/name&gt;</span>  </span><br><span class="line">  <span class="params">&lt;value&gt;</span>com.mysql.jdbc.Driver<span class="params">&lt;/value&gt;</span>  </span><br><span class="line"><span class="params">&lt;/property&gt;</span>  </span><br><span class="line">   </span><br><span class="line"><span class="params">&lt;property&gt;</span>  </span><br><span class="line">  <span class="params">&lt;name&gt;</span>javax.jdo.option.ConnectionUserName<span class="params">&lt;/name&gt;</span>  </span><br><span class="line">  <span class="params">&lt;value&gt;</span>root<span class="params">&lt;/value&gt;</span>  </span><br><span class="line"><span class="params">&lt;/property&gt;</span>  </span><br><span class="line">   </span><br><span class="line"><span class="params">&lt;property&gt;</span>  </span><br><span class="line">  <span class="params">&lt;name&gt;</span>javax.jdo.option.ConnectionPassword<span class="params">&lt;/name&gt;</span>  </span><br><span class="line">  <span class="params">&lt;value&gt;</span><span class="number">123</span><span class="params">&lt;/value&gt;</span>  </span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="启动metastore-server"><a href="#启动metastore-server" class="headerlink" title="启动metastore server"></a>启动metastore server</h5><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive <span class="comment">--service metastore</span></span><br></pre></td></tr></table></figure>
<p>也可使用hiveserver2 beeline方式</p>
<h4 id="hive-client"><a href="#hive-client" class="headerlink" title="hive  client"></a>hive  client</h4><p>vi hive-site.xml</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">:</span>.,<span class="variable">$-</span><span class="number">1</span>d</span><br></pre></td></tr></table></figure>
<p>连接metastore</p>
<p>环境变量</p>
<p>./hive</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">&lt;property&gt;</span>  </span><br><span class="line">  <span class="params">&lt;name&gt;</span>hive.metastore.warehouse.dir<span class="params">&lt;/name&gt;</span>  </span><br><span class="line">  <span class="params">&lt;value&gt;</span><span class="meta-keyword">/user/</span>hive/warehouse<span class="params">&lt;/value&gt;</span>  </span><br><span class="line"><span class="params">&lt;/property&gt;</span>  </span><br><span class="line"> </span><br><span class="line"><span class="params">&lt;property&gt;</span>  </span><br><span class="line">  <span class="params">&lt;name&gt;</span>hive.metastore.local<span class="params">&lt;/name&gt;</span>  </span><br><span class="line">  <span class="params">&lt;value&gt;</span>false<span class="params">&lt;/value&gt;</span>  </span><br><span class="line"><span class="params">&lt;/property&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="params">&lt;property&gt;</span>  </span><br><span class="line">  <span class="params">&lt;name&gt;</span>hive.metastore.uris<span class="params">&lt;/name&gt;</span>  </span><br><span class="line">  <span class="params">&lt;value&gt;</span>thrift:<span class="comment">//node02:9083&lt;/value&gt;  </span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">property</span>&gt;  </span><br><span class="line">  &lt;<span class="built_in">name</span>&gt;hive.metastore.<span class="keyword">local</span>&lt;/<span class="built_in">name</span>&gt;  </span><br><span class="line">  &lt;value&gt;<span class="literal">false</span>&lt;/value&gt;  </span><br><span class="line">&lt;/<span class="keyword">property</span>&gt;  可以去掉,避免waring</span><br><span class="line">Metastore <span class="keyword">is</span> remote.  Note: This <span class="keyword">is</span> no longer needed <span class="keyword">as</span> <span class="keyword">of</span> Hive <span class="number">0.10</span>.  Setting hive.metastore.uri <span class="keyword">is</span> sufficient.</span><br></pre></td></tr></table></figure>
<p>避免jline报错</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/sxt/hadoop-<span class="number">2.6</span>.<span class="number">5</span>/share/hadoop/yarn/<span class="class"><span class="keyword">lib</span></span></span><br><span class="line">rm jline-<span class="number">0.9</span>.<span class="number">94</span>.jar</span><br><span class="line">cp /root/apache-hive-<span class="number">1.2</span>.<span class="number">1</span>-bin/<span class="class"><span class="keyword">lib</span>/<span class="title">jline</span>-2.12.<span class="title">jar</span> ./</span></span><br></pre></td></tr></table></figure>
<p>启动</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">hive</span></span><br></pre></td></tr></table></figure>
<h3 id="hive操作"><a href="#hive操作" class="headerlink" title="hive操作"></a>hive操作</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tbl(<span class="keyword">id</span> <span class="built_in">int</span>,age <span class="built_in">int</span>);</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tbl <span class="keyword">values</span>(<span class="number">1</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>Time taken: 175.393 seconds  查看map reduece 执行job状态 <a href="http://node03:8088/cluster" target="_blank" rel="external">http://node03:8088/cluster</a></p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tbl;</span><br></pre></td></tr></table></figure>
<p>查看hdfs存储  <a href="http://node01:50070/explorer.html#/user/hive/warehouse/tbl" target="_blank" rel="external">http://node01:50070/explorer.html#/user/hive/warehouse/tbl</a></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -cat <span class="regexp">/user/</span>hive<span class="regexp">/warehouse/</span>tbl<span class="regexp">/*</span></span><br></pre></td></tr></table></figure>
<h3 id="hive数据类型"><a href="#hive数据类型" class="headerlink" title="hive数据类型"></a>hive数据类型</h3><p>: primitive_type</p>
<p>  | array_type   数组</p>
<p>  | map_type     map类型</p>
<p>  | struct_type   结构体</p>
<p>：primitive_type</p>
<p>  |TINYINT</p>
<p>  | SMALLINT</p>
<p>  | INT</p>
<p>  | BIGINT</p>
<p>  | BOOLEAN</p>
<p>  | FLOAT</p>
<p>  | DOUBLE</p>
<p>  | STRING</p>
<p>参考 <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL</a></p>
<p><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-CreateTable" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-CreateTable</a></p>
<h4 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h4><h5 id="内部表"><a href="#内部表" class="headerlink" title="内部表"></a>内部表</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> psn(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="keyword">string</span>,</span><br><span class="line">likes <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;,</span><br><span class="line">address <span class="keyword">map</span>&lt;<span class="keyword">string</span>,<span class="keyword">string</span>&gt;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">DELIMITED</span></span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span></span><br><span class="line">COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'-'</span></span><br><span class="line"><span class="keyword">MAP</span> <span class="keyword">KEYS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">':'</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">人员表</span><br><span class="line">id,姓名,爱好，住址</span><br><span class="line"><span class="number">1</span>,小明<span class="number">1</span>,<span class="keyword">lol</span>-book-movie,zhejian<span class="variable">g:hangzhou</span>-guangdon<span class="variable">g:shenzhen</span></span><br><span class="line"><span class="number">2</span>,小明<span class="number">2</span>,<span class="keyword">lol</span>-book,zhejian<span class="variable">g:hangzhou</span>-guangdon<span class="variable">g:shenzhen</span></span><br></pre></td></tr></table></figure>
<h4 id="描述表"><a href="#描述表" class="headerlink" title="描述表"></a>描述表</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">desc</span> psn;</span><br><span class="line"><span class="keyword">desc</span> formatted psn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Table</span> <span class="keyword">Type</span>:         	MANAGED_TABLE  内部表</span><br></pre></td></tr></table></figure>
<h4 id="数据插入"><a href="#数据插入" class="headerlink" title="数据插入"></a>数据插入</h4><p>参考 <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DML#LanguageManualDML-Loadingfilesintotables" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DML#LanguageManualDML-Loadingfilesintotables</a></p>
<p>文件导入</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> <span class="keyword">LOCAL</span> INPATH <span class="string">'/root/persondata'</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> psn;</span><br></pre></td></tr></table></figure>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; <span class="keyword">select</span> * <span class="keyword">from</span> psn;</span><br><span class="line">OK</span><br><span class="line"><span class="number">1</span>	小明<span class="number">1</span>	[<span class="string">"lol"</span>,<span class="string">"book"</span>,<span class="string">"movie"</span>]	&#123;<span class="string">"zhejiang"</span>:<span class="string">"hangzhou"</span>,<span class="string">"guangdong"</span>:<span class="string">"shenzhen"</span>&#125;</span><br><span class="line"><span class="number">2</span>	小明<span class="number">2</span>	[<span class="string">"lol"</span>,<span class="string">"book"</span>]	&#123;<span class="string">"zhejiang"</span>:<span class="string">"hangzhou"</span>,<span class="string">"guangdong"</span>:<span class="string">"shenzhen"</span>&#125;</span><br></pre></td></tr></table></figure>
<h5 id="外部表"><a href="#外部表" class="headerlink" title="外部表"></a>外部表</h5><p>persondata为数据txt</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs <span class="built_in">mkdir</span> /external_table</span><br><span class="line">hdfs dfs -<span class="built_in">put</span> persondata /external_table/</span><br></pre></td></tr></table></figure>
<p>创建table</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">EXTERNAL</span> <span class="keyword">table</span>  psn_external(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="keyword">string</span>,</span><br><span class="line">likes <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;,</span><br><span class="line">address <span class="keyword">map</span>&lt;<span class="keyword">string</span>,<span class="keyword">string</span>&gt;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">DELIMITED</span></span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span></span><br><span class="line">COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'-'</span></span><br><span class="line"><span class="keyword">MAP</span> <span class="keyword">KEYS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">':'</span></span><br><span class="line">LOCATION <span class="string">'/external_table'</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> psn_external;</span><br><span class="line"><span class="keyword">desc</span> formatted psn_external;</span><br><span class="line">Table <span class="keyword">Type</span>:         	EXTERNAL_TABLE</span><br></pre></td></tr></table></figure>
<p>内部：删除元数据，及目录</p>
<p>外部：只删除元数据，存放目录不会删除</p>
<h4 id="其他创建表方式"><a href="#其他创建表方式" class="headerlink" title="其他创建表方式"></a>其他创建表方式</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">like</span> <span class="keyword">table</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> psn2 <span class="keyword">as</span> <span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span>,likes <span class="keyword">from</span> psn;</span><br></pre></td></tr></table></figure>
<h3 id="分区表"><a href="#分区表" class="headerlink" title="分区表"></a>分区表</h3><h4 id="单个字段分区"><a href="#单个字段分区" class="headerlink" title="单个字段分区"></a>单个字段分区</h4><p>按年龄分区</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id,年龄爱好，住址</span><br><span class="line"><span class="number">1</span>,小明<span class="number">1</span>,<span class="keyword">lol</span>-book-movie,zhejian<span class="variable">g:hangzhou</span>-guangdon<span class="variable">g:shenzhen</span></span><br><span class="line"><span class="number">2</span>,小明<span class="number">2</span>,lofl-book,zhejian<span class="variable">g:hangzhou</span>-guangdon<span class="variable">g:shenzhen</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> psn_partition(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="keyword">string</span>,</span><br><span class="line">likes <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;,</span><br><span class="line">address <span class="keyword">map</span>&lt;<span class="keyword">string</span>,<span class="keyword">string</span>&gt;</span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (age <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">DELIMITED</span></span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span></span><br><span class="line">COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'-'</span></span><br><span class="line"><span class="keyword">MAP</span> <span class="keyword">KEYS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">':'</span>;</span><br></pre></td></tr></table></figure>
<p>通过分区指定年龄</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> <span class="keyword">LOCAL</span> INPATH <span class="string">'/root/persondata'</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> psn_partition <span class="keyword">partition</span>(age=<span class="number">10</span>);</span><br><span class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> <span class="keyword">LOCAL</span> INPATH <span class="string">'/root/persondata'</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> psn_partition <span class="keyword">partition</span>(age=<span class="number">20</span>);</span><br></pre></td></tr></table></figure>
<h4 id="多个字段分区"><a href="#多个字段分区" class="headerlink" title="多个字段分区"></a>多个字段分区</h4><p>按年龄和性别分区</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> psn_partition_multi(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="keyword">string</span>,</span><br><span class="line">likes <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;,</span><br><span class="line">address <span class="keyword">map</span>&lt;<span class="keyword">string</span>,<span class="keyword">string</span>&gt;</span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (age <span class="built_in">int</span>,sex <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">DELIMITED</span></span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span></span><br><span class="line">COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'-'</span></span><br><span class="line"><span class="keyword">MAP</span> <span class="keyword">KEYS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">':'</span>;</span><br></pre></td></tr></table></figure>
<p>通过分区指定年龄、性别</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> <span class="keyword">LOCAL</span> INPATH <span class="string">'/root/persondata'</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> psn_partition_multi <span class="keyword">partition</span>(age=<span class="number">10</span>,sex=<span class="string">'boy'</span>);</span><br><span class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> <span class="keyword">LOCAL</span> INPATH <span class="string">'/root/persondata'</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> psn_partition_multi <span class="keyword">partition</span>(age=<span class="number">10</span>,sex=<span class="string">'girl'</span>);</span><br><span class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> <span class="keyword">LOCAL</span> INPATH <span class="string">'/root/persondata'</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> psn_partition_multi <span class="keyword">partition</span>(age=<span class="number">20</span>,sex=<span class="string">'girl'</span>);</span><br></pre></td></tr></table></figure>
<h5 id="删除分区"><a href="#删除分区" class="headerlink" title="删除分区"></a>删除分区</h5><p>参考文档 <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-DropPartitions" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-DropPartitions</a></p>
<p>10和20的girl二级分区都删掉</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> psn_partition_multi <span class="keyword">DROP</span> <span class="keyword">PARTITION</span> (sex=<span class="string">'girl'</span>);</span><br></pre></td></tr></table></figure>
<h5 id="添加分区"><a href="#添加分区" class="headerlink" title="添加分区"></a>添加分区</h5><p>必须指定第一级分区年龄</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> psn_partition_multi <span class="keyword">ADD</span> <span class="keyword">PARTITION</span> (age=<span class="number">10</span>,sex=<span class="string">'girl'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="DML"><a href="#DML" class="headerlink" title="DML"></a>DML</h3><h4 id="from-insert-select方式"><a href="#from-insert-select方式" class="headerlink" title="from insert select方式"></a>from insert select方式</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> psn_copy <span class="keyword">like</span> psn;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM psn</span><br><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> psn_copy</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">id</span>,<span class="keyword">name</span>,likes,address;</span><br></pre></td></tr></table></figure>
<h3 id="Hive-Beeline"><a href="#Hive-Beeline" class="headerlink" title="Hive Beeline"></a>Hive Beeline</h3><h4 id="hiveserver2"><a href="#hiveserver2" class="headerlink" title="hiveserver2"></a>hiveserver2</h4><p>node02</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hiveserver2</span><br></pre></td></tr></table></figure>
<h4 id="beeline"><a href="#beeline" class="headerlink" title="beeline"></a>beeline</h4><p>node03</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">beeline</span><br></pre></td></tr></table></figure>
<p>生产环境用 用户名、密码不校验</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">!connect <span class="string">jdbc:</span><span class="string">hive2:</span><span class="comment">//node02:10000/default; root 123</span></span><br><span class="line"></span><br><span class="line">show tables;</span><br></pre></td></tr></table></figure>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc<span class="function">:hive2</span>:<span class="string">//node02</span><span class="function">:10000</span>/default&gt; select * from psn;</span><br><span class="line">+<span class="params">---------</span>+<span class="params">-----------</span>+<span class="params">-------------------------</span>+<span class="params">-------------------------------------------------</span>+--+</span><br><span class="line">| psn.id  | psn.name  |        psn.likes        |                   psn.address                   |</span><br><span class="line">+<span class="params">---------</span>+<span class="params">-----------</span>+<span class="params">-------------------------</span>+<span class="params">-------------------------------------------------</span>+--+</span><br><span class="line">| 1       | 小明1       | [<span class="string">"lol"</span>,<span class="string">"book"</span>,<span class="string">"movie"</span>]  | &#123;<span class="string">"zhejiang"</span>:<span class="string">"hangzhou"</span>,<span class="string">"guangdong"</span>:<span class="string">"shenzhen"</span>&#125;  |</span><br><span class="line">| 2       | 小明2       | [<span class="string">"lol"</span>,<span class="string">"book"</span>]          | &#123;<span class="string">"zhejiang"</span>:<span class="string">"hangzhou"</span>,<span class="string">"guangdong"</span>:<span class="string">"shenzhen"</span>&#125;  |</span><br><span class="line">+<span class="params">---------</span>+<span class="params">-----------</span>+<span class="params">-------------------------</span>+<span class="params">-------------------------------------------------</span>+--+</span><br><span class="line">2 rows selected <span class="params">(3.391 seconds)</span></span><br></pre></td></tr></table></figure>
<p>退出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!quit</span><br></pre></td></tr></table></figure>
<h3 id="hive-jdbc-demo"><a href="#hive-jdbc-demo" class="headerlink" title="hive jdbc demo"></a>hive jdbc demo</h3><p>参考hivedemo</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> HiveJdbcClient &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> String driverName = <span class="string">"org.apache.hive.jdbc.HiveDriver"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(String[] args) <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">Class</span>.forName(driverName);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Connection conn = DriverManager.getConnection(<span class="string">"jdbc:hive2://node02:10000/default"</span>, <span class="string">"root"</span>, <span class="string">""</span>);</span><br><span class="line">		Statement stmt = conn.createStatement();</span><br><span class="line">		String sql = <span class="string">"select * from psn limit 5"</span>;</span><br><span class="line">		ResultSet res = stmt.executeQuery(sql);</span><br><span class="line">		<span class="keyword">while</span> (res.<span class="keyword">next</span>()) &#123;</span><br><span class="line">			System.out.<span class="keyword">println</span>(res.getString(<span class="number">1</span>) + <span class="string">"-"</span> + res.getString(<span class="string">"name"</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="hive-函数"><a href="#hive-函数" class="headerlink" title="hive 函数"></a>hive 函数</h3><h4 id="UDF-用户自定义函数"><a href="#UDF-用户自定义函数" class="headerlink" title="UDF 用户自定义函数"></a>UDF 用户自定义函数</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.laolian;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.exec.<span class="type">UDF</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.<span class="type">Text</span>;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">TuoMin</span> <span class="keyword">extends</span> <span class="title">UDF</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	public <span class="type">Text</span> evaluate(<span class="keyword">final</span> <span class="type">Text</span> s) &#123;</span><br><span class="line">		<span class="keyword">if</span> (s == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">String</span> str = s.toString().substring(<span class="number">0</span>, <span class="number">3</span>) + <span class="string">"***"</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="type">Text</span>(str);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>eclipse 导出jar 包export jar</p>
<p>node02</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive <span class="comment">--service metastore</span></span><br></pre></td></tr></table></figure>
<p>node03</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hive</span><br><span class="line"></span><br><span class="line">add jar /root/tuomin.jar;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">temporary</span> <span class="keyword">function</span> tm <span class="keyword">AS</span> <span class="string">'cn.laolian.TuoMin'</span>;</span><br><span class="line"><span class="keyword">select</span> tm(<span class="keyword">name</span>) <span class="keyword">from</span> psn;</span><br></pre></td></tr></table></figure>
<p>临时函数，当前会话有效</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; <span class="function"><span class="keyword">select</span> <span class="title">tm</span>(<span class="params">name</span>) <span class="keyword">from</span> psn</span>;</span><br><span class="line">OK</span><br><span class="line">小明<span class="number">1</span>***</span><br><span class="line">小明<span class="number">2</span>***</span><br></pre></td></tr></table></figure>
<h4 id="UDAF"><a href="#UDAF" class="headerlink" title="UDAF"></a>UDAF</h4><h4 id="UDTF-一进多出"><a href="#UDTF-一进多出" class="headerlink" title="UDTF 一进多出"></a>UDTF 一进多出</h4><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">select</span> <span class="title">explode</span>(<span class="params">likes</span>) <span class="keyword">from</span> psn</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">: jdbc:hive2://node02:10000/default&gt;</span> select explode(likes) from psn;</span><br><span class="line"><span class="code">+--------+</span>--+</span><br><span class="line">|  col   |</span><br><span class="line"><span class="code">+--------+</span>--+</span><br><span class="line">| lol    |</span><br><span class="line">| book   |</span><br><span class="line">| movie  |</span><br><span class="line">| lol    |</span><br><span class="line">| book   |</span><br><span class="line"><span class="code">+--------+</span>--+</span><br></pre></td></tr></table></figure>
<h3 id="hive参数"><a href="#hive参数" class="headerlink" title="hive参数"></a>hive参数</h3><p>打印头信息</p>
<h4 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hive</span><br><span class="line"><span class="builtin-name">set</span> hive.cli.print.<span class="attribute">header</span>=<span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>; 进行提示，导出配置</span><br></pre></td></tr></table></figure>
<h4 id="方式二-启动时设置"><a href="#方式二-启动时设置" class="headerlink" title="方式二 启动时设置"></a>方式二 启动时设置</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive --hiveconf hive.cli.print.<span class="attribute">header</span>=<span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>只在当前会话有效</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; select *  <span class="keyword">from</span> psn;</span><br><span class="line">OK</span><br><span class="line">psn.<span class="built_in">id</span>	psn.<span class="built_in">name</span>	psn.likes	psn.address</span><br><span class="line"><span class="number">1</span>	小明<span class="number">1</span>	[<span class="string">"lol"</span>,<span class="string">"book"</span>,<span class="string">"movie"</span>]	&#123;<span class="string">"zhejiang"</span>:<span class="string">"hangzhou"</span>,<span class="string">"guangdong"</span>:<span class="string">"shenzhen"</span>&#125;</span><br><span class="line"><span class="number">2</span>	小明<span class="number">2</span>	[<span class="string">"lol"</span>,<span class="string">"book"</span>]	&#123;<span class="string">"zhejiang"</span>:<span class="string">"hangzhou"</span>,<span class="string">"guangdong"</span>:<span class="string">"shenzhen"</span>&#125;</span><br></pre></td></tr></table></figure>
<h4 id="方式三-所有会话有效"><a href="#方式三-所有会话有效" class="headerlink" title="方式三 所有会话有效"></a>方式三 所有会话有效</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi .hiverc</span><br><span class="line"></span><br><span class="line">hive.cli.print.<span class="attribute">header</span>=<span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h4 id="历史命令"><a href="#历史命令" class="headerlink" title="历史命令"></a>历史命令</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">cat</span> <span class="selector-class">.hivehistory</span></span><br></pre></td></tr></table></figure>
<h3 id="Hive-动态分区"><a href="#Hive-动态分区" class="headerlink" title="Hive 动态分区"></a>Hive 动态分区</h3><p>严格模式：至少保证有一个静态分区</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">set</span> hive.exec.dynamic.<span class="attribute">partition</span>=<span class="literal">true</span>;</span><br><span class="line"><span class="builtin-name">set</span> hive.exec.dynamic.partition.<span class="attribute">mode</span>=nostrict;</span><br></pre></td></tr></table></figure>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi persondat<span class="built_in">a_daynamic</span>_partition</span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">id,姓名，年龄，性别，爱好，住址</span><br><span class="line"><span class="number">1</span>,小明<span class="number">1</span>,<span class="number">10</span>,boy,<span class="keyword">lol</span>-book-movie,zhejian<span class="variable">g:hangzhou</span>-guangdon<span class="variable">g:shenzhen</span></span><br><span class="line"><span class="number">2</span>,小明<span class="number">2</span>,<span class="number">10</span>,man,lofl-book,zhejian<span class="variable">g:hangzhou</span>-guangdon<span class="variable">g:shenzhen</span></span><br><span class="line"><span class="number">3</span>,小明<span class="number">3</span>,<span class="number">20</span>,boy,lofl-book,zhejian<span class="variable">g:hangzhou</span>-guangdon<span class="variable">g:shenzhen</span></span><br><span class="line"><span class="number">2</span>,小明<span class="number">3</span>,<span class="number">20</span>,man,lofl-book,zhejian<span class="variable">g:hangzhou</span>-guangdon<span class="variable">g:shenzhen</span></span><br></pre></td></tr></table></figure>
<h4 id="原始表"><a href="#原始表" class="headerlink" title="原始表"></a>原始表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> psn_dynamic_partition(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="keyword">string</span>,</span><br><span class="line">age <span class="built_in">int</span>,</span><br><span class="line">sex <span class="keyword">string</span>,</span><br><span class="line">likes <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;,</span><br><span class="line">address <span class="keyword">map</span>&lt;<span class="keyword">string</span>,<span class="keyword">string</span>&gt;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">DELIMITED</span></span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span></span><br><span class="line">COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'-'</span></span><br><span class="line"><span class="keyword">MAP</span> <span class="keyword">KEYS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">':'</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/root/persondata_daynamic_partition'</span> <span class="keyword">into</span> <span class="keyword">table</span> psn_dynamic_partition;</span><br></pre></td></tr></table></figure>
<h4 id="分区表-1"><a href="#分区表-1" class="headerlink" title="分区表"></a>分区表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> psn_dynamic_partition_r(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="keyword">string</span>,</span><br><span class="line">likes <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;,</span><br><span class="line">address <span class="keyword">map</span>&lt;<span class="keyword">string</span>,<span class="keyword">string</span>&gt;</span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (age <span class="built_in">int</span> , sex <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">DELIMITED</span></span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span></span><br><span class="line">COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'-'</span></span><br><span class="line"><span class="keyword">MAP</span> <span class="keyword">KEYS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">':'</span>;</span><br></pre></td></tr></table></figure>
<h4 id="从原始表导入到分区表"><a href="#从原始表导入到分区表" class="headerlink" title="从原始表导入到分区表"></a>从原始表导入到分区表</h4><p>注意age,sex的顺序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from psn_dynamic_partition</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> psn_dynamic_partition_r <span class="keyword">partition</span>(age,sex)</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span>,likes,address,age,sex <span class="keyword">distribute</span> <span class="keyword">by</span> age,sex;</span><br></pre></td></tr></table></figure>
<h3 id="Hive脚本运行方式"><a href="#Hive脚本运行方式" class="headerlink" title="Hive脚本运行方式"></a>Hive脚本运行方式</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hive -e <span class="string">"select * from psn"</span></span><br><span class="line">重定向</span><br><span class="line">hive -e <span class="string">"select * from psn"</span> &gt; aaa</span><br><span class="line">静默输出</span><br><span class="line">hive -S -e <span class="string">"select * from psn"</span> &gt; aaa</span><br></pre></td></tr></table></figure>
<h4 id="文件脚本"><a href="#文件脚本" class="headerlink" title="文件脚本"></a>文件脚本</h4><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi sql</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> psn</span><br></pre></td></tr></table></figure>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">hive -f sql</span></span><br></pre></td></tr></table></figure>
<h3 id="hive-client终端交互"><a href="#hive-client终端交互" class="headerlink" title="hive client终端交互"></a>hive client终端交互</h3><h4 id="hdfs交互"><a href="#hdfs交互" class="headerlink" title="hdfs交互"></a>hdfs交互</h4><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; dfs -ls / ;</span><br><span class="line">Found 5 items</span><br><span class="line">drwxr-xr-x   - root supergroup          0 2019<span class="string">-04</span><span class="string">-17</span> 22:08 /data</span><br><span class="line">drwxr-xr-x   - root supergroup          0 2019<span class="string">-06</span><span class="string">-02</span> 19:25 /external_table</span><br><span class="line">-rw-r--r--   2 root supergroup        118 2019<span class="string">-06</span><span class="string">-02</span> 19:10 /persondata</span><br><span class="line">drwx------   - root supergroup          0 2019<span class="string">-06</span><span class="string">-02</span> 11:55 /tmp</span><br><span class="line">drwxr-xr-x   - root supergroup          0 2019<span class="string">-06</span><span class="string">-02</span> 12:06 /user</span><br></pre></td></tr></table></figure>
<h4 id="linux交互"><a href="#linux交互" class="headerlink" title="linux交互"></a>linux交互</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">hive&gt;</span><span class="bash"> !<span class="built_in">pwd</span>;</span></span><br><span class="line">/root</span><br></pre></td></tr></table></figure>
<h3 id="Hive优化"><a href="#Hive优化" class="headerlink" title="Hive优化"></a>Hive优化</h3><h4 id="核心思想：hive-SQL-当做Map-Reduce程序去优化"><a href="#核心思想：hive-SQL-当做Map-Reduce程序去优化" class="headerlink" title="核心思想：hive SQL 当做Map Reduce程序去优化"></a>核心思想：hive SQL 当做Map Reduce程序去优化</h4><p>两种不会转化为Mapreduce执行</p>
<ul>
<li>select仅查询本表字段</li>
</ul>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> psn;</span><br></pre></td></tr></table></figure>
<ul>
<li>select仅对本表字段做条件过滤</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> psn <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h4 id="Explain执行计划"><a href="#Explain执行计划" class="headerlink" title="Explain执行计划"></a>Explain执行计划</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> psn;</span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">extended</span> <span class="keyword">select</span> * <span class="keyword">from</span> psn;</span><br></pre></td></tr></table></figure>
<h4 id="抓取策略"><a href="#抓取策略" class="headerlink" title="抓取策略"></a>抓取策略</h4><p>这样会执行mapreduce，默认值more</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.fetch.task.conversion=<span class="keyword">none</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> psn;</span><br></pre></td></tr></table></figure>
<h4 id="hive运行方式"><a href="#hive运行方式" class="headerlink" title="hive运行方式"></a>hive运行方式</h4><h5 id="本地模式"><a href="#本地模式" class="headerlink" title="本地模式"></a>本地模式</h5><p>本地模式，开发测试用，生产不要用</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> hive.<span class="built_in">exec</span>.mode.<span class="built_in">local</span>.auto=<span class="literal">true</span>;</span><br><span class="line"><span class="built_in">select</span> <span class="built_in">count</span>(*) <span class="keyword">from</span>  psn;</span><br></pre></td></tr></table></figure>
<ul>
<li>hive.exec.mode.local.inputbytes.max 默认值128M，大于该配置，也会以集群方法运行</li>
</ul>
<h4 id="并行计算"><a href="#并行计算" class="headerlink" title="并行计算"></a>并行计算</h4>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/05/15/Spring-framwork技术体系目录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/15/Spring-framwork技术体系目录/" itemprop="url">Spring framwork技术体系目录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-15T12:58:56+08:00">
                2019-05-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index">
                    <span itemprop="name">Spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/05/15/Spring-framwork技术体系目录/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/05/15/Spring-framwork技术体系目录/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  393
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><p>在Spring中常见的全局异常处理，主要有三种：</p>
<ul>
<li>注解 @ExceptionHandler</li>
</ul>
<blockquote>
<p>在 Controller 内部，用 <code>@ExceptionHandler</code>注解的方法，就会作为该Controller内部的异常处理方法。</p>
<p>该方式需要在每个类中处理异常，不适合全局异常处理。</p>
</blockquote>
<ul>
<li>继承HandlerExceptionResolver接口</li>
</ul>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomHandlerExceptionResolver</span> <span class="keyword">implements</span> <span class="title">HandlerExceptionResolver</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">ModelAndView <span class="title">resolveException</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object <span class="keyword">handler</span>, Exception ex)</span> </span>&#123;</span><br><span class="line">        Method method = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">handler</span> != <span class="keyword">null</span> &amp;&amp; <span class="keyword">handler</span> <span class="keyword">instanceof</span> HandlerMethod) &#123;</span><br><span class="line">            method = ((HandlerMethod) <span class="keyword">handler</span>).getMethod();</span><br><span class="line">        &#125;</span><br><span class="line">        log.<span class="keyword">error</span>(<span class="string">"[&#123;&#125;] system error"</span>, method, ex);</span><br><span class="line">        ResponseDTO response = ResponseDTO.builder()</span><br><span class="line">        .errorCode(ErrorCode.SYSTEM_ERROR)</span><br><span class="line">        .build();</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = JSON.toJSONString(response).getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileCopyUtils.copy(bytes, response.getOutputStream());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.<span class="keyword">error</span>(<span class="string">"error"</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>函数还可以返回一个 ModelAndView 对象，表示渲染一个视图，比方说错误页面。不过，在前后端分离为主流架构的今天，这个很少用了。如果函数返回的视图为空，则表示不需要视图。</p>
</blockquote>
<ul>
<li>注解 @ControllerAdvice</li>
</ul>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@ControllerAdvice</span>(assignableTypes = &#123;GlobalExceptionHandlerMixin.class&#125;)</span><br><span class="line">public class ExceptionAdvice &#123;</span><br><span class="line">    <span class="variable">@ExceptionHandler</span>(ErrorCodeWrapperException.class)</span><br><span class="line">    <span class="variable">@ResponseBody</span></span><br><span class="line">    public ResponseDTO&lt;?&gt; exceptionHandler(ErrorCodeWrapperException e) &#123;</span><br><span class="line">        <span class="selector-tag">if</span> ((errCodeException.getErrorCode().equals(ErrorCode.SYSTEM_ERROR))) &#123;</span><br><span class="line">            <span class="selector-tag">log</span><span class="selector-class">.error</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">ResponseDTO</span><span class="selector-class">.ofErroCodeWrapperException</span>(errCodeException);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ControllerAdvice 支持的限定范围</p>
<ol>
<li>按注解：<code>@ControllerAdvice(annotations = RestController.class)</code></li>
<li>按包名：<code>@ControllerAdvice(&quot;org.example.controllers&quot;)</code></li>
<li>按类型：<code>@ControllerAdvice(assignableTypes = {ControllerInterface.class, AbstractController.class})</code></li>
</ol>
</blockquote>
<h3 id="源码对应"><a href="#源码对应" class="headerlink" title="源码对应"></a>源码对应</h3><ul>
<li>ExceptionHandlerExceptionResolver<ul>
<li>@ExceptionHandler<ul>
<li>@ControllerAdvice</li>
</ul>
</li>
</ul>
</li>
<li>ResponseStatusExceptionResolver</li>
<li>DefaultHandlerExceptionResolver</li>
<li>MyHandlerExceptionResolver</li>
</ul>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><blockquote>
<p>常见的Spring异常分析及处理 <a href="https://my.oschina.net/u/4007037/blog/3049044" target="_blank" rel="external">https://my.oschina.net/u/4007037/blog/3049044</a></p>
<p>Spring中的统一异常处理  <a href="http://www.importnew.com/29962.html" target="_blank" rel="external">http://www.importnew.com/29962.html</a></p>
<p>Spring全局异常处理的三种方式  <a href="https://www.jianshu.com/p/f968b8dcf95a" target="_blank" rel="external">https://www.jianshu.com/p/f968b8dcf95a</a></p>
<p>Spring RestFul API统一异常处理 <a href="http://daobin.wang/2017/05/spring-restful-api/" target="_blank" rel="external">http://daobin.wang/2017/05/spring-restful-api/</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/04/16/单点登录实现——基于OAuth2-0协议的接入方案/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/16/单点登录实现——基于OAuth2-0协议的接入方案/" itemprop="url">单点登录实现——基于OAuth2.0协议的接入方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-16T11:49:04+08:00">
                2019-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/单点登录/" itemprop="url" rel="index">
                    <span itemprop="name">单点登录</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/04/16/单点登录实现——基于OAuth2-0协议的接入方案/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/04/16/单点登录实现——基于OAuth2-0协议的接入方案/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  61
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><p><a href="https://m635674608.iteye.com/blog/2313142" target="_blank" rel="external">单点登录实现——基于OAuth2.0协议的接入方案</a></p>
</li>
<li><p><a href="https://www.cnblogs.com/xifengxiaoma/p/10043173.html" target="_blank" rel="external">Spring Security Oauth2 单点登录案例实现和执行流程剖析</a></p>
</li>
<li><p><a href="https://www.cnblogs.com/ywlaker/p/6113927.html" target="_blank" rel="external">单点登录原理与简单实现</a></p>
</li>
<li><p><a href="https://blog.csdn.net/javaloveiphone/article/details/52439613" target="_blank" rel="external">CAS实现单点登录SSO执行原理探究</a></p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/xiaowu_avatar.jpg"
                alt="周小伍 Joey" />
            
              <p class="site-author-name" itemprop="name">周小伍 Joey</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">147</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">27</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">周小伍 Joey</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">265.9k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    
      <script id="dsq-count-scr" src="https://joeyblog.disqus.com/count.js" async></script>
    

    

  




	





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
