<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="xiaowu&#39;s blog">
<meta property="og:url" content="https://zhouxiaowu.coding.me/index.html">
<meta property="og:site_name" content="xiaowu&#39;s blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="xiaowu&#39;s blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhouxiaowu.coding.me/"/>





  <title>xiaowu's blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3da41265a1a0042eebe5413c0d6c76f5";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">xiaowu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-dubbo">
          <a href="/categories/Dubbo" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            Dubbo
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/08/23/Dubbo源码分析——NIO-服务器（二）之Transport层/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/23/Dubbo源码分析——NIO-服务器（二）之Transport层/" itemprop="url">Dubbo源码分析——NIO 服务器（二）之Transport层</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-23T22:38:30+08:00">
                2019-08-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Dubbo/" itemprop="url" rel="index">
                    <span itemprop="name">Dubbo</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Dubbo/remoting-api-interface/" itemprop="url" rel="index">
                    <span itemprop="name">remoting-api-interface</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/08/23/Dubbo源码分析——NIO-服务器（二）之Transport层/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/08/23/Dubbo源码分析——NIO-服务器（二）之Transport层/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  7.3k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  33
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>本文接 《精尽 Dubbo 源码分析 —— NIO 服务器（一）之抽象 API》一文，分享 <code>dubbo-remoting-api</code> 模块， <code>transport</code>包，<strong>网络传输层</strong>。</p>
<blockquote>
<p><strong>transport</strong> 网络传输层：抽象 mina 和 netty 为统一接口，以 Message 为中心，扩展接口为 Channel, Transporter, Client, Server, Codec</p>
</blockquote>
<p>涉及的类图如下：</p>
<p><img src="/images/Dubbo/2018_12_04/01.png" alt="类图"></p>
<ul>
<li><p>白色部分，为通用接口。</p>
</li>
<li><p>蓝色部分，为 <code>transport</code> 包下的类。</p>
</li>
<li><p>整个类图，我们分成</p>
<p>六个</p>
<p>部分：</p>
<ul>
<li>Client</li>
<li>Server</li>
<li>Channel</li>
<li>ChannelHandler</li>
<li>Codec</li>
<li>Dispacher</li>
</ul>
</li>
<li><p>从流程上来说，我们分成：</p>
<ul>
<li>Server<ul>
<li>启动</li>
<li>关闭</li>
</ul>
</li>
<li>Client<ul>
<li>启动</li>
<li>关闭</li>
</ul>
</li>
<li>ChannelHandler<ul>
<li>处理连接</li>
<li>处理断开</li>
<li>发送消息</li>
<li>接收消息</li>
<li>处理异常</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>艿艿的旁白：涉及较多类和流程，内容不是很线性，可能分享的比较凌乱，还望胖友谅解。建议，读 2-3 遍，并且做一些调试。</p>
</blockquote>
<h1 id="2-AbstractPeer"><a href="#2-AbstractPeer" class="headerlink" title="2. AbstractPeer"></a>2. AbstractPeer</h1><p><a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractPeer.java" target="_blank" rel="external"><code>com.alibaba.dubbo.remoting.transport.AbstractPeer</code></a> ，实现 Endpoint、ChannelHandler 接口，<strong>Peer</strong> 抽象类。</p>
<p><strong>构造方法</strong></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br><span class="line"><span class="comment"> 2:  * 通道处理器</span></span><br><span class="line"><span class="comment"> 3:  */</span></span><br><span class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> ChannelHandler handler;</span><br><span class="line"> <span class="number">5</span>: <span class="comment">/**</span></span><br><span class="line"><span class="comment"> 6:  * URL</span></span><br><span class="line"><span class="comment"> 7:  */</span></span><br><span class="line"> <span class="number">8</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> URL url;</span><br><span class="line"> <span class="number">9</span>: <span class="comment">/**</span></span><br><span class="line"><span class="comment">10:  * 正在关闭</span></span><br><span class="line"><span class="comment">11:  *</span></span><br><span class="line"><span class="comment">12:  * &#123;@link #startClose()&#125;</span></span><br><span class="line"><span class="comment">13:  */</span></span><br><span class="line"><span class="number">14</span>: <span class="comment">// closing closed means the process is being closed and close is finished</span></span><br><span class="line"><span class="number">15</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> closing;</span><br><span class="line"><span class="number">16</span>: <span class="comment">/**</span></span><br><span class="line"><span class="comment">17:  * 关闭完成</span></span><br><span class="line"><span class="comment">18:  *</span></span><br><span class="line"><span class="comment">19:  * &#123;@link #close()&#125;</span></span><br><span class="line"><span class="comment">20:  */</span></span><br><span class="line"><span class="number">21</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> closed;</span><br><span class="line"><span class="number">22</span>:</span><br><span class="line"><span class="number">23</span>: <span class="keyword">public</span> AbstractPeer(URL url, ChannelHandler handler) &#123;</span><br><span class="line"><span class="number">24</span>:     <span class="keyword">if</span> (url == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">25</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"url == null"</span>);</span><br><span class="line"><span class="number">26</span>:     &#125;</span><br><span class="line"><span class="number">27</span>:     <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">28</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"handler == null"</span>);</span><br><span class="line"><span class="number">29</span>:     &#125;</span><br><span class="line"><span class="number">30</span>:     <span class="keyword">this</span>.url = url;</span><br><span class="line"><span class="number">31</span>:     <span class="keyword">this</span>.handler = handler;</span><br><span class="line"><span class="number">32</span>: &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">handler</span></span><br></pre></td></tr></table></figure>
<p>属性，通道处理器，通过构造方法传入。实现的 ChannelHandler 的接口方法，直接调用</p>
</li>
</ul>
  <figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">handler</span></span><br></pre></td></tr></table></figure>
<p>  的方法，进行执行逻辑处理。</p>
<ul>
<li>参见代码：<a href="https://github.com/YunaiV/dubbo/blob/7fad710c2dbf66356d5e7b7995e843b8f6225652/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractPeer.java#L114-L141" target="_blank" rel="external">传送门</a></li>
<li>这种方式在设计模式中被称作 “<a href="https://www.cnblogs.com/java-my-life/archive/2012/04/20/2455726.html" target="_blank" rel="external">装饰模式</a>“ 。在下文中，我们会看到<strong>大量的</strong>装饰模式的使用。实际上，这也是 <code>dubbo-remoting</code> 抽象 API + 实现最核心的方式之一。</li>
</ul>
<ul>
<li><p><code>url</code> 属性，URL ，通过构造方法传入。通过该属性，传递 Dubbo 服务引用和服务暴露的<strong>配置项</strong>。</p>
</li>
<li><p><code>closing</code> 属性，正在关闭，调用 <code>#startClose()</code> 方法，变更。</p>
</li>
<li><p><code>close</code> 属性，关闭完成，调用 <code>#close()</code> 方法，变更。</p>
</li>
</ul>
<p><strong>发送消息</strong></p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(Object message)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    send(message, url.getParameter(Constants.SENT_KEY, <span class="keyword">false</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sent</span></span><br></pre></td></tr></table></figure>
<p>配置项：</p>
<ul>
<li><code>true</code> 等待消息发出，消息发送失败将抛出异常。</li>
<li><code>false</code> 不等待消息发出，将消息放入 IO 队列，即刻返回。</li>
<li>详细参见：<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/async-call.html" target="_blank" rel="external">《Dubbo 用户指南 —— 异步调用》</a></li>
</ul>
</li>
</ul>
<p><strong>其他方法</strong></p>
<p>胖友点击 <a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractPeer.java" target="_blank" rel="external">AbstractPeer</a> ，再看看<strong>所有</strong>的方法。</p>
<h2 id="2-1-AbstractEndpint"><a href="#2-1-AbstractEndpint" class="headerlink" title="2.1 AbstractEndpint"></a>2.1 AbstractEndpint</h2><p><a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractEndpoint.java" target="_blank" rel="external"><code>com.alibaba.dubbo.remoting.transport.AbstractPeer.AbstractEndpint</code></a> ，实现 Resetable 接口，继承 AbstractPeer 抽象类，<strong>端点</strong>抽象类。</p>
<p><strong>构造方法</strong></p>
<figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br><span class="line"><span class="comment"> 2:  * 编解码器</span></span><br><span class="line"><span class="comment"> 3:  */</span></span><br><span class="line"> <span class="number">4</span>: private Codec2 codec;</span><br><span class="line"> <span class="number">5</span>: <span class="comment">/**</span></span><br><span class="line"><span class="comment"> 6:  * 超时时间</span></span><br><span class="line"><span class="comment"> 7:  */</span></span><br><span class="line"> <span class="number">8</span>: private <span class="built_in">int</span> timeout;</span><br><span class="line"> <span class="number">9</span>: <span class="comment">/**</span></span><br><span class="line"><span class="comment">10:  * 连接超时时间</span></span><br><span class="line"><span class="comment">11:  */</span></span><br><span class="line"><span class="number">12</span>: private <span class="built_in">int</span> connectTimeout;</span><br><span class="line"><span class="number">13</span>:</span><br><span class="line"><span class="number">14</span>: public AbstractEndpoint(URL <span class="built_in">url</span>, ChannelHandler handler) &#123;</span><br><span class="line"><span class="number">15</span>:     <span class="keyword">super</span>(<span class="built_in">url</span>, handler);</span><br><span class="line"><span class="number">16</span>:     <span class="keyword">this</span>.codec = getChannelCodec(<span class="built_in">url</span>);</span><br><span class="line"><span class="number">17</span>:     <span class="keyword">this</span>.timeout = <span class="built_in">url</span>.getPositiveParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);</span><br><span class="line"><span class="number">18</span>:     <span class="keyword">this</span>.connectTimeout = <span class="built_in">url</span>.getPositiveParameter(Constants.CONNECT_TIMEOUT_KEY, Constants.DEFAULT_CONNECT_TIMEOUT);</span><br><span class="line"><span class="number">19</span>: &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>codec</code> 属性，编解码器。在构造方法中，可以看到调用 <code>#getChannelCodec(url)</code> 方法，基于 <code>url</code> 参数，加载对应的 Codec 实现对象。代码如下：</p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>: <span class="keyword">protected</span> <span class="keyword">static</span> Codec2 getChannelCodec(URL url) &#123;</span><br><span class="line"><span class="number">2</span>:     String codecName = url.getParameter(Constants.CODEC_KEY, <span class="string">"telnet"</span>);</span><br><span class="line"><span class="number">3</span>:     <span class="keyword">if</span> (ExtensionLoader.getExtensionLoader(Codec2.<span class="keyword">class</span>).hasExtension(codecName)) &#123; <span class="comment">// 例如，在 DubboProtocol 中，会获得 DubboCodec</span></span><br><span class="line"><span class="number">4</span>:         <span class="keyword">return</span> ExtensionLoader.getExtensionLoader(Codec2.<span class="keyword">class</span>).getExtension(codecName);</span><br><span class="line"><span class="number">5</span>:     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">6</span>:         <span class="keyword">return</span> <span class="keyword">new</span> CodecAdapter(ExtensionLoader.getExtensionLoader(Codec.<span class="keyword">class</span>).getExtension(codecName));</span><br><span class="line"><span class="number">7</span>:     &#125;</span><br><span class="line"><span class="number">8</span>: &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>第 3 行：基于 Dubbo SPI 机制，加载对应的 Codec 实现对象。例如，在 DubboProtocol 中，会获得 <a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-rpc/dubbo-rpc-dubbo/src/main/java/com/alibaba/dubbo/rpc/protocol/dubbo/DubboCodec.java" target="_blank" rel="external">DubboCodec</a> 对象。</li>
<li>第 6 行：Codec 接口，已经废弃了，目前 Dubbo 项目里，也没有它的拓展实现。</li>
</ul>
</li>
</ul>
<p><strong>重置属性</strong></p>
<p><a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractEndpoint.java#L60-L92" target="_blank" rel="external"><code>#reset(url)</code></a> <strong>实现</strong>方法，使用新的 <code>url</code> 属性，可重置 <code>codec</code> <code>timeout</code> <code>connectTimeout</code> 属性。</p>
<h1 id="3-Client"><a href="#3-Client" class="headerlink" title="3. Client"></a>3. Client</h1><h2 id="3-1-AbstractClient"><a href="#3-1-AbstractClient" class="headerlink" title="3.1 AbstractClient"></a>3.1 AbstractClient</h2><p><a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractClient.java" target="_blank" rel="external"><code>com.alibaba.dubbo.remoting.transport.AbstractClient</code></a> ，实现 Client 接口，继承 AbstractEndpoint 抽象类，<strong>客户端</strong>抽象类，<strong>重点</strong>实现了公用的重连逻辑，同时抽象了连接等模板方法，供子类实现。抽象方法如下：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">void</span> <span class="title">doOpen</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">void</span> <span class="title">doClose</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">void</span> <span class="title">doConnect</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">void</span> <span class="title">doDisConnect</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="function">Channel <span class="title">getChannel</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p><strong>构造方法</strong></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br><span class="line"><span class="comment"> 2:  * 重连定时任务执行器</span></span><br><span class="line"><span class="comment"> 3:  */</span></span><br><span class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ScheduledThreadPoolExecutor reconnectExecutorService = <span class="keyword">new</span> ScheduledThreadPoolExecutor(<span class="number">2</span>, <span class="keyword">new</span> NamedThreadFactory(<span class="string">"DubboClientReconnectTimer"</span>, <span class="keyword">true</span>));</span><br><span class="line"> <span class="number">5</span>: <span class="comment">/**</span></span><br><span class="line"><span class="comment"> 6:  * 发送消息时，若断开，是否重连</span></span><br><span class="line"><span class="comment"> 7:  */</span></span><br><span class="line"> <span class="number">8</span>: <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> send_reconnect;</span><br><span class="line"> <span class="number">9</span>: <span class="comment">/**</span></span><br><span class="line"><span class="comment">10:  * 重连 warning 的间隔.(waring多少次之后，warning一次) //for test</span></span><br><span class="line"><span class="comment">11:  */</span></span><br><span class="line"><span class="number">12</span>: <span class="comment">// reconnect warning period. Reconnect warning interval (log warning after how many times) //for test</span></span><br><span class="line"><span class="number">13</span>: <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> reconnect_warning_period;</span><br><span class="line"><span class="number">14</span>: <span class="comment">/**</span></span><br><span class="line"><span class="comment">15:  * 关闭超时时间</span></span><br><span class="line"><span class="comment">16:  */</span></span><br><span class="line"><span class="number">17</span>: <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> shutdown_timeout;</span><br><span class="line"><span class="number">18</span>: <span class="comment">/**</span></span><br><span class="line"><span class="comment">19:  * 线程池</span></span><br><span class="line"><span class="comment">20:  *</span></span><br><span class="line"><span class="comment">21:  * 在调用 &#123;@link #wrapChannelHandler(URL, ChannelHandler)&#125; 时，会调用 &#123;@link com.alibaba.dubbo.remoting.transport.dispatcher.WrappedChannelHandler&#125; 创建</span></span><br><span class="line"><span class="comment">22:  */</span></span><br><span class="line"><span class="number">23</span>: <span class="keyword">protected</span> <span class="keyword">volatile</span> ExecutorService executor;</span><br><span class="line"><span class="number">24</span>:</span><br><span class="line"><span class="number">25</span>: <span class="keyword">public</span> AbstractClient(URL url, ChannelHandler handler) <span class="keyword">throws</span> RemotingException &#123;</span><br><span class="line"><span class="number">26</span>:     <span class="keyword">super</span>(url, handler);</span><br><span class="line"><span class="number">27</span>:     <span class="comment">// 从 URL 中，获得重连相关配置项</span></span><br><span class="line"><span class="number">28</span>:     send_reconnect = url.getParameter(Constants.SEND_RECONNECT_KEY, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">29</span>:     shutdown_timeout = url.getParameter(Constants.SHUTDOWN_TIMEOUT_KEY, Constants.DEFAULT_SHUTDOWN_TIMEOUT);</span><br><span class="line"><span class="number">30</span>:     <span class="comment">// The default reconnection interval is 2s, 1800 means warning interval is 1 hour.</span></span><br><span class="line"><span class="number">31</span>:     reconnect_warning_period = url.getParameter(<span class="string">"reconnect.waring.period"</span>, <span class="number">1800</span>);</span><br><span class="line"><span class="number">32</span>:</span><br><span class="line"><span class="number">33</span>:     <span class="comment">// 初始化客户端</span></span><br><span class="line"><span class="number">34</span>:     <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">35</span>:         doOpen();</span><br><span class="line"><span class="number">36</span>:     &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line"><span class="number">37</span>:         close(); <span class="comment">// 失败，则关闭</span></span><br><span class="line"><span class="number">38</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RemotingException(url.toInetSocketAddress(), <span class="keyword">null</span>,</span><br><span class="line"><span class="number">39</span>:                 <span class="string">"Failed to start "</span> + getClass().getSimpleName() + <span class="string">" "</span> + NetUtils.getLocalAddress()</span><br><span class="line"><span class="number">40</span>:                         + <span class="string">" connect to the server "</span> + getRemoteAddress() + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br><span class="line"><span class="number">41</span>:     &#125;</span><br><span class="line"><span class="number">42</span>:</span><br><span class="line"><span class="number">43</span>:     <span class="comment">// 连接服务器</span></span><br><span class="line"><span class="number">44</span>:     <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">45</span>:         <span class="comment">// connect.</span></span><br><span class="line"><span class="number">46</span>:         connect();</span><br><span class="line"><span class="number">47</span>:         <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line"><span class="number">48</span>:             logger.info(<span class="string">"Start "</span> + getClass().getSimpleName() + <span class="string">" "</span> + NetUtils.getLocalAddress() + <span class="string">" connect to the server "</span> + getRemoteAddress());</span><br><span class="line"><span class="number">49</span>:         &#125;</span><br><span class="line"><span class="number">50</span>:     &#125; <span class="keyword">catch</span> (RemotingException t) &#123;</span><br><span class="line"><span class="number">51</span>:         <span class="keyword">if</span> (url.getParameter(Constants.CHECK_KEY, <span class="keyword">true</span>)) &#123;</span><br><span class="line"><span class="number">52</span>:             close(); <span class="comment">// 失败，则关闭</span></span><br><span class="line"><span class="number">53</span>:             <span class="keyword">throw</span> t;</span><br><span class="line"><span class="number">54</span>:         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">55</span>:             logger.warn(<span class="string">"Failed to start "</span> + getClass().getSimpleName() + <span class="string">" "</span> + NetUtils.getLocalAddress()</span><br><span class="line"><span class="number">56</span>:                     + <span class="string">" connect to the server "</span> + getRemoteAddress() + <span class="string">" (check == false, ignore and retry later!), cause: "</span> + t.getMessage(), t);</span><br><span class="line"><span class="number">57</span>:         &#125;</span><br><span class="line"><span class="number">58</span>:     &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line"><span class="number">59</span>:         close(); <span class="comment">// 失败，则关闭</span></span><br><span class="line"><span class="number">60</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RemotingException(url.toInetSocketAddress(), <span class="keyword">null</span>,</span><br><span class="line"><span class="number">61</span>:                 <span class="string">"Failed to start "</span> + getClass().getSimpleName() + <span class="string">" "</span> + NetUtils.getLocalAddress()</span><br><span class="line"><span class="number">62</span>:                         + <span class="string">" connect to the server "</span> + getRemoteAddress() + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br><span class="line"><span class="number">63</span>:     &#125;</span><br><span class="line"><span class="number">64</span>:</span><br><span class="line"><span class="number">65</span>:     <span class="comment">// 获得线程池</span></span><br><span class="line"><span class="number">66</span>:     executor = (ExecutorService) ExtensionLoader.getExtensionLoader(DataStore.<span class="keyword">class</span>).getDefaultExtension()</span><br><span class="line"><span class="number">67</span>:             .get(Constants.CONSUMER_SIDE, Integer.toString(url.getPort()));</span><br><span class="line"><span class="number">68</span>:     ExtensionLoader.getExtensionLoader(DataStore.<span class="keyword">class</span>).getDefaultExtension()</span><br><span class="line"><span class="number">69</span>:             .remove(Constants.CONSUMER_SIDE, Integer.toString(url.getPort()));</span><br><span class="line"><span class="number">70</span>: &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>reconnectExecutorService</code> 属性，重连定时任务执行器。在客户端连接服务端时，会创建后台任务，定时检查连接，若断开，会进行重连。</p>
</li>
<li><p>第 27 至 31 行：从 URL 中，获得重连相关<strong>配置项</strong>。</p>
</li>
<li><p>第 33 至 41 行：调用 <code>#doOpen()</code> <strong>抽象</strong>方法，初始化客户端。若异常，调用 <code>#close()</code> 方法，进行关闭。</p>
</li>
<li><p>第 43 至 63 行：调用</p>
</li>
</ul>
  <figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">#</span><span class="title">connect</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p>  实现</p>
<p>  方法，连接服务器。若异常，调用</p>
  <figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">#</span><span class="title">close</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p>  方法，进行关闭。</p>
<ul>
<li>第 51 至 57 行：若是连接失败 RemotingException ，若开启了 <a href="http://dubbo.apache.org/zh-cn/docs/user/demos/preflight-check.html" target="_blank" rel="external">启动时检查</a> ，则调用 <code>#close()</code> 方法，进行关闭。</li>
</ul>
<ul>
<li><p>第 66 至 69 行：从DataStore中，获得线程池。</p>
<ul>
<li>DataStore 在 <code>dubbo-common</code> 模块，<a href="https://github.com/YunaiV/dubbo/tree/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-common/src/main/java/com/alibaba/dubbo/common/store" target="_blank" rel="external"><code>store</code></a> 包下实现。目前的实现比较简单，可以认为是 <code>ConcurrentMap&lt;String, ConcurrentMap&lt;String, Object&gt;&gt;</code> 的集合。胖友可以自己看相关实现。</li>
<li>此处的线程池，实际就是 <a href="http://dubbo.apache.org/zh-cn/docs/user/demos/thread-model.html" target="_blank" rel="external">《Dubbo 用户指南 —— 线程模型》</a> 中说的<strong>线程池</strong>。在 <a href="http://svip.iocoder.cn/Dubbo/remoting-api-transport/#" target="_blank" rel="external">「8. Dispacher」</a> 中，详细解析。</li>
</ul>
</li>
</ul>
<p><strong>连接服务器</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 连接锁，用于实现发起连接和断开连接互斥，避免并发。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> final Lock connectLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">connect</span>(<span class="params"></span>) throws RemotingException </span>&#123;</span><br><span class="line">  <span class="number">2</span>:     <span class="comment">// 获得锁</span></span><br><span class="line">  <span class="number">3</span>:     connectLock.<span class="keyword">lock</span>();</span><br><span class="line">  <span class="number">4</span>:     <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="number">5</span>:         <span class="comment">// 已连接，</span></span><br><span class="line">  <span class="number">6</span>:         <span class="keyword">if</span> (isConnected()) &#123;</span><br><span class="line">  <span class="number">7</span>:             <span class="keyword">return</span>;</span><br><span class="line">  <span class="number">8</span>:         &#125;</span><br><span class="line">  <span class="number">9</span>:         <span class="comment">// 初始化重连线程</span></span><br><span class="line"> <span class="number">10</span>:         initConnectStatusCheckCommand();</span><br><span class="line"> <span class="number">11</span>:         <span class="comment">// 执行连接</span></span><br><span class="line"> <span class="number">12</span>:         doConnect();</span><br><span class="line"> <span class="number">13</span>:         <span class="comment">// 连接失败，抛出异常</span></span><br><span class="line"> <span class="number">14</span>:         <span class="keyword">if</span> (!isConnected()) &#123;</span><br><span class="line"> <span class="number">15</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RemotingException(<span class="keyword">this</span>, <span class="string">"Failed connect to server "</span> + getRemoteAddress() + <span class="string">" from "</span> + getClass().getSimpleName() + <span class="string">" "</span></span><br><span class="line"> <span class="number">16</span>:                     + NetUtils.getLocalHost() + <span class="string">" using dubbo version "</span> + Version.getVersion()</span><br><span class="line"> <span class="number">17</span>:                     + <span class="string">", cause: Connect wait timeout: "</span> + getTimeout() + <span class="string">"ms."</span>);</span><br><span class="line"> <span class="number">18</span>:         <span class="comment">// 连接成功，打印日志</span></span><br><span class="line"> <span class="number">19</span>:         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="number">20</span>:             <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line"> <span class="number">21</span>:                 logger.info(<span class="string">"Successed connect to server "</span> + getRemoteAddress() + <span class="string">" from "</span> + getClass().getSimpleName() + <span class="string">" "</span></span><br><span class="line"> <span class="number">22</span>:                         + NetUtils.getLocalHost() + <span class="string">" using dubbo version "</span> + Version.getVersion()</span><br><span class="line"> <span class="number">23</span>:                         + <span class="string">", channel is "</span> + <span class="keyword">this</span>.getChannel());</span><br><span class="line"> <span class="number">24</span>:             &#125;</span><br><span class="line"> <span class="number">25</span>:         &#125;</span><br><span class="line"> <span class="number">26</span>:         <span class="comment">// 设置重连次数归零</span></span><br><span class="line"> <span class="number">27</span>:         reconnect_count.<span class="keyword">set</span>(<span class="number">0</span>);</span><br><span class="line"> <span class="number">28</span>:         <span class="comment">// 设置未打印过错误日志</span></span><br><span class="line"> <span class="number">29</span>:         reconnect_error_log_flag.<span class="keyword">set</span>(<span class="literal">false</span>);</span><br><span class="line"> <span class="number">30</span>:     &#125; <span class="keyword">catch</span> (RemotingException e) &#123;</span><br><span class="line"> <span class="number">31</span>:         <span class="keyword">throw</span> e;</span><br><span class="line"> <span class="number">32</span>:     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line"> <span class="number">33</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RemotingException(<span class="keyword">this</span>, <span class="string">"Failed connect to server "</span> + getRemoteAddress() + <span class="string">" from "</span> + getClass().getSimpleName() + <span class="string">" "</span></span><br><span class="line"> <span class="number">34</span>:                 + NetUtils.getLocalHost() + <span class="string">" using dubbo version "</span> + Version.getVersion()</span><br><span class="line"> <span class="number">35</span>:                 + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br><span class="line"> <span class="number">36</span>:     &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"> <span class="number">37</span>:         <span class="comment">// 释放锁</span></span><br><span class="line"> <span class="number">38</span>:         connectLock.unlock();</span><br><span class="line"> <span class="number">39</span>:     &#125;</span><br><span class="line"> <span class="number">40</span>: &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>第 3 行：获得锁。在连接和断开连接时，通过锁，避免并发冲突。</p>
</li>
<li><p>第 5 至 8 行：调用 <code>#isConnected()</code> 方法，判断连接状态。若已经连接，就不重复连接。代码如下：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">isConnected</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Channel channel = getChannel();</span><br><span class="line">    <span class="keyword">return</span> channel != <span class="keyword">null</span> &amp;&amp; channel.isConnected();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>该方法，是因为实现 Channel 接口( Client 实现 Channel 接口 )，所以需要实现的。我们可以看到，实际方法内部，调用的是 <code>channel</code>对象，进行判断。其它实现 Channel 的方法，也是这么处理的，例如 <a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractClient.java#L194-L245" target="_blank" rel="external"><code>#getAttribute(key)</code></a> 等方法。</li>
</ul>
</li>
<li><p>第 10 行：调用 <code>#initConnectStatusCheckCommand()</code> 方法，初始化重连<strong>线程</strong>。</p>
<ul>
<li>方法会复杂一些，不杂糅在这里讲。</li>
</ul>
</li>
<li><p>第 14 至 17 行：连接失败，抛出异常 RemotingException 。</p>
</li>
<li><p>第 18 至 25 行：连接成功，打印日志。</p>
</li>
<li><p>第 26 至 29 行：设置重连次数归零，打印过错误日志状态为否。下面，我们会看到这些状态字段的变更。</p>
</li>
<li><p>第 38 行：释放锁。</p>
</li>
</ul>
<p><strong>初始化重连线程</strong></p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 重连次数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger reconnect_count = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 重连时，是否已经打印过错误日志。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// Reconnection error log has been called before?</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean reconnect_error_log_flag = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 重连执行任务 Future</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> ScheduledFuture&lt;?&gt; reconnectExecutorFuture = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 最后成功连接时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// the last successed connected time</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> lastConnectedTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">  <span class="number">1</span>: <span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> initConnectStatusCheckCommand() &#123;</span><br><span class="line">  <span class="number">2</span>:     <span class="comment">//reconnect=false to close reconnect</span></span><br><span class="line">  <span class="number">3</span>:     <span class="comment">// 获得获得重连频率，默认开启。</span></span><br><span class="line">  <span class="number">4</span>:     <span class="built_in">int</span> reconnect = getReconnectParam(getUrl());</span><br><span class="line">  <span class="number">5</span>:     <span class="comment">// 若开启重连功能，创建重连线程</span></span><br><span class="line">  <span class="number">6</span>:     <span class="keyword">if</span> (reconnect &gt; <span class="number">0</span> &amp;&amp; (reconnectExecutorFuture == <span class="keyword">null</span> || reconnectExecutorFuture.isCancelled())) &#123;</span><br><span class="line">  <span class="number">7</span>:         <span class="comment">// 创建 Runnable 对象</span></span><br><span class="line">  <span class="number">8</span>:         Runnable connectStatusCheckCommand = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">  <span class="number">9</span>:             <span class="keyword">public</span> <span class="keyword">void</span> run() &#123;</span><br><span class="line"> <span class="number">10</span>:                 <span class="keyword">try</span> &#123;</span><br><span class="line"> <span class="number">11</span>:                     <span class="comment">// 未连接，重连</span></span><br><span class="line"> <span class="number">12</span>:                     <span class="keyword">if</span> (!isConnected()) &#123;</span><br><span class="line"> <span class="number">13</span>:                         connect();</span><br><span class="line"> <span class="number">14</span>:                     <span class="comment">// 已连接，记录最后连接时间</span></span><br><span class="line"> <span class="number">15</span>:                     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="number">16</span>:                         lastConnectedTime = System.currentTimeMillis();</span><br><span class="line"> <span class="number">17</span>:                     &#125;</span><br><span class="line"> <span class="number">18</span>:                 &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line"> <span class="number">19</span>:                     <span class="comment">// 超过一定时间未连接上，才打印异常日志。并且，仅打印一次。默认，15 分钟。</span></span><br><span class="line"> <span class="number">20</span>:                     <span class="keyword">String</span> errorMsg = <span class="string">"client reconnect to "</span> + getUrl().getAddress() + <span class="string">" find error . url: "</span> + getUrl();</span><br><span class="line"> <span class="number">21</span>:                     <span class="comment">// wait registry sync provider list</span></span><br><span class="line"> <span class="number">22</span>:                     <span class="keyword">if</span> (System.currentTimeMillis() - lastConnectedTime &gt; shutdown_timeout) &#123;</span><br><span class="line"> <span class="number">23</span>:                         <span class="keyword">if</span> (!reconnect_error_log_flag.<span class="built_in">get</span>()) &#123;</span><br><span class="line"> <span class="number">24</span>:                             reconnect_error_log_flag.<span class="built_in">set</span>(<span class="keyword">true</span>);</span><br><span class="line"> <span class="number">25</span>:                             logger.error(errorMsg, t);</span><br><span class="line"> <span class="number">26</span>:                             <span class="keyword">return</span>;</span><br><span class="line"> <span class="number">27</span>:                         &#125;</span><br><span class="line"> <span class="number">28</span>:                     &#125;</span><br><span class="line"> <span class="number">29</span>:                     <span class="comment">// 每一定次发现未重连，才打印告警日志。默认，1800 次，1 小时。</span></span><br><span class="line"> <span class="number">30</span>:                     <span class="keyword">if</span> (reconnect_count.getAndIncrement() % reconnect_warning_period == <span class="number">0</span>) &#123;</span><br><span class="line"> <span class="number">31</span>:                         logger.warn(errorMsg, t);</span><br><span class="line"> <span class="number">32</span>:                     &#125;</span><br><span class="line"> <span class="number">33</span>:                 &#125;</span><br><span class="line"> <span class="number">34</span>:             &#125;</span><br><span class="line"> <span class="number">35</span>:         &#125;;</span><br><span class="line"> <span class="number">36</span>:         <span class="comment">// 发起定时任务</span></span><br><span class="line"> <span class="number">37</span>:         reconnectExecutorFuture = reconnectExecutorService.scheduleWithFixedDelay(connectStatusCheckCommand, reconnect, reconnect, TimeUnit.MILLISECONDS);</span><br><span class="line"> <span class="number">38</span>:     &#125;</span><br><span class="line"> <span class="number">39</span>: &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>第 4 行：调用</li>
</ul>
<p>  <code>#getReconnectParam(url)</code></p>
<p>  方法，获得重连频率。默认开启，2000 毫秒。</p>
<ul>
<li>代码比较简单，胖友自己点击方法查看。</li>
</ul>
<ul>
<li><p>第 6 至 38 行：若</p>
<p>开启</p>
<p>重连功能， 创建重连线程。</p>
<ul>
<li>第 8 至 35 行：创建 Runnable 对象。<ul>
<li>第 11 至 13 行：未连接时，调用 <code>#connect()</code> 方法，进行重连。</li>
<li>第 14 至 17 行：已连接时，记录最后连接时间。</li>
<li>第 18 至 33 行：<strong>符合</strong>条件时，打印<strong>错误</strong>或<strong>告警</strong>日志。为什么要符合条件才打印呢？之前也和朋友聊起来过，线上因为中间件组件，打印了太多的日志，结果整个 JVM 崩了。特别在网络场景 + 大量“无限”重试的场景，特别容易打出满屏的日志。这块，我们可以学习下。另外，Eureka 在集群同步，也有类似处理。</li>
</ul>
</li>
<li>第 36 行：发起任务，<strong>定时</strong>检查，是否需要重连。</li>
</ul>
</li>
<li><p><code>reconnect=false to close reconnect</code> ，从目前代码上来看，未实现 <code>#reset(url)</code> 方法，在 URL 的 <code>reconnect=false</code> 配置项时，关闭重连线程。</p>
</li>
</ul>
<p><strong>发送消息</strong></p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(Object message, <span class="keyword">boolean</span> sent)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    <span class="comment">// 未连接时，开启重连功能，则先发起连接</span></span><br><span class="line">    <span class="keyword">if</span> (send_reconnect &amp;&amp; !isConnected()) &#123;</span><br><span class="line">        connect();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 发送消息</span></span><br><span class="line">    Channel channel = getChannel();</span><br><span class="line">    <span class="comment">//TODO Can the value returned by getChannel() be null? need improvement.</span></span><br><span class="line">    <span class="keyword">if</span> (channel == <span class="keyword">null</span> || !channel.isConnected()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RemotingException(<span class="keyword">this</span>, <span class="string">"message can not send, because channel is closed . url:"</span> + getUrl());</span><br><span class="line">    &#125;</span><br><span class="line">    channel.send(message, sent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>包装通道处理器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Constants.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_CLIENT_THREADPOOL = <span class="string">"cached"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String CLIENT_THREAD_POOL_NAME = <span class="string">"DubboClientHandler"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="number">1</span>: <span class="comment">/**</span></span><br><span class="line"><span class="comment">  2:  * 包装通道处理器</span></span><br><span class="line"><span class="comment">  3:  *</span></span><br><span class="line"><span class="comment">  4:  * <span class="doctag">@param</span> url URL</span></span><br><span class="line"><span class="comment">  5:  * <span class="doctag">@param</span> handler 被包装的通道处理器</span></span><br><span class="line"><span class="comment">  6:  * <span class="doctag">@return</span> 包装后的通道处理器</span></span><br><span class="line"><span class="comment">  7:  */</span></span><br><span class="line">  <span class="number">8</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> ChannelHandler <span class="title">wrapChannelHandler</span><span class="params">(URL url, ChannelHandler handler)</span> </span>&#123;</span><br><span class="line">  <span class="number">9</span>:     <span class="comment">// 设置线程名</span></span><br><span class="line"> <span class="number">10</span>:     url = ExecutorUtil.setThreadName(url, CLIENT_THREAD_POOL_NAME);</span><br><span class="line"> <span class="number">11</span>:     <span class="comment">// 设置使用的线程池类型</span></span><br><span class="line"> <span class="number">12</span>:     url = url.addParameterIfAbsent(Constants.THREADPOOL_KEY, Constants.DEFAULT_CLIENT_THREADPOOL);</span><br><span class="line"> <span class="number">13</span>:     <span class="comment">// 包装通道处理器</span></span><br><span class="line"> <span class="number">14</span>:     <span class="keyword">return</span> ChannelHandlers.wrap(handler, url);</span><br><span class="line"> <span class="number">15</span>: &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>第 10 行：调用 <code>ExecutorUtil#setThreadName(url, CLIENT_THREAD_POOL_NAME)</code>方法，设置<strong>线程名</strong>，即 <code>URL.threadname=xxx</code> 。代码如下：</p>
<figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public static URL setThreadName(URL <span class="built_in">url</span>, <span class="built_in">String</span> defaultName) &#123;</span><br><span class="line">    <span class="built_in">String</span> name = <span class="built_in">url</span>.getParameter(Constants.THREAD_NAME_KEY, defaultName);</span><br><span class="line">    name = <span class="keyword">new</span> StringBuilder(<span class="number">32</span>).append(name).append(<span class="string">"-"</span>).append(<span class="built_in">url</span>.getAddress()).toString();</span><br><span class="line">    <span class="built_in">url</span> = <span class="built_in">url</span>.addParameter(Constants.THREAD_NAME_KEY, name);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">url</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>注意，线程名中，包含 <strong>URL 的地址信息</strong>。</li>
</ul>
</li>
<li><p>第 12 行：设置<strong>线程类型</strong>，即 <code>URL.threadpool=xxx</code> 。默认情况下，使用 <code>&quot;cached&quot;</code> 类型，这个和 Server 是不同的，下面我们会看到。</p>
<ul>
<li><a href="http://svip.iocoder.cn/Dubbo/thread-pool/?self" target="_blank" rel="external">《精尽 Dubbo 源码分析 —— 线程池》</a></li>
</ul>
</li>
<li><p>第 14 行：调用 <code>ChannelHandlers#wrap(handler, url)</code> 方法，包装通道处理器。这里我们不细说，在 <a href="http://svip.iocoder.cn/Dubbo/remoting-api-transport/#" target="_blank" rel="external">「8. Dispacher」</a> 中，结合解析。</p>
</li>
<li><p>这是一个非常关键的方法，在例如 NettyClient 等里，都会调用该方法。</p>
</li>
</ul>
<p><strong>其他方法</strong></p>
<p>如下方法比较简单，艿艿就不重复啰嗦了。</p>
<ul>
<li><a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractClient.java#L291-L311" target="_blank" rel="external"><code>#disconnect()</code></a> 方法，断开连接。</li>
<li><a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractClient.java#L313-L316" target="_blank" rel="external"><code>#reconnect()</code></a> 方法，主动重连。</li>
<li><a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractClient.java#L318-L341" target="_blank" rel="external"><code>#close()</code></a> 方法，强制关闭。</li>
<li><a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractClient.java#L343-L346" target="_blank" rel="external"><code>#close(timeout)</code></a> 方法，优雅关闭。</li>
</ul>
<p><strong>子类类图</strong></p>
<p><img src="http://www.iocoder.cn/images/Dubbo/2018_12_04/03.png" alt="类图"></p>
<h2 id="3-2-ClientDelegate"><a href="#3-2-ClientDelegate" class="headerlink" title="3.2 ClientDelegate"></a>3.2 ClientDelegate</h2><p><a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/ClientDelegate.java" target="_blank" rel="external"><code>com.alibaba.dubbo.remoting.transport.ClientDelegate</code></a> ，实现 Client 接口，客户端装饰者实现类。在每个实现的方法里，直接调用被装饰的 <a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/ClientDelegate.java#L31" target="_blank" rel="external"><code>client</code></a> 属性的方法。</p>
<p>目前 <code>dubbo-rpc-default</code> 模块中，<a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-rpc/dubbo-rpc-default/src/main/java/com/alibaba/dubbo/rpc/protocol/dubbo/ChannelWrappedInvoker.java#L91-L160" target="_blank" rel="external">ChannelWrapper</a> 继承了 ClientDelegate 类。但实际上，ChannelWrapper <strong>重新实现了所有的方法</strong>，并且，并未复用任何方法。所以，ClientDelegate 目前用途不大。</p>
<h1 id="4-Server"><a href="#4-Server" class="headerlink" title="4. Server"></a>4. Server</h1><h2 id="4-1-AbstractServer"><a href="#4-1-AbstractServer" class="headerlink" title="4.1 AbstractServer"></a>4.1 AbstractServer</h2><p><a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractServer.java" target="_blank" rel="external"><code>com.alibaba.dubbo.remoting.transport.AbstractServer</code></a> ，实现 Server 接口，继承 AbstractEndpoint 抽象类，<strong>服务器</strong>抽象类，<strong>重点</strong>实现了公用的逻辑，同时抽象了开启、关闭等模板方法，供子类实现。抽象方法如下：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">void</span> <span class="title">doOpen</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">void</span> <span class="title">doClose</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span>;</span><br></pre></td></tr></table></figure>
<p><strong>构造方法</strong></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"> 1: /**</span><br><span class="line"> 2:  * 线程池</span><br><span class="line"> 3:  */</span><br><span class="line"> 4: ExecutorService executor;</span><br><span class="line"> 5: /**</span><br><span class="line"> 6:  * 服务地址</span><br><span class="line"> 7:  */</span><br><span class="line"> 8: <span class="keyword">private</span> InetSocketAddress localAddress;</span><br><span class="line"> 9: /**</span><br><span class="line"><span class="section">10:  * 绑定地址</span></span><br><span class="line"><span class="section">11:  */</span></span><br><span class="line"><span class="section">12: private InetSocketAddress bindAddress;</span></span><br><span class="line"><span class="section">13: /**</span></span><br><span class="line"><span class="section">14:  * 服务器最大可接受连接数</span></span><br><span class="line"><span class="section">15:  */</span></span><br><span class="line"><span class="section">16: private int accepts;</span></span><br><span class="line"><span class="section">17: /**</span></span><br><span class="line"><span class="section">18:  * 空闲超时时间，单位：毫秒</span></span><br><span class="line"><span class="section">19:  */</span></span><br><span class="line"><span class="section">20: private int idleTimeout; //600 seconds</span></span><br><span class="line"><span class="section">21:</span></span><br><span class="line"><span class="section">22: public AbstractServer(URL url, ChannelHandler handler) throws RemotingException &#123;</span></span><br><span class="line"><span class="section">23:     super(url, handler);</span></span><br><span class="line"><span class="section">24:     // 服务地址</span></span><br><span class="line"><span class="section">25:     localAddress = getUrl().toInetSocketAddress();</span></span><br><span class="line"><span class="section">26:     // 绑定地址</span></span><br><span class="line"><span class="section">27:     String bindIp = getUrl().getParameter(Constants.BIND_IP_KEY, getUrl().getHost());</span></span><br><span class="line"><span class="section">28:     int bindPort = getUrl().getParameter(Constants.BIND_PORT_KEY, getUrl().getPort());</span></span><br><span class="line"><span class="section">29:     if (url.getParameter(Constants.ANYHOST_KEY, false) || NetUtils.isInvalidLocalHost(bindIp)) &#123;</span></span><br><span class="line"><span class="section">30:         bindIp = NetUtils.ANYHOST;</span></span><br><span class="line"><span class="section">31:     &#125;</span></span><br><span class="line"><span class="section">32:     bindAddress = new InetSocketAddress(bindIp, bindPort);</span></span><br><span class="line"><span class="section">33:     // 服务器最大可接受连接数</span></span><br><span class="line"><span class="section">34:     this.accepts = url.getParameter(Constants.ACCEPTS_KEY, Constants.DEFAULT_ACCEPTS);</span></span><br><span class="line"><span class="section">35:     // 空闲超时时间</span></span><br><span class="line"><span class="section">36:     this.idleTimeout = url.getParameter(Constants.IDLE_TIMEOUT_KEY, Constants.DEFAULT_IDLE_TIMEOUT);</span></span><br><span class="line"><span class="section">37:</span></span><br><span class="line"><span class="section">38:     // 开启服务器</span></span><br><span class="line"><span class="section">39:     try &#123;</span></span><br><span class="line"><span class="section">40:         doOpen();</span></span><br><span class="line"><span class="section">41:         if (logger.isInfoEnabled()) &#123;</span></span><br><span class="line"><span class="section">42:             logger.info("Start " + getClass().getSimpleName() + " bind " + getBindAddress() + ", export " + getLocalAddress());</span></span><br><span class="line"><span class="section">43:         &#125;</span></span><br><span class="line"><span class="section">44:     &#125; catch (Throwable t) &#123;</span></span><br><span class="line"><span class="section">45:         throw new RemotingException(url.toInetSocketAddress(), null, "Failed to bind " + getClass().getSimpleName()</span></span><br><span class="line"><span class="section">46:                 + " on " + getLocalAddress() + ", cause: " + t.getMessage(), t);</span></span><br><span class="line"><span class="section">47:     &#125;</span></span><br><span class="line"><span class="section">48:</span></span><br><span class="line"><span class="section">49:     // 获得线程池</span></span><br><span class="line"><span class="section">50:     //fixme replace this with better method</span></span><br><span class="line"><span class="section">51:     DataStore dataStore = ExtensionLoader.getExtensionLoader(DataStore.class).getDefaultExtension();</span></span><br><span class="line"><span class="section">52:     executor = (ExecutorService) dataStore.get(Constants.EXECUTOR_SERVICE_COMPONENT_KEY, Integer.toString(url.getPort()));</span></span><br><span class="line"><span class="section">53: &#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>第 24 至 36 行：从 URL 中，加载</li>
</ul>
  <figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">localAddress</span></span><br></pre></td></tr></table></figure>
  <figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">bindAddress</span></span><br></pre></td></tr></table></figure>
  <figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">accepts</span></span><br></pre></td></tr></table></figure>
  <figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">idleTimeout</span></span><br></pre></td></tr></table></figure>
<p>  配置项。比较难理解的，可能是两个地址属性，如下是比例提供的一个例子：</p>
<ul>
<li>配置项可在 <a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractServer.java#L80-L129" target="_blank" rel="external"><code>#reset(url)</code></a> 方法中，重置属性。</li>
</ul>
<ul>
<li><p>第 38 至 47 行：调用 <code>#doOpen()</code> 方法，开启服务器。</p>
</li>
<li><p>第 49 至 52 行：从DataStore中，获得线程池。</p>
<ul>
<li><code>fixme replace this with better method</code> ，说明<strong>官方</strong>在这块实现上，也不是很满意，后面会优化掉。</li>
</ul>
</li>
</ul>
<p><strong>被客户端连接</strong></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="built_in">connected</span>(Channel ch) throws RemotingException &#123;</span><br><span class="line">    <span class="comment">// If the server has entered the shutdown process, reject any new connection</span></span><br><span class="line">    <span class="built_in">if</span> (<span class="keyword">this</span>.isClosing() || <span class="keyword">this</span>.isClosed()) &#123;</span><br><span class="line">        logger.warn(<span class="string">"Close new channel "</span> + ch + <span class="string">", cause: server is closing or has been closed. For example, receive a new connect request while in shutdown process."</span>);</span><br><span class="line">        ch.<span class="built_in">close</span>();</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 超过上限，关闭新的链接</span></span><br><span class="line">    Collection&lt;Channel&gt; channels = getChannels();</span><br><span class="line">    <span class="built_in">if</span> (accepts &gt; <span class="number">0</span> &amp;&amp; channels.<span class="built_in">size</span>() &gt; accepts) &#123;</span><br><span class="line">        logger.error(<span class="string">"Close channel "</span> + ch + <span class="string">", cause: The server "</span> + ch.getLocalAddress() + <span class="string">" connections greater than max config "</span> + accepts);</span><br><span class="line">        ch.<span class="built_in">close</span>(); <span class="comment">// 关闭新的链接</span></span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 连接</span></span><br><span class="line">    super.<span class="built_in">connected</span>(ch);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>发送消息</strong></p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(Object message, <span class="keyword">boolean</span> sent)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    <span class="comment">// 获得所有的客户端的通道</span></span><br><span class="line">    Collection&lt;Channel&gt; channels = getChannels();</span><br><span class="line">    <span class="comment">// 群发消息</span></span><br><span class="line">    <span class="keyword">for</span> (Channel channel : channels) &#123;</span><br><span class="line">        <span class="keyword">if</span> (channel.isConnected()) &#123;</span><br><span class="line">            channel.send(message, sent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>其他方法</strong></p>
<p>如下方法比较简单，艿艿就不重复啰嗦了。</p>
<ul>
<li><a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractServer.java#L196-L203" target="_blank" rel="external"><code>#disconnect()</code></a> 方法，断开连接。</li>
<li><a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractServer.java#L140-L155" target="_blank" rel="external"><code>#close()</code></a> 方法，强制关闭。</li>
<li><a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractServer.java#L157-L160" target="_blank" rel="external"><code>#close(timeout)</code></a> 方法，优雅关闭。</li>
</ul>
<p><strong>子类类图</strong></p>
<p><img src="http://www.iocoder.cn/images/Dubbo/2018_12_04/04.png" alt="类图"></p>
<h2 id="4-2-ServerDelegate"><a href="#4-2-ServerDelegate" class="headerlink" title="4.2 ServerDelegate"></a>4.2 ServerDelegate</h2><p><a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/ServerDelegate.java" target="_blank" rel="external"><code>com.alibaba.dubbo.remoting.transport.ServerDelegate</code></a> ，实现 Client 接口，客户端装饰者实现类。在每个实现的方法里，直接调用被装饰的 <a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/ServerDelegate.java#L35" target="_blank" rel="external"><code>server</code></a> 属性的方法。</p>
<p>目前 <code>dubbo-remoting-p2p</code> 模块中，PeerServer 会继承该类，后续再看。</p>
<h1 id="5-Channel"><a href="#5-Channel" class="headerlink" title="5. Channel"></a>5. Channel</h1><h2 id="5-1-AbstractChannel"><a href="#5-1-AbstractChannel" class="headerlink" title="5.1 AbstractChannel"></a>5.1 AbstractChannel</h2><p><a href="https://github.com/YunaiV/dubbo/blob/4fa80f25673c4e7060847a711a87ea37ed152d91/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractChannel.java" target="_blank" rel="external"><code>com.alibaba.dubbo.remoting.transport.AbstractChannel</code></a> ，实现 Channel 接口，实现 AbstractPeer 抽象类，<strong>通道</strong>抽象类。</p>
<p><strong>发送消息</strong></p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(Object message, <span class="keyword">boolean</span> sent)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isClosed()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RemotingException(<span class="keyword">this</span>, <span class="string">"Failed to send message "</span></span><br><span class="line">                + (message == <span class="keyword">null</span> ? <span class="string">""</span> : message.getClass().getName()) + <span class="string">":"</span> + message</span><br><span class="line">                + <span class="string">", cause: Channel closed. channel: "</span> + getLocalAddress() + <span class="string">" -&gt; "</span> + getRemoteAddress());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>具体的发送方法，子类实现。在 AbstractChannel 中，目前只做状态检查。</li>
</ul>
<p><strong>子类类图</strong></p>
<p><img src="http://www.iocoder.cn/images/Dubbo/2018_12_04/05.png" alt="类图"></p>
<h2 id="5-2-ChannelDelegate"><a href="#5-2-ChannelDelegate" class="headerlink" title="5.2 ChannelDelegate"></a>5.2 ChannelDelegate</h2><p><a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/ChannelDelegate.java" target="_blank" rel="external"><code>com.alibaba.dubbo.remoting.transport.ChannelDelegate</code></a> ，实现 Channel 接口，通道装饰者实现类。在每个实现的方法里，直接调用被装饰的 <a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/ChannelDelegate.java#L31" target="_blank" rel="external"><code>channel</code></a> 属性的方法。</p>
<p>目前 Dubbo 中，暂未用到。</p>
<h1 id="7-ChannelHandler"><a href="#7-ChannelHandler" class="headerlink" title="7. ChannelHandler"></a>7. ChannelHandler</h1><h2 id="7-1-ChannelHandlerAdapter"><a href="#7-1-ChannelHandlerAdapter" class="headerlink" title="7.1 ChannelHandlerAdapter"></a>7.1 ChannelHandlerAdapter</h2><p><code>com.alibaba.dubbo.remoting.transport.ChannelHandlerAdapter</code> ，实现 ChannelHandler 接口，通道处理器<strong>适配器</strong>，每个方法为空实现。代码如下：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Override</span> public void connected(Channel channel) throws RemotingException &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">@Override</span> public void disconnected(Channel channel) throws RemotingException &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">@Override</span> public void sent(Channel channel, Object message) &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">@Override</span> public void received(Channel channel, Object message) throws RemotingException &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">@Override</span> public void caught(Channel channel, Throwable exception) throws RemotingException &#123; &#125;</span><br></pre></td></tr></table></figure>
<p>子类，可继承它，<strong>仅实现</strong>想要的方法。</p>
<h2 id="7-2-ChannelHandlerDispatcher"><a href="#7-2-ChannelHandlerDispatcher" class="headerlink" title="7.2 ChannelHandlerDispatcher"></a>7.2 ChannelHandlerDispatcher</h2><p><code>com.alibaba.dubbo.remoting.transport.ChannelHandlerDispatcher</code> ，实现 ChannelHandler 接口，通道处理器<strong>调度器</strong>。在它内部，有一个通道处理器数组 <a href="https://github.com/YunaiV/dubbo/blob/4fa80f25673c4e7060847a711a87ea37ed152d91/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/ChannelHandlerDispatcher.java#L35" target="_blank" rel="external"><code>channelHandlers</code></a> 属性。</p>
<p>每个实现的方法，都会循环调用 <code>channelHandlers</code> 的方法，例如：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">received</span><span class="params">(Channel channel, Object message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (ChannelHandler listener : channelHandlers) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            listener.received(channel, message);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            logger.<span class="keyword">error</span>(t.getMessage(), t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>搜索了下 ChannelHandlerDispatcher 的使用情况，主要用在 <code>dubbo-remoting-p2p</code> 的 AbstractGroup 中。</p>
<h2 id="7-3-ChannelHandlerDelegate"><a href="#7-3-ChannelHandlerDelegate" class="headerlink" title="7.3 ChannelHandlerDelegate"></a>7.3 ChannelHandlerDelegate</h2><p><code>com.alibaba.dubbo.remoting.transport.ChannelHandlerDelegate</code> ，实现 ChannelHandler 接口，通道处理器<strong>装饰者</strong>接口。方法如下：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ChannelHandler getHandler()<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>正如，我们在上文中说道，<strong>装饰器模式</strong>，在 <code>dubbo-remoting-api</code> 扮演了非常重要的角色，那么最佳演员就是 ChannelHandlerDelegate 们。下面，开始他们的表演。</p>
<h3 id="7-3-1-AbstractChannelHandlerDelegate"><a href="#7-3-1-AbstractChannelHandlerDelegate" class="headerlink" title="7.3.1 AbstractChannelHandlerDelegate"></a>7.3.1 AbstractChannelHandlerDelegate</h3><p><a href="https://github.com/YunaiV/dubbo/blob/4fa80f25673c4e7060847a711a87ea37ed152d91/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractChannelHandlerDelegate.java" target="_blank" rel="external"><code>com.alibaba.dubbo.remoting.transport.AbstractChannelHandlerDelegate</code></a> ，实现 ChannelHandlerDelegate 接口，通道处理器装饰者<strong>抽象实现类</strong>。在每个实现的方法里，直接调用被装饰的 <a href="https://github.com/YunaiV/dubbo/blob/4fa80f25673c4e7060847a711a87ea37ed152d91/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractChannelHandlerDelegate.java#L26" target="_blank" rel="external"><code>handler</code></a> 属性的方法。</p>
<h3 id="7-3-2-DecodeHandler"><a href="#7-3-2-DecodeHandler" class="headerlink" title="7.3.2 DecodeHandler"></a>7.3.2 DecodeHandler</h3><p><code>com.alibaba.dubbo.remoting.transport.DecodeHandler</code> ，实现 AbstractChannelHandlerDelegate 抽象类，<strong>解码处理器</strong>，处理接收到的消息，实现了 Decodeable 接口的情况。</p>
<p><strong>覆写了 #received(channel, message) 方法</strong></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="attribute">1</span>: <span class="variable">@Override</span></span><br><span class="line"> <span class="number">2</span>: public void received(Channel channel, Object message) throws RemotingException &#123;</span><br><span class="line"> <span class="number">3</span>:     if (message instanceof Decodeable) &#123;</span><br><span class="line"> <span class="number">4</span>:         decode(message);</span><br><span class="line"> <span class="attribute">5</span>:     &#125;</span><br><span class="line"> <span class="attribute">6</span>:</span><br><span class="line"> <span class="number">7</span>:     if (message instanceof Request) &#123;</span><br><span class="line"> <span class="number">8</span>:         decode(((Request) message).getData());</span><br><span class="line"> <span class="attribute">9</span>:     &#125;</span><br><span class="line"><span class="attribute">10</span>:</span><br><span class="line"><span class="number">11</span>:     if (message instanceof Response) &#123;</span><br><span class="line"><span class="number">12</span>:         decode(((Response) message).getResult());</span><br><span class="line"><span class="attribute">13</span>:     &#125;</span><br><span class="line"><span class="attribute">14</span>:</span><br><span class="line"><span class="number">15</span>:     handler.received(channel, message);</span><br><span class="line"><span class="attribute">16</span>: &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>第 3 至 5 行：当消息是 Decodeable 类型时，调用 <code>#decode(message)</code> 方法，解析消息。</li>
<li>第 7 至 9 行：当消息是 Request 类型时，调用 <code>#decode(message)</code> 方法，解析 <code>data</code> 属性。</li>
<li>第 11 至 13 行：当消息是 Response 类型时，调用 <code>#decode(message)</code> 方法，解析 <code>result</code> 属性。</li>
<li>第 15 行：调用 <code>ChannelHandler#received(channel, message)</code> 方法，将消息交给委托的 <code>handler</code> ，继续处理。🙂 胖友是否感受到，装饰器模式的好处：通过组合的方式，实现功能的叠加。</li>
</ul>
<p><strong>解析消息</strong></p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="keyword">private</span> <span class="keyword">void</span> decode(<span class="keyword">Object</span> message) &#123;</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">if</span> (message != <span class="keyword">null</span> &amp;&amp; message <span class="keyword">instanceof</span> Decodeable) &#123;</span><br><span class="line"> <span class="number">3</span>:         <span class="keyword">try</span> &#123;</span><br><span class="line"> <span class="number">4</span>:             ((Decodeable) message).decode(); <span class="comment">// 解析消息</span></span><br><span class="line"> <span class="number">5</span>:             <span class="keyword">if</span> (<span class="built_in">log</span>.isDebugEnabled()) &#123;</span><br><span class="line"> <span class="number">6</span>:                 <span class="built_in">log</span>.debug(<span class="keyword">new</span> StringBuilder(<span class="number">32</span>).<span class="built_in">append</span>(<span class="string">"Decode decodeable message "</span>).<span class="built_in">append</span>(message.getClass().getName()).toString());</span><br><span class="line"> <span class="number">7</span>:             &#125;</span><br><span class="line"> <span class="number">8</span>:         &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line"> <span class="number">9</span>:             <span class="keyword">if</span> (<span class="built_in">log</span>.isWarnEnabled()) &#123;</span><br><span class="line"><span class="number">10</span>:                 <span class="built_in">log</span>.warn(<span class="keyword">new</span> StringBuilder(<span class="number">32</span>).<span class="built_in">append</span>(<span class="string">"Call Decodeable.decode failed: "</span>).<span class="built_in">append</span>(e.getMessage()).toString(), e);</span><br><span class="line"><span class="number">11</span>:             &#125;</span><br><span class="line"><span class="number">12</span>:         &#125; <span class="comment">// ~ end of catch</span></span><br><span class="line"><span class="number">13</span>:     &#125; <span class="comment">// ~ end of if</span></span><br><span class="line"><span class="number">14</span>: &#125; <span class="comment">// ~ end of method decode</span></span><br></pre></td></tr></table></figure>
<ul>
<li>第 2 至 4 行：当类型是 Decodeable 时，调用 <code>Decodeable#decode()</code> 方法，进一步解析。</li>
<li>在 <code>dubbo-rpc-default</code> 项目中，DecodeableRpcInvocation 和 DecodeableRpcResult 实现 Decodeable 接口，后面我们来分享。</li>
</ul>
<h3 id="7-3-3-MultiMessageHandler"><a href="#7-3-3-MultiMessageHandler" class="headerlink" title="7.3.3 MultiMessageHandler"></a>7.3.3 MultiMessageHandler</h3><p><code>com.alibaba.dubbo.remoting.transport.MultiMessageHandler</code> ，实现 AbstractChannelHandlerDelegate 抽象类，<strong>多消息处理器</strong>，处理一次性接收到多条消息的情况。</p>
<p><strong>覆写了 #received(channel, message) 方法</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="attribute">1</span>: @Override</span><br><span class="line"> <span class="attribute">2</span>: public void received(Channel channel, Object message) throws RemotingException &#123;</span><br><span class="line"> <span class="attribute">3</span>:     if (message instanceof MultiMessage) &#123; // 多消息</span><br><span class="line"> <span class="attribute">4</span>:         MultiMessage list = (MultiMessage) message;</span><br><span class="line"> <span class="attribute">5</span>:         for (Object obj : list) &#123;</span><br><span class="line"> <span class="attribute">6</span>:             handler.received(channel, obj);</span><br><span class="line"> <span class="attribute">7</span>:         &#125;</span><br><span class="line"> <span class="attribute">8</span>:     &#125; else &#123;</span><br><span class="line"> <span class="attribute">9</span>:         handler.received(channel, message);</span><br><span class="line"><span class="attribute">10</span>:     &#125;</span><br><span class="line"><span class="attribute">11</span>: &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>第 3 至 7 行：当消息是 MultiMessage 类型，即<strong>多消息</strong>，<strong>循环</strong>提交给 <code>handler</code> 处理。</li>
<li>第 8 至 10 行：当<strong>单消息</strong>时，<strong>直接</strong>提交给 <code>handler</code> 处理。</li>
</ul>
<hr>
<p>🙂 在下面的文章，我们可以看到 ChannelHandlerDelegate 的<strong>组合使用的例子</strong>。</p>
<h1 id="8-Dispacher"><a href="#8-Dispacher" class="headerlink" title="8. Dispacher"></a>8. Dispacher</h1><p>本小节内容，对应 <a href="http://dubbo.apache.org/zh-cn/docs/user/demos/thread-model.html" target="_blank" rel="external">《Dubbo 用户指南 —— 线程模型》</a> 。</p>
<p>简单概括这节，以<strong>接收消息</strong>举例子，代码如下：</p>
<figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">executor.execute(<span class="function"><span class="keyword">new</span> <span class="title">Runnable</span>() &#123;</span></span><br><span class="line"><span class="function">    <span class="title">handler</span>.<span class="title">received</span>(channel, message)</span></span><br><span class="line"><span class="function">&#125;);</span></span><br></pre></td></tr></table></figure>
<p>将 ChannelHandler 的具体操作，调度到线程池中，这也是为什么这个模块叫 <code>dispacher</code> 的原因。</p>
<h2 id="8-1-ChannelHandlers"><a href="#8-1-ChannelHandlers" class="headerlink" title="8.1 ChannelHandlers"></a>8.1 ChannelHandlers</h2><p><code>com.alibaba.dubbo.remoting.transport.dispatcher.ChannelHandlers</code> ，通道处理器<strong>工厂</strong>。在上文 <a href="http://svip.iocoder.cn/Dubbo/remoting-api-transport/#" target="_blank" rel="external">「3.1 AbstractClient」</a> ，我们看到 <code>AbstractClient#wrapChannelHandler(url, handler)</code> 方法中，会调用 <code>ChannelHandlers#wrap(url, handler)</code> 方法。实际上，Server 部分也会有这样类似的逻辑，只是代码实现上暂未统一。以 <code>dubbo-remoting-netty4</code> 来举例子：</p>
<ul>
<li><p>NettyClient ：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NettyClient</span><span class="params">(<span class="keyword">final</span> URL url, <span class="keyword">final</span> ChannelHandler <span class="keyword">handler</span>)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(url, wrapChannelHandler(url, <span class="keyword">handler</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>NettyServer ：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NettyServer</span><span class="params">(URL url, ChannelHandler <span class="keyword">handler</span>)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(url, ChannelHandlers.wrap(<span class="keyword">handler</span>, ExecutorUtil.setThreadName(url, SERVER_THREAD_POOL_NAME) <span class="comment">/* 设置线程名到 URL 上 */</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>无论 Client 还是 Server ，都是类似的，将传入的 <code>handler</code> ，最终使用 ChannelHandlers 进行一次包装。OK ，我们来看看包装通道处理器的具体代码：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span>: /**</span><br><span class="line"> 2:  * 单例</span><br><span class="line"> 3:  */</span><br><span class="line"> 4: <span class="keyword">private</span> <span class="keyword">static</span> ChannelHandlers INSTANCE = <span class="keyword">new</span> ChannelHandlers();</span><br><span class="line"> <span class="number">5</span>:</span><br><span class="line"> 6: <span class="keyword">public</span> <span class="keyword">static</span> ChannelHandler wrap(ChannelHandler <span class="keyword">handler</span>, URL url) &#123;</span><br><span class="line"> <span class="number">7</span>:     <span class="keyword">return</span> ChannelHandlers.getInstance().wrapInternal(<span class="keyword">handler</span>, url);</span><br><span class="line"> <span class="number">8</span>: &#125;</span><br><span class="line"> 9:</span><br><span class="line">10: <span class="keyword">protected</span> ChannelHandler wrapInternal(ChannelHandler <span class="keyword">handler</span>, URL url) &#123;</span><br><span class="line"><span class="number">11</span>:     <span class="keyword">return</span> <span class="keyword">new</span> MultiMessageHandler(</span><br><span class="line">12:             <span class="keyword">new</span> HeartbeatHandler(</span><br><span class="line">13:                     ExtensionLoader.getExtensionLoader(Dispatcher.class).getAdaptiveExtension().dispatch(<span class="keyword">handler</span>, url)</span><br><span class="line">14:             )</span><br><span class="line">15:     );</span><br><span class="line"><span class="number">16</span>: &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>第 11 至 15 行：在这里，我们就看到了多个 ChannelHandlerDelegate 的组合。包括，第 15 行的，<code>Dispatcher#dispatch(handler, url)</code> 方法，实际上也是<strong>返回</strong>一个 ChannelHandlerDelegate 对象。</li>
</ul>
<h2 id="8-2-Dispatcher-实现类"><a href="#8-2-Dispatcher-实现类" class="headerlink" title="8.2 Dispatcher 实现类"></a>8.2 Dispatcher 实现类</h2><p>在 Dubbo 中，有多种 Dispatcher 的实现，如下：</p>
<blockquote>
<p>FROM <a href="http://dubbo.apache.org/zh-cn/docs/user/demos/thread-model.html" target="_blank" rel="external">《Dubbo 用户指南 —— 线程模型》</a></p>
<ul>
<li><code>all</code> 所有消息都派发到线程池，包括请求，响应，连接事件，断开事件，心跳等。</li>
<li><code>direct</code> 所有消息都不派发到线程池，全部在 IO 线程上直接执行。</li>
<li><code>message</code> 只有请求响应消息派发到线程池，其它连接断开事件，心跳等消息，直接在 IO 线程上执行。</li>
<li><code>execution</code> 只请求消息派发到线程池，不含响应，响应和其它连接断开事件，心跳等消息，直接在 IO 线程上执行。</li>
<li><code>connection</code> 在 IO 线程上，将连接断开事件放入队列，有序逐个执行，其它消息派发到线程池。</li>
</ul>
</blockquote>
<p><strong>子类类图</strong></p>
<p><img src="http://www.iocoder.cn/images/Dubbo/2018_12_04/07.png" alt="类图"></p>
<h3 id="8-2-1-AllDispatcher"><a href="#8-2-1-AllDispatcher" class="headerlink" title="8.2.1 AllDispatcher"></a>8.2.1 AllDispatcher</h3><p>我们以 <code>all</code> 对应的 AllDispatcher 举例子，代码如下：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllDispatcher</span> <span class="keyword">implements</span> <span class="title">Dispatcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">"all"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function">ChannelHandler <span class="title">dispatch</span><span class="params">(ChannelHandler <span class="keyword">handler</span>, URL url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AllChannelHandler(<span class="keyword">handler</span>, url);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在该类的 <code>#dispatch(...)</code> 的方法中，我们可以看到创建 AllChannelHandler 对象，并传入 <code>handler</code> 属性。🙂 聪慧如你，已经猜到 AllChannelHandler 也是 ChannelHandlerDelegate 类型。也就是说“<strong>线程模型</strong>”，也是通过<strong>装饰器模式</strong>，组合而成。</p>
<p>每个 Dispatcher 实现类，都对应一个 ChannelHandler 实现类。默认<strong>未配置</strong>的情况下，使用 AllDispatcher 调度。</p>
<h3 id="8-2-2-AllChannelHandler"><a href="#8-2-2-AllChannelHandler" class="headerlink" title="8.2.2 AllChannelHandler"></a>8.2.2 AllChannelHandler</h3><p><a href="http://svip.iocoder.cn/Dubbo/remoting-api-transport/com.alibaba.dubbo.remoting.transport.dispatcher.all" target="_blank" rel="external"><code>com.alibaba.dubbo.remoting.transport.dispatcher.all.AllChannelHandler</code></a> ，实现 WrappedChannelHandler 抽象类。覆写 <code>#connected(channel)</code> 方法如下：</p>
<blockquote>
<p>WrappedChannelHandler 是实现 ChannelHandlerDelegate 的抽象类，下文再看。</p>
</blockquote>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">connected</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    ExecutorService cexecutor = getExecutorService();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        cexecutor.execute(<span class="keyword">new</span> ChannelEventRunnable(channel, <span class="keyword">handler</span>, ChannelState.CONNECTED));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ExecutionException(<span class="string">"connect event"</span>, channel, getClass() + <span class="string">" error when process connected event ."</span>, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建 ChannelEventRunnable 对象，提交给线程池执行。</li>
<li>注意，传入的状态为 <code>ChannelState.CONNECTED</code> 。不同的实现方法，对应不同的状态。</li>
</ul>
<h2 id="8-3-ChannelEventRunnable"><a href="#8-3-ChannelEventRunnable" class="headerlink" title="8.3 ChannelEventRunnable"></a>8.3 ChannelEventRunnable</h2><p><a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/dispatcher/ChannelEventRunnable.java" target="_blank" rel="external"><code>com.alibaba.dubbo.remoting.transport.dispatcher.ChannelEventRunnable</code></a> ，实现 Runnable 接口。代码比较简单，胖友自己看噢。主要分成三部分：</p>
<ul>
<li><p><a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/dispatcher/ChannelEventRunnable.java#L27-L51" target="_blank" rel="external">构造方法</a></p>
</li>
<li><p><a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/dispatcher/ChannelEventRunnable.java#L98-L129" target="_blank" rel="external">ChannelState</a></p>
</li>
<li><p><a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/dispatcher/ChannelEventRunnable.java#L53-L96" target="_blank" rel="external"><code>#run()</code></a> 方法，简化代码如下：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">        <span class="keyword">case</span> CONNECTED: <span class="keyword">handler</span>.connected(channel); <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DISCONNECTED:<span class="keyword">handler</span>.disconnected(channel); <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SENT:<span class="keyword">handler</span>.sent(channel, message);<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> RECEIVED:<span class="keyword">handler</span>.received(channel, message);<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CAUGHT:<span class="keyword">handler</span>.caught(channel, exception);<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>: logger.warn(<span class="string">"unknown state: "</span> + state + <span class="string">", message is "</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="8-4-WrappedChannelHandler"><a href="#8-4-WrappedChannelHandler" class="headerlink" title="8.4 WrappedChannelHandler"></a>8.4 WrappedChannelHandler</h2><p><code>com.alibaba.dubbo.remoting.transport.dispatcher.WrappedChannelHandler</code> ，实现 ChannelHandlerDelegate 接口，<strong>包装的</strong> WrappedChannelHandler 实现类。</p>
<blockquote>
<p>从目前的实现来看，WrappedChannelHandler 继承 AbstractChannelHandlerDelegate 更合适，因为 <code>#connected(channel)</code> 等，实现的方法都是相同的。</p>
</blockquote>
<p><strong>构造方法</strong></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> 1: /**</span><br><span class="line"> 2:  * 线程池</span><br><span class="line"> 3:  */</span><br><span class="line"> 4: protected final ExecutorService executor;</span><br><span class="line"> 5: /**</span><br><span class="line"> 6:  * 通道处理器</span><br><span class="line"> 7:  */</span><br><span class="line"> 8: protected final ChannelHandler handler;</span><br><span class="line"> 9: /**</span><br><span class="line"><span class="section">10:  * URL</span></span><br><span class="line"><span class="section">11:  */</span></span><br><span class="line"><span class="section">12: protected final URL url;</span></span><br><span class="line"><span class="section">13:</span></span><br><span class="line"><span class="section">14: public WrappedChannelHandler(ChannelHandler handler, URL url) &#123;</span></span><br><span class="line"><span class="section">15:     this.handler = handler;</span></span><br><span class="line"><span class="section">16:     this.url = url;</span></span><br><span class="line"><span class="section">17:</span></span><br><span class="line"><span class="section">18:     // 创建线程池</span></span><br><span class="line"><span class="section">19:     executor = (ExecutorService) ExtensionLoader.getExtensionLoader(ThreadPool.class).getAdaptiveExtension().getExecutor(url);</span></span><br><span class="line"><span class="section">20:</span></span><br><span class="line"><span class="section">21:     // 添加线程池到 DataStore 中</span></span><br><span class="line"><span class="section">22:     String componentKey = Constants.EXECUTOR_SERVICE_COMPONENT_KEY;</span></span><br><span class="line"><span class="section">23:     if (Constants.CONSUMER_SIDE.equalsIgnoreCase(url.getParameter(Constants.SIDE_KEY))) &#123;</span></span><br><span class="line"><span class="section">24:         componentKey = Constants.CONSUMER_SIDE;</span></span><br><span class="line"><span class="section">25:     &#125;</span></span><br><span class="line"><span class="section">26:     DataStore dataStore = ExtensionLoader.getExtensionLoader(DataStore.class).getDefaultExtension();</span></span><br><span class="line"><span class="section">27:     dataStore.put(componentKey, Integer.toString(url.getPort()), executor);</span></span><br><span class="line"><span class="section">28: &#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>第 19 行：基于 Dubbo SPI Adaptive 机制，创建线程池。</li>
<li>第 21 至 27 行：添加线程池到 DataStore 中。🙂 这就是上文 AbstractClient 或 AbstractServer 从 DataStore 获得线程池的<strong>方式</strong>。当然，官方也说了，这种方式不是很优雅，有点奇淫技巧，未来会优化掉。</li>
</ul>
<p><strong>共享线程池</strong></p>
<p>在 WrappedChannelHandler 中，有一个内置的共享线程池，如下：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protected <span class="keyword">static</span> final ExecutorService SHARED_EXECUTOR = Executors.<span class="keyword">new</span><span class="type">CachedThreadPool</span>(<span class="keyword">new</span> <span class="type">NamedThreadFactory</span>(<span class="string">"DubboSharedHandler"</span>, <span class="literal">true</span>));</span><br></pre></td></tr></table></figure>
<p>【TODO 8024】搞不懂，这个设计的意图，先mark留着。</p>
<p><strong>子类类图</strong></p>
<p><img src="http://www.iocoder.cn/images/Dubbo/2018_12_04/06.png" alt="类图"></p>
<h1 id="9-Codec"><a href="#9-Codec" class="headerlink" title="9. Codec"></a>9. Codec</h1><h2 id="9-1-CodecSupport"><a href="#9-1-CodecSupport" class="headerlink" title="9.1 CodecSupport"></a>9.1 CodecSupport</h2><p><code>com.alibaba.dubbo.remoting.transport.CodecSupport</code> ，编解码工具类，提供查询 Serialization 的功能。</p>
<p><strong>初始化</strong></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 序列化对象集合</span></span><br><span class="line"><span class="comment"> * key：序列化类型编号 &#123;@link Serialization#getContentTypeId()&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Byte, Serialization&gt; ID_SERIALIZATION_MAP = <span class="keyword">new</span> HashMap&lt;Byte, Serialization&gt;();</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 序列化名集合</span></span><br><span class="line"><span class="comment"> * key：序列化类型编号 &#123;@link Serialization#getContentTypeId()&#125;</span></span><br><span class="line"><span class="comment"> * value: 序列化拓展名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Byte, <span class="keyword">String</span>&gt; ID_SERIALIZATIONNAME_MAP = <span class="keyword">new</span> HashMap&lt;Byte, <span class="keyword">String</span>&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="comment">// 基于 Dubbo SPI ，初始化</span></span><br><span class="line">    Set&lt;<span class="keyword">String</span>&gt; supportedExtensions = ExtensionLoader.getExtensionLoader(Serialization.class).getSupportedExtensions();</span><br><span class="line">    <span class="built_in">for</span> (<span class="keyword">String</span> name : supportedExtensions) &#123;</span><br><span class="line">        Serialization serialization = ExtensionLoader.getExtensionLoader(Serialization.class).getExtension(name);</span><br><span class="line">        <span class="keyword">byte</span> idByte = serialization.getContentTypeId();</span><br><span class="line">        <span class="built_in">if</span> (ID_SERIALIZATION_MAP.containsKey(idByte)) &#123;</span><br><span class="line">            logger.error(<span class="string">"Serialization extension "</span> + serialization.getClass().getName()</span><br><span class="line">                    + <span class="string">" has duplicate id to Serialization extension "</span></span><br><span class="line">                    + ID_SERIALIZATION_MAP.<span class="built_in">get</span>(idByte).getClass().getName()</span><br><span class="line">                    + <span class="string">", ignore this Serialization extension"</span>);</span><br><span class="line">            <span class="built_in">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ID_SERIALIZATION_MAP.<span class="built_in">put</span>(idByte, serialization);</span><br><span class="line">        ID_SERIALIZATIONNAME_MAP.<span class="built_in">put</span>(idByte, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Dubbo 提供了多种序列化方式，此处初始化结果，如下图：<img src="http://www.iocoder.cn/images/Dubbo/2018_12_04/08.png" alt="SERIALIZATION 集合"></p>
<p><strong>查找 Serialization 对象</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Serialization <span class="title">getSerialization</span>(<span class="params">URL url, Byte id</span>) throws IOException </span>&#123;</span><br><span class="line">    Serialization serialization = getSerializationById(id);</span><br><span class="line">    String serializationName = url.getParameter(Constants.SERIALIZATION_KEY, Constants.DEFAULT_REMOTING_SERIALIZATION); <span class="comment">// 默认，hessian2</span></span><br><span class="line">    <span class="comment">// 出于安全的目的，针对 JDK 的序列化方式（对应编号为 3、4、7），检查连接到服务器的 URL 和实际传输的数据，协议是否一致。</span></span><br><span class="line">    <span class="comment">// https://github.com/apache/incubator-dubbo/issues/1138</span></span><br><span class="line">    <span class="comment">// Check if "serialization id" passed from network matches the id on this side(only take effect for JDK serialization), for security purpose.</span></span><br><span class="line">    <span class="keyword">if</span> (serialization == <span class="literal">null</span></span><br><span class="line">            || ((id == <span class="number">3</span> || id == <span class="number">7</span> || id == <span class="number">4</span>) &amp;&amp; !(serializationName.<span class="keyword">equals</span>(ID_SERIALIZATIONNAME_MAP.<span class="keyword">get</span>(id))))) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected serialization id:"</span> + id + <span class="string">" received from network, please check if the peer send the right id."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> serialization;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>🙂 在最新的 Dubbo 版本中，已经将 <code>serialization</code> 模块，从 <code>dubbo-common</code> 中，独立成 <a href="https://github.com/apache/incubator-dubbo/blob/HEAD/dubbo-serialization/pom.xml" target="_blank" rel="external"><code>dubbo-serialization</code></a> 。So ，我们后面开一个系列来分享。</p>
<h2 id="9-2-AbstractCodec"><a href="#9-2-AbstractCodec" class="headerlink" title="9.2 AbstractCodec"></a>9.2 AbstractCodec</h2><p><code>com.alibaba.dubbo.remoting.transport.AbstractCodec</code> ，实现 Codec<strong>2</strong> 接口，提供如下公用方法：</p>
<ul>
<li><a href="https://github.com/apache/incubator-dubbo/blob/05da8040e88ef5c9a544cb9dddf4c6abee6bd61a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractCodec.java#L38-L48" target="_blank" rel="external"><code>#checkPayload(channel, size)</code></a> <strong>静态</strong>方法，校验消息长度。</li>
<li><a href="https://github.com/apache/incubator-dubbo/blob/05da8040e88ef5c9a544cb9dddf4c6abee6bd61a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractCodec.java#L50-L52" target="_blank" rel="external"><code>#getSerialization(channel)</code></a> 方法，获得 Serialization 对象。</li>
<li><a href="https://github.com/apache/incubator-dubbo/blob/05da8040e88ef5c9a544cb9dddf4c6abee6bd61a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractCodec.java#L54-L71" target="_blank" rel="external"><code>#isClientSide(channel)</code></a> 方法，是否为客户端侧的通道。</li>
<li><a href="https://github.com/apache/incubator-dubbo/blob/05da8040e88ef5c9a544cb9dddf4c6abee6bd61a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractCodec.java#L73-L75" target="_blank" rel="external"><code>#isServerSide(channel)</code></a> 方法，是否为服务端侧的通道。</li>
</ul>
<p><strong>子类类图</strong></p>
<p><img src="http://www.iocoder.cn/images/Dubbo/2018_12_04/09.png" alt="类图"></p>
<p>编解码器的实现，通过<strong>继承</strong>的方式，获得更多的功能。每一个 Codec2 类实现对不同消息的编解码。通过<strong>协议头</strong>来判断，具体使用哪个编解码逻辑。听起来有点绕，我们来看一段简化 ExchangeCodec 的 <code>#decode(...)</code> 例子：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1:<span class="keyword"> protected</span> Object decode(Channel channel, ChannelBuffer buffer,<span class="built_in"> int </span>readable, byte[] header) throws IOException &#123;</span><br><span class="line">2:     //<span class="built_in"> check </span>magic number.</span><br><span class="line">3:    <span class="built_in"> if </span>(readable &gt; 0 &amp;&amp; header[0] != MAGIC_HIGH</span><br><span class="line">4:             || readable &gt; 1 &amp;&amp; header[1] != MAGIC_LOW) &#123;</span><br><span class="line">5:         // ... 省略</span><br><span class="line">6:        <span class="built_in"> return </span>super.decode(channel, buffer, readable, header);</span><br><span class="line">7:     &#125;</span><br><span class="line">8:</span><br><span class="line">9:      // ... 省略</span><br><span class="line">10:</span><br><span class="line">11:    <span class="built_in"> return </span>decodeBody(channel, is, header);</span><br><span class="line">12: &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>第 2 至 7 行：通过 magic number 判断到，<strong>并非</strong> Dubbo Exchange <strong>信息交易的协议头</strong>，转交给父类 TelnetCodec 处理，一般此时是 Telnet 消息。</li>
<li>第 8 至 11 行：通过 magic number 判断到，<strong>符合</strong> Dubbo Exchange <strong>信息交易的协议头</strong>，ExchangeCodec 自己处理。</li>
</ul>
<h3 id="9-2-1-TransportCodec"><a href="#9-2-1-TransportCodec" class="headerlink" title="9.2.1 TransportCodec"></a>9.2.1 TransportCodec</h3><p><code>com.alibaba.dubbo.remoting.transport.codec.TransportCodec</code> ，传输编解码器，使用 Serialization 进行序列化/反序列化，直接编解码。</p>
<p><strong>编码消息</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="attribute">1</span>: @Override</span><br><span class="line"> <span class="attribute">2</span>: public void encode(Channel channel, ChannelBuffer buffer, Object message) throws IOException &#123;</span><br><span class="line"> <span class="attribute">3</span>:     // 获得反序列化的 ObjectOutput 对象</span><br><span class="line"> <span class="attribute">4</span>:     OutputStream output = new ChannelBufferOutputStream(buffer);</span><br><span class="line"> <span class="attribute">5</span>:     ObjectOutput objectOutput = getSerialization(channel).serialize(channel.getUrl(), output);</span><br><span class="line"> <span class="attribute">6</span>:     // 写入 ObjectOutput</span><br><span class="line"> <span class="attribute">7</span>:     encodeData(channel, objectOutput, message);</span><br><span class="line"> <span class="attribute">8</span>:     objectOutput.flushBuffer();</span><br><span class="line"> <span class="attribute">9</span>:     // 释放</span><br><span class="line"><span class="attribute">10</span>:     if (objectOutput instanceof Cleanable) &#123;</span><br><span class="line"><span class="attribute">11</span>:         ((Cleanable) objectOutput).cleanup();</span><br><span class="line"><span class="attribute">12</span>:     &#125;</span><br><span class="line"><span class="attribute">13</span>: &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>第 3 至 5 行：获得对应的 Serialization 对象，并创建用于反序列化的 ObjectOutput 对象。不同的 Serialization 实现，对应不同的 ObjectOutput 实现类。🙂 这里，我们只要读懂大体流程，详细的，我们后面文章见。</p>
</li>
<li><p>第 7 行：调用 <code>#encodeData(channel, objectOutput, message)</code> 方法，写入 ObjectOutput。代码如下：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">encodeData</span><span class="params">(Channel channel, ObjectOutput output, Object message)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    encodeData(output, message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">encodeData</span><span class="params">(ObjectOutput output, Object message)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    output.writeObject(message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第 9 至 12 行：释放资源。目前，仅有 <code>kryo</code> 的 KryoObjectInput 、KryoObjectOutput 实现了 Cleanable 接口，需要释放资源。</p>
</li>
</ul>
<p><strong>解码消息</strong></p>
<p><a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/codec/TransportCodec.java#L48-L56" target="_blank" rel="external"><code>#decode(channel, buffer)</code></a> <strong>实现</strong>方法，和解码消息基本一致，胖友自己查看。</p>
<h2 id="9-3-CodecAdapter"><a href="#9-3-CodecAdapter" class="headerlink" title="9.3 CodecAdapter"></a>9.3 CodecAdapter</h2><p><a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/codec/CodecAdapter.java" target="_blank" rel="external"><code>com.alibaba.dubbo.remoting.transport.codec.CodecAdapter</code></a> ，实现 Code2 <strong>接口</strong>，Codec <strong>适配器</strong>，将 Codec 适配成 Codec2 。</p>
<p>🙂 代码比较简单，胖友自己查看。</p>
<h1 id="666-彩蛋"><a href="#666-彩蛋" class="headerlink" title="666. 彩蛋"></a>666. 彩蛋</h1><p><img src="http://www.iocoder.cn/images/Architecture/2017_12_29/01.png" alt="知识星球"></p>
<p>代码比较多，如果不熟悉 Netty 等框架的胖友，可能会一脸懵逼的看到文末。建议胖友结合如下的代码：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Netty.java</span></span><br><span class="line"><span class="keyword">new</span> ChannelInitializer&lt;NioSocketChannel&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(NioSocketChannel ch)</span> </span>&#123;</span><br><span class="line">        NettyCodecAdapter adapter = <span class="keyword">new</span> NettyCodecAdapter(getCodec(), getUrl(), NettyServer.<span class="keyword">this</span>);</span><br><span class="line">        ch.pipeline().addLast(<span class="string">"decoder"</span>, adapter.getDecoder()) <span class="comment">// 解码</span></span><br><span class="line">                    .addLast(<span class="string">"encoder"</span>, adapter.getEncoder())  <span class="comment">// 解码</span></span><br><span class="line">                    .addLast(<span class="string">"handler"</span>, nettyServerHandler); <span class="comment">// 处理器</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在脑补 Debug + IDE Debug ，多考虑下。</p>
<p>推荐阅读：</p>
<ul>
<li><a href="http://manzhizhen.iteye.com/blog/2380055" target="_blank" rel="external">《Dubbo源代码实现六：线程池模型与提供者》</a></li>
<li><a href="http://manzhizhen.iteye.com/blog/2391177" target="_blank" rel="external">《Dubbo源代码分析八：再说Provider线程池被EXHAUSTED》</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/09/11/Web协议详解与抓包实战/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/11/Web协议详解与抓包实战/" itemprop="url">Web协议详解与抓包实战</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-11T08:29:23+08:00">
                2019-09-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/运维/" itemprop="url" rel="index">
                    <span itemprop="name">运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/09/11/Web协议详解与抓包实战/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/09/11/Web协议详解与抓包实战/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  260
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><p>参考</p>
<ul>
<li><blockquote>
<p><a href="https://github.com/Frankenjoy123/geektime-webprotocol" target="_blank" rel="external">https://github.com/Frankenjoy123/geektime-webprotocol</a> 极客时间《Web协议详解与抓包实战》课程</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h1 id="HTTP-1-1协议"><a href="#HTTP-1-1协议" class="headerlink" title="HTTP/1.1协议"></a>HTTP/1.1协议</h1><h2 id="ABNF范式"><a href="#ABNF范式" class="headerlink" title="ABNF范式"></a>ABNF范式</h2><ul>
<li>空白字符：用来分隔定义中的各个元素<ul>
<li>method SP request-target SP HTTP-version CRLF</li>
</ul>
</li>
<li>选择 /：表示多个规则都是可供选择的规则<ul>
<li>start-line = request-line / status-line</li>
</ul>
</li>
<li>值范围 %c##-## ：<ul>
<li>OCTAL = “0” / “1” / “2” / “3” / “4” / “5” / “6” / “7” 与 OCTAL = %x30-37 等价</li>
</ul>
</li>
<li>序列组合 ()：将规则组合起来，视为单个元素</li>
<li>不定量重复 m*n：<ul>
<li><code>*</code> 元素表示零个或更多元素：<code>*( header-field CRLF )</code></li>
<li><code>1*</code>元素表示一个或更多元素，<code>2*4</code> 元素表示两个至四个元素</li>
</ul>
</li>
<li>可选序列 []：<ul>
<li>[ message-body ]</li>
</ul>
</li>
</ul>
<h2 id="短连接与长连接"><a href="#短连接与长连接" class="headerlink" title="短连接与长连接"></a>短连接与长连接</h2><ul>
<li>Connection 头部<ul>
<li>Keep-Alive：长连接</li>
<li>客户端请求长连接<ul>
<li>Connection: Keep-Alive</li>
</ul>
</li>
<li>服务器表示支持长连接<ul>
<li>Connection: Keep-Alive<br>• 客户端复用连接</li>
</ul>
</li>
<li>HTTP/1.1 默认支持长连接<ul>
<li>Connection: Keep-Alive 无意义</li>
</ul>
</li>
<li>Close：短连接</li>
<li>对代理服务器的要求<ul>
<li>不转发 Connection 列出头部，该头部仅与当前连接相关</li>
</ul>
</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/08/23/Dubbo源码分析——NIO-服务器（一）之抽象API/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/23/Dubbo源码分析——NIO-服务器（一）之抽象API/" itemprop="url">Dubbo源码分析——NIO-服务器（一）之抽象API</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-23T23:16:01+08:00">
                2019-08-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Dubbo/" itemprop="url" rel="index">
                    <span itemprop="name">Dubbo</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/08/23/Dubbo源码分析——NIO-服务器（一）之抽象API/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/08/23/Dubbo源码分析——NIO-服务器（一）之抽象API/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  11
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>从本小节开始，我们来分享 Dubbo <strong>自己</strong>实现的 NIO 服务器，使用在 <a href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/dubbo.html" target="_blank" rel="external"><code>dubbo://</code></a> 和 <a href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/thrift.html" target="_blank" rel="external"><code>thrift://</code></a> 协议上。</p>
<p>在 NIO 框架的选型上，强大的 Java 社区里有 mina、netty、grizzly 等，甚至 netty 提供了 3.x 和 4.x 的版本。那么该咋办呢？</p>
<p>Dubbo 开发团队的选择是：</p>
<ul>
<li>API 层：<ul>
<li><code>dubbo-remoting-api</code></li>
</ul>
</li>
<li>实现层：<ul>
<li><code>dubbo-remoting-netty3</code></li>
<li><code>dubbo-remoting-netty4</code></li>
<li><code>dubbo-remoting-mina</code></li>
<li><code>dubbo-remoting-grizzly</code></li>
<li><code>dubbo-remoting-p2p</code></li>
</ul>
</li>
</ul>
<p>再配合上 Dubbo SPI 的机制，使用者可以自定义使用哪一种具体的实现。</p>
<h1 id="2-一览"><a href="#2-一览" class="headerlink" title="2. 一览"></a>2. 一览</h1><p>还是老样子，笔者习惯性对代码量进行下统计，<code>dubbo-remoting</code> 的<strong>代码量</strong>如下图：</p>
<p><img src="/2019/08/23/Dubbo源码分析——NIO-服务器（一）之抽象API/01.png" alt=""></p>
<p><code>dubbo-remoting-api</code> 的代码量竟然近<strong>万行</strong>？</p>
<p>我们来首先看一张图：</p>
<blockquote>
<p>FROM <a href="http://dubbo.apache.org/zh-cn/docs/dev/design.html" target="_blank" rel="external">《Dubbo 开发指南 —— 框架设计》</a></p>
<p><img src="/2019/08/23/Dubbo源码分析——NIO-服务器（一）之抽象API/02.png" alt="整体设计"></p>
</blockquote>
<p><strong>红框部分</strong>，Protocol =&gt; Exchange =&gt; Transport =&gt; Serialize 的调用顺序。</p>
<blockquote>
<ul>
<li><strong>exchange</strong> 信息交换层：封装请求响应模式，同步转异步，以 Request, Response 为中心，扩展接口为 Exchanger, ExchangeChannel, ExchangeClient, ExchangeServer。</li>
<li><strong>transport</strong> 网络传输层：抽象 mina 和 netty 为统一接口，以 Message 为中心，扩展接口为 Channel, Transporter, Client, Server, Codec</li>
<li><strong>serialize</strong> 数据序列化层：可复用的一些工具，扩展接口为 Serialization, ObjectInput, ObjectOutput, ThreadPool</li>
</ul>
</blockquote>
<p>在笔者初看 <code>dubbo-remoting-api</code> 的代码时，对 <strong>exchange</strong> 和 <strong>transport</strong> 的理解是比较模糊的。简单来说，<strong>exchange</strong> 在 <strong>transport</strong> 之上，构造了 Request，Response 模型，<strong>一个请求对应一个响应</strong>。这样的方式，才符合我们实际业务开发的需要。当然，即使是 Request，Response 也分成<strong>同步和异步</strong>返回，重要的是，能够<strong>一一映射</strong>。</p>
<p>如果有兴趣，可以看看：</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Request%E2%80%93response" target="_blank" rel="external">《Request–response》</a></li>
<li><a href="https://en.wikipedia.org/wiki/Client%E2%80%93server_model" target="_blank" rel="external">《Client–server model》</a></li>
</ul>
<p>看完以上知识，我们在回过头看 <code>dubbo-remoting-api</code> 的项目结构就清晰了：</p>
<p><img src="/2019/08/23/Dubbo源码分析——NIO-服务器（一）之抽象API/03.png" alt="dubbo-remoting-api"></p>
<ul>
<li>最外层：通用接口。</li>
<li><code>buffer</code> 包：缓冲区。</li>
<li><code>exchange</code> 包：信息交换层</li>
<li><code>transporter</code> 包：网络传输层</li>
<li><code>telnet</code> 包：<a href="http://dubbo.apache.org/zh-cn/docs/dev/impls/telnet-handler.html" target="_blank" rel="external">Telnet 命令</a></li>
</ul>
<p>如上的每一层/包，我们都会独立一篇文章，进行分享。<br>当然，<code>dubbo-remoting-api</code> 模块，只负责 API 层抽象和部分实现，最终能够<strong>真正通信</strong>，需要 <code>dubbo-remoting-netty</code> 等等模块来实现。对应的每一个实现模块，我们也是独立一篇文章。</p>
<p>🙂 是不是很清晰，美滋滋？</p>
<h1 id="3-最外层：通用接口"><a href="#3-最外层：通用接口" class="headerlink" title="3. 最外层：通用接口"></a>3. 最外层：通用接口</h1><p>先看看 <a href="https://blog.csdn.net/u013252773/article/details/21046697?self" target="_blank" rel="external">《Netty4.0学习笔记系列之一：Server与Client的通讯》</a> <strong>教程文章</strong>。在该文章中，我们可以看到使用 Netty 在四个类：</p>
<blockquote>
<ul>
<li>1、HelloServer ：server类，启动Netty server</li>
<li>2、HelloServerInHandler：server的handler，接收客户端消息，并向客户端发送消息</li>
<li>3、HelloClient：client类，建立于Netty server的连接</li>
<li>4、HelloClientIntHandler：client的handler，接收server端的消息，并向服务端发送消息</li>
</ul>
</blockquote>
<p>恰好，和 <code>dubbo-remoting-api</code> 模块，定义的 Server、Client、ChannelHandler <strong>接口</strong>对应。我们以 <code>dubbo-remoting-netty4</code> 模块的，举例子。整理如下：</p>
<table>
<thead>
<tr>
<th>上文</th>
<th><code>dubbo-remoting-api</code></th>
<th><code>dubbo-remoting-netty4</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>HelloServer</td>
<td>Server 接口</td>
<td><a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyServer.java" target="_blank" rel="external">NettyServer</a> 实现类</td>
</tr>
<tr>
<td>HelloServerInHandler：server</td>
<td>ChannelHandler 接口</td>
<td><a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyServerHandler.java" target="_blank" rel="external">NettyServerHandler</a> 实现类</td>
</tr>
<tr>
<td>HelloClient</td>
<td>Client 接口</td>
<td><a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyClient.java" target="_blank" rel="external">NettyClient</a> 实现类</td>
</tr>
<tr>
<td>HelloServerInHandler</td>
<td>ChannelHandler 接口</td>
<td><a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyClientHandler.java" target="_blank" rel="external">NettyClientHandler</a> 实现类</td>
</tr>
</tbody>
</table>
<p>因为<strong>教程文章</strong>，以教程 Demo 为准，实际会有更多需要抽象的，例如：Codec 协议编解码，Dispatcher 消息等分发。再来看看 <code>dubbo://</code> 的处理流程：</p>
<blockquote>
<p>FROM <a href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/dubbo.html" target="_blank" rel="external">《Dubbo 用户指南 —— dubbo://》</a><br><img src="/2019/08/23/Dubbo源码分析——NIO-服务器（一）之抽象API/04.png" alt="dubbo:// "></p>
<ul>
<li>Transporter: mina, netty, grizzy</li>
<li>Serialization: dubbo, hessian2, java, json</li>
<li>Dispatcher: all, direct, message, execution, connection</li>
<li>ThreadPool: fixed, cached</li>
</ul>
</blockquote>
<p>如果这个图读不懂，没关系，下面我们来看看每个接口。后面，可以回过头来理解这个图。</p>
<p><strong>本文涉及的类图如下</strong>：</p>
<p><img src="/2019/08/23/Dubbo源码分析——NIO-服务器（一）之抽象API/05.png" alt="类图"></p>
<h1 id="4-Endpoint"><a href="#4-Endpoint" class="headerlink" title="4. Endpoint"></a>4. Endpoint</h1><p><code>com.alibaba.dubbo.remoting.Endpoint</code> ，<strong>端点</strong>接口。方法如下：</p>
<ul>
<li><p>属性相关</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">URL getUrl()<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">InetSocketAddress getLocalAddress()<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">ChannelHandler getChannelHandler()<span class="comment">;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>发送消息</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(Object message)</span> <span class="keyword">throws</span> RemotingException</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(Object message, <span class="keyword">boolean</span> sent)</span> <span class="keyword">throws</span> RemotingException</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>关系相关</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">int</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startClose</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isClosed</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Endpoint ，从中文上解释来说是，“<strong>端点</strong>”。从字面上来看，不太容易理解。在 <code>dubbo-remoting-api</code> 中，一个 Client 或 Server ，都是一个 Endpoint 。不同系统的，Endpoint 代表的会略有差距，例如 SpringMVC 中，一个请求 Restful URL 也可以是一个 Endpoint ，可以 Google 查询，理解更多。</p>
<h2 id="4-1-Channel"><a href="#4-1-Channel" class="headerlink" title="4.1 Channel"></a>4.1 Channel</h2><p><code>com.alibaba.dubbo.remoting.Channel</code> ，继承 Endpoint 接口，<strong>通道</strong>接口。方法如下：</p>
<ul>
<li><p>连接相关</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">InetSocketAddress <span class="title">getRemoteAddress</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isConnected</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>属性相关</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">boolean</span> hasAttribute(<span class="keyword">String</span> <span class="built_in">key</span>);</span><br><span class="line"><span class="keyword">Object</span> getAttribute(<span class="keyword">String</span> <span class="built_in">key</span>);</span><br><span class="line"><span class="keyword">void</span> setAttribute(<span class="keyword">String</span> <span class="built_in">key</span>, <span class="keyword">Object</span> value);</span><br><span class="line"><span class="keyword">void</span> removeAttribute(<span class="keyword">String</span> <span class="built_in">key</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>和 Netty Channel 一致，<strong>通讯的载体</strong>。在后面的文章，我们会看到在 <code>dubbo-remoting-netty4</code> 项目中，<a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyChannel.java" target="_blank" rel="external">NettyChannel</a> 是 Dubbo Channel 的实现，内部有<strong>真正的</strong> Netty Channel 属性，用于<strong>通讯</strong>。</p>
<h2 id="4-2-Client"><a href="#4-2-Client" class="headerlink" title="4.2 Client"></a>4.2 Client</h2><p><code>com.alibaba.dubbo.remoting.Client</code> ，实现 Endpoint 和 Channel 和 Resetable 接口，<strong>客户端</strong>接口。方法如下：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重连</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reconnect</span><span class="params">()</span> <span class="keyword">throws</span> RemotingException</span>;</span><br></pre></td></tr></table></figure>
<h2 id="4-3-Server"><a href="#4-3-Server" class="headerlink" title="4.3 Server"></a>4.3 Server</h2><p><code>com.alibaba.dubbo.remoting.Server</code> ，继承 Endpoint 和 Resetable 接口，<strong>服务器</strong>接口。方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 是否绑定本地端口，提供服务。即，是否启动成功，可连接，接收消息等。</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isBound</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得连接上服务器的通道（客户端）们</span></span><br><span class="line"><span class="function">Collection&lt;Channel&gt; <span class="title">getChannels</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">Channel <span class="title">getChannel</span><span class="params">(InetSocketAddress remoteAddress)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="4-3-1-Resetable"><a href="#4-3-1-Resetable" class="headerlink" title="4.3.1 Resetable"></a>4.3.1 Resetable</h3><p><code>com.alibaba.dubbo.common.Resetable</code> ，<strong>可重置</strong>接口。方法如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void <span class="keyword">reset</span>(<span class="keyword">URL</span> <span class="keyword">url</span>);</span><br></pre></td></tr></table></figure>
<p>Server 实现 Resetable 接口，在实现 <code>#reset(url)</code> 方法，用于根据新传入的 <code>url</code> 属性，重置自己内部的一些属性，例如 <a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractServer.java#L80-L129" target="_blank" rel="external"><code>AbstractServer#reset(url)</code></a> 方法。</p>
<h1 id="5-ChannelHandler"><a href="#5-ChannelHandler" class="headerlink" title="5. ChannelHandler"></a>5. ChannelHandler</h1><p><code>com.alibaba.dubbo.remoting.ChannelHandler</code> ，<strong>通道处理器</strong>接口。方法如下：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">connected</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> RemotingException</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disconnected</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> RemotingException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sent</span><span class="params">(Channel channel, Object message)</span> <span class="keyword">throws</span> RemotingException</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">received</span><span class="params">(Channel channel, Object message)</span> <span class="keyword">throws</span> RemotingException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">caught</span><span class="params">(Channel channel, Throwable exception)</span> <span class="keyword">throws</span> RemotingException</span>;</span><br></pre></td></tr></table></figure>
<p>和 Netty ChannelHandler 一致，<strong>负责 Channel 中的逻辑处理</strong>。在后面的文章，我们会看到在 <code>dubbo-remoting-netty4</code> 项目中，<a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyServerHandler.java" target="_blank" rel="external">NettyServerHandler</a> 是 Netty ChannelHandler 的实现，内部调用 Netty ChannelHandler 的方法，进行逻辑处理。</p>
<h1 id="6-Transporter"><a href="#6-Transporter" class="headerlink" title="6. Transporter"></a>6. Transporter</h1><p><code>com.alibaba.dubbo.remoting.Transporter</code> ，<strong>网络传输</strong>接口。方法如下：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SPI</span>(<span class="string">"netty"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transporter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bind a server.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 绑定一个服务器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url     server url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler 通道处理器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> server 服务器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RemotingException 当绑定发生异常时</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> com.alibaba.dubbo.remoting.Transporters#bind(URL, Receiver, ChannelHandler)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Adaptive</span>(&#123;Constants.SERVER_KEY, Constants.TRANSPORTER_KEY&#125;)</span><br><span class="line">    <span class="function">Server <span class="title">bind</span><span class="params">(URL url, ChannelHandler <span class="keyword">handler</span>)</span> <span class="keyword">throws</span> RemotingException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Connect to a server.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 连接一个服务器，即创建一个客户端</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url     server url 服务器地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler 通道处理器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> client 客户端</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RemotingException 当连接发生异常时</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> com.alibaba.dubbo.remoting.Transporters#connect(URL, Receiver, ChannelListener)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Adaptive</span>(&#123;Constants.CLIENT_KEY, Constants.TRANSPORTER_KEY&#125;)</span><br><span class="line">    <span class="function">Client <span class="title">connect</span><span class="params">(URL url, ChannelHandler <span class="keyword">handler</span>)</span> <span class="keyword">throws</span> RemotingException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>@SPI(&quot;netty&quot;)</code> 注解，Dubbo SPI <strong>拓展点</strong>，默认为 <code>&quot;netty&quot;</code> 。注意，此处的 <code>netty</code> 对应的是 netty3 ，因为 Dubbo 项目在开发时，netty4 并未发布。配置方式见 <a href="http://dubbo.apache.org/zh-cn/docs/user/demos/netty4.html" target="_blank" rel="external">《Dubbo 用户指南 —— Netty4》</a> 文档。</li>
<li><code>@Adaptive({Constants.SERVER_KEY, Constants.TRANSPORTER_KEY})</code> 注解，基于 Dubbo SPI Adaptive 机制，加载对应的 Server 实现，使用 <code>URL.server</code> 或 <code>URL.transporter</code> 属性。</li>
<li><code>@Adaptive({Constants.CLIENT_KEY, Constants.TRANSPORTER_KEY})</code> 注解，基于 Dubbo SPI Adaptive 机制，加载对应的 Client 实现，使用 <code>URL.client</code> 或 <code>URL.transporter</code> 属性。</li>
</ul>
<h2 id="6-1-Transporters"><a href="#6-1-Transporters" class="headerlink" title="6.1 Transporters"></a>6.1 Transporters</h2><p><a href="https://github.com/YunaiV/dubbo/blob/7fad710c2dbf66356d5e7b7995e843b8f6225652/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/Transporters.java" target="_blank" rel="external"><code>com.alibaba.dubbo.remoting.Transporters</code></a> ，Transporter 门面类。</p>
<blockquote>
<p>友情提示：Facade 设计模式，参见 <a href="https://blog.csdn.net/hguisu/article/details/7533759" target="_blank" rel="external">《 设计模式（九）外观模式Facade（结构型）》</a> 文章。</p>
</blockquote>
<p><code>#bind(String url, ChannelHandler... handler)</code> <strong>静态</strong>方法，绑定一个服务器。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Server <span class="title">bind</span><span class="params">(String url, ChannelHandler... handler)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">return</span> bind(URL.valueOf(url), handler);</span><br><span class="line"> <span class="number">3</span>: &#125;</span><br><span class="line"> <span class="number">4</span>: </span><br><span class="line"> <span class="number">5</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Server <span class="title">bind</span><span class="params">(URL url, ChannelHandler... handlers)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (url == <span class="keyword">null</span>) &#123;</span><br><span class="line"> <span class="number">7</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"url == null"</span>);</span><br><span class="line"> <span class="number">8</span>:     &#125;</span><br><span class="line"> <span class="number">9</span>:     <span class="keyword">if</span> (handlers == <span class="keyword">null</span> || handlers.length == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">10</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"handlers == null"</span>);</span><br><span class="line"><span class="number">11</span>:     &#125;</span><br><span class="line"><span class="number">12</span>:     <span class="comment">// 创建 handler</span></span><br><span class="line"><span class="number">13</span>:     ChannelHandler handler;</span><br><span class="line"><span class="number">14</span>:     <span class="keyword">if</span> (handlers.length == <span class="number">1</span>) &#123;</span><br><span class="line"><span class="number">15</span>:         handler = handlers[<span class="number">0</span>];</span><br><span class="line"><span class="number">16</span>:     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">17</span>:         handler = <span class="keyword">new</span> ChannelHandlerDispatcher(handlers);</span><br><span class="line"><span class="number">18</span>:     &#125;</span><br><span class="line"><span class="number">19</span>:     <span class="comment">// 创建 Server 对象</span></span><br><span class="line"><span class="number">20</span>:     <span class="keyword">return</span> getTransporter().bind(url, handler);</span><br><span class="line"><span class="number">21</span>: &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>和 <code>Transporter#bind(url, handler)</code> 方法，对应。</p>
</li>
<li><p>第 12 至 18 行：创建 <code>handler</code> 。若 <code>handlers</code> 是多个，使用 <a href="https://github.com/YunaiV/dubbo/blob/7fad710c2dbf66356d5e7b7995e843b8f6225652/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/ChannelHandlerDispatcher.java" target="_blank" rel="external">ChannelHandlerDispatcher</a> 进行封装。在 ChannelHandlerDispatcher 中，会循环调用 <code>handlers</code> ，对应的方法。</p>
</li>
<li><p>第 20 行：调用 <code>#getTransporter()</code> 方法，基于 Dubbo SPI 机制，获得 Transporter$Adaptive 对象。代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Transporter <span class="title">getTransporter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ExtensionLoader.getExtensionLoader(Transporter.class).getAdaptiveExtension();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第 20 行：调用 <code>Transporter#bind(url, handler)</code> 方法，在 Transporter$Adaptive 对象中，会根据 <code>url</code> 参数，获得对应的 <strong>Transporter 实现对象</strong>（例如， <a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyTransporter.java" target="_blank" rel="external">NettyTransporter</a>），从而创建对应的 Server 对象（例如， <a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyServer.java" target="_blank" rel="external">NettyServer</a>）。</p>
</li>
</ul>
<p>另外，还有一个 <a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/Transporters.java#L59-L76" target="_blank" rel="external"><code>#connect(url, handler)</code></a> <strong>静态</strong>方法，连接一个服务器，即创建一个客户端。🙂 和上面方法类似，自己看咯。</p>
<h1 id="7-Codec2"><a href="#7-Codec2" class="headerlink" title="7. Codec2"></a>7. Codec2</h1><p><code>com.alibaba.dubbo.remoting.Codec2</code> ，<strong>编解码器</strong>接口。代码如下：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 编码</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> channel 通道</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> buffer Buffer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message 消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException 当编码发生异常时</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Adaptive</span>(&#123;Constants.CODEC_KEY&#125;)</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">encode</span><span class="params">(Channel channel, ChannelBuffer buffer, Object message)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解码</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> channel 通道</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> buffer Buffer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException 当解码发生异常时</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Adaptive</span>(&#123;Constants.CODEC_KEY&#125;)</span><br><span class="line"><span class="function">Object <span class="title">decode</span><span class="params">(Channel channel, ChannelBuffer buffer)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>@SPI(&quot;netty&quot;)</code> 注解，Dubbo SPI <strong>拓展点</strong>。</li>
<li><code>@Adaptive({Constants.CODEC_KEY})</code> 注解，基于 Dubbo SPI Adaptive 机制，加载对应的 Codec2 实现，使用 <code>URL.codec</code> 属性。</li>
</ul>
<p>另外，解码过程中，需要解决 TCP 拆包、粘包的场景，因此解码结果如下：</p>
<figure class="highlight thrift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Codec2.java</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">DecodeResult</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 需要更多输入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    NEED_MORE_INPUT,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 忽略一些输入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SKIP_SOME_INPUT</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>目前 <code>SKIP_SOME_INPUT</code> ，暂未使用。</li>
<li>感兴趣的，可以提前看下 <a href="http://chen-tao.github.io/2015/10/03/nettytcp/" target="_blank" rel="external">《高性能网络框架Netty的TCP拆包、粘包解决方案》</a> 文章。在后续的文章中，我们既会看到基于<strong>长度</strong>的方案，也会看到基于<strong>界定符</strong>的方案。</li>
</ul>
<h2 id="7-1-Codec"><a href="#7-1-Codec" class="headerlink" title="7.1 Codec"></a>7.1 Codec</h2><p><a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/Codec.java" target="_blank" rel="external"><code>com.alibaba.dubbo.remoting.Codec</code> </a>，<strong>老的</strong>编解码器接口，被 Codec2 取代。</p>
<p>通过 <a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/codec/CodecAdapter.java" target="_blank" rel="external">CodecAdapter</a> ，将 Codec 适配成 Codec2 。</p>
<h2 id="7-2-Decodeable"><a href="#7-2-Decodeable" class="headerlink" title="7.2 Decodeable"></a>7.2 Decodeable</h2><p><code>com.alibaba.dubbo.remoting.Decodeable</code> ，<strong>可解码</strong>的接口。方法如下：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解码</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">decode</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure>
<h1 id="8-Dispatcher"><a href="#8-Dispatcher" class="headerlink" title="8. Dispatcher"></a>8. Dispatcher</h1><p><code>com.alibaba.dubbo.remoting.Dispatcher</code> ，<strong>调度器</strong>接口。方法如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SPI(AllDispatcher.NAME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Dispatcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Adaptive(&#123;Constants.DISPATCHER_KEY, <span class="meta-string">"dispather"</span>, <span class="meta-string">"channel.handler"</span>&#125;)</span></span><br><span class="line">    <span class="comment">// The last two parameters are reserved for compatibility with the old configuration</span></span><br><span class="line">    ChannelHandler dispatch(ChannelHandler handler, URL url);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>@SPI(AllDispatcher.NAME)</code> 注解，Dubbo SPI <strong>拓展点</strong>，默认为 <code>&quot;all&quot;</code> 。</li>
<li><code>@Adaptive({Constants.DISPATCHER_KEY, &quot;dispather&quot;, &quot;channel.handler&quot;})</code> 注解，基于 Dubbo SPI Adaptive 机制，加载对应的 ChanelHander 实现，使用 <code>URL.dispatcher</code> 属性。</li>
<li>为什么传入的 <code>handler</code> 参数，创建返回的还是 ChannelHandler 对象呢？感兴趣的，可以提前看下 <a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/dispatcher/all/AllChannelHandler.java" target="_blank" rel="external">AllChannelHandler</a> 和 <a href="http://dubbo.apache.org/zh-cn/docs/user/demos/thread-model.html" target="_blank" rel="external">《Dubbo 用户指南 —— 线程模型》</a> 。🙂 文章，后面见。</li>
</ul>
<h1 id="9-RemotingException"><a href="#9-RemotingException" class="headerlink" title="9. RemotingException"></a>9. RemotingException</h1><p><code>com.alibaba.dubbo.remoting.RemotingException</code> ，实现 Exception 类，<code>dubbo-remoting-api</code> 的<strong>基础</strong>异常。代码如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">RemotingException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 本地地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">InetSocketAddress</span> localAddress;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 远程地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">InetSocketAddress</span> remoteAddress;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="9-1-ExecutionException"><a href="#9-1-ExecutionException" class="headerlink" title="9.1 ExecutionException"></a>9.1 ExecutionException</h2><p><code>com.alibaba.dubbo.remoting.ExecutionException</code> ，实现 RemotingException 类，执行异常。代码如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ExecutionException</span> <span class="keyword">extends</span> <span class="title">RemotingException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> request;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 省略方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="9-2-TimeoutException"><a href="#9-2-TimeoutException" class="headerlink" title="9.2 TimeoutException"></a>9.2 TimeoutException</h2><p><code>com.alibaba.dubbo.remoting.TimeoutException</code> ，实现 RemotingException 类，超时异常。代码如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">TimeoutException</span> <span class="keyword">extends</span> <span class="title">RemotingException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public static <span class="keyword">final</span> int <span class="type">CLIENT_SIDE</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public static <span class="keyword">final</span> int <span class="type">SERVER_SIDE</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 阶段</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> int phase;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>dubbo-remoting-api</code> 模块，涉及到大量的封装，如果不太理解的，建议多多调试。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/08/02/Spark原理案例及搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/02/Spark原理案例及搭建/" itemprop="url">Spark原理案例及搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-02T09:58:44+08:00">
                2019-08-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/08/02/Spark原理案例及搭建/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/08/02/Spark原理案例及搭建/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.3k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  10
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文基于Spark 2.3.1    scala 2.11</p>
<h1 id="RDD算子"><a href="#RDD算子" class="headerlink" title="RDD算子"></a>RDD算子</h1><p>a <em>resilient distributed dataset</em> (RDD), which is a collection of elements partitioned across the nodes of the cluster that can be operated on in parallel</p>
<p><img src="/2019/08/02/Spark原理案例及搭建/01.jpg" alt=""></p>
<h2 id="Transformation算子"><a href="#Transformation算子" class="headerlink" title="Transformation算子"></a>Transformation算子</h2><p><a href="http://spark.apache.org/docs/latest/rdd-programming-guide.html#transformations" target="_blank" rel="external">http://spark.apache.org/docs/latest/rdd-programming-guide.html#transformations</a></p>
<p>懒执行，返回值依然是RDD</p>
<ul>
<li>map</li>
<li>filter</li>
<li>flatMap</li>
<li>groupByKey</li>
<li>reduceByKey</li>
<li>mapValues</li>
<li>sort</li>
</ul>
<h2 id="Action算子"><a href="#Action算子" class="headerlink" title="Action算子"></a>Action算子</h2><p><a href="http://spark.apache.org/docs/latest/rdd-programming-guide.html#actions" target="_blank" rel="external">http://spark.apache.org/docs/latest/rdd-programming-guide.html#actions</a></p>
<p>触发真正执行，返回值不再是RDD</p>
<h3 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h3><p>不需要根据key分组，直接进行聚合，reduce双子没必要必须作用在KV格式的RDD上</p>
<h3 id="collect"><a href="#collect" class="headerlink" title="collect"></a>collect</h3><p>将RDD的元素收集回来，收集到一个集合中。<strong>慎用，一般在测试环境使用</strong></p>
<p><img src="/2019/08/02/Spark原理案例及搭建/02.jpg" alt=""></p>
<h3 id="count"><a href="#count" class="headerlink" title="count"></a>count</h3><h1 id="RDD持久化"><a href="#RDD持久化" class="headerlink" title="RDD持久化"></a>RDD持久化</h1><p><a href="http://spark.apache.org/docs/latest/rdd-programming-guide.html#rdd-persistence" target="_blank" rel="external">http://spark.apache.org/docs/latest/rdd-programming-guide.html#rdd-persistence</a></p>
<h3 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h3><ul>
<li>cache算子将数据保存到内存中</li>
<li><p>cache算子是懒加载算子，需要Action算子触发执行</p>
</li>
<li><p>cache 是 persist简化版</p>
</li>
</ul>
<p><code>StorageLevel</code> 半生对象</p>
<p>deseriliezd 不序列化的意思，</p>
<p>序列化，占用空间小</p>
<h3 id="persist"><a href="#persist" class="headerlink" title="persist"></a>persist</h3><h4 id="StorageLevel"><a href="#StorageLevel" class="headerlink" title="StorageLevel"></a>StorageLevel</h4><p>优先级</p>
<ul>
<li>MEMORY_ONLY   只放内存，不够放弃。释放：1.自动ttl，2.手动释放内存 unpersist。</li>
<li>MEMORY_ONLY_SER</li>
<li>MEMORY_AND_DISK_SER  内存放不了，再放磁盘</li>
<li>DISK_ONLY 不建议使用</li>
</ul>
<p>一个action算子，就是一个Job</p>
<h1 id="standlone部署"><a href="#standlone部署" class="headerlink" title="standlone部署"></a>standlone部署</h1><h2 id="spark-env-sh-修改"><a href="#spark-env-sh-修改" class="headerlink" title="spark-env.sh 修改"></a>spark-env.sh 修改</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># masterIP</span></span><br><span class="line"><span class="attr">SPARK_MASTER_HOST</span>=node01</span><br><span class="line"><span class="comment"># master通信端口</span></span><br><span class="line"><span class="attr">SPARK_MASTER_PORT</span>=<span class="number">7077</span></span><br><span class="line"><span class="comment"># 心跳超时时间</span></span><br><span class="line"><span class="attr">SPARK_MASTER_OPTS</span>=<span class="string">"-Dspark.worker.timeout=100"</span></span><br><span class="line"><span class="comment"># webUI端口</span></span><br><span class="line"><span class="attr">SPARK_MASTER_WEBUI_PORT</span>=<span class="number">8888</span></span><br><span class="line"><span class="comment"># 日志存放位置</span></span><br><span class="line"><span class="attr">SPARK_LOCAL_DIRS</span>=<span class="string">"/var/zfg/spark"</span></span><br><span class="line"><span class="comment"># worker进程所管理的核心数</span></span><br><span class="line"><span class="attr">SPARK_WORKER_CORES</span>=<span class="number">2</span></span><br><span class="line"><span class="comment"># worker进程所管理的内存数</span></span><br><span class="line"><span class="attr">SPARK_WORKER_MEMORY</span>=<span class="number">3</span>G</span><br><span class="line"><span class="comment"># 计算工作区</span></span><br><span class="line"><span class="attr">SPARK_WORKER_DIR</span>=<span class="string">"/var/zfg/spark/work"</span></span><br><span class="line"><span class="comment"># 工作区文件的有效期</span></span><br><span class="line"><span class="attr">SPARK_WORKER_OPTS</span>=<span class="string">"-Dspark.worker.cleanup.enabled=true -Dspark.worker.cleanup.appDataTtl=259200"</span></span><br></pre></td></tr></table></figure>
<h2 id="slave修改"><a href="#slave修改" class="headerlink" title="slave修改"></a>slave修改</h2><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">node02</span></span><br><span class="line"><span class="symbol">node03</span></span><br><span class="line"><span class="symbol">node04</span></span><br></pre></td></tr></table></figure>
<p>sbin的目录下的spark-config.sh 文件下添加</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">JAVA_HOME</span>=/usr/install/jdk/jdk1.8.0_171</span><br></pre></td></tr></table></figure>
<h2 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h2><p>配置环境变量，sbin bin添加到path</p>
<p>start-all.sh  改名start-spark.sh</p>
<h2 id="scp到node02-node03-node04"><a href="#scp到node02-node03-node04" class="headerlink" title="scp到node02 node03 node04"></a>scp到node02 node03 node04</h2><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>启动 start-spark.sh</p>
<p>访问 <a href="http://node01:8888" target="_blank" rel="external">http://node01:8888</a></p>
<h2 id="动态添加worker"><a href="#动态添加worker" class="headerlink" title="动态添加worker"></a>动态添加worker</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./sbin/<span class="keyword">start</span>-slave.sh &lt;<span class="keyword">master</span>-spark-<span class="keyword">URL</span>&gt;</span><br></pre></td></tr></table></figure>
<h1 id="spark-shell"><a href="#spark-shell" class="headerlink" title="spark shell"></a>spark shell</h1><p>集群方式</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/spark-shell --<span class="keyword">master</span> <span class="title">spark</span>://IP:PORT</span><br></pre></td></tr></table></figure>
<p>本地方式</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/spark-<span class="keyword">shell</span><span class="bash"></span></span><br></pre></td></tr></table></figure>
<h2 id="REPL"><a href="#REPL" class="headerlink" title="REPL"></a>REPL</h2><p>读、执行、打印、循环</p>
<h1 id="standalone-HA部署"><a href="#standalone-HA部署" class="headerlink" title="standalone HA部署"></a>standalone HA部署</h1><p><a href="http://spark.apache.org/docs/latest/spark-standalone.html#high-availability" target="_blank" rel="external">Spark Standalone Mode - Spark 2.4.3 Documentation</a></p>
<p><a href="http://spark.apache.org/docs/latest/configuration.html#deploy" target="_blank" rel="external">Configuration - Spark 2.4.3 Documentation</a></p>
<p><img src="/2019/08/02/Spark原理案例及搭建/03.jpg" alt=""></p>
<ul>
<li>处于active状态的master，会将收集的元信息放到zookeeper，包括worker个数，地址。</li>
<li>备用master监听zk，通知active挂了。备用master会从zk中读取元数据到内存，通知worker以后的主、心跳发送</li>
</ul>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>SPARK_DAEMON_JAVA_OPTS in spark-env by configuring <code>spark.deploy.recoveryMode</code> and related spark.deploy.zookeeper.* configurations.</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">SPARK_DAEMON_JAVA_OPTS</span>=<span class="string">"-Dspark.deploy.recoveryMode=ZOOKEEPER spark.deploy.zookeeper.url=node02:2181,node03:2181,node04:2181 -Dspark.deploy.zookeeper.dir=spark201908"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>将spark-env.sh 同步到其他节点</li>
<li>启动start-spark.sh，发现只有一个master</li>
<li>在node02中，修改<code>SPARK_MASTER_HOST=node02</code>，再 start-master启动</li>
</ul>
<p>备用 node02 start-master.sh<br>Master=node02</p>
<p>RECAVering 准备切换状态</p>
<h1 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h1><ul>
<li>Master(standalone)：资源管理的主节点(进程)</li>
<li>Cluster Manager：在集群上获取资源的外部服务(例如standalone,Mesos,Yarn )</li>
<li>Worker Node(standalone)：资源管理的从节点(进程) 或者说管理本机资源的进程</li>
<li><p>Application：基于Spark的⽤用户程序，包含了driver程序和运行在集群上的executor程序</p>
</li>
<li><p>Driver Program：用来连接工作进程（Worker）的程序</p>
</li>
<li><p>Executor：是在一个worker进程所管理的节点上为某Application启动的⼀一个进程，该进</p>
</li>
</ul>
<p>程负责运行任务，并且负责将数据存在内存或者磁盘上。每个应⽤用都有各自独⽴立的</p>
<p>executors</p>
<ul>
<li><p>Task：被送到某个executor上的工作单元</p>
</li>
<li><p>Job：包含很多任务(Task)的并行计算，可以看做和action对Job：包含很多任务(Task)的并行计算，可以看做和action对v应</p>
</li>
<li><p>Stage：⼀个Job会被拆分很多组任务，每组任务被称为Stage(就像Mapreduce分map task</p>
</li>
</ul>
<p>和reduce task一样)</p>
<h1 id="宽依赖"><a href="#宽依赖" class="headerlink" title="宽依赖"></a>宽依赖</h1><p><img src="/2019/08/02/Spark原理案例及搭建/04.jpg" alt=""></p>
<ul>
<li><p>宽依赖：父RDD的分区：子RDD的分区，1对多</p>
</li>
<li><p>导致宽依赖的算子: groupByKey</p>
</li>
<li>宽依赖和shuffle是一一对应的</li>
</ul>
<h1 id="窄依赖"><a href="#窄依赖" class="headerlink" title="窄依赖"></a>窄依赖</h1><ul>
<li>map fitler</li>
<li>union 不会导致宽依赖</li>
<li>窄依赖一般不会发生shuffle</li>
</ul>
<h1 id="Stage切割规则"><a href="#Stage切割规则" class="headerlink" title="Stage切割规则"></a>Stage切割规则</h1><p><img src="/2019/08/02/Spark原理案例及搭建/05.jpg" alt=""></p>
<ul>
<li>按宽依赖进行划分，连着的窄依赖为一个stage</li>
<li>正是有了宽窄依赖，才能将job切分成一个个stage</li>
<li>一个stage的task个数（并发数），以最后一个RDD的分区数为准</li>
</ul>
<h1 id="pipeline操作"><a href="#pipeline操作" class="headerlink" title="pipeline操作"></a>pipeline操作</h1><p><img src="/2019/08/02/Spark原理案例及搭建/06.jpg" alt=""></p>
<ul>
<li>一个stage内（都是窄依赖）进行pipeline操作</li>
<li>计算向数据移动，C、D、F的计算都可以移动到C操作</li>
<li>为什么有懒执行算子，就是为了构建pipeline，增加并行度</li>
</ul>
<h2 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h2><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">val <span class="attr">RDD</span> = sc.textFile(hdfs)</span><br><span class="line">val <span class="attr">filterRDD</span> = RDD.filter(<span class="attr">x</span> =&gt; x.contains(<span class="string">"Ab"</span>))</span><br><span class="line">val <span class="attr">mapRDD</span> = filterRDD.<span class="built_in">map</span>(<span class="attr">x</span> =&gt; x+<span class="string">"~"</span>)</span><br><span class="line">val <span class="attr">flatMapRDD</span> = mapRDD.flatMap(<span class="attr">x</span> =&gt; x.split(<span class="string">" "</span>))</span><br><span class="line">flatMapRDD.collect</span><br></pre></td></tr></table></figure>
<p><img src="/2019/08/02/Spark原理案例及搭建/07.jpg" alt=""></p>
<ul>
<li>task1最好在B1执行</li>
<li>task2最好在B2执行</li>
</ul>
<h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><p>管道中的数据什么时候持久化到磁盘</p>
<ol>
<li>shuttle 的write的阶段（stage和stage之间，shuttfle write 和 shuttfle read）</li>
<li>对一个RDD执行了持久化算子(persist)</li>
</ol>
<h1 id="任务调度"><a href="#任务调度" class="headerlink" title="任务调度"></a>任务调度</h1><p><img src="/2019/08/02/Spark原理案例及搭建/09.png" alt=""></p>
<h2 id="任务重试"><a href="#任务重试" class="headerlink" title="任务重试"></a>任务重试</h2><ul>
<li>默认值重试3次 ， 加上1次，一共4次。重试次数为4-1=3</li>
</ul>
<p><a href="http://spark.apache.org/docs/latest/configuration.html#scheduling" target="_blank" rel="external">http://spark.apache.org/docs/latest/configuration.html#scheduling</a></p>
<table>
<thead>
<tr>
<th>spark.task.maxFailures</th>
<th>4</th>
<th>Number of failures of any particular task before giving up on the job. The total number of failures spread across different tasks will not cause the job to fail; a particular task has to fail this number of attempts. Should be greater than or equal to 1. Number of allowed retries = this value - 1.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>1.代码配置</p>
<p>2.spark-default.xml配置文件</p>
<p>3.提交Application的时候，<strong>常用</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-submit --conf spark<span class="selector-class">.task</span><span class="selector-class">.maxFailures</span>=<span class="number">10</span></span><br></pre></td></tr></table></figure>
<h3 id="挣扎的任务"><a href="#挣扎的任务" class="headerlink" title="挣扎的任务"></a>挣扎的任务</h3><p>TaskScheduler负责任务的重试，和挣扎的任务(推测执行)</p>
<ul>
<li>推测过程</li>
</ul>
<p>75%的任务都执行完成后，会每隔100ms来鉴定一次剩余的task是否是挣扎的task。鉴定过程：25task的执行时间，按照执行时间来排序，取中位数10s，10s*1.5倍数=15s。25task中大于这个15s的任务就是挣扎的任务。</p>
<table>
<thead>
<tr>
<th><code>spark.speculation</code></th>
<th>false</th>
<th>If set to “true”, performs speculative execution of tasks. This means if one or more tasks are running slowly in a stage, they will be re-launched.</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>spark.speculation.interval</code></td>
<td>100ms</td>
<td>How often Spark will check for tasks to speculate.</td>
</tr>
<tr>
<td><code>spark.speculation.multiplier</code></td>
<td>1.5</td>
<td>How many times slower a task is than the median to be considered for speculation.</td>
</tr>
<tr>
<td><code>spark.speculation.quantile</code></td>
<td>0.75</td>
<td>Fraction of tasks which must be complete before speculation is enabled for a particular stage.</td>
</tr>
</tbody>
</table>
<h2 id="stage重试"><a href="#stage重试" class="headerlink" title="stage重试"></a>stage重试</h2><p>DAGScheduler负责重试stage，默认重试次数为4</p>
<table>
<thead>
<tr>
<th><code>spark.stage.maxConsecutiveAttempts</code></th>
<th>4</th>
<th>Number of consecutive stage attempts allowed before a stage is aborted.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="单机执行3h，Spark并行执行却要12h？？"><a href="#单机执行3h，Spark并行执行却要12h？？" class="headerlink" title="单机执行3h，Spark并行执行却要12h？？"></a>单机执行3h，Spark并行执行却要12h？？</h2><ul>
<li>可能发生数据倾斜，99task 100M，1task 1T-100M</li>
<li>可能开启了推测执行，那么很有可能1task为挣扎的task，那么TaskScheduler会新起一个task和挣扎的task比赛执行</li>
</ul>
<p>解决方案：</p>
<ol>
<li>关闭推测执行</li>
<li>解决数据倾斜问题</li>
</ol>
<h1 id="资源调度"><a href="#资源调度" class="headerlink" title="资源调度"></a>资源调度</h1><p><img src="/2019/08/02/Spark原理案例及搭建/08.png" alt=""></p>
<p>DAGScheduler taskshceduler  存在于driver中</p>
<ul>
<li><p>为了防止master压力过大，都要增加client</p>
</li>
<li><p>client spark-submit  通过执行Main函数，启动一个driver进程。创建sparkContext，同时创建两个对象，DAGScheduler,TaskScheduler。</p>
</li>
</ul>
<h2 id="资源调度过程"><a href="#资源调度过程" class="headerlink" title="资源调度过程"></a>资源调度过程</h2><ol>
<li><p>TaskScheduler创建成功后，会找master，给当前application申请资源。</p>
</li>
<li><p>master会查看自己的资源情况，告诉worker节点，启动一个executor进程。<strong>默认使用1G内存，所有核。</strong></p>
</li>
<li>excutor启动成功后，会反向注册给TaskScheduler</li>
<li><p>DAGScheduler，根据RDD的宽窄依赖切分stage，将一个个stage提交给taskSehduler</p>
</li>
<li><p>TaskScheduler，接收到stage之后，遍历拿到每个task，调用HDFS的方法，得到block位置。将task分发到数据节点执行。</p>
</li>
</ol>
<h3 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h3><ul>
<li><strong>完全一致部署，也不能避免数据移动。也有可能从其他节点拉取数据，在节点计算。</strong></li>
<li><strong>启动Exetor或者申请资源，不会考虑数据的位置。</strong></li>
</ul>
<p>对比</p>
<table>
<thead>
<tr>
<th></th>
<th>Spark</th>
<th>MR on YARN</th>
</tr>
</thead>
<tbody>
<tr>
<td>类型</td>
<td>粗粒度的资源调度</td>
<td>细粒度的资源调度</td>
</tr>
<tr>
<td>过程</td>
<td>在提交Application的时候，taskScheduler先去申请资源。然后taskScheduler分发任务，执行所有task执行完毕，才释放这部分资源。</td>
<td>在提交Applicaiton的时候，先向数据节点分发task，task自己去申请资源。如果申请到了资源，立即执行。否则一直等待。当task执行完毕，立即释放资源。</td>
</tr>
<tr>
<td>优点</td>
<td>1. 每一个task的等待时间变短了 2.可以资源复用</td>
<td>集群资源能充分利用</td>
</tr>
<tr>
<td>缺点</td>
<td>10000task  9999task 1task没执行完，无法充分利用集群资源</td>
<td>task的等待时间太长</td>
</tr>
</tbody>
</table>
<h2 id="源码解读"><a href="#源码解读" class="headerlink" title="源码解读"></a>源码解读</h2><p><img src="/2019/08/02/Spark原理案例及搭建/10.png" alt=""></p>
<ul>
<li>worker进程启动成功后，会向master注册，发送worker的管理的资源信息</li>
<li>当worker启动完毕后，会定期向master发送心跳，此时不会携带worker的资源信息，只会携带当前worker的id号。</li>
<li>默认情况下，每一个worker节点为当前的Application指定启动一个1executor，这个executor默认使用1G 所有的core</li>
</ul>
<ol>
<li>client指定driver不在本地执行，为Driver申请资源，1G 1core</li>
<li>master查询workers信息，随机指定worker2启动启动Driver进程。</li>
</ol>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-submit <span class="params">--class</span> org.apache.spark.examples.SparkPi <span class="params">--master</span> spark:<span class="string">//node01</span><span class="function">:7077</span> <span class="params">--deploy-mode</span> cluster <span class="params">--driver-memory</span> 1g <span class="params">--num-executors</span> 2 <span class="params">--executor-memory</span> 1g <span class="params">--executor-cores</span> 1 <span class="string">/opt/sxt/spark-2.3.1/examples/jars/spark-examples_2.11-2.3.1.jar</span></span><br></pre></td></tr></table></figure>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-submit <span class="params">--class</span> org.apache.spark.examples.SparkPi <span class="params">--master</span> spark:<span class="string">//node01</span><span class="function">:7077</span> <span class="params">--deploy-mode</span> cluster <span class="params">--total-executor-cores=6</span> <span class="params">--executor-memory</span> 1g <span class="params">--executor-cores</span> 1 <span class="string">/opt/sxt/spark-2.3.1/examples/jars/spark-examples_2.11-2.3.1.jar</span></span><br></pre></td></tr></table></figure>
<p>`</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark<span class="selector-class">.deploy</span><span class="selector-class">.spreadOut</span>=true</span><br></pre></td></tr></table></figure>
<ul>
<li><p>默认情况下（在提交Application的时候，没有指定–executor-cores），每一个worker节点为当前的Application只启动1个Executor，这个Executor使用所有的核</p>
</li>
<li><p>如果想要一个Worker节点上启动多个Executor，那么在提交Application的时候需要指定<code>--executor-cores</code>这个选项</p>
</li>
<li><p><code>spark.deploy.spreadOut</code>默认为true，表示轮询在workers启动executor</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-submit <span class="params">--class</span> org.apache.spark.examples.SparkPi <span class="params">--master</span> spark:<span class="string">//node01</span><span class="function">:7077</span> <span class="params">--deploy-mode</span> cluster <span class="params">--total-executor-cores=6</span> <span class="params">--executor-memory</span> 1g <span class="params">--executor-cores</span> 1 <span class="params">--spark</span>.<span class="keyword">deploy</span>.spreadOut <span class="literal">false</span> <span class="string">/opt/sxt/spark-2.3.1/examples/jars/spark-examples_2.11-2.3.1.jar</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>参考</p>
<blockquote>
<p><a href="https://spark.apache.org/docs/latest/spark-standalone.html" target="_blank" rel="external">https://spark.apache.org/docs/latest/spark-standalone.html</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/06/23/storm搭建及原理分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/23/storm搭建及原理分析/" itemprop="url">storm搭建及原理分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-23T11:44:50+08:00">
                2019-06-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/23/storm搭建及原理分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/06/23/storm搭建及原理分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  7
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><a href="http://storm.apache.org/" target="_blank" rel="external">http://storm.apache.org/</a></p>
</blockquote>
<h2 id="编程模型"><a href="#编程模型" class="headerlink" title="编程模型"></a>编程模型</h2><p><img src="/2019/06/23/storm搭建及原理分析/pic3.png" alt="pic1"></p>
<h3 id="DAG-（Topology）有向无环图"><a href="#DAG-（Topology）有向无环图" class="headerlink" title="DAG （Topology）有向无环图"></a>DAG （Topology）有向无环图</h3><h3 id="Spout-–-数据源"><a href="#Spout-–-数据源" class="headerlink" title="Spout – 数据源"></a>Spout – 数据源</h3><ul>
<li>nextTuple</li>
</ul>
<p>Spout中最核心的方法是nextTuple，该方法会被Storm线程不断调用、主动从数据源拉取数据，再通过emit方法将数据生成元组（Tuple）发送给之后的Bolt计算</p>
<ul>
<li>OutputFieldsDeclarer</li>
</ul>
<p>可先通过OutputFieldsDeclarer中的declare方法声明定义的不同数据流，发送数据时通过SpoutOutputCollector中的emit方法指定数据流Id（streamId）参数将数据发送出去</p>
<h3 id="Bolt-–-数据流处理组件"><a href="#Bolt-–-数据流处理组件" class="headerlink" title="Bolt – 数据流处理组件"></a>Bolt – 数据流处理组件</h3><p>Bolt：处理者，可以有多个。多个bolt可以并行执行。</p>
<p>一个Bolt可以发送多个数据流（Stream）</p>
<ul>
<li>OutputFieldsDeclarer</li>
</ul>
<p>可先通过OutputFieldsDeclarer中的declare方法声明定义的不同数据流，发送数据时通过SpoutOutputCollector中的emit方法指定数据流Id（streamId）参数将数据发送出去</p>
<ul>
<li>execute</li>
</ul>
<p>Bolt中最核心的方法是execute方法，该方法负责接收到一个元组（Tuple）数据、真正实现核心的业务逻辑</p>
<h3 id="Stream-Grouping-–-数据流分组（即数据分发策略）"><a href="#Stream-Grouping-–-数据流分组（即数据分发策略）" class="headerlink" title="Stream Grouping – 数据流分组（即数据分发策略）"></a>Stream Grouping – 数据流分组（即数据分发策略）</h3><h2 id="高可靠性"><a href="#高可靠性" class="headerlink" title="高可靠性"></a>高可靠性</h2><p>异常处理</p>
<p>消息可靠性保障机制(ACK)</p>
<h2 id="流式处理"><a href="#流式处理" class="headerlink" title="流式处理"></a>流式处理</h2><h3 id="异步方式"><a href="#异步方式" class="headerlink" title="异步方式"></a>异步方式</h3><ul>
<li>流式处理（异步 与 同步）</li>
</ul>
<p>客户端提交数据进行结算，并不会等待数据计算结果</p>
<ul>
<li>逐条处理</li>
</ul>
<p>例：ETL（数据清洗）extracted transform load</p>
<ul>
<li>统计分析</li>
</ul>
<p>例：计算PV、UV、访问热点 以及 某些数据的聚合、加和、平均等</p>
<p>​       客户端提交数据之后，计算完成结果存储到Redis、HBase、MySQL或者其他MQ当中，</p>
<p>​       客户端并不关心最终结果是多少。</p>
<p><img src="/2019/06/23/storm搭建及原理分析/pic1.png" alt="pic1"></p>
<h3 id="同步方式"><a href="#同步方式" class="headerlink" title="同步方式"></a>同步方式</h3><p>客户端提交数据请求之后，立刻取得计算结果并返回给客户端</p>
<p><img src="/2019/06/23/storm搭建及原理分析/pic2.png" alt="pic1"></p>
<p>客户端通过和DRPC server交互，立刻取得返回结果</p>
<h2 id="和MapReduce比较"><a href="#和MapReduce比较" class="headerlink" title="和MapReduce比较"></a>和MapReduce比较</h2><ul>
<li><p>Storm：进程、线程常驻内存运行，数据不进入磁盘，数据通过网络传递。</p>
</li>
<li><p>MapReduce：为TB、PB级别数据设计的批处理计算框架。</p>
</li>
</ul>
<h2 id="和Spark-Streaming比较"><a href="#和Spark-Streaming比较" class="headerlink" title="和Spark Streaming比较"></a>和Spark Streaming比较</h2><ul>
<li>Storm：纯流式处理，毫秒级</li>
</ul>
<p>专门为流式处理设计</p>
<p>数据传输模式更为简单，很多地方也更为高效</p>
<p>并不是不能做批处理，它也可以来做微批处理，来提高吞吐</p>
<ul>
<li>Spark Streaming：微批处理，秒级</li>
</ul>
<p>将RDD做的很小来用小的批处理来接近流式处理</p>
<p>基于内存和DAG可以把处理任务做的很快</p>
<h2 id="数据累加demo"><a href="#数据累加demo" class="headerlink" title="数据累加demo"></a>数据累加demo</h2><p>代码参考<code>eclipse-hadoop-workspace/ws</code></p>
<h2 id="集群安装"><a href="#集群安装" class="headerlink" title="集群安装"></a>集群安装</h2><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">python -V</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th></th>
<th>nimbus</th>
<th>supervisor</th>
<th>zookeeper</th>
</tr>
</thead>
<tbody>
<tr>
<td>node01</td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td>node02</td>
<td></td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td>node03</td>
<td></td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td>node04</td>
<td></td>
<td></td>
<td>*</td>
</tr>
</tbody>
</table>
<p>scp安装包到node01 <code>apache-storm-0.10.0.tar.gz</code></p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ vim conf/storm.yaml</span><br><span class="line">storm.zookeeper.servers:</span><br><span class="line">  -<span class="ruby"> <span class="string">"node02"</span></span></span><br><span class="line"><span class="ruby">  - <span class="string">"node03"</span></span></span><br><span class="line"><span class="ruby">  - <span class="string">"node04"</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">storm.local.<span class="symbol">dir:</span> <span class="string">"/tmp/storm"</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">nimbus.<span class="symbol">host:</span> <span class="string">"node01"</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby"><span class="comment"># slot 代表一个进程</span></span></span><br><span class="line"><span class="ruby">supervisor.slots.<span class="symbol">ports:</span></span></span><br><span class="line"><span class="ruby">    - <span class="number">6700</span></span></span><br><span class="line"><span class="ruby">    - <span class="number">6701</span></span></span><br><span class="line"><span class="ruby">    - <span class="number">6702</span></span></span><br><span class="line"><span class="ruby">    - <span class="number">6703</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -r apache-storm-<span class="number">0</span>.<span class="number">10.0</span> root<span class="variable">@node02</span><span class="symbol">:`pwd`</span></span><br><span class="line">scp -r apache-storm-<span class="number">0</span>.<span class="number">10.0</span> root<span class="variable">@node03</span><span class="symbol">:`pwd`</span></span><br></pre></td></tr></table></figure>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">环境变量配置</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">STORM_HOME</span>=/opt/sxt/storm</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="variable">$PATH</span>:$STORM_HOME/bin</span><br></pre></td></tr></table></figure>
<p>在storm目录中创建logs目录<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> <span class="variable">$STORM_HOME</span></span><br><span class="line"><span class="keyword">mkdir</span> logs</span><br></pre></td></tr></table></figure></p>
<p>node01上启动Nimbus<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">storm nimbus &gt;&gt; ./logs/nimbus<span class="selector-class">.out</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line">tail -f logs/nimbus.log</span><br><span class="line">storm ui &gt;&gt; ./logs/ui<span class="selector-class">.out</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line">tail -f logs/ui.log</span><br></pre></td></tr></table></figure></p>
<p>节点node2和node3启动supervisor，按照配置，每启动一个supervisor就有了4个slots<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> <span class="variable">$STORM_HOME</span></span><br><span class="line"><span class="keyword">mkdir</span> logs</span><br><span class="line">storm supervisor &gt;&gt; ./logs/supervisor.<span class="keyword">out</span> 2&gt;&amp;1 &amp;</span><br><span class="line">tail -f logs/supervisor.<span class="built_in">log</span></span><br></pre></td></tr></table></figure></p>
<h3 id="帮助命令"><a href="#帮助命令" class="headerlink" title="帮助命令"></a>帮助命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">storm <span class="built_in">help</span></span><br><span class="line">storm <span class="built_in">help</span> jar</span><br></pre></td></tr></table></figure>
<h3 id="kill"><a href="#kill" class="headerlink" title="kill"></a>kill</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storm <span class="built_in">kill</span> <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<h3 id="web运维页面"><a href="#web运维页面" class="headerlink" title="web运维页面"></a>web运维页面</h3><blockquote>
<p><a href="http://node01:8080/" target="_blank" rel="external">http://node01:8080/</a></p>
</blockquote>
<h3 id="集群提交"><a href="#集群提交" class="headerlink" title="集群提交"></a>集群提交</h3><p>提交任务到Storm集群当中运行：代码参考(eclipse-hadoop-workspace/wordcount)</p>
<p>src打包，test为参数表示集群方式运行，作为topology名称</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storm jar wordcount<span class="selector-class">.jar</span> com<span class="selector-class">.sxt</span><span class="selector-class">.storm</span><span class="selector-class">.test</span><span class="selector-class">.Test</span> test</span><br></pre></td></tr></table></figure>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">if</span> (args.length&gt;<span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">try</span> &#123;</span><br><span class="line">		StormSubmitter.submitTopology(args[<span class="number">0</span>], <span class="built_in">config</span>, tb.createTopology());</span><br><span class="line">	&#125; <span class="built_in">catch</span> (AlreadyAliveException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125; <span class="built_in">catch</span> (InvalidTopologyException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="built_in">else</span> &#123;</span><br><span class="line"></span><br><span class="line">	LocalCluster lc = <span class="keyword">new</span> LocalCluster();</span><br><span class="line">	lc.submitTopology(<span class="string">"wordcount"</span>, <span class="built_in">config</span>, tb.createTopology());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>流程：</p>
<p>spout —&gt; bolt(切分单词)—&gt; bolt(计数)</p>
<h2 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h2><p><img src="/2019/06/23/storm搭建及原理分析/pic4.png" alt="pic4"></p>
<h3 id="Nimbus"><a href="#Nimbus" class="headerlink" title="Nimbus"></a>Nimbus</h3><ul>
<li><p>资源调度</p>
</li>
<li><p>任务分配</p>
</li>
<li><p>接收jar包</p>
</li>
</ul>
<h3 id="Supervisor"><a href="#Supervisor" class="headerlink" title="Supervisor"></a>Supervisor</h3><ul>
<li><p>接收nimbus分配的任务</p>
</li>
<li><p>启动、停止自己管理的worker进程（当前supervisor上worker数量由配置文件设定）</p>
</li>
</ul>
<h3 id="Worker"><a href="#Worker" class="headerlink" title="Worker"></a>Worker</h3><ul>
<li><p>运行具体处理运算组件的进程（每个Worker对应执行一个Topology的子集）</p>
</li>
<li><p>worker任务类型，即spout任务、bolt任务两种</p>
</li>
<li><p>启动executor</p>
</li>
</ul>
<p>​    （executor即worker JVM进程中的一个java线程，一般默认每个executor负责执行一个task任务）</p>
<h3 id="与hadoop-yarn对比"><a href="#与hadoop-yarn对比" class="headerlink" title="与hadoop yarn对比"></a>与hadoop yarn对比</h3><table>
<thead>
<tr>
<th></th>
<th>Hadoop</th>
<th>Storm</th>
</tr>
</thead>
<tbody>
<tr>
<td>主节点</td>
<td>ResourceManager</td>
<td>Nimbus</td>
</tr>
<tr>
<td>从节点</td>
<td>NodeManager</td>
<td>Supervisor</td>
</tr>
<tr>
<td>应用程序</td>
<td>Job</td>
<td>Topology</td>
</tr>
<tr>
<td>工作进程</td>
<td>Child</td>
<td>Worker</td>
</tr>
<tr>
<td>计算模型</td>
<td>Map/Reduce(split,map,shuffle,reduce)</td>
<td>Spout/Bolt</td>
</tr>
</tbody>
</table>
<h3 id="运行过程"><a href="#运行过程" class="headerlink" title="运行过程"></a>运行过程</h3><ul>
<li>提交jar包到nimbus/inbox目录下</li>
<li>对topology进行校验处理</li>
<li>nimbus/stormdist/${topology-id}下，包含jar包、stormcode序列化方法、stormconf运行配置</li>
<li>nimbus初始化spout/bolt的task，写到zookeeper的/tasks节点下</li>
<li>nimbus创建/taskbeats的zk节点，监控task心跳</li>
<li>将任务分配信息，写到zk assignment/${topology-id}节点中，此时认为任务提交完毕</li>
<li>在zk的storms/${topology-id}下存放任务的运行时间、状态信息</li>
</ul>
<p><img src="/2019/06/23/storm搭建及原理分析/pic5.png" alt="pic4"></p>
<h3 id="本地目录树"><a href="#本地目录树" class="headerlink" title="本地目录树"></a>本地目录树</h3><p><img src="/2019/06/23/storm搭建及原理分析/pic7.png" alt="pic4"></p>
<h3 id="zookeeper目录树"><a href="#zookeeper目录树" class="headerlink" title="zookeeper目录树"></a>zookeeper目录树</h3><p><img src="/2019/06/23/storm搭建及原理分析/pic8.png" alt="pic4"></p>
<h2 id="Storm-DRPC"><a href="#Storm-DRPC" class="headerlink" title="Storm DRPC"></a>Storm DRPC</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><ul>
<li>DRPC (Distributed RPC)  remote procedure call</li>
</ul>
<p>分布式远程过程调用</p>
<ul>
<li>DRPC 是通过一个 DRPC 服务端(DRPC server)来实现分布式 RPC 功能的。</li>
</ul>
<p>DRPC Server 负责接收 RPC 请求，并将该请求发送到 Storm中运行的 Topology，等待接收 Topology 发送的处理结果，并将该结果返回给发送请求的客户端。</p>
<p>（其实，从客户端的角度来说，DPRC 与普通的 RPC 调用并没有什么区别。）</p>
<ul>
<li>DRPC设计目的：</li>
</ul>
<p>为了充分利用Storm的计算能力实现高密度的并行实时计算。</p>
<p>（Storm接收若干个数据流输入，数据在Topology当中运行完成，然后通过DRPC将结果进行输出。）</p>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">vi</span> <span class="selector-tag">storm</span><span class="selector-class">.yaml</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">drpc<span class="selector-class">.servers</span>:</span><br><span class="line">    - <span class="string">"node01"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp storm.yaml root<span class="variable">@node02</span><span class="symbol">:`pwd`</span></span><br><span class="line">scp storm.yaml root<span class="variable">@node03</span><span class="symbol">:`pwd`</span></span><br></pre></td></tr></table></figure>
<p>node01执行</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nohup storm nimbus &gt;&gt; ./logs/nimbus<span class="selector-class">.out</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line">tail -f logs/nimbus.log</span><br><span class="line">nohup storm drpc &gt;&gt; ./logs/drpc<span class="selector-class">.out</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line">tail -f logs/drpc.log</span><br><span class="line">nohup storm ui &gt;&gt; ./logs/ui<span class="selector-class">.out</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line">tail -f logs/ui.log</span><br></pre></td></tr></table></figure>
<p>node02 node03执行</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> <span class="variable">$STORM_HOME</span></span><br><span class="line">nohup storm supervisor &gt;&gt; ./logs/supervisor.<span class="keyword">out</span> 2&gt;&amp;1 &amp;</span><br><span class="line">tail -f logs/supervisor.<span class="built_in">log</span></span><br></pre></td></tr></table></figure>
<p>代码参考eclipse-hadoop-workspace/StormDemo</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp drpc.jar root<span class="variable">@node01</span><span class="symbol">:/root/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storm jar drpc<span class="selector-class">.jar</span> com<span class="selector-class">.sxt</span><span class="selector-class">.storm</span><span class="selector-class">.drpc</span><span class="selector-class">.BasicDRPCTopology</span> test</span><br></pre></td></tr></table></figure>
<p>客户端执行结果</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDRPCclient</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(String[] args) &#123;</span><br><span class="line">		DRPCClient <span class="keyword">client</span> = <span class="keyword">new</span> DRPCClient(<span class="string">"node01"</span>, <span class="number">3772</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			String result = <span class="keyword">client</span>.execute(<span class="string">"exclamation"</span>, <span class="string">"11,22"</span>);</span><br><span class="line"></span><br><span class="line">			System.out.println(result);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (TException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (DRPCExecutionException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Storm-容错机制"><a href="#Storm-容错机制" class="headerlink" title="Storm 容错机制"></a>Storm 容错机制</h2><h3 id="集群节点宕机"><a href="#集群节点宕机" class="headerlink" title="集群节点宕机"></a>集群节点宕机</h3><ul>
<li>Nimbus服务器</li>
</ul>
<p>单点故障<strong>？</strong></p>
<ul>
<li>非Nimbus服务器</li>
</ul>
<p>故障时，该节点上所有Task任务都会超时，Nimbus会将这些Task任务重新分配到其他服务器上运行</p>
<h3 id="进程挂掉"><a href="#进程挂掉" class="headerlink" title="进程挂掉"></a>进程挂掉</h3><h4 id="Worker-1"><a href="#Worker-1" class="headerlink" title="Worker"></a>Worker</h4><p>挂掉时，Supervisor会重新启动这个进程。如果启动过程中仍然一直失败，并且无法向Nimbus发送心跳，Nimbus会将该Worker重新分配到其他服务器上</p>
<h4 id="Supervisor-1"><a href="#Supervisor-1" class="headerlink" title="Supervisor"></a>Supervisor</h4><p>无状态（所有的状态信息都存放在Zookeeper中来管理）</p>
<p>快速失败（每当遇到任何异常情况，都会自动毁灭）</p>
<h4 id="Nimbus-1"><a href="#Nimbus-1" class="headerlink" title="Nimbus"></a>Nimbus</h4><p>无状态（所有的状态信息都存放在Zookeeper中来管理）</p>
<p>快速失败（每当遇到任何异常情况，都会自动毁灭）</p>
<h3 id="消息的完整性"><a href="#消息的完整性" class="headerlink" title="消息的完整性"></a>消息的完整性</h3><ul>
<li><p>从Spout中发出的Tuple，以及基于他所产生Tuple（例如上个例子当中Spout发出的句子，以及句子当中单词的tuple等）</p>
</li>
<li><p>由这些消息就构成了一棵tuple树</p>
</li>
<li><p>当这棵tuple树发送完成，并且树当中每一条消息都被正确处理，就表明spout发送消息被“完整处理”，即消息的完整性</p>
</li>
</ul>
<p><img src="/2019/06/23/storm搭建及原理分析/pic9.png" alt="pic4"></p>
<h2 id="中国移动项目"><a href="#中国移动项目" class="headerlink" title="中国移动项目"></a>中国移动项目</h2><p>代码参考<code>cmccstormjk02</code>  和<code>cmcc02_hbase</code></p>
<h3 id="hbase"><a href="#hbase" class="headerlink" title="hbase"></a>hbase</h3><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">create</span> <span class="string">'cell_monitor_table'</span>,<span class="string">'cf'</span></span><br></pre></td></tr></table></figure>
<p><img src="/2019/06/23/storm搭建及原理分析/中国移动项目架构图.jpg" alt="pic4"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/06/21/hadoop日志分析实战项目搭建及分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/21/hadoop日志分析实战项目搭建及分析/" itemprop="url">hadoop日志分析实战项目搭建及分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-21T14:42:19+08:00">
                2019-06-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/21/hadoop日志分析实战项目搭建及分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/06/21/hadoop日志分析实战项目搭建及分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  7.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  39
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="整体项目流程"><a href="#整体项目流程" class="headerlink" title="整体项目流程"></a>整体项目流程</h1><ul>
<li>js或者java sdk访问nginx提供的接口，nginx写入访问日志文件</li>
<li>flume <code>tail -F</code>监控日志文件，存储日志到hdfs</li>
<li>通过Mapper Reducer 任务，清洗日志为标准的数据，存储到hbase</li>
<li>通过map reduce 任务，按不同的维度，统计数据，写入到mysql。或者使用hive建立外部表，关联hbase，通过spoop，转换hive数据到mysql。</li>
</ul>
<p><img src="/2019/06/21/hadoop日志分析实战项目搭建及分析/数据流图.jpg" alt="数据流图"></p>
<h1 id="tengine安装"><a href="#tengine安装" class="headerlink" title="tengine安装"></a>tengine安装</h1><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><blockquote>
<p><a href="http://tengine.taobao.org/document/install.html" target="_blank" rel="external">http://tengine.taobao.org/document/install.html</a></p>
<p><a href="http://tengine.taobao.org/nginx_docs/cn/docs/" target="_blank" rel="external">Nginx文档</a><br><a href="http://tengine.taobao.org/nginx_docs/cn/docs/http/ngx_http_log_module.html" target="_blank" rel="external">ngx_http_log_module模块</a></p>
</blockquote>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> gcc openssl-devel pcre-devel zlib-devel -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索</span></span><br><span class="line">yum search</span><br></pre></td></tr></table></figure>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p><code>nginx.conf</code>的<code>http</code>模块下配置</p>
<figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log_format my_format '<span class="built_in">$remote</span>_addr<span class="symbol">^A</span><span class="built_in">$msec</span><span class="symbol">^A</span><span class="built_in">$http</span>_host<span class="symbol">^A</span><span class="built_in">$request</span>_uri'<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p><code>server</code>配置访问日志的格式和文件地址</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location = /<span class="built_in">log</span>.gif &#123;</span><br><span class="line">    default_type image/gif;</span><br><span class="line">    access_log /opt/<span class="keyword">data</span>/<span class="keyword">access</span>.<span class="built_in">log</span> my_format;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./<span class="built_in">n</span></span><br></pre></td></tr></table></figure>
<h1 id="flume安装"><a href="#flume安装" class="headerlink" title="flume安装"></a>flume安装</h1><h2 id="单节点"><a href="#单节点" class="headerlink" title="单节点"></a>单节点</h2><h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#a-simple-example" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#a-simple-example</a></p>
</blockquote>
<h3 id="上传解压"><a href="#上传解压" class="headerlink" title="上传解压"></a>上传解压</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp apache-flume-<span class="number">1.6</span>.<span class="number">0</span>-bin<span class="selector-class">.tar</span><span class="selector-class">.gz</span> root@node02:/root</span><br><span class="line">tar -zxvf apache-flume-<span class="number">1.6</span>.<span class="number">0</span>-bin<span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">mv apache-flume-<span class="number">1.6</span>.<span class="number">0</span>-bin/ /usr/install/</span><br></pre></td></tr></table></figure>
<h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export FLUME_HOME=/usr/<span class="keyword">install</span>/apache-flume<span class="number">-1.6</span><span class="number">.0</span>-<span class="keyword">bin</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">PATH</span>=$<span class="keyword">PATH</span>:$ZOOKEEPER_HOME/<span class="keyword">bin</span>:$HADOOP_HOME/<span class="keyword">bin</span>:$HADOOP_HOME/sbin:$HIVE_HOME/<span class="keyword">bin</span>:$HBASE_HOME/<span class="keyword">bin</span>:$FLUME_HOME/<span class="keyword">bin</span></span><br></pre></td></tr></table></figure>
<h3 id="修改conf-flume-env-sh-文件中的JDK目录"><a href="#修改conf-flume-env-sh-文件中的JDK目录" class="headerlink" title="修改conf/flume-env.sh  文件中的JDK目录"></a>修改conf/flume-env.sh  文件中的JDK目录</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp flume-env<span class="selector-class">.sh</span><span class="selector-class">.template</span> flume-env.sh</span><br><span class="line">vi flume-env.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">JAVA_HOME</span>=/usr/install/jdk/jdk1.8.0_171</span><br></pre></td></tr></table></figure>
<h3 id="验证安装是否成功"><a href="#验证安装是否成功" class="headerlink" title="验证安装是否成功"></a>验证安装是否成功</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng <span class="built_in">version</span></span><br></pre></td></tr></table></figure>
<h3 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> <span class="keyword">conf</span>/</span><br><span class="line"><span class="keyword">vi</span> simple.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Name the components on this agent</span></span><br><span class="line"><span class="built_in">a1</span>.sources = r1</span><br><span class="line"><span class="built_in">a1</span>.sinks = <span class="built_in">k1</span></span><br><span class="line"><span class="built_in">a1</span>.channels = c1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe/configure the source</span></span><br><span class="line"><span class="built_in">a1</span>.sources.r1.type = netcat</span><br><span class="line"><span class="built_in">a1</span>.sources.r1.<span class="keyword">bind </span>= node02</span><br><span class="line"><span class="built_in">a1</span>.sources.r1.port = <span class="number">44444</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe the sink</span></span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.type = logger</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use a channel which buffers events in memory</span></span><br><span class="line"><span class="built_in">a1</span>.channels.c1.type = memory</span><br><span class="line"><span class="built_in">a1</span>.channels.c1.capacity = <span class="number">1000</span></span><br><span class="line"><span class="built_in">a1</span>.channels.c1.transactionCapacity = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the source and sink to the channel</span></span><br><span class="line"><span class="built_in">a1</span>.sources.r1.channels = c1</span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>
<h3 id="启动flume"><a href="#启动flume" class="headerlink" title="启动flume"></a>启动flume</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent -n a1 -c conf -f simple<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h3 id="发送数据"><a href="#发送数据" class="headerlink" title="发送数据"></a>发送数据</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet node<span class="number">02 44444</span></span><br></pre></td></tr></table></figure>
<h2 id="两个flume做集群"><a href="#两个flume做集群" class="headerlink" title="两个flume做集群"></a>两个flume做集群</h2><h3 id="参考文档-1"><a href="#参考文档-1" class="headerlink" title="参考文档"></a>参考文档</h3><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#setting-multi-agent-flow" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#setting-multi-agent-flow</a></p>
</blockquote>
<h3 id="右侧节点-node03"><a href="#右侧节点-node03" class="headerlink" title="右侧节点(node03)"></a>右侧节点(node03)</h3><h4 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h4><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#avro-source" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#avro-source</a></p>
</blockquote>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> double-flume.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Name the components on this agent</span></span><br><span class="line"><span class="built_in">a1</span>.sources = r1</span><br><span class="line"><span class="built_in">a1</span>.sinks = <span class="built_in">k1</span></span><br><span class="line"><span class="built_in">a1</span>.channels = c1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe/configure the source</span></span><br><span class="line"><span class="built_in">a1</span>.sources.r1.type = avro</span><br><span class="line"><span class="built_in">a1</span>.sources.r1.<span class="keyword">bind </span>= node03</span><br><span class="line"><span class="built_in">a1</span>.sources.r1.port = <span class="number">60000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe the sink</span></span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.type = logger</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use a channel which buffers events in memory</span></span><br><span class="line"><span class="built_in">a1</span>.channels.c1.type = memory</span><br><span class="line"><span class="built_in">a1</span>.channels.c1.capacity = <span class="number">1000</span></span><br><span class="line"><span class="built_in">a1</span>.channels.c1.transactionCapacity = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the source and sink to the channel</span></span><br><span class="line"><span class="built_in">a1</span>.sources.r1.channels = c1</span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>
<h4 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent  -n a1 -c conf -f double-flume<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h3 id="左侧节点-node02"><a href="#左侧节点-node02" class="headerlink" title="左侧节点(node02)"></a>左侧节点(node02)</h3><h4 id="参考-2"><a href="#参考-2" class="headerlink" title="参考"></a>参考</h4><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#avro-sink" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#avro-sink</a></p>
</blockquote>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -r apache-flume-<span class="number">1.6</span>.<span class="number">0</span>-bin/ root<span class="variable">@node03</span><span class="symbol">:/usr/install</span></span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> double-flume.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">a1</span>.sources = r1</span><br><span class="line"><span class="built_in">a1</span>.sinks = <span class="built_in">k1</span></span><br><span class="line"><span class="built_in">a1</span>.channels = c1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe/configure the source</span></span><br><span class="line"><span class="built_in">a1</span>.sources.r1.type = netcat</span><br><span class="line"><span class="built_in">a1</span>.sources.r1.<span class="keyword">bind </span>= node02</span><br><span class="line"><span class="built_in">a1</span>.sources.r1.port = <span class="number">44444</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe the sink</span></span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.type = avro</span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.hostname = node03</span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.port = <span class="number">60000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use a channel which buffers events in memory</span></span><br><span class="line"><span class="built_in">a1</span>.channels.c1.type = memory</span><br><span class="line"><span class="built_in">a1</span>.channels.c1.capacity = <span class="number">1000</span></span><br><span class="line"><span class="built_in">a1</span>.channels.c1.transactionCapacity = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the source and sink to the channel</span></span><br><span class="line"><span class="built_in">a1</span>.sources.r1.channels = c1</span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>
<h4 id="启动-2"><a href="#启动-2" class="headerlink" title="启动"></a>启动</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent  -n a1 -c conf -f double-flume<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h3 id="发送数据-1"><a href="#发送数据-1" class="headerlink" title="发送数据"></a>发送数据</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet node<span class="number">02 44444</span></span><br></pre></td></tr></table></figure>
<h2 id="Exec-Source方式，监控文件tail命令"><a href="#Exec-Source方式，监控文件tail命令" class="headerlink" title="Exec Source方式，监控文件tail命令"></a>Exec Source方式，监控文件tail命令</h2><h3 id="参考-3"><a href="#参考-3" class="headerlink" title="参考"></a>参考</h3><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#exec-source" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#exec-source</a></p>
</blockquote>
<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> exec.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">a1.<span class="attr">sources</span> = r1</span><br><span class="line">a1.<span class="attr">sinks</span> = k1</span><br><span class="line">a1.<span class="attr">channels</span> = c1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe/configure the source</span></span><br><span class="line">a1.sources.r1.<span class="attr">type</span> = exec</span><br><span class="line">a1.sources.r1.<span class="attr">command</span> = tail -F /root/test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe the sink</span></span><br><span class="line">a1.sinks.k1.<span class="attr">type</span> = logger</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use a channel which buffers events in memory</span></span><br><span class="line">a1.channels.c1.<span class="attr">type</span> = memory</span><br><span class="line">a1.channels.c1.<span class="attr">capacity</span> = <span class="number">1000</span></span><br><span class="line">a1.channels.c1.<span class="attr">transactionCapacity</span> = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the source and sink to the channel</span></span><br><span class="line">a1.sources.r1.<span class="attr">channels</span> = c1</span><br><span class="line">a1.sinks.k1.<span class="attr">channel</span> = c1</span><br></pre></td></tr></table></figure>
<h3 id="启动-3"><a href="#启动-3" class="headerlink" title="启动"></a>启动</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent -n a1 -c conf -f exec<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h3 id="添加数据"><a href="#添加数据" class="headerlink" title="添加数据"></a>添加数据</h3><p>循环添加数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..50&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">"<span class="variable">$i</span> hi flume"</span> &gt;&gt; /root/test.txt ; sleep 0.1; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h2 id="Spooling-Directory-Source监控目录"><a href="#Spooling-Directory-Source监控目录" class="headerlink" title="Spooling Directory Source监控目录"></a>Spooling Directory Source监控目录</h2><h3 id="参考-4"><a href="#参考-4" class="headerlink" title="参考"></a>参考</h3><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#spooling-directory-source" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#spooling-directory-source</a></p>
</blockquote>
<h3 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> spool.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">a1.<span class="attr">sources</span> = r1</span><br><span class="line">a1.<span class="attr">sinks</span> = k1</span><br><span class="line">a1.<span class="attr">channels</span> = c1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe/configure the source</span></span><br><span class="line">a1.sources.r1.<span class="attr">type</span> = spooldir</span><br><span class="line">a1.sources.r1.<span class="attr">spoolDir</span> = /root/logs</span><br><span class="line">a1.sources.r1.<span class="attr">fileHeader</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe the sink</span></span><br><span class="line">a1.sinks.k1.<span class="attr">type</span> = logger</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use a channel which buffers events in memory</span></span><br><span class="line">a1.channels.c1.<span class="attr">type</span> = memory</span><br><span class="line">a1.channels.c1.<span class="attr">capacity</span> = <span class="number">1000</span></span><br><span class="line">a1.channels.c1.<span class="attr">transactionCapacity</span> = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the source and sink to the channel</span></span><br><span class="line">a1.sources.r1.<span class="attr">channels</span> = c1</span><br><span class="line">a1.sinks.k1.<span class="attr">channel</span> = c1</span><br></pre></td></tr></table></figure>
<h3 id="启动-4"><a href="#启动-4" class="headerlink" title="启动"></a>启动</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent -n a1 -c conf -f spool<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h3 id="拷贝文件演示"><a href="#拷贝文件演示" class="headerlink" title="拷贝文件演示"></a>拷贝文件演示</h3><pre><code>mkdir logs
mv aa logs/
</code></pre><h2 id="flume和kafka"><a href="#flume和kafka" class="headerlink" title="flume和kafka"></a>flume和kafka</h2><p>两者经常配对使用，谁在前后都可以</p>
<h2 id="hdfs-sink方式"><a href="#hdfs-sink方式" class="headerlink" title="hdfs sink方式"></a>hdfs sink方式</h2><h3 id="参考-5"><a href="#参考-5" class="headerlink" title="参考"></a>参考</h3><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#hdfs-sink" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#hdfs-sink</a></p>
</blockquote>
<h3 id="配置-3"><a href="#配置-3" class="headerlink" title="配置"></a>配置</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> hdfs-sink.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">a1.<span class="attr">sources</span> = r1</span><br><span class="line">a1.<span class="attr">sinks</span> = k1</span><br><span class="line">a1.<span class="attr">channels</span> = c1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe/configure the source</span></span><br><span class="line">a1.sources.r1.<span class="attr">type</span> = spooldir</span><br><span class="line">a1.sources.r1.<span class="attr">spoolDir</span> = /root/logs</span><br><span class="line">a1.sources.r1.<span class="attr">fileHeader</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe the sink 文件目录格式</span></span><br><span class="line">a1.sinks.k1.<span class="attr">type=hdfs</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">path=hdfs://mycluster/flume/%Y-%m-%d/%H%M</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##每隔60s或者文件大小超过10M的时候产生新文件，roll对文件设置</span></span><br><span class="line"><span class="comment"># hdfs有多少条消息时新建文件，0不基于消息个数</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">rollCount=0</span></span><br><span class="line"><span class="comment"># hdfs创建多长时间新建文件，0不基于时间</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">rollInterval=60</span></span><br><span class="line"><span class="comment"># hdfs多大时新建文件，0不基于文件大小</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">rollSize=10240</span></span><br><span class="line"><span class="comment"># 当目前被打开的临时文件在该参数指定的时间（秒）内，没有任何数据写入，则将该临时文件关闭并重命名成目标文件</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">idleTimeout=3</span></span><br><span class="line"></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">fileType=DataStream</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">useLocalTimeStamp=true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 每五分钟生成一个目录，round对目录设置</span></span><br><span class="line"><span class="comment"># 是否启用时间上的”舍弃”，这里的”舍弃”，类似于”四舍五入”，后面再介绍。如果启用，则会影响除了%t的其他所有时间表达式</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">round=true</span></span><br><span class="line"><span class="comment"># 时间上进行“舍弃”的值；</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">roundValue=5</span></span><br><span class="line"><span class="comment"># 时间上进行”舍弃”的单位，包含：second,minute,hour</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">roundUnit=minute</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use a channel which buffers events in memory</span></span><br><span class="line">a1.channels.c1.<span class="attr">type</span> = memory</span><br><span class="line">a1.channels.c1.<span class="attr">capacity</span> = <span class="number">1000</span></span><br><span class="line">a1.channels.c1.<span class="attr">transactionCapacity</span> = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the source and sink to the channel</span></span><br><span class="line">a1.sources.r1.<span class="attr">channels</span> = c1</span><br><span class="line">a1.sinks.k1.<span class="attr">channel</span> = c1</span><br></pre></td></tr></table></figure>
<h3 id="启动-5"><a href="#启动-5" class="headerlink" title="启动"></a>启动</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent -n a1 -c conf -f hdfs-sink<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h3 id="拷贝文件演示-1"><a href="#拷贝文件演示-1" class="headerlink" title="拷贝文件演示"></a>拷贝文件演示</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> logs</span><br><span class="line">mv aa logs/</span><br></pre></td></tr></table></figure>
<h1 id="tengine和flume集成"><a href="#tengine和flume集成" class="headerlink" title="tengine和flume集成"></a>tengine和flume集成</h1><h2 id="配置-4"><a href="#配置-4" class="headerlink" title="配置"></a>配置</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> tengine_project.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">a1.<span class="attr">sources</span> = r1</span><br><span class="line">a1.<span class="attr">sinks</span> = k1</span><br><span class="line">a1.<span class="attr">channels</span> = c1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 监听tengine的access log文件</span></span><br><span class="line">a1.sources.r1.<span class="attr">type</span> = exec</span><br><span class="line">a1.sources.r1.<span class="attr">command</span> = tail -F /opt/data/access.log</span><br><span class="line"></span><br><span class="line">a1.sinks.k1.<span class="attr">type=hdfs</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">path=hdfs://mycluster/log/%Y%m%d</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">rollCount=0</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">rollInterval=0</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">rollSize=10240</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">idleTimeout=5</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">fileType=DataStream</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">useLocalTimeStamp=true</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">callTimeout=40000</span></span><br><span class="line"></span><br><span class="line">a1.channels.c1.<span class="attr">type</span> = memory</span><br><span class="line">a1.channels.c1.<span class="attr">capacity</span> = <span class="number">1000</span></span><br><span class="line">a1.channels.c1.<span class="attr">transactionCapacity</span> = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">a1.sources.r1.<span class="attr">channels</span> = c1</span><br><span class="line">a1.sinks.k1.<span class="attr">channel</span> = c1</span><br></pre></td></tr></table></figure>
<h2 id="启动-6"><a href="#启动-6" class="headerlink" title="启动"></a>启动</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent -n a1 -c conf -f tengine_project<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h2 id="拷贝文件演示-2"><a href="#拷贝文件演示-2" class="headerlink" title="拷贝文件演示"></a>拷贝文件演示</h2><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> logs</span><br><span class="line">mv aa logs/</span><br></pre></td></tr></table></figure>
<h1 id="经过ETL清洗存储到hbase"><a href="#经过ETL清洗存储到hbase" class="headerlink" title="经过ETL清洗存储到hbase"></a>经过ETL清洗存储到hbase</h1><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><ul>
<li>过滤脏数据</li>
<li>分析IP，得到省、市区</li>
<li>分析useragent，得到浏览器版本</li>
</ul>
<h2 id="AnalyserLogDataRunner"><a href="#AnalyserLogDataRunner" class="headerlink" title="AnalyserLogDataRunner"></a>AnalyserLogDataRunner</h2><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sxt.etl.mr.ald;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.FileSystem;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.HBaseConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Put;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.mapreduce.TableMapReduceUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.Tool;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.ToolRunner;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sxt.common.EventLogConstants;</span><br><span class="line"><span class="keyword">import</span> com.sxt.common.GlobalConstants;</span><br><span class="line"><span class="keyword">import</span> com.sxt.util.TimeUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 编写mapreduce的runner类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> root</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnalyserLogDataRunner</span> <span class="keyword">implements</span> <span class="title">Tool</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = Logger</span><br><span class="line">			.getLogger(AnalyserLogDataRunner.class);</span><br><span class="line">	<span class="keyword">private</span> Configuration conf = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ToolRunner.run(<span class="keyword">new</span> Configuration(), <span class="keyword">new</span> AnalyserLogDataRunner(), args);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			logger.<span class="keyword">error</span>(<span class="string">"执行日志解析job异常"</span>, e);</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">setConf</span><span class="params">(Configuration conf)</span> </span>&#123;</span><br><span class="line">		conf.set(<span class="string">"fs.defaultFS"</span>, <span class="string">"hdfs://node01:8020"</span>);</span><br><span class="line"><span class="comment">//		conf.set("yarn.resourcemanager.hostname", "node3");</span></span><br><span class="line">		conf.set(<span class="string">"hbase.zookeeper.quorum"</span>, <span class="string">"node02,node03,node04"</span>);</span><br><span class="line">		<span class="keyword">this</span>.conf = HBaseConfiguration.create(conf);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function">Configuration <span class="title">getConf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.conf;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		Configuration conf = <span class="keyword">this</span>.getConf();</span><br><span class="line">		<span class="keyword">this</span>.processArgs(conf, args);</span><br><span class="line"></span><br><span class="line">		Job job = Job.getInstance(conf, <span class="string">"analyser_logdata"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 设置本地提交job，集群运行，需要代码</span></span><br><span class="line">		<span class="comment">// File jarFile = EJob.createTempJar("target/classes");</span></span><br><span class="line">		<span class="comment">// ((JobConf) job.getConfiguration()).setJar(jarFile.toString());</span></span><br><span class="line">		<span class="comment">// 设置本地提交job，集群运行，需要代码结束</span></span><br><span class="line"></span><br><span class="line">		job.setJarByClass(AnalyserLogDataRunner.class);</span><br><span class="line">		job.setMapperClass(AnalyserLogDataMapper.class);</span><br><span class="line">		job.setMapOutputKeyClass(NullWritable.class);</span><br><span class="line">		job.setMapOutputValueClass(Put.class);</span><br><span class="line">		<span class="comment">// 设置reducer配置</span></span><br><span class="line">		<span class="comment">// 1. 集群上运行，打成jar运行(要求addDependencyJars参数为true，默认就是true)</span></span><br><span class="line">		<span class="comment">// TableMapReduceUtil.initTableReducerJob(EventLogConstants.HBASE_NAME_EVENT_LOGS,</span></span><br><span class="line">		<span class="comment">// null, job);</span></span><br><span class="line">		<span class="comment">// 2. 本地运行，要求参数addDependencyJars为false</span></span><br><span class="line">		TableMapReduceUtil.initTableReducerJob(</span><br><span class="line">				EventLogConstants.HBASE_NAME_EVENT_LOGS, <span class="keyword">null</span>, job, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">				<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">		job.setNumReduceTasks(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 设置输入路径</span></span><br><span class="line">		<span class="keyword">this</span>.setJobInputPaths(job);</span><br><span class="line">		<span class="keyword">return</span> job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : -1;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 处理参数</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> conf</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">processArgs</span><span class="params">(Configuration conf, String[] args)</span> </span>&#123;</span><br><span class="line">		String date = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="string">"-d"</span>.equals(args[i])) &#123;</span><br><span class="line">				<span class="keyword">if</span> (i + <span class="number">1</span> &lt; args.length) &#123;</span><br><span class="line">					date = args[++i];</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		System.out.println(<span class="string">"-----"</span> + date);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 要求date格式为: yyyy-MM-dd</span></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isBlank(date) || !TimeUtil.isValidateRunningDate(date)) &#123;</span><br><span class="line">			<span class="comment">// date是一个无效时间数据</span></span><br><span class="line">			date = TimeUtil.getYesterday(); <span class="comment">// 默认时间是昨天</span></span><br><span class="line">			System.out.println(date);</span><br><span class="line">		&#125;</span><br><span class="line">		conf.set(GlobalConstants.RUNNING_DATE_PARAMES, date);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 设置job的输入路径</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> job</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">setJobInputPaths</span><span class="params">(Job job)</span> </span>&#123;</span><br><span class="line">		Configuration conf = job.getConfiguration();</span><br><span class="line">		FileSystem fs = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			fs = FileSystem.get(conf);</span><br><span class="line">			String date = conf.get(GlobalConstants.RUNNING_DATE_PARAMES);</span><br><span class="line">			<span class="comment">// Path inputPath = new Path("/flume/" +</span></span><br><span class="line">			<span class="comment">// TimeUtil.parseLong2String(TimeUtil.parseString2Long(date),</span></span><br><span class="line">			<span class="comment">// "MM/dd/"));</span></span><br><span class="line">			Path inputPath = <span class="keyword">new</span> Path(<span class="string">"/log/"</span></span><br><span class="line">					+ TimeUtil.parseLong2String(</span><br><span class="line">							TimeUtil.parseString2Long(date), <span class="string">"yyyyMMdd"</span>)</span><br><span class="line">					+ <span class="string">"/"</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (fs.exists(inputPath)) &#123;</span><br><span class="line">				FileInputFormat.addInputPath(job, inputPath);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"文件不存在:"</span> + inputPath);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"设置job的mapreduce输入路径出现异常"</span>, e);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (fs != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					fs.close();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">					<span class="comment">// nothing</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="AnalyserLogDataMapper"><a href="#AnalyserLogDataMapper" class="headerlink" title="AnalyserLogDataMapper"></a>AnalyserLogDataMapper</h2><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sxt.etl.mr.ald;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.CRC32;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Put;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.util.Bytes;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sxt.common.EventLogConstants;</span><br><span class="line"><span class="keyword">import</span> com.sxt.common.EventLogConstants.EventEnum;</span><br><span class="line"><span class="keyword">import</span> com.sxt.etl.util.LoggerUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义数据解析map类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @author root</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> class AnalyserLogDataMapper extends Mapper&lt;LongWritable, Text, NullWritable, Put&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Logger logger = Logger.getLogger(AnalyserLogDataMapper.class);</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">int</span> inputRecords, filterRecords, outputRecords; <span class="comment">// 主要用于标志，方便查看过滤数据</span></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">byte</span>[] family = Bytes.toBytes(EventLogConstants.EVENT_LOGS_FAMILY_NAME);</span><br><span class="line">	<span class="keyword">private</span> CRC32 crc32 = <span class="keyword">new</span> CRC32();</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="built_in">map</span>(LongWritable <span class="built_in">key</span>, Text value, Context context)</span><br><span class="line">			<span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">		<span class="keyword">this</span>.inputRecords++;</span><br><span class="line">		<span class="keyword">this</span>.logger.debug(<span class="string">"Analyse data of :"</span> + value);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// 解析日志</span></span><br><span class="line">			Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; clientInfo = LoggerUtil.handleLog(value.toString());</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 过滤解析失败的数据</span></span><br><span class="line">			<span class="keyword">if</span> (clientInfo.isEmpty()) &#123;</span><br><span class="line">				<span class="keyword">this</span>.filterRecords++;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 获取事件名称</span></span><br><span class="line">			<span class="keyword">String</span> eventAliasName = clientInfo.<span class="built_in">get</span>(EventLogConstants.LOG_COLUMN_NAME_EVENT_NAME);</span><br><span class="line">			EventEnum event = EventEnum.valueOfAlias(eventAliasName);</span><br><span class="line">			<span class="keyword">switch</span> (event) &#123;</span><br><span class="line">			<span class="keyword">case</span> LAUNCH:</span><br><span class="line">			<span class="keyword">case</span> PAGEVIEW:</span><br><span class="line">			<span class="keyword">case</span> CHARGEREQUEST:</span><br><span class="line">			<span class="keyword">case</span> CHARGEREFUND:</span><br><span class="line">			<span class="keyword">case</span> CHARGESUCCESS:</span><br><span class="line">			<span class="keyword">case</span> EVENT:</span><br><span class="line">				<span class="comment">// 处理数据</span></span><br><span class="line">				<span class="keyword">this</span>.handleData(clientInfo, event, context);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="keyword">this</span>.filterRecords++;</span><br><span class="line">				<span class="keyword">this</span>.logger.warn(<span class="string">"该事件没法进行解析，事件名称为:"</span> + eventAliasName);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">this</span>.filterRecords++;</span><br><span class="line">			<span class="keyword">this</span>.logger.error(<span class="string">"处理数据发出异常，数据:"</span> + value, e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> cleanup(Context context) <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">		<span class="keyword">super</span>.cleanup(context);</span><br><span class="line">		logger.info(<span class="string">"输入数据:"</span> + <span class="keyword">this</span>.inputRecords + <span class="string">"；输出数据:"</span> + <span class="keyword">this</span>.outputRecords</span><br><span class="line">				+ <span class="string">"；过滤数据:"</span> + <span class="keyword">this</span>.filterRecords);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 具体处理数据的方法</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param clientInfo</span></span><br><span class="line"><span class="comment">	 * @param context</span></span><br><span class="line"><span class="comment">	 * @param event</span></span><br><span class="line"><span class="comment">	 * @throws InterruptedException</span></span><br><span class="line"><span class="comment">	 * @throws IOException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> handleData(Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; clientInfo, EventEnum event,</span><br><span class="line">			Context context) <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">		<span class="keyword">String</span> uuid = clientInfo.<span class="built_in">get</span>(EventLogConstants.LOG_COLUMN_NAME_UUID);</span><br><span class="line">		<span class="keyword">String</span> memberId = clientInfo</span><br><span class="line">				.<span class="built_in">get</span>(EventLogConstants.LOG_COLUMN_NAME_MEMBER_ID);</span><br><span class="line">		<span class="keyword">String</span> serverTime = clientInfo</span><br><span class="line">				.<span class="built_in">get</span>(EventLogConstants.LOG_COLUMN_NAME_SERVER_TIME);</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isNotBlank(serverTime)) &#123;</span><br><span class="line">			<span class="comment">// 要求服务器时间不为空</span></span><br><span class="line">			clientInfo.remove(EventLogConstants.LOG_COLUMN_NAME_USER_AGENT); <span class="comment">// 浏览器信息去掉</span></span><br><span class="line">			<span class="keyword">String</span> rowkey = <span class="keyword">this</span>.generateRowKey(uuid, memberId, event.alias,</span><br><span class="line">					serverTime); <span class="comment">// timestamp</span></span><br><span class="line">									<span class="comment">// +</span></span><br><span class="line">									<span class="comment">// (uuid+memberid+event).crc</span></span><br><span class="line">			Put put = <span class="keyword">new</span> Put(Bytes.toBytes(rowkey));</span><br><span class="line">			<span class="keyword">for</span> (Map.Entry&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; entry : clientInfo.entrySet()) &#123;</span><br><span class="line">				<span class="keyword">if</span> (StringUtils.isNotBlank(entry.getKey())</span><br><span class="line">						&amp;&amp; StringUtils.isNotBlank(entry.getValue())) &#123;</span><br><span class="line">					put.<span class="built_in">add</span>(family, Bytes.toBytes(entry.getKey()),</span><br><span class="line">							Bytes.toBytes(entry.getValue()));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			context.write(NullWritable.<span class="built_in">get</span>(), put);</span><br><span class="line">			<span class="keyword">this</span>.outputRecords++;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.filterRecords++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 根据uuid memberid servertime创建rowkey</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param uuid</span></span><br><span class="line"><span class="comment">	 * @param memberId</span></span><br><span class="line"><span class="comment">	 * @param eventAliasName</span></span><br><span class="line"><span class="comment">	 * @param serverTime</span></span><br><span class="line"><span class="comment">	 * @return</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> generateRowKey(<span class="keyword">String</span> uuid, <span class="keyword">String</span> memberId,</span><br><span class="line">			<span class="keyword">String</span> eventAliasName, <span class="keyword">String</span> serverTime) &#123;</span><br><span class="line">		StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">		sb.<span class="built_in">append</span>(serverTime).<span class="built_in">append</span>(<span class="string">"_"</span>);</span><br><span class="line">		<span class="keyword">this</span>.crc32.reset();</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isNotBlank(uuid)) &#123;</span><br><span class="line">			<span class="keyword">this</span>.crc32.update(uuid.getBytes());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isNotBlank(memberId)) &#123;</span><br><span class="line">			<span class="keyword">this</span>.crc32.update(memberId.getBytes());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.crc32.update(eventAliasName.getBytes());</span><br><span class="line">		sb.<span class="built_in">append</span>(<span class="keyword">this</span>.crc32.getValue() % <span class="number">100000000</span>L);</span><br><span class="line">		<span class="keyword">return</span> sb.toString();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="map-reduce分析hbase的数据，落到mysql"><a href="#map-reduce分析hbase的数据，落到mysql" class="headerlink" title="map reduce分析hbase的数据，落到mysql"></a>map reduce分析hbase的数据，落到mysql</h1><p>经过不同维度</p>
<h2 id="mysql数据库准备"><a href="#mysql数据库准备" class="headerlink" title="mysql数据库准备"></a>mysql数据库准备</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> <span class="string">'result_db'</span>;</span><br></pre></td></tr></table></figure>
<p>使用<code>mysql_表设计.sql</code>创建表</p>
<h2 id="新用户模块"><a href="#新用户模块" class="headerlink" title="新用户模块"></a>新用户模块</h2><h3 id="NewInstallUserMapper"><a href="#NewInstallUserMapper" class="headerlink" title="NewInstallUserMapper"></a>NewInstallUserMapper</h3><p>经过1次map，输出多个维度，减少网络IO</p>
<p>输出的key <code>StatsUserDimension</code>，包含以下两个维度。分别是普通统计用户</p>
<p>新用户访问数据： 时间  访问平台(js浏览器)  访问浏览器</p>
<p>这样浏览器新用户KPI，可以经过笛卡尔积2*2，统计4个维度的信息。</p>
<table>
<thead>
<tr>
<th></th>
<th>当前浏览器(全部版本)</th>
<th>当前浏览器(版本1.0)</th>
</tr>
</thead>
<tbody>
<tr>
<td>当前平台(js浏览器端或者手机安卓)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>全部平台</td>
<td></td>
</tr>
</tbody>
</table>
<p>另外，只统计新用户KPI，平台信息支持输出，不带浏览器，有2种结果。这样4+2=6种结果。</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> StatsCommonDimension statsCommon = <span class="keyword">new</span> <span class="type">StatsCommonDimension</span>();</span><br><span class="line"><span class="keyword">private</span> BrowserDimension browser = <span class="keyword">new</span> <span class="type">BrowserDimension</span>();</span><br></pre></td></tr></table></figure>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> StatsUserDimension statsUserDimension = <span class="keyword">new</span> <span class="type">StatsUserDimension</span>();</span><br><span class="line"> <span class="keyword">private</span> TimeOutputValue timeOutputValue = <span class="keyword">new</span> <span class="type">TimeOutputValue</span>();</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">package com.sxt.transformer.mr.nu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Result;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.io.ImmutableBytesWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.mapreduce.TableMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.util.Bytes;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sxt.common.DateEnum;</span><br><span class="line"><span class="keyword">import</span> com.sxt.common.EventLogConstants;</span><br><span class="line"><span class="keyword">import</span> com.sxt.common.KpiType;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.dim.StatsCommonDimension;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.dim.StatsUserDimension;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.dim.base.BrowserDimension;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.dim.base.DateDimension;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.dim.base.KpiDimension;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.dim.base.PlatformDimension;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.value.map.TimeOutputValue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewInstallUserMapper</span> <span class="title">extends</span> <span class="title">TableMapper</span>&lt;<span class="title">StatsUserDimension</span>, <span class="title">TimeOutputValue</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> logger = <span class="type">Logger</span>.getLogger(<span class="type">NewInstallUserMapper</span>.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">StatsUserDimension</span> statsUserDimension = new <span class="type">StatsUserDimension</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">TimeOutputValue</span> timeOutputValue = new <span class="type">TimeOutputValue</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> byte[] family = <span class="type">Bytes</span>.toBytes(<span class="type">EventLogConstants</span>.<span class="type">EVENT_LOGS_FAMILY_NAME</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//代表用户分析模块的统计</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">KpiDimension</span> newInstallUserKpi = new <span class="type">KpiDimension</span>(<span class="type">KpiType</span>.<span class="type">NEW_INSTALL_USER</span>.name);</span><br><span class="line">    <span class="comment">//浏览器分析模块的统计</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">KpiDimension</span> newInstallUserOfBrowserKpi = new <span class="type">KpiDimension</span>(<span class="type">KpiType</span>.<span class="type">BROWSER_NEW_INSTALL_USER</span>.name);</span><br><span class="line"></span><br><span class="line">    @<span class="type">Override</span></span><br><span class="line">    protected void <span class="built_in">map</span>(<span class="type">ImmutableBytesWritable</span> key, <span class="type">Result</span> value, <span class="type">Context</span> context)</span><br><span class="line">    		<span class="keyword">throws</span> <span class="type">IOException</span>, <span class="type">InterruptedException</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="type">String</span> uuid = <span class="type">Bytes</span>.<span class="built_in">toString</span>(value.getValue(family, <span class="type">Bytes</span>.toBytes(<span class="type">EventLogConstants</span>.<span class="type">LOG_COLUMN_NAME_UUID</span>)));</span><br><span class="line">		<span class="type">String</span> serverTime = <span class="type">Bytes</span>.<span class="built_in">toString</span>(value.getValue(family, <span class="type">Bytes</span>.toBytes(<span class="type">EventLogConstants</span>.<span class="type">LOG_COLUMN_NAME_SERVER_TIME</span>)));</span><br><span class="line">		<span class="type">String</span> platform = <span class="type">Bytes</span>.<span class="built_in">toString</span>(value.getValue(family, <span class="type">Bytes</span>.toBytes(<span class="type">EventLogConstants</span>.<span class="type">LOG_COLUMN_NAME_PLATFORM</span>)));</span><br><span class="line"></span><br><span class="line">		<span class="type">System</span>.out.<span class="built_in">println</span>(uuid + <span class="string">"-"</span> + serverTime +<span class="string">"-"</span>+ platform);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="type">StringUtils</span>.isBlank(uuid) || <span class="type">StringUtils</span>.isBlank(serverTime) || <span class="type">StringUtils</span>.isBlank(platform)) &#123;</span><br><span class="line">			logger.warn(<span class="string">"uuid&amp;servertime&amp;platform不能为空"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		long longOfTime = <span class="type">Long</span>.valueOf(serverTime.trim());</span><br><span class="line">		timeOutputValue.setTime(longOfTime);</span><br><span class="line">		timeOutputValue.setId(uuid);</span><br><span class="line"></span><br><span class="line">		<span class="type">DateDimension</span> dateDimension = <span class="type">DateDimension</span>.buildDate(longOfTime, <span class="type">DateEnum</span>.<span class="type">DAY</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置date维度</span></span><br><span class="line">        <span class="type">StatsCommonDimension</span> statsCommonDimension = this.statsUserDimension.getStatsCommon();</span><br><span class="line">        statsCommonDimension.setDate(dateDimension);</span><br><span class="line"></span><br><span class="line">        <span class="type">List</span>&lt;<span class="type">PlatformDimension</span>&gt; platformDimensions = <span class="type">PlatformDimension</span>.buildList(platform);</span><br><span class="line"></span><br><span class="line">		<span class="type">String</span> browserName = <span class="type">Bytes</span>.<span class="built_in">toString</span>(value.getValue(family, <span class="type">Bytes</span>.toBytes(<span class="type">EventLogConstants</span>.<span class="type">LOG_COLUMN_NAME_BROWSER_NAME</span>)));</span><br><span class="line">		<span class="type">String</span> browserVersion = <span class="type">Bytes</span>.<span class="built_in">toString</span>(value.getValue(family, <span class="type">Bytes</span>.toBytes(<span class="type">EventLogConstants</span>.<span class="type">LOG_COLUMN_NAME_BROWSER_VERSION</span>)));</span><br><span class="line">		<span class="type">List</span>&lt;<span class="type">BrowserDimension</span>&gt; browserDimensions = <span class="type">BrowserDimension</span>.buildList(browserName, browserVersion);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//空浏览器维度，不考虑浏览器维度</span></span><br><span class="line">        <span class="type">BrowserDimension</span> defaultBrowser = new <span class="type">BrowserDimension</span>(<span class="string">""</span>, <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">PlatformDimension</span> pfDimension : platformDimensions) &#123;</span><br><span class="line">        	statsUserDimension.setBrowser(defaultBrowser);</span><br><span class="line"></span><br><span class="line">        	statsCommonDimension.setKpi(newInstallUserKpi);</span><br><span class="line">        	statsCommonDimension.setPlatform(pfDimension);</span><br><span class="line"></span><br><span class="line">        	context.write(statsUserDimension, timeOutputValue);</span><br><span class="line"></span><br><span class="line">        	<span class="keyword">for</span>(<span class="type">BrowserDimension</span> browserDimension : browserDimensions) &#123;</span><br><span class="line">            	statsUserDimension.setBrowser(browserDimension);</span><br><span class="line">            	statsCommonDimension.setKpi(newInstallUserOfBrowserKpi);</span><br><span class="line"></span><br><span class="line">            	context.write(statsUserDimension, timeOutputValue);</span><br><span class="line">        	&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="NewInstallUserReducer"><a href="#NewInstallUserReducer" class="headerlink" title="NewInstallUserReducer"></a>NewInstallUserReducer</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sxt.transformer.mr.nu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.dim.StatsUserDimension;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.value.<span class="built_in">map</span>.TimeOutputValue;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.value.reduce.MapWritableValue;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.MapWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</span><br><span class="line"><span class="keyword">import</span> com.sxt.common.KpiType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> class NewInstallUserReducer extends Reducer&lt;StatsUserDimension, TimeOutputValue, StatsUserDimension, MapWritableValue&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MapWritableValue outputValue = <span class="keyword">new</span> MapWritableValue();</span><br><span class="line">    <span class="keyword">private</span> Set&lt;<span class="keyword">String</span>&gt; unique = <span class="keyword">new</span> HashSet&lt;<span class="keyword">String</span>&gt;();</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> reduce(StatsUserDimension <span class="built_in">key</span>, Iterable&lt;TimeOutputValue&gt; values,</span><br><span class="line">			Reducer&lt;StatsUserDimension, TimeOutputValue, StatsUserDimension, MapWritableValue&gt;.Context context)</span><br><span class="line">			<span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">		<span class="keyword">this</span>.unique.<span class="built_in">clear</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span>(TimeOutputValue value : values) &#123;</span><br><span class="line">			<span class="keyword">this</span>.unique.<span class="built_in">add</span>(value.getId());</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		MapWritable <span class="built_in">map</span> = <span class="keyword">new</span> MapWritable();</span><br><span class="line">		<span class="built_in">map</span>.put(<span class="keyword">new</span> IntWritable(<span class="number">-1</span>), <span class="keyword">new</span> IntWritable(unique.<span class="built_in">size</span>()));</span><br><span class="line">		outputValue.setValue(<span class="built_in">map</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">String</span> kpiName  = <span class="built_in">key</span>.getStatsCommon().getKpi().getKpiName();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (KpiType.NEW_INSTALL_USER.name.equals(kpiName)) &#123;</span><br><span class="line">			outputValue.setKpi(KpiType.NEW_INSTALL_USER);</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span> (KpiType.BROWSER_NEW_INSTALL_USER.name.equals(kpiName)) &#123;</span><br><span class="line"></span><br><span class="line">			outputValue.setKpi(KpiType.BROWSER_NEW_INSTALL_USER);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		context.write(<span class="built_in">key</span>, outputValue);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意检查配置<code>jdbc:mysql://node01:3306/result_db</code>  zk配置  和 hdfs配置正确。</p>
<h3 id="TransformerOutputFormat"><a href="#TransformerOutputFormat" class="headerlink" title="TransformerOutputFormat"></a>TransformerOutputFormat</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sxt.transformer.mr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.util.<span class="keyword">HashMap</span>;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.JobContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.OutputCommitter;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.OutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.RecordWriter;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.TaskAttemptContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputCommitter;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sxt.common.GlobalConstants;</span><br><span class="line"><span class="keyword">import</span> com.sxt.common.KpiType;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.dim.base.BaseDimension;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.model.value.BaseStatsValueWritable;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.service.IDimensionConverter;</span><br><span class="line"><span class="keyword">import</span> com.sxt.transformer.service.impl.DimensionConverterImpl;</span><br><span class="line"><span class="keyword">import</span> com.sxt.util.JdbcManager;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义输出到mysql的outputformat类</span></span><br><span class="line"><span class="comment"> * BaseDimension:reducer输出的key</span></span><br><span class="line"><span class="comment"> * BaseStatsValueWritable：reducer输出的value</span></span><br><span class="line"><span class="comment"> * @author root</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> class TransformerOutputFormat extends OutputFormat&lt;BaseDimension, BaseStatsValueWritable&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = Logger.getLogger(TransformerOutputFormat.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义每条数据的输出格式，一条数据就是reducer任务每次执行write方法输出的数据。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @Override</span><br><span class="line">	<span class="keyword">public</span> RecordWriter&lt;BaseDimension, BaseStatsValueWritable&gt; getRecordWriter(TaskAttemptContext context) <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        Configuration conf = context.getConfiguration();</span><br><span class="line">        Connection conn = <span class="keyword">null</span>;</span><br><span class="line">        IDimensionConverter converter = <span class="keyword">new</span> DimensionConverterImpl();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            conn = JdbcManager.getConnection(conf, GlobalConstants.WAREHOUSE_OF_REPORT);</span><br><span class="line">            conn.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            logger.error(<span class="string">"获取数据库连接失败"</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"获取数据库连接失败"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TransformerRecordWriter(conn, conf, converter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> checkOutputSpecs(JobContext context) <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 检测输出空间，输出到mysql不用检测</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> OutputCommitter getOutputCommitter(TaskAttemptContext context) <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FileOutputCommitter(FileOutputFormat.getOutputPath(context), context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义具体数据输出writer</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @author root</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> class TransformerRecordWriter extends RecordWriter&lt;BaseDimension, BaseStatsValueWritable&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> Connection conn = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">private</span> Configuration conf = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">private</span> IDimensionConverter converter = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">private</span> Map&lt;KpiType, PreparedStatement&gt; <span class="built_in">map</span> = <span class="keyword">new</span> <span class="keyword">HashMap</span>&lt;KpiType, PreparedStatement&gt;();</span><br><span class="line">        <span class="keyword">private</span> Map&lt;KpiType, Integer&gt; batch = <span class="keyword">new</span> <span class="keyword">HashMap</span>&lt;KpiType, Integer&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> TransformerRecordWriter(Connection conn, Configuration conf, IDimensionConverter converter) &#123;</span><br><span class="line">            <span class="keyword">super</span>();</span><br><span class="line">            <span class="keyword">this</span>.conn = conn;</span><br><span class="line">            <span class="keyword">this</span>.conf = conf;</span><br><span class="line">            <span class="keyword">this</span>.converter = converter;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 当reduce任务输出数据是，由计算框架自动调用。把reducer输出的数据写到mysql中</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> write(BaseDimension <span class="built_in">key</span>, BaseStatsValueWritable value) <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">key</span> == <span class="keyword">null</span> || value == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                KpiType kpi = value.getKpi();</span><br><span class="line">                PreparedStatement pstmt = <span class="keyword">null</span>;<span class="comment">//每一个pstmt对象对应一个sql语句</span></span><br><span class="line">                <span class="built_in">int</span> count = <span class="number">1</span>;<span class="comment">//sql语句的批处理，一次执行10</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">map</span>.<span class="built_in">get</span>(kpi) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 使用kpi进行区分，返回sql保存到config中</span></span><br><span class="line">                    pstmt = <span class="keyword">this</span>.conn.prepareStatement(conf.<span class="built_in">get</span>(kpi.name));</span><br><span class="line">                    <span class="built_in">map</span>.put(kpi, pstmt);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    pstmt = <span class="built_in">map</span>.<span class="built_in">get</span>(kpi);</span><br><span class="line">                    count = batch.<span class="built_in">get</span>(kpi);</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">                batch.put(kpi, count); <span class="comment">// 批量次数的存储</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">String</span> collectorName = conf.<span class="built_in">get</span>(GlobalConstants.OUTPUT_COLLECTOR_KEY_PREFIX + kpi.name);</span><br><span class="line">                Class&lt;?&gt; clazz = Class.forName(collectorName);</span><br><span class="line">                IOutputCollector collector = (IOutputCollector) clazz.newInstance();<span class="comment">//把value插入到mysql的方法。由于kpi维度不一样。插入到不能表里面。</span></span><br><span class="line">                collector.collect(conf, <span class="built_in">key</span>, value, pstmt, converter);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (count % Integer.valueOf(conf.<span class="built_in">get</span>(GlobalConstants.JDBC_BATCH_NUMBER, GlobalConstants.DEFAULT_JDBC_BATCH_NUMBER)) == <span class="number">0</span>) &#123;</span><br><span class="line">                    pstmt.executeBatch();</span><br><span class="line">                    conn.commit();</span><br><span class="line">                    batch.put(kpi, <span class="number">0</span>); <span class="comment">// 对应批量计算删除</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                logger.error(<span class="string">"在writer中写数据出现异常"</span>, e);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> close(TaskAttemptContext context) <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;KpiType, PreparedStatement&gt; entry : <span class="keyword">this</span>.<span class="built_in">map</span>.entrySet()) &#123;</span><br><span class="line">                    entry.getValue().executeBatch();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                logger.error(<span class="string">"执行executeUpdate方法异常"</span>, e);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (conn != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        conn.commit(); <span class="comment">// 进行connection的提交动作</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="comment">// nothing</span></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (Map.Entry&lt;KpiType, PreparedStatement&gt; entry : <span class="keyword">this</span>.<span class="built_in">map</span>.entrySet()) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            entry.getValue().close();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                            <span class="comment">// nothing</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (conn != <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            conn.close();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            <span class="comment">// nothing</span></span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><p>run as java application 添加 运行参数  <code>-d 2019-06-15</code></p>
<p>跑出结果，<code>dimension_</code>开头为维度表，<code>stats_</code>开头为真正的统计数据</p>
<h1 id="hive和hbase整合"><a href="#hive和hbase整合" class="headerlink" title="hive和hbase整合"></a>hive和hbase整合</h1><h2 id="参考-6"><a href="#参考-6" class="headerlink" title="参考"></a>参考</h2><blockquote>
<p><a href="https://cwiki.apache.org/confluence/display/Hive/HBaseIntegration" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/HBaseIntegration</a></p>
</blockquote>
<h2 id="配置lib"><a href="#配置lib" class="headerlink" title="配置lib"></a>配置lib</h2><p>把hive-hbase-handler-1.2.1.jar  cp到hbase/lib 下</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp hive-hbase-handler-<span class="number">1.2</span>.<span class="number">1</span>.jar $HBASE_HOME/<span class="class"><span class="keyword">lib</span>/</span></span><br></pre></td></tr></table></figure>
<p>同时把hbase中的所有的jar，cp到hive/lib</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -r $HBASE_HOME/<span class="class"><span class="keyword">lib</span>/* ./</span></span><br></pre></td></tr></table></figure>
<h2 id="在hive的配置文件增加属性："><a href="#在hive的配置文件增加属性：" class="headerlink" title="在hive的配置文件增加属性："></a>在hive的配置文件增加属性：</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>node02,node03,node04<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="在hive中创建临时表"><a href="#在hive中创建临时表" class="headerlink" title="在hive中创建临时表"></a>在hive中创建临时表</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> tmp_order</span><br><span class="line">(<span class="keyword">key</span> <span class="keyword">string</span>, <span class="keyword">id</span> <span class="keyword">string</span>, user_id <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">STORED</span> <span class="keyword">BY</span> <span class="string">'org.apache.hadoop.hive.hbase.HBaseStorageHandler'</span></span><br><span class="line"><span class="keyword">WITH</span> SERDEPROPERTIES (<span class="string">"hbase.columns.mapping"</span> = <span class="string">":key,order:order_id,order:user_id"</span>)</span><br><span class="line">TBLPROPERTIES (<span class="string">"hbase.table.name"</span> = <span class="string">"t_order"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> hbasetbl(<span class="keyword">key</span> <span class="built_in">int</span>, <span class="keyword">value</span> <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">STORED</span> <span class="keyword">BY</span> <span class="string">'org.apache.hadoop.hive.hbase.HBaseStorageHandler'</span></span><br><span class="line"><span class="keyword">WITH</span> SERDEPROPERTIES (<span class="string">"hbase.columns.mapping"</span> = <span class="string">":key,cf1:val"</span>)</span><br><span class="line">TBLPROPERTIES (<span class="string">"hbase.table.name"</span> = <span class="string">"xyz"</span>, <span class="string">"hbase.mapred.output.outputtable"</span> = <span class="string">"xyz"</span>);</span><br></pre></td></tr></table></figure>
<h1 id="hive分析sqoop输出到mysql"><a href="#hive分析sqoop输出到mysql" class="headerlink" title="hive分析sqoop输出到mysql"></a>hive分析sqoop输出到mysql</h1><h2 id="在hive中创建hbase的event-log对应表"><a href="#在hive中创建hbase的event-log对应表" class="headerlink" title="在hive中创建hbase的event_log对应表"></a>在hive中创建hbase的event_log对应表</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> event_logs(</span><br><span class="line"><span class="keyword">key</span> <span class="keyword">string</span>, pl <span class="keyword">string</span>, en <span class="keyword">string</span>, s_time <span class="built_in">bigint</span>, p_url <span class="keyword">string</span>, u_ud <span class="keyword">string</span>, u_sd <span class="keyword">string</span></span><br><span class="line">) <span class="keyword">ROW</span> <span class="keyword">FORMAT</span> SERDE <span class="string">'org.apache.hadoop.hive.hbase.HBaseSerDe'</span></span><br><span class="line"><span class="keyword">STORED</span> <span class="keyword">BY</span> <span class="string">'org.apache.hadoop.hive.hbase.HBaseStorageHandler'</span></span><br><span class="line"><span class="keyword">with</span> serdeproperties(<span class="string">'hbase.columns.mapping'</span>=<span class="string">':key,log:pl,log:en,log:s_time,log:p_url,log:u_ud,log:u_sd'</span>)</span><br><span class="line">tblproperties(<span class="string">'hbase.table.name'</span>=<span class="string">'eventlog'</span>);</span><br></pre></td></tr></table></figure>
<h2 id="创建mysql在hive中的对应表"><a href="#创建mysql在hive中的对应表" class="headerlink" title="创建mysql在hive中的对应表"></a>创建mysql在hive中的对应表</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 2. 创建mysql在hive中的对应表，hive中的表，执行HQL之后分析的结果保存该表，然后通过sqoop工具导出到mysql</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`stats_view_depth`</span> (</span><br><span class="line">  <span class="string">`platform_dimension_id`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`data_dimension_id`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`kpi_dimension_id`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`pv1`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`pv2`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`pv3`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`pv4`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`pv5_10`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`pv10_30`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`pv30_60`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`pv60_plus`</span> <span class="built_in">bigint</span> ,</span><br><span class="line">  <span class="string">`created`</span> <span class="keyword">string</span></span><br><span class="line">) <span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. hive创建临时表:把hql分析之后的中间结果存放到当前的临时表。</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`stats_view_depth_tmp`</span>(<span class="string">`pl`</span> <span class="keyword">string</span>, <span class="string">`date`</span> <span class="keyword">string</span>, <span class="string">`col`</span> <span class="keyword">string</span>, <span class="string">`ct`</span> <span class="built_in">bigint</span>);</span><br></pre></td></tr></table></figure>
<h2 id="编写UDF"><a href="#编写UDF" class="headerlink" title="编写UDF"></a>编写UDF</h2><p>编写<code>UDF(platformdimension &amp; datedimension)</code>需要注意，要删除<code>DimensionConvertClient</code>类中所有<code>FileSystem</code>关闭的操作</p>
<p>node03执行</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">hive</span></span><br></pre></td></tr></table></figure>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add</span><span class="bash"> jar /root/transform_date.jar;</span></span><br></pre></td></tr></table></figure>
<p>创建hive的function</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> date_convert <span class="keyword">as</span> <span class="string">'com.sxt.transformer.hive.DateDimensionUDF'</span>;</span><br></pre></td></tr></table></figure>
<h2 id="统计用户角度的浏览深度"><a href="#统计用户角度的浏览深度" class="headerlink" title="统计用户角度的浏览深度"></a>统计用户角度的浏览深度</h2><h3 id="分析得到临时表stats-view-depth-tmp"><a href="#分析得到临时表stats-view-depth-tmp" class="headerlink" title="分析得到临时表stats_view_depth_tmp"></a>分析得到临时表stats_view_depth_tmp</h3><ul>
<li>tmp表</li>
</ul>
<p>可以将tmp，拆分了看比较清晰。</p>
<p>统计每个用户、每个平台，在当天的访问次数</p>
<ul>
<li>stats_view_depth_tmp</li>
</ul>
<p>groupby pl,day,pv数，将u_ud distinct求和，得出当天的平台的某个pv数的用户数，即pv</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 7. hql编写(统计用户角度的浏览深度)&lt;注意：时间为外部给定&gt;</span></span><br><span class="line">from (</span><br><span class="line">  <span class="keyword">select</span></span><br><span class="line">    pl, from_unixtime(<span class="keyword">cast</span>(s_time/<span class="number">1000</span> <span class="keyword">as</span> <span class="built_in">bigint</span>),<span class="string">'yyyy-MM-dd'</span>) <span class="keyword">as</span> <span class="keyword">day</span>, u_ud,</span><br><span class="line">    (<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">count</span>(p_url) = <span class="number">1</span> <span class="keyword">then</span> <span class="string">"pv1"</span></span><br><span class="line">      <span class="keyword">when</span> <span class="keyword">count</span>(p_url) = <span class="number">2</span> <span class="keyword">then</span> <span class="string">"pv2"</span></span><br><span class="line">      <span class="keyword">when</span> <span class="keyword">count</span>(p_url) = <span class="number">3</span> <span class="keyword">then</span> <span class="string">"pv3"</span></span><br><span class="line">      <span class="keyword">when</span> <span class="keyword">count</span>(p_url) = <span class="number">4</span> <span class="keyword">then</span> <span class="string">"pv4"</span></span><br><span class="line">      <span class="keyword">when</span> <span class="keyword">count</span>(p_url) &gt;= <span class="number">5</span> <span class="keyword">and</span> <span class="keyword">count</span>(p_url) &lt;<span class="number">10</span> <span class="keyword">then</span> <span class="string">"pv5_10"</span></span><br><span class="line">      <span class="keyword">when</span> <span class="keyword">count</span>(p_url) &gt;= <span class="number">10</span> <span class="keyword">and</span> <span class="keyword">count</span>(p_url) &lt;<span class="number">30</span> <span class="keyword">then</span> <span class="string">"pv10_30"</span></span><br><span class="line">      <span class="keyword">when</span> <span class="keyword">count</span>(p_url) &gt;=<span class="number">30</span> <span class="keyword">and</span> <span class="keyword">count</span>(p_url) &lt;<span class="number">60</span> <span class="keyword">then</span> <span class="string">"pv30_60"</span></span><br><span class="line">      <span class="keyword">else</span> <span class="string">'pv60_plus'</span> <span class="keyword">end</span>) <span class="keyword">as</span> pv</span><br><span class="line">  <span class="keyword">from</span> event_logs</span><br><span class="line">  <span class="keyword">where</span></span><br><span class="line">    en=<span class="string">'e_pv'</span></span><br><span class="line">    <span class="keyword">and</span> p_url <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">    <span class="keyword">and</span> pl <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">    <span class="keyword">and</span> s_time &gt;= <span class="keyword">unix_timestamp</span>(<span class="string">'2019-06-15'</span>,<span class="string">'yyyy-MM-dd'</span>)*<span class="number">1000</span></span><br><span class="line">    <span class="keyword">and</span> s_time &lt; <span class="keyword">unix_timestamp</span>(<span class="string">'2019-06-16'</span>,<span class="string">'yyyy-MM-dd'</span>)*<span class="number">1000</span></span><br><span class="line">  <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    pl, from_unixtime(<span class="keyword">cast</span>(s_time/<span class="number">1000</span> <span class="keyword">as</span> <span class="built_in">bigint</span>),<span class="string">'yyyy-MM-dd'</span>), u_ud</span><br><span class="line">) <span class="keyword">as</span> tmp</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> stats_view_depth_tmp</span><br><span class="line">  <span class="keyword">select</span> pl,<span class="keyword">day</span>,pv,<span class="keyword">count</span>(<span class="keyword">distinct</span> u_ud) <span class="keyword">as</span> ct <span class="keyword">where</span> u_ud <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">group</span> <span class="keyword">by</span> pl,<span class="keyword">day</span>,pv;</span><br></pre></td></tr></table></figure>
<h3 id="多行转1行"><a href="#多行转1行" class="headerlink" title="多行转1行"></a>多行转1行</h3><p>平台 日期 pv1 用户数</p>
<p>展开转换为 pv2 pv5 pv10 等都为0</p>
<p>平台 日期 pv1 0 0 0 0 用户数</p>
<table>
<thead>
<tr>
<th>pl</th>
<th>date</th>
<th>pv1</th>
<th>pv2</th>
<th>pv3</th>
<th>pv4</th>
<th>pv5</th>
<th>pv10</th>
<th>pv30</th>
<th>pv60</th>
</tr>
</thead>
<tbody>
<tr>
<td>web_site</td>
<td>2019-06-15</td>
<td>5</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,ct <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus <span class="keyword">from</span> stats_view_depth_tmp <span class="keyword">where</span> <span class="keyword">col</span>=<span class="string">'pv1'</span></span><br></pre></td></tr></table></figure>
<p>这样之后，pv1到pv60，都合并求和。合并成1行。</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">--把临时表的多行数据，转换一行</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tmp <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,ct <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv1'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,ct <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv2'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,ct <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv3'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,ct <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv4'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,ct <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv5_10'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,ct <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv10_30'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,ct <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv30_60'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,ct <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv60_plus'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,ct <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv1'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,ct <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv2'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,ct <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv3'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,ct <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv4'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,ct <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv5_10'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,ct <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv10_30'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,ct <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv30_60'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,<span class="string">`date`</span> <span class="keyword">as</span> date1,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,ct <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv60_plus'</span></span><br><span class="line">)</span><br><span class="line">from tmp</span><br><span class="line">insert overwrite table stats_view_depth</span><br><span class="line"><span class="keyword">select</span> <span class="number">2</span>,<span class="number">3</span>,<span class="number">6</span>,sum(pv1),sum(pv2),sum(pv3),sum(pv4),sum(pv5_10),sum(pv10_30),sum(pv30_60),sum(pv60_plus),<span class="string">'2019-06-15'</span> group by pl,date1;</span><br></pre></td></tr></table></figure>
<p>上面sql中的2，3，6要先计算出来，这里先手工填入。</p>
<h3 id="sqoop脚本编写-统计用户角度"><a href="#sqoop脚本编写-统计用户角度" class="headerlink" title="sqoop脚本编写(统计用户角度)"></a>sqoop脚本编写(统计用户角度)</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqoop export <span class="params">--connect</span> jdbc<span class="function">:mysql</span>:<span class="string">//node01</span><span class="function">:3306</span>/result_db <span class="params">--username</span> root <span class="params">--password</span> 123 <span class="params">--table</span> stats_view_depth <span class="params">--export-dir</span> <span class="string">/user/hive/warehouse/stats_view_depth/</span>* <span class="params">--input-fields-terminated-by</span> <span class="string">"\t"</span> <span class="params">--update-mode</span> allowinsert <span class="params">--update-key</span> platform_dimension_id,data_dimension_id,kpi_dimension_id</span><br></pre></td></tr></table></figure>
<p>–export-dir hive表对应的hdfs位置</p>
<p>–input-fields-terminated-by hive表的字段分隔符</p>
<p>–update-mode 更新模式</p>
<p>–update-key 更新key</p>
<p>成功输出到mysql</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span>	<span class="number">3</span>	<span class="number">6</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">1</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">2019</span><span class="number">-06</span><span class="number">-15</span></span><br></pre></td></tr></table></figure>
<h3 id="shell定时任务"><a href="#shell定时任务" class="headerlink" title="shell定时任务"></a>shell定时任务</h3><p>使用cron 定时执行sqoop命令</p>
<p>参考 ``</p>
<h2 id="统计会话角度的浏览深度"><a href="#统计会话角度的浏览深度" class="headerlink" title="统计会话角度的浏览深度"></a>统计会话角度的浏览深度</h2><h3 id="统计当天每个会话数段的"><a href="#统计当天每个会话数段的" class="headerlink" title="统计当天每个会话数段的"></a>统计当天每个会话数段的</h3><p>tmp表： group by pl,date , u_sd  每个会话id的 pv数</p>
<p>stats_view_depth_tmp： 每个会话数段的 会话数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 8. hql编写(统计会话角度的浏览深度)&lt;注意：时间为外部给定&gt;</span></span><br><span class="line">from (</span><br><span class="line"><span class="keyword">select</span> pl, from_unixtime(<span class="keyword">cast</span>(s_time/<span class="number">1000</span> <span class="keyword">as</span> <span class="built_in">bigint</span>),<span class="string">'yyyy-MM-dd'</span>) <span class="keyword">as</span> <span class="keyword">day</span>, u_sd, (<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">count</span>(p_url) = <span class="number">1</span> <span class="keyword">then</span> <span class="string">"pv1"</span> <span class="keyword">when</span> <span class="keyword">count</span>(p_url) = <span class="number">2</span> <span class="keyword">then</span> <span class="string">"pv2"</span> <span class="keyword">when</span> <span class="keyword">count</span>(p_url) = <span class="number">3</span> <span class="keyword">then</span> <span class="string">"pv3"</span> <span class="keyword">when</span> <span class="keyword">count</span>(p_url) = <span class="number">4</span> <span class="keyword">then</span> <span class="string">"pv4"</span> <span class="keyword">when</span> <span class="keyword">count</span>(p_url) &gt;= <span class="number">5</span> <span class="keyword">and</span> <span class="keyword">count</span>(p_url) &lt;<span class="number">10</span> <span class="keyword">then</span> <span class="string">"pv5_10"</span> <span class="keyword">when</span> <span class="keyword">count</span>(p_url) &gt;= <span class="number">10</span> <span class="keyword">and</span> <span class="keyword">count</span>(p_url) &lt;<span class="number">30</span> <span class="keyword">then</span> <span class="string">"pv10_30"</span> <span class="keyword">when</span> <span class="keyword">count</span>(p_url) &gt;=<span class="number">30</span> <span class="keyword">and</span> <span class="keyword">count</span>(p_url) &lt;<span class="number">60</span> <span class="keyword">then</span> <span class="string">"pv30_60"</span>  <span class="keyword">else</span> <span class="string">'pv60_plus'</span> <span class="keyword">end</span>) <span class="keyword">as</span> pv</span><br><span class="line"><span class="keyword">from</span> event_logs</span><br><span class="line"><span class="keyword">where</span> en=<span class="string">'e_pv'</span> <span class="keyword">and</span> p_url <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">and</span> pl <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">and</span> s_time &gt;= <span class="keyword">unix_timestamp</span>(<span class="string">'2019-06-15'</span>,<span class="string">'yyyy-MM-dd'</span>)*<span class="number">1000</span> <span class="keyword">and</span> s_time &lt; <span class="keyword">unix_timestamp</span>(<span class="string">'2019-06-16'</span>,<span class="string">'yyyy-MM-dd'</span>)*<span class="number">1000</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> pl, from_unixtime(<span class="keyword">cast</span>(s_time/<span class="number">1000</span> <span class="keyword">as</span> <span class="built_in">bigint</span>),<span class="string">'yyyy-MM-dd'</span>), u_sd</span><br><span class="line">) <span class="keyword">as</span> tmp</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> stats_view_depth_tmp <span class="keyword">select</span> pl,<span class="keyword">day</span>,pv,<span class="keyword">count</span>(<span class="keyword">distinct</span> u_sd) <span class="keyword">as</span> ct <span class="keyword">where</span> u_sd <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">group</span> <span class="keyword">by</span> pl,<span class="keyword">day</span>,pv;</span><br></pre></td></tr></table></figure>
<h3 id="多行转1行-1"><a href="#多行转1行-1" class="headerlink" title="多行转1行"></a>多行转1行</h3><p>date_convert 日期转换函数</p>
<p>platform_convert 平台转化函数</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">with</span> tmp <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> pl,date,ct <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv1'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,ct <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv2'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,ct <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv3'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,ct <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv4'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,ct <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv5_10'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,ct <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv10_30'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,ct <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv30_60'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,ct <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv60_plus'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,date,ct <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv1'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,ct <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv2'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,ct <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv3'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,ct <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv4'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,ct <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv5_10'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,ct <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv10_30'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,ct <span class="keyword">as</span> pv30_60,<span class="number">0</span> <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv30_60'</span> <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'all'</span> <span class="keyword">as</span> pl,date,<span class="number">0</span> <span class="keyword">as</span> pv1,<span class="number">0</span> <span class="keyword">as</span> pv2,<span class="number">0</span> <span class="keyword">as</span> pv3,<span class="number">0</span> <span class="keyword">as</span> pv4,<span class="number">0</span> <span class="keyword">as</span> pv5_10,<span class="number">0</span> <span class="keyword">as</span> pv10_30,<span class="number">0</span> <span class="keyword">as</span> pv30_60,ct <span class="keyword">as</span> pv60_plus from stats_view_depth_tmp where col=<span class="string">'pv60_plus'</span></span><br><span class="line">)</span><br><span class="line">from tmp</span><br><span class="line">insert overwrite table stats_view_depth</span><br><span class="line"><span class="keyword">select</span> platform_convert(pl),date_convert(date),<span class="number">6</span>,sum(pv1),sum(pv2),sum(pv3),sum(pv4),sum(pv5_10),sum(pv10_30),sum(pv30_60),sum(pv60_plus),<span class="string">'2019-06-15'</span> group by pl,date;</span><br><span class="line"></span><br><span class="line">-- <span class="number">9</span>. sqoop脚步编写(统计会话角度)</span><br><span class="line">sqoop export --connect <span class="symbol">jdbc:</span><span class="symbol">mysql:</span>/<span class="regexp">/node01:3306/result</span>_db --username root --password <span class="number">123</span> --table stats_view_depth --export-dir /user/hive/warehouse/stats_view_depth/* --input-fields-terminated-by <span class="string">"\t"</span> --update-mode allowinsert --update-key platform_dimension_id,data_dimension_id,kpi_dimension_id</span><br><span class="line"></span><br><span class="line">-- <span class="number">10</span>. shell脚步编写</span><br></pre></td></tr></table></figure>
<h1 id="sqoop"><a href="#sqoop" class="headerlink" title="sqoop"></a>sqoop</h1><ul>
<li><p>将关系数据库（oracle、mysql、postgresql等）数据与hadoop数据进行转换的工具</p>
</li>
<li><p>sqoop由client端直接接入hadoop，任务通过解析生成对应的maprecue执行</p>
</li>
</ul>
<h2 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h2><p>node04中解压安装，注意下载完整版</p>
<blockquote>
<p><a href="http://www.apache.org/dyn/closer.lua/sqoop/1.4.7" target="_blank" rel="external">http://www.apache.org/dyn/closer.lua/sqoop/1.4.7</a></p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp /Users/zhouxiaowu/big-data/sqoop-<span class="number">1.4</span>.<span class="number">7</span><span class="selector-class">.bin__hadoop-2</span>.<span class="number">6.0</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span>  root@node04:/root/</span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv sqoop-<span class="number">1.4</span>.<span class="number">7</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span> /usr/install/</span><br><span class="line">tar -zxvf sqoop-<span class="number">1.4</span>.<span class="number">7</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br></pre></td></tr></table></figure>
<p>配置环境变量</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">SQOOP_HOME</span>=/usr/install/sqoop-1.4.7</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="variable">$PATH</span>:$JAVA_HOME/bin:$ZOOKEEPER_HOME/bin:$HADOOP_HOME/bin:$HADOOP_HOME/sbin:$HBASE_HOME/bin:$SQOOP_HOME/bin</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<p>添加数据库驱动包</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp <span class="regexp">/Users/</span>zhouxiaowu<span class="regexp">/big-data/</span>hadoop项目<span class="number">1</span><span class="regexp">/01资料/</span>mysql-connector-java<span class="number">-5.1</span><span class="number">.26</span>-bin.jar  root<span class="meta">@node</span><span class="number">04:</span><span class="regexp">/root/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv ~/mysql-connector-java<span class="number">-5.1</span><span class="number">.26</span>-bin.jar lib/</span><br></pre></td></tr></table></figure>
<p>重命名配置文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">mv</span> <span class="selector-tag">sqoop-env-template</span><span class="selector-class">.sh</span> <span class="selector-tag">sqoop-env</span><span class="selector-class">.sh</span></span><br></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sqoop </span><span class="string">version</span></span><br><span class="line"><span class="string">sqoop </span><span class="built_in">list-databases</span> -<span class="string">connect </span><span class="string">jdbc:mysql:</span>//<span class="string">node01:3306/</span> -<span class="string">username </span><span class="string">root </span>-<span class="string">password </span><span class="string">123</span></span><br></pre></td></tr></table></figure>
<p>去除警告</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">vi configure-sqoop</span></span><br></pre></td></tr></table></figure>
<p>去掉未安装服务相关内容， 例如（HBase、HCatalog、Accumulo）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">if</span> [ ! -d <span class="string">"<span class="variable">$&#123;HBASE_HOME&#125;</span>"</span> ]; <span class="keyword">then</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  <span class="built_in">echo</span> <span class="string">"Error: <span class="variable">$HBASE_HOME</span> does not exist!"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  <span class="built_in">echo</span> <span class="string">'Please set $HBASE_HOME to the root of your HBase installation.'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  <span class="built_in">exit</span> 1</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="http://sqoop.apache.org/docs/1.4.7/SqoopUserGuide.html" target="_blank" rel="external">http://sqoop.apache.org/docs/1.4.7/SqoopUserGuide.html</a></p>
</blockquote>
<h2 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h2><ul>
<li>命令行方式</li>
<li>文件配置方式</li>
</ul>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$</span> sqoop import --connect jdbc:mysql:<span class="comment">//localhost/db --username foo --table TEST</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">$</span> sqoop --<span class="keyword">options</span>-<span class="keyword">file</span> /users/homer/work/import.txt --<span class="keyword">table</span> TEST</span><br></pre></td></tr></table></figure>
<p>参考</p>
<blockquote>
<p><a href="http://sqoop.apache.org/docs/1.4.6/SqoopUserGuide.html#_literal_sqoop_import_literal" target="_blank" rel="external">http://sqoop.apache.org/docs/1.4.6/SqoopUserGuide.html#_literal_sqoop_import_literal</a></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_test</span><br><span class="line">(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">default</span> <span class="string">'0'</span> <span class="literal">null</span>,</span><br><span class="line">	<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">default</span> <span class="string">''</span> <span class="literal">null</span></span><br><span class="line">)</span><br><span class="line">;</span><br></pre></td></tr></table></figure>
<h3 id="mysql导入到hdfs"><a href="#mysql导入到hdfs" class="headerlink" title="mysql导入到hdfs"></a>mysql导入到hdfs</h3><p><code>vi option1</code></p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import</span><br><span class="line">-<span class="ruby">-connect</span></span><br><span class="line"><span class="ruby"><span class="symbol">jdbc:</span><span class="symbol">mysql:</span>/<span class="regexp">/node01:3306/test</span></span></span><br><span class="line"><span class="ruby">--username</span></span><br><span class="line"><span class="ruby">root</span></span><br><span class="line"><span class="ruby">--password</span></span><br><span class="line"><span class="ruby"><span class="number">123</span></span></span><br><span class="line"><span class="ruby">--as-textfile</span></span><br><span class="line"><span class="ruby">--columns</span></span><br><span class="line"><span class="ruby">id,name</span></span><br><span class="line"><span class="ruby">--table</span></span><br><span class="line"><span class="ruby">t_test</span></span><br><span class="line"><span class="ruby">--delete-target-dir</span></span><br><span class="line"><span class="ruby">--target-dir</span></span><br><span class="line"><span class="ruby">/sqoop/data</span></span><br><span class="line"><span class="ruby">-m</span></span><br><span class="line"><span class="ruby"><span class="number">1</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqoop --<span class="keyword">options</span>-<span class="keyword">file</span> <span class="regexp">/root/</span>sqoop_option<span class="regexp">/option1</span></span><br></pre></td></tr></table></figure>
<h3 id="mysql导入到hdfs，带查询"><a href="#mysql导入到hdfs，带查询" class="headerlink" title="mysql导入到hdfs，带查询"></a>mysql导入到hdfs，带查询</h3><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi optio<span class="symbol">n2</span></span><br></pre></td></tr></table></figure>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import</span><br><span class="line">-<span class="ruby">-connect</span></span><br><span class="line"><span class="ruby"><span class="symbol">jdbc:</span><span class="symbol">mysql:</span>/<span class="regexp">/node01/test</span></span></span><br><span class="line"><span class="ruby">--username</span></span><br><span class="line"><span class="ruby">root</span></span><br><span class="line"><span class="ruby">--password</span></span><br><span class="line"><span class="ruby"><span class="number">123</span></span></span><br><span class="line"><span class="ruby">--as-textfile</span></span><br><span class="line"><span class="ruby">--query</span></span><br><span class="line"><span class="ruby"><span class="string">'select id, name, msg from psn where id like "1%" and $CONDITIONS'</span></span></span><br><span class="line"><span class="ruby">--delete-target-dir</span></span><br><span class="line"><span class="ruby">--target-dir</span></span><br><span class="line"><span class="ruby">/sqoop/tmp</span></span><br><span class="line"><span class="ruby">-m</span></span><br><span class="line"><span class="ruby"><span class="number">1</span></span></span><br><span class="line"><span class="ruby">--hive-home</span></span><br><span class="line"><span class="ruby">/home/hive-<span class="number">1.2</span>.<span class="number">1</span></span></span><br><span class="line"><span class="ruby">--hive-import</span></span><br><span class="line"><span class="ruby">--create-hive-table</span></span><br><span class="line"><span class="ruby">--hive-table</span></span><br><span class="line"><span class="ruby">t_test</span></span><br></pre></td></tr></table></figure>
<h2 id="导出"><a href="#导出" class="headerlink" title="导出"></a>导出</h2><p>参考</p>
<blockquote>
<p><a href="http://sqoop.apache.org/docs/1.4.6/SqoopUserGuide.html#_literal_sqoop_export_literal" target="_blank" rel="external">http://sqoop.apache.org/docs/1.4.6/SqoopUserGuide.html#_literal_sqoop_export_literal</a></p>
</blockquote>
<p>创建mysql表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_test2</span><br><span class="line">(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">default</span> <span class="string">'0'</span> <span class="literal">null</span>,</span><br><span class="line">	<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">default</span> <span class="string">''</span> <span class="literal">null</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>创建命令配置</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi optio<span class="symbol">n3</span></span><br></pre></td></tr></table></figure>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">export</span><br><span class="line">-<span class="ruby">-connect</span></span><br><span class="line"><span class="ruby"><span class="symbol">jdbc:</span><span class="symbol">mysql:</span>/<span class="regexp">/node01/test</span></span></span><br><span class="line"><span class="ruby">--username</span></span><br><span class="line"><span class="ruby">root</span></span><br><span class="line"><span class="ruby">--password</span></span><br><span class="line"><span class="ruby"><span class="number">123</span></span></span><br><span class="line"><span class="ruby">-m</span></span><br><span class="line"><span class="ruby"><span class="number">1</span></span></span><br><span class="line"><span class="ruby">--columns</span></span><br><span class="line"><span class="ruby">id,name</span></span><br><span class="line"><span class="ruby">--export-dir</span></span><br><span class="line"><span class="ruby">/sqoop/data</span></span><br><span class="line"><span class="ruby">--table</span></span><br><span class="line"><span class="ruby">t_test2</span></span><br></pre></td></tr></table></figure>
<p>执行</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqoop --<span class="keyword">options</span>-<span class="keyword">file</span> <span class="regexp">/root/</span>sqoop_option<span class="regexp">/option3</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/06/12/java线程池设置指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/12/java线程池设置指南/" itemprop="url">java线程池设置指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-12T09:46:56+08:00">
                2019-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java基础/" itemprop="url" rel="index">
                    <span itemprop="name">java基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/12/java线程池设置指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/06/12/java线程池设置指南/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  273
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="线程数设置公式"><a href="#线程数设置公式" class="headerlink" title="线程数设置公式"></a>线程数设置公式</h2><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">最佳线程数目 = （（线程等待时间+线程<span class="meta">CPU</span>时间）/线程<span class="meta">CPU</span>时间 ）* <span class="meta">CPU</span>数目</span><br></pre></td></tr></table></figure>
<p><strong>服务器CPU核数为4核，一个任务线程cpu耗时为20ms，线程等待（网络IO、磁盘IO）耗时80ms，那最佳线程数目：( 80 + 20 )/20 * 4 = 20</strong>。也就是设置20个线程数最佳。</p>
<p>从这个公式上面我们就得出，<strong>线程的等待时间越大，线程数就要设置越大</strong>，这个正好符合我们上面的分析，可提升CPU利用率。那从另一个角度上面说，<strong>线程数设置多大，是根据我们自身的业务的，需要自己去压力测试，设置一个合理的数值。</strong></p>
<h2 id="常用标准设置"><a href="#常用标准设置" class="headerlink" title="常用标准设置"></a>常用标准设置</h2><p><strong>CPU密集型：</strong>操作内存处理的业务，一般线程数设置为：CPU核数 + 1 或者 CPU核数<em>2<br>核数为4的话，一般设置 5 或 8<br><em>*IO密集型：</em></em> 文件操作，网络操作，数据库操作，一般线程设置为：cpu核数 / (1-0.9)<br>核数为4的话，一般设置 40</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/06/11/jfr采集使用及jmc分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/11/jfr采集使用及jmc分析/" itemprop="url">jfr采集使用及jmc分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-11T10:49:20+08:00">
                2019-06-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/线上故障排查/" itemprop="url" rel="index">
                    <span itemprop="name">线上故障排查</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/11/jfr采集使用及jmc分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/06/11/jfr采集使用及jmc分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  195
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="找到java进程"><a href="#找到java进程" class="headerlink" title="找到java进程"></a>找到java进程</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ps</span> -ef | <span class="keyword">grep</span> java</span><br></pre></td></tr></table></figure>
<h2 id="解锁Java程序的商业特性"><a href="#解锁Java程序的商业特性" class="headerlink" title="解锁Java程序的商业特性"></a>解锁Java程序的商业特性</h2><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jcmd 12174 VM.check_commercial_features</span><br><span class="line"></span><br><span class="line">12174:</span><br><span class="line">Commercial Features <span class="keyword">are</span> <span class="keyword">locked</span>.</span><br></pre></td></tr></table></figure>
<h2 id="采集JFR"><a href="#采集JFR" class="headerlink" title="采集JFR"></a>采集JFR</h2><h3 id="固定时长采集"><a href="#固定时长采集" class="headerlink" title="固定时长采集"></a>固定时长采集</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jcmd <span class="variable">$pid</span> JFR.start <span class="attribute">name</span>=myrec <span class="attribute">settings</span>=temple <span class="attribute">delay</span>=20s <span class="attribute">duration</span>=2m <span class="attribute">filename</span>=/tmp/$pid.jfr</span><br><span class="line"></span><br><span class="line">jcmd 12174 JFR.start <span class="attribute">name</span>=10min.jfr <span class="attribute">settings</span>=profile <span class="attribute">delay</span>=3s <span class="attribute">duration</span>=5m</span><br></pre></td></tr></table></figure>
<h3 id="持续采集JFR"><a href="#持续采集JFR" class="headerlink" title="持续采集JFR"></a>持续采集JFR</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jcmd 12174 JFR.start <span class="attribute">name</span>=endless <span class="attribute">settings</span>=profile <span class="attribute">delay</span>=3s <span class="attribute">duration</span>=0  <span class="attribute">compress</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>对于这种持续采集的任务，我们需要手动转存：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jcmd 12174 JFR.dump <span class="attribute">recording</span>=3 <span class="attribute">filename</span>=<span class="string">"/Users/jianyuan/Personal/dump_endless.jfr"</span> <span class="attribute">compress</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="分析JFR文件"><a href="#分析JFR文件" class="headerlink" title="分析JFR文件"></a>分析JFR文件</h2><p>线下输入<code>jmc</code></p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">jmc</span></span><br></pre></td></tr></table></figure>
<p>打开<code>java mission control</code></p>
<p>选择打开导出的jfr文件</p>
<h3 id="分析角度"><a href="#分析角度" class="headerlink" title="分析角度"></a>分析角度</h3><p>一般来说可以从下面几个方式来入手：</p>
<ul>
<li>应用异常</li>
<li>热点线程和方法</li>
<li>不合预期的IO</li>
<li>过长的GC</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><blockquote>
<p><a href="https://blog.csdn.net/yue530tomtom/article/details/80805412" target="_blank" rel="external">https://blog.csdn.net/yue530tomtom/article/details/80805412</a></p>
<p><a href="http://www.manongjc.com/article/7589.html" target="_blank" rel="external">http://www.manongjc.com/article/7589.html</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/06/11/Arthas使用文档/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/11/Arthas使用文档/" itemprop="url">Arthas使用文档</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-11T09:51:12+08:00">
                2019-06-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/线上故障排查/" itemprop="url" rel="index">
                    <span itemprop="name">线上故障排查</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/11/Arthas使用文档/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/06/11/Arthas使用文档/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  92
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="手动安装推荐"><a href="#手动安装推荐" class="headerlink" title="手动安装推荐"></a>手动安装推荐</h2><p><a href="https://alibaba.github.io/arthas/manual-install.html" target="_blank" rel="external">https://alibaba.github.io/arthas/manual-install.html</a></p>
<h1 id="使用命令"><a href="#使用命令" class="headerlink" title="使用命令"></a>使用命令</h1><h2 id="watch-查看方法的返回值"><a href="#watch-查看方法的返回值" class="headerlink" title="watch 查看方法的返回值"></a>watch 查看方法的返回值</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">watch demo<span class="selector-class">.MathGame</span> primeFactors returnObj</span><br><span class="line">watch</span><br></pre></td></tr></table></figure>
<h2 id="stack-查看方法调用栈"><a href="#stack-查看方法调用栈" class="headerlink" title="stack 查看方法调用栈"></a>stack 查看方法调用栈</h2><p>参考</p>
<blockquote>
<p><a href="https://alibaba.github.io/arthas/stack.html" target="_blank" rel="external">https://alibaba.github.io/arthas/stack.html</a></p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stack demo<span class="selector-class">.MathGame</span> primeFactors</span><br></pre></td></tr></table></figure>
<h2 id="thread"><a href="#thread" class="headerlink" title="thread"></a>thread</h2><p>参考</p>
<blockquote>
<p><a href="https://alibaba.github.io/arthas/thread.html" target="_blank" rel="external">https://alibaba.github.io/arthas/thread.html</a></p>
</blockquote>
<h3 id="当前最忙的前N个线程"><a href="#当前最忙的前N个线程" class="headerlink" title="当前最忙的前N个线程"></a>当前最忙的前N个线程</h3><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">thread</span> -n <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h3 id="找出当前阻塞其他线程的线程"><a href="#找出当前阻塞其他线程的线程" class="headerlink" title="找出当前阻塞其他线程的线程"></a>找出当前阻塞其他线程的线程</h3><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">thread</span> -b</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/06/08/HBase原理案例及搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/08/HBase原理案例及搭建/" itemprop="url">HBase原理案例及搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-08T11:16:12+08:00">
                2019-06-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/08/HBase原理案例及搭建/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/06/08/HBase原理案例及搭建/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  8
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="HBase-数据模型"><a href="#HBase-数据模型" class="headerlink" title="HBase 数据模型"></a>HBase 数据模型</h1><table>
<thead>
<tr>
<th>Row   Key</th>
<th>Time   Stamp</th>
<th>CF1</th>
<th>CF2</th>
<th>CF3</th>
</tr>
</thead>
<tbody>
<tr>
<td>11248112</td>
<td>t6</td>
<td></td>
<td>CF2:q1=val1</td>
<td>CF3:q3=val3</td>
</tr>
<tr>
<td></td>
<td>t3</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>t2</td>
<td>CF1:q2=val2</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="ROW-KEY"><a href="#ROW-KEY" class="headerlink" title="ROW  KEY"></a>ROW  KEY</h2><ul>
<li>决定一行数据</li>
<li>按照字典顺序排序的。</li>
<li>Row key只能存储64k的字节数据</li>
</ul>
<h2 id="Column-Family列族"><a href="#Column-Family列族" class="headerlink" title="Column Family列族"></a>Column Family列族</h2><ul>
<li><p>HBase表中的每个列都归属于某个列族，列族必须作为表模式(schema)定义的一部分预先给出。如<code>create &#39;tbl&#39;, ‘cf’</code></p>
</li>
<li><p>列名以列族作为前缀，<code>cf:name</code></p>
</li>
<li><p>权限控制、存储以及调优都是在列族层面进行的；</p>
</li>
<li>HBase把同一列族里面的数据存储在同一目录下，由几个文件保存。</li>
</ul>
<h2 id="Timestamp时间戳"><a href="#Timestamp时间戳" class="headerlink" title="Timestamp时间戳"></a>Timestamp时间戳</h2><ul>
<li>在HBase每个cell存储单元对同一份数据有多个版本，根据唯一的时间戳来区分每个版本之间的差异，不同版本的数据按照时间倒序排序，最新的数据版本排在最前面。</li>
<li>时间戳的类型是 64位整型。</li>
<li>时间戳可以由HBase(在数据写入时自动)赋值，此时时间戳是精确到毫秒的当前系统时间。</li>
<li>时间戳也可以由客户显式赋值，如果应用程序要避免数据版本冲突，就必须自己生成具有唯一性的时间戳。</li>
</ul>
<h2 id="Cell单元格"><a href="#Cell单元格" class="headerlink" title="Cell单元格"></a>Cell单元格</h2><ul>
<li><p>由<code>{row key， column(&lt;family&gt; +&lt;qualifier&gt;)， version}</code>唯一确定的单元。</p>
</li>
<li><p>cell中的数据是没有类型的，全部是字节码形式存贮。</p>
</li>
</ul>
<h2 id="HLog-WAL-log"><a href="#HLog-WAL-log" class="headerlink" title="HLog(WAL log)"></a>HLog(WAL log)</h2><ul>
<li><p>HLog文件就是一个普通的Hadoop Sequence File，Sequence File 的Key是HLogKey对象，HLogKey中记录了写入数据的归属信息，除了table和region名字外，同时还包括 sequence number和timestamp，timestamp是” 写入时间”，sequence number的起始值为0，或者是最近一次存入文件系统中sequence number。</p>
</li>
<li><p>类似binlog</p>
</li>
</ul>
<h1 id="HBase-架构"><a href="#HBase-架构" class="headerlink" title="HBase 架构"></a>HBase 架构</h1><p><img src="/2019/06/08/HBase原理案例及搭建/01.png" alt="01"></p>
<h2 id="写流程"><a href="#写流程" class="headerlink" title="写流程"></a>写流程</h2><ul>
<li>client记录写入数据，到Hlog</li>
<li>memstore</li>
<li>memstore达到阈值,写入到store file</li>
</ul>
<h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><ul>
<li>包含访问HBase的接口并维护cache来加快对HBase的访问</li>
</ul>
<h2 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a>Zookeeper</h2><ul>
<li><p>保证任何时候，集群中只有一个master</p>
</li>
<li><p>存贮所有Region的寻址入口。</p>
</li>
<li><p>实时监控Region server的上线和下线信息。并实时通知Master</p>
</li>
<li><p>存储HBase的schema和table元数据</p>
</li>
</ul>
<h2 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h2><ul>
<li><p>为Region server分配region</p>
</li>
<li><p>负责Region server的负载均衡</p>
</li>
<li><p>发现失效的Region server并重新分配其上的region</p>
</li>
<li><p>管理用户对table的增删改操作</p>
</li>
</ul>
<h2 id="RegionServer"><a href="#RegionServer" class="headerlink" title="RegionServer"></a>RegionServer</h2><ul>
<li><p>Region server维护region，处理对这些region的IO请求</p>
</li>
<li><p>Region server负责切分在运行过程中变得过大的region</p>
</li>
</ul>
<h2 id="Region"><a href="#Region" class="headerlink" title="Region"></a>Region</h2><ul>
<li><p>HBase自动把表水平划分成多个区域(region)，每个region会保存一个表里面某段连续的数据</p>
</li>
<li><p>每个表一开始只有一个region，随着数据不断插入表，region不断增大，当增大到一个阀值的时候，region就会等分会两个新的region（裂变）</p>
</li>
<li>当table中的行不断增多，就会有越来越多的region。这样一张完整的表被保存在多个Regionserver 上。</li>
</ul>
<p><img src="/2019/06/08/HBase原理案例及搭建/02.png" alt="01"></p>
<ul>
<li><p>HRegion是HBase中分布式存储和负载均衡的最小单元。最小单元就表示不同的HRegion可以分布在不同的 HRegion server上。</p>
</li>
<li><p>HRegion由一个或者多个Store组成，每个store保存一个columns family。</p>
</li>
<li><p>每个Strore又由一个memStore和0至多个StoreFile组成。如图：StoreFile以HFile格式保存在HDFS上。</p>
</li>
</ul>
<h2 id="memstore-与-storefile"><a href="#memstore-与-storefile" class="headerlink" title="memstore 与 storefile"></a>memstore 与 storefile</h2><ul>
<li><p>一个region由多个store组成，一个store对应一个CF（列族）</p>
</li>
<li><p>store包括位于内存中的<strong>memstore</strong>和位于磁盘的<strong>storefile</strong>写操作<u>先写入memstore</u>，<u>当memstore中的数据达到某个阈值，hregionserver会启动flashcache进程写入storefile</u>，每次写入形成单独的一个storefile</p>
</li>
<li><p><u>当storefile文件的数量增长到一定阈值后，系统会进行合并</u>（minor、major compaction），在合并过程中会进行版本合并和删除工作（majar），形成更大的storefile</p>
</li>
<li><p>当一个region所有storefile的大小和数量超过一定阈值后，会把当前的region分割为两个，并由hmaster分配到相应的regionserver服务器，实现负载均衡</p>
</li>
<li><p>客户端检索数据，先在memstore找，找不到再找storefile</p>
</li>
</ul>
<p><img src="/2019/06/08/HBase原理案例及搭建/03.png" alt="01"></p>
<ul>
<li>SequeceFile的Value是HBase的KeyValue对象，即对应HFile中的KeyValue</li>
<li>StoreFile 等价于hdfs file</li>
</ul>
<h2 id="读顺序"><a href="#读顺序" class="headerlink" title="读顺序"></a>读顺序</h2><ul>
<li>1.读memstore，没有则下一步</li>
<li>2.读block cache，没有则下一步</li>
<li>3.读store file</li>
</ul>
<p>写顺序</p>
<ul>
<li>1.写memstore，达到阈值，下一步</li>
<li>2.写store file</li>
</ul>
<h1 id="HBase-完全HA分布式搭建"><a href="#HBase-完全HA分布式搭建" class="headerlink" title="HBase 完全HA分布式搭建"></a>HBase 完全HA分布式搭建</h1><table>
<thead>
<tr>
<th></th>
<th>zookeeper</th>
<th>master</th>
<th>region server</th>
<th>master backup</th>
</tr>
</thead>
<tbody>
<tr>
<td>node01</td>
<td></td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td>node02</td>
<td>*</td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td>node03</td>
<td>*</td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td>node04</td>
<td>*</td>
<td></td>
<td></td>
<td>*</td>
</tr>
</tbody>
</table>
<h3 id="hbase-env-sh-配置"><a href="#hbase-env-sh-配置" class="headerlink" title="hbase-env.sh 配置"></a>hbase-env.sh 配置</h3><p>conf中</p>
<ul>
<li>jdk地址</li>
<li>使用自己配置zk，不适用hbase自带内置的zk</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi hbase-env.sh</span><br><span class="line"></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">JAVA_HOME</span>=/usr/install/jdk/jdk1.8.0_171/</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">HBASE_MANAGES_ZK</span>=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h3 id="hbase-site-xml配置"><a href="#hbase-site-xml配置" class="headerlink" title="hbase-site.xml配置"></a>hbase-site.xml配置</h3><ul>
<li>hbase在hdfs的目录</li>
<li>是否分布式</li>
<li>zk地址</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vi hbase-site.xml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rootdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://mycluster/hbase<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.cluster.distributed<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>node02,node03,node04<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="regionservers配置"><a href="#regionservers配置" class="headerlink" title="regionservers配置"></a>regionservers配置</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">vi</span> regionservers</span><br><span class="line"></span><br><span class="line">node02 node03</span><br></pre></td></tr></table></figure>
<h3 id="backup-masters配置"><a href="#backup-masters配置" class="headerlink" title="backup-masters配置"></a>backup-masters配置</h3><p>添加 backup-masters</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">vi</span> <span class="keyword">backup-masters</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">node04</span></span><br></pre></td></tr></table></figure>
<h3 id="hdfs-site-xml复制"><a href="#hdfs-site-xml复制" class="headerlink" title="hdfs-site.xml复制"></a>hdfs-site.xml复制</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp <span class="regexp">/opt/</span>sxt<span class="regexp">/hadoop-2.6.5/</span>etc<span class="regexp">/hadoop/</span>hdfs-site.xml .<span class="regexp">/</span></span><br></pre></td></tr></table></figure>
<h3 id="环境变量配置"><a href="#环境变量配置" class="headerlink" title="环境变量配置"></a>环境变量配置</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">HBASE_HOME</span>=/root/hbase-0.98.12.1-hadoop2</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="variable">$PATH</span>:$ZOOKEEPER_HOME/bin:$HADOOP_HOME/bin:$HADOOP_HOME/sbin:$HBASE_HOME/bin</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<p>注意各节点的时间一致</p>
<h3 id="给其他节点scp一份"><a href="#给其他节点scp一份" class="headerlink" title="给其他节点scp一份"></a>给其他节点scp一份</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp -r hbase-<span class="number">0</span>.<span class="number">98.12</span>.<span class="number">1</span>-hadoop2 root<span class="variable">@node02</span><span class="symbol">:/root/</span></span><br><span class="line">scp -r hbase-<span class="number">0</span>.<span class="number">98.12</span>.<span class="number">1</span>-hadoop2 root<span class="variable">@node03</span><span class="symbol">:/root/</span></span><br><span class="line">scp -r hbase-<span class="number">0</span>.<span class="number">98.12</span>.<span class="number">1</span>-hadoop2 root<span class="variable">@node04</span><span class="symbol">:/root/</span></span><br></pre></td></tr></table></figure>
<h3 id="启动start-hbase-sh"><a href="#启动start-hbase-sh" class="headerlink" title="启动start-hbase.sh"></a>启动start-hbase.sh</h3><p>需要提前启动node02、03、04的zk，start-hdfs.sh服务</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">start</span>-hbase.sh</span><br></pre></td></tr></table></figure>
<h3 id="验证是否启动成功"><a href="#验证是否启动成功" class="headerlink" title="验证是否启动成功"></a>验证是否启动成功</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hbase <span class="keyword">shell</span><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="built_in">help</span></span></span><br><span class="line"><span class="bash">create <span class="string">'tbl'</span>,<span class="string">'cf'</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hbase(main)<span class="symbol">:023</span><span class="symbol">:0</span>&gt; scan 'tbl'</span><br><span class="line"><span class="built_in">ROW</span>                                <span class="built_in">COLUMN</span>+<span class="built_in">CELL</span></span><br><span class="line"> <span class="number">1111</span>                              <span class="built_in">column</span>=<span class="symbol">cf:ag</span>e, timestamp=<span class="number">1559984836555</span>, <span class="built_in">value</span>=<span class="number">12</span></span><br><span class="line"> <span class="number">1111</span>                              <span class="built_in">column</span>=<span class="symbol">cf:na</span>me, timestamp=<span class="number">1559984734803</span>, <span class="built_in">value</span>=zhangsan</span><br><span class="line"> <span class="number">2222</span>                              <span class="built_in">column</span>=<span class="symbol">cf:se</span>x, timestamp=<span class="number">1559984896283</span>, <span class="built_in">value</span>=boy</span><br><span class="line"><span class="number">2</span> <span class="built_in">row</span>(s) in <span class="number">0.0480</span> seconds</span><br></pre></td></tr></table></figure>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get 'tbl','<span class="number">1111</span>'</span><br></pre></td></tr></table></figure>
<ul>
<li>数据内容先写到memstore</li>
<li>执行<code>flush</code>，查看filestore</li>
</ul>
<blockquote>
<p><a href="http://node02:50070/explorer.html#/hbase/data/default/tbl/78a2935308b5f14d4c23a999ee797ed2/cf" target="_blank" rel="external">http://node02:50070/explorer.html#/hbase/data/default/tbl/78a2935308b5f14d4c23a999ee797ed2/cf</a></p>
</blockquote>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">flush</span> <span class="string">'tbl'</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="http://node02:50070/explorer.html#/hbase/data/default/tbl" target="_blank" rel="external">http://node02:50070/explorer.html#/hbase/data/default/tbl</a></p>
</blockquote>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">node01:</span><span class="number">60010</span></span><br></pre></td></tr></table></figure>
<h1 id="DDL操作"><a href="#DDL操作" class="headerlink" title="DDL操作"></a>DDL操作</h1><h2 id="进入client-shell"><a href="#进入client-shell" class="headerlink" title="进入client shell"></a>进入client shell</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hbase <span class="keyword">shell</span><span class="bash"></span></span><br></pre></td></tr></table></figure>
<h2 id="帮助"><a href="#帮助" class="headerlink" title="帮助"></a>帮助</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">help</span></span><br></pre></td></tr></table></figure>
<h2 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h2><p>列族数量2到3个</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">create</span> <span class="string">'tbl'</span>,<span class="string">'cf1'</span>,<span class="string">'cf2'</span></span><br></pre></td></tr></table></figure>
<h2 id="描述表"><a href="#描述表" class="headerlink" title="描述表"></a>描述表</h2><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">desc</span> <span class="string">'tbl'</span></span><br></pre></td></tr></table></figure>
<h3 id="列表list"><a href="#列表list" class="headerlink" title="列表list"></a>列表list</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">list</span></span><br></pre></td></tr></table></figure>
<h2 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">disable</span> <span class="string">'tbl'</span></span><br><span class="line">drop <span class="string">'tbl'</span></span><br></pre></td></tr></table></figure>
<h2 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h2><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">put 'tbl','<span class="number">1111</span>','cf:name','zhangsan'</span><br><span class="line">put 'tbl','<span class="number">1111</span>','cf:age','12'</span><br><span class="line">put 'tbl','<span class="number">2222</span>','cf:sex','boy'</span><br></pre></td></tr></table></figure>
<p>flush数据，memstore立即到store file，到hdfs中</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">flush</span> <span class="string">'tbl'</span></span><br></pre></td></tr></table></figure>
<h2 id="查看数据"><a href="#查看数据" class="headerlink" title="查看数据"></a>查看数据</h2><h3 id="查看全表"><a href="#查看全表" class="headerlink" title="查看全表"></a>查看全表</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">scan</span> <span class="string">'tbl'</span></span><br></pre></td></tr></table></figure>
<h3 id="查看单条"><a href="#查看单条" class="headerlink" title="查看单条"></a>查看单条</h3><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get 'tbl','<span class="number">1111</span>'</span><br></pre></td></tr></table></figure>
<h3 id="溢写数据"><a href="#溢写数据" class="headerlink" title="溢写数据"></a>溢写数据</h3><p><code>hbase shell</code>执行</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">flush</span> <span class="string">'eventlog'</span></span><br></pre></td></tr></table></figure>
<h3 id="查看hdfs的存储文件"><a href="#查看hdfs的存储文件" class="headerlink" title="查看hdfs的存储文件"></a>查看hdfs的存储文件</h3><p>hdfs查看目录 /hbase/data/default/eventlog/43169c43dc06d3e24836e3291149f8e5/log</p>
<p>直接服务器执行</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hbase hfile -p -f <span class="regexp">/hbase/</span>data<span class="regexp">/default/</span>eventlog<span class="regexp">/43169c43dc06d3e24836e3291149f8e5/</span>log<span class="regexp">/9bb18168d5e2437491a5adeaae62f864</span></span><br></pre></td></tr></table></figure>
<h1 id="hbase-java实战"><a href="#hbase-java实战" class="headerlink" title="hbase java实战"></a>hbase java实战</h1><h2 id="表创建"><a href="#表创建" class="headerlink" title="表创建"></a>表创建</h2><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> void createTable() &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		Configuration conf = <span class="keyword">new</span> <span class="type">Configuration</span>();</span><br><span class="line">		conf.<span class="keyword">set</span>(<span class="string">"hbase.zookeeper.quorum"</span>, <span class="string">"node02,node03,node04"</span>);</span><br><span class="line">		admin = <span class="keyword">new</span> <span class="type">HBaseAdmin</span>(conf);</span><br><span class="line"></span><br><span class="line">		HTableDescriptor desc = <span class="keyword">new</span> <span class="type">HTableDescriptor</span>(tableName);</span><br><span class="line">		HColumnDescriptor columnDescriptor = <span class="keyword">new</span> <span class="type">HColumnDescriptor</span>(<span class="string">"cf"</span>);</span><br><span class="line">		desc.addFamily(columnDescriptor);</span><br><span class="line">		admin.createTable(desc);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (admin != <span class="literal">null</span>) &#123;</span><br><span class="line">			admin.close();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> handle exception</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h2><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> insertTable() &#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">try</span> &#123;</span><br><span class="line">		Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">		conf.set(<span class="string">"hbase.zookeeper.quorum"</span>, <span class="string">"node02,node03,node04"</span>);</span><br><span class="line"></span><br><span class="line">		HTable hTable = <span class="keyword">new</span> HTable(conf, tableName);</span><br><span class="line"></span><br><span class="line">		Put <span class="built_in">put</span> = <span class="keyword">new</span> Put(<span class="string">"1111"</span>.getBytes());</span><br><span class="line">		<span class="built_in">put</span>.add(<span class="string">"cf"</span>.getBytes(), <span class="string">"name"</span>.getBytes(), <span class="string">"zhangsan"</span>.getBytes());</span><br><span class="line">		<span class="built_in">put</span>.add(<span class="string">"cf"</span>.getBytes(), <span class="string">"age"</span>.getBytes(), <span class="string">"12"</span>.getBytes());</span><br><span class="line">		<span class="built_in">put</span>.add(<span class="string">"cf"</span>.getBytes(), <span class="string">"sex"</span>.getBytes(), <span class="string">"boy"</span>.getBytes());</span><br><span class="line">		hTable.<span class="built_in">put</span>(<span class="built_in">put</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">if</span> (admin != null) &#123;</span><br><span class="line">			admin.<span class="built_in">close</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="built_in">catch</span> (Exception e) &#123;</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> handle exception</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> getTable() &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">			conf.<span class="built_in">set</span>(<span class="string">"hbase.zookeeper.quorum"</span>, <span class="string">"node02,node03,node04"</span>);</span><br><span class="line"></span><br><span class="line">			HTable hTable = <span class="keyword">new</span> HTable(conf, tableName);</span><br><span class="line"></span><br><span class="line">			Get <span class="built_in">get</span> = <span class="keyword">new</span> Get(<span class="string">"1111"</span>.getBytes());</span><br><span class="line">			<span class="comment">// define return columns in family</span></span><br><span class="line">			<span class="built_in">get</span>.addColumn(<span class="string">"cf"</span>.getBytes(), <span class="string">"name"</span>.getBytes());</span><br><span class="line">			<span class="built_in">get</span>.addColumn(<span class="string">"cf"</span>.getBytes(), <span class="string">"age"</span>.getBytes());</span><br><span class="line">			<span class="built_in">get</span>.addColumn(<span class="string">"cf"</span>.getBytes(), <span class="string">"sex"</span>.getBytes());</span><br><span class="line"></span><br><span class="line">			Result result = hTable.<span class="built_in">get</span>(<span class="built_in">get</span>);</span><br><span class="line">			Cell cell = result.getColumnLatestCell(<span class="string">"cf"</span>.getBytes(), <span class="string">"name"</span>.getBytes());</span><br><span class="line">			Cell cell2 = result.getColumnLatestCell(<span class="string">"cf"</span>.getBytes(), <span class="string">"age"</span>.getBytes());</span><br><span class="line">			Cell cell3 = result.getColumnLatestCell(<span class="string">"cf"</span>.getBytes(), <span class="string">"sex"</span>.getBytes());</span><br><span class="line"><span class="comment">//			System.out.println(new String( cell.getValue()));</span></span><br><span class="line">			System.out.<span class="built_in">println</span>(<span class="keyword">new</span> <span class="keyword">String</span>(CellUtil.cloneValue(cell)));</span><br><span class="line">			System.out.<span class="built_in">println</span>(<span class="keyword">new</span> <span class="keyword">String</span>(CellUtil.cloneValue(cell2)));</span><br><span class="line">			System.out.<span class="built_in">println</span>(<span class="keyword">new</span> <span class="keyword">String</span>(CellUtil.cloneValue(cell3)));</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (admin != <span class="keyword">null</span>) &#123;</span><br><span class="line">				admin.close();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="comment">// <span class="doctag">TODO:</span> handle exception</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Hbase出现ServerNotRunningYetException的解决方案"><a href="#Hbase出现ServerNotRunningYetException的解决方案" class="headerlink" title="Hbase出现ServerNotRunningYetException的解决方案"></a>Hbase出现ServerNotRunningYetException的解决方案</h1><p>因为hadoop处在安全模式下。所以hbase的操作会出现异常。</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">hadoop dfsadmin -safemode leave</span></span><br></pre></td></tr></table></figure>
<h1 id="hbase-shell中使用list命令报错"><a href="#hbase-shell中使用list命令报错" class="headerlink" title="hbase shell中使用list命令报错"></a>hbase shell中使用list命令报错</h1><blockquote>
<p><a href="https://blog.csdn.net/hll19950830/article/details/80022676" target="_blank" rel="external">https://blog.csdn.net/hll19950830/article/details/80022676</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/xiaowu_avatar.jpg"
                alt="周小伍 Joey" />
            
              <p class="site-author-name" itemprop="name">周小伍 Joey</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">150</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">周小伍 Joey</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">276.8k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    
      <script id="dsq-count-scr" src="https://joeyblog.disqus.com/count.js" async></script>
    

    

  




	





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
