<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="xiaowu&#39;s blog">
<meta property="og:url" content="https://zhouxiaowu.coding.me/page/2/index.html">
<meta property="og:site_name" content="xiaowu&#39;s blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="xiaowu&#39;s blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhouxiaowu.coding.me/page/2/"/>





  <title>xiaowu's blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3da41265a1a0042eebe5413c0d6c76f5";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">xiaowu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-dubbo">
          <a href="/categories/Dubbo" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            Dubbo
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/05/21/Hive原理案例及搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/21/Hive原理案例及搭建/" itemprop="url">Hive原理案例及搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-21T08:06:27+08:00">
                2019-05-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/05/21/Hive原理案例及搭建/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/05/21/Hive原理案例及搭建/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  11
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Hive搭建"><a href="#Hive搭建" class="headerlink" title="Hive搭建"></a>Hive搭建</h2><h3 id="in-memory-derby"><a href="#in-memory-derby" class="headerlink" title="in-memory derby"></a>in-memory derby</h3><p>内存数据库，实际不用</p>
<h3 id="远程服务器模式"><a href="#远程服务器模式" class="headerlink" title="远程服务器模式"></a>远程服务器模式</h3><ul>
<li>前面为hadoop部分</li>
<li>元数据 保存在MySQL</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>namenode 主备</th>
<th>ZKFC</th>
<th>datanode</th>
<th>zookeeper</th>
<th>JNN</th>
<th>mysql</th>
<th>hive Metastore Server</th>
<th>hive  client</th>
</tr>
</thead>
<tbody>
<tr>
<td>node01</td>
<td>*</td>
<td>*</td>
<td></td>
<td></td>
<td>*</td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td>node02</td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>*</td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td>node03</td>
<td></td>
<td></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td>node04</td>
<td></td>
<td></td>
<td>*</td>
<td>*</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Thrift MetaStore Server</p>
<h4 id="mysql安装"><a href="#mysql安装" class="headerlink" title="mysql安装"></a>mysql安装</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">解决无包可用，下载地址 http://repo.mysql.com/mysql-community-<span class="keyword">release</span>-el7<span class="number">-5.</span>noarch.rpm</span><br><span class="line">rpm -ivh mysql-community-<span class="keyword">release</span>-el7<span class="number">-5.</span>noarch.rpm</span><br><span class="line">yum <span class="keyword">install</span> -y mysql-<span class="keyword">server</span></span><br></pre></td></tr></table></figure>
<p>服务mysql启动</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysqld <span class="literal">start</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">databases</span></span><br><span class="line"><span class="keyword">use</span> mysql</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span></span><br><span class="line"><span class="keyword">desc</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure>
<p>修改授权用户密码</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> Host , User , Password from user;</span><br><span class="line">GRANT <span class="literal">ALL</span> PRIVILEGES <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'root'</span>@<span class="string">'%'</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">'123'</span> <span class="keyword">WITH</span> GRANT OPTION;</span><br><span class="line">delete from user <span class="keyword">where</span> Host != <span class="string">'%'</span>;</span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line">quit</span><br><span class="line">mysql <span class="params">-uroot</span> <span class="params">-p</span>;</span><br><span class="line"></span><br><span class="line">含义：<span class="literal">ALL</span> PRIVILEGES所有权限，*.*所有库所有表， %任何host  root用户名 <span class="number">123</span>密码</span><br></pre></td></tr></table></figure>
<h4 id="hive-Metastore-Server"><a href="#hive-Metastore-Server" class="headerlink" title="hive Metastore Server"></a>hive Metastore Server</h4><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">服务端需要连接mysql</span><br><span class="line">scp apache-hive-<span class="number">1.2</span>.<span class="number">1</span>-bin.tar.gz mysql-connector-java-<span class="number">5.1</span>.<span class="number">32</span>-bin.jar root@<span class="symbol">node02:</span>/root/</span><br><span class="line">tar zxvf apache-hive-<span class="number">1.2</span>.<span class="number">1</span>-bin.tar.gz</span><br><span class="line">cp mysql-connector-java-<span class="number">5.1</span>.<span class="number">32</span>-bin.jar apache-hive-<span class="number">1.2</span>.<span class="number">1</span>-bin/<span class="class"><span class="keyword">lib</span>/</span></span><br></pre></td></tr></table></figure>
<p>环境变量</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">HIVE_HOME</span>=/root/apache-hive-1.2.1-bin</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="variable">$PATH</span>:$ZOOKEEPER_HOME/bin:$HADOOP_HOME/bin:$HADOOP_HOME/sbin:$HIVE_HOME/bin</span><br><span class="line">source  /etc/profile</span><br></pre></td></tr></table></figure>
<p>配置文件</p>
<p>参考 <a href="https://cwiki.apache.org/confluence/display/Hive/AdminManual+Configuration" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/AdminManual+Configuration</a></p>
<p><a href="https://cwiki.apache.org/confluence/display/Hive/AdminManual+Metastore+Administration" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/AdminManual+Metastore+Administration</a></p>
<p><a href="https://cwiki.apache.org/confluence/display/Hive/AdminManual+Metastore+Administration#AdminManualMetastoreAdministration-RemoteMetastoreServer" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/AdminManual+Metastore+Administration#AdminManualMetastoreAdministration-RemoteMetastoreServer</a></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd conf/</span><br><span class="line">mv hive-default<span class="selector-class">.xml</span><span class="selector-class">.template</span> hive-site.xml</span><br><span class="line">vi hive-site.xml</span><br><span class="line">从当前行 &lt;configuration&gt;下面一行， 删除到倒数-<span class="number">1</span>行</span><br><span class="line">:.,$-<span class="number">1</span>d</span><br></pre></td></tr></table></figure>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">&lt;property&gt;</span>  </span><br><span class="line">  <span class="params">&lt;name&gt;</span>hive.metastore.warehouse.dir<span class="params">&lt;/name&gt;</span>  </span><br><span class="line">  <span class="params">&lt;value&gt;</span><span class="meta-keyword">/user/</span>hive/warehouse<span class="params">&lt;/value&gt;</span>  </span><br><span class="line"><span class="params">&lt;/property&gt;</span>  </span><br><span class="line">   </span><br><span class="line"><span class="params">&lt;property&gt;</span>  </span><br><span class="line">  <span class="params">&lt;name&gt;</span>javax.jdo.option.ConnectionURL<span class="params">&lt;/name&gt;</span>  </span><br><span class="line">  <span class="params">&lt;value&gt;</span>jdbc:mysql:<span class="comment">//node01:3306/hive?createDatabaseIfNotExist=true&lt;/value&gt;  </span></span><br><span class="line"><span class="params">&lt;/property&gt;</span>  </span><br><span class="line">   </span><br><span class="line"><span class="params">&lt;property&gt;</span>  </span><br><span class="line">  <span class="params">&lt;name&gt;</span>javax.jdo.option.ConnectionDriverName<span class="params">&lt;/name&gt;</span>  </span><br><span class="line">  <span class="params">&lt;value&gt;</span>com.mysql.jdbc.Driver<span class="params">&lt;/value&gt;</span>  </span><br><span class="line"><span class="params">&lt;/property&gt;</span>  </span><br><span class="line">   </span><br><span class="line"><span class="params">&lt;property&gt;</span>  </span><br><span class="line">  <span class="params">&lt;name&gt;</span>javax.jdo.option.ConnectionUserName<span class="params">&lt;/name&gt;</span>  </span><br><span class="line">  <span class="params">&lt;value&gt;</span>root<span class="params">&lt;/value&gt;</span>  </span><br><span class="line"><span class="params">&lt;/property&gt;</span>  </span><br><span class="line">   </span><br><span class="line"><span class="params">&lt;property&gt;</span>  </span><br><span class="line">  <span class="params">&lt;name&gt;</span>javax.jdo.option.ConnectionPassword<span class="params">&lt;/name&gt;</span>  </span><br><span class="line">  <span class="params">&lt;value&gt;</span><span class="number">123</span><span class="params">&lt;/value&gt;</span>  </span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="启动metastore-server"><a href="#启动metastore-server" class="headerlink" title="启动metastore server"></a>启动metastore server</h5><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive <span class="comment">--service metastore</span></span><br></pre></td></tr></table></figure>
<p>也可使用hiveserver2 beeline方式</p>
<h4 id="hive-client"><a href="#hive-client" class="headerlink" title="hive  client"></a>hive  client</h4><p>vi hive-site.xml</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">:</span>.,<span class="variable">$-</span><span class="number">1</span>d</span><br></pre></td></tr></table></figure>
<p>连接metastore</p>
<p>环境变量</p>
<p>./hive</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">&lt;property&gt;</span>  </span><br><span class="line">  <span class="params">&lt;name&gt;</span>hive.metastore.warehouse.dir<span class="params">&lt;/name&gt;</span>  </span><br><span class="line">  <span class="params">&lt;value&gt;</span><span class="meta-keyword">/user/</span>hive/warehouse<span class="params">&lt;/value&gt;</span>  </span><br><span class="line"><span class="params">&lt;/property&gt;</span>  </span><br><span class="line"> </span><br><span class="line"><span class="params">&lt;property&gt;</span>  </span><br><span class="line">  <span class="params">&lt;name&gt;</span>hive.metastore.local<span class="params">&lt;/name&gt;</span>  </span><br><span class="line">  <span class="params">&lt;value&gt;</span>false<span class="params">&lt;/value&gt;</span>  </span><br><span class="line"><span class="params">&lt;/property&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="params">&lt;property&gt;</span>  </span><br><span class="line">  <span class="params">&lt;name&gt;</span>hive.metastore.uris<span class="params">&lt;/name&gt;</span>  </span><br><span class="line">  <span class="params">&lt;value&gt;</span>thrift:<span class="comment">//node02:9083&lt;/value&gt;  </span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">property</span>&gt;  </span><br><span class="line">  &lt;<span class="built_in">name</span>&gt;hive.metastore.<span class="keyword">local</span>&lt;/<span class="built_in">name</span>&gt;  </span><br><span class="line">  &lt;value&gt;<span class="literal">false</span>&lt;/value&gt;  </span><br><span class="line">&lt;/<span class="keyword">property</span>&gt;  可以去掉,避免waring</span><br><span class="line">Metastore <span class="keyword">is</span> remote.  Note: This <span class="keyword">is</span> no longer needed <span class="keyword">as</span> <span class="keyword">of</span> Hive <span class="number">0.10</span>.  Setting hive.metastore.uri <span class="keyword">is</span> sufficient.</span><br></pre></td></tr></table></figure>
<p>避免jline报错</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/sxt/hadoop-<span class="number">2.6</span>.<span class="number">5</span>/share/hadoop/yarn/<span class="class"><span class="keyword">lib</span></span></span><br><span class="line">rm jline-<span class="number">0.9</span>.<span class="number">94</span>.jar</span><br><span class="line">cp /root/apache-hive-<span class="number">1.2</span>.<span class="number">1</span>-bin/<span class="class"><span class="keyword">lib</span>/<span class="title">jline</span>-2.12.<span class="title">jar</span> ./</span></span><br></pre></td></tr></table></figure>
<p>启动</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">hive</span></span><br></pre></td></tr></table></figure>
<h3 id="hive操作"><a href="#hive操作" class="headerlink" title="hive操作"></a>hive操作</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tbl(<span class="keyword">id</span> <span class="built_in">int</span>,age <span class="built_in">int</span>);</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tbl <span class="keyword">values</span>(<span class="number">1</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>Time taken: 175.393 seconds  查看map reduece 执行job状态 <a href="http://node03:8088/cluster" target="_blank" rel="external">http://node03:8088/cluster</a></p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tbl;</span><br></pre></td></tr></table></figure>
<p>查看hdfs存储  <a href="http://node01:50070/explorer.html#/user/hive/warehouse/tbl" target="_blank" rel="external">http://node01:50070/explorer.html#/user/hive/warehouse/tbl</a></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -cat <span class="regexp">/user/</span>hive<span class="regexp">/warehouse/</span>tbl<span class="regexp">/*</span></span><br></pre></td></tr></table></figure>
<h3 id="hive数据类型"><a href="#hive数据类型" class="headerlink" title="hive数据类型"></a>hive数据类型</h3><p>: primitive_type</p>
<p>  | array_type   数组</p>
<p>  | map_type     map类型</p>
<p>  | struct_type   结构体</p>
<p>：primitive_type</p>
<p>  |TINYINT</p>
<p>  | SMALLINT</p>
<p>  | INT</p>
<p>  | BIGINT</p>
<p>  | BOOLEAN</p>
<p>  | FLOAT</p>
<p>  | DOUBLE</p>
<p>  | STRING</p>
<p>参考 <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL</a></p>
<p><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-CreateTable" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-CreateTable</a></p>
<h4 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h4><h5 id="内部表"><a href="#内部表" class="headerlink" title="内部表"></a>内部表</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> psn(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="keyword">string</span>,</span><br><span class="line">likes <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;,</span><br><span class="line">address <span class="keyword">map</span>&lt;<span class="keyword">string</span>,<span class="keyword">string</span>&gt;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">DELIMITED</span></span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span></span><br><span class="line">COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'-'</span></span><br><span class="line"><span class="keyword">MAP</span> <span class="keyword">KEYS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">':'</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">人员表</span><br><span class="line">id,姓名,爱好，住址</span><br><span class="line"><span class="number">1</span>,小明<span class="number">1</span>,<span class="keyword">lol</span>-book-movie,zhejian<span class="variable">g:hangzhou</span>-guangdon<span class="variable">g:shenzhen</span></span><br><span class="line"><span class="number">2</span>,小明<span class="number">2</span>,<span class="keyword">lol</span>-book,zhejian<span class="variable">g:hangzhou</span>-guangdon<span class="variable">g:shenzhen</span></span><br></pre></td></tr></table></figure>
<h4 id="描述表"><a href="#描述表" class="headerlink" title="描述表"></a>描述表</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">desc</span> psn;</span><br><span class="line"><span class="keyword">desc</span> formatted psn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Table</span> <span class="keyword">Type</span>:         	MANAGED_TABLE  内部表</span><br></pre></td></tr></table></figure>
<h4 id="数据插入"><a href="#数据插入" class="headerlink" title="数据插入"></a>数据插入</h4><p>参考 <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DML#LanguageManualDML-Loadingfilesintotables" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DML#LanguageManualDML-Loadingfilesintotables</a></p>
<p>文件导入</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> <span class="keyword">LOCAL</span> INPATH <span class="string">'/root/persondata'</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> psn;</span><br></pre></td></tr></table></figure>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; <span class="keyword">select</span> * <span class="keyword">from</span> psn;</span><br><span class="line">OK</span><br><span class="line"><span class="number">1</span>	小明<span class="number">1</span>	[<span class="string">"lol"</span>,<span class="string">"book"</span>,<span class="string">"movie"</span>]	&#123;<span class="string">"zhejiang"</span>:<span class="string">"hangzhou"</span>,<span class="string">"guangdong"</span>:<span class="string">"shenzhen"</span>&#125;</span><br><span class="line"><span class="number">2</span>	小明<span class="number">2</span>	[<span class="string">"lol"</span>,<span class="string">"book"</span>]	&#123;<span class="string">"zhejiang"</span>:<span class="string">"hangzhou"</span>,<span class="string">"guangdong"</span>:<span class="string">"shenzhen"</span>&#125;</span><br></pre></td></tr></table></figure>
<h5 id="外部表"><a href="#外部表" class="headerlink" title="外部表"></a>外部表</h5><p>persondata为数据txt</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs <span class="built_in">mkdir</span> /external_table</span><br><span class="line">hdfs dfs -<span class="built_in">put</span> persondata /external_table/</span><br></pre></td></tr></table></figure>
<p>创建table</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">EXTERNAL</span> <span class="keyword">table</span>  psn_external(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="keyword">string</span>,</span><br><span class="line">likes <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;,</span><br><span class="line">address <span class="keyword">map</span>&lt;<span class="keyword">string</span>,<span class="keyword">string</span>&gt;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">DELIMITED</span></span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span></span><br><span class="line">COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'-'</span></span><br><span class="line"><span class="keyword">MAP</span> <span class="keyword">KEYS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">':'</span></span><br><span class="line">LOCATION <span class="string">'/external_table'</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> psn_external;</span><br><span class="line"><span class="keyword">desc</span> formatted psn_external;</span><br><span class="line">Table <span class="keyword">Type</span>:         	EXTERNAL_TABLE</span><br></pre></td></tr></table></figure>
<p>内部：删除元数据，及目录</p>
<p>外部：只删除元数据，存放目录不会删除</p>
<h4 id="其他创建表方式"><a href="#其他创建表方式" class="headerlink" title="其他创建表方式"></a>其他创建表方式</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">like</span> <span class="keyword">table</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> psn2 <span class="keyword">as</span> <span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span>,likes <span class="keyword">from</span> psn;</span><br></pre></td></tr></table></figure>
<h3 id="分区表"><a href="#分区表" class="headerlink" title="分区表"></a>分区表</h3><h4 id="单个字段分区"><a href="#单个字段分区" class="headerlink" title="单个字段分区"></a>单个字段分区</h4><p>按年龄分区</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id,年龄爱好，住址</span><br><span class="line"><span class="number">1</span>,小明<span class="number">1</span>,<span class="keyword">lol</span>-book-movie,zhejian<span class="variable">g:hangzhou</span>-guangdon<span class="variable">g:shenzhen</span></span><br><span class="line"><span class="number">2</span>,小明<span class="number">2</span>,lofl-book,zhejian<span class="variable">g:hangzhou</span>-guangdon<span class="variable">g:shenzhen</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> psn_partition(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="keyword">string</span>,</span><br><span class="line">likes <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;,</span><br><span class="line">address <span class="keyword">map</span>&lt;<span class="keyword">string</span>,<span class="keyword">string</span>&gt;</span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (age <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">DELIMITED</span></span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span></span><br><span class="line">COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'-'</span></span><br><span class="line"><span class="keyword">MAP</span> <span class="keyword">KEYS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">':'</span>;</span><br></pre></td></tr></table></figure>
<p>通过分区指定年龄</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> <span class="keyword">LOCAL</span> INPATH <span class="string">'/root/persondata'</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> psn_partition <span class="keyword">partition</span>(age=<span class="number">10</span>);</span><br><span class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> <span class="keyword">LOCAL</span> INPATH <span class="string">'/root/persondata'</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> psn_partition <span class="keyword">partition</span>(age=<span class="number">20</span>);</span><br></pre></td></tr></table></figure>
<h4 id="多个字段分区"><a href="#多个字段分区" class="headerlink" title="多个字段分区"></a>多个字段分区</h4><p>按年龄和性别分区</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> psn_partition_multi(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="keyword">string</span>,</span><br><span class="line">likes <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;,</span><br><span class="line">address <span class="keyword">map</span>&lt;<span class="keyword">string</span>,<span class="keyword">string</span>&gt;</span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (age <span class="built_in">int</span>,sex <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">DELIMITED</span></span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span></span><br><span class="line">COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'-'</span></span><br><span class="line"><span class="keyword">MAP</span> <span class="keyword">KEYS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">':'</span>;</span><br></pre></td></tr></table></figure>
<p>通过分区指定年龄、性别</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> <span class="keyword">LOCAL</span> INPATH <span class="string">'/root/persondata'</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> psn_partition_multi <span class="keyword">partition</span>(age=<span class="number">10</span>,sex=<span class="string">'boy'</span>);</span><br><span class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> <span class="keyword">LOCAL</span> INPATH <span class="string">'/root/persondata'</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> psn_partition_multi <span class="keyword">partition</span>(age=<span class="number">10</span>,sex=<span class="string">'girl'</span>);</span><br><span class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> <span class="keyword">LOCAL</span> INPATH <span class="string">'/root/persondata'</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> psn_partition_multi <span class="keyword">partition</span>(age=<span class="number">20</span>,sex=<span class="string">'girl'</span>);</span><br></pre></td></tr></table></figure>
<h5 id="删除分区"><a href="#删除分区" class="headerlink" title="删除分区"></a>删除分区</h5><p>参考文档 <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-DropPartitions" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-DropPartitions</a></p>
<p>10和20的girl二级分区都删掉</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> psn_partition_multi <span class="keyword">DROP</span> <span class="keyword">PARTITION</span> (sex=<span class="string">'girl'</span>);</span><br></pre></td></tr></table></figure>
<h5 id="添加分区"><a href="#添加分区" class="headerlink" title="添加分区"></a>添加分区</h5><p>必须指定第一级分区年龄</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> psn_partition_multi <span class="keyword">ADD</span> <span class="keyword">PARTITION</span> (age=<span class="number">10</span>,sex=<span class="string">'girl'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="DML"><a href="#DML" class="headerlink" title="DML"></a>DML</h3><h4 id="from-insert-select方式"><a href="#from-insert-select方式" class="headerlink" title="from insert select方式"></a>from insert select方式</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> psn_copy <span class="keyword">like</span> psn;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM psn</span><br><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> psn_copy</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">id</span>,<span class="keyword">name</span>,likes,address;</span><br></pre></td></tr></table></figure>
<h3 id="Hive-Beeline"><a href="#Hive-Beeline" class="headerlink" title="Hive Beeline"></a>Hive Beeline</h3><h4 id="hiveserver2"><a href="#hiveserver2" class="headerlink" title="hiveserver2"></a>hiveserver2</h4><p>node02</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hiveserver2</span><br></pre></td></tr></table></figure>
<h4 id="beeline"><a href="#beeline" class="headerlink" title="beeline"></a>beeline</h4><p>node03</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">beeline</span><br></pre></td></tr></table></figure>
<p>生产环境用 用户名、密码不校验</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">!connect <span class="string">jdbc:</span><span class="string">hive2:</span><span class="comment">//node02:10000/default; root 123</span></span><br><span class="line"></span><br><span class="line">show tables;</span><br></pre></td></tr></table></figure>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc<span class="function">:hive2</span>:<span class="string">//node02</span><span class="function">:10000</span>/default&gt; select * from psn;</span><br><span class="line">+<span class="params">---------</span>+<span class="params">-----------</span>+<span class="params">-------------------------</span>+<span class="params">-------------------------------------------------</span>+--+</span><br><span class="line">| psn.id  | psn.name  |        psn.likes        |                   psn.address                   |</span><br><span class="line">+<span class="params">---------</span>+<span class="params">-----------</span>+<span class="params">-------------------------</span>+<span class="params">-------------------------------------------------</span>+--+</span><br><span class="line">| 1       | 小明1       | [<span class="string">"lol"</span>,<span class="string">"book"</span>,<span class="string">"movie"</span>]  | &#123;<span class="string">"zhejiang"</span>:<span class="string">"hangzhou"</span>,<span class="string">"guangdong"</span>:<span class="string">"shenzhen"</span>&#125;  |</span><br><span class="line">| 2       | 小明2       | [<span class="string">"lol"</span>,<span class="string">"book"</span>]          | &#123;<span class="string">"zhejiang"</span>:<span class="string">"hangzhou"</span>,<span class="string">"guangdong"</span>:<span class="string">"shenzhen"</span>&#125;  |</span><br><span class="line">+<span class="params">---------</span>+<span class="params">-----------</span>+<span class="params">-------------------------</span>+<span class="params">-------------------------------------------------</span>+--+</span><br><span class="line">2 rows selected <span class="params">(3.391 seconds)</span></span><br></pre></td></tr></table></figure>
<p>退出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!quit</span><br></pre></td></tr></table></figure>
<h3 id="hive-jdbc-demo"><a href="#hive-jdbc-demo" class="headerlink" title="hive jdbc demo"></a>hive jdbc demo</h3><p>参考hivedemo</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> HiveJdbcClient &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> String driverName = <span class="string">"org.apache.hive.jdbc.HiveDriver"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(String[] args) <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">Class</span>.forName(driverName);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Connection conn = DriverManager.getConnection(<span class="string">"jdbc:hive2://node02:10000/default"</span>, <span class="string">"root"</span>, <span class="string">""</span>);</span><br><span class="line">		Statement stmt = conn.createStatement();</span><br><span class="line">		String sql = <span class="string">"select * from psn limit 5"</span>;</span><br><span class="line">		ResultSet res = stmt.executeQuery(sql);</span><br><span class="line">		<span class="keyword">while</span> (res.<span class="keyword">next</span>()) &#123;</span><br><span class="line">			System.out.<span class="keyword">println</span>(res.getString(<span class="number">1</span>) + <span class="string">"-"</span> + res.getString(<span class="string">"name"</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="hive-函数"><a href="#hive-函数" class="headerlink" title="hive 函数"></a>hive 函数</h3><h4 id="UDF-用户自定义函数"><a href="#UDF-用户自定义函数" class="headerlink" title="UDF 用户自定义函数"></a>UDF 用户自定义函数</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.laolian;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.exec.<span class="type">UDF</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.<span class="type">Text</span>;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">TuoMin</span> <span class="keyword">extends</span> <span class="title">UDF</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	public <span class="type">Text</span> evaluate(<span class="keyword">final</span> <span class="type">Text</span> s) &#123;</span><br><span class="line">		<span class="keyword">if</span> (s == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">String</span> str = s.toString().substring(<span class="number">0</span>, <span class="number">3</span>) + <span class="string">"***"</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="type">Text</span>(str);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>eclipse 导出jar 包export jar</p>
<p>node02</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive <span class="comment">--service metastore</span></span><br></pre></td></tr></table></figure>
<p>node03</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hive</span><br><span class="line"></span><br><span class="line">add jar /root/tuomin.jar;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">temporary</span> <span class="keyword">function</span> tm <span class="keyword">AS</span> <span class="string">'cn.laolian.TuoMin'</span>;</span><br><span class="line"><span class="keyword">select</span> tm(<span class="keyword">name</span>) <span class="keyword">from</span> psn;</span><br></pre></td></tr></table></figure>
<p>临时函数，当前会话有效</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; <span class="function"><span class="keyword">select</span> <span class="title">tm</span>(<span class="params">name</span>) <span class="keyword">from</span> psn</span>;</span><br><span class="line">OK</span><br><span class="line">小明<span class="number">1</span>***</span><br><span class="line">小明<span class="number">2</span>***</span><br></pre></td></tr></table></figure>
<h4 id="UDAF"><a href="#UDAF" class="headerlink" title="UDAF"></a>UDAF</h4><h4 id="UDTF-一进多出"><a href="#UDTF-一进多出" class="headerlink" title="UDTF 一进多出"></a>UDTF 一进多出</h4><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">select</span> <span class="title">explode</span>(<span class="params">likes</span>) <span class="keyword">from</span> psn</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">: jdbc:hive2://node02:10000/default&gt;</span> select explode(likes) from psn;</span><br><span class="line"><span class="code">+--------+</span>--+</span><br><span class="line">|  col   |</span><br><span class="line"><span class="code">+--------+</span>--+</span><br><span class="line">| lol    |</span><br><span class="line">| book   |</span><br><span class="line">| movie  |</span><br><span class="line">| lol    |</span><br><span class="line">| book   |</span><br><span class="line"><span class="code">+--------+</span>--+</span><br></pre></td></tr></table></figure>
<h3 id="hive参数"><a href="#hive参数" class="headerlink" title="hive参数"></a>hive参数</h3><p>打印头信息</p>
<h4 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hive</span><br><span class="line"><span class="builtin-name">set</span> hive.cli.print.<span class="attribute">header</span>=<span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>; 进行提示，导出配置</span><br></pre></td></tr></table></figure>
<h4 id="方式二-启动时设置"><a href="#方式二-启动时设置" class="headerlink" title="方式二 启动时设置"></a>方式二 启动时设置</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive --hiveconf hive.cli.print.<span class="attribute">header</span>=<span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>只在当前会话有效</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; select *  <span class="keyword">from</span> psn;</span><br><span class="line">OK</span><br><span class="line">psn.<span class="built_in">id</span>	psn.<span class="built_in">name</span>	psn.likes	psn.address</span><br><span class="line"><span class="number">1</span>	小明<span class="number">1</span>	[<span class="string">"lol"</span>,<span class="string">"book"</span>,<span class="string">"movie"</span>]	&#123;<span class="string">"zhejiang"</span>:<span class="string">"hangzhou"</span>,<span class="string">"guangdong"</span>:<span class="string">"shenzhen"</span>&#125;</span><br><span class="line"><span class="number">2</span>	小明<span class="number">2</span>	[<span class="string">"lol"</span>,<span class="string">"book"</span>]	&#123;<span class="string">"zhejiang"</span>:<span class="string">"hangzhou"</span>,<span class="string">"guangdong"</span>:<span class="string">"shenzhen"</span>&#125;</span><br></pre></td></tr></table></figure>
<h4 id="方式三-所有会话有效"><a href="#方式三-所有会话有效" class="headerlink" title="方式三 所有会话有效"></a>方式三 所有会话有效</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi .hiverc</span><br><span class="line"></span><br><span class="line">hive.cli.print.<span class="attribute">header</span>=<span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h4 id="历史命令"><a href="#历史命令" class="headerlink" title="历史命令"></a>历史命令</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">cat</span> <span class="selector-class">.hivehistory</span></span><br></pre></td></tr></table></figure>
<h3 id="Hive-动态分区"><a href="#Hive-动态分区" class="headerlink" title="Hive 动态分区"></a>Hive 动态分区</h3><p>严格模式：至少保证有一个静态分区</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">set</span> hive.exec.dynamic.<span class="attribute">partition</span>=<span class="literal">true</span>;</span><br><span class="line"><span class="builtin-name">set</span> hive.exec.dynamic.partition.<span class="attribute">mode</span>=nostrict;</span><br></pre></td></tr></table></figure>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi persondat<span class="built_in">a_daynamic</span>_partition</span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">id,姓名，年龄，性别，爱好，住址</span><br><span class="line"><span class="number">1</span>,小明<span class="number">1</span>,<span class="number">10</span>,boy,<span class="keyword">lol</span>-book-movie,zhejian<span class="variable">g:hangzhou</span>-guangdon<span class="variable">g:shenzhen</span></span><br><span class="line"><span class="number">2</span>,小明<span class="number">2</span>,<span class="number">10</span>,man,lofl-book,zhejian<span class="variable">g:hangzhou</span>-guangdon<span class="variable">g:shenzhen</span></span><br><span class="line"><span class="number">3</span>,小明<span class="number">3</span>,<span class="number">20</span>,boy,lofl-book,zhejian<span class="variable">g:hangzhou</span>-guangdon<span class="variable">g:shenzhen</span></span><br><span class="line"><span class="number">2</span>,小明<span class="number">3</span>,<span class="number">20</span>,man,lofl-book,zhejian<span class="variable">g:hangzhou</span>-guangdon<span class="variable">g:shenzhen</span></span><br></pre></td></tr></table></figure>
<h4 id="原始表"><a href="#原始表" class="headerlink" title="原始表"></a>原始表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> psn_dynamic_partition(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="keyword">string</span>,</span><br><span class="line">age <span class="built_in">int</span>,</span><br><span class="line">sex <span class="keyword">string</span>,</span><br><span class="line">likes <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;,</span><br><span class="line">address <span class="keyword">map</span>&lt;<span class="keyword">string</span>,<span class="keyword">string</span>&gt;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">DELIMITED</span></span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span></span><br><span class="line">COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'-'</span></span><br><span class="line"><span class="keyword">MAP</span> <span class="keyword">KEYS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">':'</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/root/persondata_daynamic_partition'</span> <span class="keyword">into</span> <span class="keyword">table</span> psn_dynamic_partition;</span><br></pre></td></tr></table></figure>
<h4 id="分区表-1"><a href="#分区表-1" class="headerlink" title="分区表"></a>分区表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> psn_dynamic_partition_r(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="keyword">string</span>,</span><br><span class="line">likes <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;,</span><br><span class="line">address <span class="keyword">map</span>&lt;<span class="keyword">string</span>,<span class="keyword">string</span>&gt;</span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (age <span class="built_in">int</span> , sex <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">DELIMITED</span></span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span></span><br><span class="line">COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'-'</span></span><br><span class="line"><span class="keyword">MAP</span> <span class="keyword">KEYS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">':'</span>;</span><br></pre></td></tr></table></figure>
<h4 id="从原始表导入到分区表"><a href="#从原始表导入到分区表" class="headerlink" title="从原始表导入到分区表"></a>从原始表导入到分区表</h4><p>注意age,sex的顺序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from psn_dynamic_partition</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> psn_dynamic_partition_r <span class="keyword">partition</span>(age,sex)</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span>,likes,address,age,sex <span class="keyword">distribute</span> <span class="keyword">by</span> age,sex;</span><br></pre></td></tr></table></figure>
<h3 id="Hive脚本运行方式"><a href="#Hive脚本运行方式" class="headerlink" title="Hive脚本运行方式"></a>Hive脚本运行方式</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hive -e <span class="string">"select * from psn"</span></span><br><span class="line">重定向</span><br><span class="line">hive -e <span class="string">"select * from psn"</span> &gt; aaa</span><br><span class="line">静默输出</span><br><span class="line">hive -S -e <span class="string">"select * from psn"</span> &gt; aaa</span><br></pre></td></tr></table></figure>
<h4 id="文件脚本"><a href="#文件脚本" class="headerlink" title="文件脚本"></a>文件脚本</h4><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi sql</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> psn</span><br></pre></td></tr></table></figure>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">hive -f sql</span></span><br></pre></td></tr></table></figure>
<h3 id="hive-client终端交互"><a href="#hive-client终端交互" class="headerlink" title="hive client终端交互"></a>hive client终端交互</h3><h4 id="hdfs交互"><a href="#hdfs交互" class="headerlink" title="hdfs交互"></a>hdfs交互</h4><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; dfs -ls / ;</span><br><span class="line">Found 5 items</span><br><span class="line">drwxr-xr-x   - root supergroup          0 2019<span class="string">-04</span><span class="string">-17</span> 22:08 /data</span><br><span class="line">drwxr-xr-x   - root supergroup          0 2019<span class="string">-06</span><span class="string">-02</span> 19:25 /external_table</span><br><span class="line">-rw-r--r--   2 root supergroup        118 2019<span class="string">-06</span><span class="string">-02</span> 19:10 /persondata</span><br><span class="line">drwx------   - root supergroup          0 2019<span class="string">-06</span><span class="string">-02</span> 11:55 /tmp</span><br><span class="line">drwxr-xr-x   - root supergroup          0 2019<span class="string">-06</span><span class="string">-02</span> 12:06 /user</span><br></pre></td></tr></table></figure>
<h4 id="linux交互"><a href="#linux交互" class="headerlink" title="linux交互"></a>linux交互</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">hive&gt;</span><span class="bash"> !<span class="built_in">pwd</span>;</span></span><br><span class="line">/root</span><br></pre></td></tr></table></figure>
<h3 id="Hive优化"><a href="#Hive优化" class="headerlink" title="Hive优化"></a>Hive优化</h3><h4 id="核心思想：hive-SQL-当做Map-Reduce程序去优化"><a href="#核心思想：hive-SQL-当做Map-Reduce程序去优化" class="headerlink" title="核心思想：hive SQL 当做Map Reduce程序去优化"></a>核心思想：hive SQL 当做Map Reduce程序去优化</h4><p>两种不会转化为Mapreduce执行</p>
<ul>
<li>select仅查询本表字段</li>
</ul>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> psn;</span><br></pre></td></tr></table></figure>
<ul>
<li>select仅对本表字段做条件过滤</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> psn <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h4 id="Explain执行计划"><a href="#Explain执行计划" class="headerlink" title="Explain执行计划"></a>Explain执行计划</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> psn;</span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">extended</span> <span class="keyword">select</span> * <span class="keyword">from</span> psn;</span><br></pre></td></tr></table></figure>
<h4 id="抓取策略"><a href="#抓取策略" class="headerlink" title="抓取策略"></a>抓取策略</h4><p>这样会执行mapreduce，默认值more</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.fetch.task.conversion=<span class="keyword">none</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> psn;</span><br></pre></td></tr></table></figure>
<h4 id="hive运行方式"><a href="#hive运行方式" class="headerlink" title="hive运行方式"></a>hive运行方式</h4><h5 id="本地模式"><a href="#本地模式" class="headerlink" title="本地模式"></a>本地模式</h5><p>本地模式，开发测试用，生产不要用</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> hive.<span class="built_in">exec</span>.mode.<span class="built_in">local</span>.auto=<span class="literal">true</span>;</span><br><span class="line"><span class="built_in">select</span> <span class="built_in">count</span>(*) <span class="keyword">from</span>  psn;</span><br></pre></td></tr></table></figure>
<ul>
<li>hive.exec.mode.local.inputbytes.max 默认值128M，大于该配置，也会以集群方法运行</li>
</ul>
<h4 id="并行计算"><a href="#并行计算" class="headerlink" title="并行计算"></a>并行计算</h4>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/05/15/Spring-framwork技术体系目录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/15/Spring-framwork技术体系目录/" itemprop="url">Spring framwork技术体系目录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-15T12:58:56+08:00">
                2019-05-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index">
                    <span itemprop="name">Spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/05/15/Spring-framwork技术体系目录/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/05/15/Spring-framwork技术体系目录/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  393
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><p>在Spring中常见的全局异常处理，主要有三种：</p>
<ul>
<li>注解 @ExceptionHandler</li>
</ul>
<blockquote>
<p>在 Controller 内部，用 <code>@ExceptionHandler</code>注解的方法，就会作为该Controller内部的异常处理方法。</p>
<p>该方式需要在每个类中处理异常，不适合全局异常处理。</p>
</blockquote>
<ul>
<li>继承HandlerExceptionResolver接口</li>
</ul>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomHandlerExceptionResolver</span> <span class="keyword">implements</span> <span class="title">HandlerExceptionResolver</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">ModelAndView <span class="title">resolveException</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object <span class="keyword">handler</span>, Exception ex)</span> </span>&#123;</span><br><span class="line">        Method method = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">handler</span> != <span class="keyword">null</span> &amp;&amp; <span class="keyword">handler</span> <span class="keyword">instanceof</span> HandlerMethod) &#123;</span><br><span class="line">            method = ((HandlerMethod) <span class="keyword">handler</span>).getMethod();</span><br><span class="line">        &#125;</span><br><span class="line">        log.<span class="keyword">error</span>(<span class="string">"[&#123;&#125;] system error"</span>, method, ex);</span><br><span class="line">        ResponseDTO response = ResponseDTO.builder()</span><br><span class="line">        .errorCode(ErrorCode.SYSTEM_ERROR)</span><br><span class="line">        .build();</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = JSON.toJSONString(response).getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileCopyUtils.copy(bytes, response.getOutputStream());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.<span class="keyword">error</span>(<span class="string">"error"</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>函数还可以返回一个 ModelAndView 对象，表示渲染一个视图，比方说错误页面。不过，在前后端分离为主流架构的今天，这个很少用了。如果函数返回的视图为空，则表示不需要视图。</p>
</blockquote>
<ul>
<li>注解 @ControllerAdvice</li>
</ul>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@ControllerAdvice</span>(assignableTypes = &#123;GlobalExceptionHandlerMixin.class&#125;)</span><br><span class="line">public class ExceptionAdvice &#123;</span><br><span class="line">    <span class="variable">@ExceptionHandler</span>(ErrorCodeWrapperException.class)</span><br><span class="line">    <span class="variable">@ResponseBody</span></span><br><span class="line">    public ResponseDTO&lt;?&gt; exceptionHandler(ErrorCodeWrapperException e) &#123;</span><br><span class="line">        <span class="selector-tag">if</span> ((errCodeException.getErrorCode().equals(ErrorCode.SYSTEM_ERROR))) &#123;</span><br><span class="line">            <span class="selector-tag">log</span><span class="selector-class">.error</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">ResponseDTO</span><span class="selector-class">.ofErroCodeWrapperException</span>(errCodeException);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ControllerAdvice 支持的限定范围</p>
<ol>
<li>按注解：<code>@ControllerAdvice(annotations = RestController.class)</code></li>
<li>按包名：<code>@ControllerAdvice(&quot;org.example.controllers&quot;)</code></li>
<li>按类型：<code>@ControllerAdvice(assignableTypes = {ControllerInterface.class, AbstractController.class})</code></li>
</ol>
</blockquote>
<h3 id="源码对应"><a href="#源码对应" class="headerlink" title="源码对应"></a>源码对应</h3><ul>
<li>ExceptionHandlerExceptionResolver<ul>
<li>@ExceptionHandler<ul>
<li>@ControllerAdvice</li>
</ul>
</li>
</ul>
</li>
<li>ResponseStatusExceptionResolver</li>
<li>DefaultHandlerExceptionResolver</li>
<li>MyHandlerExceptionResolver</li>
</ul>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><blockquote>
<p>常见的Spring异常分析及处理 <a href="https://my.oschina.net/u/4007037/blog/3049044" target="_blank" rel="external">https://my.oschina.net/u/4007037/blog/3049044</a></p>
<p>Spring中的统一异常处理  <a href="http://www.importnew.com/29962.html" target="_blank" rel="external">http://www.importnew.com/29962.html</a></p>
<p>Spring全局异常处理的三种方式  <a href="https://www.jianshu.com/p/f968b8dcf95a" target="_blank" rel="external">https://www.jianshu.com/p/f968b8dcf95a</a></p>
<p>Spring RestFul API统一异常处理 <a href="http://daobin.wang/2017/05/spring-restful-api/" target="_blank" rel="external">http://daobin.wang/2017/05/spring-restful-api/</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/04/16/单点登录实现——基于OAuth2-0协议的接入方案/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/16/单点登录实现——基于OAuth2-0协议的接入方案/" itemprop="url">单点登录实现——基于OAuth2.0协议的接入方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-16T11:49:04+08:00">
                2019-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/单点登录/" itemprop="url" rel="index">
                    <span itemprop="name">单点登录</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/04/16/单点登录实现——基于OAuth2-0协议的接入方案/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/04/16/单点登录实现——基于OAuth2-0协议的接入方案/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  61
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><p><a href="https://m635674608.iteye.com/blog/2313142" target="_blank" rel="external">单点登录实现——基于OAuth2.0协议的接入方案</a></p>
</li>
<li><p><a href="https://www.cnblogs.com/xifengxiaoma/p/10043173.html" target="_blank" rel="external">Spring Security Oauth2 单点登录案例实现和执行流程剖析</a></p>
</li>
<li><p><a href="https://www.cnblogs.com/ywlaker/p/6113927.html" target="_blank" rel="external">单点登录原理与简单实现</a></p>
</li>
<li><p><a href="https://blog.csdn.net/javaloveiphone/article/details/52439613" target="_blank" rel="external">CAS实现单点登录SSO执行原理探究</a></p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/04/14/Hadoop-MapReduce原理案例及搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/14/Hadoop-MapReduce原理案例及搭建/" itemprop="url">Hadoop MapReduce原理案例及搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-14T11:41:18+08:00">
                2019-04-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/04/14/Hadoop-MapReduce原理案例及搭建/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/04/14/Hadoop-MapReduce原理案例及搭建/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3.3k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  16
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="MapReduce语义"><a href="#MapReduce语义" class="headerlink" title="MapReduce语义"></a>MapReduce语义</h2><p><img src="/2019/04/14/Hadoop-MapReduce原理案例及搭建/图片 2.png" alt="图片 2"></p>
<ul>
<li>MapTask(左边)</li>
</ul>
<p>a. block和切片：block是物理的存储，偏移量和位置信息；切片是逻辑概念。1:1 1:N N:1关系</p>
<p>b. 切片和map：1：1关系 。 数据多个切片，多个map。一个map有多个key。</p>
<p>c. 同一个map，根据partion的分区信息排序，再根据key，进行一次快排。</p>
<ul>
<li>ReduceTask(右边)</li>
</ul>
<p>a. reduce最终数量由人，默认一个reduce。map和reduce的关系数目不固定。</p>
<p>b. 从其他map拿到相同的key，做归并排序。1个key不能分割，只能在一个分区partition（原语）。</p>
<h3 id="shuffer洗牌"><a href="#shuffer洗牌" class="headerlink" title="shuffer洗牌"></a>shuffer洗牌</h3><p><img src="/2019/04/14/Hadoop-MapReduce原理案例及搭建/图片 3.png" alt="图片 3"></p>
<p>a. 一个切片split =&gt; 一个map=&gt; 内存根据分区和Key做一次快排 , (partition,key,value)</p>
<p>环形缓冲区，达到80%，产生溢写，快排</p>
<p>b. reduceTask是在一个分区partition，从不同的map，拿到相同的key。内部有序，外部无序，进行归并排序。</p>
<p><img src="/Users/zhouxiaowu/IdeaProject-gupao/blog/source/_posts/Hadoop-MapReduce原理案例及搭建/图片 4.png" alt=""></p>
<p>如上图</p>
<p>a. split进行逻辑分割，默认是一个block为一个split</p>
<p>b. map操作，(key,value,partition)信息，排序可选</p>
<p>c. shuffler，洗牌，从不同的map拿到相同的Key，归并</p>
<p>d. reduce计算</p>
<p>e. 合并拿到最后结果</p>
<h2 id="YARN-HA部署"><a href="#YARN-HA部署" class="headerlink" title="YARN HA部署"></a>YARN HA部署</h2><p><img src="/2019/04/14/Hadoop-MapReduce原理案例及搭建/图片 1.png" alt=""></p>
<p>a. client提交任务，包含计算清单</p>
<p>b. ResourceManager根据NodeManager的状态，挑选一台，作为App Master</p>
<p>c. App Master向ResourceManger发起资源请求，分配Container。当Container失败后，ResourceManager又会重新分配。</p>
<table>
<thead>
<tr>
<th></th>
<th>HDFS范围</th>
<th></th>
<th></th>
<th></th>
<th></th>
<th>YARN范围</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>namenode 主备</td>
<td>ZKFC</td>
<td>datanode</td>
<td>zookeeper</td>
<td>JNN</td>
<td>ResourceMangager</td>
<td>NodeManager</td>
</tr>
<tr>
<td>node01</td>
<td>*</td>
<td>*</td>
<td></td>
<td></td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td>node02</td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>*</td>
<td></td>
<td>*</td>
</tr>
<tr>
<td>node03</td>
<td></td>
<td></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td>node04</td>
<td></td>
<td></td>
<td>*</td>
<td>*</td>
<td></td>
<td>*</td>
<td>*</td>
</tr>
</tbody>
</table>
<ul>
<li><p>HDFS 分布式HA搭建参考上篇文档</p>
</li>
<li><p>hdfs1.0 就有了，考虑兼容，增加zkfc保证HA 。yarn是在2.0开发的，resourcemanger不用zkfc</p>
</li>
<li><p>nodeManageer 和 dataNode 1比1关系</p>
</li>
<li><p><code>mapred-site.xml</code></p>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.framework.name<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>标识mapreduce的框架为yarn</p>
<ul>
<li><code>yarn-site.xml</code></li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>mapreduce_shuffle<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.ha.enabled<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.cluster-id<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">value</span>&gt;</span>cluster1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.ha.rm-ids<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">value</span>&gt;</span>rm1,rm2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.hostname.rm1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">value</span>&gt;</span>node03<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.hostname.rm2<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">value</span>&gt;</span>node04<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.zk-address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">value</span>&gt;</span>node02:2181,node03:2181,node04:2181<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>a. <code>mapreduce_shuffle</code>标识，从多个map取出相同的key，shuffle过程</p>
<p>b.开启ha</p>
<p>c. yarn的resourcemanager的逻辑和物理关系</p>
<p>d. yarn的resourcemanager的zk配置</p>
<p>分别复制到node02 node03 node04</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -r mapred-site.<span class="keyword">xml</span> <span class="title">yarn-site</span>.<span class="keyword">xml</span> <span class="title">node02</span>:/`pwd`</span><br></pre></td></tr></table></figure>
<p>node01上启动NodeManager，node02 node03 node04</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">start</span>-yarn.sh</span><br></pre></td></tr></table></figure>
<p>node03 node04手工启用resourcemanager</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn-daemon<span class="selector-class">.sh</span> start resourcemanager</span><br></pre></td></tr></table></figure>
<p><a href="http://node03:8088/cluster/cluster" target="_blank" rel="external">http://node03:8088/cluster/cluster</a> 查看yarn resourcemanager状态</p>
<ul>
<li>执行example单词计数</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/opt/</span>sxt<span class="regexp">/hadoop-2.6.5/</span>share<span class="regexp">/hadoop/m</span>apreduce</span><br><span class="line"><span class="comment">#执行任务</span></span><br><span class="line">hadoop jar hadoop-mapreduce-examples-<span class="number">2.6</span>.<span class="number">5</span>.jar wordcount <span class="regexp">/user/</span>root<span class="regexp">/test.txt /</span>data<span class="regexp">/output/</span></span><br><span class="line"><span class="comment">#从hdfs到本地</span></span><br><span class="line">hdfs dfs -get <span class="regexp">/data/</span>output<span class="regexp">/part-r-00000 ~/</span>result_count.txt</span><br></pre></td></tr></table></figure>
<h2 id="开发MapReduce，单词计数"><a href="#开发MapReduce，单词计数" class="headerlink" title="开发MapReduce，单词计数"></a>开发MapReduce，单词计数</h2><p>hadoop-2.6.5/share/hadoop 中的jar包，根目录及lib，复制到hadoop-user-lib中。配置成全局的user-libaray</p>
<p>，添加<code>hadoop-2.6.5/share/hadoop/mapreduce/sources</code>等作为source源码。</p>
<ul>
<li>启动Main</li>
</ul>
<figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">class</span> MyWC &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        Configuration conf = <span class="keyword">new</span> Configuration(true)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">Job</span> <span class="keyword">job</span> =<span class="keyword">Job</span>.getInstance(conf)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">job</span>.setJarByClass(MyWC.<span class="keyword">class</span>)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">job</span>.setJobName(<span class="string">"sxt-wc"</span>)<span class="comment">;</span></span><br><span class="line">        Path path = <span class="keyword">new</span> Path(<span class="string">"/user/root/test.txt"</span>)<span class="comment">;</span></span><br><span class="line">        FileInputFormat.addInputPath(<span class="keyword">job</span>,path)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        Path output = <span class="keyword">new</span> Path(<span class="string">"/data/wc/output"</span>)<span class="comment">;</span></span><br><span class="line">        <span class="comment">//存在删除文件</span></span><br><span class="line">        <span class="keyword">if</span> (output.getFileSystem(conf).exists(output))&#123;</span><br><span class="line">            output.getFileSystem(conf).delete(output,true)<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        FileOutputFormat.setOutputPath(<span class="keyword">job</span>,output)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">job</span>.setMapperClass(MyMapper.<span class="keyword">class</span>)<span class="comment">;</span></span><br><span class="line">        <span class="keyword">job</span>.setReducerClass(MyReducer.<span class="keyword">class</span>)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//map的kev vaule类型</span></span><br><span class="line">        <span class="keyword">job</span>.setMapOutputKeyClass(Text.<span class="keyword">class</span>)<span class="comment">;</span></span><br><span class="line">        <span class="keyword">job</span>.setMapOutputValueClass(IntWritable.<span class="keyword">class</span>)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//output的key value类型</span></span><br><span class="line">        <span class="keyword">job</span>.setOutputKeyClass(Text.<span class="keyword">class</span>)<span class="comment">;</span></span><br><span class="line">        <span class="keyword">job</span>.setOutputValueClass(IntWritable.<span class="keyword">class</span>)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Submit the job, then poll for progress until the job is complete</span></span><br><span class="line">        <span class="keyword">job</span>.waitForCompletion(true)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Mapper</li>
</ul>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMapper</span></span></span><br><span class="line"><span class="class">        <span class="keyword"><span class="keyword">extends</span> <span class="type">Mapper</span></span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> final <span class="keyword">static</span> IntWritable one = <span class="keyword">new</span> <span class="type">IntWritable</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> Text word = <span class="keyword">new</span> <span class="type">Text</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//hello sxt 1</span></span><br><span class="line">    <span class="keyword">public</span> void map(Object key, Text value, Context context) throws IOException, InterruptedException &#123;</span><br><span class="line">        StringTokenizer itr = <span class="keyword">new</span> <span class="type">StringTokenizer</span>(value.toString());</span><br><span class="line">        <span class="keyword">while</span> (itr.hasMoreTokens()) &#123;</span><br><span class="line">            word.<span class="keyword">set</span>(itr.nextToken());</span><br><span class="line">            context.write(word, one);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Reducer</li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyReducer</span> <span class="keyword">extends</span> <span class="title">Reducer&lt;Text</span>,<span class="title">IntWritable</span>, <span class="title">Text</span>,<span class="title">IntWritable&gt;</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">IntWritable</span> result = <span class="keyword">new</span> <span class="type">IntWritable</span>();</span><br><span class="line"></span><br><span class="line">    public void reduce(<span class="type">Text</span> key, <span class="type">Iterable</span>&lt;<span class="type">IntWritable</span>&gt; values,</span><br><span class="line">                       <span class="type">Context</span> context) <span class="keyword">throws</span> <span class="type">IOException</span>, <span class="type">InterruptedException</span> &#123;</span><br><span class="line">        int sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">IntWritable</span> <span class="keyword">val</span> : values) &#123;</span><br><span class="line">            sum += <span class="keyword">val</span>.get();</span><br><span class="line">        &#125;</span><br><span class="line">        result.set(sum);</span><br><span class="line">        context.write(key, result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Build Artifact jar包，上传到服务器node01</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop jar wordcount<span class="selector-class">.jar</span> com<span class="selector-class">.sxt</span><span class="selector-class">.hadoop</span><span class="selector-class">.mapreduce</span><span class="selector-class">.MyWC</span></span><br></pre></td></tr></table></figure>
<p><a href="http://node04:8088" target="_blank" rel="external">http://node04:8088</a> 查看job执行</p>
<h2 id="MapReduce-Job运行源码解读"><a href="#MapReduce-Job运行源码解读" class="headerlink" title="MapReduce Job运行源码解读"></a>MapReduce Job运行源码解读</h2><h3 id="客户端源码解读"><a href="#客户端源码解读" class="headerlink" title="客户端源码解读"></a>客户端源码解读</h3><ul>
<li>入口 <code>job.waitForCompletion(true);</code></li>
</ul>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">submit(); </span> -&gt; <span class="keyword">submitter.submitJobInternal(Job.this, </span>cluster)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p><code>org.apache.hadoop.mapreduce.JobSubmitter#submitJobInternal</code> 方法</p>
<ul>
<li>计算切片和map，JobSubmitter197行</li>
</ul>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">int maps</span> = writeSplits(job, submitJobDir);</span><br><span class="line"></span><br><span class="line"><span class="attribute">maps</span> = writeNewSplits(job, jobSubmitDir);</span><br></pre></td></tr></table></figure>
<p>ReflectionUtils.newInstatnce  默认 TextInputFormat.class 继承 FileInputFormat</p>
<p>input.getSplits(jb)</p>
<ul>
<li>FileInputFormat#getSplits</li>
</ul>
<p>得到 blocklocations</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blkLocations = fs.getFileBlockLocations(<span class="built_in">file</span>, <span class="number">0</span>, <span class="built_in">length</span>);</span><br></pre></td></tr></table></figure>
<p>计算切片的大小</p>
<p><u>若要切片比块大，配置minSize 比块大，得出的切片大小大于块</u></p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">long splitSize = computeSplitSize(<span class="built_in">block</span>Size, <span class="keyword">min</span>Size, <span class="keyword">max</span>Size);</span><br><span class="line"></span><br><span class="line">Math.<span class="keyword">max</span>(<span class="keyword">min</span>Size, Math.<span class="keyword">min</span>(<span class="keyword">max</span>Size, <span class="built_in">block</span>Size));</span><br></pre></td></tr></table></figure>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">long <span class="keyword">blockSize </span>= file.getBlockSize()<span class="comment">;</span></span><br><span class="line">long splitSize = computeSplitSize(<span class="keyword">blockSize, </span>minSize, maxSize)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">long <span class="keyword">bytesRemaining </span>= length<span class="comment">;</span></span><br><span class="line">while (((double) <span class="keyword">bytesRemaining)/splitSize </span>&gt; SPLIT_SLOP) &#123;</span><br><span class="line">  int <span class="keyword">blkIndex </span>= getBlockIndex(<span class="keyword">blkLocations, </span>length-<span class="keyword">bytesRemaining);</span></span><br><span class="line"><span class="keyword"> </span> splits.<span class="keyword">add(makeSplit(path, </span>length-<span class="keyword">bytesRemaining, </span>splitSize,</span><br><span class="line">              <span class="keyword">blkLocations[blkIndex].getHosts(),</span></span><br><span class="line"><span class="keyword"> </span>             <span class="keyword">blkLocations[blkIndex].getCachedHosts()));</span></span><br><span class="line"><span class="keyword"> </span> <span class="keyword">bytesRemaining </span>-= splitSize<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (<span class="keyword">bytesRemaining </span>!= <span class="number">0</span>) &#123;</span><br><span class="line">  int <span class="keyword">blkIndex </span>= getBlockIndex(<span class="keyword">blkLocations, </span>length-<span class="keyword">bytesRemaining);</span></span><br><span class="line"><span class="keyword"> </span> splits.<span class="keyword">add(makeSplit(path, </span>length-<span class="keyword">bytesRemaining, </span><span class="keyword">bytesRemaining,</span></span><br><span class="line"><span class="keyword"> </span>            <span class="keyword">blkLocations[blkIndex].getHosts(),</span></span><br><span class="line"><span class="keyword"> </span>            <span class="keyword">blkLocations[blkIndex].getCachedHosts()));</span></span><br><span class="line"><span class="keyword">&#125;</span></span><br></pre></td></tr></table></figure>
<p>bytesRemaining剩余的字节数</p>
<p>length-bytesRemaining 得出的就是每个切片的偏移量</p>
<p>getBlockIndex 用切片的偏移量，在哪个块的偏移量和终止偏移量之间，得到第几个块</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">for (<span class="name">int</span> i = <span class="number">0</span> <span class="comment">; i &lt; blkLocations.length; i++) &#123;</span></span><br><span class="line">  // is the offset inside this block?</span><br><span class="line">  if ((<span class="name">blkLocations</span>[i].getOffset() &lt;= offset) <span class="symbol">&amp;&amp;</span></span><br><span class="line">      (<span class="name">offset</span> &lt; blkLocations[i].getOffset() + blkLocations[i].getLength()))&#123;</span><br><span class="line">    return i<span class="comment">;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>makeSplit 完成切片，传递path，切片的偏移量，切片的大小，block的locations的主机信息</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> FileSplit makeSplit(Path file, <span class="keyword">long</span> start, <span class="keyword">long</span> length,</span><br><span class="line">                              <span class="keyword">String</span>[] hosts, <span class="keyword">String</span>[] inMemoryHosts) &#123;</span><br><span class="line">  <span class="built_in">return</span> <span class="keyword">new</span> FileSplit(file, start, length, hosts, inMemoryHosts);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>waitForCompletion submit() -&gt;  submitter.submitJob  -&gt;</p>
<p>197 line -&gt; writeSplites  -&gt; writeNewSplits -&gt;  ReflectionUtils.newInstatnce  默认 TextInputFormat.class</p>
<p>input.getSplits(jb) -&gt;   FileInputFormat继承 -&gt;  minSize最小1 maxSize Long最大值</p>
<p>-》 file.getLen  blkLocatons  -&gt; fs.getFileSystem -&gt; fs.getFileBlockLocations(file ,0 ,length) 拿到文件的block清单</p>
<p>可切片 -》 splitSize = computeSpliteSize() 默认切片大小，minSize 比块大小大，得出的切片大小大于块</p>
<p>=》 FileInputFormt.setMinInputSplitSize(job,128)</p>
<p>getBlockIndex 得到属于第几个块</p>
<p>lenth-byteRemainging <strong>切片</strong>的偏移量 ， 切片的偏移量 在块的偏移量 和 块的结束偏移量之间，得到block的index</p>
<p>文件 切片偏移量 大小 getHosts主机</p>
<p>Thread.sleep -&gt; .tmp/haddp-yarn/staging/root.stagging/_003/ -&gt; jar包 job.split  ;  job.xml 运行配置清单 Mapper class Reduce.class TextFormat.minSize</p>
</blockquote>
<h3 id="Map-Task过程"><a href="#Map-Task过程" class="headerlink" title="Map Task过程"></a>Map Task过程</h3><ul>
<li>Mapper.java</li>
</ul>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void run(<span class="built_in">Context</span> <span class="built_in">context</span>) throws IOException, InterruptedException &#123;</span><br><span class="line">  setup(<span class="built_in">context</span>)<span class="comment">;</span></span><br><span class="line">  try &#123;</span><br><span class="line">    while (<span class="built_in">context</span>.nextKeyValue()) &#123;</span><br><span class="line">      map(<span class="built_in">context</span>.getCurrentKey(), <span class="built_in">context</span>.getCurrentValue(), <span class="built_in">context</span>)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; finally &#123;</span><br><span class="line">    cleanup(<span class="built_in">context</span>)<span class="comment">;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>MapTask.java</li>
</ul>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">public void run(final <span class="keyword">JobConf </span><span class="keyword">job, </span>final TaskUmbilicalProtocol umbilical)</span><br><span class="line">  throws IOException, ClassNotFoundException, InterruptedException &#123;</span><br><span class="line">  this.umbilical = umbilical<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">  if (isMapTask()) &#123;</span><br><span class="line">    if (conf.getNumReduceTasks() == <span class="number">0</span>) &#123;</span><br><span class="line">      mapPhase = getProgress().<span class="keyword">addPhase("map", </span><span class="number">1</span>.<span class="number">0</span>f)<span class="comment">;</span></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      mapPhase = getProgress().<span class="keyword">addPhase("map", </span><span class="number">0</span>.<span class="number">667</span>f)<span class="comment">;</span></span><br><span class="line">      sortPhase  = getProgress().<span class="keyword">addPhase("sort", </span><span class="number">0</span>.<span class="number">333</span>f)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  TaskReporter reporter = startReporter(umbilical)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">boolean </span>useNewApi = <span class="keyword">job.getUseNewMapper();</span></span><br><span class="line"><span class="keyword"> </span> initialize(<span class="keyword">job, </span>getJobID(), reporter, useNewApi)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">  if (<span class="keyword">jobCleanup) </span>&#123;</span><br><span class="line">    runJobCleanupTask(umbilical, reporter)<span class="comment">;</span></span><br><span class="line">    return<span class="comment">;</span></span><br><span class="line">  &#125;</span><br><span class="line">  if (<span class="keyword">jobSetup) </span>&#123;</span><br><span class="line">    runJobSetupTask(umbilical, reporter)<span class="comment">;</span></span><br><span class="line">    return<span class="comment">;</span></span><br><span class="line">  &#125;</span><br><span class="line">  if (taskCleanup) &#123;</span><br><span class="line">    runTaskCleanupTask(umbilical, reporter)<span class="comment">;</span></span><br><span class="line">    return<span class="comment">;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (useNewApi) &#123;</span><br><span class="line">    runNewMapper(<span class="keyword">job, </span>splitMetaInfo, umbilical, reporter)<span class="comment">;</span></span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    runOldMapper(<span class="keyword">job, </span>splitMetaInfo, umbilical, reporter)<span class="comment">;</span></span><br><span class="line">  &#125;</span><br><span class="line">  done(umbilical, reporter)<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>a. conf.getNumReduceTasks() == 0  没有reduce环节，map时间占比100%  比如数据过滤，不经过reducer</p>
<p>b. 否则的话， 经过 map、 排序</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mapPhase</span> = getProgress().addPhase(<span class="string">"map"</span>, 0.667f);</span><br><span class="line"><span class="attribute">sortPhase</span>  = getProgress().addPhase(<span class="string">"sort"</span>, 0.333f);</span><br></pre></td></tr></table></figure>
<p>c. 最后runNewMapper(job, splitMetaInfo, umbilical, reporter);</p>
<ul>
<li>runNewMapper</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> runNewMapper(<span class="keyword">final</span> JobConf job,</span><br><span class="line">                  <span class="keyword">final</span> TaskSplitIndex splitIndex,</span><br><span class="line">                  <span class="keyword">final</span> TaskUmbilicalProtocol umbilical,</span><br><span class="line">                  TaskReporter reporter</span><br><span class="line">                  ) throws IOException, ClassNotFoundException,</span><br><span class="line">                           InterruptedException &#123;</span><br><span class="line">  <span class="comment">// make a task context so we can get the classes</span></span><br><span class="line">  org<span class="variable">.apache</span><span class="variable">.hadoop</span><span class="variable">.mapreduce</span><span class="variable">.TaskAttemptContext</span> taskContext =</span><br><span class="line">    <span class="keyword">new</span> org<span class="variable">.apache</span><span class="variable">.hadoop</span><span class="variable">.mapreduce</span><span class="variable">.task</span><span class="variable">.TaskAttemptContextImpl</span>(job,</span><br><span class="line">                                                                getTaskID(),</span><br><span class="line">                                                                reporter);</span><br><span class="line">  <span class="comment">// make a mapper</span></span><br><span class="line">  org<span class="variable">.apache</span><span class="variable">.hadoop</span><span class="variable">.mapreduce</span><span class="variable">.Mapper</span>&lt;INKEY,INVALUE,OUTKEY,OUTVALUE&gt; mapper =</span><br><span class="line">    (org<span class="variable">.apache</span><span class="variable">.hadoop</span><span class="variable">.mapreduce</span><span class="variable">.Mapper</span>&lt;INKEY,INVALUE,OUTKEY,OUTVALUE&gt;)</span><br><span class="line">      ReflectionUtils<span class="variable">.newInstance</span>(taskContext<span class="variable">.getMapperClass</span>(), job);</span><br><span class="line">  <span class="comment">// make the input format</span></span><br><span class="line">  org<span class="variable">.apache</span><span class="variable">.hadoop</span><span class="variable">.mapreduce</span><span class="variable">.InputFormat</span>&lt;INKEY,INVALUE&gt; inputFormat =</span><br><span class="line">    (org<span class="variable">.apache</span><span class="variable">.hadoop</span><span class="variable">.mapreduce</span><span class="variable">.InputFormat</span>&lt;INKEY,INVALUE&gt;)</span><br><span class="line">      ReflectionUtils<span class="variable">.newInstance</span>(taskContext<span class="variable">.getInputFormatClass</span>(), job);</span><br><span class="line">  <span class="comment">// rebuild the input split</span></span><br><span class="line">  org<span class="variable">.apache</span><span class="variable">.hadoop</span><span class="variable">.mapreduce</span><span class="variable">.InputSplit</span> split = <span class="literal">null</span>;</span><br><span class="line">  split = getSplitDetails(<span class="keyword">new</span> Path(splitIndex<span class="variable">.getSplitLocation</span>()),</span><br><span class="line">      splitIndex<span class="variable">.getStartOffset</span>());</span><br><span class="line">  LOG<span class="variable">.info</span>(<span class="string">"Processing split: "</span> + split);</span><br><span class="line"></span><br><span class="line">  org<span class="variable">.apache</span><span class="variable">.hadoop</span><span class="variable">.mapreduce</span><span class="variable">.RecordReader</span>&lt;INKEY,INVALUE&gt; <span class="keyword">input</span> =</span><br><span class="line">    <span class="keyword">new</span> NewTrackingRecordReader&lt;INKEY,INVALUE&gt;</span><br><span class="line">      (split, inputFormat, reporter, taskContext);</span><br><span class="line"></span><br><span class="line">  job<span class="variable">.setBoolean</span>(JobContext<span class="variable">.SKIP_RECORDS</span>, isSkipping());</span><br><span class="line">  org<span class="variable">.apache</span><span class="variable">.hadoop</span><span class="variable">.mapreduce</span><span class="variable">.RecordWriter</span> <span class="keyword">output</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// get an output object</span></span><br><span class="line">  <span class="keyword">if</span> (job<span class="variable">.getNumReduceTasks</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">output</span> =</span><br><span class="line">      <span class="keyword">new</span> NewDirectOutputCollector(taskContext, job, umbilical, reporter);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">output</span> = <span class="keyword">new</span> NewOutputCollector(taskContext, job, umbilical, reporter);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  org<span class="variable">.apache</span><span class="variable">.hadoop</span><span class="variable">.mapreduce</span><span class="variable">.MapContext</span>&lt;INKEY, INVALUE, OUTKEY, OUTVALUE&gt;</span><br><span class="line">  mapContext =</span><br><span class="line">    <span class="keyword">new</span> MapContextImpl&lt;INKEY, INVALUE, OUTKEY, OUTVALUE&gt;(job, getTaskID(),</span><br><span class="line">        <span class="keyword">input</span>, <span class="keyword">output</span>,</span><br><span class="line">        committer,</span><br><span class="line">        reporter, split);</span><br><span class="line"></span><br><span class="line">  org<span class="variable">.apache</span><span class="variable">.hadoop</span><span class="variable">.mapreduce</span><span class="variable">.Mapper</span>&lt;INKEY,INVALUE,OUTKEY,OUTVALUE&gt;<span class="variable">.Context</span></span><br><span class="line">      mapperContext =</span><br><span class="line">        <span class="keyword">new</span> WrappedMapper&lt;INKEY, INVALUE, OUTKEY, OUTVALUE&gt;()<span class="variable">.getMapContext</span>(</span><br><span class="line">            mapContext);</span><br><span class="line"></span><br><span class="line">  try &#123;</span><br><span class="line">    <span class="keyword">input</span><span class="variable">.initialize</span>(split, mapperContext);</span><br><span class="line">    mapper<span class="variable">.run</span>(mapperContext);</span><br><span class="line">    mapPhase<span class="variable">.complete</span>();</span><br><span class="line">    setPhase(TaskStatus<span class="variable">.Phase</span><span class="variable">.SORT</span>);</span><br><span class="line">    statusUpdate(umbilical);</span><br><span class="line">    <span class="keyword">input</span><span class="variable">.close</span>();</span><br><span class="line">    <span class="keyword">input</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">output</span><span class="variable">.close</span>(mapperContext);</span><br><span class="line">    <span class="keyword">output</span> = <span class="literal">null</span>;</span><br><span class="line">  &#125; finally &#123;</span><br><span class="line">    closeQuietly(<span class="keyword">input</span>);</span><br><span class="line">    closeQuietly(<span class="keyword">output</span>, mapperContext);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反射初始化Mapper，业务实现的Mapper。<code>JobContextImpl</code>查看默认实现。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">org.apache.hadoop.mapreduce.Mapper<span class="tag">&lt;<span class="name">INKEY,INVALUE,OUTKEY,OUTVALUE</span>&gt;</span> mapper =</span><br><span class="line">  (org.apache.hadoop.mapreduce.Mapper<span class="tag">&lt;<span class="name">INKEY,INVALUE,OUTKEY,OUTVALUE</span>&gt;</span>)</span><br><span class="line">    ReflectionUtils.newInstance(taskContext.getMapperClass(), job);</span><br></pre></td></tr></table></figure>
<p>反射工具 Mapper 实例化  InputFormat实例化，JobContextImpl 默认TextINputFormat</p>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">Class</span>&lt;? <span class="keyword">extends</span> <span class="title">InputFormat</span>&lt;?,?&gt;&gt; <span class="title">getInputFormatClass</span>()</span></span><br><span class="line">   throws ClassNotFoundException &#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="class"><span class="keyword">Class</span>&lt;? <span class="keyword">extends</span> <span class="title">InputFormat</span>&lt;?,?&gt;&gt;)</span></span><br><span class="line">    conf.getClass(INPUT_FORMAT_CLASS_ATTR, TextInputFormat.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实例化NewTrakingRecordReader</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">org.apache.hadoop.mapreduce.RecordReader<span class="tag">&lt;<span class="name">INKEY,INVALUE</span>&gt;</span> input =</span><br><span class="line">  new NewTrackingRecordReader<span class="tag">&lt;<span class="name">INKEY,INVALUE</span>&gt;</span></span><br><span class="line">    (split, inputFormat, reporter, taskContext);</span><br></pre></td></tr></table></figure>
<h4 id="MapTask-NewTrackingRecordReader"><a href="#MapTask-NewTrackingRecordReader" class="headerlink" title="MapTask.NewTrackingRecordReader"></a>MapTask.NewTrackingRecordReader</h4><p>line 512 创建 RecordReader</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.<span class="keyword">real</span> = inputFormat.createRecordReader(split, taskContext);</span><br></pre></td></tr></table></figure>
<p>TextInputFormat实现  ， 参数为字节数组，返回 LineRecordReader</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RecordReader&lt;LongWritable, Text&gt;</span><br><span class="line">  createRecordReader(InputSplit <span class="built_in">split</span>,</span><br><span class="line">                     TaskAttemptContext context) &#123;</span><br><span class="line">  <span class="keyword">String</span> delimiter = context.getConfiguration().<span class="built_in">get</span>(</span><br><span class="line">      <span class="string">"textinputformat.record.delimiter"</span>);</span><br><span class="line">  <span class="built_in">byte</span>[] recordDelimiterBytes = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">null</span> != delimiter)</span><br><span class="line">    recordDelimiterBytes = delimiter.getBytes(Charsets.UTF_8);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> LineRecordReader(recordDelimiterBytes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MapContextImpl的实现都是委托给LIneRecordReder  reader.getCurrentKey reader.nestKeyValue()</p>
<h4 id="LineRecordReader"><a href="#LineRecordReader" class="headerlink" title="LineRecordReader"></a>LineRecordReader</h4><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> LineRecordReader(Configuration job, FileSplit <span class="built_in">split</span>,</span><br><span class="line">    <span class="built_in">byte</span>[] recordDelimiter) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="keyword">this</span>.maxLineLength = job.getInt(org.apache.hadoop.mapreduce.lib.input.</span><br><span class="line">    LineRecordReader.MAX_LINE_LENGTH, Integer.MAX_VALUE);</span><br><span class="line">  start = <span class="built_in">split</span>.getStart();</span><br><span class="line">  end = start + <span class="built_in">split</span>.getLength();</span><br><span class="line">  <span class="keyword">final</span> Path file = <span class="built_in">split</span>.getPath();</span><br><span class="line">  compressionCodecs = <span class="keyword">new</span> CompressionCodecFactory(job);</span><br><span class="line">  codec = compressionCodecs.getCodec(file);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> FileSystem fs = file.getFileSystem(job);</span><br><span class="line">  fileIn = fs.<span class="built_in">open</span>(file);</span><br><span class="line">  <span class="keyword">if</span> (isCompressedInput()) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    fileIn.seek(start);</span><br><span class="line">    in = <span class="keyword">new</span> UncompressedSplitLineReader(</span><br><span class="line">        fileIn, job, recordDelimiter, <span class="built_in">split</span>.getLength());</span><br><span class="line">    filePosition = fileIn;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (start != <span class="number">0</span>) &#123;</span><br><span class="line">    start += in.readLine(<span class="keyword">new</span> Text(), <span class="number">0</span>, maxBytesToConsume(start));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.pos = start;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>fileIn.seek(start)直接从切片的偏移量开始读</p>
<p>start !=0 第二个切片开始都要处理， in.readLine(new Text(),0,) 读出第一行，换行符，不用，算出字节数</p>
<p>start  = start + 数值 ，这样处理一行文本，被拆分到多个block的情况。</p>
<blockquote>
<p>mappper  -&gt; map 重写 -&gt;  输入 输出 context.write</p>
<p>340行 runNewMapper  try finally  初始化  mapper.run 排序 释放  关闭</p>
<p>反射工具 Mapper 实例化  InputFormat实例化，默认TextINputFormat  hadoop中spilte spark中是partition</p>
<p>NewTrakingRecordReader 512行  inputFormat.createRecordReader -&gt; new LIneRecordReder 重要</p>
<p>MapContextImpl的实现 都是LIneRecordReder  reader.getCurrentKey reader.nestKeyValue()</p>
<p>LIneRecordReader initlize <em>host信息</em>已经在分配container做了，fileIn.seek(start)直接冲切片的偏移量开始读</p>
<p>start !=0 第二个切片开始都要处理， in.readLine(new Text(),0,) 读出第一行，换行符，不适用，算出字节数，start  = start + 数值</p>
<p>每个切片都会多读1行，LineRecordReader ， 数据移动都是小量的</p>
</blockquote>
<p><strong>计算都是和fs拿文件，不是block块</strong></p>
<p>this.pos = start 切片的第二行的偏移量</p>
<p>LIneRecordReader nextKeyValue key value赋值</p>
<p>output reducer数据为0  直接速出</p>
<p>NewOUtputCollerctor reduce数量就是partition数</p>
<p>只有1个分区，Partioner分区器，0</p>
<p>大于1的时候，morning hashPartitioner   key.hashCOde &amp; Integer.max % reducetaskNum</p>
<p> 输出 k ,v ，变为 k,v,p</p>
<p>createSorting MapoutBuffer  初始化  sortmb 内存缓冲区  sorter 快排  comparotor 默认</p>
<p>设置排序器，没有取key的Text的默认</p>
<p>MapTask</p>
<p>combiner:  被移植到map阶段的reducerTask  小reducer    map输出一次，归并一次</p>
<p>MapoutBuffer  80%溢出写，中间20%继续，不会阻塞</p>
<p>map的输出 到 环形缓冲器  key和索引都放进去去  赤道  比较，索引换位置即可</p>
<ul>
<li>MapTask&amp;MapOutBuffer</li>
</ul>
<p>spillyixie 次数 小于</p>
<ul>
<li>SplliThread run</li>
</ul>
<h3 id="Reducer-过程"><a href="#Reducer-过程" class="headerlink" title="Reducer 过程"></a>Reducer 过程</h3><ul>
<li>ReducerTask</li>
</ul>
<p>ReducerTask run方法   line 376 触发shuffer过程 拉取数据。RawKeyValueIterator rIter 获取真迭代器，传入到reducerContext中。</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    org.apache.hadoop.mapreduce.Reducer.Context</span><br><span class="line">       reducerContext = createReduceContext(reducer, job, getTaskID(),</span><br><span class="line"><span class="built_in">                                             rIter,</span> reduceInputKeyCounter,</span><br><span class="line"><span class="built_in">                                             reduceInputValueCounter,</span></span><br><span class="line"><span class="built_in">                                             trackedRW,</span></span><br><span class="line"><span class="built_in">                                             committer,</span></span><br><span class="line"><span class="built_in">                                             reporter,</span> comparator, keyClass,</span><br><span class="line">                                             valueClass)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">try &#123;</span><br><span class="line">    reducer.run(reducerContext)<span class="comment">;</span></span><br><span class="line">  &#125; finally &#123;</span><br><span class="line">    trackedRW.close(reducerContext)<span class="comment">;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>627 reduce.run 创建上下文</p>
<ul>
<li>Reducer</li>
</ul>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public void run(<span class="built_in">Context</span> <span class="built_in">context</span>) throws IOException, InterruptedException &#123;</span><br><span class="line">  setup(<span class="built_in">context</span>)<span class="comment">;</span></span><br><span class="line">  try &#123;</span><br><span class="line">    while (<span class="built_in">context</span>.nextKey()) &#123;</span><br><span class="line">      reduce(<span class="built_in">context</span>.getCurrentKey(), <span class="built_in">context</span>.getValues(), <span class="built_in">context</span>)<span class="comment">;</span></span><br><span class="line">      Iterator&lt;VALUEIN&gt; iter = <span class="built_in">context</span>.getValues().iterator()<span class="comment">;</span></span><br><span class="line">      if(iter <span class="keyword">instanceof </span>ReduceContext.ValueIterator) &#123;</span><br><span class="line">        ((ReduceContext.ValueIterator&lt;VALUEIN&gt;)iter).resetBackupStore()<span class="comment">;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; finally &#123;</span><br><span class="line">    cleanup(<span class="built_in">context</span>)<span class="comment">;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>reduce方法用户重写</p>
<ul>
<li>ReduceContextImpl</li>
</ul>
<p>nextKeyValue()   从真迭代器取值，line138</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">DataInputBuffer nextKey</span> = input.getKey();</span><br></pre></td></tr></table></figure>
<p>line 158 nextKeyIsSame根据分组比较器，比较下一次的key是否相同。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">hasMore</span> = input.next();</span><br><span class="line"><span class="attribute">if</span> (hasMore) &#123;</span><br><span class="line">  <span class="attribute">nextKey</span> = input.getKey();</span><br><span class="line">  <span class="attribute">nextKeyIsSame</span> = comparator.compare(currentRawKey.getBytes(), <span class="number">0</span>,</span><br><span class="line">                                 currentRawKey.getLength(),</span><br><span class="line">                                 nextKey.getData(),</span><br><span class="line">                                 nextKey.getPosition(),</span><br><span class="line">                                 nextKey.getLength() - nextKey.getPosition()</span><br><span class="line">                                     ) == <span class="number">0</span>;</span><br><span class="line">&#125; <span class="section">else</span> &#123;</span><br><span class="line">  <span class="attribute">nextKeyIsSame</span> = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假迭代器，getValues方法返回</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ValueIterable iterable = <span class="keyword">new</span> <span class="type">ValueIterable</span>();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>doc文档</p>
<p>map中是无序到有序</p>
<p>reducer都是归并排序</p>
<p>ReduceTask run   line 376 触发shuffer过程 拉取数据，没有spark优美,，真迭代器rIter</p>
<p>386 map task 环形缓冲区 的  。 分区比较器</p>
<p>map task 用户设置，没有则取key自身的排序器</p>
<p>reduce task 用户设置，<u>分组比较器-》 排序比较器</u>，没有取value自身的排序</p>
<p>627 reduce.run 创建上下文</p>
<p>Reducer.class run  nexyKye nextKey 放空过</p>
<p>ReduceContestImpl.class nextKeyValue()   从真迭代器取值</p>
<p>hasMore nextKeyIsSmae  分组比较器 当前和取下一次的比较</p>
<p>getValues iterable ValueIterrable 假。迭代器</p>
<p>239行</p>
</blockquote>
<h4 id="案例-每个月最高气温的2天"><a href="#案例-每个月最高气温的2天" class="headerlink" title="案例 每个月最高气温的2天"></a>案例 每个月最高气温的2天</h4><ul>
<li><p>MyMain 主入口</p>
</li>
<li><p>TMapper</p>
</li>
<li><p>TSorterComparator 排序比较器。MapTask阶段用，80%环形缓冲区溢写，快排。</p>
</li>
<li><p>TPartition 分区比较器，决定key到哪个分区。分区数即reducerTask数。要么重写key的hash equals ,否则重写分区器。</p>
</li>
<li><p>TGroupComparator 分组比较器，ReducerTask阶段用。决定key是不是一组。</p>
</li>
</ul>
<h4 id="案例-词频搜索-TF-IDF"><a href="#案例-词频搜索-TF-IDF" class="headerlink" title="案例 词频搜索 TF*IDF"></a>案例 词频搜索 TF*IDF</h4><p>微博账号总数、一个词有多少个微博包含</p>
<p>addCacheFile  每个map发送过去，作为本地文件</p>
<p>TF * idF</p>
<p>LastJob</p>
<p>LastMapper</p>
<ul>
<li>setup</li>
</ul>
<p>数据集不是很大，很其他map都要关联</p>
<p>cmap  : count 微博总数</p>
<p>df： 一个词有多少个微博包含</p>
<h4 id="案例-电商广告推荐"><a href="#案例-电商广告推荐" class="headerlink" title="案例 电商广告推荐"></a>案例 电商广告推荐</h4><p>UserCF 用户的相似性，协同过滤</p>
<p>ItemCF 基于物品的协同过滤</p>
<p>MapReducer</p>
<p>用户评分向量</p>
<p>u1 : i1 i2 i3</p>
<p>u2: i2 i3</p>
<ul>
<li>setp1</li>
</ul>
<p>NullWrite.get() 不写</p>
<p>Run as java Application</p>
<ul>
<li>setp2</li>
</ul>
<p>用户评分向量</p>
<ul>
<li>setp3</li>
</ul>
<p>同现矩阵 对称矩阵</p>
<ul>
<li>setp4</li>
</ul>
<p>setup</p>
<p>矩阵 * 向量</p>
<p>reduce相同的key为一组，物品作为Key</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/03/31/centos7虚拟机配置及网络配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/31/centos7虚拟机配置及网络配置/" itemprop="url">centos7虚拟机配置及网络配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-31T20:45:51+08:00">
                2019-03-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/运维/" itemprop="url" rel="index">
                    <span itemprop="name">运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/31/centos7虚拟机配置及网络配置/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/03/31/centos7虚拟机配置及网络配置/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  200
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="虚拟机配置"><a href="#虚拟机配置" class="headerlink" title="虚拟机配置"></a>虚拟机配置</h2><ol>
<li>添加虚拟机，选择centos7镜像</li>
<li>移除原有的网络适配器，添加网络适配器，选择<strong>桥接方式</strong></li>
</ol>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2019/03/31/centos7虚拟机配置及网络配置/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/03/28/flume集群安装部署文档/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/28/flume集群安装部署文档/" itemprop="url">flume集群安装部署文档</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-28T22:37:08+08:00">
                2019-03-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/28/flume集群安装部署文档/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/03/28/flume集群安装部署文档/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.3k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  7
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="单节点"><a href="#单节点" class="headerlink" title="单节点"></a>单节点</h2><h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#a-simple-example" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#a-simple-example</a></p>
</blockquote>
<h3 id="上传解压"><a href="#上传解压" class="headerlink" title="上传解压"></a>上传解压</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp apache-flume-<span class="number">1.6</span>.<span class="number">0</span>-bin<span class="selector-class">.tar</span><span class="selector-class">.gz</span> root@node02:/root</span><br><span class="line">tar -zxvf apache-flume-<span class="number">1.6</span>.<span class="number">0</span>-bin<span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">mv apache-flume-<span class="number">1.6</span>.<span class="number">0</span>-bin/ /usr/install/</span><br></pre></td></tr></table></figure>
<h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export FLUME_HOME=/usr/<span class="keyword">install</span>/apache-flume<span class="number">-1.6</span><span class="number">.0</span>-<span class="keyword">bin</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">PATH</span>=$<span class="keyword">PATH</span>:$ZOOKEEPER_HOME/<span class="keyword">bin</span>:$HADOOP_HOME/<span class="keyword">bin</span>:$HADOOP_HOME/sbin:$HIVE_HOME/<span class="keyword">bin</span>:$HBASE_HOME/<span class="keyword">bin</span>:$FLUME_HOME/<span class="keyword">bin</span></span><br></pre></td></tr></table></figure>
<h3 id="修改conf-flume-env-sh-文件中的JDK目录"><a href="#修改conf-flume-env-sh-文件中的JDK目录" class="headerlink" title="修改conf/flume-env.sh  文件中的JDK目录"></a>修改conf/flume-env.sh  文件中的JDK目录</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp flume-env<span class="selector-class">.sh</span><span class="selector-class">.template</span> flume-env.sh</span><br><span class="line">vi flume-env.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">JAVA_HOME</span>=/usr/install/jdk/jdk1.8.0_171</span><br></pre></td></tr></table></figure>
<h3 id="验证安装是否成功"><a href="#验证安装是否成功" class="headerlink" title="验证安装是否成功"></a>验证安装是否成功</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng <span class="built_in">version</span></span><br></pre></td></tr></table></figure>
<h3 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> <span class="keyword">conf</span>/</span><br><span class="line"><span class="keyword">vi</span> simple.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Name the components on this agent</span></span><br><span class="line"><span class="built_in">a1</span>.sources = r1</span><br><span class="line"><span class="built_in">a1</span>.sinks = <span class="built_in">k1</span></span><br><span class="line"><span class="built_in">a1</span>.channels = c1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe/configure the source</span></span><br><span class="line"><span class="built_in">a1</span>.sources.r1.type = netcat</span><br><span class="line"><span class="built_in">a1</span>.sources.r1.<span class="keyword">bind </span>= node02</span><br><span class="line"><span class="built_in">a1</span>.sources.r1.port = <span class="number">44444</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe the sink</span></span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.type = logger</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use a channel which buffers events in memory</span></span><br><span class="line"><span class="built_in">a1</span>.channels.c1.type = memory</span><br><span class="line"><span class="built_in">a1</span>.channels.c1.capacity = <span class="number">1000</span></span><br><span class="line"><span class="built_in">a1</span>.channels.c1.transactionCapacity = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the source and sink to the channel</span></span><br><span class="line"><span class="built_in">a1</span>.sources.r1.channels = c1</span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>
<h3 id="启动flume"><a href="#启动flume" class="headerlink" title="启动flume"></a>启动flume</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent -n a1 -c conf -f simple<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h3 id="发送数据"><a href="#发送数据" class="headerlink" title="发送数据"></a>发送数据</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet node<span class="number">02 44444</span></span><br></pre></td></tr></table></figure>
<h2 id="两个flume做集群"><a href="#两个flume做集群" class="headerlink" title="两个flume做集群"></a>两个flume做集群</h2><h3 id="参考文档-1"><a href="#参考文档-1" class="headerlink" title="参考文档"></a>参考文档</h3><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#setting-multi-agent-flow" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#setting-multi-agent-flow</a></p>
</blockquote>
<h3 id="右侧节点-node03"><a href="#右侧节点-node03" class="headerlink" title="右侧节点(node03)"></a>右侧节点(node03)</h3><h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#avro-source" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#avro-source</a></p>
</blockquote>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> double-flume.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Name the components on this agent</span></span><br><span class="line"><span class="built_in">a1</span>.sources = r1</span><br><span class="line"><span class="built_in">a1</span>.sinks = <span class="built_in">k1</span></span><br><span class="line"><span class="built_in">a1</span>.channels = c1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe/configure the source</span></span><br><span class="line"><span class="built_in">a1</span>.sources.r1.type = avro</span><br><span class="line"><span class="built_in">a1</span>.sources.r1.<span class="keyword">bind </span>= node03</span><br><span class="line"><span class="built_in">a1</span>.sources.r1.port = <span class="number">60000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe the sink</span></span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.type = logger</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use a channel which buffers events in memory</span></span><br><span class="line"><span class="built_in">a1</span>.channels.c1.type = memory</span><br><span class="line"><span class="built_in">a1</span>.channels.c1.capacity = <span class="number">1000</span></span><br><span class="line"><span class="built_in">a1</span>.channels.c1.transactionCapacity = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the source and sink to the channel</span></span><br><span class="line"><span class="built_in">a1</span>.sources.r1.channels = c1</span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent  -n a1 -c conf -f double-flume<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h3 id="左侧节点-node02"><a href="#左侧节点-node02" class="headerlink" title="左侧节点(node02)"></a>左侧节点(node02)</h3><h4 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h4><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#avro-sink" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#avro-sink</a></p>
</blockquote>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -r apache-flume-<span class="number">1.6</span>.<span class="number">0</span>-bin/ root<span class="variable">@node03</span><span class="symbol">:/usr/install</span></span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> double-flume.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">a1</span>.sources = r1</span><br><span class="line"><span class="built_in">a1</span>.sinks = <span class="built_in">k1</span></span><br><span class="line"><span class="built_in">a1</span>.channels = c1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe/configure the source</span></span><br><span class="line"><span class="built_in">a1</span>.sources.r1.type = netcat</span><br><span class="line"><span class="built_in">a1</span>.sources.r1.<span class="keyword">bind </span>= node02</span><br><span class="line"><span class="built_in">a1</span>.sources.r1.port = <span class="number">44444</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe the sink</span></span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.type = avro</span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.hostname = node03</span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.port = <span class="number">60000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use a channel which buffers events in memory</span></span><br><span class="line"><span class="built_in">a1</span>.channels.c1.type = memory</span><br><span class="line"><span class="built_in">a1</span>.channels.c1.capacity = <span class="number">1000</span></span><br><span class="line"><span class="built_in">a1</span>.channels.c1.transactionCapacity = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the source and sink to the channel</span></span><br><span class="line"><span class="built_in">a1</span>.sources.r1.channels = c1</span><br><span class="line"><span class="built_in">a1</span>.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>
<h4 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent  -n a1 -c conf -f double-flume<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h3 id="发送数据-1"><a href="#发送数据-1" class="headerlink" title="发送数据"></a>发送数据</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet node<span class="number">02 44444</span></span><br></pre></td></tr></table></figure>
<h2 id="Exec-Source方式，监控文件tail命令"><a href="#Exec-Source方式，监控文件tail命令" class="headerlink" title="Exec Source方式，监控文件tail命令"></a>Exec Source方式，监控文件tail命令</h2><h3 id="参考-2"><a href="#参考-2" class="headerlink" title="参考"></a>参考</h3><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#exec-source" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#exec-source</a></p>
</blockquote>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> exec.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">a1.<span class="attr">sources</span> = r1</span><br><span class="line">a1.<span class="attr">sinks</span> = k1</span><br><span class="line">a1.<span class="attr">channels</span> = c1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe/configure the source</span></span><br><span class="line">a1.sources.r1.<span class="attr">type</span> = exec</span><br><span class="line">a1.sources.r1.<span class="attr">command</span> = tail -F /root/test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe the sink</span></span><br><span class="line">a1.sinks.k1.<span class="attr">type</span> = logger</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use a channel which buffers events in memory</span></span><br><span class="line">a1.channels.c1.<span class="attr">type</span> = memory</span><br><span class="line">a1.channels.c1.<span class="attr">capacity</span> = <span class="number">1000</span></span><br><span class="line">a1.channels.c1.<span class="attr">transactionCapacity</span> = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the source and sink to the channel</span></span><br><span class="line">a1.sources.r1.<span class="attr">channels</span> = c1</span><br><span class="line">a1.sinks.k1.<span class="attr">channel</span> = c1</span><br></pre></td></tr></table></figure>
<h3 id="启动-2"><a href="#启动-2" class="headerlink" title="启动"></a>启动</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent -n a1 -c conf -f exec<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h3 id="添加数据"><a href="#添加数据" class="headerlink" title="添加数据"></a>添加数据</h3><p>循环添加数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..50&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">"<span class="variable">$i</span> hi flume"</span> &gt;&gt; /root/test.txt ; sleep 0.1; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h2 id="Spooling-Directory-Source监控目录"><a href="#Spooling-Directory-Source监控目录" class="headerlink" title="Spooling Directory Source监控目录"></a>Spooling Directory Source监控目录</h2><h3 id="参考-3"><a href="#参考-3" class="headerlink" title="参考"></a>参考</h3><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#spooling-directory-source" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#spooling-directory-source</a></p>
</blockquote>
<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> spool.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">a1.<span class="attr">sources</span> = r1</span><br><span class="line">a1.<span class="attr">sinks</span> = k1</span><br><span class="line">a1.<span class="attr">channels</span> = c1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe/configure the source</span></span><br><span class="line">a1.sources.r1.<span class="attr">type</span> = spooldir</span><br><span class="line">a1.sources.r1.<span class="attr">spoolDir</span> = /root/logs</span><br><span class="line">a1.sources.r1.<span class="attr">fileHeader</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe the sink</span></span><br><span class="line">a1.sinks.k1.<span class="attr">type</span> = logger</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use a channel which buffers events in memory</span></span><br><span class="line">a1.channels.c1.<span class="attr">type</span> = memory</span><br><span class="line">a1.channels.c1.<span class="attr">capacity</span> = <span class="number">1000</span></span><br><span class="line">a1.channels.c1.<span class="attr">transactionCapacity</span> = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the source and sink to the channel</span></span><br><span class="line">a1.sources.r1.<span class="attr">channels</span> = c1</span><br><span class="line">a1.sinks.k1.<span class="attr">channel</span> = c1</span><br></pre></td></tr></table></figure>
<h3 id="启动-3"><a href="#启动-3" class="headerlink" title="启动"></a>启动</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent -n a1 -c conf -f spool<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h3 id="拷贝文件演示"><a href="#拷贝文件演示" class="headerlink" title="拷贝文件演示"></a>拷贝文件演示</h3><pre><code>mkdir logs
mv aa logs/
</code></pre><h2 id="flume和kafka"><a href="#flume和kafka" class="headerlink" title="flume和kafka"></a>flume和kafka</h2><p>两者经常配对使用，谁在前后都可以</p>
<h2 id="hdfs-sink方式"><a href="#hdfs-sink方式" class="headerlink" title="hdfs sink方式"></a>hdfs sink方式</h2><h3 id="参考-4"><a href="#参考-4" class="headerlink" title="参考"></a>参考</h3><blockquote>
<p><a href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#hdfs-sink" target="_blank" rel="external">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#hdfs-sink</a></p>
</blockquote>
<h3 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> hdfs-sink.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">a1.<span class="attr">sources</span> = r1</span><br><span class="line">a1.<span class="attr">sinks</span> = k1</span><br><span class="line">a1.<span class="attr">channels</span> = c1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe/configure the source</span></span><br><span class="line">a1.sources.r1.<span class="attr">type</span> = spooldir</span><br><span class="line">a1.sources.r1.<span class="attr">spoolDir</span> = /root/logs</span><br><span class="line">a1.sources.r1.<span class="attr">fileHeader</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe the sink 文件目录格式</span></span><br><span class="line">a1.sinks.k1.<span class="attr">type=hdfs</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">path=hdfs://mycluster/flume/%Y-%m-%d/%H%M</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##每隔60s或者文件大小超过10M的时候产生新文件，roll对文件设置</span></span><br><span class="line"><span class="comment"># hdfs有多少条消息时新建文件，0不基于消息个数</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">rollCount=0</span></span><br><span class="line"><span class="comment"># hdfs创建多长时间新建文件，0不基于时间</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">rollInterval=60</span></span><br><span class="line"><span class="comment"># hdfs多大时新建文件，0不基于文件大小</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">rollSize=10240</span></span><br><span class="line"><span class="comment"># 当目前被打开的临时文件在该参数指定的时间（秒）内，没有任何数据写入，则将该临时文件关闭并重命名成目标文件</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">idleTimeout=3</span></span><br><span class="line"></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">fileType=DataStream</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">useLocalTimeStamp=true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 每五分钟生成一个目录，round对目录设置</span></span><br><span class="line"><span class="comment"># 是否启用时间上的”舍弃”，这里的”舍弃”，类似于”四舍五入”，后面再介绍。如果启用，则会影响除了%t的其他所有时间表达式</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">round=true</span></span><br><span class="line"><span class="comment"># 时间上进行“舍弃”的值；</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">roundValue=5</span></span><br><span class="line"><span class="comment"># 时间上进行”舍弃”的单位，包含：second,minute,hour</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">roundUnit=minute</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use a channel which buffers events in memory</span></span><br><span class="line">a1.channels.c1.<span class="attr">type</span> = memory</span><br><span class="line">a1.channels.c1.<span class="attr">capacity</span> = <span class="number">1000</span></span><br><span class="line">a1.channels.c1.<span class="attr">transactionCapacity</span> = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the source and sink to the channel</span></span><br><span class="line">a1.sources.r1.<span class="attr">channels</span> = c1</span><br><span class="line">a1.sinks.k1.<span class="attr">channel</span> = c1</span><br></pre></td></tr></table></figure>
<h3 id="启动-4"><a href="#启动-4" class="headerlink" title="启动"></a>启动</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent -n a1 -c conf -f hdfs-sink<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h3 id="拷贝文件演示-1"><a href="#拷贝文件演示-1" class="headerlink" title="拷贝文件演示"></a>拷贝文件演示</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> logs</span><br><span class="line">mv aa logs/</span><br></pre></td></tr></table></figure>
<h2 id="tengine和flume集成项目"><a href="#tengine和flume集成项目" class="headerlink" title="tengine和flume集成项目"></a>tengine和flume集成项目</h2><h3 id="配置-3"><a href="#配置-3" class="headerlink" title="配置"></a>配置</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> tengine_project.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">a1.<span class="attr">sources</span> = r1</span><br><span class="line">a1.<span class="attr">sinks</span> = k1</span><br><span class="line">a1.<span class="attr">channels</span> = c1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 监听tengine的access log文件</span></span><br><span class="line">a1.sources.r1.<span class="attr">type</span> = exec</span><br><span class="line">a1.sources.r1.<span class="attr">command</span> = tail -F /opt/data/access.log</span><br><span class="line"></span><br><span class="line">a1.sinks.k1.<span class="attr">type=hdfs</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">path=hdfs://mycluster/log/%Y%m%d</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">rollCount=0</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">rollInterval=0</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">rollSize=10240</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">idleTimeout=5</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">fileType=DataStream</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">useLocalTimeStamp=true</span></span><br><span class="line">a1.sinks.k1.hdfs.<span class="attr">callTimeout=40000</span></span><br><span class="line"></span><br><span class="line">a1.channels.c1.<span class="attr">type</span> = memory</span><br><span class="line">a1.channels.c1.<span class="attr">capacity</span> = <span class="number">1000</span></span><br><span class="line">a1.channels.c1.<span class="attr">transactionCapacity</span> = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">a1.sources.r1.<span class="attr">channels</span> = c1</span><br><span class="line">a1.sinks.k1.<span class="attr">channel</span> = c1</span><br></pre></td></tr></table></figure>
<h3 id="启动-5"><a href="#启动-5" class="headerlink" title="启动"></a>启动</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flume-ng agent -n a1 -c conf -f tengine_project<span class="selector-class">.conf</span> -Dflume<span class="selector-class">.root</span><span class="selector-class">.logger</span>=INFO,console</span><br></pre></td></tr></table></figure>
<h3 id="拷贝文件演示-2"><a href="#拷贝文件演示-2" class="headerlink" title="拷贝文件演示"></a>拷贝文件演示</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> logs</span><br><span class="line">mv aa logs/</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/03/28/hadoop集群安装部署文档/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/28/hadoop集群安装部署文档/" itemprop="url">Hadoop HDFS集群安装部署文档</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-28T22:37:08+08:00">
                2019-03-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/28/hadoop集群安装部署文档/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/03/28/hadoop集群安装部署文档/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.4k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  12
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="伪集群安装方式"><a href="#伪集群安装方式" class="headerlink" title="伪集群安装方式"></a>伪集群安装方式</h2><h3 id="1-JAVA-HOME配置"><a href="#1-JAVA-HOME配置" class="headerlink" title="1.JAVA_HOME配置"></a>1.<code>JAVA_HOME</code>配置</h3><p>编辑<code>/etc/profile</code>，配置如下</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">JAVA_HOME</span>=/usr/install/jdk/jdk1.8.0_171</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="variable">$PATH</span>:$&#123;JAVA_HOME&#125;/bin</span><br></pre></td></tr></table></figure>
<h3 id="2-HADOOP-HOME配置"><a href="#2-HADOOP-HOME配置" class="headerlink" title="2.HADOOP_HOME配置"></a>2.<code>HADOOP_HOME</code>配置</h3><p>编辑<code>/etc/profile</code>，配置如下</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">HADOOP_HOME</span>=/opt/sxt/hadoop-2.6.5</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="variable">$PATH</span>:$HADOOP_HOME/bin:$HADOOP_HOME/sbin</span><br></pre></td></tr></table></figure>
<h3 id="3-配置hostname"><a href="#3-配置hostname" class="headerlink" title="3.配置hostname"></a>3.配置<code>hostname</code></h3><p>编辑<code>/etc/hostname</code></p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">node01</span></span><br></pre></td></tr></table></figure>
<p>编辑<code>/etc/sysconfig\network</code>，配置如下</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">NETWORKING</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">HOSTNAME</span>=node01</span><br><span class="line"><span class="attr">GATEWAY</span>=<span class="number">192.168</span>.<span class="number">0.255</span></span><br></pre></td></tr></table></figure>
<p>配置静态ip，参考“centos7虚拟机配置”</p>
<p>配置hosts <code>vi /etc/hosts</code></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.151</span> <span class="selector-tag">node01</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.152</span> <span class="selector-tag">node02</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.153</span> <span class="selector-tag">node03</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.154</span> <span class="selector-tag">node04</span></span><br></pre></td></tr></table></figure>
<p>执行<code>hostname node01</code></p>
<p>执行<code>uname -n</code>，查看hostname ，为node1配置正常。</p>
<h3 id="4-配置ssh"><a href="#4-配置ssh" class="headerlink" title="4.配置ssh"></a>4.配置<code>ssh</code></h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t dsa -P <span class="string">''</span> -f ~<span class="regexp">/.ssh/id</span>_dsa</span><br><span class="line">cat ~<span class="regexp">/.ssh/id</span>_dsa.pub <span class="meta">&gt;&gt; </span>~<span class="regexp">/.ssh/authorized</span>_keys</span><br></pre></td></tr></table></figure>
<p>执行<code>ssh node01</code>，正常连接。</p>
<h3 id="5-配置core-site-xml"><a href="#5-配置core-site-xml" class="headerlink" title="5.配置core-site.xml"></a>5.配置<code>core-site.xml</code></h3><p>编辑<code>/opt/sxt/hadoop-2.6.5/etc/hadoop/core-site.xml</code></p>
<p>配置<code>namenode</code>的内存持久化存储地址，hdfs是其中一种。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://node01:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>vi命令,<code>4yy</code>复制4行，<code>np</code>再进行粘贴</p>
<p>配置<code>hadoop.tmp.dir</code>，根据<a href="https://hadoop.apache.org/docs/r2.6.5/hadoop-project-dist/hadoop-common/core-default.xml" target="_blank" rel="external">core-default.xml</a>的配置，默认配置是临时tmp目录<code>/tmp/hadoop-${user.name}</code>，会有被删除的风险。根据<a href="https://hadoop.apache.org/docs/r2.6.5/hadoop-project-dist/hadoop-hdfs/hdfs-default.xml" target="_blank" rel="external">hdfs-default.xml</a>的配置，<code>dfs.namenode.name.dir</code>的默认配置为<code>file://${hadoop.tmp.dir}/dfs/name</code>，<code>dfs.datanode.data.dir</code>的默认配置为<code>file://${hadoop.tmp.dir}/dfs/data</code>。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line">    <span class="params">&lt;name&gt;</span>hadoop.tmp.dir<span class="params">&lt;/name&gt;</span></span><br><span class="line">    <span class="params">&lt;value&gt;</span><span class="meta-keyword">/var/</span>sxt<span class="meta-keyword">/hadoop/</span>local<span class="params">&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="6-配置hdfs-site-xml"><a href="#6-配置hdfs-site-xml" class="headerlink" title="6.配置hdfs-site.xml"></a>6.配置<code>hdfs-site.xml</code></h3><p>编辑<code>/opt/sxt/hadoop-2.6.5/etc/hadoop/hdfs-site.xml</code></p>
<p>配置<code>dfs.replication</code> block的副本为1，因为伪集群只有一个节点。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>vi 4yy，再np粘贴</p>
<p>配置<code>secondary</code>的地址</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.secondary.http-address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>node01:50090<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="7-配置hadoop-env-sh"><a href="#7-配置hadoop-env-sh" class="headerlink" title="7.配置hadoop-env.sh"></a>7.配置<code>hadoop-env.sh</code></h3><p>编辑<code>/opt/sxt/hadoop-2.6.5/etc/hadoop/hadoop-env.xml</code>，因为ssh免登会读不到<code>JAVA_HOME</code>的环境变量。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The java implementation to use.</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">JAVA_HOME</span>=/usr/install/jdk/jdk1.8.0_171</span><br></pre></td></tr></table></figure>
<h3 id="8-hdfs格式化"><a href="#8-hdfs格式化" class="headerlink" title="8.hdfs格式化"></a>8.hdfs格式化</h3><p>格式化<code>namenode</code>，<code>/var/sxt/hadoop/local</code>目录下会出现。生产环境，谨慎操作</p>
<ul>
<li>data</li>
<li>name</li>
<li>namesecondary</li>
</ul>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs namenode -<span class="built_in">format</span></span><br></pre></td></tr></table></figure>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">start</span>-dfs.sh</span><br></pre></td></tr></table></figure>
<p>此时jps查看启动<code>NameNode</code> <code>DataNode</code> <code>SecondaryNameNode</code> 三个进程</p>
<p><code>cat /var/sxt/hadoop/local/dfs/data/current/VERSION</code>，<code>clusterID</code>为集群id，一个集群的相同。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Fri Mar 29 23:44:23 CST 2019</span></span><br><span class="line"><span class="attr">storageID</span>=DS-ecfbb1c3-<span class="number">3054</span>-<span class="number">432</span>b-adc1-<span class="number">3</span>d0420278192</span><br><span class="line"><span class="attr">clusterID</span>=CID-<span class="number">56727752</span>-<span class="number">38</span>bd-<span class="number">4609</span>-<span class="number">8</span>a00-e3166867c072</span><br><span class="line"><span class="attr">cTime</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">datanodeUuid</span>=<span class="number">43</span>d62867-<span class="number">0669</span>-<span class="number">4277</span>-b37f-<span class="number">859</span>f7194bc51</span><br><span class="line"><span class="attr">storageType</span>=DATA_NODE</span><br><span class="line"><span class="attr">layoutVersion</span>=-<span class="number">56</span></span><br></pre></td></tr></table></figure>
<h3 id="9-为root用户创建用户目录"><a href="#9-为root用户创建用户目录" class="headerlink" title="9.为root用户创建用户目录"></a>9.为root用户创建用户目录</h3><p><code>hdfs dfs -mkdir /user/root</code></p>
<p>浏览器查看<code>[http://192.168.0.117:50070](http://192.168.0.117:50070/)</code></p>
<h3 id="10-上传文件到用户目录"><a href="#10-上传文件到用户目录" class="headerlink" title="10. 上传文件到用户目录"></a>10. 上传文件到用户目录</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -put hadoop-<span class="number">2.6</span>.<span class="number">5</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span> /user/root</span><br></pre></td></tr></table></figure>
<p>查看上传的<a href="http://192.168.0.117:50070/explorer.html#/user/root" target="_blank" rel="external">文件</a></p>
<p>生成文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ` seq 100000 `; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">"hello sxt <span class="variable">$i</span>"</span> &gt;&gt; test.txt;<span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>配置blocksize的大小，上传文件</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -D dfs.<span class="attribute">blocksize</span>=1048576 -put test.txt /user/root</span><br></pre></td></tr></table></figure>
<p>block块以文件的形式存储</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/var/</span>sxt<span class="regexp">/hadoop/</span>local<span class="regexp">/dfs/</span>data<span class="regexp">/current/</span>BP-<span class="number">280976167</span>-<span class="number">127.0</span>.<span class="number">0.1</span>-<span class="number">1553874062300</span><span class="regexp">/current/</span>finalized<span class="regexp">/subdir0/</span>subdir0</span><br></pre></td></tr></table></figure>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hadoop-2.6.5.tar.gz两个block</span></span><br><span class="line">-rw-r--r--.<span class="number"> 1 </span>root root<span class="number"> 134217728 </span>3月 <span class="number"> 29 </span>23:56 blk_1073741825</span><br><span class="line">-rw-r--r--.<span class="number"> 1 </span>root root  <span class="number"> 1048583 </span>3月 <span class="number"> 29 </span>23:56 blk_1073741825_1001.meta</span><br><span class="line">-rw-r--r--.<span class="number"> 1 </span>root root <span class="number"> 49377148 </span>3月 <span class="number"> 29 </span>23:56 blk_1073741826</span><br><span class="line">-rw-r--r--.<span class="number"> 1 </span>root root   <span class="number"> 385767 </span>3月 <span class="number"> 29 </span>23:56 blk_1073741826_1002.meta</span><br><span class="line"></span><br><span class="line"><span class="comment"># test.txt的两个block</span></span><br><span class="line">-rw-r--r--.<span class="number"> 1 </span>root root  <span class="number"> 1048576 </span>3月 <span class="number"> 30 </span>21:31 blk_1073741827</span><br><span class="line">-rw-r--r--.<span class="number"> 1 </span>root root     <span class="number"> 8199 </span>3月 <span class="number"> 30 </span>21:31 blk_1073741827_1003.meta</span><br><span class="line">-rw-r--r--.<span class="number"> 1 </span>root root   <span class="number"> 540319 </span>3月 <span class="number"> 30 </span>21:31 blk_1073741828</span><br><span class="line">-rw-r--r--.<span class="number"> 1 </span>root root     <span class="number"> 4231 </span>3月 <span class="number"> 30 </span>21:31 blk_1073741828_1004.meta</span><br></pre></td></tr></table></figure>
<h2 id="分布式集群部署方式"><a href="#分布式集群部署方式" class="headerlink" title="分布式集群部署方式"></a>分布式集群部署方式</h2><table>
<thead>
<tr>
<th></th>
<th>namenode</th>
<th>datanode</th>
<th>secondarynode</th>
</tr>
</thead>
<tbody>
<tr>
<td>node01(192.168.0.151)</td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td>node02(192.168.0.152)</td>
<td></td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td>node03(192.168.0.153)</td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td>node04(192.168.0.154)</td>
<td></td>
<td>*</td>
</tr>
</tbody>
</table>
<h3 id="1-ssh配置node01到node02-node03-node04"><a href="#1-ssh配置node01到node02-node03-node04" class="headerlink" title="1. ssh配置node01到node02 node03 node04"></a>1. ssh配置node01到node02 node03 node04</h3><p>切换到node01</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd .ssh</span><br><span class="line">scp id_dsa.pub root<span class="variable">@192</span>.<span class="number">168.0</span>.<span class="number">152</span><span class="symbol">:`pwd`/node01</span>.pub</span><br></pre></td></tr></table></figure>
<p>切换到node02</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd .ssh</span><br><span class="line">cat node01<span class="selector-class">.pub</span> &gt;&gt; authorized_keys</span><br></pre></td></tr></table></figure>
<p>如此配置node03  node04</p>
<h3 id="2-hosts配置4台机器"><a href="#2-hosts配置4台机器" class="headerlink" title="2.hosts配置4台机器"></a>2.hosts配置4台机器</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi <span class="regexp">/etc/</span>hosts</span><br></pre></td></tr></table></figure>
<p>配置如下</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.151</span> <span class="selector-tag">node01</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.152</span> <span class="selector-tag">node02</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.153</span> <span class="selector-tag">node03</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.154</span> <span class="selector-tag">node04</span></span><br></pre></td></tr></table></figure>
<h3 id="3-配置core-site-xml"><a href="#3-配置core-site-xml" class="headerlink" title="3. 配置core-site.xml"></a>3. 配置<code>core-site.xml</code></h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /<span class="keyword">opt</span>/sxt/hadoop-<span class="number">2.6</span>.<span class="number">5</span>/etc/hadoop</span><br><span class="line"><span class="keyword">vi</span> core-site.xml</span><br></pre></td></tr></table></figure>
<p>配置如下</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">&lt;configuration&gt;</span></span><br><span class="line">    <span class="params">&lt;property&gt;</span></span><br><span class="line">        <span class="params">&lt;name&gt;</span>fs.defaultFS<span class="params">&lt;/name&gt;</span></span><br><span class="line">        <span class="meta"># namenode启动节点及端口</span></span><br><span class="line">        <span class="params">&lt;value&gt;</span>hdfs:<span class="comment">//node01:9000&lt;/value&gt;</span></span><br><span class="line">    <span class="params">&lt;/property&gt;</span></span><br><span class="line">    <span class="params">&lt;property&gt;</span></span><br><span class="line">        <span class="params">&lt;name&gt;</span>hadoop.tmp.dir<span class="params">&lt;/name&gt;</span></span><br><span class="line">        <span class="params">&lt;value&gt;</span><span class="meta-keyword">/var/</span>sxt<span class="meta-keyword">/hadoop/</span>full<span class="params">&lt;/value&gt;</span></span><br><span class="line">    <span class="params">&lt;/property&gt;</span></span><br><span class="line"><span class="params">&lt;/configuration&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-配置datanode的slave节点"><a href="#4-配置datanode的slave节点" class="headerlink" title="4.配置datanode的slave节点"></a>4.配置datanode的slave节点</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /<span class="keyword">opt</span>/sxt/hadoop-<span class="number">2.6</span>.<span class="number">5</span>/etc/hadoop</span><br><span class="line"><span class="keyword">vi</span> slaves</span><br></pre></td></tr></table></figure>
<p>配置如下</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">node02</span></span><br><span class="line"><span class="symbol">node03</span></span><br><span class="line"><span class="symbol">node04</span></span><br></pre></td></tr></table></figure>
<h3 id="5-配置hdfs-site-xml，datanode数据数量，secondarynode的启动节点"><a href="#5-配置hdfs-site-xml，datanode数据数量，secondarynode的启动节点" class="headerlink" title="5.配置hdfs-site.xml，datanode数据数量，secondarynode的启动节点"></a>5.配置<code>hdfs-site.xml</code>，datanode数据数量，secondarynode的启动节点</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">vi</span> <span class="selector-tag">hdfs-site</span><span class="selector-class">.xml</span></span><br></pre></td></tr></table></figure>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">&lt;configuration&gt;</span></span><br><span class="line">    <span class="params">&lt;property&gt;</span></span><br><span class="line">        <span class="params">&lt;name&gt;</span>dfs.replication<span class="params">&lt;/name&gt;</span></span><br><span class="line">        <span class="meta"># datanode副本数量</span></span><br><span class="line">        <span class="params">&lt;value&gt;</span><span class="number">2</span><span class="params">&lt;/value&gt;</span></span><br><span class="line">    <span class="params">&lt;/property&gt;</span></span><br><span class="line">    <span class="params">&lt;property&gt;</span></span><br><span class="line">    	<span class="meta">#secondarynode的启动节点</span></span><br><span class="line">        <span class="params">&lt;name&gt;</span>dfs.namenode.secondary.http-address<span class="params">&lt;/name&gt;</span></span><br><span class="line">        <span class="params">&lt;value&gt;</span>node02:<span class="number">50090</span><span class="params">&lt;/value&gt;</span></span><br><span class="line">    <span class="params">&lt;/property&gt;</span></span><br><span class="line"><span class="params">&lt;/configuration&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="6-scp配置好的安装目录到其他3台"><a href="#6-scp配置好的安装目录到其他3台" class="headerlink" title="6.scp配置好的安装目录到其他3台"></a>6.scp配置好的安装目录到其他3台</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /opt</span><br><span class="line">scp -r sxt root<span class="variable">@192</span>.<span class="number">168.0</span>.<span class="number">152</span><span class="symbol">:/opt/</span></span><br></pre></td></tr></table></figure>
<h3 id="7-format和启动"><a href="#7-format和启动" class="headerlink" title="7.format和启动"></a>7.format和启动</h3><p>在node01format和启动</p>
<p><a href="http://192.168.0.151:50070/dfshealth.html#tab-datanode" target="_blank" rel="external">http://192.168.0.151:50070/dfshealth.html#tab-datanode</a>  可以查看datanode节点</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hdfs namenode -<span class="built_in">format</span></span><br><span class="line"><span class="built_in">start</span>-dfs.sh</span><br></pre></td></tr></table></figure>
<h2 id="ha高可用集群部署方式"><a href="#ha高可用集群部署方式" class="headerlink" title="ha高可用集群部署方式"></a>ha高可用集群部署方式</h2><p><img src="/2019/03/28/hadoop集群安装部署文档/图片1.png" alt=""></p>
<ul>
<li>namenode 主备，fsimage + editLog</li>
<li>JournalNode 更新日志</li>
<li>ZKFC争抢锁，为namenode判断主节点</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>namenode 主备</th>
<th>ZKFC</th>
<th>datanode</th>
<th>zookeeper</th>
<th>JNN</th>
</tr>
</thead>
<tbody>
<tr>
<td>node01</td>
<td>*</td>
<td>*</td>
<td></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td>node02</td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td>node03</td>
<td></td>
<td></td>
<td>*</td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td>node04</td>
<td></td>
<td></td>
<td>*</td>
<td>*</td>
</tr>
</tbody>
</table>
<ul>
<li>需要配置node01 和 node02之间的相互免密</li>
<li>需要配置node01 到 node02 node03 node04的免密</li>
<li>需要配置node02 到 node01 node03 node04的免密</li>
</ul>
<h3 id="1-zookeeper安装-node02-node03-node04"><a href="#1-zookeeper安装-node02-node03-node04" class="headerlink" title="1.zookeeper安装(node02 node03 node04)"></a>1.zookeeper安装(node02 node03 node04)</h3><p>编辑启用node02(192.168.0.152)</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/var/sxt/zk</span><br><span class="line"></span><br><span class="line">server<span class="meta">.1</span>=<span class="number">192.168</span><span class="meta">.0</span><span class="meta">.152</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br><span class="line">server<span class="meta">.2</span>=<span class="number">192.168</span><span class="meta">.0</span><span class="meta">.153</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br><span class="line">server<span class="meta">.3</span>=<span class="number">192.168</span><span class="meta">.0</span><span class="meta">.154</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br></pre></td></tr></table></figure>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="meta-keyword">/var/</span>sxt/zk</span><br><span class="line">echo <span class="string">"1"</span> &gt; <span class="meta-keyword">/var/</span>sxt<span class="meta-keyword">/zk/</span>myid</span><br></pre></td></tr></table></figure>
<p>依次启动node03 node04</p>
<p>会发现node03作为leader节点，比较版本最新，版本一次比较myid的大小。</p>
<p><strong>启动完node02，node03的myid比较大，作为leader。</strong>启动node04的时候，leader节点已存在。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zkServer<span class="selector-class">.sh</span> start</span><br><span class="line">zkServer<span class="selector-class">.sh</span> status</span><br></pre></td></tr></table></figure>
<h3 id="2-配置hdfs-site-xml"><a href="#2-配置hdfs-site-xml" class="headerlink" title="2.配置hdfs-site.xml"></a>2.配置<code>hdfs-site.xml</code></h3><p>配置逻辑和物理的关系</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.nameservices<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>mycluster<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.ha.namenodes.mycluster<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>nn1,nn2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.rpc-address.mycluster.nn1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>node01:8020<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.rpc-address.mycluster.nn2<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>node02:8020<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.http-address.mycluster.nn1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>node01:50070<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.http-address.mycluster.nn2<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>node02:50070<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置<code>journalnode</code>  和 <code>ssh</code></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line">  <span class="params">&lt;name&gt;</span>dfs.namenode.shared.edits.dir<span class="params">&lt;/name&gt;</span></span><br><span class="line">  <span class="params">&lt;value&gt;</span>qjournal:<span class="comment">//node01:8485;node02:8485;node03:8485/mycluster&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line">  <span class="params">&lt;name&gt;</span>dfs.journalnode.edits.dir<span class="params">&lt;/name&gt;</span></span><br><span class="line">  <span class="params">&lt;value&gt;</span><span class="meta-keyword">/var/</span>sxt<span class="meta-keyword">/hadoop/</span>ha/jn<span class="params">&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line">  <span class="params">&lt;name&gt;</span>dfs.client.failover.proxy.provider.mycluster<span class="params">&lt;/name&gt;</span></span><br><span class="line">  <span class="params">&lt;value&gt;</span>org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider<span class="params">&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line">  <span class="params">&lt;name&gt;</span>dfs.ha.fencing.methods<span class="params">&lt;/name&gt;</span></span><br><span class="line">  <span class="params">&lt;value&gt;</span>sshfence<span class="params">&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line">  <span class="params">&lt;name&gt;</span>dfs.ha.fencing.ssh.private-key-files<span class="params">&lt;/name&gt;</span></span><br><span class="line">  <span class="params">&lt;value&gt;</span><span class="meta-keyword">/root/</span>.ssh/id_dsa<span class="params">&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br></pre></td></tr></table></figure>
<p>启用<code>zkfc</code>配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.ha.automatic-failover.enabled<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="3-配置core-site-xml-1"><a href="#3-配置core-site-xml-1" class="headerlink" title="3.配置core-site.xml"></a>3.配置<code>core-site.xml</code></h3><p>配置namenode的存储配置，以及<code>zookeeper</code>的配置</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line">    <span class="params">&lt;name&gt;</span>fs.defaultFS<span class="params">&lt;/name&gt;</span></span><br><span class="line">    <span class="params">&lt;value&gt;</span>hdfs:<span class="comment">//mycluster&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line">    <span class="params">&lt;name&gt;</span>hadoop.tmp.dir<span class="params">&lt;/name&gt;</span></span><br><span class="line">    <span class="params">&lt;value&gt;</span><span class="meta-keyword">/var/</span>sxt<span class="meta-keyword">/hadoop/</span>ha<span class="params">&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line">   <span class="params">&lt;name&gt;</span>ha.zookeeper.quorum<span class="params">&lt;/name&gt;</span></span><br><span class="line">   <span class="params">&lt;value&gt;</span>node02:<span class="number">2181</span>,node03:<span class="number">2181</span>,node04:<span class="number">2181</span><span class="params">&lt;/value&gt;</span></span><br><span class="line"> <span class="params">&lt;/property&gt;</span></span><br></pre></td></tr></table></figure>
<p>复制配置文件到node02 node03 node04</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp hdfs-site.<span class="keyword">xml</span> <span class="title">core-site</span>.<span class="keyword">xml</span> <span class="title">node02</span>:`pwd`</span><br></pre></td></tr></table></figure>
<h3 id="4-启动journalnode，node01-node02-node03"><a href="#4-启动journalnode，node01-node02-node03" class="headerlink" title="4.启动journalnode，node01 node02 node03"></a>4.启动<code>journalnode</code>，node01 node02 node03</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop-daemon<span class="selector-class">.sh</span> start journalnode</span><br></pre></td></tr></table></figure>
<h3 id="5-格式化namenode-格式化zkfczookeeper-启动namenode"><a href="#5-格式化namenode-格式化zkfczookeeper-启动namenode" class="headerlink" title="5.格式化namenode  格式化zkfczookeeper  启动namenode"></a>5.格式化<code>namenode</code>  格式化zkfc<code>zookeeper</code>  启动namenode</h3><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hdfs namenode -<span class="built_in">format</span></span><br><span class="line">hdfs zkfc -formtZK</span><br><span class="line">hadoop-daemon.sh <span class="built_in">start</span> namenode</span><br></pre></td></tr></table></figure>
<p>查看<code>zkCli.sh</code></p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ls</span> <span class="string">/hadoop-ha/mycluster</span></span><br></pre></td></tr></table></figure>
<h3 id="6-node02-复制配置，以standby方式启动"><a href="#6-node02-复制配置，以standby方式启动" class="headerlink" title="6.node02 复制配置，以standby方式启动"></a>6.node02 复制配置，以standby方式启动</h3><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">hdfs namenode -bootstrapStandby</span></span><br></pre></td></tr></table></figure>
<h3 id="7-最后启动-hdfs"><a href="#7-最后启动-hdfs" class="headerlink" title="7.最后启动    hdfs"></a>7.最后启动    <code>hdfs</code></h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">start</span>-dfs.sh</span><br></pre></td></tr></table></figure>
<h3 id="8-重启只需要启动zk，启动start-dfs-sh"><a href="#8-重启只需要启动zk，启动start-dfs-sh" class="headerlink" title="8.重启只需要启动zk，启动start-dfs.sh"></a>8.重启只需要启动zk，启动<code>start-dfs.sh</code></h3><h3 id="9-验证ha"><a href="#9-验证ha" class="headerlink" title="9.验证ha"></a>9.验证ha</h3><p><a href="http://node01:50070/dfshealth.html#tab-overview" target="_blank" rel="external">http://node01:50070/dfshealth.html#tab-overview</a>  查看node01为active状态</p>
<p>杀掉node01<code>kill -9 namenode</code> <a href="http://node02:50070/dfshealth.html#tab-overview" target="_blank" rel="external">http://node02:50070/dfshealth.html#tab-overview</a>  node02变为active状态</p>
<p>从zk节点查看争抢锁状态</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">get</span> /hadoop-ha/mycluster/ActiveStandbyElectorLock</span><br></pre></td></tr></table></figure>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">	myclusternn2node02</span><br><span class="line">cZxid = 0x100000175</span><br><span class="line">ctime = Sat Apr 06 23:58:59 EDT 2019</span><br><span class="line">mZxid = 0x100000175</span><br><span class="line">mtime = Sat Apr 06 23:58:59 EDT 2019</span><br><span class="line">pZxid = 0x100000175</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x269f5aa4c8b003a</span><br><span class="line">dataLength = 30</span><br><span class="line">numChildren = 0</span><br></pre></td></tr></table></figure>
<p>重新启用node01</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop-daemon<span class="selector-class">.sh</span> start namenode</span><br></pre></td></tr></table></figure>
<p>zkFC down之后，应该是zk争抢锁节点，失去心跳链接</p>
<p>服务器down之后的后果，也可正常切换</p>
<h2 id="开发分布式存储"><a href="#开发分布式存储" class="headerlink" title="开发分布式存储"></a>开发分布式存储</h2><h3 id="windows-eclipse开发配置"><a href="#windows-eclipse开发配置" class="headerlink" title="windows eclipse开发配置"></a>windows eclipse开发配置</h3><p>1.使用eclipse mars解压，解压<code>hadoop-2.6.5</code>，</p>
<p>2.复制<code>hadoop-2.6.5\sharre\hadoop</code>中comon、hdfs、mapreduce、tools、yarn中的根目录的jar包，以及lib目录下的jar包，统一复制到目录，共121个，配置成user-library</p>
<p>3.配置<code>HADOOP_HOME</code>环境变量，<code>HADOOP_USER_NAME</code>环境变量为<code>root</code>，配置path</p>
<p>4.<code>hadoop.dll</code>  放到 <code>c:/windows/system32</code>下</p>
<p>5.复制服务机器配置中的<code>core-site.xml</code> <code>hdfs-site.xml</code> 到conf目录下，并将文件夹设置为resource</p>
<p>测试用例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sxt.hadoop.hdfs;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.BlockLocation;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.FSDataOutputStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.FileStatus;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.FileSystem;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.After;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TetsHDFS</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	Configuration conf = <span class="keyword">null</span>;</span><br><span class="line">	FileSystem fs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Before</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">		conf = <span class="keyword">new</span> Configuration(<span class="keyword">true</span>);</span><br><span class="line">		fs = FileSystem.get(conf);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@After</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">		fs.close();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mkdir</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">		Path dirs = <span class="keyword">new</span> Path(<span class="string">"/data"</span>);</span><br><span class="line">		<span class="keyword">if</span>(fs.exists(dirs))&#123;</span><br><span class="line">			fs.delete(dirs,<span class="keyword">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		fs.mkdirs(dirs);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">upload</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">		InputStream input = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(</span><br><span class="line">				<span class="keyword">new</span> File(<span class="string">"D:\\uninstall\\redis\\redis\\redis.windows.conf"</span>)));</span><br><span class="line">		Path f = <span class="keyword">new</span> Path(<span class="string">"/data/ooxx.txt"</span>);</span><br><span class="line">		FSDataOutputStream out = fs.create(f);</span><br><span class="line"></span><br><span class="line">		IOUtils.copyBytes(input, out, conf , <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">blocksize</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line"></span><br><span class="line">		Path path = <span class="keyword">new</span> Path(<span class="string">"/user/root/test.txt"</span>);</span><br><span class="line"></span><br><span class="line">		FileStatus fileStatus = fs.getFileStatus(path);</span><br><span class="line"></span><br><span class="line">		BlockLocation[] lcts = fs.getFileBlockLocations(fileStatus, <span class="number">0</span>, fileStatus.getLen());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span>(BlockLocation lct : lcts)&#123;</span><br><span class="line">			System.out.println(lct);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq 100` ;<span class="keyword">do</span> echo <span class="string">""</span> &gt;&gt; <span class="keyword">test</span>.txt;done</span><br><span class="line"></span><br><span class="line">fs.getFileStatus(f);</span><br><span class="line">Boclocatin[] fs.getFileBOckeLocations(<span class="keyword">file</span>,0.<span class="keyword">file</span>.getLen);</span><br><span class="line">sout(locaiton);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FSInput fs.<span class="keyword">open</span>(f);</span><br><span class="line"></span><br><span class="line">sout((cahr)<span class="keyword">in</span>.redfByte());</span><br><span class="line"></span><br><span class="line">第二个块<span class="built_in">index</span></span><br><span class="line"><span class="keyword">in</span>.seek(1048576);</span><br><span class="line">跳过</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/03/08/Netty-ByteBuf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/08/Netty-ByteBuf/" itemprop="url">Netty ByteBuf</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-08T09:54:24+08:00">
                2019-03-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Netty/" itemprop="url" rel="index">
                    <span itemprop="name">Netty</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/08/Netty-ByteBuf/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/03/08/Netty-ByteBuf/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  5.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  20
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本章主要内容<br>ByteBuf<br>ByteBufHolder<br>ByteBufAllocator<br>使用上述接口<br>传输数据时一般都会使用一个缓冲区包装数据。Java的NIO有自己的Buffer类，，它们实现的功能有限并且没有优<br>化过。使用JDK的ByteBuffer往往是比较麻烦也比较复杂的。缓冲区是网络应用非常重要的一个组件，有必要提供<br>给开发者，并且应该是API的一部分。<br>幸运的是，Netty提供了功能强大的缓冲区实现，它用来表示一个字节序列，帮助开发者操作原始字节数据或者自<br>定义的Java对象。Netty中的缓冲区叫ByteBuf，实际上等价于JDK的ByteBuffer。ByteBuf的作用是通过Netty的管<br>道传输数据。它从根本上解决了JDK缓冲区的问题，并且Netty应用开发者经常会使用到它，这些因素都让它有很强<br>的生产力。在与JDK的缓冲期相比有很大优势。<br>因为缓冲区传送数据都是通过Netty的ChannelPipeline和ChannelHandler，所以Netty应用都会使用到缓冲区<br>API。</p>
<h1 id="一、Buffer-API"><a href="#一、Buffer-API" class="headerlink" title="一、Buffer API"></a>一、Buffer API</h1><p>Netty的Buffer API主要有两个接口：<br>ByteBuf<br>ByteBufHolder<br>Netty缓冲API有以下几个优点：<br>如果有需要你可以自定义缓冲类型<br>内置复合缓冲类型实现零拷贝<br>容量是按需扩展的，类似StringBuffer<br>不需要通过调用flip()方法切换读写模式<br>读索引和写索引是分开的<br>方法调用是链式结构的<br>引用技术功能自动释放资源<br>池优化技术<br>上面这些我们后面都会介绍，包括池优化技术。现在我们先从最常用的字节容器开始。</p>
<h1 id="二、字节容器ByteBuf"><a href="#二、字节容器ByteBuf" class="headerlink" title="二、字节容器ByteBuf"></a>二、字节容器ByteBuf</h1><p>当你需要通过网络与对端如数据库交换数据时，都是通过字节来沟通的 ByteBuf是一个可以让你有效的读写字节数<br>据的数据容器。为了易于操作，它使用了两个索引：一个用来读一个用来写。这样你只需要调整读索引就可以很方<br>便的重复读取容器内的数据了。</p>
<h2 id="2-1、工作方式"><a href="#2-1、工作方式" class="headerlink" title="2.1、工作方式"></a>2.1、工作方式</h2><p>当向ByteBuf写数据时，写索引会根据根据写入的字符数增加同样数值。当你开始读数据时，读索引也会增加，只<br>有读写索引处于同一位置。然后ByteBuf就不可读了，如果继续读的话就会抛出IndexOutOfBoundsException异<br>常，类似读数组越界一样。<br>当调用任何以read或write开头的方法时，读写索引都会自动增长。也有一些相对操作方法如get或set，这些方法<br>不会去移动索引，但会去操作给定的相对索引。<br>ByteBuf是有容量上限的，如果将写索引移到超过容量上限的位置就会出现异常。默认的容量上限是<br>Integer.MAX_VALUE。<br>下图展示了ByteBuf的基本结构图。<br>从上图可以看出，ByteBuf很类似字节数组，最明显的区别就是ByteBuf有分开了读写索引进行访问数据。</p>
<h2 id="2-2、不同类型的ByteBuf"><a href="#2-2、不同类型的ByteBuf" class="headerlink" title="2.2、不同类型的ByteBuf"></a>2.2、不同类型的ByteBuf</h2><p>常用的ByteBuf一共有三种，其他的也有不少，不过一般开发者很少会用到，都是Netty内部使用。可能你还会实<br>现自己的缓冲区，不过这个不在本章内容之内。首先来看看你可能最感兴趣的缓冲。</p>
<h3 id="堆缓冲"><a href="#堆缓冲" class="headerlink" title="堆缓冲"></a>堆缓冲</h3><p>最常用的ByteBuf是存储数据在JVM堆内存上的缓冲区。这种缓冲区内部实现就是一个数组。下面展示一下它的基<br>本用法。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ByteBuf heapBuf = ...;</span><br><span class="line"><span class="comment">//检测ByteBuf是否有数组</span></span><br><span class="line"><span class="built_in">if</span> (heapBuf.hasArray()) &#123;</span><br><span class="line">    <span class="comment">//获取数组引用</span></span><br><span class="line">    <span class="keyword">byte</span>[] <span class="keyword">array</span> = heapBuf.<span class="keyword">array</span>();</span><br><span class="line">    <span class="comment">//计算第一个字节所在位置</span></span><br><span class="line">    <span class="keyword">int</span> offset = heapBuf.arrayOffset() + heapBuf.<span class="built_in">position</span>();</span><br><span class="line">    <span class="comment">//获取可读字节总数</span></span><br><span class="line">    <span class="keyword">int</span> length = heapBuf.readableBytes();</span><br><span class="line">    <span class="comment">//使用自己的业务逻辑处理数据</span></span><br><span class="line">    YourImpl.method(<span class="keyword">array</span>, offset, length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果访问非堆内存ByteBuf的数组，就会抛出UnsupportedOperationException。因此访问ByteBuf数组之前应该<br>使用<strong>hasArray()方法</strong>检测此缓冲区是否支持数组。</p>
<h3 id="直接缓冲区"><a href="#直接缓冲区" class="headerlink" title="直接缓冲区"></a>直接缓冲区</h3><p>另一个ByteBuf的实现是直接缓冲区。直接的意思就是这个缓冲区分配的内存是<strong>在JVM堆内存外部</strong>。使用直接内存<br>时你不会在JVM堆空间中看见它的使用量。所以你计算你的应用内存使用量时，直接内存区域也要算上，然后限制<br>它的最大使用量，防止系统内存不够用出现错误。通过网络传输数据时使用直接缓冲性能是很高的。<br>下面的一部分代码展示了如何通过数组的方式访问直接缓冲区的数据。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ByteBuf directBuf = ...;</span><br><span class="line"><span class="comment">//检查缓冲区是否有数组，返回flase就是直接缓冲</span></span><br><span class="line"><span class="built_in">if</span> (!directBuf.hasArray()) &#123;</span><br><span class="line"><span class="comment">//获取可读字节数量</span></span><br><span class="line"><span class="keyword">int</span> length = directBuf.readableBytes();</span><br><span class="line"><span class="comment">//初始化相同长度的直接数组</span></span><br><span class="line"><span class="keyword">byte</span>[] <span class="keyword">array</span> = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</span><br><span class="line"><span class="comment">//读取数据到数组中</span></span><br><span class="line">directBuf.getBytes(<span class="keyword">array</span>);</span><br><span class="line"><span class="comment">//用户业务逻辑操作字节数组</span></span><br><span class="line">YourImpl.method(<span class="keyword">array</span>, <span class="number">0</span>, <span class="keyword">array</span>.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出，直接缓冲区需要将数据复制到数组，如果你想直接通过字节数组访问数据，用堆缓冲区更好一些。</p>
<h3 id="组合缓冲区"><a href="#组合缓冲区" class="headerlink" title="组合缓冲区"></a>组合缓冲区</h3><p>现在来介绍一个组合缓冲区，它的名字叫<strong>CompositeByteBuf</strong>。人如其名，它允许你将不同类型的ByteBuf组合在<br>一起并且提供访问他们的方式。<strong>CompositeByteBuf也像是各种类型ByteBuf的视图，它的hasArray()方法返回的false，因为它里面可能包含多个堆缓冲或直接缓冲。</strong><br>例如，一条消息可能由两个部分组成：消息头和消息体。模块化应用中，这两部分可能是由不同模块的产生并组合<br>在一起然后再发送。很多时候，你发送的消息往往只修改一部分，比如消息体一样，改变消息头。这里就不用每次<br>都重新分配缓存了</p>
<p>上面这种场景就很适合CompositeByteBuf，不需要内存拷贝，而且使用的是和非组合缓冲相同的API。下图展示了<br>下面的伪代码展示这两个方式。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//第一种使用数组组合</span><br><span class="line"><span class="keyword">ByteBuffer[] </span>message = new <span class="keyword">ByteBuffer[] </span>&#123; header, <span class="keyword">body </span>&#125;<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">//第二种将头尾都复制到新的<span class="keyword">ByteBuffer</span></span><br><span class="line"><span class="keyword">ByteBuffer </span>message2 = <span class="keyword">ByteBuffer.allocate(header.remaining()+ </span><span class="keyword">body.remaining());</span></span><br><span class="line"><span class="keyword">message2.put(header);</span></span><br><span class="line"><span class="keyword">message2.put(body);</span></span><br><span class="line"><span class="keyword">message2.flip();</span></span><br></pre></td></tr></table></figure>
<p>上面的方式都有很明显的缺点：使用数组处理，代码量及API都比较复杂。使用数据复制代价有很大，浪费时间和<br>资源。下面我们看看Netty的CompositeByteBuf怎么处理这种情况。</p>
<p><strong>CompositeByteBuf组合消息头和消息体的结构</strong></p>
<p>CompositeBytebuf也是不能通过数组的方式直接访问其里面的数据。下面展示CompositeBytebuf怎么访问数<br>据</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CompositeByteBuf compBuf = ...;</span><br><span class="line">ByteBuf heapBuf = ...;</span><br><span class="line">ByteBuf directBuf = ...;</span><br><span class="line"><span class="comment">//将数据都放入到CompositeByteBuf</span></span><br><span class="line">compBuf.addComponent(heapBuf, directBuf)</span><br><span class="line">.....</span><br><span class="line"><span class="comment">//移除索引是0的数据，就像List</span></span><br><span class="line">compBuf.removeComponent(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//遍历组合缓冲中的缓冲实例</span></span><br><span class="line">for (ByteBuf buf: compBuf) &#123;</span><br><span class="line">	System.out.println(buf.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="三、ByteBuf的字节操作"><a href="#三、ByteBuf的字节操作" class="headerlink" title="三、ByteBuf的字节操作"></a>三、ByteBuf的字节操作</h1><p>ByteBuf提供了很多读写内容的方法。</p>
<h2 id="3-1、随机访问"><a href="#3-1、随机访问" class="headerlink" title="3.1、随机访问"></a>3.1、随机访问</h2><p>和原始字节数组一样，ByteBuf的索引也是从0开始的。也就是说它的第一个字节的位置是0，最后一个字节的位置<br>是容量-1。例如下面的代码，可以直接遍历ByteBuf的所有字节，而不用去管它内部如何实现的。<br>前面说过，使用set或get开头的方法不会增长它的读写索引，所以如果你使用上面的方式读取数据，可以写代码更<br>新读写索引。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ByteBuf <span class="built_in">buffer</span> = ...;</span><br><span class="line"><span class="built_in">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">buffer</span>.capacity(); i ++) &#123;</span><br><span class="line">    <span class="keyword">byte</span> b = <span class="built_in">buffer</span>.getByte(i);</span><br><span class="line">    System.out.<span class="built_in">println</span>((<span class="keyword">char</span>) b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-2、顺序访问"><a href="#3-2、顺序访问" class="headerlink" title="3.2、顺序访问"></a>3.2、顺序访问</h2><p>ByteBuf提供了两个索引来支持顺序访问的需求，一个是readerIndex读索引支持读操作的，一个是writerIndex写<br>索引支持写操作的，各自之间分工很明确。而JDK的ByteBuffer只有一个索引，所以每次切换读写模式的时候你都<br>需要调用一下flip()方法。下图展示了ByteBuf被两个索引分成三个区域的结构。</p>
<p><img src="/2019/03/08/Netty-ByteBuf/20190308101241.jpg" alt=""></p>
<h2 id="3-3、可读字节内容-实际内容"><a href="#3-3、可读字节内容-实际内容" class="headerlink" title="3.3、可读字节内容(实际内容)"></a>3.3、可读字节内容(实际内容)</h2><p>ByteBuf中的实际内容存储在可读字节区域。以read或skip开头的方法，你读了多少数量的字节，相应的读索引就<br>会增加多少<br>下面的代码展示了如何读取ByteBuf中的所有可读内容。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ByteBuf <span class="built_in">buffer</span> = ...;</span><br><span class="line"><span class="built_in">while</span> (<span class="built_in">buffer</span>.readable()) &#123;</span><br><span class="line">    System.out.<span class="built_in">println</span>(<span class="built_in">buffer</span>.readByte());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-4、可写字节"><a href="#3-4、可写字节" class="headerlink" title="3.4、可写字节"></a>3.4、可写字节</h2><p>这块区域是需要填充的未定义区域。<u>以write开头的方法会从当前的<strong>writerIndex</strong>位置写入数据，并且写了多少数据,这个writerIndex也会增加相应的数量。</u>如果写操作方法的参数也是一个ByteBuf并且没有指定源索引，则这个参数<br>的读索引也会增长相应的数量。<br>如果没有足够的可写区域了还继续使用写操作就会抛出IndexOutOfBoundException异常。新分配的ByteBuf的写<br>索引默认值也是0。<br>下面的代码展示了用Int类型数据填满可写区域。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ByteBuf <span class="built_in">buffer</span> = ...;</span><br><span class="line"><span class="built_in">while</span> (<span class="built_in">buffer</span>.writableBytes() &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">    <span class="built_in">buffer</span>.writeInt(<span class="built_in">random</span>.nextInt());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-5、派生缓冲区"><a href="#3-5、派生缓冲区" class="headerlink" title="3.5、派生缓冲区"></a>3.5、派生缓冲区</h2><p>派生缓冲区，也就是创建一个已经存在的缓冲区的视图，可以调用<strong>duplicate(),slice(),slice(int, int),</strong><br><strong>readOnly()和order(ByteOrder)等方法实现。</strong>派生缓冲区会产生自己的读写索引和其他标记索引，但是他们共享内部的数据。因为它们<strong>共享内部的数据</strong>，所以创建派生缓冲是没有什么性能损耗的，而且是比较好的方式，例如你想拥有一个缓冲区的切片。<br>如果需要复制一个缓冲区，可以使用copy()或copy(int, int)方法。下面的代码展示了怎么获取一个ByteBuf的切片。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Charset utf8 = Charset.forName(“UTF<span class="number">-8</span>“);</span><br><span class="line"><span class="comment">//根据给定的字符串内容创建一个ByteBuf</span></span><br><span class="line">ByteBuf buf = Unpooled.copiedBuffer(“xxxx“, utf8);</span><br><span class="line"><span class="comment">//创建ByteBuf的切片，起始位置是0，截止位置是14</span></span><br><span class="line">ByteBuf sliced = buf.slice(<span class="number">0</span>, <span class="number">14</span>);</span><br><span class="line"><span class="comment">//打印切片内容，正常应该是"xxxx"</span></span><br><span class="line">System.out.println(sliced.toString(utf8);</span><br><span class="line"><span class="comment">//修改索引0内容</span></span><br><span class="line">buf.setByte(<span class="number">0</span>, (byte) ’J’);</span><br><span class="line"><span class="comment">//断言会成功，因为他们共享内部的数据，其实修改的就是他们内部指向的共同数据块</span></span><br><span class="line">assert buf.get(<span class="number">0</span>) == sliced.get(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>可以发现，切片和原始ByteBuf里面的内容其实是同一块内存区域。现在我们来看看怎么复制ByteBuf，以及它和<br>切片ByteBuf有什么不同，请看下面的代码。</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Charset utf8 = Charset.forName(“UTF<span class="number">-8</span>“);</span><br><span class="line"><span class="comment">//同样根据给定字符串创建ByteBuf</span></span><br><span class="line">ByteBuf buf = Unpooled.copiedBuffer(“xxx!“, utf8);</span><br><span class="line"><span class="comment">//复制ByteBuf 0-14位置的内容</span></span><br><span class="line">ByteBuf <span class="built_in">copy</span> = buf.<span class="built_in">copy</span>(<span class="number">0</span>, <span class="number">14</span>);</span><br><span class="line"><span class="comment">//输出复制的ByteBuf内容，正常应该是"xxx"</span></span><br><span class="line">System.out.<span class="built_in">println</span>(<span class="built_in">copy</span>.toString(utf8);</span><br><span class="line"><span class="comment">//同样修改内容</span></span><br><span class="line">buf.setByte(<span class="number">0</span>, (<span class="built_in">byte</span>) ’J’);</span><br><span class="line"><span class="comment">//断言会成功，因为复制缓冲和原始缓冲并没有共享数据</span></span><br><span class="line"><span class="keyword">assert</span> buf.<span class="built_in">get</span>(<span class="number">0</span>) != <span class="built_in">copy</span>.<span class="built_in">get</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>API基本上都是一样的，不过不同的方式派生的ByteBuf，内部也会有细微差别<br><strong>一般情况下建议使用切片，除非必须不共享数据才使用复制方式</strong>。<strong>因为复制ByteBuf需要进行内存复制操作，不仅</strong><br><strong>消耗更多资源，执行方法也会更耗时。</strong></p>
<h2 id="3-6、读写操作"><a href="#3-6、读写操作" class="headerlink" title="3.6、读写操作"></a>3.6、读写操作</h2><p>ByteBuf的读写操作共有两大类：<br>基于索引的，指定索引读写相应位置的数据<br>从当前索引读写数据，然后增长读写索引<br>先来看一下这些方法，下面列出来的都是比较常用的方法，如果想看其他方法，请参考API DOC。先看一下读<br>操作的。</p>
<p>名称描述<br>getBoolean(int) 获取指定位置的Boolean类型数据<br>getByte(int) 获取指定位置的字节内容<br>getUnsignedByte(int) 获取指定位置的无符号字节内容<br>getMedium(int) 获取指定位置的24位整数内容<br>getUnsignedMedium(int) 获取指定位置的无符号24位整数内容<br>getInt(int) 获取指定位置的Int类型内容<br>getUnsignedInt(int) 获取指定位置的无符号Int类型内容<br>getLong(int) 获取指定位置的Long类型内容<br>getUnsignedLong(int) 获取指定位置的无符号Long类型内容<br>getShort(int) 获取指定位置的Short类型内容<br>getUnsignedShort(int) 获取指定位置的无符号Short类型内容<br>getBytes(int, …) 从给定位置开始将数据转换到目标容器中<br>名称描述<br>setBoolean(int, boolean) 设置指定位置的Boolean类似数据<br>setByte(int, int) 设置指定位置字节数据<br>setMedium(int, int) 设置指定位置24位整数数据<br>setInt(int, int) 设置指定位置Int类型数据<br>setLong(int, long) 设置指定位置Long类型数据<br>setShort(int, int) 设置指定位置Short类型数据<br>setBytes(int,…) 从指定位置将源数据容器中转换过来<br>它的set操作和get操作都很类似，请看下面的表格。<br>你可能会发现set方法没有无符号类型的。这是因为在设置数据的时候没有无符号的概念。上面已经介绍了相关的<br>方法，现在我们来看看怎么在实际代码中使用它们。<br>Charset utf8 = Charset.forName(“UTF-8”);<br>//根据字符串创建ByteBuf<br>ByteBuf buf = Unpooled.copiedBuffer(“Netty in Action rocks!”, utf8);<br>//打印位置0的字符，正常输出’N’<br>System.out.println((char) buf.getByte(0));<br>//查询现在的读写索引<br>名称描述<br>readBoolean() 读取当前读索引Boolean数据，同时读索引会加1<br>readByte() 读取当前读索引Byte数据，同时读索引会加1<br>readUnsignedByte() 读取当前读索引无符号Byte数据，同时读索引会加1<br>readMedium() 读取当前读索引24位整数数据，同时读索引会加1<br>readUnsignedMedium() 读取当前读索引无符号24位整数数据，同时读索引会加1<br>readInt() 读取当前读索引Int类型数据，同时读索引会加1<br>readUnsignedInt() 读取当前读索引无符号Int类型数据，同时读索引会加1<br>readLong() 读取当前读索引Long类型数据，同时读索引会加1<br>readUnsignedLong() 读取当前读索引无符号Long类型数据，同时读索引会加1<br>readShort() 读取当前读索引Short类型数据，同时读索引会加1<br>readUnsignedShort() 读取当前读索引无符号Short类型数据，同时读索引会加1<br>readBytes(int) 从当前读索引读取指定长度的字节内容，读索引也会增加指定长度<br>接下来介绍到的读写操作就是read和write开头的方法，前面说过，这些方法也会影响到缓冲的读写索引。这里面<br>用到最多的方法就是把ByteBuf当成一个流来读取数据。同样，write方法相当于在ByteBuf上追加数据。常用的<br>read方法如下表格。<br>它的write方法基本上和read方法也是一一对应的。<br>int readerIndex = buf.readerIndex();<br>int writerIndex = buf.writerIndex();<br>//修改位置0的数据<br>buf.setByte(0, (byte)”B”);<br>//再次打印位置0的数据，这次应该是’B’<br>System.out.println((char) buf.getByte(0));<br>//set或get方法不会改变读写索引<br>assert readerIndex = buf.readerIndex();<br>assert writerIndex = buf.writerIndex();<br>名称描述<br>writeBoolean(boolean) 在当前写索引位置写入Boolean类型数据，同时写索引加1<br>writeByte(int) 当前写索引写入Byte类型数据，同时写索引加1<br>writeMedium(int) 当前写索引写入24位整数数据，同时写索引会加3，24位=3字节<br>writeInt(int) 在当前写索引写入32位整数数据，同时写索引加4，32位=4字节<br>writeLong(long) 当前写索引写入64位整数数据，同时写索引加8，64位=8字节<br>writeShort(int) 当前写索引写入Short类型数据，同时写索引加2<br>writeBytes(ByteBuf src, int<br>length)<br>从源数据中转换指定长度数据到当前写索引，同时写索引增加相应数<br>量<br>现在我们来看看上面这些read和write方法在实际项目中的应用。<br>一直忘记了说一件事，获取当前读写索引的方法是不会修改读写索引。上面已经介绍了很多读写数据的方法，当然<br>还有一些其他很有用的方法，下面会介绍这些方法。<br>3.11、其他常用方法<br>还有一些常用的方法我们没有介绍到，下表列出来这些常用方法，并简要介绍它们的用法。<br>Charset utf8 = Charset.forName(“UTF-8”);<br>//根据字符串创建ByteBuf<br>ByteBuf buf = Unpooled.copiedBuffer(“xxx”, utf8);<br>//打印首位置字符，正常是’x’<br>System.out.println((char) buf.readByte());<br>//获取当前的读写索引<br>int readerIndex = buf.readerIndex();<br>int writerIndex = buf.writerIndex();<br>//修改写索引0位置的数据<br>buf.writeByte( (byte) ‘?’);<br>//写数据读索引不会变化，写索引会加1<br>assert readerIndex = buf.readerIndex();<br>assert writerIndex != buf.writerIndex();<br>名称描述<br>isReadable() 有一个字节可读就会返回true<br>isWritable() 有一个可写字节空间就会返回true<br>readableBytes() 返回可读字节内容总数<br>writablesBytes() 返回可写内容区域总数<br>capacity()<br>返回缓冲区目前容量，如果超过这个数值，缓冲区会扩容， 只到达到maxCapacity()的<br>限制<br>maxCapacity() 返回缓冲区最大容量<br>hasArray() 如果缓冲区内部以数组存储返回true<br>array() 返回内部存储的数组，如果没有数组则 抛出UnsupportedOperationException<br>名称描述<br>content() 返回它存储的内容的ByteBuf<br>copy() 返回一个深拷贝的ByteBufHolder，也就是他们的数据不共享<br>前面介绍的都是Java基础类型，但很多时候我们网络应用需要处理普通Java对象，也就是Java Bean。需要存储和<br>检查，而且在容器中按照顺序存储也很重要。因此，Netty提供了另一个数据容器<br>MessageBuf。</p>
<h1 id="四、ByteBufHolder"><a href="#四、ByteBufHolder" class="headerlink" title="四、ByteBufHolder"></a>四、ByteBufHolder</h1><p>你有一个对象，里面很多属性，但是都是通过字节去传输的。例如，HTTP协议中的相应数据就很符合这种情况。<br>HTTP响应数据有很多属性，如果状态码，Cookie等等，而且它实际的内容都是以字节方式传输的。<br>因为这种情况很普遍，所以Netty抽象了一个接口ByteBufHolder。这样做的好处就是Netty可以优化分配<br>ByteBuf，例如使用池技术，也能够自动释放这部分资源。<br>ByteBufHolder实际上比较有用的方法就是访问它里面存储的数据以及使用引用计数功能。下表展示了它常用的方<br>法。<br>如果你传输的数据存储的是ByteBuf，那么使用ByteBufHolder是一个不错的选择。</p>
<h2 id="4-1、Netty缓冲区帮助类"><a href="#4-1、Netty缓冲区帮助类" class="headerlink" title="4.1、Netty缓冲区帮助类"></a>4.1、Netty缓冲区帮助类</h2><p>使用JDK的NIO API的一个困难是完成一个简单的任务有很多重复性的代码。虽然Netty提供的缓冲区API已经很容易<br>使用了，但是Netty还是提供了很多工具类方便开发者创建或使用缓冲区。<br>名称描述<br>buffer() 创建ByteBuf，类似可能是堆或直接的，依赖具体的实现<br>buffer(int)<br>buffer(int, int)<br>heapBuffer() 创建堆类型ByteBuf<br>heapBuffer(int)<br>heapBuffer(int, int)<br>directBuffer() 创建直接类型ByteBuf<br>directBuffer(int)<br>directBuffer(int, int)<br>compositeBuffer() 创建复合类型缓冲区<br>compositeBuffer(int)<br>heapCompositeBuffer() 内部为堆类型ByteBuf的复合缓冲区<br>heapCompositeBuffer(int)<br>directCompositeBuffer() 内部为直接类型ByteBuf的复合缓冲区<br>directCompositeBuffer(int)<br>ioBuffer() 创建用于IO操作的ByteBuf</p>
<h2 id="4-2、ByteBufAllocator"><a href="#4-2、ByteBufAllocator" class="headerlink" title="4.2、ByteBufAllocator"></a>4.2、ByteBufAllocator</h2><p>前面提到过，Netty提供了池技术优化了各种ByteBuf。为了实现这个功能Netty抽象了一个ByteBufAllocator接<br>口。它主要是用来分配ByteBuf实例的。<br>我们先来看一下ByteBufAllocator提供了哪些操作。<br>有些方法后面带了一个或两个Int类型参数，这两个参数就是指定ByteBuf的初始容量和最大容量的。你应该记得<br>ByteBuf是可以扩容的。ByteBuf可以不断扩容只到达到了最大容量。<br>获取ByteBufAllocator的引用也是很容易的事情。通过Channel或者你实现的ChannelHandler的方法中的<br>ChannelHandlerContext。更多关于ChannelHandlerContext和ChannelHandler的知识将会在第六章介绍。<br>下面的代码展示了获取ByteBufAllocator的方式。<br>名称描述<br>buffer() 创建未使用池技术的堆缓冲ByteBuf<br>buffer(int)<br>buffer(int, int)<br>directBuffer() 创建未使用池技术的直接缓冲ByteBuf<br>directBuffer(int)<br>directBuffer(int, int)<br>wrappedBuffer() 创建包含给定数据的ByteBuf<br>copiedBuffer() 复制给定数据然后创建ByteBuf</p>
<h2 id="4-3、Unpooled"><a href="#4-3、Unpooled" class="headerlink" title="4.3、Unpooled"></a>4.3、Unpooled</h2><p>有时候你没办法获取ByteBufAllocator的实例，也就是没办法使用上一节介绍的方式创建ByteBuf实例。为了应对<br>这种情况，Netty提供了一个工具类Unpooled。这个工具类提供了很多静态方法帮助我们创建ByteBuf实例，不过<br>没有使用池技术。 先来看看它提供了哪些常用方法给我们使用。<br>你也可以在非Netty项目中使用<br>Unpooled，因为它的API很简单，性能也很高，项目中如果需要这种高性能缓冲区的地方可以尝试一下。</p>
<h2 id="4-4、ByteBufUtil"><a href="#4-4、ByteBufUtil" class="headerlink" title="4.4、ByteBufUtil"></a>4.4、ByteBufUtil</h2><p>另一个比较有用的类是ByteBufUtil。这个类提供了很多静态方法直接操作ByteBuf。相比较上面的Unpooled，这<br>个类提供的方法是比较通用的并且不用关心你的ByteBuf是使用了池技术的还是没有使用。 例如它最常用的方法<br>hexdump()，这个方法返回ByteBuf内容的十六进制格式。这个方法可以使用在很多场景，例如日志场景。十六进<br>制格式的内容也很容易转成字节表示。你也许奇怪为什么不直接显示字节内容。主要是因为字节内容人类难以阅<br>读，而16进制就比较友好了。 这个类提供了很多ByteBuf相关的静态方法，例如复制、编码、解码等等，这个大家<br>在以后开发中会慢慢用到，甚至当你需要实现自己的ByteBuf的时候也会用到它们。</p>
<h1 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h1><p>我们还学习了Netty的数据容器有哪些类型的实现，已经各自的使用场景和性能高低，还有分配或释放需要的资源<br>代价。<br>Channel channel = …;<br>ByteBufAllocator allocator = channel.alloc();<br>….<br>ChannelHandlerContext ctx = …;<br>ByteBufAllocator allocator2 = ctx.alloc();</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/03/04/DES、AES、RSA等常用加密算法介绍与比较/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/04/DES、AES、RSA等常用加密算法介绍与比较/" itemprop="url">DES、AES、RSA等常用加密算法介绍与比较</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-04T09:31:44+08:00">
                2019-03-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/安全/" itemprop="url" rel="index">
                    <span itemprop="name">安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/04/DES、AES、RSA等常用加密算法介绍与比较/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/03/04/DES、AES、RSA等常用加密算法介绍与比较/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  6
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p> 加密算法分对称加密和非对称算法，其中对称加密算法的加密与解密密钥相同，非对称加密算法的加密密钥与解密密钥不同，此外，还有一类不需要密钥的散列算法。</p>
<p>​       常见的对称加密算法主要有DES、3DES、AES等，常见的非对称算法主要有RSA、DSA等，散列算法主要有SHA-1、MD5等。</p>
<h1 id="非对称算法"><a href="#非对称算法" class="headerlink" title="非对称算法"></a>非对称算法</h1><p>非对称加密算法的加密密钥与解密密钥不同</p>
<p>非对称加密，公钥加密，私钥解密，反之亦然。由于需要大数的乘幂求模等算法，运行速度慢，不易于硬件实现。</p>
<p>通常私钥长度有512bit，1024bit，2048bit，4096bit，长度越长，越安全，但是生成密钥越慢，加解密也越耗时。</p>
<p>既然是加密，那肯定是不希望别人知道我的消息，所以只有我才能解密，所以可得出公钥负责加密，私钥负责解密；</p>
<p>同理，既然是签名，那肯定是不希望有人冒充我发消息，只有我才能发布这个签名，所以可得出私钥负责签名，公钥负责验证。</p>
<p>非对称式加密就是加密和解密所使用的不是同一个密钥，通常有两个密钥，称为”公钥”和”私钥”，它们两个必需配对使用，否则不能打开加密文件。发送双方A,B事先均生成一堆密匙，然后A将自己的公有密匙发送给B，B将自己的公有密匙发送给A，如果A要给B发送消 息，则先需要用B的公有密匙进行消息加密，然后发送给B端，此时B端再用自己的私有密匙进行消息解密，B向A发送消息时为同样的道理。</p>
<h2 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h2><p>非对称加密，公钥加密，私钥解密，反之亦然。由于需要大数的乘幂求模等算法，运行速度慢，不易于硬件实现。</p>
<p>通常私钥长度有512bit，1024bit，2048bit，4096bit，长度越长，越安全，但是生成密钥越慢，加解密也越耗时。</p>
<p>既然是加密，那肯定是不希望别人知道我的消息，所以只有我才能解密，所以可得出公钥负责加密，私钥负责解密；</p>
<p>同理，既然是签名，那肯定是不希望有人冒充我发消息，只有我才能发布这个签名，所以可得出私钥负责签名，公钥负责验证。</p>
<h2 id="DSA"><a href="#DSA" class="headerlink" title="DSA"></a>DSA</h2><p><strong>DSA</strong>（Digital Signature Algorithm）：数字签名算法，是一种标准的 DSS（数字签名标准），严格来说不算加密算法。</p>
<h2 id="ECC"><a href="#ECC" class="headerlink" title="ECC"></a>ECC</h2><p><strong>ECC</strong>（Elliptic Curves Cryptography）：椭圆曲线密码编码学。ECC和RSA相比，具有多方面的绝对优势，主要有：抗攻击性强。相同的密钥长度，其抗攻击性要强很多倍。计算量小，处理速度快。ECC总的速度比RSA、DSA要快得多。存储空间占用小。ECC的密钥尺寸和系统参数与RSA、DSA相比要小得多，意味着它所占的存贮空间要小得多。这对于加密算法在IC卡上的应用具有特别重要的意义。带宽要求低。当对长消息进行加解密时，三类密码系统有相同的带宽要求，但应用于短消息时ECC带宽要求却低得多。带宽要求低使ECC在无线网络领域具有广泛的应用前景。</p>
<h1 id="对称加密算法"><a href="#对称加密算法" class="headerlink" title="对称加密算法"></a>对称加密算法</h1><p>对称式加密就是加密和解密使用<strong>同一个密钥</strong>。信息接收双方都需事先知道密匙和加解密算法且其密匙是相同的，之后便是对数据进行加解密了。对称加密算法用来对敏感数据等信息进行加密。</p>
<p>对称加密算法的<strong>加密与解密密钥相同</strong></p>
<h2 id="AES"><a href="#AES" class="headerlink" title="AES"></a>AES</h2><p><strong>AES（Advanced Encryption Standard）</strong>：高级加密标准，是下一代的加密算法标准，速度快，安全级别高；AES是一个使用<strong>128为分组块</strong>的分组加密算法，<strong>分组块和128、192或256位的密钥</strong>一起作为输入，对4×4的字节数组上进行操作。众所周之AES是种十分高效的算法，尤其在8位架构中，这源于它面向字节的设计。AES 适用于8位的小型单片机或者普通的32位微处理器,并且适合用专门的硬件实现，硬件实现能够使其吞吐量（每秒可以到达的加密/解密bit数）达到十亿量级。同样，其也适用于RFID系统。</p>
<p>对称加密，密钥最长只有256个bit，执行速度快，易于硬件实现。由于是对称加密，密钥需要在传输前通讯双方获知。</p>
<p><strong>基于以上特点，通常使用RSA来首先传输AES的密钥给对方，然后再使用AES来进行加密通讯。</strong></p>
<h2 id="DES"><a href="#DES" class="headerlink" title="DES"></a>DES</h2><p><strong>DES</strong>（Data Encryption Standard）：数据加密标准，速度较快，适用于加密大量数据的场合。</p>
<h2 id="3DES"><a href="#3DES" class="headerlink" title="3DES"></a>3DES</h2><p><strong>3DES</strong>（Triple DES）：是基于DES，对一块数据用三个不同的密钥进行三次加密，强度更高。</p>
<h1 id="散列算法"><a href="#散列算法" class="headerlink" title="散列算法"></a>散列算法</h1><p><strong>散列算法，又称哈希函数</strong>，是一种单向加密算法。在信息安全技术中，经常需要验证消息的完整性，散列(Hash)函数提供了这一服务，它对不同长度的输入消息，<strong>产生固定长度的输出</strong>。这个固定长度的输出称为原输入消息的”散列”或”消息摘要”(Message digest)。散列算法不算加密算法，因为其结果是不可逆的，既然是不可逆的，那么当然不是用来加密的，而是签名。</p>
<p>散列算法主要有SHA-1、MD5等</p>
<p><strong>MD5输出128bit、SHA1输出160bit、SHA256输出256bit</strong><br><code>SHA-1</code>是160位的哈希值，而<code>SHA-2</code>是组合值，有不同的位数，其中最受欢迎的是256位。</p>
<p>因为<code>SHA-2</code>有多种不同的位数，导致这个名词有一些混乱。但是无论是“<code>SHA-2</code>”，“<code>SHA-256</code>”或“<code>SHA-256位</code>”，其实都是指同一种加密算法。但是<code>SHA-224</code>，“<code>SHA-384</code>”或“<code>SHA-512</code>”，表示<code>SHA-2</code>的二进制长度。还要另一种就是会把算法和二进制长度都写上，如“<code>SHA-2 384</code>”。</p>
<p>SSL行业选择<code>SHA</code>作为数字签名的散列算法，从2011到2015，一直以<code>SHA-1</code>位主导算法。但随着互联网技术的提升，<code>SHA-1</code>的缺点越来越突显。从去年起，<code>SHA-2</code>成为了新的标准，所以现在签发的<code>SSL</code>证书，必须使用该算法签名。</p>
<p>也许有人偶尔会看到<code>SHA-2 384</code>位的证书，很少会看到<code>224</code>位，因为<code>224</code>位不允许用于公共信任的证书，<code>512</code>位，不被软件支持。<br>初步预计，<code>SHA-2</code>的使用年限为五年，但也许会被提前淘汰。这需要时间来验证。</p>
<hr>
<p>以一个60M的文件为测试样本，经过1000次的测试平均值，三种算法的表现为：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MD5算法运行<span class="number">1000</span>次的平均时间为：<span class="number">226</span>ms</span><br><span class="line">SHA1算法运行<span class="number">1000</span>次的平均时间为：<span class="number">308</span>ms</span><br><span class="line">SHA256算法运行<span class="number">1000</span>次的平均时间为：<span class="number">473</span>ms123</span><br></pre></td></tr></table></figure>
<p>安全性方面，显然<code>SHA256</code>（又称<code>SHA2</code>）的安全性最高，但是耗时要比其他两种多很多。<code>MD5</code>相对较容易破解，因此，<code>SHA1</code>应该是这三种中性能最好的一款加密算法。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2019/02/26/使用Spring5的Webflux开发Reactive应用（SSE-、Websocket/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/26/使用Spring5的Webflux开发Reactive应用（SSE-、Websocket/" itemprop="url">使用Spring5的Webflux开发Reactive应用（SSE 、Websocket)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-26T10:34:15+08:00">
                2019-02-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index">
                    <span itemprop="name">Spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/26/使用Spring5的Webflux开发Reactive应用（SSE-、Websocket/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/02/26/使用Spring5的Webflux开发Reactive应用（SSE-、Websocket/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  21
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>对 Java 开发者来说，2017 年 9 月是个热闹的月份，Java SE 9、Java EE 8 相继发布，而 Spring 也在这段时间，发布了 5.0 正式版本。</p>
<p>身为 Java 开发者，对于 Spring 框架并不陌生。Spring 在 Rod Johnson 十几年前一个人单挑 J2EE 体系开始，到十年前开始大行其道至今，基本上已是 Java 开发领域的事实标准了。</p>
<p>Spring 5 中最重要改动是把反应式编程的思想应用到了框架的各个方面，Spring 5 的反应式编程以 Reactor 库为基础。Spring 5 框架所包含的内容很多，这里只重点介绍其中新增的 WebFlux 模块。我们可以使用 WebFlux 创建高性能的 Web 应用和客户端。本文对 WebFlux 模块进行了详细介绍，包括其中的 HTTP、服务器推送事件（SSE）和 WebSocket 支持。</p>
<h1 id="WebFlux-简介"><a href="#WebFlux-简介" class="headerlink" title="WebFlux 简介"></a>WebFlux 简介</h1><p>WebFlux 模块的名称是 spring-webflux，名称中的 Flux 来源于 Reactor 中的类 Flux。该模块中包含了对反应式 HTTP、服务器推送事件和 WebSocket 的客户端和服务器端的支持。<br>对于开发人员来说，比较重要的是服务器端的开发，这也是本文的重点。在服务器端，WebFlux 支持两种不同的编程模型：第一种是 Spring MVC 中使用的基于 Java 注解的方式；第二种是基于 Java 8 的 Lambda 表达式的函数式编程模型。这两种编程模型只是在代码编写方式上存在不同。它们运行在同样的反应式底层架构之上，因此在运行时是相同的。WebFlux 需要底层提供运行时的支持，WebFlux 可以运行在支持 Servlet 3.1 非阻塞 IO API 的 Servlet 容器上，或是其他异步运行时环境，如 Netty 和 Undertow。</p>
<p><a href="https://spring.io/img/homepage/diagram-boot-reactor.svg" target="_blank" rel="external"><img src="https://spring.io/img/homepage/diagram-boot-reactor.svg" alt="img"></a><br>Spring Boot 2 是基于 Spring 5 的，其中一个比较大的更新就在于支持包括 spring-webflux 和响应式的 spring-data 在内的响应式模块，下边的例子我们就用 Spring Boot 2 在进行搭建。</p>
<p>本文从三个方面对 WebFlux 进行介绍。首先是使用经典的基于 Java 注解的编程模型来进行开发，其次是使用 WebFlux 新增的函数式编程模型来进行开发，最后介绍 WebFlux 应用的测试。通过这样循序渐进的方式让读者了解 WebFlux 应用开发的细节。</p>
<h1 id="Java-注解编程模型"><a href="#Java-注解编程模型" class="headerlink" title="Java 注解编程模型"></a>Java 注解编程模型</h1><p>基于 Java 注解的编程模型，对于使用过 Spring MVC 的人来说是再熟悉不过的。在 WebFlux 应用中使用同样的模式，容易理解和上手。我们先从最经典的 Hello World 开始说明。</p>
<p>我们通过 Spring Initializ 创建一个 Spring Boot 工程，因为目前我们还不涉及 DAO 层，所以只选择 Reactive Web 就行了<br><a href="https://ws4.sinaimg.cn/large/006tNc79ly1fqovuf2vr9j31as0v6n2m.jpg" target="_blank" rel="external"><img src="https://ws4.sinaimg.cn/large/006tNc79ly1fqovuf2vr9j31as0v6n2m.jpg" alt="img"></a></p>
<p>也可以使用网页版的 <a href="https://start.spring.io/" target="_blank" rel="external">https://start.spring.io</a> 来创建项目：<br><a href="https://ws3.sinaimg.cn/large/006tNc79ly1fqow11gjudj31kw0v8gwj.jpg" target="_blank" rel="external"><img src="https://ws3.sinaimg.cn/large/006tNc79ly1fqow11gjudj31kw0v8gwj.jpg" alt="img"></a></p>
<p>创建后的项目 POM 中，包含下边的依赖，即表示基于 Spring WebFlux：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>创建 Controller 类<code>HelloController</code>，仅提供一个 Endpoint<code>/hello</code>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(<span class="meta-string">"/hello"</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;String&gt; sayHello()&#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.just(<span class="string">"Hello World!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们启动应用，通过访问 <a href="http://localhost:8080/hello" target="_blank" rel="external">http://localhost:8080/hello</a> 可以得到返回值<code>Hello World!</code>。</p>
<p>通过这个简单的 Hello World 示例我们可以看到使用 WebFlux 与 Spring MVC 的不同在于，WebFlux 所使用的类型是与反应式编程相关的 Flux 和 Mono 等，而不是简单的对象。对于简单的 Hello World 示例来说，这两者之间并没有什么太大的差别。对于复杂的应用来说，反应式编程和负压的优势会体现出来，可以带来整体的性能的提升。</p>
<h2 id="RESTful-API"><a href="#RESTful-API" class="headerlink" title="RESTful API"></a>RESTful API</h2><p>简单的 Hello World 示例并不足以说明 WebFlux 的用法。在下面的小节中，本文将介绍其他具体的实例。先从 RESTful API 开始说起。RESTful API 在 Web 服务器端应用中占据了很大的一部分。我们通过一个具体的实例来说明如何使用 WebFlux 来开发 RESTful API，该 RESTful API 用来对用户数据进行基本的 CRUD 操作。</p>
<p>作为领域对象的<code>User</code>类中包含了<code>id</code>、<code>name</code>和<code>email</code>三个基本的属性。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Data</span> <span class="comment">// 生成无参构造方法 getter setter hashCode equals toString</span></span><br><span class="line"><span class="variable">@AllArgsConstructor</span> <span class="comment">// 生成所有参数构造方法</span></span><br><span class="line"><span class="variable">@NoArgsConstructor</span> <span class="comment">// @AllArgsConstructor 会导致 @Data 不生成无参构造方法，需要手动添加 @NoArgsConstructor，如果没有无参构造方法，可能会导致比如 com.fasterxml.jackson 在序列化处理时报错</span></span><br><span class="line">public class User &#123;</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">Integer</span> <span class="selector-tag">id</span>;</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">String</span> <span class="selector-tag">name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">String</span> <span class="selector-tag">email</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了对<code>User</code>类进行操作，我们需要提供服务类<code>UserService</code>。<code>UserService</code>使用一个 Map 来保存所有用户的信息，并不是一个持久化的实现，这对于示例应用来说已经足够了。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, User&gt; <span class="keyword">data</span> = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> void init() &#123;</span><br><span class="line">        <span class="keyword">data</span>.put(<span class="number">1</span>, new User(<span class="number">1</span>, <span class="string">"张三"</span>, <span class="string">"z3@qq.com"</span>));</span><br><span class="line">        <span class="keyword">data</span>.put(<span class="number">2</span>, new User(<span class="number">2</span>, <span class="string">"李四"</span>, <span class="string">"l4@qq.com"</span>));</span><br><span class="line">        <span class="keyword">data</span>.put(<span class="number">3</span>, new User(<span class="number">3</span>, <span class="string">"王五"</span>, <span class="string">"w5@qq.com"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;User&gt; list() &#123;</span><br><span class="line">        <span class="keyword">return</span> Flux.fromIterable(<span class="keyword">this</span>.<span class="keyword">data</span>.values());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;User&gt; getByIds(Flux&lt;Integer&gt; ids) &#123;</span><br><span class="line">        <span class="keyword">return</span> ids.flatMap(id -&gt; Mono.justOrEmpty(<span class="keyword">this</span>.<span class="keyword">data</span>.<span class="keyword">get</span>(id)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;User&gt; getById(Integer id) &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.justOrEmpty(<span class="keyword">this</span>.<span class="keyword">data</span>.<span class="keyword">get</span>(id))</span><br><span class="line">                .switchIfEmpty(Mono.error(new ResourceNotFoundException()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;User&gt; createOrUpdate(Flux&lt;User&gt; users) &#123;</span><br><span class="line">        <span class="keyword">return</span> users.doOnNext(user -&gt; <span class="keyword">this</span>.<span class="keyword">data</span>.put(user.getId(), user));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;User&gt; createOrUpdate(User user) &#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="keyword">data</span>.put(user.getId(), user);</span><br><span class="line">        <span class="keyword">return</span> Mono.just(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;User&gt; delete(Integer id) &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.justOrEmpty(<span class="keyword">this</span>.<span class="keyword">data</span>.remove(id));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>UserController</code>是具体的 Spring MVC 控制器类，它使用<code>UserService</code>来完成具体的功能。<code>UserController</code>中使用了注解<code>@ExceptionHandler</code>来添加了<code>ResourceNotFoundException</code>异常的处理方法，并返回 404 错误。<code>UserController</code>中的方法都很简单，只是简单地代理给<code>UserService</code>中的对应方法。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="meta-string">"/user"</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(ResourceNotFoundException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(code = HttpStatus.NOT_FOUND, reason = <span class="meta-string">"User not found"</span>)</span></span><br><span class="line">    <span class="keyword">public</span> void notFound()&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(<span class="meta-string">""</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;User&gt; list() &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.list();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(<span class="meta-string">"/&#123;id&#125;"</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;User&gt; getById(<span class="meta">@PathVariable</span> Integer id)&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.getById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(<span class="meta-string">""</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;User&gt; create(<span class="meta">@RequestBody</span> Flux&lt;User&gt; users)&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.createOrUpdate(users);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(<span class="meta-string">"/&#123;id&#125;"</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;User&gt; update(<span class="meta">@PathVariable</span> Integer id, <span class="meta">@RequestBody</span> User user)&#123;</span><br><span class="line">        Objects.requireNonNull(user);</span><br><span class="line">        user.setId(id);</span><br><span class="line">        <span class="keyword">return</span> userService.createOrUpdate(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping(<span class="meta-string">"/&#123;id&#125;"</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;User&gt; delete(<span class="meta">@PathVariable</span> Integer id)&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.delete(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以通过访问 <a href="http://127.0.0.1:8080/user" target="_blank" rel="external">http://127.0.0.1:8080/user</a> 获取到用户信息，其他的 CRUD 操作可以自行测试</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"张三"</span>,</span><br><span class="line">    <span class="attr">"email"</span>: <span class="string">"z3@qq.com"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"李四"</span>,</span><br><span class="line">    <span class="attr">"email"</span>: <span class="string">"l4@qq.com"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"王五"</span>,</span><br><span class="line">    <span class="attr">"email"</span>: <span class="string">"w5@qq.com"</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="服务器推送事件（SSE）"><a href="#服务器推送事件（SSE）" class="headerlink" title="服务器推送事件（SSE）"></a>服务器推送事件（SSE）</h2><p>服务器推送事件（Server-Sent Events，SSE）允许服务器端不断地推送数据到客户端。相对于 WebSocket 而言，服务器推送事件只支持服务器端到客户端的单向数据传递。虽然功能较弱，但优势在于 SSE 在已有的 HTTP 协议上使用简单易懂的文本格式来表示传输的数据。作为 W3C 的推荐规范，SSE 在浏览器端的支持也比较广泛，除了 IE 之外的其他浏览器都提供了支持。在 IE 上也可以使用 polyfill 库来提供支持。在服务器端来说，SSE 是一个不断产生新数据的流，非常适合于用反应式流来表示。在 WebFlux 中创建 SSE 的服务器端是非常简单的。只需要返回的对象的类型是 Flux，就会被自动按照 SSE 规范要求的格式来发送响应。</p>
<p>下面的<code>SseController</code>是一个使用 SSE 的控制器的示例。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="meta-string">"/sse"</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SseController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(<span class="meta-string">"/random"</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;ServerSentEvent&lt;Integer&gt;&gt; random() &#123;</span><br><span class="line">        <span class="keyword">return</span> Flux.interval(Duration.ofSeconds(<span class="number">1</span>)) <span class="comment">// 1</span></span><br><span class="line">                .map(seq -&gt; &#123;</span><br><span class="line">                            <span class="keyword">return</span> ServerSentEvent.&lt;Integer&gt;builder() <span class="comment">// 2</span></span><br><span class="line">                                    .event(<span class="string">"random"</span>)</span><br><span class="line">                                    .id(seq.toString())</span><br><span class="line">                                    .<span class="keyword">data</span>(ThreadLocalRandom.current().nextInt())</span><br><span class="line">                                    .build();</span><br><span class="line">                        &#125;</span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>每 1 秒发出一个自增的 Long 值</li>
<li>使用<code>ServerSentEvent.Builder</code>来创建<code>ServerSentEvent</code>对象</li>
</ol>
<p>在测试 SSE 时，我们只需要使用 curl 来访问即可。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ curl http:<span class="comment">//localhost:8080/sse/random</span></span><br><span class="line"><span class="symbol">id:</span><span class="number">0</span></span><br><span class="line"><span class="symbol">event:</span>random</span><br><span class="line"><span class="symbol">data:</span><span class="number">-244762412</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">id:</span><span class="number">1</span></span><br><span class="line"><span class="symbol">event:</span>random</span><br><span class="line"><span class="symbol">data:</span><span class="number">-1757349679</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">id:</span><span class="number">2</span></span><br><span class="line"><span class="symbol">event:</span>random</span><br><span class="line"><span class="symbol">data:</span><span class="number">496598301</span></span><br></pre></td></tr></table></figure>
<h2 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h2><p>WebSocket 支持客户端与服务器端的双向通讯。当客户端与服务器端之间的交互方式比较复杂时，可以使用 WebSocket。WebSocket 在主流的浏览器上都得到了支持。<br>WebFlux 也对创建 WebSocket 服务器端提供了支持。在服务器端，我们需要实现接口<code>org.springframework.web.reactive.socket.WebSocketHandler</code>来处理 WebSocket 通讯，其<code>handle</code>方法的参数是<code>WebSocketSession</code>对象，可以用来获取客户端信息、接送消息和发送消息。</p>
<p>下面的<code>EchoHandler</code>对于每个接收到的消息，都会在其前边添加一个前缀<code>Echo -&gt;</code>再发送出去。<code>WebSocketSession</code>的<code>receive()</code>方法的返回值是一个<code>Flux&lt;WebSocketMessage&gt;</code>对象，表示的是接收到的消息流，而<code>send()</code>方法的参数是一个<code>Publisher&lt;WebSocketMessage&gt;</code>对象，表示要发送的消息流。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoHandler</span> <span class="keyword">implements</span> <span class="title">WebSocketHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(WebSocketSession session)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> session.send(</span><br><span class="line">                session.receive()</span><br><span class="line">                        .map(msg -&gt; session.textMessage(<span class="string">"Echo -&gt; "</span> + msg.getPayloadAsText())));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>仅创建一个<code>WebSocketHandler</code>是不够的，我们还需要把它注册到 WebFlux 中。<br>我们再来需要创建一个<code>WebSocketHandlerAdapter</code>对象，该对象负责把 WebSocketHandler 关联到 WebFlux 中。其中我们使用<code>HandlerMapping</code>把<code>EchoHandler</code>映射到<code>/echo</code>端点。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HandlerMapping <span class="title">webSocketMapping</span><span class="params">(EchoHandler echoHandler)</span></span>&#123;</span><br><span class="line">        Map&lt;String, WebSocketHandler&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        map.put(<span class="string">"/echo"</span>, echoHandler);</span><br><span class="line"></span><br><span class="line">        SimpleUrlHandlerMapping mapping = <span class="keyword">new</span> SimpleUrlHandlerMapping();</span><br><span class="line">        mapping.setOrder(Ordered.HIGHEST_PRECEDENCE);</span><br><span class="line">        mapping.setUrlMap(map);</span><br><span class="line">        <span class="keyword">return</span> mapping;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WebSocketHandlerAdapter <span class="title">webSocketHandlerAdapter</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WebSocketHandlerAdapter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行应用之后，可以使用<a href="https://www.websocket.org/echo.html" target="_blank" rel="external">工具</a>来测试该 WebSocket 服务。<br>打开<a href="https://www.websocket.org/echo.html" target="_blank" rel="external">工具页面</a>，然后连接到<code>ws://localhost:8080/echo</code>可以发送消息并查看服务器端返回的结果。<br><a href="https://ws3.sinaimg.cn/large/006tNc79ly1fqoxyc59hfj311g0e5mzr.jpg" target="_blank" rel="external"><img src="https://ws3.sinaimg.cn/large/006tNc79ly1fqoxyc59hfj311g0e5mzr.jpg" alt="img"></a></p>
<h1 id="函数式编程模型"><a href="#函数式编程模型" class="headerlink" title="函数式编程模型"></a>函数式编程模型</h1><p>前面介绍了基于 Java 注解的编程模型，WebFlux 还支持基于 Lambda 表达式的函数式编程模型。与基于 Java 注解的编程模型相比，函数式编程模型的抽象层次更低，代码编写更灵活，可以满足一些对动态性要求更高的场景。不过在编写时的代码复杂度也较高，学习曲线也较陡。</p>
<p>目前 Spring Boot 已支持在一个应用中同时使用两种不同的编程模式，我们可以根据实际的需要来选择合适的编程模型。</p>
<p>在函数式编程模型中，每个请求是由一个函数来处理的， 通过接口<code>org.springframework.web.reactive.function.server.HandlerFunction</code>来表示。<code>HandlerFunction</code>是一个函数式接口，其中只有一个方法，因此可以用 Labmda 表达式来实现该接口：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mono&lt;T extends ServerResponse&gt; handle(<span class="name">ServerRequest</span> request)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>然后通过函数式接口<code>org.springframework.web.reactive.function.server.RouterFunction</code>来为这些<code>HandlerFunction</code>提供路由信息，输入为请求，输出为装在 Mono 里边的<code>Handlerfunction</code></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mono&lt;HandlerFunction&lt;T<span class="meta">&gt;&gt; </span>route(ServerRequest request);</span><br></pre></td></tr></table></figure>
<p>我们看到，在 WebFlux 中，请求和响应不再是 WebMVC 中的<code>ServletRequest</code>和<code>ServletResponse</code>，而是<code>ServerRequest</code>和<code>ServerResponse</code>。后者是在响应式编程中使用的接口，它们提供了对非阻塞和回压特性的支持，以及 HTTP 消息体与响应式类型 Mono 和 Flux 的转换方法。</p>
<p>下面我们用函数式的方式开发一个简单的计算器，有<code>add</code>、<code>subtract</code>、<code>multiply</code>和<code>divide</code>四个方法，都是接口<code>HandlerFunction</code>的实现，分别对应加、减、乘、除四种运算。</p>
<p>对于这个需求，HandlerFunction 很容易写：</p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HandlerFunction&lt;ServerResponse&gt; add = request -&gt; ServerResponse.ok()</span><br><span class="line">            .<span class="keyword">body</span>(Mono.just(parseOperand(request, <span class="string">"v1"</span>) + parseOperand(request, <span class="string">"v2"</span>)), Integer.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> parseOperand(<span class="keyword">final</span> ServerRequest request, <span class="keyword">final</span> String param) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Integer.parseInt(request.queryParam(param).orElse(<span class="string">"0"</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> NumberFormatException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么 RouterFunction 为：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line"><span class="function"><span class="keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="title">routerFunction</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RouterFunctions.route(RequestPredicates.GET(<span class="string">"/add"</span>), <span class="keyword">add</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动服务，访问 <a href="http://localhost:8080/add?v1=2&amp;v2=3" target="_blank" rel="external">http://localhost:8080/add?v1=2&amp;v2=3</a> 即计算 2+3 得到返回值<code>5</code>。</p>
<p>不过这么写在业务逻辑复杂的时候不太好组织，我们通常采用跟 MVC 类似的代码组织方式，将同类业务的 HandlerFunction 放在一个类中，然后在 Java Config 中将 RouterFunction 配置为 Spring 容器的 Bean。我们继续在这个计算器的代码上开发：</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">CalculatorHandler</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    public Mono&lt;ServerResponse&gt; add(final ServerRequest request) &#123;</span><br><span class="line">        <span class="keyword">return</span> calculate<span class="function"><span class="params">(request, (v1, v2) -&gt; v1 + v2)</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">public</span> <span class="title">Mono</span>&lt;<span class="title">ServerResponse</span>&gt; <span class="title">subtract</span><span class="params">(final ServerRequest request)</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">return</span> <span class="title">calculate</span><span class="params">(request, (v1, v2) -&gt; v1 - v2)</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">public</span> <span class="title">Mono</span>&lt;<span class="title">ServerResponse</span>&gt; <span class="title">multiply</span><span class="params">(final ServerRequest request)</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">return</span> <span class="title">calculate</span><span class="params">(request, (v1, v2) -&gt; v1 * v2)</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">public</span> <span class="title">Mono</span>&lt;<span class="title">ServerResponse</span>&gt; <span class="title">divide</span><span class="params">(final ServerRequest request)</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">return</span> <span class="title">calculate</span><span class="params">(request, (v1, v2) -&gt; v1 / v2)</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">private</span> <span class="title">Mono</span>&lt;<span class="title">ServerResponse</span>&gt; <span class="title">calculate</span><span class="params">(final ServerRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           final BiFunction&lt;Integer, Integer, Integer&gt; calculateFunc)</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">final</span> <span class="title">Tuple2</span>&lt;<span class="title">Integer</span>, <span class="title">Integer</span>&gt; <span class="title">operands</span> = <span class="title">extractOperands</span><span class="params">(request)</span>;</span></span><br><span class="line"><span class="function">        <span class="title">return</span> <span class="title">ServerResponse</span></span></span><br><span class="line"><span class="function">                .<span class="title">ok</span><span class="params">()</span></span></span><br><span class="line"><span class="function">                .<span class="title">body</span><span class="params">(Mono.just(calculateFunc.apply(operands.getT1(), operands.getT2())), Integer.class)</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">private</span> <span class="title">Tuple2</span>&lt;<span class="title">Integer</span>, <span class="title">Integer</span>&gt; <span class="title">extractOperands</span><span class="params">(final ServerRequest request)</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">return</span> <span class="title">Tuples</span>.<span class="title">of</span><span class="params">(parseOperand(request, <span class="string">"v1"</span>), parseOperand(request, <span class="string">"v2"</span>))</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">private</span> <span class="title">int</span> <span class="title">parseOperand</span><span class="params">(final ServerRequest request, final String param)</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">try</span> &#123;</span></span><br><span class="line"><span class="function">            <span class="title">return</span> <span class="title">Integer</span>.<span class="title">parseInt</span><span class="params">(request.queryParam(param).orElse(<span class="string">"0"</span>))</span>;</span></span><br><span class="line"><span class="function">        &#125; <span class="title">catch</span> <span class="params">(final NumberFormatException e)</span> &#123;</span></span><br><span class="line"><span class="function">            <span class="title">return</span> 0;</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p>我们采用 Spring 现在比较推荐的 Java Config 的配置 Bean 的方式，创建用于存放 Router 的配置类<code>RouterConfig.java</code>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouterConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> RouterFunction&lt;ServerResponse&gt; routerFunction(<span class="keyword">final</span> CalculatorHandler calculatorHandler) &#123;</span><br><span class="line">        <span class="keyword">return</span> RouterFunctions.route(RequestPredicates.path(<span class="string">"/calculator"</span>), request -&gt;</span><br><span class="line">                request.queryParam(<span class="string">"operator"</span>).map(<span class="keyword">operator</span> -&gt;</span><br><span class="line">                        Mono.justOrEmpty(ReflectionUtils.findMethod(CalculatorHandler.<span class="keyword">class</span>, <span class="keyword">operator</span>, ServerRequest.<span class="keyword">class</span>))</span><br><span class="line">                                .flatMap(method -&gt; (Mono&lt;ServerResponse&gt;) ReflectionUtils.invokeMethod(method, calculatorHandler, request))</span><br><span class="line">                                .switchIfEmpty(ServerResponse.badRequest().build())</span><br><span class="line">                                .onErrorResume(ex -&gt; ServerResponse.status(HttpStatus.INTERNAL_SERVER_ERROR).build()))</span><br><span class="line">                        .orElse(ServerResponse.badRequest().build()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上边的代码中，我们首先用<code>RouterFunctions.route</code>来根据<code>Predicate</code>是否匹配来确定<code>HandlerFunction</code>是否被应用。<code>RequestPredicates</code>中包含了很多静态方法来创建常用的基于不同匹配规则的<code>Predicate</code>，如<code>RequestPredicates.path</code>用来根据 HTTP 请求的路径来进行匹配，此处我们检查请求的路径是<code>/calculator</code>。然后使用<code>ServerRequest</code>的<code>queryParam</code>方法来获取到参数<code>operator</code>的值，然后通过反射 API 在<code>CalculatorHandler</code>中找到与参数<code>operator</code>的值名称相同的方法来确定要调用的<code>HandlerFunction</code>的实现，最后调用查找到的方法来处理该请求。如果找不到参数<code>operator</code>，服务器端返回 400 错误；如果反射 API 的方法调用中出现错误，服务器端返回 500 错误。</p>
<p>重启服务然后我们访问 <a href="http://127.0.0.1:8080/calculator?operator=add&amp;v1=2&amp;v2=3" target="_blank" rel="external">http://127.0.0.1:8080/calculator?operator=add&amp;v1=2&amp;v2=3</a> 得到返回值<code>5</code>。</p>
<h1 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h1><p>除了服务器端实现之外，WebFlux 也提供了反应式客户端，可以访问 HTTP、SSE 和 WebSocket 服务器端。</p>
<h2 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h2><p>对于 HTTP 和 SSE，可以使用 WebFlux 模块中的类<code>org.springframework.web.reactive.function.client.WebClient</code>。下面的代码中我们将用<code>RESTClient</code>来访问前面小节中创建的 REST API。</p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> testRESTClient() throws InterruptedException &#123;</span><br><span class="line">    User user = <span class="keyword">new</span> User(<span class="number">4</span>, <span class="string">"赵六"</span>, <span class="string">"z6@qq.com"</span>);</span><br><span class="line">    WebClient client = WebClient.create(<span class="string">"http://localhost:8080/user"</span>); <span class="comment">// 1</span></span><br><span class="line">    Flux&lt;User&gt; createdUser = client.post() <span class="comment">// 2</span></span><br><span class="line">            .uri(<span class="string">""</span>) <span class="comment">// 3</span></span><br><span class="line">            .accept(MediaType.APPLICATION_JSON) <span class="comment">// 4</span></span><br><span class="line">            .<span class="keyword">body</span>(Mono.just(user), User.<span class="keyword">class</span>) <span class="comment">// 5</span></span><br><span class="line">            .retrieve() <span class="comment">// 6</span></span><br><span class="line">            .bodyToFlux(User.<span class="keyword">class</span>); <span class="comment">// 7</span></span><br><span class="line"></span><br><span class="line">    createdUser.subscribe(System.<span class="keyword">out</span>::println); <span class="comment">// 8</span></span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">1</span>); <span class="comment">// 9</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>使用<code>WebClient.create</code>方法来创建一个新的<code>WebClient</code>对象</li>
<li>使用<code>post</code>方法来创建一个 POST 请求</li>
<li>指定 baseUrl</li>
<li>配置请求 Header：<code>Content-Type: application/json</code></li>
<li>使用<code>body()</code>方法来设置 POST 请求的内容</li>
<li>异步地获取 response 信息，返回值为<code>WebClient.ResponseSpec</code>，<code>retrive()</code>可以看做是<code>exchange()</code>方法的 “快捷版”（<code>exchange()</code>的返回值为<code>ClientResponse</code>）</li>
<li><code>WebClient.ResponseSpec</code>的<code>bodyToFlux</code>方法把响应内容转换成<code>User</code>对象，最终得到的结果是<code>Flux&lt;User&gt;</code></li>
<li>打印出来</li>
<li>由于是异步的，我们将测试线程 sleep 1 秒确保拿到 response，也可以用<code>CountDownLatch</code></li>
</ol>
<p><a href="https://ws4.sinaimg.cn/large/006tNc79ly1fqp20ifrhzj30wi0hmaf8.jpg" target="_blank" rel="external"><img src="https://ws4.sinaimg.cn/large/006tNc79ly1fqp20ifrhzj30wi0hmaf8.jpg" alt="img"></a></p>
<h2 id="SEE"><a href="#SEE" class="headerlink" title="SEE"></a>SEE</h2><p>WebClient 还可以用同样的方式来访问 SSE 服务。这里我们访问的是在之前的小节中创建的生成随机数的 SSE 服务。使用 WebClient 访问 SSE 在发送请求部分与访问 REST API 是相同的，所不同的地方在于对 HTTP 响应的处理。</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testSEEClient() &#123;</span><br><span class="line">    <span class="attribute">final WebClient client = WebClient.create();</span></span><br><span class="line"><span class="attribute">    client.get()</span></span><br><span class="line"><span class="attribute">            .uri("http</span>://localhost:8080/sse/random")</span><br><span class="line">            <span class="variable">.accept</span>(MediaType<span class="variable">.TEXT_EVENT_STREAM</span>)</span><br><span class="line">            <span class="variable">.exchange</span>()</span><br><span class="line">            <span class="variable">.flatMapMany</span>(response -&gt; // 1</span><br><span class="line">                    response<span class="variable">.body</span>(</span><br><span class="line">                            BodyExtractors<span class="variable">.toFlux</span>(</span><br><span class="line">                                    new ParameterizedTypeReference&lt;ServerSentEvent&lt;String&gt;&gt;() &#123;&#125;</span><br><span class="line">                            )</span><br><span class="line">                    )</span><br><span class="line">            )</span><br><span class="line">            <span class="variable">.filter</span>(sse -&gt; Objects<span class="variable">.nonNull</span>(sse<span class="variable">.data</span>()))</span><br><span class="line">            <span class="variable">.map</span>(ServerSentEvent::data)</span><br><span class="line">            <span class="variable">.buffer</span>(10) // 2</span><br><span class="line">            <span class="variable">.doOnNext</span>(System<span class="variable">.out</span>::println) // 3</span><br><span class="line">            <span class="variable">.blockFirst</span>(); // 4</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>由于 SSE 服务的响应是一个消息流，我们需要使用<code>flatMapMany</code>把 <code>Mono&lt;ServerResponse&gt;</code>转换成一个<code>Flux&lt;ServerSentEvent&gt;</code>对象，这是通过方法<code>BodyExtractors.toFlux</code>来完成的，其中的参数<code>new ParameterizedTypeReference&lt;ServerSentEvent&lt;String&gt;&gt;() {}</code>表明了响应消息流中的内容是<code>ServerSentEvent</code>对象</li>
<li>由于 SSE 服务器会不断地发送消息，这里我们只是通过<code>buffer</code>方法来获取前 10 条消息并输出</li>
<li>只读地 peek 每个元素，然后打印出来，它并不是 subscribe，所以不会触发流</li>
<li><code>blockFirst</code>方法，顾名思义，在收到第一个元素前会阻塞，响应式业务场景中慎用</li>
</ol>
<p>运行效果如下：<br><a href="https://ws4.sinaimg.cn/large/006tNc79ly1fqp1z8lm44j31kw08u0ut.jpg" target="_blank" rel="external"><img src="https://ws4.sinaimg.cn/large/006tNc79ly1fqp1z8lm44j31kw08u0ut.jpg" alt="img"></a></p>
<p>或者也可以像下边这样</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testSEEClient2() &#123;</span><br><span class="line">    <span class="attribute">WebClient client = WebClient.create();</span></span><br><span class="line"><span class="attribute">    client.get()</span></span><br><span class="line"><span class="attribute">            .uri("http</span>://localhost:8080/sse/random")</span><br><span class="line">            <span class="variable">.accept</span>(MediaType<span class="variable">.TEXT_EVENT_STREAM</span>)</span><br><span class="line">            <span class="variable">.retrieve</span>()</span><br><span class="line">            <span class="variable">.bodyToFlux</span>(String<span class="variable">.class</span>)</span><br><span class="line">            <span class="variable">.log</span>()</span><br><span class="line">            <span class="variable">.take</span>(10)</span><br><span class="line">            <span class="variable">.blockLast</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行效果如下：<br><a href="https://ws1.sinaimg.cn/large/006tNc79ly1fqp25ohnygj311g0j6jw0.jpg" target="_blank" rel="external"><img src="https://ws1.sinaimg.cn/large/006tNc79ly1fqp25ohnygj311g0j6jw0.jpg" alt="img"></a></p>
<h2 id="WebSocket-1"><a href="#WebSocket-1" class="headerlink" title="WebSocket"></a>WebSocket</h2><p>访问 WebSocket 不能使用 WebClient，而应该使用专门的 WebSocketClient 客户端。Spring Boot 的 WebFlux 模板中默认使用的是 Reactor Netty 库。Reactor Netty 库提供了 WebSocketClient 的实现。我们这里访问前面创建的 WebSocket 服务。</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line"><span class="keyword">public</span> <span class="literal">void</span> testWSClient() &#123;</span><br><span class="line">    WebSocketClient client = <span class="literal">new</span> ReactorNettyWebSocketClient(); <span class="comment">// 1</span></span><br><span class="line">    client.execute(URI.create(<span class="string">"ws://localhost:8080/echo"</span>), session -&gt; <span class="comment">// 2</span></span><br><span class="line">            session.send(Flux.just(session.textMessage(<span class="string">"Hello"</span>))) <span class="comment">// 3</span></span><br><span class="line">                    .thenMany(session.receive().<span class="keyword">take</span>(<span class="number">1</span>).<span class="built_in">map</span>(WebSocketMessage<span class="type">::getPayloadAsText</span>)) <span class="comment">// 4</span></span><br><span class="line">                    .doOnNext(System.out<span class="type">::println</span>)</span><br><span class="line">                    .then())</span><br><span class="line">            .block(<span class="built_in">Duration</span>.ofMillis(<span class="number">5000</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>创建一个 WebSocketClient 实例</li>
<li>使用 WebSocketClient 的<code>execute</code>方法与 WebSocket 服务器建立连接，并执行给定的 WebSocketHandler 对象</li>
<li>通过 WebSocketSession 的<code>send</code>方法来发送字符串”Hello” 到服务器端</li>
<li>通过<code>receive</code>方法来等待服务器端的响应并输出，<code>take(1)</code>的作用是表明客户端只获取服务器端发送的第一条消息</li>
</ol>
<p>运行效果如下：<br><a href="https://ws2.sinaimg.cn/large/006tNc79ly1fqp2mdfjfcj30tw0gkdjc.jpg" target="_blank" rel="external"><img src="https://ws2.sinaimg.cn/large/006tNc79ly1fqp2mdfjfcj30tw0gkdjc.jpg" alt="img"></a></p>
<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><p>在 spring-test 模块中也添加了对 WebFlux 的支持。通过类 <code>org.springframework.test.web.reactive.server.WebTestClient</code>可以测试 WebFlux 服务器。进行测试时既可以通过 mock 的方式来进行，也可以对实际运行的服务器进行集成测试。</p>
<p>我们通过一个集成测试来测试<code>UserController</code>中的创建用户的功能。方法 <code>WebTestClient.bindToServer</code>绑定到一个运行的服务器并设置了基础 URL。发送 HTTP 请求的方式与之前的代码相同，不同的是<code>exchange</code>方法的返回值是<code>ResponseSpec</code>对象，其中包含了<code>expectStatus</code>和<code>expectBody</code>等方法来验证 HTTP 响应的状态码和内容。方法<code>jsonPath</code>可以根据 JSON 对象中的路径来进行验证。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public class UserControllerTest &#123;</span><br><span class="line"></span><br><span class="line">    private final WebTestClient<span class="built_in"> client </span>= WebTestClient.bindToServer().baseUrl(<span class="string">"http://localhost:8080"</span>).build();</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testCreateUser() throws Exception &#123;</span><br><span class="line">       <span class="built_in"> User user </span>= new User(5, <span class="string">"钱七"</span>,  <span class="string">"q7@qq.com"</span>);</span><br><span class="line">        client.post().uri(<span class="string">"/user"</span>)</span><br><span class="line">                .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">                .body(Mono.just(user), User.class)</span><br><span class="line">                .exchange()</span><br><span class="line">                .expectStatus().isOk()</span><br><span class="line">                .expectBody().jsonPath(<span class="string">"$[0].name"</span>)</span><br><span class="line">                .isEqualTo(<span class="string">"钱七"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>JsonPath 的语法可以看 <a href="https://github.com/json-path/JsonPath" target="_blank" rel="external">https://github.com/json-path/JsonPath</a></p>
</blockquote>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>反应式编程范式为开发高性能 Web 应用带来了新的机会和挑战。Spring 5 中的 WebFlux 模块可以作为开发反应式 Web 应用的基础。由于 Spring 框架的流行，WebFlux 会成为开发 Web 应用的重要趋势之一。本文对 Spring 5 中的 WebFlux 模块进行了详细的介绍，包括如何用 WebFlux 开发 HTTP、SSE 和 WebSocket 服务器端应用，以及作为客户端来访问 HTTP、SSE 和 WebSocket 服务。对于 WebFlux 的基于 Java 注解和函数式编程等两种模型都进行了介绍。最后介绍了如何测试 WebFlux 应用。</p>
<p>示例代码：<a href="https://github.com/zhaoyibo/spring-webflux" target="_blank" rel="external">Github</a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html" target="_blank" rel="external">Web on Reactive Stack</a><br><a href="https://docs.spring.io/spring-framework/docs/5.0.0.BUILD-SNAPSHOT/spring-framework-reference/html/web-reactive.html" target="_blank" rel="external">23. WebFlux framework</a><br><a href="https://www.ibm.com/developerworks/cn/java/spring5-webflux-reactive/index.html" target="_blank" rel="external">使用 Spring 5 的 WebFlux 开发反应式 Web 应用</a><br><a href="https://www.ibm.com/developerworks/cn/java/j-cn-with-reactor-response-encode/index.html" target="_blank" rel="external">使用 Reactor 进行反应式编程</a><br><a href="https://github.com/reactor/reactor-netty" target="_blank" rel="external">Reactor Netty</a><br><a href="https://blog.csdn.net/get_set/article/details/79480233" target="_blank" rel="external">Spring WebFlux 快速上手</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/xiaowu_avatar.jpg"
                alt="周小伍 Joey" />
            
              <p class="site-author-name" itemprop="name">周小伍 Joey</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">150</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">周小伍 Joey</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">276.8k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    
      <script id="dsq-count-scr" src="https://joeyblog.disqus.com/count.js" async></script>
    

    

  




	





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
