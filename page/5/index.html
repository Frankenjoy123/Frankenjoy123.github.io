<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="xiaowu&#39;s blog">
<meta property="og:url" content="https://zhouxiaowu.coding.me/page/5/index.html">
<meta property="og:site_name" content="xiaowu&#39;s blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="xiaowu&#39;s blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhouxiaowu.coding.me/page/5/"/>





  <title>xiaowu's blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3da41265a1a0042eebe5413c0d6c76f5";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">xiaowu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-dubbo">
          <a href="/categories/Dubbo" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            Dubbo
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/11/16/Spring-Boot-AbstractMessageConverterMethodProcessor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/16/Spring-Boot-AbstractMessageConverterMethodProcessor/" itemprop="url">Spring Boot AbstractMessageConverterMethodProcessor</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-16T23:32:40+08:00">
                2018-11-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SpringBoot/" itemprop="url" rel="index">
                    <span itemprop="name">SpringBoot</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/16/Spring-Boot-AbstractMessageConverterMethodProcessor/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/16/Spring-Boot-AbstractMessageConverterMethodProcessor/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  81
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="writeWithMessageConverters"><a href="#writeWithMessageConverters" class="headerlink" title="writeWithMessageConverters"></a><code>writeWithMessageConverters</code></h2><p>org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodProcessor#writeWithMessageConverters(T, org.springframework.core.MethodParameter, org.springframework.http.server.ServletServerHttpRequest, org.springframework.http.server.ServletServerHttpResponse)</p>
<p><code>getAcceptableMediaTypes</code>获取的是 请求头Accept中的MediaType</p>
<p><code>getProducibleMediaTypes</code>获取的是<code>controller</code>中<code>@Producer</code>注解的MediaType，如果两者不一致，报415错误</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;MediaType&gt; requestedMediaTypes = getAcceptableMediaTypes(<span class="name">request</span>)<span class="comment">;</span></span><br><span class="line">List&lt;MediaType&gt; producibleMediaTypes = getProducibleMediaTypes(<span class="name">request</span>, valueType, declaredType)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RequestResponseBodyMethodProcessor <span class="keyword">extends</span> AbstractMessageConverterMethodProcessor</span><br><span class="line"></span><br><span class="line">AbstractMessageConverterMethodProcessor <span class="keyword">extends</span> AbstractMessageConverterMethodArgumentResolver</span><br><span class="line">		<span class="keyword">implements</span> HandlerMethodReturnValueHandler</span><br><span class="line"></span><br><span class="line">AbstractMessageConverterMethodArgumentResolver <span class="keyword">implements</span> HandlerMethodArgumentResolver</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/11/15/MySQL查看和修改字符集的方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/15/MySQL查看和修改字符集的方法/" itemprop="url">MySQL查看和修改字符集的方法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-15T14:05:40+08:00">
                2018-11-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/15/MySQL查看和修改字符集的方法/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/15/MySQL查看和修改字符集的方法/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.1k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  5
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、查看字符集"><a href="#一、查看字符集" class="headerlink" title="一、查看字符集"></a><strong>一、查看字符集</strong></h2><h3 id="1-查看MYSQL数据库服务器和数据库字符集"><a href="#1-查看MYSQL数据库服务器和数据库字符集" class="headerlink" title="1.查看MYSQL数据库服务器和数据库字符集"></a>1.查看MYSQL数据库服务器和数据库字符集</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">方法一：<span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'%character%'</span>;</span><br><span class="line">方法二：<span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'collation%'</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="emphasis">'collation%'</span>;</span><br><span class="line"><span class="code">+----------------------+</span>-----------------+</span><br><span class="line">| Variable<span class="emphasis">_name        | Value           |</span></span><br><span class="line"><span class="emphasis">+----------------------+-----------------+</span></span><br><span class="line"><span class="emphasis">| collation_</span>connection | utf8<span class="emphasis">_general_</span>ci |</span><br><span class="line">| collation<span class="emphasis">_database   | utf8_</span>general<span class="emphasis">_ci |</span></span><br><span class="line"><span class="emphasis">| collation_</span>server     | utf8<span class="emphasis">_general_</span>ci |</span><br><span class="line"><span class="code">+----------------------+</span>-----------------+</span><br><span class="line">rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="emphasis">'collation%'</span>;</span><br><span class="line"><span class="code">+----------------------+</span>-----------------+</span><br><span class="line">| Variable<span class="emphasis">_name        | Value           |</span></span><br><span class="line"><span class="emphasis">+----------------------+-----------------+</span></span><br><span class="line"><span class="emphasis">| collation_</span>connection | utf8<span class="emphasis">_general_</span>ci |</span><br><span class="line">| collation<span class="emphasis">_database   | utf8_</span>general<span class="emphasis">_ci |</span></span><br><span class="line"><span class="emphasis">| collation_</span>server     | utf8<span class="emphasis">_general_</span>ci |</span><br><span class="line"><span class="code">+----------------------+</span>-----------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="2-查看MYSQL所支持的字符集"><a href="#2-查看MYSQL所支持的字符集" class="headerlink" title="2.查看MYSQL所支持的字符集"></a>2.查看MYSQL所支持的字符集</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">charset</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show charset;</span><br><span class="line">+----------+-----------------------------+---------------------+--------+</span><br><span class="line">|<span class="string"> Charset  </span>|<span class="string"> Description                 </span>|<span class="string"> Default collation   </span>|<span class="string"> Maxlen </span>|</span><br><span class="line">+----------+-----------------------------+---------------------+--------+</span><br><span class="line">|<span class="string"> big5     </span>|<span class="string"> Big5 Traditional Chinese    </span>|<span class="string"> big5_chinese_ci     </span>|<span class="string">      2 </span>|</span><br><span class="line">|<span class="string"> dec8     </span>|<span class="string"> DEC West European           </span>|<span class="string"> dec8_swedish_ci     </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> cp850    </span>|<span class="string"> DOS West European           </span>|<span class="string"> cp850_general_ci    </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> hp8      </span>|<span class="string"> HP West European            </span>|<span class="string"> hp8_english_ci      </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> koi8r    </span>|<span class="string"> KOI8-R Relcom Russian       </span>|<span class="string"> koi8r_general_ci    </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> latin1   </span>|<span class="string"> cp1252 West European        </span>|<span class="string"> latin1_swedish_ci   </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> latin2   </span>|<span class="string"> ISO 8859-2 Central European </span>|<span class="string"> latin2_general_ci   </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> swe7     </span>|<span class="string"> 7bit Swedish                </span>|<span class="string"> swe7_swedish_ci     </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> ascii    </span>|<span class="string"> US ASCII                    </span>|<span class="string"> ascii_general_ci    </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> ujis     </span>|<span class="string"> EUC-JP Japanese             </span>|<span class="string"> ujis_japanese_ci    </span>|<span class="string">      3 </span>|</span><br><span class="line">|<span class="string"> sjis     </span>|<span class="string"> Shift-JIS Japanese          </span>|<span class="string"> sjis_japanese_ci    </span>|<span class="string">      2 </span>|</span><br><span class="line">|<span class="string"> hebrew   </span>|<span class="string"> ISO 8859-8 Hebrew           </span>|<span class="string"> hebrew_general_ci   </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> tis620   </span>|<span class="string"> TIS620 Thai                 </span>|<span class="string"> tis620_thai_ci      </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> euckr    </span>|<span class="string"> EUC-KR Korean               </span>|<span class="string"> euckr_korean_ci     </span>|<span class="string">      2 </span>|</span><br><span class="line">|<span class="string"> koi8u    </span>|<span class="string"> KOI8-U Ukrainian            </span>|<span class="string"> koi8u_general_ci    </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> gb2312   </span>|<span class="string"> GB2312 Simplified Chinese   </span>|<span class="string"> gb2312_chinese_ci   </span>|<span class="string">      2 </span>|</span><br><span class="line">|<span class="string"> greek    </span>|<span class="string"> ISO 8859-7 Greek            </span>|<span class="string"> greek_general_ci    </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> cp1250   </span>|<span class="string"> Windows Central European    </span>|<span class="string"> cp1250_general_ci   </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> gbk      </span>|<span class="string"> GBK Simplified Chinese      </span>|<span class="string"> gbk_chinese_ci      </span>|<span class="string">      2 </span>|</span><br><span class="line">|<span class="string"> latin5   </span>|<span class="string"> ISO 8859-9 Turkish          </span>|<span class="string"> latin5_turkish_ci   </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> armscii8 </span>|<span class="string"> ARMSCII-8 Armenian          </span>|<span class="string"> armscii8_general_ci </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> utf8     </span>|<span class="string"> UTF-8 Unicode               </span>|<span class="string"> utf8_general_ci     </span>|<span class="string">      3 </span>|</span><br><span class="line">|<span class="string"> ucs2     </span>|<span class="string"> UCS-2 Unicode               </span>|<span class="string"> ucs2_general_ci     </span>|<span class="string">      2 </span>|</span><br><span class="line">|<span class="string"> cp866    </span>|<span class="string"> DOS Russian                 </span>|<span class="string"> cp866_general_ci    </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> keybcs2  </span>|<span class="string"> DOS Kamenicky Czech-Slovak  </span>|<span class="string"> keybcs2_general_ci  </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> macce    </span>|<span class="string"> Mac Central European        </span>|<span class="string"> macce_general_ci    </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> macroman </span>|<span class="string"> Mac West European           </span>|<span class="string"> macroman_general_ci </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> cp852    </span>|<span class="string"> DOS Central European        </span>|<span class="string"> cp852_general_ci    </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> latin7   </span>|<span class="string"> ISO 8859-13 Baltic          </span>|<span class="string"> latin7_general_ci   </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> utf8mb4  </span>|<span class="string"> UTF-8 Unicode               </span>|<span class="string"> utf8mb4_general_ci  </span>|<span class="string">      4 </span>|</span><br><span class="line">|<span class="string"> cp1251   </span>|<span class="string"> Windows Cyrillic            </span>|<span class="string"> cp1251_general_ci   </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> utf16    </span>|<span class="string"> UTF-16 Unicode              </span>|<span class="string"> utf16_general_ci    </span>|<span class="string">      4 </span>|</span><br><span class="line">|<span class="string"> cp1256   </span>|<span class="string"> Windows Arabic              </span>|<span class="string"> cp1256_general_ci   </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> cp1257   </span>|<span class="string"> Windows Baltic              </span>|<span class="string"> cp1257_general_ci   </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> utf32    </span>|<span class="string"> UTF-32 Unicode              </span>|<span class="string"> utf32_general_ci    </span>|<span class="string">      4 </span>|</span><br><span class="line">|<span class="string"> binary   </span>|<span class="string"> Binary pseudo charset       </span>|<span class="string"> binary              </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> geostd8  </span>|<span class="string"> GEOSTD8 Georgian            </span>|<span class="string"> geostd8_general_ci  </span>|<span class="string">      1 </span>|</span><br><span class="line">|<span class="string"> cp932    </span>|<span class="string"> SJIS for Windows Japanese   </span>|<span class="string"> cp932_japanese_ci   </span>|<span class="string">      2 </span>|</span><br><span class="line">|<span class="string"> eucjpms  </span>|<span class="string"> UJIS for Windows Japanese   </span>|<span class="string"> eucjpms_japanese_ci </span>|<span class="string">      3 </span>|</span><br><span class="line">+----------+-----------------------------+---------------------+--------+</span><br><span class="line">39 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="3-查看库的字符集"><a href="#3-查看库的字符集" class="headerlink" title="3.查看库的字符集"></a>3.查看库的字符集</h3><p>语法：show database status from 库名 like  表名;</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show create database shiyan\G</span><br><span class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 1. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line"><span class="code">       Database: shiyan</span></span><br><span class="line">Create Database: CREATE DATABASE <span class="code">`shiyan`</span> /<span class="emphasis">*!40100 DEFAULT CHARACTER SET gbk *</span>/</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="4-查看表的字符集"><a href="#4-查看表的字符集" class="headerlink" title="4.查看表的字符集"></a>4.查看表的字符集</h3><p>语法：show table status from 库名 like  表名;</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show <span class="keyword">table</span> status <span class="comment">from class_7 like</span> <span class="comment">'test_info'</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show table status from class_7 like 'test_info';</span><br><span class="line">+<span class="params">-----------</span>+<span class="params">--------</span>+<span class="params">---------</span>+<span class="params">------------</span>+<span class="params">------</span>+<span class="params">----------------</span>+<span class="params">-------------------------</span>+<span class="params">-------------</span>+<span class="params">------------</span>+<span class="params">-----------------</span>+<span class="params">----------</span>+-</span><br><span class="line">| Name      | Engine | Version | Row_format | Rows | Avg_row_length | Data_leate_time         | Update_time | Check_time | Collation       | Checksum |</span><br><span class="line">+<span class="params">-----------</span>+<span class="params">--------</span>+<span class="params">---------</span>+<span class="params">------------</span>+<span class="params">------</span>+<span class="params">----------------</span>+<span class="params">-------------------------</span>+<span class="params">-------------</span>+<span class="params">------------</span>+<span class="params">-----------------</span>+<span class="params">----------</span>+-</span><br><span class="line">| test_info | InnoDB |      10 | Compact    |   10 |           1638 |       17-12-05 19<span class="function">:01</span><span class="function">:55</span> | NULL        | NULL       | utf8_general_ci |     NULL |</span><br><span class="line">+<span class="params">-----------</span>+<span class="params">--------</span>+<span class="params">---------</span>+<span class="params">------------</span>+<span class="params">------</span>+<span class="params">----------------</span>+<span class="params">-------------------------</span>+<span class="params">-------------</span>+<span class="params">------------</span>+<span class="params">-----------------</span>+<span class="params">----------</span>+-</span><br><span class="line">1 row in <span class="keyword">set</span> <span class="params">(0.00 sec)</span></span><br></pre></td></tr></table></figure>
<h3 id="5-查看表中所有列的字符集"><a href="#5-查看表中所有列的字符集" class="headerlink" title="5.查看表中所有列的字符集"></a>5.查看表中所有列的字符集</h3><p>语法：show full columns from 表名;</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">show</span> full <span class="built_in">columns</span> from test_info;</span><br></pre></td></tr></table></figure>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show full columns from test_info;</span><br><span class="line">+-------+----------+-----------------+------+-----+---------+-------+---------------------------------+---------+</span><br><span class="line">|<span class="string"> Field </span>|<span class="string"> Type     </span>|<span class="string"> Collation       </span>|<span class="string"> Null </span>|<span class="string"> Key </span>|<span class="string"> Default </span>|<span class="string"> Extra </span>|<span class="string"> Privileges                      </span>|<span class="string"> Comment </span>|</span><br><span class="line">+-------+----------+-----------------+------+-----+---------+-------+---------------------------------+---------+</span><br><span class="line">|<span class="string"> id    </span>|<span class="string"> int(3)   </span>|<span class="string"> NULL            </span>|<span class="string"> NO   </span>|<span class="string"> PRI </span>|<span class="string"> NULL    </span>|<span class="string">       </span>|<span class="string"> select,insert,update,references </span>|<span class="string">         </span>|</span><br><span class="line">|<span class="string"> name  </span>|<span class="string"> char(12) </span>|<span class="string"> utf8_general_ci </span>|<span class="string"> YES  </span>|<span class="string">     </span>|<span class="string"> NULL    </span>|<span class="string">       </span>|<span class="string"> select,insert,update,references </span>|<span class="string">         </span>|</span><br><span class="line">|<span class="string"> dorm  </span>|<span class="string"> char(10) </span>|<span class="string"> utf8_general_ci </span>|<span class="string"> YES  </span>|<span class="string">     </span>|<span class="string"> NULL    </span>|<span class="string">       </span>|<span class="string"> select,insert,update,references </span>|<span class="string">         </span>|</span><br><span class="line">|<span class="string"> addr  </span>|<span class="string"> char(12) </span>|<span class="string"> utf8_general_ci </span>|<span class="string"> YES  </span>|<span class="string">     </span>|<span class="string"> 未知    </span>|<span class="string">       </span>|<span class="string"> select,insert,update,references </span>|<span class="string">         </span>|</span><br><span class="line">|<span class="string"> score </span>|<span class="string"> int(3)   </span>|<span class="string"> NULL            </span>|<span class="string"> YES  </span>|<span class="string">     </span>|<span class="string"> NULL    </span>|<span class="string">       </span>|<span class="string"> select,insert,update,references </span>|<span class="string">         </span>|</span><br><span class="line">+-------+----------+-----------------+------+-----+---------+-------+---------------------------------+---------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h2 id="二、设置字符集"><a href="#二、设置字符集" class="headerlink" title="二、设置字符集"></a><strong>二、设置字符集</strong></h2><p>设置字符集一般有两种方法，一种是在创建表的时候设置字符集，另一种是表建成之后修改字符集。</p>
<h3 id="1-创建时指定字符集"><a href="#1-创建时指定字符集" class="headerlink" title="1.创建时指定字符集"></a>1.创建时指定字符集</h3><p>创建库的时候指定字符集：</p>
<p>语法：create database 库名 default character set=字符集；</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database db2<span class="built_in"> default </span>character <span class="attribute">set</span>=utf8</span><br></pre></td></tr></table></figure>
<p>创建表的时候指定字符集：</p>
<p>语法：create table 表名（属性）default character set = 字符集；</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="function">create table <span class="title">test1</span>(<span class="params">id <span class="keyword">int</span>(<span class="number">6</span></span>),name <span class="title">char</span>(<span class="params"><span class="number">10</span></span>)) <span class="keyword">default</span> character <span class="keyword">set</span> </span>= <span class="string">'gbk'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="function">rows <span class="title">affected</span> (<span class="params"><span class="number">0.39</span> sec</span>)</span></span><br></pre></td></tr></table></figure>
<h3 id="2-修改字符集"><a href="#2-修改字符集" class="headerlink" title="2.修改字符集"></a>2.修改字符集</h3><h4 id="修改全局字符集"><a href="#修改全局字符集" class="headerlink" title="修改全局字符集"></a>修改全局字符集</h4><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*建立连接使用的编码*/</span></span><br><span class="line"><span class="keyword">set</span> character_set_connection=utf8;</span><br><span class="line"><span class="comment">/*数据库的编码*/</span></span><br><span class="line"><span class="keyword">set</span> character_set_database=utf8;</span><br><span class="line"><span class="comment">/*结果集的编码*/</span></span><br><span class="line"><span class="keyword">set</span> character_set_results=utf8;</span><br><span class="line"><span class="comment">/*数据库服务器的编码*/</span></span><br><span class="line"><span class="keyword">set</span> character_set_server=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> character_set_system=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> collation_connection=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> collation_database=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> collation_server=utf8;</span><br><span class="line"></span><br><span class="line">修改全局字符集</span><br></pre></td></tr></table></figure>
<h4 id="修改库的字符集"><a href="#修改库的字符集" class="headerlink" title="修改库的字符集"></a>修改库的字符集</h4><p>语法：alter database 库名 default character set 字符集;</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter database shiyan<span class="built_in"> default </span>character <span class="builtin-name">set</span> gbk;</span><br></pre></td></tr></table></figure>
<h4 id="修改表的字符集"><a href="#修改表的字符集" class="headerlink" title="修改表的字符集"></a>修改表的字符集</h4><p>语法：alter table 表名 convert to character set 字符集;</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> test1 <span class="keyword">convert</span> <span class="keyword">to</span> <span class="built_in">character</span> <span class="keyword">set</span> utf8;</span><br></pre></td></tr></table></figure>
<h4 id="修改字段的字符集"><a href="#修改字段的字符集" class="headerlink" title="修改字段的字符集"></a>修改字段的字符集</h4><p>语法：alter table 表名 modify 字段名 字段属性 character set gbk；</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> test1 <span class="keyword">modify</span> <span class="keyword">name</span> <span class="built_in">char</span>(<span class="number">10</span>) <span class="built_in">character</span> <span class="keyword">set</span> gbk;</span><br></pre></td></tr></table></figure>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show full columns <span class="keyword">from</span> test1;</span><br><span class="line">+-------+----------+-----------------+------+-----+---------+-------+---------------------------------+---------+</span><br><span class="line">| Field |<span class="built_in"> Type </span>    | Collation       | <span class="literal">Null</span> | Key |<span class="built_in"> Default </span>| Extra | Privileges                      | Comment |</span><br><span class="line">+-------+----------+-----------------+------+-----+---------+-------+---------------------------------+---------+</span><br><span class="line">| id    | int(6)   | <span class="literal">NULL</span>            | <span class="literal">YES</span>  |     | <span class="literal">NULL</span>    |       | select,insert,update,references |         |</span><br><span class="line">| name  | char(10) | utf8_general_ci | <span class="literal">YES</span>  |     | <span class="literal">NULL</span>    |       | select,insert,update,references |         |</span><br><span class="line">+-------+----------+-----------------+------+-----+---------+-------+---------------------------------+---------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="builtin-name">set</span> (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; alter table test1 modify name char(10) character <span class="builtin-name">set</span> gbk;</span><br><span class="line">Query OK, 0 rows affected (0.58 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; show full columns <span class="keyword">from</span> test1;</span><br><span class="line">+-------+----------+----------------+------+-----+---------+-------+---------------------------------+---------+</span><br><span class="line">| Field |<span class="built_in"> Type </span>    | Collation      | <span class="literal">Null</span> | Key |<span class="built_in"> Default </span>| Extra | Privileges                      | Comment |</span><br><span class="line">+-------+----------+----------------+------+-----+---------+-------+---------------------------------+---------+</span><br><span class="line">| id    | int(6)   | <span class="literal">NULL</span>           | <span class="literal">YES</span>  |     | <span class="literal">NULL</span>    |       | select,insert,update,references |         |</span><br><span class="line">| name  | char(10) | gbk_chinese_ci | <span class="literal">YES</span>  |     | <span class="literal">NULL</span>    |       | select,insert,update,references |         |</span><br><span class="line">+-------+----------+----------------+------+-----+---------+-------+---------------------------------+---------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="builtin-name">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure>
<p><strong>character set即字符集</strong></p>
<p>我们常看到的UTF-8、GB2312、GB18030都是相互独立的character set。即对Unicode的一套编码。</p>
<p><strong>collation即比对方法</strong></p>
<p>用于指定数据集如何排序，以及字符串的比对规则。</p>
<p>collation名字的规则可以归纳为这两类：</p>
<ul>
<li><character set=""><em><language other=""></language></em><ci cs=""></ci></character></li>
<li><character set="">_bin</character></li>
</ul>
<p>例如：</p>
<p>utf8_danish_ci</p>
<p>ci是case insensitive的缩写，cs是case sensitive的缩写。即，指定大小写是否敏感。</p>
<p>utf8_bin是将字符串中的每一个字符用二进制数据存储，区分大小写。</p>
<p>奇怪的是utf8字符集对应的collation居然没有一个是cs的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/11/09/浅谈springMVC中的设计模式——组合模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/09/浅谈springMVC中的设计模式——组合模式/" itemprop="url">浅谈springMVC中的设计模式——组合模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-09T22:31:35+08:00">
                2018-11-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index">
                    <span itemprop="name">Spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/09/浅谈springMVC中的设计模式——组合模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/09/浅谈springMVC中的设计模式——组合模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  297
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>惯例我们先来看一看组合模式的定义：组合模式，将对象组合成树形结构以表示“部分-整体”的层次结构，组合模式使得用户对单个对象和组合对象的使用具有一致性。通俗的来说，就是讲一系列的对象组合在一个整体的对象中，用户在对这个组合对象操作使用时就能跟操作一个对象一样。</p>
<h2 id="WebMvcConfigurerComposite"><a href="#WebMvcConfigurerComposite" class="headerlink" title="WebMvcConfigurerComposite"></a>WebMvcConfigurerComposite</h2><h3 id="1-component-gt-WebMvcConfigurer抽象接口"><a href="#1-component-gt-WebMvcConfigurer抽象接口" class="headerlink" title="1.  component -&gt; WebMvcConfigurer抽象接口"></a>1.  component -&gt; WebMvcConfigurer抽象接口</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> interface </span>WebMvcConfigurer &#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line"><span class="built_in">	default </span>void addInterceptors(InterceptorRegistry registry) &#123;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-leaf-具体实现-gt-自定义实现"><a href="#2-leaf-具体实现-gt-自定义实现" class="headerlink" title="2. leaf 具体实现 -&gt; 自定义实现"></a>2. leaf 具体实现 -&gt; 自定义实现</h2><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> <span class="function">WebMvcConfigurer <span class="title">webMvcConfigurer</span><span class="params">()</span></span>&#123;</span><br><span class="line">    WebMvcConfigurer configurer = <span class="keyword">new</span> WebMvcConfigurer() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">            registry.addInterceptor(<span class="keyword">new</span> HandlerInterceptor() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object <span class="keyword">handler</span>)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    System.out.println(<span class="string">"handler执行前"</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> configurer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-composite容器-gt-WebMvcConfigurerComposite"><a href="#3-composite容器-gt-WebMvcConfigurerComposite" class="headerlink" title="3. composite容器 -&gt; WebMvcConfigurerComposite"></a>3. composite容器 -&gt; WebMvcConfigurerComposite</h3><p><code>@EnableWebMvc</code></p>
<p>​    <code>@Import(DelegatingWebMvcConfiguration.class)</code></p>
<p>​        <code>WebMvcConfigurerComposite</code></p>
<p>本身也实现component <code>WebMvcConfigurer</code>接口，并存在<code>List&lt;WebMvcConfigurer&gt; delegates</code>，对所有的leaf进行统一配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfigurerComposite</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;WebMvcConfigurer&gt; delegates = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addWebMvcConfigurers</span><span class="params">(List&lt;WebMvcConfigurer&gt; configurers)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!CollectionUtils.isEmpty(configurers)) &#123;</span><br><span class="line">			<span class="keyword">this</span>.delegates.addAll(configurers);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configurePathMatch</span><span class="params">(PathMatchConfigurer configurer)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (WebMvcConfigurer delegate : <span class="keyword">this</span>.delegates) &#123;</span><br><span class="line">			delegate.configurePathMatch(configurer);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/10/16/如何保证微服务接口的幂等性/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/16/如何保证微服务接口的幂等性/" itemprop="url">如何保证微服务接口的幂等性</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-16T10:05:05+08:00">
                2018-10-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/微服务/" itemprop="url" rel="index">
                    <span itemprop="name">微服务</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/16/如何保证微服务接口的幂等性/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/10/16/如何保证微服务接口的幂等性/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.3k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在微服务架构下，我们在完成一个订单流程时经常遇到下面的场景：</p>
<blockquote>
<ol>
<li>一个订单创建接口，第一次调用超时了，然后调用方重试了一次</li>
<li>在订单创建时，我们需要去扣减库存，这时接口发生了超时，调用方重试了一次</li>
<li>当这笔订单开始支付，在支付请求发出之后，在服务端发生了扣钱操作，接口响应超时了，调用方重试了一次</li>
<li>一个订单状态更新接口，调用方连续发送了两个消息，一个是已创建，一个是已付款。但是你先接收到已付款，然后又接收到了已创建</li>
<li>在支付完成订单之后，需要发送一条短信，当一台机器接收到短信发送的消息之后，处理较慢。消息中间件又把消息投递给另外一台机器处理</li>
</ol>
</blockquote>
<p>以上问题，就是在单体架构转成微服务架构之后，带来的问题。当然不是说单体架构下没有这些问题，在单体架构下同样要避免重复请求。但是出现的问题要比这少得多。</p>
<p>为了解决以上问题，就需要保证接口的幂等性，接口的幂等性实际上就是接口可重复调用，在调用方多次调用的情况下，接口最终得到的结果是一致的。有些接口可以天然的实现幂等性，比如查询接口，对于查询来说，你查询一次和两次，对于系统来说，没有任何影响，查出的结果也是一样。</p>
<p>除了查询功能具有天然的幂等性之外，增加、更新、删除都要保证幂等性。那么如何来保证幂等性呢？</p>
<h3 id="全局唯一ID"><a href="#全局唯一ID" class="headerlink" title="全局唯一ID"></a>全局唯一ID</h3><p>如果使用全局唯一ID，就是根据业务的操作和内容生成一个全局ID，在执行操作前先根据这个全局唯一ID是否存在，来判断这个操作是否已经执行。如果不存在则把全局ID，存储到存储系统中，比如数据库、redis等。如果存在则表示该方法已经执行。</p>
<p>从工程的角度来说，使用全局ID做幂等可以作为一个业务的基础的微服务存在，在很多的微服务中都会用到这样的服务，在每个微服务中都完成这样的功能，会存在工作量重复。另外打造一个高可靠的幂等服务还需要考虑很多问题，比如一台机器虽然把全局ID先写入了存储，但是在写入之后挂了，这就需要引入全局ID的超时机制。</p>
<p>使用全局唯一ID是一个通用方案，可以支持插入、更新、删除业务操作。但是这个方案看起来很美但是实现起来比较麻烦，下面的方案适用于特定的场景，但是实现起来比较简单。</p>
<h3 id="去重表"><a href="#去重表" class="headerlink" title="去重表"></a>去重表</h3><p>这种方法适用于在业务中有唯一标的插入场景中，比如在以上的支付场景中，如果一个订单只会支付一次，所以订单ID可以作为唯一标识。这时，我们就可以建一张去重表，并且把唯一标识作为唯一索引，在我们实现时，把创建支付单据和写入去去重表，放在一个事务中，如果重复创建，数据库会抛出唯一约束异常，操作就会回滚。</p>
<p>插入或更新<br>这种方法插入并且有唯一索引的情况，比如我们要关联商品品类，其中商品的ID和品类的ID可以构成唯一索引，并且在数据表中也增加了唯一索引。这时就可以使用InsertOrUpdate操作。在mysql数据库中如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> goods_category (goods_id,category_id,create_time,update_time)</span><br><span class="line">       <span class="keyword">values</span>(#&#123;goodsId&#125;,#&#123;categoryId&#125;,<span class="keyword">now</span>(),<span class="keyword">now</span>())</span><br><span class="line">       <span class="keyword">on</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span></span><br><span class="line">       update_time=<span class="keyword">now</span>()</span><br></pre></td></tr></table></figure>
<h3 id="多版本控制"><a href="#多版本控制" class="headerlink" title="多版本控制"></a>多版本控制</h3><p>这种方法适合在更新的场景中，比如我们要更新商品的名字，这时我们就可以在更新的接口中增加一个版本号，来做幂等</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> updateGoodsName(<span class="keyword">int</span> id,<span class="keyword">String</span> newName,<span class="keyword">int</span> version);</span><br></pre></td></tr></table></figure>
<p>在实现时可以如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> goods <span class="keyword">set</span> <span class="keyword">name</span>=#&#123;newName&#125;,<span class="keyword">version</span>=#&#123;<span class="keyword">version</span>&#125; <span class="keyword">where</span> <span class="keyword">id</span>=#&#123;<span class="keyword">id</span>&#125; <span class="keyword">and</span> <span class="keyword">version</span>&lt;$&#123;<span class="keyword">version</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="状态机控制"><a href="#状态机控制" class="headerlink" title="状态机控制"></a>状态机控制</h3><p>这种方法适合在有状态机流转的情况下，比如就会订单的创建和付款，订单的付款肯定是在之前，这时我们可以通过在设计状态字段时，使用int类型，并且通过值类型的大小来做幂等，比如订单的创建为0，付款成功为100。付款失败为99</p>
<p>在做状态机更新时，我们就这可以这样控制</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> <span class="keyword">order</span> <span class="keyword">set</span> <span class="keyword">status</span>=#&#123;<span class="keyword">status</span>&#125; <span class="keyword">where</span> <span class="keyword">id</span>=#&#123;<span class="keyword">id</span>&#125; <span class="keyword">and</span> <span class="keyword">status</span>&lt;#&#123;<span class="keyword">status</span>&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/10/15/2PC到3PC到Paxos到Raft到ISR/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/15/2PC到3PC到Paxos到Raft到ISR/" itemprop="url">2PC到3PC到Paxos到Raft到ISR</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-15T21:04:21+08:00">
                2018-10-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式/" itemprop="url" rel="index">
                    <span itemprop="name">分布式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/15/2PC到3PC到Paxos到Raft到ISR/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/10/15/2PC到3PC到Paxos到Raft到ISR/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  17
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>分布式理论系列</p>
</blockquote>
<ul>
<li><a href="https://segmentfault.com/a/1190000004468442" target="_blank" rel="external">从ACID到CAP到BASE</a></li>
<li><a href="https://segmentfault.com/a/1190000004474543" target="_blank" rel="external">2PC到3PC到Paxos到Raft到ISR</a></li>
<li><a href="https://segmentfault.com/a/1190000004485355" target="_blank" rel="external">复制、分片和路由</a></li>
<li><a href="https://segmentfault.com/a/1190000004480546" target="_blank" rel="external">副本更新策略</a></li>
<li><a href="https://segmentfault.com/a/1190000004492447" target="_blank" rel="external">负载均衡算法及手段</a></li>
<li><a href="https://segmentfault.com/a/1190000004499551" target="_blank" rel="external">RWN及Quorum与强一致性</a></li>
</ul>
<h2 id="序"><a href="#序" class="headerlink" title="序"></a>序</h2><p>本文主要讲述2PC及3PC，以及Paxos以及Raft协议。</p>
<h2 id="两类一致性-操作原子性与副本一致性"><a href="#两类一致性-操作原子性与副本一致性" class="headerlink" title="两类一致性(操作原子性与副本一致性)"></a>两类一致性(<code>操作原子性与副本一致性</code>)</h2><ul>
<li>2PC协议用于保证属于多个数据分片上的操作的原子性。这些数据分片可能分布在不同的服务器上，2PC协议保证多台服务器上的操作要么全部成功，要么全部失败。</li>
<li>Paxos协议用于保证同一个数据分片的多个副本之间的数据一致性。当这些副本分布到不同的数据中心时，这个需求尤其强烈。</li>
</ul>
<h2 id="一、2PC（阻塞、数据不一致问题、单点问题）"><a href="#一、2PC（阻塞、数据不一致问题、单点问题）" class="headerlink" title="一、2PC（阻塞、数据不一致问题、单点问题）"></a>一、2PC（阻塞、数据不一致问题、单点问题）</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Two-Phase <span class="keyword">Commit</span>，两阶段提交</span><br></pre></td></tr></table></figure>
<h3 id="1、阶段一：提交事务请求（投票阶段）"><a href="#1、阶段一：提交事务请求（投票阶段）" class="headerlink" title="1、阶段一：提交事务请求（投票阶段）"></a>1、阶段一：提交事务请求（投票阶段）</h3><p>（1）事务询问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">协调者向所有的参与者发送事务内容，询问是否可以执行事务提交操作，并开始等待各参与者的响应</span><br></pre></td></tr></table></figure>
<p>（2）执行事务</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">各参与者节点执行事务操作，并将<span class="keyword">Undo</span>和Redo信息计入事务日志中</span><br></pre></td></tr></table></figure>
<p>（3）各参与者向协调者反馈事务询问的响应</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果参与者成功执行了事务操作，那么就反馈给协调者<span class="keyword">Yes</span>响应，表示事务可以执行；如果参与者没有成功执行事务，那么就反馈给协调者<span class="keyword">No</span>响应，表示事务不可以执行。</span><br></pre></td></tr></table></figure>
<h3 id="2、阶段二：执行事务提交（执行阶段）"><a href="#2、阶段二：执行事务提交（执行阶段）" class="headerlink" title="2、阶段二：执行事务提交（执行阶段）"></a>2、阶段二：执行事务提交（执行阶段）</h3><h4 id="（1）执行事务提交"><a href="#（1）执行事务提交" class="headerlink" title="（1）执行事务提交"></a>（1）执行事务提交</h4><p><img src="http://oz3qait0p.bkt.clouddn.com/2pc%20-1.png" alt="clipboard.png"></p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果所有参与者的反馈都是<span class="keyword">Yes</span>响应，那么</span><br></pre></td></tr></table></figure>
<ul>
<li><p>A、发送提交请求</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">协调者向所有参与者节点发出<span class="keyword">Commit</span>请求</span><br></pre></td></tr></table></figure>
</li>
<li><p>B、事务提交</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参与者接收到<span class="keyword">Commit</span>请求后，会正式执行事务提交操作，并在完成提交之后释放在整个事务执行期间占用的事务资源</span><br></pre></td></tr></table></figure>
</li>
<li><p>C、反馈事务提交结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参与者在完成事务提交之后，向协调者发送ACK信息</span><br></pre></td></tr></table></figure>
</li>
<li><p>D、完成事务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">协调者接收到所有参与者反馈的ACK消息后，完成事务</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="（2）中断事务"><a href="#（2）中断事务" class="headerlink" title="（2）中断事务"></a>（2）中断事务</h4><p><img src="http://oz3qait0p.bkt.clouddn.com/2pc-2.png" alt="clipboard.png"></p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">任何一个参与者反馈了<span class="keyword">No</span>响应，或者在等待超时之后，协调者尚无法接收到所有参与者的反馈响应，那么就会中断事务。</span><br></pre></td></tr></table></figure>
<ul>
<li><p>A、发送回滚请求</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">协调者向所有参与者节点发出<span class="keyword">Rollback</span>请求</span><br></pre></td></tr></table></figure>
</li>
<li><p>B、事务回滚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参与者接收到<span class="keyword">rollback</span>请求后，会利用其在阶段一中记录的<span class="keyword">Undo</span>信息来执行事务回滚操作，并在完成回滚之后释放整个事务执行期间占用的资源</span><br></pre></td></tr></table></figure>
</li>
<li><p>C、反馈事务回滚结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参与者在完成事务回滚之后，向协调者发送ACK信息</span><br></pre></td></tr></table></figure>
</li>
<li><p>D、中断事务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">协调者接收到所有参与者反馈的ACK信息后，完成事务中断</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h4><p>优点：原理简单、实现方便<br>缺点：同步阻塞、单点问题、数据不一致、太过保守</p>
<ul>
<li>（1）同步阻塞<br>同步阻塞会极大地限制分布式系统的性能。在二阶段提交的执行过程中，所有参与该事务操作的逻辑都处于阻塞状态，各个参与者在等待其他参与者响应的过程中，将无法进行其他任何操作。</li>
<li>（2）单点问题<br>一旦协调者出现问题，那么整个二阶段提交流程将无法运转，更为严重的是，如果是在阶段二中出现问题，那么其他参与者将会一直处于锁定事务资源的状态中，无法继续完成事务操作。</li>
<li>（3）数据不一致<br>在阶段二，当协调者向所有参与者发送commit请求之后，发生了局部网络异常或协调者在尚未发完commit请求之前自身发生了崩溃，导致最终只有部分参与者接收到了commit请求，于是这部分参与者执行事务提交，而没收到commit请求的参与者则无法进行事务提交，于是整个分布式系统出现了数据不一致性现象。</li>
<li>（4）太过保守<br>如果参与者在与协调者通信期间出现故障，协调者只能靠超时机制来判断是否需要中断事务，这个策略比较保守，需要更为完善的容错机制，任意一个节点的失败都会导致整个事务的失败。</li>
</ul>
<h2 id="二、3PC（解决2PC的阻塞，但还是可能造成数据不一致）"><a href="#二、3PC（解决2PC的阻塞，但还是可能造成数据不一致）" class="headerlink" title="二、3PC（解决2PC的阻塞，但还是可能造成数据不一致）"></a>二、3PC（解决2PC的阻塞，但还是可能造成数据不一致）</h2><p>Three-Phase Commit，三阶段提交，分为CanCommit、PreCommit、do Commit三个阶段。<br><img src="http://oz3qait0p.bkt.clouddn.com/3pc%20-1.png" alt="clipboard.png"></p>
<p>为了避免在通知所有参与者提交事务时，其中一个参与者crash不一致时，就出现了三阶段提交的方式。三阶段提交在两阶段提交的基础上增加了一个preCommit的过程，当所有参与者收到preCommit后，并不执行动作，直到收到commit或超过一定时间后才完成操作。</p>
<h3 id="1、阶段一CanCommit"><a href="#1、阶段一CanCommit" class="headerlink" title="1、阶段一CanCommit"></a>1、阶段一CanCommit</h3><ul>
<li>（1）事务询问<br>协调者向各参与者发送CanCommit的请求，询问是否可以执行事务提交操作，并开始等待各参与者的响应</li>
<li>（2）参与者向协调者反馈询问的响应<br>参与者收到CanCommit请求后，正常情况下，如果自身认为可以顺利执行事务，那么会反馈Yes响应，并进入预备状态，否则反馈No。</li>
</ul>
<h3 id="2、阶段二PreCommit"><a href="#2、阶段二PreCommit" class="headerlink" title="2、阶段二PreCommit"></a>2、阶段二PreCommit</h3><h4 id="（1）执行事务预提交"><a href="#（1）执行事务预提交" class="headerlink" title="（1）执行事务预提交"></a>（1）执行事务预提交</h4><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果协调者接收到各参与者反馈都是<span class="keyword">Yes</span>，那么执行事务预提交</span><br></pre></td></tr></table></figure>
<ul>
<li>A、发送预提交请求<br>协调者向各参与者发送preCommit请求，并进入prepared阶段</li>
<li>B、事务预提交<br>参与者接收到preCommit请求后，会执行事务操作，并将Undo和Redo信息记录到事务日记中</li>
<li>C、各参与者向协调者反馈事务执行的响应<br>如果各参与者都成功执行了事务操作，那么反馈给协调者Ack响应，同时等待最终指令，提交commit或者终止abort</li>
</ul>
<h4 id="（2）中断事务-1"><a href="#（2）中断事务-1" class="headerlink" title="（2）中断事务"></a>（2）中断事务</h4><p>如果任何一个参与者向协调者反馈了No响应，或者在等待超时后，协调者无法接收到所有参与者的反馈，那么就会中断事务。</p>
<ul>
<li><p>A、发送中断请求</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">协调者向所有参与者发送<span class="keyword">abort</span>请求</span><br></pre></td></tr></table></figure>
</li>
<li><p>B、中断事务</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">无论是收到来自协调者的<span class="keyword">abort</span>请求，还是等待超时，参与者都中断事务</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="3、阶段三doCommit"><a href="#3、阶段三doCommit" class="headerlink" title="3、阶段三doCommit"></a>3、阶段三doCommit</h3><h4 id="（1）执行提交"><a href="#（1）执行提交" class="headerlink" title="（1）执行提交"></a>（1）执行提交</h4><ul>
<li>A、发送提交请求<br>假设协调者正常工作，接收到了所有参与者的ack响应，那么它将从预提交阶段进入提交状态，并向所有参与者发送doCommit请求</li>
<li>B、事务提交<br>参与者收到doCommit请求后，正式提交事务，并在完成事务提交后释放占用的资源</li>
<li>C、反馈事务提交结果<br>参与者完成事务提交后，向协调者发送ACK信息</li>
<li>D、完成事务<br>协调者接收到所有参与者ack信息，完成事务</li>
</ul>
<h4 id="（2）中断事务-2"><a href="#（2）中断事务-2" class="headerlink" title="（2）中断事务"></a>（2）中断事务</h4><p>假设协调者正常工作，并且有任一参与者反馈No，或者在等待超时后无法接收所有参与者的反馈，都会中断事务</p>
<ul>
<li>A、发送中断请求<br>协调者向所有参与者节点发送abort请求</li>
<li>B、事务回滚<br>参与者接收到abort请求后，利用undo日志执行事务回滚，并在完成事务回滚后释放占用的资源</li>
<li>C、反馈事务回滚结果<br>参与者在完成事务回滚之后，向协调者发送ack信息</li>
<li>D、中断事务<br>协调者接收到所有参与者反馈的ack信息后，中断事务。</li>
</ul>
<p>阶段三可能出现的问题：<br>协调者出现问题、协调者与参与者之间网络出现故障。不论出现哪种情况，最终都会导致参与者无法及时接收到来自协调者的doCommit或是abort请求，针对这种情况，参与者都会在等待超时后，继续进行事务提交（timeout后中断事务）。</p>
<p>优点：降低参与者阻塞范围，并能够在出现单点故障后继续达成一致<br>缺点：引入preCommit阶段，在这个阶段如果出现网络分区，协调者无法与参与者正常通信，参与者依然会进行事务提交，造成数据不一致。</p>
<h2 id="三、Paxos（解决单点问题）"><a href="#三、Paxos（解决单点问题）" class="headerlink" title="三、Paxos（解决单点问题）"></a>三、Paxos（解决单点问题）</h2><p>基于消息传递且具有高度容错性的一致性算法。Paxos算法要解决的问题就是如何在可能发生几起宕机或网络异常的分布式系统中，快速且正确地在集群内部对某个数据的值达成一致，并且保证不论发生以上任何异常，都不会破坏整个系统的一致性。</p>
<p>拜占庭问题：消息不完整或者被篡改。Paxos在维持领导者选举或者变量修改一致性上，采取一种类似议会投票的过半同意机制，比如设定一个领导者，需要将此看做一个议案，征求过半同意，每个节点通过一个议案会有编号记录，再次收到此领导者的不同人选，发现已经有编号记录便驳回，最后以多数通过的结果为准。</p>
<p>我们举个简单的例子，来阐述一下Paxos的基本思想：假设我们有5台计算机A、B、C、D、E，每台计算机保存着公司CEO的信息，现在CEO任期到了，需要进行新一界选举了。</p>
<p>A计算机发起一个选举议案，提议CEO为“张三”，如果没有其他候选人议案，也没有网络问题，只要其中半数以上计算机收到并通过议案，那么最终“张三”当选CEO。由于是分布式环境，并发请求、机器故障、网络故障等问题是常态，如果A和E同时提交选举议案，A提名“张三”，E提名“李四”，那么肯定会涉及多计算机的一致性问题了：假设A、B、C先收到A的议案，D、E先收到E的议案，那么A继续提交给D时，D告诉它已经先收到E的议案了，因此驳回了A的请求。同样E继续提交给A、B、C时也碰到相同的问题。</p>
<p>我们可以通过“在每台计算机同时接受议案提交时设置一个编号，编号先的通过，编号后的驳回”的方式来实现。议案提交上去后，发现A、B、C投票“张三”为CEO，D、E投票“李四”为CEO，少数服从多数，因此最后结果为“张三”当选CEO。</p>
<p><img src="http://oz3qait0p.bkt.clouddn.com/paxos%20-1.png" alt="clipboard.png"></p>
<p>如果是C计算机发生了网络问题或者故障，双方投票相同，那么选举无法完成。</p>
<p>如果C计算机发生了网络问题或者故障，A、B、D投票“张三”，E投票“李四”，那么结果为“张三”当选，而C对于这些情况一无所知，但是当C计算机恢复正常时，他会发起一个“询问谁是CEO”的议案获取最新信息。简言之，Paxos对每个节点的并发修改采取编号记录的方式保持一致性，对多个节点的并发修改采取少数服从多数的方式保持一致性。Paxos有点类似分布式二阶段提交方式，但是又不同，二阶段提交不能是多数节点同意，必须是全部同意。为了遵守过半节点同意的约束，Paxos算法往往要求节点总数为奇数。</p>
<p>Paxos 算法解决的问题是在一个可能发生上述异常的分布式系统中如何就某个值达成一致，保证不论发生以上任何异常，都不会破坏决议的一致性。一个典型的场景是，在一个分布式数据库系统中，如果各节点的初始状态一致，每个节点都执行相同的操作序列，那么他们最后能得到一个一致的状态。为保证每个节点执行相同的命令序列，需要在每一条指令上执行一个「一致性算法」以保证每个节点看到的指令一致。一个通用的一致性算法可以应用在许多场景中，是分布式计算中的重要问题。从20世纪80年代起对于一致性算法的研究就没有停止过。</p>
<p>简单说来，Paxos的目的是让整个集群的结点对某个值的变更达成一致。Paxos算法基本上来说是个民主选举的算法——大多数的决定会成个整个集群的统一决定。任何一个点都可以提出要修改某个数据的提案，是否通过这个提案取决于这个集群中是否有超过半数的结点同意（所以Paxos算法需要集群中的结点是单数）。</p>
<p>这个算法有两个阶段（假设这个有三个结点：A，B，C）：</p>
<h3 id="第一阶段：Prepare阶段"><a href="#第一阶段：Prepare阶段" class="headerlink" title="第一阶段：Prepare阶段"></a>第一阶段：Prepare阶段</h3><p>A把申请修改的请求Prepare Request发给所有的结点A，B，C。注意，Paxos算法会有一个Sequence Number（你可以认为是一个提案号，这个数不断递增，而且是唯一的，也就是说A和B不可能有相同的提案号），这个提案号会和修改请求一同发出，任何结点在“Prepare阶段”时都会拒绝其值小于当前提案号的请求。所以，结点A在向所有结点申请修改请求的时候，需要带一个提案号，越新的提案，这个提案号就越是是最大的。</p>
<p>如果接收结点收到的提案号n大于其它结点发过来的提案号，这个结点会回应Yes（本结点上最新的被批准提案号），并保证不接收其它&lt;n的提案。这样一来，结点上在Prepare阶段里总是会对最新的提案做承诺。</p>
<p>优化：在上述 prepare 过程中，如果任何一个结点发现存在一个更高编号的提案，则需要通知 提案人，提醒其中断这次提案。</p>
<h3 id="第二阶段：Accept阶段"><a href="#第二阶段：Accept阶段" class="headerlink" title="第二阶段：Accept阶段"></a>第二阶段：Accept阶段</h3><p>如果提案者A收到了超过半数的结点返回的Yes，然后他就会向所有的结点发布Accept Request（同样，需要带上提案号n），如果没有超过半数的话，那就返回失败。</p>
<p>当结点们收到了Accept Request后，如果对于接收的结点来说，n是最大的了，那么，它就会通过request（修改这个值），如果发现自己有一个更大的提案号，那么，结点就会拒绝request（拒绝修改）。</p>
<p>我们可以看以，这似乎就是一个“两段提交”的优化。其实，2PC/3PC都是分布式一致性算法的残次版本，Google Chubby的作者Mike Burrows说过这个世界上只有一种一致性算法，那就是Paxos，其它的算法都是残次品。</p>
<p>我们还可以看到：对于同一个值的在不同结点的修改提案就算是在接收方被乱序收到也是没有问题的。</p>
<h2 id="四、Raft协议-解决paxos的实现难度"><a href="#四、Raft协议-解决paxos的实现难度" class="headerlink" title="四、Raft协议(解决paxos的实现难度)"></a>四、Raft协议(<code>解决paxos的实现难度</code>)</h2><p>Paxos 相比 Raft 比较复杂和难以理解。角色扮演和流程比 Raft 都要啰嗦。比如 Agreement 这个流程，在 Paxos 里边：Client 发起请求举荐 Proposer 成为 Leader，Proposer 然后向全局 Acceptors 寻求确认，Acceptors 全部同意 Proposer 后，Proposer 的 Leader 地位得已承认，Acceptors 还得再向Learners 进行全局广播来同步。而在 Raft 里边，只有 Follower/Candidate/Leader 三种角色，角色本身代表状态，角色之间进行状态转移是一件非常自由民主的事情。Raft虽然有角色之分但是是全民参与进行选举的模式；但是在Paxos里边，感觉更像议员参政模式。</p>
<h3 id="三个角色"><a href="#三个角色" class="headerlink" title="三个角色"></a>三个角色</h3><p>follower、candidate、leader。<br>最开始大家都是follower，当follower监听不到leader，就可以自己成为candidate，发起投票</p>
<h3 id="leader选举：timeout限制"><a href="#leader选举：timeout限制" class="headerlink" title="leader选举：timeout限制"></a>leader选举：timeout限制</h3><h4 id="选举的timeout"><a href="#选举的timeout" class="headerlink" title="选举的timeout"></a>选举的timeout</h4><p>follower成为candidate的超时时间，每个follower都在150ms and 300ms之间随机，之后看谁先timeout，谁就先成为candidate，然后它会先投自己一票，再向其他节点发起投票邀请。<br>如果其他节点在这轮选举还没有投过票，那么就给candidate投票，然后重置自己的选举timeout。<br>如果得到大多数的投票就成为leader，之后定期开始向follower发送心跳。</p>
<p>如果两个follower同时成为candidate的话，如果最后得到的票数相同，则等待其他follower的选择timeout之后成为candidate，继续开始新一轮的选举。</p>
<h3 id="log复制"><a href="#log复制" class="headerlink" title="log复制"></a>log复制</h3><p>leader把变动的log借助心跳同步给follower，过半回复之后才成功提交，之后再下一次心跳之后，follower也commit变动，在自己的node上生效。</p>
<p>分裂之后，另一个分区的follower接受不到leader的timeout，然后会有一个先timeout，成为candidate，最后成为leader。<br>于是两个分区就有了两个leader。</p>
<p>当客户端有变动时，其中的leader由于无法收到过半的提交，则保持未提交状态。有的leader的修改，可以得到过半的提交，则可以修改生效。</p>
<p>当分裂恢复之后，leader开始对比选举的term，发现有更高的term存在时，他们会撤销未提交的修改，然后以最新的为准。</p>
<h2 id="五、ISR的机制-解决f容错的2f-1成本问题"><a href="#五、ISR的机制-解决f容错的2f-1成本问题" class="headerlink" title="五、ISR的机制(解决f容错的2f+1成本问题)"></a>五、ISR的机制(<code>解决f容错的2f+1成本问题</code>)</h2><p>Kafka并没有使用Zab或Paxos协议的多数投票机制来保证主备数据的一致性，而是提出了ISR的机制（In-Sync Replicas）的机制来保证数据一致性。</p>
<p>ISR认为对于2f+1个副本来说，多数投票机制要求最多只能允许f个副本发生故障，如果要支持2个副本的容错，则需要至少维持5个副本，对于消息系统的场景来说，效率太低。</p>
<p>ISR的运行机制如下：将所有次级副本数据分到两个集合，其中一个被称为ISR集合，这个集合备份数据的特点是即时和主副本数据保持一致，而另外一个集合的备份数据允许其消息队列落后于主副本的数据。在做主备切换时，只允许从ISR集合中选择主副本，只有ISR集合内所有备份都写成功才能认为这次写入操作成功。在具体实现时，kafka利用zookeeper来保持每个ISR集合的信息，当ISR集合内成员变化时，相关构件也便于通知。通过这种方式，如果设定ISR集合大小为f+1，那么可以最多允许f个副本故障，而对于多数投票机制来说，则需要2f+1个副本才能达到相同的容错性。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://www.jdon.com/artichect/raft.html" target="_blank" rel="external">分布式系统的Raft算法</a></li>
<li><a href="http://thesecretlivesofdata.com/raft/" target="_blank" rel="external">英文动画演示Raft</a>(<code>推荐</code>)</li>
<li><a href="https://angus.nyc/2012/paxos-by-example/" target="_blank" rel="external">paxos-by-example</a></li>
<li><a href="http://chuansong.me/n/1019861" target="_blank" rel="external">为啥CoreOS没用Paxos，重新搞了Raft？</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/10/10/微服务架构下分布式事务解决方式-GTS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/10/微服务架构下分布式事务解决方式-GTS/" itemprop="url">微服务架构下分布式事务解决方式-GTS</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-10T10:31:57+08:00">
                2018-10-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/微服务/" itemprop="url" rel="index">
                    <span itemprop="name">微服务</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/10/微服务架构下分布式事务解决方式-GTS/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/10/10/微服务架构下分布式事务解决方式-GTS/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  15
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-微服务的发展"><a href="#1-微服务的发展" class="headerlink" title="1 微服务的发展"></a>1 微服务的发展</h2><p>微服务倡导将复杂的单体应用拆分为若干个功能简单、松耦合的服务，这样可以降低开发难度、增强扩展性、便于敏捷开发。当前被越来越多的开发者推崇，很多互联网行业巨头、开源社区等都开始了微服务的讨论和实践。Hailo有160个不同服务构成，NetFlix有大约600个服务。国内方面，阿里巴巴、<a href="http://www.sohu.com/a/203351190_468650" target="_blank" rel="external">腾讯</a>、<a href="http://blog.csdn.net/lambert310/article/details/78084859" target="_blank" rel="external">360</a>、京东、58同城等很多互联网公司都进行了微服务化实践。当前微服务的开发框架也非常多，比较著名的有<a href="http://dubbo.io/" target="_blank" rel="external">Dubbo</a>、<a href="https://springcloud.cc/" target="_blank" rel="external">SpringCloud</a>、<a href="http://thrift.apache.org/" target="_blank" rel="external">thrift</a> 、<a href="http://doc.oschina.net/grpc?t=57966" target="_blank" rel="external">grpc</a>等。</p>
<h2 id="2-微服务落地存在的问题"><a href="#2-微服务落地存在的问题" class="headerlink" title="2 微服务落地存在的问题"></a>2 微服务落地存在的问题</h2><p>虽然微服务现在如火如荼，但对其实践其实仍处于探索阶段。很多中小型互联网公司，鉴于经验、技术实力等问题，微服务落地比较困难。如著名架构师Chris Richardson所言，目前存在的主要困难有如下几方面：</p>
<p>1）单体应用拆分为分布式系统后，进程间的通讯机制和故障处理措施变的更加复杂。</p>
<p>2）系统微服务化后，一个看似简单的功能，内部可能需要调用多个服务并操作多个数据库实现，服务调用的分布式事务问题变的非常突出。</p>
<p>3）微服务数量众多，其测试、部署、监控等都变的更加困难。</p>
<p>随着RPC框架的成熟，第一个问题已经逐渐得到解决。例如dubbo可以支持多种通讯协议，springcloud可以非常好的支持restful调用。对于第三个问题，随着docker、devops技术的发展以及各公有云paas平台自动化运维工具的推出，微服务的测试、部署与运维会变得越来越容易。</p>
<p>而对于第二个问题，现在还没有通用方案很好的解决微服务产生的事务问题。分布式事务已经成为微服务落地最大的阻碍，也是最具挑战性的一个<a href="http://tech.huanqiu.com/news/2017-04/10451235.html" target="_blank" rel="external">技术难题</a>。 为此，本文将深入和大家探讨微服务架构下，分布式事务的各种解决方案，并重点为大家解读阿里巴巴提出的分布式事务解决方案—-GTS。<strong>该方案中提到的GTS是全新一代解决微服务问题的分布式事务互联网中间件</strong>。</p>
<h2 id="3-SOA分布式事务解决方案"><a href="#3-SOA分布式事务解决方案" class="headerlink" title="3 SOA分布式事务解决方案"></a>3 SOA分布式事务解决方案</h2><h3 id="3-1-基于XA协议的两阶段提交方案"><a href="#3-1-基于XA协议的两阶段提交方案" class="headerlink" title="3.1 基于XA协议的两阶段提交方案"></a>3.1 基于XA协议的两阶段提交方案</h3><p>交易中间件与数据库通过 XA 接口规范，使用两阶段提交来完成一个全局事务， XA 规范的基础是两阶段提交协议。<br>第一阶段是表决阶段，所有参与者都将本事务能否成功的信息反馈发给协调者；第二阶段是执行阶段，协调者根据所有参与者的反馈，通知所有参与者，步调一致地在所有分支上提交或者回滚。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334519/201803/1334519-20180307150636190-1704712093.png" alt="img"></p>
<p>两阶段提交方案应用非常广泛，几乎所有商业OLTP数据库都支持XA协议。但是两阶段提交方案锁定资源时间长，对性能影响很大，基本不适合解决微服务事务问题。</p>
<h3 id="3-2-TCC方案"><a href="#3-2-TCC方案" class="headerlink" title="3.2 TCC方案"></a>3.2 TCC方案</h3><p><a href="https://wenku.baidu.com/view/be946bec0975f46527d3e104.html" target="_blank" rel="external">TCC方案</a>在电商、金融领域落地较多。TCC方案其实是两阶段提交的一种改进。其将整个业务逻辑的每个分支显式的分成了Try、Confirm、Cancel三个操作。Try部分完成业务的准备工作，confirm部分完成业务的提交，cancel部分完成事务的回滚。基本原理如下图所示。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334519/201803/1334519-20180307150648591-1729601878.png" alt="img"></p>
<p>事务开始时，业务应用会向事务协调器注册启动事务。之后业务应用会调用所有服务的try接口，完成一阶段准备。之后事务协调器会根据try接口返回情况，决定调用confirm接口或者cancel接口。如果接口调用失败，会进行重试。</p>
<p>TCC方案让应用自己定义数据库操作的粒度，使得降低锁冲突、提高吞吐量成为可能。 当然TCC方案也有不足之处，集中表现在以下两个方面：</p>
<ul>
<li><strong>对应用的侵入性强</strong>。业务逻辑的每个分支都需要实现try、confirm、cancel三个操作，应用侵入性较强，改造成本高。</li>
<li><strong>实现难度较大</strong>。需要按照网络状态、系统故障等不同的失败原因实现不同的回滚策略。为了满足一致性的要求，confirm和cancel接口必须实现幂等。</li>
</ul>
<p>上述原因导致TCC方案大多被研发实力较强、有迫切需求的大公司所采用。微服务倡导服务的轻量化、易部署，而TCC方案中很多事务的处理逻辑需要应用自己编码实现，复杂且开发量大。</p>
<h3 id="3-3-基于消息的最终一致性方案"><a href="#3-3-基于消息的最终一致性方案" class="headerlink" title="3.3 基于消息的最终一致性方案"></a>3.3 基于消息的最终一致性方案</h3><p>消息一致性方案是通过消息中间件保证上、下游应用数据操作的<a href="https://segmentfault.com/a/1190000011479826" target="_blank" rel="external">一致性</a>。基本思路是将本地操作和发送消息放在一个事务中，保证本地操作和消息发送要么两者都成功或者都失败。下游应用向消息系统订阅该消息，收到消息后执行相应操作。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334519/201803/1334519-20180307150703434-1501056265.png" alt="img"></p>
<p>消息方案从本质上讲是将分布式事务转换为两个本地事务，然后依靠下游业务的重试机制达到最终一致性。基于消息的最终一致性方案对应用侵入性也很高，应用需要进行大量业务改造，成本较高。</p>
<h2 id="4-GTS–分布式事务解决方案"><a href="#4-GTS–分布式事务解决方案" class="headerlink" title="4 GTS–分布式事务解决方案"></a>4 GTS–分布式事务解决方案</h2><p><a href="https://www.aliyun.com/aliware/txc?spm=5176.8142029.388261.386.a72376f4lqvQxv" target="_blank" rel="external">GTS是一款分布式事务中间件</a>，由阿里巴巴中间件部门研发，可以为微服务架构中的分布式事务提供一站式解决方案。</p>
<p>更多GTS资料请访问<a href="https://weibo.com/jiangyu666" target="_blank" rel="external">创始人微博</a>。</p>
<h3 id="4-1-GTS的核心优势"><a href="#4-1-GTS的核心优势" class="headerlink" title="4.1 GTS的核心优势"></a>4.1 GTS的核心优势</h3><ul>
<li><p><strong>性能超强</strong></p>
<p>GTS通过大量创新，解决了事务ACID特性与高性能、高可用、低侵入不可兼得的问题。单事务分支的平均响应时间在2ms左右，3台服务器组成的集群可以支撑3万TPS以上的分布式事务请求。</p>
</li>
<li><p><strong>应用侵入性极低</strong></p>
<p>GTS对业务低侵入，业务代码最少只需要添加一行注解（@TxcTransaction）声明事务即可。业务与事务分离，将微服务从事务中解放出来，微服务关注于业务本身，不再需要考虑反向接口、幂等、回滚策略等复杂问题，极大降低了微服务开发的难度与工作量。</p>
</li>
<li><p><strong>完整解决方案</strong></p>
<p>GTS支持多种主流的服务框架，包括EDAS，Dubbo，Spring Cloud等。<br>有些情况下，应用需要调用第三方系统的接口，而第三方系统没有接入GTS。此时需要用到GTS的MT模式。GTS的MT模式可以等价于TCC模式，用户可以根据自身业务需求自定义每个事务阶段的具体行为。MT模式提供了更多的灵活性，可能性，以达到特殊场景下的自定义优化及特殊功能的实现。</p>
</li>
<li><p><strong>容错能力强</strong></p>
<p>GTS解决了XA事务协调器单点问题，实现真正的高可用，可以保证各种异常情况下的严格数据一致。</p>
</li>
</ul>
<h3 id="4-2-GTS的应用场景"><a href="#4-2-GTS的应用场景" class="headerlink" title="4.2 GTS的应用场景"></a>4.2 GTS的应用场景</h3><p>GTS可应用在涉及服务调用的多个领域，包括但不限于金融支付、电信、电子商务、快递物流、广告营销、社交、即时通信、手游、视频、物联网、车联网等，详细介绍可以阅读 <a href="https://www.jianshu.com/u/c9668ae2b661" target="_blank" rel="external">《GTS–阿里巴巴分布式事务全新解决方案》</a>一文。</p>
<h3 id="4-3-GTS与微服务的集成"><a href="#4-3-GTS与微服务的集成" class="headerlink" title="4.3 GTS与微服务的集成"></a>4.3 GTS与微服务的集成</h3><p>GTS包括客户端（GTS Client）、资源管理器（GTS RM）和事务协调器（GTS Server）三个部分。GTS Client主要用来界定事务边界，完成事务的发起与结束。GTS RM完成事务分支的创建、提交、回滚等操作。GTS Server主要负责分布式事务的整体推进，事务生命周期的管理。GTS和微服务集成的结构图如下所示，GTS Client需要和业务应用集成部署，RM与微服务集成部署。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334519/201803/1334519-20180307150720354-1188496664.png" alt="img"></p>
<h3 id="4-4-GTS的输出形式"><a href="#4-4-GTS的输出形式" class="headerlink" title="4.4 GTS的输出形式"></a>4.4 GTS的输出形式</h3><p>GTS目前有三种输出形式：公有云输出、公网输出、专有云输出。</p>
<h4 id="4-4-1-公有云输出"><a href="#4-4-1-公有云输出" class="headerlink" title="4.4.1 公有云输出"></a>4.4.1 公有云输出</h4><p>这种输出形式面向阿里云用户。如果用户的业务系统已经部署到阿里云上，可以申请开通公有云GTS。开通后业务应用即可通过GTS保证服务调用的一致性。这种使用场景下，业务系统和GTS间的网络环境比较理想，达到很好性能。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334519/201803/1334519-20180307150813657-193084867.png" alt="img"></p>
<h4 id="4-4-2-公网输出"><a href="#4-4-2-公网输出" class="headerlink" title="4.4.2 公网输出"></a>4.4.2 公网输出</h4><p>这种输出形式面向于非阿里云的用户，使用更加方便、灵活，业务系统只要能连接互联网即可享受GTS提供的云服务（与公有云输出的差别在于客户端部署于用户本地，而不在云上）。</p>
<p>在正常网络环境下，以包含两个本地事务的全局事务为例，事务完成时间在20ms左右，50个并发就可以轻松实现1000TPS以上分布式事务，对绝大多数业务来说性能是足够的。在公网环境，网络闪断很难完全避免，这种情况下GTS仍能保证服务调用的数据一致性。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334519/201803/1334519-20180307150800978-1059620711.png" alt="img"></p>
<p>具体使用样例使用参见4.7节GTS的工程样例。</p>
<h4 id="4-4-3-专有云输出"><a href="#4-4-3-专有云输出" class="headerlink" title="4.4.3 专有云输出"></a>4.4.3 专有云输出</h4><p>这种形式主要面向于已建设了自己专有云平台的大用户，GTS可以直接部署到用户的专有云上，为专有云提供分布式事务服务。目前已经有10多个特大型企业的专有云使用GTS解决分布式事务难题，性能与稳定性经过了用户的严格检测。</p>
<h3 id="4-5-GTS的使用方式"><a href="#4-5-GTS的使用方式" class="headerlink" title="4.5 GTS的使用方式"></a>4.5 <a href="https://help.aliyun.com/document_detail/53298.html?spm=a2c4g.11186623.6.554.NZEXg9" target="_blank" rel="external">GTS的使用方式</a></h3><p>GTS对应用的侵入性非常低，使用也很简单。下面以订单存储应用为例说明。订单业务应用通过调用订单服务和库存服务完成订单业务，服务开发框架为Dubbo。</p>
<h4 id="4-5-1-订单业务应用"><a href="#4-5-1-订单业务应用" class="headerlink" title="4.5.1 订单业务应用"></a>4.5.1 订单业务应用</h4><p>在业务函数外围使用@TxcTransaction注解即可开启分布式事务。Dubbo应用通过隐藏参数将GTS的事务xid传播到服务端。</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> @TxcTransaction(timeout = <span class="number">1000</span> * <span class="number">10</span>)</span><br><span class="line"><span class="keyword">public</span> void Bussiness(OrderService orderService, StockService stockService, <span class="keyword">String</span> userId) &#123;</span><br><span class="line">    <span class="comment">//获取事务上下文</span></span><br><span class="line">    <span class="keyword">String</span> xid = TxcContext.getCurrentXid();</span><br><span class="line">    <span class="comment">//通过RpcContext将xid传到一个服务端</span></span><br><span class="line">    RpcContext.getContext().setAttachment(<span class="string">"xid"</span>, xid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行自己的业务逻辑</span></span><br><span class="line">    int productId = <span class="keyword">new</span> <span class="type">Random</span>().nextInt(<span class="number">100</span>);</span><br><span class="line">    int productNum = <span class="keyword">new</span> <span class="type">Random</span>().nextInt(<span class="number">100</span>);</span><br><span class="line">    OrderDO orderDO = <span class="keyword">new</span> <span class="type">OrderDO</span>(userId, productId, productNum, <span class="keyword">new</span> <span class="type">Timestamp</span>(<span class="keyword">new</span> <span class="type">Date</span>().getTime()));</span><br><span class="line">    orderService.createOrder(orderDO);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过RpcContext将xid传到另一个服务端</span></span><br><span class="line">    RpcContext.getContext().setAttachment(<span class="string">"xid"</span>,xid);</span><br><span class="line">    stockService.updateStock(orderDO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-5-2-服务提供者"><a href="#4-5-2-服务提供者" class="headerlink" title="4.5.2 服务提供者"></a>4.5.2 服务提供者</h4><p>更新库存方法</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> updateStock(OrderDO orderDO) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取全局事务ID，并绑定到上下文</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">String</span> xid = RpcContext.getContext().getAttachment(<span class="string">"xid"</span>);</span><br><span class="line"></span><br><span class="line">TxcContext.bind(xid,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//执行自己的业务逻辑</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> ret = jdbcTemplate.update(<span class="string">"update stock set amount = amount - ? where product_id = ?"</span>,<span class="keyword">new</span> <span class="keyword">Object</span>[]&#123;orderDO.getNumber(), orderDO.getProductId()&#125;);</span><br><span class="line"></span><br><span class="line">TxcContext.unbind();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-6-GTS的应用情况"><a href="#4-6-GTS的应用情况" class="headerlink" title="4.6 GTS的应用情况"></a>4.6 GTS的应用情况</h3><p>GTS目前已经在淘宝、天猫、阿里影业、淘票票、阿里妈妈、1688等阿里各业务系统广泛使用，经受了16年和17年两年双十一海量请求的考验。某线上业务系统最高流量已达十万TPS（每秒钟10万笔事务）。</p>
<p>GTS在公有云和专有云输出后，已经有了100多个线上用户，很多用户通过GTS解决SpringCloud、Dubbo、Edas等服务框架的分布式事务问题。业务领域涉及电力、物流、ETC、烟草、金融、零售、电商、共享出行等十几个行业，得到<a href="https://www.aliyun.com/aliware/hotproducts/gtscase1?open_id=42e50fd2-3b02-4d91-9468-4c785adaaff4-53709576&amp;open_cid=17680" target="_blank" rel="external">用户的一致认可</a>。</p>
<p><img src="https://images2018.cnblogs.com/blog/1334519/201803/1334519-20180307150852411-2089496276.png" alt="img"></p>
<p>上图是GTS与SpringCloud集成，应用于某共享出行系统。业务共享出行场景下，通过GTS支撑物联网系统、订单系统、支付系统、运维系统、分析系统等系各统应用的数据一致性，保证海量订单和数千万流水的交易。</p>
<h3 id="4-7-GTS的工程样例"><a href="#4-7-GTS的工程样例" class="headerlink" title="4.7 GTS的工程样例"></a>4.7 GTS的工程样例</h3><p>GTS的公有云样例可参考阿里云网站。在公网环境下提供<a href="http://txc-console.oss-cn-beijing.aliyuncs.com/sample/sample-txc-simple.zip" target="_blank" rel="external">sample-txc-simple</a>和<a href="http://txc-console.oss-cn-beijing.aliyuncs.com/sample/sample-txc-dubbo.zip" target="_blank" rel="external">sample-txc-dubbo</a>两个样例工程。</p>
<h4 id="4-7-1-sample-txc-simple样例"><a href="#4-7-1-sample-txc-simple样例" class="headerlink" title="4.7.1 sample-txc-simple样例"></a>4.7.1 sample-txc-simple样例</h4><h5 id="4-7-1-1-样例业务逻辑"><a href="#4-7-1-1-样例业务逻辑" class="headerlink" title="4.7.1.1 样例业务逻辑"></a>4.7.1.1 样例业务逻辑</h5><p>该样例是GTS的入门sample，案例的业务逻辑是从A账户转账给B账户，其中A和B分别位于两个MySQL数据库中，使用GTS事务保证A和B账户钱的总数始终不变。</p>
<h5 id="4-7-1-2-样例搭建方法"><a href="#4-7-1-2-样例搭建方法" class="headerlink" title="4.7.1.2 样例搭建方法"></a>4.7.1.2 样例搭建方法</h5><p>1) 准备数据库环境</p>
<p>安装MySQL，创建两个数据库db1和db2。在db1和db2中分别创建<strong>txc_undo_log</strong>表（SQL脚本见4.7.3）。在db1库中创建user_money_a表，在db2库中创建user_money_b表。</p>
<p>2) 下载样例</p>
<p>将sample-txc-simple文件下载到本地，样例中已经包含了GTS的SDK。</p>
<p>3) 修改配置</p>
<p>打开sample-txc-simple/src/main/resources目录下的txc-client-context.xml，将数据源的url、username、password修改为实际值。</p>
<p>4) 运行样例</p>
<p>在sample-txc-simple目录下执行build.sh编译本工程。编译完成后执行run.sh。</p>
<h4 id="4-7-2-sample-txc-dubbo-样例"><a href="#4-7-2-sample-txc-dubbo-样例" class="headerlink" title="4.7.2 sample-txc-dubbo 样例"></a>4.7.2 sample-txc-dubbo 样例</h4><h5 id="4-7-2-1-样例业务逻辑"><a href="#4-7-2-1-样例业务逻辑" class="headerlink" title="4.7.2.1 样例业务逻辑"></a>4.7.2.1 样例业务逻辑</h5><p>本案例模拟了用户下订单、减库存的业务逻辑。客户端（Client）通过调用订单服务（OrderService）创建订单，之后通过调用库存服务（StockService）扣库存。其中订单服务读写订单数据库，库存服务读写库存数据库。由 GTS 保证跨服务事务的一致性。</p>
<h5 id="4-7-2-2-样例搭建方法"><a href="#4-7-2-2-样例搭建方法" class="headerlink" title="4.7.2.2 样例搭建方法"></a>4.7.2.2 样例搭建方法</h5><p>1) 准备数据库环境</p>
<p>安装MySQL，创建两个数据库db1和db2。在db1和db2中分别创建txc_undo_log表。在db1库中创建orders表，在db2库中创建stock表。</p>
<p>2) 下载样例</p>
<p>将样例文件sample-txc-dubbo下载到本地机器，样例中已经包含了GTS的SDK。</p>
<p>3) 修改配置</p>
<p>打开sample-txc-dubbo/src/main/resources目录，将dubbo-order-service.xml、dubbo-stock-service.xml两个文件中数据源的url、username、password修改为实际值。</p>
<p>4) 运行样例</p>
<p>a. 编译程序</p>
<p>在工程根目录执行 build.sh 命令，编译工程。编译后会在 sample-txc-dubbo/client/bin 目录下生成 order_run.sh、stock_run.sh、client_run.sh 三个运行脚本对应订单服务、库存服务以及客户端。</p>
<p>b. 运行程序</p>
<p>在根目录执行run.sh，该脚本会依次启动order_run.sh(订单服务)、stock_run.sh(库存服务)和client_run.sh(客户端程序)。</p>
<h5 id="4-7-2-3-其他说明"><a href="#4-7-2-3-其他说明" class="headerlink" title="4.7.2.3 其他说明"></a>4.7.2.3 其他说明</h5><p>样例使用Multicast注册中心的声明方式。如果本机使用无线网络，dubbo服务在绑定地址时有可能获取ipv6地址，可以通过jvm启动参数禁用。<br>方法是配置jvm启动参数 <strong>-Djava.net.preferIPv4Stack=true</strong>。</p>
<h4 id="4-7-3-SQL"><a href="#4-7-3-SQL" class="headerlink" title="4.7.3 SQL"></a>4.7.3 SQL</h4><h5 id="4-7-3-1-建表-txc-undo-log"><a href="#4-7-3-1-建表-txc-undo-log" class="headerlink" title="4.7.3.1 建表 txc_undo_log"></a>4.7.3.1 建表 txc_undo_log</h5><p>CREATE TABLE <code>txc_undo_log</code> (</p>
<p><code>id</code> bigint(20) NOT NULL AUTO_INCREMENT COMMENT ‘主键’,</p>
<p><code>gmt_create</code> datetime NOT NULL COMMENT ‘创建时间’,</p>
<p><code>gmt_modified</code> datetime NOT NULL COMMENT ‘修改时间’,</p>
<p><code>xid</code> varchar(100) NOT NULL COMMENT ‘全局事务ID’,</p>
<p><code>branch_id</code> bigint(20) NOT NULL COMMENT ‘分支事务ID’,</p>
<p><code>rollback_info</code> longblob NOT NULL COMMENT ‘LOG’,</p>
<p><code>status</code> int(11) NOT NULL COMMENT ‘状态’,</p>
<p><code>server</code> varchar(32) NOT NULL COMMENT ‘分支所在DB IP’,</p>
<p>PRIMARY KEY (<code>id</code>),</p>
<p>KEY <code>unionkey</code> (<code>xid</code>,<code>branch_id</code>)</p>
<p>) ENGINE=InnoDB AUTO_INCREMENT=211225994 DEFAULT CHARSET=utf8 COMMENT=’事务日志表’;</p>
<h5 id="4-7-3-2-建表-user-money-a"><a href="#4-7-3-2-建表-user-money-a" class="headerlink" title="4.7.3.2 建表 user_money_a"></a>4.7.3.2 建表 user_money_a</h5><p>CREATE TABLE <code>user_money_a</code> (</p>
<p><code>id</code> int(11) NOT NULL AUTO_INCREMENT,</p>
<p><code>money</code> int(11) DEFAULT NULL,</p>
<p>PRIMARY KEY (<code>id</code>)</p>
<p>) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;</p>
<h5 id="4-7-3-3-建表-user-money-b"><a href="#4-7-3-3-建表-user-money-b" class="headerlink" title="4.7.3.3 建表 user_money_b"></a>4.7.3.3 建表 user_money_b</h5><p>CREATE TABLE <code>user_money_b</code> (</p>
<p><code>id</code> int(11) NOT NULL AUTO_INCREMENT,</p>
<p><code>money</code> int(11) DEFAULT NULL,</p>
<p>PRIMARY KEY (<code>id</code>)</p>
<p>) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;</p>
<h5 id="4-7-3-4-建表-orders"><a href="#4-7-3-4-建表-orders" class="headerlink" title="4.7.3.4 建表 orders"></a>4.7.3.4 建表 orders</h5><p>CREATE TABLE <code>orders</code> (</p>
<p><code>id</code> bigint(20) NOT NULL AUTO_INCREMENT,</p>
<p><code>user_id</code> varchar(255) NOT NULL,</p>
<p><code>product_id</code> int(11) NOT NULL,</p>
<p><code>number</code> int(11) NOT NULL,</p>
<p><code>gmt_create</code> timestamp NOT NULL,</p>
<p>PRIMARY KEY (<code>id</code>)</p>
<p>) ENGINE=MyISAM AUTO_INCREMENT=351 DEFAULT CHARSET=utf8</p>
<h5 id="4-7-3-5-建表-stock"><a href="#4-7-3-5-建表-stock" class="headerlink" title="4.7.3.5 建表 stock"></a>4.7.3.5 建表 stock</h5><p>CREATE TABLE <code>stock</code> (</p>
<p><code>product_id</code> int(11) NOT NULL,</p>
<p><code>price</code> float NOT NULL,</p>
<p><code>amount</code> int(11) NOT NULL,</p>
<p>PRIMARY KEY (<code>product_id</code>)</p>
<p>) ENGINE=InnoDB DEFAULT CHARSET=utf8</p>
<blockquote>
<p><a href="https://www.cnblogs.com/jiangyu666/p/8522547.html" target="_blank" rel="external">https://www.cnblogs.com/jiangyu666/p/8522547.html</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/09/27/Spring-AutowireCapableBeanFactory-整合-quartz/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/27/Spring-AutowireCapableBeanFactory-整合-quartz/" itemprop="url">Spring AutowireCapableBeanFactory 整合 quartz</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-27T17:29:58+08:00">
                2018-09-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index">
                    <span itemprop="name">Spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/27/Spring-AutowireCapableBeanFactory-整合-quartz/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/27/Spring-AutowireCapableBeanFactory-整合-quartz/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  802
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>最近做spring与quartz整合。业务实现时，需要在job里引入spring的bean，但是job的初始化时quartz在执行时new出来的。不受spring的管理，无法注入相关的依赖bean。多方查阅资料后，发现AutowireCapableBeanFactory可以实现类似功能。下面就通过走读代码的方式来学习下这个类的用法。</p>
<h3 id="进入正题"><a href="#进入正题" class="headerlink" title="进入正题"></a>进入正题</h3><p>首先来看下AutowireCapableBeanFactory的定义：</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> interface AutowireCapableBeanFactory extends BeanFactory &#123;</span><br><span class="line">    &lt;T&gt; T createBean(Class&lt;T&gt; beanClass) <span class="keyword">throws</span> BeansException;</span><br><span class="line">    <span class="keyword">void</span> autowireBean(<span class="keyword">Object</span> existingBean) <span class="keyword">throws</span> BeansException;</span><br><span class="line">    <span class="keyword">Object</span> configureBean(<span class="keyword">Object</span> existingBean, <span class="keyword">String</span> beanName) <span class="keyword">throws</span> BeansException;</span><br><span class="line">    <span class="keyword">Object</span> createBean(Class&lt;?&gt; beanClass, <span class="built_in">int</span> autowireMode, <span class="built_in">boolean</span> dependencyCheck) <span class="keyword">throws</span> BeansException;</span><br><span class="line">    <span class="keyword">Object</span> autowire(Class&lt;?&gt; beanClass, <span class="built_in">int</span> autowireMode, <span class="built_in">boolean</span> dependencyCheck) <span class="keyword">throws</span> BeansException;</span><br><span class="line">    <span class="keyword">void</span> autowireBeanProperties(<span class="keyword">Object</span> existingBean, <span class="built_in">int</span> autowireMode, <span class="built_in">boolean</span> dependencyCheck)</span><br><span class="line">            <span class="keyword">throws</span> BeansException;</span><br><span class="line">    <span class="keyword">void</span> applyBeanPropertyValues(<span class="keyword">Object</span> existingBean, <span class="keyword">String</span> beanName) <span class="keyword">throws</span> BeansException;</span><br><span class="line">    <span class="keyword">Object</span> initializeBean(<span class="keyword">Object</span> existingBean, <span class="keyword">String</span> beanName) <span class="keyword">throws</span> BeansException;</span><br><span class="line">    <span class="keyword">Object</span> applyBeanPostProcessorsBeforeInitialization(<span class="keyword">Object</span> existingBean, <span class="keyword">String</span> beanName)</span><br><span class="line">            <span class="keyword">throws</span> BeansException;</span><br><span class="line">    <span class="keyword">Object</span> applyBeanPostProcessorsAfterInitialization(<span class="keyword">Object</span> existingBean, <span class="keyword">String</span> beanName)</span><br><span class="line">            <span class="keyword">throws</span> BeansException;</span><br><span class="line">    <span class="keyword">void</span> destroyBean(<span class="keyword">Object</span> existingBean);</span><br><span class="line">    &lt;T&gt; NamedBeanHolder&lt;T&gt; resolveNamedBean(Class&lt;T&gt; requiredType) <span class="keyword">throws</span> BeansException;</span><br><span class="line">    <span class="keyword">Object</span> resolveDependency(DependencyDescriptor descriptor, <span class="keyword">String</span> requestingBeanName) <span class="keyword">throws</span> BeansException;</span><br><span class="line">    <span class="keyword">Object</span> resolveDependency(DependencyDescriptor descriptor, <span class="keyword">String</span> requestingBeanName,</span><br><span class="line">            Set&lt;<span class="keyword">String</span>&gt; autowiredBeanNames, TypeConverter typeConverter) <span class="keyword">throws</span> BeansException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该类的注释中有这么一句话<code>Integration code for other frameworks can leverage this interface to wire and populate existing bean instances that Spring does not control the lifecycle of</code>，意思是说该类可以填充那些不受spring容器控制的bean。<br> spring和quartz在集成的时候用了autowireBean方法。下面走读这个方法的代码来看处理逻辑。<br> autowireBean的实现在类AbstractAutowireCapableBeanFactory中。<br> 代码如下</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">public</span> void autowireBean(Object existingBean) &#123;</span><br><span class="line">        // Use non-singleton <span class="keyword">bean </span>definition, to avoid registering <span class="keyword">bean </span>as dependent <span class="keyword">bean.</span></span><br><span class="line"><span class="keyword"> </span>       RootBeanDefinition <span class="keyword">bd </span>= new RootBeanDefinition(ClassUtils.getUserClass(existingBean))<span class="comment">;</span></span><br><span class="line">        <span class="keyword">bd.setScope(BeanDefinition.SCOPE_PROTOTYPE);</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">bd.allowCaching </span>= ClassUtils.isCacheSafe(<span class="keyword">bd.getBeanClass(), </span>getBeanClassLoader())<span class="comment">;</span></span><br><span class="line">        <span class="keyword">BeanWrapper </span><span class="keyword">bw </span>= new <span class="keyword">BeanWrapperImpl(existingBean);</span></span><br><span class="line"><span class="keyword"> </span>       initBeanWrapper(<span class="keyword">bw);</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">populateBean(bd.getBeanClass().getName(), </span><span class="keyword">bd, </span><span class="keyword">bw);</span></span><br><span class="line"><span class="keyword"> </span>   &#125;</span><br></pre></td></tr></table></figure>
<p>该方法的逻辑主要在populateBean中。这个方法是spring里很重要的一个方法，用于装配bean。这里逻辑很复杂，主要是通过反射获取我们new出来的对象的属性及注解。若注解是Autowired,Value,Inject时，进行bean的组装。此方法执行完成之后。我们new出来的对象里通过注解注入的bean就可以使用了。<br> 关键代码展示：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">protected</span> void <span class="keyword">populateBean(String </span><span class="keyword">beanName, </span>RootBeanDefinition mbd, <span class="keyword">BeanWrapper </span><span class="keyword">bw) </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">        <span class="meta">if</span> (hasInstAwareBpps <span class="title">||</span> needsDepCheck) &#123;</span><br><span class="line">            PropertyDescriptor[] filteredPds = filterPropertyDescriptorsForDependencyCheck(<span class="keyword">bw, </span>mbd.allowCaching)<span class="comment">;</span></span><br><span class="line">            <span class="meta">if</span> (hasInstAwareBpps) &#123;</span><br><span class="line">                for (<span class="keyword">BeanPostProcessor </span><span class="keyword">bp </span>: getBeanPostProcessors()) &#123;</span><br><span class="line">                    <span class="meta">if</span> (<span class="keyword">bp </span>instanceof InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">                        InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) <span class="keyword">bp;</span></span><br><span class="line"><span class="keyword"> </span>                     //依赖的<span class="keyword">bean注入在这里实现</span></span><br><span class="line"><span class="keyword"> </span>                       pvs = ibp.postProcessPropertyValues(pvs, filteredPds, <span class="keyword">bw.getWrappedInstance(), </span><span class="keyword">beanName);</span></span><br><span class="line"><span class="keyword"> </span>                 //<span class="meta">end</span></span><br><span class="line">                        <span class="meta">if</span> (pvs == null) &#123;</span><br><span class="line">                            return<span class="comment">;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">if</span> (needsDepCheck) &#123;</span><br><span class="line">                checkDependencies(<span class="keyword">beanName, </span>mbd, filteredPds, pvs)<span class="comment">;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        applyPropertyValues(<span class="keyword">beanName, </span>mbd, <span class="keyword">bw, </span>pvs)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="symbol">public</span> PropertyValues postProcessPropertyValues(</span><br><span class="line">            PropertyValues pvs, PropertyDescriptor[] pds, Object <span class="keyword">bean, </span><span class="keyword">String </span><span class="keyword">beanName) </span>throws <span class="keyword">BeanCreationException </span>&#123;</span><br><span class="line"></span><br><span class="line">            //获取注入的属性</span><br><span class="line">        InjectionMetadata metadata = findAutowiringMetadata(<span class="keyword">beanName, </span><span class="keyword">bean.getClass(), </span>pvs)<span class="comment">;</span></span><br><span class="line">        try &#123;</span><br><span class="line">                    //注入</span><br><span class="line">            metadata.inject(<span class="keyword">bean, </span><span class="keyword">beanName, </span>pvs)<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        catch (<span class="keyword">BeanCreationException </span>ex) &#123;</span><br><span class="line">            throw ex<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        catch (Throwable ex) &#123;</span><br><span class="line">            throw new <span class="keyword">BeanCreationException(beanName, </span><span class="string">"Injection of autowired dependencies failed"</span>, ex)<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        return pvs<span class="comment">;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>quartz 的job里注入bean：<br> job 工厂：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">JobFactory</span> <span class="keyword">extends</span> <span class="title">AdaptableJobFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">AutowireCapableBeanFactory</span> capableBeanFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Object</span> createJobInstance(<span class="type">TriggerFiredBundle</span> bundle) <span class="keyword">throws</span> <span class="type">Exception</span> &#123;</span><br><span class="line">        <span class="comment">//调用父类的方法</span></span><br><span class="line">        <span class="type">Object</span> jobInstance = <span class="keyword">super</span>.createJobInstance(bundle);</span><br><span class="line">        <span class="comment">//进行注入</span></span><br><span class="line">        capableBeanFactory.autowireBean(jobInstance);</span><br><span class="line">        <span class="keyword">return</span> jobInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>job的具体处理逻辑</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalJob</span> <span class="keyword">implements</span> <span class="title">Job</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(InternalJob .<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CuratorFramework client;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobAlarmEventService jobAlarmEventService;</span><br></pre></td></tr></table></figure>
<p>job的spring配置：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean <span class="built_in">id</span>=<span class="string">"jobFactory"</span> <span class="built_in">class</span>=<span class="string">"com.test.scheduler.JobFactory"</span>&gt;&lt;/bean&gt;</span><br><span class="line">    &lt;bean <span class="built_in">id</span>=<span class="string">"schedulerFactoryBean"</span> <span class="built_in">class</span>=<span class="string">"org.springframework.scheduling.quartz.SchedulerFactoryBean"</span>&gt;</span><br><span class="line">        &lt;<span class="keyword">property</span> <span class="built_in">name</span>=<span class="string">"jobFactory"</span> <span class="keyword">ref</span>=<span class="string">"jobFactory"</span>&gt;&lt;/<span class="keyword">property</span>&gt;</span><br><span class="line">        &lt;<span class="keyword">property</span> <span class="built_in">name</span>=<span class="string">"schedulerName"</span> value=<span class="string">"scheduler"</span>&gt;&lt;/<span class="keyword">property</span>&gt;</span><br><span class="line">        &lt;<span class="keyword">property</span> <span class="built_in">name</span>=<span class="string">"configLocation"</span>  value=<span class="string">"classpath:META-INF/spring/quartz.properties"</span>&gt;&lt;/<span class="keyword">property</span>&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/09/25/vmware-网络设置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/25/vmware-网络设置/" itemprop="url">vmware 网络设置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-25T22:29:30+08:00">
                2018-09-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/运维/" itemprop="url" rel="index">
                    <span itemprop="name">运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/25/vmware-网络设置/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/25/vmware-网络设置/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  121
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="NAT设置"><a href="#NAT设置" class="headerlink" title="NAT设置"></a>NAT设置</h2><ul>
<li>删除原有的NAT</li>
<li>新建一个新的NAT链接，生成MAC网卡地址</li>
<li>检查LAN网段</li>
</ul>
<h2 id="桥接设置"><a href="#桥接设置" class="headerlink" title="桥接设置"></a>桥接设置</h2><ul>
<li>删除原有的桥接</li>
<li>新建一个新的桥接，<strong>生成MAC网卡地址 ， 路由admin绑定静态IP</strong></li>
<li>检查LAN网段</li>
<li>ip addr 查看IP和网卡</li>
</ul>
<h2 id="路由设置"><a href="#路由设置" class="headerlink" title="路由设置"></a>路由设置</h2><ul>
<li><ol>
<li>DHCP服务器 -&gt; 静态地址保留 ， 生效所有</li>
<li><a href="http://192.168.0.1/userRpm/LanArpBindingRpm.htm" target="_blank" rel="external">IP与MAC绑定</a>  -&gt; <a href="http://192.168.0.1/userRpm/LanArpBindingRpm.htm" target="_blank" rel="external">静态ARP绑定设置</a> ，生效所有</li>
<li>关闭虚拟机，重启路由器</li>
</ol>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/09/21/Mysql多表连接删除/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/21/Mysql多表连接删除/" itemprop="url">Mysql多表连接删除</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-21T10:06:34+08:00">
                2018-09-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/21/Mysql多表连接删除/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/21/Mysql多表连接删除/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  209
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="联表删除："><a href="#联表删除：" class="headerlink" title="联表删除："></a>联表删除：</h3><p>1、从数据表t1 中把那些id值在数据表t2 里有匹配的记录全删除掉</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DELETE <span class="built_in">t1</span> FROM <span class="built_in">t1</span>,<span class="built_in">t2</span> WHERE <span class="built_in">t1</span>.id=<span class="built_in">t2</span>.id</span><br><span class="line"></span><br><span class="line">或</span><br><span class="line"></span><br><span class="line">DELETE  FROM <span class="built_in">t1</span> USING <span class="built_in">t1</span>,<span class="built_in">t2</span> WHERE <span class="built_in">t1</span>.id=<span class="built_in">t2</span>.id</span><br></pre></td></tr></table></figure>
<p>2、从数据表t1里在数据表t2里没有匹配的记录查找出来并删除掉</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> t1 <span class="keyword">FROM</span> t1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> T2 <span class="keyword">ON</span> t1.id=t2.id <span class="keyword">WHERE</span> t2.id <span class="keyword">IS</span> <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line">或</span><br><span class="line"></span><br><span class="line"><span class="keyword">DELETE</span>  <span class="keyword">FROM</span> t1,<span class="keyword">USING</span> t1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> T2 <span class="keyword">ON</span> t1.id=t2.id <span class="keyword">WHERE</span> t2.id <span class="keyword">IS</span> <span class="literal">NULL</span></span><br></pre></td></tr></table></figure>
<p>3、从两个表中找出相同记录的数据并把两个表中的数据都删除掉</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE <span class="built_in">t1</span>,<span class="built_in">t2</span> from <span class="built_in">t1</span> LEFT <span class="keyword">JOIN </span><span class="built_in">t2</span> ON <span class="built_in">t1</span>.id=<span class="built_in">t2</span>.id WHERE <span class="built_in">t1</span>.id=<span class="number">25</span></span><br></pre></td></tr></table></figure>
<p>注意此处的delete t1,t2 from 中的t1,t2不能是别名</p>
<p>如：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete t1,t2 <span class="keyword">from</span> table_name <span class="keyword">as</span> t1 left join table2_name <span class="keyword">as</span> t2 <span class="keyword">on</span> t1.<span class="built_in">id</span>=t2.<span class="built_in">id</span> <span class="keyword">where</span> table_name.<span class="built_in">id</span>=<span class="number">25</span></span><br></pre></td></tr></table></figure></p>
<p><strong>要求：MYSQL 版本不小于5.0</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/09/15/Redis原理详解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/15/Redis原理详解/" itemprop="url">Redis原理详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-15T21:10:43+08:00">
                2018-09-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/缓存/" itemprop="url" rel="index">
                    <span itemprop="name">缓存</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/缓存/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/15/Redis原理详解/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/15/Redis原理详解/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  683
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  3
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="expire"><a href="#expire" class="headerlink" title="expire"></a>expire</h2><blockquote>
<p><a href="https://redis.io/commands/expire" target="_blank" rel="external">https://redis.io/commands/expire</a></p>
</blockquote>
<ul>
<li>消极方式，访问Key，已过期删除</li>
<li>积极方式，1秒10次。1. 选取20个随机的key 2.删除过期key 3.超过20%过期，执行1步骤。</li>
</ul>
<blockquote>
<h2 id="How-Redis-expires-keys"><a href="#How-Redis-expires-keys" class="headerlink" title="How Redis expires keys"></a>How Redis expires keys</h2><p>Redis keys are expired in two ways: a passive way, and an active way.</p>
<p>A key is passively expired simply when some client tries to access it, and the key is found to be timed out.</p>
<p>Of course this is not enough as there are expired keys that will never be accessed again. These keys should be expired anyway, so periodically Redis tests a few keys at random among keys with an expire set. All the keys that are already expired are deleted from the keyspace.</p>
<p>Specifically this is what Redis does 10 times per second:</p>
<ol>
<li>Test 20 random keys from the set of keys with an associated expire.</li>
<li>Delete all the keys found expired.</li>
<li>If more than 25% of keys were expired, start again from step 1.</li>
</ol>
<p>This is a trivial probabilistic algorithm, basically the assumption is that our sample is representative of the whole key space, and we continue to expire until the percentage of keys that are likely to be expired is under 25%</p>
<p>This means that at any given moment the maximum amount of keys already expired that are using memory is at max equal to max amount of write operations per second divided by 4.</p>
</blockquote>
<h2 id="数据持久化"><a href="#数据持久化" class="headerlink" title="数据持久化"></a>数据持久化</h2><h3 id="rdb-（默认）"><a href="#rdb-（默认）" class="headerlink" title="rdb （默认）"></a>rdb （默认）</h3><blockquote>
<p>  条件满足一个执行，每条规则之间是“或”的关系</p>
<p>  In the example below the behaviour will be to save:<br>  after 900 sec (15 min) if at least 1 key changed<br>  after 300 sec (5 min) if at least 10 keys changed<br>  after 60 sec if at least 10000 keys changed</p>
</blockquote>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">save <span class="number">900</span> <span class="number">1</span></span><br><span class="line">save <span class="number">300</span> <span class="number">10</span></span><br><span class="line">save <span class="number">60</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure>
<h3 id="aof"><a href="#aof" class="headerlink" title="aof"></a>aof</h3><ul>
<li>默认的rdb能够满足持久化的需求，但是存在缺陷就是两次快照之间，可能会丢失数据。</li>
</ul>
<blockquote>
<p>By default Redis asynchronously dumps the dataset on disk. This mode is<br>good enough in many applications, but an issue with the Redis process or<br>a power outage may result into a few minutes of writes lost (depending on<br>the configured save points).</p>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">appendonly</span> <span class="literal">yes</span></span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br></pre></td></tr></table></figure>
<h2 id="lua脚本"><a href="#lua脚本" class="headerlink" title="lua脚本"></a>lua脚本</h2><h3 id="保证原子性"><a href="#保证原子性" class="headerlink" title="保证原子性"></a>保证原子性</h3><ul>
<li><p>redis-cli –eval example.lua</p>
</li>
<li><p>比较暴力</p>
</li>
</ul>
<h3 id="限流demo"><a href="#限流demo" class="headerlink" title="限流demo"></a>限流demo</h3><ul>
<li>10秒内限流10次demo</li>
<li>script load 导入脚本，生成sha</li>
<li>evalsha “{sha}”</li>
<li>lua执行死环境脚本，会有阻塞问题</li>
<li>redis-cli –eval example.lua</li>
</ul>
<h2 id="单线程如何保证高性能"><a href="#单线程如何保证高性能" class="headerlink" title="单线程如何保证高性能"></a>单线程如何保证高性能</h2><h3 id="同步阻塞"><a href="#同步阻塞" class="headerlink" title="同步阻塞"></a>同步阻塞</h3><h3 id="同步非阻塞"><a href="#同步非阻塞" class="headerlink" title="同步非阻塞"></a>同步非阻塞</h3><h3 id="异步阻塞-redis实现，多路复用"><a href="#异步阻塞-redis实现，多路复用" class="headerlink" title="异步阻塞(redis实现，多路复用)"></a>异步阻塞(redis实现，多路复用)</h3><p>异步不一定是多线程</p>
<h3 id="异步非阻塞"><a href="#异步非阻塞" class="headerlink" title="异步非阻塞"></a>异步非阻塞</h3><h2 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 无磁盘复制</span></span><br><span class="line">repl-diskless-sync</span><br></pre></td></tr></table></figure>
<h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">查看集群信息</span></span><br><span class="line">info replication</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">告诉master节点 slave的端口</span></span><br><span class="line">replconf listening-port 6379</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">抓取master的同步信息</span></span><br><span class="line">sync</span><br></pre></td></tr></table></figure>
<h3 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h3><p>全量复制</p>
<p>增量复制</p>
<ul>
<li>链接到集群</li>
</ul>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -<span class="keyword">c</span> -p <span class="number">7000</span></span><br><span class="line">会有redirect <span class="keyword">to</span> slot提示</span><br></pre></td></tr></table></figure>
<ul>
<li>连接到某台机器</li>
</ul>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-<span class="keyword">cli</span> -p 7001</span><br><span class="line">提示MOVED <span class="keyword">error</span></span><br></pre></td></tr></table></figure>
<ul>
<li>cluster slots 查看集群信息 槽信息</li>
</ul>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3</span>主<span class="number">6</span>从</span><br></pre></td></tr></table></figure>
<ul>
<li>cluster nodes 查看节点信息</li>
<li>哨兵模式</li>
</ul>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">连接哨兵节点，然后查询<span class="literal">master</span>的节点</span><br></pre></td></tr></table></figure>
<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><h3 id="jedis"><a href="#jedis" class="headerlink" title="jedis"></a>jedis</h3><ul>
<li>sentinel cluster</li>
<li><p>cluster</p>
</li>
<li><p>jedis.watch 标志释放锁不会失败</p>
</li>
</ul>
<h3 id="redission"><a href="#redission" class="headerlink" title="redission"></a>redission</h3><ul>
<li>single</li>
<li>sentinel</li>
</ul>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">redissionClinet</span><span class="selector-class">.getBucket</span>(<span class="string">""</span>) 获取字符串</span><br><span class="line">其他类型相同</span><br></pre></td></tr></table></figure>
<ul>
<li>cluster</li>
</ul>
<h2 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h2><ul>
<li>setNX</li>
<li>redission lock unlock 源码解读</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/xiaowu_avatar.jpg"
                alt="周小伍 Joey" />
            
              <p class="site-author-name" itemprop="name">周小伍 Joey</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">151</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">周小伍 Joey</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">279.8k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    
      <script id="dsq-count-scr" src="https://joeyblog.disqus.com/count.js" async></script>
    

    

  




	





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
