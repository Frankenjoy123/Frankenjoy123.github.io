<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="xiaowu&#39;s blog">
<meta property="og:url" content="https://zhouxiaowu.coding.me/page/12/index.html">
<meta property="og:site_name" content="xiaowu&#39;s blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="xiaowu&#39;s blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhouxiaowu.coding.me/page/12/"/>





  <title>xiaowu's blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3da41265a1a0042eebe5413c0d6c76f5";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">xiaowu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-dubbo">
          <a href="/categories/Dubbo" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            Dubbo
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/03/13/MySQL开发规范/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/13/MySQL开发规范/" itemprop="url">MySQL开发规范</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-13T14:14:53+08:00">
                2018-03-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/13/MySQL开发规范/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/03/13/MySQL开发规范/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4.5k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  16
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一-命名规范"><a href="#一-命名规范" class="headerlink" title="一. 命名规范"></a>一. 命名规范</h2><ol>
<li><h3 id="库名、表名、字段名必须使用小写字母，并采用下划线分割"><a href="#库名、表名、字段名必须使用小写字母，并采用下划线分割" class="headerlink" title="库名、表名、字段名必须使用小写字母，并采用下划线分割"></a>库名、表名、字段名必须使用小写字母，并采用下划线分割</h3><ul>
<li>为了统一规范， 库名、表名、字段名使用小写字母，禁用关键字（index,order等）。</li>
</ul>
</li>
<li><h3 id="前缀命令规范"><a href="#前缀命令规范" class="headerlink" title="前缀命令规范"></a>前缀命令规范</h3><ul>
<li>视图以<code>view_</code>开头，事件以<code>event_</code>开头，触发器以<code>trig_</code>开头，存储过程以<code>proc_</code>开头，函数以<code>func_</code>开头，应用上面禁用</li>
<li>普通索引以<code>idx_各个列名简称</code>，唯一索引以<code>uk_各个列名简称</code>命名，中间用<code>_</code>隔开。如 <code>idx_col1_col2_col3(col1,col2,col3)</code>，如果列过长，用简写</li>
<li>临时表以<code>tmp_实体表名</code>，线上禁用，备份表以<code>bak_日期_实体表名</code>，尽可能备份至HDFS</li>
</ul>
</li>
<li><h3 id="库名、表名、字段名禁止超过32个字符，需见名知意"><a href="#库名、表名、字段名禁止超过32个字符，需见名知意" class="headerlink" title="库名、表名、字段名禁止超过32个字符，需见名知意"></a>库名、表名、字段名禁止超过32个字符，需见名知意</h3><p>库名、表名、字段名支持最多32个字符，但为了统一规范、易于辨识以及减少传输量，禁止超过32个字符，例：业务名称/实体_表作用</p>
</li>
<li><h3 id="按日期时间分表须符合-YYYYMMDD格式"><a href="#按日期时间分表须符合-YYYYMMDD格式" class="headerlink" title="按日期时间分表须符合_YYYYMMDD格式"></a>按日期时间分表须符合_YYYYMMDD格式</h3><p>按月或日生成的表，以<code>_YYYYMM[DD]</code>方式命名。</p>
</li>
</ol>
<h2 id="二-库表基础规范"><a href="#二-库表基础规范" class="headerlink" title="二. 库表基础规范"></a>二. 库表基础规范</h2><ol>
<li><h3 id="使用Innodb存储引擎"><a href="#使用Innodb存储引擎" class="headerlink" title="使用Innodb存储引擎"></a>使用Innodb存储引擎</h3><p>所有表必须使用默认存储引擎InnoDB。</p>
</li>
<li><h3 id="表编码方式统一使用UTF8或UTF8MB4的"><a href="#表编码方式统一使用UTF8或UTF8MB4的" class="headerlink" title="表编码方式统一使用UTF8或UTF8MB4的"></a>表编码方式统一使用UTF8或UTF8MB4的</h3><p>创建索引时utf8比utf8mb4少一个字节，所以明确没有emoj时，尽量使用utf8。</p>
</li>
<li><h3 id="所有表都要添加注释"><a href="#所有表都要添加注释" class="headerlink" title="所有表都要添加注释"></a>所有表都要添加注释</h3><p>所有字段必需要有注释，包括表注释，并标注简单意义</p>
</li>
<li><h3 id="控制单表字段数量"><a href="#控制单表字段数量" class="headerlink" title="控制单表字段数量"></a>控制单表字段数量</h3><ul>
<li>单表字段数上限50左右，再多的话考虑垂直分表，一是冷热数据分离，二是大字段分离，三是常在一起做条件和返回列的不分离。</li>
<li>表字段控制少而精，可以提高IO效率，内存缓存更多有效数据，从而提高响应速度和并发能力，后续 alter table 也更快。</li>
</ul>
</li>
<li><h3 id="所有表都必须要显式指定主键"><a href="#所有表都必须要显式指定主键" class="headerlink" title="所有表都必须要显式指定主键"></a>所有表都必须要显式指定主键</h3><ul>
<li>双活的表必须禁用自增主键【snowflake】，InnoDB表实际是一棵索引组织表，顺序存储可以提高存取效率，充分利用磁盘空间。还有对一些复杂查询可能需要自连接来优化时需要用到。</li>
<li>需要全局唯一主键时，gmt_create这类的能使用主键排序的尽量使用主键做分页排序，不浪费索引</li>
<li>少数情况可以使用联合唯一主键，需与DBA协商</li>
</ul>
</li>
<li><h3 id="不使用外键"><a href="#不使用外键" class="headerlink" title="不使用外键"></a>不使用外键</h3><p>外键严重影响数据库性能，增加表维护复杂度，所以线上禁用外键</p>
</li>
<li><h3 id="字段名称统一"><a href="#字段名称统一" class="headerlink" title="字段名称统一"></a>字段名称统一</h3><ul>
<li>每张表原则上必须含有gmt_create,gmt_modify，gmt_create为创建时间。gmt_modify属性为NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP，gmt_create属性为NOT NULL DEFAULT CURRENT_TIMESTAMP，统一放至字段最后</li>
<li>所有相同意义的表采用统一字段名称，并且字段类型一致，这样应用与维护人员见字段知其含义，方便理解</li>
</ul>
</li>
<li><h3 id="简单单表数据量控制在1000w以内"><a href="#简单单表数据量控制在1000w以内" class="headerlink" title="简单单表数据量控制在1000w以内"></a>简单单表数据量控制在1000w以内</h3></li>
<li><h3 id="尽量保证单表存储空间小于10GB"><a href="#尽量保证单表存储空间小于10GB" class="headerlink" title="尽量保证单表存储空间小于10GB"></a>尽量保证单表存储空间小于10GB</h3></li>
<li><p><strong>建表时不要加入COLLATE相关内容</strong></p>
</li>
</ol>
<h2 id="三-字段规范"><a href="#三-字段规范" class="headerlink" title="三. 字段规范"></a>三. 字段规范</h2><ol>
<li><h3 id="char、varchar、text等字符串类型定义"><a href="#char、varchar、text等字符串类型定义" class="headerlink" title="char、varchar、text等字符串类型定义"></a>char、varchar、text等字符串类型定义</h3><ul>
<li>对于长度基本固定的列，如果该列恰好更新又特别频繁，适合char</li>
<li>varchar虽然存储变长字符串，但不可太小也不可太大。UTF8最多能存21844个汉字，或65532个英文</li>
<li>TEXT类型与VARCHAR都类似，存储可变长度，最大限制也是2^16，但是它20bytes以后的内容是在数据页以外的空间存储（row_format=dynamic），对它的使用需要多一次寻址，没有默认值。</li>
<li>把text/blob拆到另一个表中，如果只存不读的禁用，建议直接存HDFS</li>
<li>BLOB可以看出varbinary的扩展版本，内容以二进制字符串存储，无字符集，区分大小写，有一种经常提但不用的场景：不要在数据库里存储图片。</li>
<li>字符集为utf8，varchar类型最大只能创建索引为前255字节；字符集为utf8mb4，varchar类型最大只能创建索引为前191字节。所以字段造型时首选int，如果varchar时字段做查询的越小越好，长度不要超过191。</li>
</ul>
</li>
<li><h3 id="int、tinyint、decimal等数字类型定义"><a href="#int、tinyint、decimal等数字类型定义" class="headerlink" title="int、tinyint、decimal等数字类型定义"></a>int、tinyint、decimal等数字类型定义</h3><ul>
<li>使用tinyint来代替 enum和booleanENUM类型在需要修改或增加枚举值时，需要在线DDL，成本较高；ENUM列值如果含有数字类型，可能会引起默认值混淆tinyint使用1个字节，一般用于status,type,flag的列</li>
<li>建议使用 UNSIGNED 存储非负数值相比不使用 unsigned，可以扩大一倍使用数值范围</li>
<li>int使用固定4个字节存储，int(11)与int(4)只是显示宽度的区别</li>
<li>使用int存储IPv4地址，可节省 9%+的数据存储空间</li>
<li>使用Decimal 代替float/double存储精确浮点数对于货币、金额这样的类型，可以使用（货币使用bigint+币种+最小单位），如果精度不高，可以使用decimal(9,2)。float默认只能能精确到6位有效数字</li>
</ul>
</li>
<li><h3 id="timestamp与datetime选择"><a href="#timestamp与datetime选择" class="headerlink" title="timestamp与datetime选择"></a>timestamp与datetime选择</h3><ul>
<li>datetime 和 timestamp类型所占的存储空间不同，前者8个字节，后者4个字节，这样造成的后果是两者能表示的时间范围不同。前者范围为1000-01-01 00:00:00 ~ 9999-12-31 23:59:59，后者范围为 1970-01-01 00:00:00 到 2037-12-31 23:59:59。所以 TIMESTAMP 支持的范围比 DATATIME 要小。</li>
<li>timestamp可以在insert/update行时，自动更新时间字段（如 NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP），但一个表只能有一个这样的定义。</li>
<li>timestamp显示与时区有关，内部总是以 UTC 毫秒 来存的。还受到严格模式的限制</li>
<li>优先使用timestamp，datetime也没问题，timestamp精度可以到秒后6位，即timestamp(6)</li>
<li>where条件里不要对时间列上使用时间函数</li>
</ul>
</li>
<li><h3 id="建议字段都定义为NOT-NULL加上default值"><a href="#建议字段都定义为NOT-NULL加上default值" class="headerlink" title="建议字段都定义为NOT NULL加上default值"></a>建议字段都定义为NOT NULL加上default值</h3><ul>
<li>如果是索引字段，一定要定义为not null 。因为null值会影响cordinate统计，影响优化器对索引的选择</li>
<li>如果不能保证insert时一定有值过来，定义时使用default ‘’ ，或 0</li>
<li>上面两条如果需要双机房同步，那同步的表新增或更改必须为NULL，再行初始化数据</li>
</ul>
</li>
<li><h3 id="类型选择原则"><a href="#类型选择原则" class="headerlink" title="类型选择原则"></a>类型选择原则</h3><p>Int-&gt;char-&gt;varchar-&gt;text，从左到右性能越差</p>
</li>
</ol>
<h2 id="四-索引规范"><a href="#四-索引规范" class="headerlink" title="四. 索引规范"></a>四. 索引规范</h2><ol>
<li><h3 id="索引个数限制"><a href="#索引个数限制" class="headerlink" title="索引个数限制"></a>索引个数限制</h3><ul>
<li>索引是双刃剑，会增加维护负担，增大IO压力，索引占用空间是成倍增加的</li>
<li>单张表的索引数量控制在5个以内，索引的大小尽量比表小。若单张表多个字段在查询需求上都要单独用到索引，需要经过DBA评估。</li>
</ul>
</li>
<li><h3 id="避免冗余索引"><a href="#避免冗余索引" class="headerlink" title="避免冗余索引"></a>避免冗余索引</h3><ul>
<li>InnoDB表是一棵索引组织表，主键是和数据放在一起的聚集索引，普通索引最终指向的是主键地址，所以把主键做最后一列是多余的。如id作为主键，联合索引(user_id,id)上的id就完全多余</li>
<li>(a,b,c)、(a,b)，后者为冗余索引。可以利用前缀索引来达到加速目的，减轻维护负担</li>
</ul>
</li>
<li><h3 id="索引创建原则"><a href="#索引创建原则" class="headerlink" title="索引创建原则"></a>索引创建原则</h3><ul>
<li>尽可能选择过滤效果好的列上创建索引</li>
<li>索引选择性计算方法（基数 ÷ 数据行数）Selectivity = Cardinality / Total Rows = select count(distinct col1)/count(*) from tbname，越接近1说明col1上使用索引的过滤效果越好</li>
<li>如果某列为sex，数据倾斜比较大，male占比99%，female占比1%，而每次查询都为female，则需要创建该列的索引</li>
</ul>
</li>
<li><h3 id="最左前缀原则"><a href="#最左前缀原则" class="headerlink" title="最左前缀原则"></a>最左前缀原则</h3><ul>
<li>mysql使用联合索引时，从左向右匹配，遇到断开或者范围查询时，无法用到后续的索引列比如索引idx_c1<em>c2</em>c3 (c1,c2,c3)，相当于创建了(c1)、(c1,c2)、(c1,c2,c3)三个索引，where条件包含上面三种情况的字段比较则可以用到索引，但像 where c1=a and c3=c 只能用到c1列的索引，像 c2=b and c3=c等情况就完全用不到这个索引</li>
<li>遇到范围查询(&gt;、&lt;、between、like)也会停止索引匹配，比如 c1=a and c2 &gt; 2 and c3=c，只有c1,c2列上的比较能用到索引，(c1,c2,c3)排列的索引才可能会都用上</li>
<li>where条件里面字段的顺序与索引顺序无关，mysql优化器会自动调整顺序</li>
<li>mysql的optimizer_switch，可以配置icp，mrr等特性。mrr为多个字段做合并，如已存在c1,c2,c3索引，查询时c1=’a’ and/or c2=’b’，则会使用到索引合并，如果大部分查询没有c1和c2同时存在，则建议创建单列索引</li>
</ul>
</li>
<li><h3 id="前缀索引"><a href="#前缀索引" class="headerlink" title="前缀索引"></a>前缀索引</h3><ul>
<li>前缀索引尽量第一列区分度高，这样如果优化器判断时会比较准确 ,A列1000个不同值，B列有100000个不同值，这样建议索引创建时idx_B_A(B,A)</li>
</ul>
</li>
<li><h3 id="合理使用覆盖索引减少IO"><a href="#合理使用覆盖索引减少IO" class="headerlink" title="合理使用覆盖索引减少IO"></a>合理使用覆盖索引减少IO</h3><p>INNODB存储引擎中，secondary index(非主键索引，又称为辅助索引、二级索引)没有直接存储行地址，而是存储主键值。如果用户需要查询secondary index中所不包含的数据列，则需要先通过secondary index查找到主键值，然后再通过主键查询到其他数据列，因此需要查询两次。覆盖索引则可以在一个索引中获取所有需要的数据列，从而避免回表进行二次查找，节省IO因此效率较高。例如SELECT email，uid FROM user_email WHERE uid=xx，如果uid不是主键，适当时候可以将索引添加为index(uid，email)，以获得性能提升。</p>
</li>
<li><h3 id="不要在频繁更新的列上创建索引"><a href="#不要在频繁更新的列上创建索引" class="headerlink" title="不要在频繁更新的列上创建索引"></a>不要在频繁更新的列上创建索引</h3></li>
</ol>
<h2 id="五-SQL设计"><a href="#五-SQL设计" class="headerlink" title="五. SQL设计"></a>五. SQL设计</h2><ol>
<li><h3 id="杜绝直接-SELECT-读取全部字段"><a href="#杜绝直接-SELECT-读取全部字段" class="headerlink" title="杜绝直接 SELECT * 读取全部字段"></a>杜绝直接 SELECT * 读取全部字段</h3><p>即使需要所有字段，减少网络带宽消耗，能有效利用覆盖索引，表结构变更对程序基本无影响</p>
</li>
<li><h3 id="能确定返回结果只有一条时，使用-limit-1"><a href="#能确定返回结果只有一条时，使用-limit-1" class="headerlink" title="能确定返回结果只有一条时，使用 limit 1"></a>能确定返回结果只有一条时，使用 limit 1</h3><p><strong>在保证数据不会有误的前提下</strong>，能确定结果集数量时，多使用limit，尽快的返回结果。</p>
</li>
<li><h3 id="建议不要使用隐式类型转换"><a href="#建议不要使用隐式类型转换" class="headerlink" title="建议不要使用隐式类型转换"></a>建议不要使用隐式类型转换</h3></li>
<li><h3 id="禁止在where条件列上使用函数"><a href="#禁止在where条件列上使用函数" class="headerlink" title="禁止在where条件列上使用函数"></a>禁止在where条件列上使用函数</h3><ul>
<li>会导致索引失效，如lower(email)，f_qq % 4。可放到右边的常量上计算</li>
<li>返回小结果集不是很大的情况下，可以对返回列使用函数，简化程序开发，但尽量不要使用函数索引</li>
</ul>
</li>
<li><h3 id="使用like模糊匹配，-不要放首位"><a href="#使用like模糊匹配，-不要放首位" class="headerlink" title="使用like模糊匹配，%不要放首位"></a>使用like模糊匹配，%不要放首位</h3><p>会导致索引失效，有这种搜索需求是，考虑其它方案，如es全文搜索</p>
</li>
<li><h3 id="使用join时，where条件尽量使用充分利用同一表上的索引"><a href="#使用join时，where条件尽量使用充分利用同一表上的索引" class="headerlink" title="使用join时，where条件尽量使用充分利用同一表上的索引"></a>使用join时，where条件尽量使用充分利用同一表上的索引</h3><ul>
<li>如 select t1.a,t2.b * from t1,t2 where t1.a=t2.a and t1.b=123 and t2.c= 4 ，如果t1.c与t2.c字段相同，那么t1上的索引(b,c)就只用到b了。此时如果把where条件中的t2.c=4改成t1.c=4，那么可以用到完整的索引</li>
<li>这种情况可能会在字段冗余设计（反范式）时出现</li>
<li>正确选取inner join和left join</li>
</ul>
</li>
<li><h3 id="少用或不用子查询，改用join"><a href="#少用或不用子查询，改用join" class="headerlink" title="少用或不用子查询，改用join"></a>少用或不用子查询，改用join</h3><p>mysql 5.6版本只支持nest loop，让mysql自已判断需要使用的索引</p>
</li>
<li><h3 id="考虑使用union-all，少使用union，注意考虑去重"><a href="#考虑使用union-all，少使用union，注意考虑去重" class="headerlink" title="考虑使用union all，少使用union，注意考虑去重"></a>考虑使用union all，少使用union，注意考虑去重</h3><ul>
<li>union all不去重，而少了排序操作，速度相对比union要快，如果没有去重的需求，优先使用union all</li>
<li>如果UNION结果中有使用limit，在2个子SQL可能有许多返回值的情况下，各自加上limit。如果还有order by，请找DBA。</li>
</ul>
</li>
<li><h3 id="IN的内容尽量不超过200个"><a href="#IN的内容尽量不超过200个" class="headerlink" title="IN的内容尽量不超过200个"></a>IN的内容尽量不超过200个</h3><p>超过200个值使用批量的方式，否则一次执行会影响数据库的并发能力，因为单SQL只能且一直占用单CPU，而且可能导致主从复制延迟</p>
</li>
<li><h3 id="拒绝大事务"><a href="#拒绝大事务" class="headerlink" title="拒绝大事务"></a>拒绝大事务</h3><p>比如在一个事务里进行多个select，多个update，如果是高频事务，会严重影响MySQL并发能力，因为事务持有的锁等资源只在事务rollback/commit时才能释放。但同时也要权衡数据写入的一致性。</p>
</li>
<li><h3 id="避免使用is-null-is-not-null这样的比较"><a href="#避免使用is-null-is-not-null这样的比较" class="headerlink" title="避免使用is null, is not null这样的比较"></a>避免使用is null, is not null这样的比较</h3></li>
<li><h3 id="杜绝危险SQL"><a href="#杜绝危险SQL" class="headerlink" title="杜绝危险SQL"></a>杜绝危险SQL</h3></li>
<li><ul>
<li>去掉where 1=1 这样无意义或恒真的条件，如果遇到update/delete或遭到sql注入就恐怖了</li>
<li>SQL中不允许出现DDL语句。一般也不给予create/alter这类权限</li>
</ul>
</li>
<li><p>编写SQL 慎用分组、聚合</p>
<p>​</p>
<p>在编写SQL中，原则上不能使用以下方法，尽可能将这些逻辑交由应用实现</p>
<p>​</p>
<p>1、group by having<br>2、count/sum/avg etc.<br>3、order by 非id<br>4、3张及3张以上表做嵌套<br>5、left join/ right join<br>6、select * from<br>7、无where条件的查询</p>
</li>
</ol>
<h2 id="使用建议"><a href="#使用建议" class="headerlink" title="使用建议"></a>使用建议</h2><ol>
<li><h3 id="order-by-limit"><a href="#order-by-limit" class="headerlink" title="order by .. limit"></a>order by .. limit</h3><p>这种查询更多的是通过索引去优化，但order by的字段有讲究，比如主键id与gmt_create都是顺序递增，那就可以考虑order by id而非 gmt_create 。</p>
</li>
<li><h3 id="c1-lt-a-order-by-c2"><a href="#c1-lt-a-order-by-c2" class="headerlink" title="c1 &lt; a order by c2"></a>c1 &lt; a order by c2</h3><p>与上面不同的是，order by之前有个范围查询，由前面的内容可知，用不到类似(c1,c2)的索引，但是可以利用(c2,c1)索引。另外还可以改写成join的方式实现。</p>
</li>
<li><h3 id="分页优化"><a href="#分页优化" class="headerlink" title="分页优化"></a>分页优化</h3><p>建议使用合理的分页方式以提高分页效率，大页情况下不使用跳跃式分页假如有类似下面分页语句:SELECT <em>FROM table1 ORDER BY ftime DESC LIMIT 10000,10;这种分页方式会导致大量的io，因为MySQL使用的是提前读取策略。推荐分页方式：SELECT </em>FROM table1 WHERE ftime &lt; last_time ORDER BY ftime DESC LIMIT 10即传入上一次分页的界值</p>
<p>SELECT * FROM table as t1 inner JOIN (SELECT id FROM table ORDER BY time LIMIT 10000，10) as t2 ON <a href="http://t1.id/" target="_blank" rel="external">t1.id</a>=<a href="http://t2.id/" target="_blank" rel="external">t2.id</a></p>
</li>
<li><h3 id="count计数"><a href="#count计数" class="headerlink" title="count计数"></a>count计数</h3><ul>
<li>首先count(<em>)、count(1)、count(col1)是有区别的，count(</em>)表示整个结果集有多少条记录，count(1)表示结果集里以primary key统计数量，绝大多数情况下count(<em>)与count(1)效果一样的，但count(col1)表示的是结果集里 col1 列 NOT null 的记录数。优先采用count(</em>)</li>
<li>大数据量count是消耗资源的操作，甚至会拖慢整个库，查询性能问题无法解决的，应从产品设计上进行重构。例如当频繁需要count的查询，考虑使用汇总表</li>
<li>遇到distinct的情况，group by方式可能效率更高。</li>
</ul>
</li>
<li><h3 id="delete-update语句改成select再explain"><a href="#delete-update语句改成select再explain" class="headerlink" title="delete,update语句改成select再explain"></a>delete,update语句改成select再explain</h3></li>
<li><h3 id="涉及到复杂sql时，务必先参考已有索引设计，先explain"><a href="#涉及到复杂sql时，务必先参考已有索引设计，先explain" class="headerlink" title="涉及到复杂sql时，务必先参考已有索引设计，先explain"></a>涉及到复杂sql时，务必先参考已有索引设计，先explain</h3><ul>
<li>简单SQL拆分，不以代码处理复杂为由。</li>
<li>比如 OR 条件： f_phone=’10000’ or f_mobile=’10000’，两个字段各自有索引，可以使用索引合并使用两个索引。不过建议拆分成2个sql，或者union all，如果非要用mysql索引实现，则需要创建两列单列索引，打开index_merge_union后会转义成union。</li>
<li>先explain的好处是可以为了利用索引，增加更多查询限制条件</li>
</ul>
</li>
<li><h3 id="减少与数据库交互的次数，尽量采用批量SQL语句"><a href="#减少与数据库交互的次数，尽量采用批量SQL语句" class="headerlink" title="减少与数据库交互的次数，尽量采用批量SQL语句"></a>减少与数据库交互的次数，尽量采用批量SQL语句</h3><ul>
<li><code>INSERT ... ON DUPLICATE KEY UPDATE ...</code>，插入行后会导致在一个UNIQUE索引或PRIMARY KEY中出现重复值，则执行旧行UPDATE，如果不重复则直接插入，影响1行。</li>
<li><code>REPLACE INTO</code>类似，但它是冲突时删除旧行。<code>INSERT IGNORE</code>相反，保留旧行，丢弃要插入的新行。</li>
<li>INSERT INTO VALUES(),(),()，合并插入。</li>
</ul>
</li>
<li><h3 id="隐式类型使用注意事项"><a href="#隐式类型使用注意事项" class="headerlink" title="隐式类型使用注意事项"></a>隐式类型使用注意事项</h3><ul>
<li><p>两个参数至少有一个是 NULL 时，比较的结果也是 NULL，例外是使用 &lt;=&gt; 对两个 NULL 做比较时会返回 1，这两种情况都不需要做类型转换</p>
</li>
<li><p>两个参数都是字符串，会按照字符串来比较，不做类型转换</p>
</li>
<li><p>两个参数都是整数，按照整数来比较，不做类型转换</p>
</li>
<li><p>十六进制的值和非数字做比较时，会被当做二进制串</p>
</li>
<li><p>有一个参数是 TIMESTAMP 或 DATETIME，并且另外一个参数是常量，常量会被转换为 timestamp</p>
</li>
<li><p>有一个参数是 decimal 类型，如果另外一个参数是 decimal 或者整数，会将整数转换为 decimal 后进行比较，如果另外一个参数是浮点数，则会把 decimal 转换为浮点数进行比较</p>
</li>
<li><p>所有其他情况下，两个参数都会被转换为浮点数再进行比较。</p>
<p>例：A列为int类型时，A=’123’隐式转换后可以使用索引；A为char类型时，A=123隐式转换后无法使用索引</p>
</li>
</ul>
</li>
<li><h3 id="任何新的select-update-delete上线，建议都要先explain，看索引使用情况"><a href="#任何新的select-update-delete上线，建议都要先explain，看索引使用情况" class="headerlink" title="任何新的select,update,delete上线，建议都要先explain，看索引使用情况"></a>任何新的select,update,delete上线，建议都要先explain，看索引使用情况</h3><p>尽量避免extra列出现：Using File Sort，Using Temporary，rows超过1000的要谨慎上线。explain解读</p>
</li>
<li><ul>
<li><code>type</code>：ALL, index, range, ref, eq_ref, const, system（从左到右，性能从差到好）</li>
<li><code>possible_keys</code>：指出MySQL能使用哪个索引在表中找到记录，查询涉及到的字段上若存在索引，则该索引将被列出，但不一定被查询使用</li>
<li><code>key</code>：表示MySQL实际决定使用的键（索引）如果没有选择索引，键是NULL。要想强制MySQL使用或忽视possible_keys列中的索引，在查询中使用FORCE INDEX、USE INDEX或者IGNORE INDEX</li>
<li><code>ref</code>：表示选择 <code>key</code> 列上的索引，哪些列或常量被用于查找索引列上的值</li>
<li><code>rows</code>：根据表统计信息及索引选用情况，估算的找到所需的记录所需要读取的行数</li>
<li><code>Extra``Using temporary</code>：表示MySQL需要使用临时表来存储结果集，常见于排序和分组查询<code>Using filesort</code>：MySQL中无法利用索引完成的排序操作称为“文件排序”</li>
</ul>
</li>
</ol>
<p><strong>查询条件（包括DML中的条件）及每个条件占比数据量：</strong></p>
<p>where login_id=1 100%不同值 算法：count(distinct login_id) / count(1)</p>
<p>where user_name=1 and status=1 order by id desc limit 5 80%不同值，算法：count(distinct user_name,status) / count(1)</p>
<p>原则上大于20%以上就要创建下索引</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/03/08/java范型通配符/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/08/java范型通配符/" itemprop="url">java范型使用小结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-08T16:33:00+08:00">
                2018-03-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java基础/" itemprop="url" rel="index">
                    <span itemprop="name">java基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/08/java范型通配符/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/03/08/java范型通配符/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  14
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="范型通配符"><a href="#范型通配符" class="headerlink" title="范型通配符"></a>范型通配符</h1><ol>
<li>&lt;? extends Hero&gt;</li>
</ol>
<p>ArrayList heroList&lt;? extends Hero&gt; 表示<br>只能放子类<br>所以 可以确凿的是，从heroList取出来的对象，一定是可以转型成Hero的</p>
<ol>
<li>&lt;? super Hero&gt;</li>
</ol>
<p>ArrayList heroList&lt;? super Hero&gt; 表示<br>heroList的泛型可能是Hero<br>heroList的泛型可能是Object<br>可以往里面插入Hero以及Hero的子类<br>但是取出来有风险，因为不确定取出来是Hero还是Object</p>
<ol>
<li>泛型通配符?</li>
</ol>
<p>泛型通配符? 代表任意泛型<br>既然?代表任意泛型，那么换句话说，这个容器什么泛型都有可能<br>所以只能以Object的形式取出来<br>并且不能往里面放对象，因为不知道到底是一个什么泛型的容器</p>
<p>一、泛型由来<br>Java语言类型包括八种基本类型(byte short int long float double boolean char)和复杂类型，复杂类型包括类和数组。<br>早期Java版本（1.4之前）如果要代指某个泛化类对象，只能使用Object，这样写出来的代码需要增加强转，而且缺少类型检查，代码缺少健壮性。在1.5之后，Java引入了泛型(Generic)的概念，提供了一套抽象的类型表示方法。利用泛型，我们可以：<br>1、表示多个可变类型之间的相互关系：HashMap<t,s>表示类型T与S的映射，HashMap<t, s="" extends="" t="">表示T的子类与T的映射关系</t,></t,s></p>
<p>2、细化类的能力：ArrayList<t> 可以容纳任何指定类型T的数据，当T代指人，则是人的有序列表，当T代指杯子，则是杯子的有序列表，所有对象个体可以共用相同的操作行为</t></p>
<p>3、复杂类型被细分成更多类型：List<people>和List<cup>是两种不同的类型，这意味着List<people> listP = new ArrayList<cup>()是不可编译的。后面会提到，这种检查基于编译而非运行，所以说是不可编译并非不可运行，因为运行时ArrayList不保留Cup信息。另外要注意，即使People继承自Object，List<object> listO = new ArrayList<people>()也是不可编译的，应理解为两种不同类型。因为listO可以容纳任意类型，而实例化的People列表只能接收People实例，这会破坏数据类型完整性。</people></object></cup></people></cup></people></p>
<p>4、简化代码实现：假设有一个执行过程，对不同类型的数据，进行某些流程一致的处理，不引入泛型的实现方法为：<br>[java] view plain copy<br>public void addToArray(Integer data, Integer array[], int pos) {<br>    array[pos] = data;<br>}<br>public void addToArray(Long data, Long array[], int pos) {<br>    array[pos] = data;<br>}<br>这是一种典型的多态行为——重载，但是不够简化。引入泛型的写法更优雅：<br>[java] view plain copy<br>public <t> void addToArray(T data, T array[], int pos) {<br>    array[pos] = data;<br>}</t></p>
<p>二、泛型定义与使用（泛型类和泛型方法）<br>1、泛型参数的命名风格：<br>1）尽量用简便的命名来命名泛型，若类型无特定意义，尽量使用一个字符<br>2）尽量使用全大写来命名泛型形参，以此与其他类型区分开<br>3）单字母的泛型建议用T命名，如果有多个泛型，可以取T周围的大写字母，注意，如果泛型本身有意义，可以不遵守这一条，比如缓存管理CacheManager<param, data="">，该类负责管理缓存查询条件与数据的映射，用单字母就不太合适，使用多字母更好<br>4）对于泛型函数或者泛型内部类在某个泛型类中出现的情况，建议泛型函数和内部类的泛型形参名称与外层类的泛型名称保持不同，否则容易引起混淆。类似这种：<br>[java] view plain copy<br>public class GenericClass<t> {<br>     public <t> void testGenericMethod(T t) {<br>     }<br>}</t></t></param,></p>
<p>其实testGenericMethod方法的形参与外面GenericClass的形参完全没有关系。换句话说，泛型方法的泛型是优先使用方法泛型定义的。这种更应该写成：<br>[java] view plain copy<br>public class GenericClass<t> {<br>     public <s> void testGenericMethod(S s) {<br>     }<br>}</s></t></p>
<p>2、泛型存在两种用法：泛型类和泛型方法</p>
<p>1）泛型类<br>定义泛型类时，在类名后加&lt;&gt;，尖括号内可以定义一个或多个泛型参数，并指定泛型参数的取值范围，多个参数用逗号(,)分割<br>泛型类中定义的泛型全类可用（静态方法、静态代码块、静态成员变量除外）<br>父类定义的泛型参数子类无法继承，所以子类得自己写<br>[java] view plain copy<br>public class GenericClass<t extends="" aclass=""> {<br>    T data;<br>    void setData(T t) {<br>        data = t;<br>    }<br>    T getData() {<br>        return data;<br>    }<br>}</t></p>
<p>2）泛型方法<br>定义泛型方法，在方法修饰符后，返回参数前加上&lt;&gt;，尖括号内可以定义一个或多个泛型参数，并指定泛型参数取值范围，多个参数用逗号(,)分割<br>泛型方法中定义的泛型作用域在方法内<br>[java] view plain copy<br>public class GenericMethodClass {<br>    public <t extends="" aclass,="" s="" t=""> T setData(T t, S s) {<br>        //do something<br>        return t;<br>    }<br>}</t></p>
<p>定义泛型方法，更多是为了表达返回值和方法形参间的关系，本例中方法第一个参数T继承AClass，第二个参数S继承T，返回值是第一个参数。<br>如果仅仅是为了实现了多态，应优先使用通配符。类似如下：<br>[java] view plain copy<br>public void addList(List&lt;?&gt; list) {<br>    //todo<br>}</p>
<p>3、定义了多个泛型类型参数时，一定要在使用时都指定类型，否则会编译出错。</p>
<p>4、对泛型类的类型参数赋值包含两种方法：<br>1）类变量或实例化：<br>List<string> listS;<br>listS = new ArrayList<string>();</string></string></p>
<p>2）继承<br>public class MyList<s> extends ArrayList<s> implements IMyInterface<s> {<br>}<br>S是对ArrayList内部定义的泛型E的赋值。</s></s></s></p>
<p>5、对泛型方法的赋值：<br>[java] view plain copy<br>public <t> T testMethod1(T t, List<t> list) {<br>}</t></t></p>
<p>public <t> T testMethod2(List<t> list1, List<t> list2){<br>}</t></t></t></p>
<p>People n = null;</p>
<p>List<people> list1 = null;<br>testMethod1(n, list1);//此时泛型参数T为People</people></p>
<p>List<integer> list2 = null;<br>testMethod2(list1, list2);//编译报错</integer></p>
<p>三、通配符<br>1）上述泛型赋值都是赋予泛型参数确定值，我们还可以赋予泛型参数不确定值，也就是通配符?。使用通配符?表示一个未知的类型。类似如下：<br>List&lt;?&gt; list;存放任意的对象<br>List&lt;? extends AClass&gt; listSubAClass; //存放AClass的子类<br>List&lt;? extends BClass&gt; listSuperBClass; //存放BClass的父类</p>
<p>2）通配符通常与泛型关键字一起使用。</p>
<p>3）在Java集合框架中，对于未知类型的容器类，只能读取其中元素，不能添加元素。这是因为，对不确定的参数类型，编译器无法识别添加元素的类型和容器的类型是否兼容，唯一的例外是NULL。同时，其读取的元素只能用Object来存储。</p>
<p>4）通配符不能用在泛型类和泛型方法声明中，类似如下：<br>[java] view plain copy<br>public class GenericClass&lt;?&gt; { //编译错误<br>  public &lt;?&gt; void testGenericMethod(? t) { //编译错误<br>  }<br>}</p>
<p>四、泛型关键字<br>1、泛型关键字有二个 extends和super，分别表示类型上界和类型下界<br>T extends AClass 表示T继承自AClass类<br>? super AClass 表示?是AClass的父类，注意：super只能与通配符?搭配使用，我们不能写：<br>public class GenericClass<t super="" aclass=""> { //错误<br>}<br>此例子中super换成extends是正确的，表示泛型T继承自AClass，T换成通配符?也是可以的，表示未知类型的下界是AClass。</t></p>
<p>2、通配符与泛型关键字组合使用</p>
<p>举两个例子：<br>下界：<br>[java] view plain copy<br>List&lt;? super People&gt; list = new ArrayList&lt;&gt;();<br>People people = new People();<br>list.add(people);<br>People data= list.get(0 ); //编译出错，报错Object不能转为People</p>
<p>上界：<br>[java] view plain copy<br>List&lt;? extends People&gt; list = new ArrayList&lt;&gt;();<br>People people = new People();<br>list.add(people);// 编译出错，不能向容器中添加确定的元素<br>People data= list.get( 0);</p>
<p>总结就是：上界添加(add)受限，下界查询(get)受限</p>
<p>五、泛型实现原理<br>1、Java泛型是编译时技术，在运行时不包含类型信息，仅其实例中包含类型参数的定义信息。<br>2、Java利用编译器擦除（erasure，前端处理）实现泛型，基本上就是泛型版本源码到非泛型版本源码的转化。<br>3、擦除去掉了所有的泛型类内所有的泛型类型信息，所有在尖括号之间的类型信息都被扔掉.<br>举例来说：List<string>类型被转换为List，所有对类型变量String的引用被替换成类型变量的上限(通常是Object)。<br>而且，无论何时结果代码类型不正确，会插入一个到合适类型的转换。<br>[java] view plain copy</string></p>
<p><t> T badCast(T t, Object o) {<br>return (T) o; // unchecked warning<br>}<br>这说明String类型参数在List运行时并不存在。它们也就不会添加任何的时间或者空间上的负担。但同时，这也意味着你不能依靠他们进行类型转换。</t></p>
<p>4、一个泛型类被其所有调用共享<br>对于上文中的GenericClass，在编译后其内部是不存入泛型信息的，也就是说：<br>[java] view plain copy<br>GenericClass<aclass> gclassA = new GenericClass<aclass>();<br>GenericClass<bclass> gclassB = new GenericClass<bclass>();<br>gClassA.getClass() == gClassB.getClass()<br>这个判断返回的值是true，而非false，因为一个泛型类所有实例运行时具有相同的运行时类，其实际类型参数被擦除了。</bclass></bclass></aclass></aclass></p>
<p>那么是不是GenericClass里完全不存AClass的信息呢？这个也不是，它内部存储的是泛型向上父类的引用，比如：<br>GenericClass<aclass extends="" charsequence="">, 其编译后内部存储的泛型替代是Charsequence，而不是Object。</aclass></p>
<p>那么我们编码时的泛型的类型判断是怎么实现的呢？<br>其实这个过程是编译时检查的，也就是说限制gClassA.add(new BClass()) 这样的使用的方式的主体，不是运行时代码，而是编译时监测。</p>
<p>泛型的意义就在于，对所有其支持的类型参数，有相同的行为，从而可以被当作不同类型使用；类的静态变量和方法在所有实例间共享使用，所以不能使用泛型。</p>
<p>5、泛型与instanceof<br>泛型擦除了类型信息，所以使用instanceof检查某个实例是否是特定类型的泛型类是不可行的：<br>GenericClass genericClass = new GenericClass<string>();<br>if (genericClass instanceof GenericClass<string>) {} // 编译错误</string></string></p>
<p>同时：<br>GenericClass<string> class1 = (GenericClass<string>) genericClass； //会报警告</string></string></p>
<p>六、Class与泛型（摘自网络）<br>从Java1.5后Class类就改为了泛型实现，Class类内定义的泛型T指的是Class对象代表的类型。比如说String.class类型代表Class<string>，People.class类型代表Class<people>。<br>主要用于提高反射代码的类型安全。</people></string></p>
<p>Class类的newInstance返回泛型T的对象，故而可以在反射时创建更精确的类型。<br>举例来说：假定你要写一个工具方法来进行一个数据库查询，给定一个SQL语句，并返回一个数据库中符合查询条件<br>的对象集合(collection)。<br>一个方法是显式的传递一个工厂对象，像下面的代码：<br>[java] view plain copy<br>interface Factory<t> {<br>    public T[] make();<br>}<br>public <t> Collection<t> select(Factory<t> factory, String statement) {<br>     Collection<t> result = new ArrayList<t>();<br>     /<em> run sql query using jdbc </em>/<br>     for ( int i=0; i&lt;10; i++ ) { /<em> iterate over jdbc results </em>/<br>         T item = factory.make();<br>         /<em> use reflection and set all of item’s fields from sql results </em>/<br>         result.add( item );<br>      }<br>      return result;<br>}</t></t></t></t></t></t></p>
<p>你可以这样调用：<br>[java] view plain copy<br>select(new Factory<empinfo>() {<br>      public EmpInfo make() {<br>          return new EmpInfo();<br>      }<br>  } , ”selection string”);<br>也可以声明一个类 EmpInfoFactory 来支持接口 Factory：<br>[java] view plain copy<br>class EmpInfoFactory implements Factory<empinfo> {<br>      …<br>      public EmpInfo make() {<br>            return new EmpInfo();<br>      }<br>}<br>然后调用：<br>[java] view plain copy<br>select(getMyEmpInfoFactory(), “selection string”);</empinfo></empinfo></p>
<p>这个解决方案的缺点是它需要下面的二者之一：<br>调用处那冗长的匿名工厂类，或为每个要使用的类型声明一个工厂类并传递其对象给调用的地方<br>这很不自然。<br>使用class类型参数值是非常自然的，它可以被反射使用。没有泛型的代码可能是：<br>[java] view plain copy<br>Collection emps = sqlUtility.select(EmpInfo.class, ”select <em> from emps”);<br>…<br>public static Collection select(Class c, String sqlStatement) {<br>          Collection result = new ArrayList();<br>          /</em> run sql query using jdbc <em>/<br>          for ( /</em> iterate over jdbc results <em>/ ) {<br>                Object item = c.newInstance();<br>                /</em> use reflection and set all of item’s fields from sql results */<br>                result.add(item);<br>          }<br>          return result;<br>   }<br>}</p>
<p>但是这不能给我们返回一个我们要的精确类型的集合。现在Class是泛型的，我们可以写：<br>[java] view plain copy<br>Collection<empinfo> emps=sqlUtility.select(EmpInfo.class, ”select <em> from emps”);<br>…<br>public static <t> Collection<t> select(Class<t>c, String sqlStatement) {<br>     Collection<t> result = new ArrayList<t>();<br>     /</t></t></t></t></t></em> run sql query using jdbc <em>/<br>     for ( /</em> iterate over jdbc results <em>/ ) {<br>         T item = c.newInstance();<br>         /</em> use reflection and set all of item’s fields from sql results */<br>         result.add(item);<br>     }<br>     return result;<br>}</empinfo></p>
<p>籍此以类型安全的方式获取我们需要的集合。<br>这项技术是一个非常有用的技巧，在处理注释(annotations)的新API中被广泛使用。</p>
<p>七、容器与泛型<br>Java泛型的最深入人心的应用就是容器（Collections）了。容器不需要考虑它要装什么东西，它的职责就是表达它装的东西的集合所具有的功能。因此是天然的泛型支持者。<br>在没有泛型时，如果要封装一个列表，简化应该是这样的：<br>[java] view plain copy<br>public class ArrayList {<br>    Object[] array = new Object[10];<br>    int i = 0;<br>    public void add(Object object) {<br>          array[i++] = object;<br>    }</p>
<pre><code>public Object get(int index) {
      return array[index];
}
</code></pre><p>}</p>
<p>这意味着我们把元素存进去，取出来还要强转，类型安全无法保证（存入一个Integer再存一个Long，转出时强转成Integer就崩溃了）。用泛型可以在编译时保证不能存入非泛型支持的数据，保证类型安全。<br>按照我们之前说的，ArrayList内不存储泛型信息，而是存储泛型的最近父类，对ArrayList<t>而言就是Object，所以其内部代码是：<br>[java] view plain copy<br>public class ArrayList<t> {<br>    Object[] array = new Object[10];<br>    int i = 0;<br>    public void add(T object) {<br>          array[i++] = object;<br>    }</t></t></p>
<pre><code>public T get(int index) {
      return (T)array[index];
}
</code></pre><p>}</p>
<p>保证我们加进去和取出来的数据都是经过类型检查的。</p>
<p>八、总结<br>1、泛型是Java为类型安全而做的一个优化，它在内部保证了数据类型一致性，细化了可变参数的类型，且能更好的表示类型间的相关性。<br>2、泛型是编译时技术，其起作用的时机是编译时，完善的编译器会报告错误的泛型使用，保证代码不能编译通过。<br>3、平常写代码时，要认真思考是否有使用泛型的必要。通常来讲，如果方法或类描述的是数据类型无关的逻辑，且其数据类型可变时，则应该使用泛型。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/03/07/influxdb用法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/07/influxdb用法/" itemprop="url">influxdb用法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-07T15:57:59+08:00">
                2018-03-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/07/influxdb用法/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/03/07/influxdb用法/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  6
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><hr>
<p>influxdb是目前比较流行的时间序列数据库。</p>
<ul>
<li>何谓时间序列数据库？<br>什么是时间序列数据库，最简单的定义就是数据格式里包含Timestamp字段的数据，比如某一时间环境的温度，CPU的使用率等。但是，有什么数据不包含Timestamp呢？几乎所有的数据其实都可以打上一个Timestamp字段。时间序列数据的更重要的一个属性是如何去查询它，包括数据的过滤，计算等等。</li>
</ul>
<h4 id="Influxdb"><a href="#Influxdb" class="headerlink" title="Influxdb"></a>Influxdb</h4><p>Influxdb是一个开源的分布式时序、时间和指标数据库，使用go语言编写，无需外部依赖。<br>它有三大特性：</p>
<ol>
<li>时序性（Time Series）：与时间相关的函数的灵活使用（诸如最大、最小、求和等）；</li>
<li>度量（Metrics）：对实时大量数据进行计算；</li>
<li>事件（Event）：支持任意的事件数据，换句话说，任意事件的数据我们都可以做操作。</li>
</ol>
<p>同时，它有以下几大特点：</p>
<ul>
<li>schemaless(无结构)，可以是任意数量的列；</li>
<li>min, max, sum, count, mean, median 一系列函数，方便统计；</li>
<li>Native HTTP API, 内置http支持，使用http读写；</li>
<li>Powerful Query Language 类似sql；</li>
<li>Built-in Explorer 自带管理工具。</li>
</ul>
<h3 id="Influxdb安装"><a href="#Influxdb安装" class="headerlink" title="Influxdb安装"></a>Influxdb安装</h3><hr>
<blockquote>
<p>注：本文使用的influxdb version是1.0.2</p>
</blockquote>
<p>在讲解具体的安装步骤之前，先说说influxdb的两个http端口：8083和8086</p>
<ul>
<li>port 8083：管理页面端口，访问localhost:8083可以进入你本机的influxdb管理页面；</li>
<li>port 8086：http连接influxdb client端口，一般使用该端口往本机的influxdb读写数据。</li>
</ul>
<p><strong>OS X</strong></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">brew </span>update</span><br><span class="line"><span class="keyword">brew </span><span class="keyword">install </span>influxdb</span><br></pre></td></tr></table></figure>
<p><strong>Docker Image</strong></p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker pull influxdb</span></span><br></pre></td></tr></table></figure>
<p><strong>Ubuntu &amp; Debian</strong></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http<span class="variable">s:</span>//<span class="keyword">dl</span>.influxdata.<span class="keyword">com</span>/influxdb/releases/influxdb_1.<span class="number">0.2</span>_amd64.<span class="keyword">deb</span></span><br><span class="line">sudo dpkg -i influxdb_1.<span class="number">0.2</span>_amd64.<span class="keyword">deb</span></span><br></pre></td></tr></table></figure>
<p><strong>RedHat &amp; CentOS</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="comment">//dl.influxdata.com/influxdb/releases/influxdb-1.0.2.x86_64.rpm</span></span><br><span class="line">sudo yum localinstall influxdb-<span class="number">1.0</span>.<span class="number">2</span><span class="selector-class">.x86_64</span><span class="selector-class">.rpm</span></span><br></pre></td></tr></table></figure>
<p><strong>Standalone Linux Binaries (64-bit)</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="comment">//dl.influxdata.com/influxdb/releases/influxdb-1.0.2_linux_amd64.tar.gz</span></span><br><span class="line">tar xvfz influxdb-<span class="number">1.0</span>.<span class="number">2</span>_linux_amd64<span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br></pre></td></tr></table></figure>
<p><strong>Standalone Linux Binaries (32-bit)</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="comment">//dl.influxdata.com/influxdb/releases/influxdb-1.0.2_linux_i386.tar.gz</span></span><br><span class="line">tar xvfz influxdb-<span class="number">1.0</span>.<span class="number">2</span>_linux_i386<span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br></pre></td></tr></table></figure>
<p><strong>Standalone Linux Binaries (ARM)</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="comment">//dl.influxdata.com/influxdb/releases/influxdb-1.0.2_linux_armhf.tar.gz</span></span><br><span class="line">tar xvfz influxdb-<span class="number">1.0</span>.<span class="number">2</span>_linux_armhf<span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br></pre></td></tr></table></figure>
<p><strong>How to start？</strong><br>安装完之后，如何启动呢？</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo<span class="built_in"> service </span>influxdb start</span><br></pre></td></tr></table></figure>
<p>到这里influxdb安装启动完成，可以访问influxdb管理页面：<a href="https://link.jianshu.com?t=http://localhost:8083" target="_blank" rel="external">本地管理页面</a>，该版本没有登录用户及密码，可以自行设置读写的用户名和密码。</p>
<p><strong>如何在命令行使用</strong><br>安装完毕之后，如何在命令行使用呢？</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3994601-9cc22a93bb379d76.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/573" alt="img"></p>
<p>influxdb在命令行中使用</p>
<h3 id="influxdb基本操作"><a href="#influxdb基本操作" class="headerlink" title="influxdb基本操作"></a>influxdb基本操作</h3><hr>
<h4 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h4><p>在具体的讲解influxdb的相关操作之前先说说influxdb的一些专有名词，这些名词代表什么。</p>
<h5 id="influxdb相关名词"><a href="#influxdb相关名词" class="headerlink" title="influxdb相关名词"></a>influxdb相关名词</h5><ul>
<li>database：数据库；</li>
<li>measurement：数据库中的表；</li>
<li>points：表里面的一行数据。</li>
</ul>
<h5 id="influxDB中独有的一些概念"><a href="#influxDB中独有的一些概念" class="headerlink" title="influxDB中独有的一些概念"></a>influxDB中独有的一些概念</h5><p>Point由<strong>时间戳</strong>（time）、<strong>数据</strong>（field）和<strong>标签</strong>（tags）组成。</p>
<ul>
<li>time：每条数据记录的时间，也是数据库自动生成的主索引；</li>
<li>fields：各种记录的值；</li>
<li>tags：各种有索引的属性。</li>
</ul>
<p>还有一个重要的名词：<strong>series</strong><br>所有在数据库中的数据，都需要通过图表来表示，series表示这个表里面的所有的数据可以在图标上画成几条线（注：线条的个数由tags排列组合计算出来）<br>举个简单的小栗子：<br>有如下数据：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3994601-f528ff65d64cf860.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/569" alt="img"></p>
<p>error_time</p>
<p>它的series为：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3994601-cb52cbd8bf20d41b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/569" alt="img"></p>
<p>error_time_series</p>
<h4 id="influxdb基本操作-1"><a href="#influxdb基本操作-1" class="headerlink" title="influxdb基本操作"></a>influxdb基本操作</h4><ul>
<li><strong>数据库与表的操作</strong><br>可以直接在web管理页面做操作，当然也可以命令行。</li>
</ul>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#创建数据库</span></span><br><span class="line">create database <span class="string">"db_name"</span></span><br><span class="line"><span class="meta">#显示所有的数据库</span></span><br><span class="line">show databases</span><br><span class="line"><span class="meta">#删除数据库</span></span><br><span class="line">drop database <span class="string">"db_name"</span></span><br><span class="line"><span class="meta">#使用数据库</span></span><br><span class="line">use db_name</span><br><span class="line"><span class="meta">#显示该数据库中所有的表</span></span><br><span class="line">show measurements</span><br><span class="line"><span class="meta">#创建表，直接在插入数据的时候指定表名</span></span><br><span class="line">insert test,host=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>,monitor_name=test count=<span class="number">1</span></span><br><span class="line"><span class="meta">#删除表</span></span><br><span class="line">drop measurement <span class="string">"measurement_name"</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>增</p>
<p>​</p>
<p>向数据库中插入数据。</p>
<ul>
<li>通过命令行</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> testDb</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">test</span>,host=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>,monitor_name=<span class="keyword">test</span> <span class="keyword">count</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通过http接口</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -<span class="selector-tag">i</span> -XPOST <span class="string">'http://127.0.0.1:8086/write?db=testDb'</span> --data-binary <span class="string">'test,host=127.0.0.1,monitor_name=test count=1'</span></span><br></pre></td></tr></table></figure>
<p>读者看到这里可能会观察到插入的数据的格式貌似比较奇怪，这是因为influxDB存储数据采用的是Line Protocol格式。那么何谓Line Protoco格式？</p>
<p><strong>Line Protocol格式：</strong>写入数据库的Point的固定格式。<br>在上面的两种插入数据的方法中都有这样的一部分：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test,host=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>,monitor_name=test count=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ol>
<li>test：表名；</li>
<li>host=127.0.0.1,monitor_name=test：tag；</li>
<li>count=1：field</li>
</ol>
<p>想对此格式有详细的了解参见<a href="https://link.jianshu.com?t=https://docs.influxdata.com/influxdb/v0.10/write_protocols/line/" target="_blank" rel="external">官方文档</a></p>
<ul>
<li><p>查</p>
<p>​</p>
<p>查询数据库中的数据。</p>
<ul>
<li>通过命令行</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">time</span> <span class="keyword">desc</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通过http接口</li>
</ul>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -G 'http:<span class="string">//localhost</span><span class="function">:8086</span>/query?pretty=<span class="literal">true</span>' <span class="params">--data-urlencode</span> <span class="string">"db=testDb"</span> <span class="params">--data-urlencode</span> <span class="string">"q=select * from test order by time desc"</span></span><br></pre></td></tr></table></figure>
<p>influxDB是支持类sql语句的，具体的查询语法都差不多，这里就不再做详细的赘述了。</p>
<ul>
<li><strong>数据保存策略（Retention Policies）</strong><br>influxDB是没有提供直接删除数据记录的方法，但是提供数据保存策略，主要用于指定数据保留时间，超过指定时间，就删除这部分数据。<ul>
<li>查看当前数据库Retention Policies</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">retention</span> policies <span class="keyword">on</span> <span class="string">"db_name"</span></span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/3994601-4dbf9942cc0f671a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/574" alt="img"></p>
<p>retention_policies</p>
<ul>
<li>创建新的Retention Policies</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create retention<span class="built_in"> policy </span><span class="string">"rp_name"</span> on <span class="string">"db_name"</span> duration 3w replication 1 default</span><br></pre></td></tr></table></figure>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">  rp_name：策略名；</span></span><br><span class="line"><span class="ruby">- db_name：具体的数据库名；</span></span><br><span class="line"><span class="ruby">- <span class="number">3</span>w：保存<span class="number">3</span>周，<span class="number">3</span>周之前的数据将被删除，influxdb具有各种事件参数，比如：h（小时），d（天），w（星期）；</span></span><br><span class="line"><span class="ruby">- replication <span class="number">1</span>：副本个数，一般为<span class="number">1</span>就可以了；</span></span><br><span class="line"><span class="ruby">- default：设置为默认策略</span></span><br></pre></td></tr></table></figure>
<ul>
<li>修改Retention Policies</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter retention<span class="built_in"> policy </span><span class="string">"rp_name"</span> on <span class="string">"db_name"</span> duration 30d default</span><br></pre></td></tr></table></figure>
<ul>
<li>删除Retention Policies</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop retention<span class="built_in"> policy </span><span class="string">"rp_name"</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>连续查询（Continous Queries）</p>
<p>​</p>
<p>当数据超过保存策略里指定的时间之后就会被删除，但是这时候可能并不想数据被完全删掉，怎么办？</p>
<p>​</p>
<p>influxdb提供了联系查询，可以做数据统计采样。</p>
<ul>
<li>查看数据库的Continous Queries</li>
</ul>
</li>
</ul>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">show continuous queries</span></span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/3994601-d0d2b55ee261869d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/440" alt="img"></p>
<p>continuous_queries.</p>
<ul>
<li>创建新的Continous Queries</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> continous <span class="keyword">query</span> cq_name <span class="keyword">on</span> db_name <span class="keyword">begin</span> <span class="keyword">select</span> <span class="keyword">sum</span>(<span class="keyword">count</span>) <span class="keyword">into</span> new_table_name <span class="keyword">from</span> table_name <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">time</span>(<span class="number">30</span>m) <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"> cq_name：连续查询名字；</span></span><br><span class="line"><span class="ruby">- db_name：数据库名字；</span></span><br><span class="line"><span class="ruby">- sum(count)：计算总和；</span></span><br><span class="line"><span class="ruby">- table_name：当前表名；</span></span><br><span class="line"><span class="ruby">- new_table_name：存新的数据的表名；</span></span><br><span class="line"><span class="ruby">- <span class="number">30</span>m：时间间隔为<span class="number">30</span>分钟</span></span><br></pre></td></tr></table></figure>
<ul>
<li>删除Continous Queries</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> continous <span class="keyword">query</span> cp_name <span class="keyword">on</span> db_name</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>用户管理</strong><br>可以直接在web管理页面做操作，也可以命令行。</li>
</ul>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#显示用户</span><br><span class="line">show users</span><br><span class="line">#创建用户</span><br><span class="line">create user <span class="string">"username"</span> <span class="keyword">with</span> password <span class="string">'password'</span></span><br><span class="line">#创建管理员权限用户create user <span class="string">"username"</span> <span class="keyword">with</span> password <span class="string">'password'</span> <span class="keyword">with</span> all privileges</span><br><span class="line">#删除用户</span><br><span class="line">drop user <span class="string">"username"</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/03/06/Java内存模型/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/06/Java内存模型/" itemprop="url">Java内存模型FAQ</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-06T15:22:44+08:00">
                2018-03-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java基础/" itemprop="url" rel="index">
                    <span itemprop="name">java基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/06/Java内存模型/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/03/06/Java内存模型/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  23
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="什么是内存模型"><a href="#什么是内存模型" class="headerlink" title="什么是内存模型"></a>什么是内存模型</h1><p><a href="http://www.cs.umd.edu/~pugh/java/memoryModel/jsr-133-faq.html" target="_blank" rel="external">http://www.cs.umd.edu/~pugh/java/memoryModel/jsr-133-faq.html</a></p>
<p>在多核系统中，处理器一般有一层或者多层的缓存，这些的缓存通过加速数据访问（因为数据距离处理器更近）和降低共享内存在总线上的通讯（因为本地缓存能够满足许多内存操作）来提高CPU性能。缓存能够大大提升性能，但是它们也带来了许多挑战。例如，当两个CPU同时检查相同的内存地址时会发生什么？在什么样的条件下它们会看到相同的值？</p>
<p>在处理器层面上，内存模型定义了一个充要条件，<strong>“让当前的处理器可以看到其他处理器写入到内存的数据”以及其他处理器可以看到当前处理器写入到内存的数据”</strong>。有些处理器有<strong>很强的内存模型(strong memory model)</strong>，能够让所有的处理器在任何时候任何指定的内存地址上都可以看到完全相同的值。而另外一些处理器则<strong>有较弱的内存模型（weaker memory model）</strong>，在这种处理器中，必须使用<strong>内存屏障（一种特殊的指令）</strong>来<u>刷新本地处理器缓存并使本地处理器缓存无效</u>，目的是为了让当前处理器能够看到其他处理器的写操作或者让其他处理器能看到当前处理器的写操作。这些内存屏障通常在lock和unlock操作的时候完成。内存屏障在高级语言中对程序员是不可见的。</p>
<p>在强内存模型下，有时候编写程序可能会更容易，因为减少了对内存屏障的依赖。但是即使在一些最强的内存模型下，内存屏障仍然是必须的。设置内存屏障往往与我们的直觉并不一致。<u>近来处理器设计的趋势更倾向于弱的内存模型，因为弱内存模型削弱了缓存一致性</u>，所以在多处理器平台和更大容量的内存下可以实现更好的可伸缩性</p>
<p>“一个线程的写操作对其他线程可见”这个问题是因为编译器对代码进行重排序导致的。<strong>例如，只要代码移动不会改变程序的语义，当编译器认为程序中移动一个写操作到后面会更有效的时候，编译器就会对代码进行移动。</strong>如果编译器推迟执行一个操作，其他线程可能在这个操作执行完之前都不会看到该操作的结果，这反映了缓存的影响。</p>
<p><strong>此外，写入内存的操作能够被移动到程序里更前的时候。在这种情况下，其他的线程在程序中可能看到一个比它实际发生更早的写操作。</strong>所有的这些灵活性的设计是为了通过给编译器，运行时或硬件灵活性使其能在最佳顺序的情况下来执行操作。在内存模型的限定之内，我们能够获取到更高的性能。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Class Reordering &#123;</span><br><span class="line">  <span class="keyword">int</span> x = <span class="number">0</span>, y = <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    x = <span class="number">1</span>;</span><br><span class="line">    y = <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> r1 = y;</span><br><span class="line">    <span class="keyword">int</span> r2 = x;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>让我们看在两个并发线程中执行这段代码，读取<em>Y</em>变量将会得到2这个值。因为这个写入比写到<em>X</em>变量更晚一些，程序员可能认为读取<em>X</em>变量将肯定会得到1。<strong>但是，写入操作可能被重排序过。</strong>如果重排序发生了，那么，就能发生对<em>Y</em>变量的写入操作，读取两个变量的操作紧随其后，而且写入到X这个操作能发生。程序的结果可能是r1变量的值是2，但是r2变量的值为0。</p>
<p>Java内存模型描述了在多线程代码中哪些行为是合法的，以及线程如何通过内存进行交互。它描述了“程序中的变量“ 和 ”从内存或者寄存器获取或存储它们的底层细节”之间的关系。Java内存模型通过使用各种各样的硬件和编译器的优化来正确实现以上事情。</p>
<p>Java包含了几个语言级别的关键字，包括：<strong>volatile, final以及synchronized，目的是为了帮助程序员向编译器描述一个程序的并发需求</strong>。Java内存模型定义了volatile和synchronized的行为，更重要的是保证了同步的java程序在所有的处理器架构下面都能正确的运行。</p>
<h1 id="其他语言，像C-，也有内存模型吗"><a href="#其他语言，像C-，也有内存模型吗" class="headerlink" title="其他语言，像C++，也有内存模型吗"></a>其他语言，像C++，也有内存模型吗</h1><p>大部分其他的语言，像C和C++，都没有被设计成直接支持多线程。这些语言对于发生在编译器和处理器平台架构的重排序行为的保护机制会严重的依赖于程序中所使用的线程库（例如pthreads），编译器，以及代码所运行的平台所提供的保障。</p>
<p>#JSR133是什么</p>
<p>从1997年以来，人们不断发现Java语言规范的17章定义的Java内存模型中的一些严重的缺陷。这些缺陷会导致一些使人迷惑的行为（例如final字段会被观察到值的改变）和破坏编译器常见的优化能力。</p>
<p>Java内存模型是一个雄心勃勃的计划，它是编程语言规范第一次尝试合并一个能够在各种处理器架构中为并发提供一致语义的内存模型。不过，定义一个既一致又直观的内存模型远比想象要更难。JSR133为Java语言定义了一个新的内存模型，它修复了早期内存模型中的缺陷。为了实现JSR133，final和volatile的语义需要重新定义。</p>
<p>完整的语义见：<a href="http://www.cs.umd.edu/users/pugh/java/memoryModel" target="_blank" rel="external">http://www.cs.umd.edu/users/pugh/java/memoryModel</a>，但是正式的语义不是小心翼翼的，它是令人惊讶和清醒的，目的是让人意识到一些看似简单的概念（如同步）其实有多复杂。幸运的是，你不需要懂得这些正式语义的细节——JSR133的目的是创建一组正式语义，这些正式语义提供了volatile、synchronzied和final如何工作的直观框架。</p>
<p>JSR 133的目标包含了：</p>
<ul>
<li>保留已经存在的安全保证（像类型安全）以及强化其他的安全保证。例如，变量值不能凭空创建：线程观察到的每个变量的值必须是被其他线程合理的设置的。</li>
</ul>
<ul>
<li>正确同步的程序的语义应该尽量简单和直观。</li>
</ul>
<ul>
<li>应该定义未完成或者未正确同步的程序的语义，主要是为了把潜在的安全危害降到最低。</li>
</ul>
<ul>
<li>程序员应该能够自信的推断多线程程序如何同内存进行交互的。</li>
</ul>
<ul>
<li>能够在现在许多流行的硬件架构中设计正确以及高性能的JVM实现。</li>
</ul>
<ul>
<li>应该能提供 <em>安全地初始化</em>的保证。如果一个对象正确的构建了（意思是它的引用没有在构建的时候逸出，那么所有能够看到这个对象的引用的线程，在不进行同步的情况下，也将能看到在构造方法中中设置的final字段的值。</li>
</ul>
<ul>
<li>应该尽量不影响现有的代码</li>
</ul>
<h1 id="重排序意味着什么？"><a href="#重排序意味着什么？" class="headerlink" title="重排序意味着什么？"></a>重排序意味着什么？</h1><p>在很多情况下，访问一个程序变量（对象实例字段，类静态字段和数组元素）可能会使用不同的顺序执行，而不是程序语义所指定的顺序执行。编译器能够自由的以优化的名义去改变指令顺序。在特定的环境下，处理器可能会次序颠倒的执行指令。数据可能在寄存器，处理器缓冲区和主内存中以不同的次序移动，而不是按照程序指定的顺序。</p>
<p>例如，<strong>如果一个线程写入值到字段a，然后写入值到字段b，而且b的值不依赖于a的值，那么，处理器就能够自由的调整它们的执行顺序，而且缓冲区能够在a之前刷新b的值到主内存。</strong>有许多潜在的重排序的来源，例如编译器，JIT以及缓冲区。</p>
<p><strong>编译器，运行时和硬件被期望一起协力创建好像是顺序执行的语义的假象，这意味着在单线程的程序中，程序应该是不能够观察到重排序的影响的。</strong><u>但是，重排序在没有正确同步了的多线程程序中开始起作用，在这些多线程程序中，一个线程能够观察到其他线程的影响，也可能检测到其他线程将会以一种不同于程序语义所规定的执行顺序来访问变量。</u></p>
<p>大部分情况下，一个线程不会关注其他线程正在做什么，<strong>但是当它需要关注的时候，这时候就需要同步了。</strong></p>
<h1 id="旧的内存模型有什么问题"><a href="#旧的内存模型有什么问题" class="headerlink" title="旧的内存模型有什么问题"></a>旧的内存模型有什么问题</h1><p>旧的内存模型中有几个严重的问题。这些问题很难理解，因此被广泛的违背。例如，旧的存储模型在许多情况下，不允许JVM发生各种重排序行为。旧的内存模型中让人产生困惑的因素造就了JSR-133规范的诞生。</p>
<p>例如，一个被广泛认可的概念就是，如果使用final字段，那么就没有必要在多个线程中使用同步来保证其他线程能够看到这个字段的值。尽管这是一个合理的假设和明显的行为，也是我们所期待的结果。实际上，在旧的内存模型中，我们想让程序正确运行起来却是不行的。<strong>在旧的内存模型中，final字段并没有同其他字段进行区别对待</strong>——这意味着同步是保证所有线程看到一个在构造方法中初始化的final字段的唯一方法。结果——如果没有正确同步的话，对一个线程来说，它可能看到一个字段的默认值，然后在稍后的时间里，又能够看到构造方法中设置的值。这意味着，一些不可变的对象，例如String，能够改变它们值——这实在很让人郁闷。</p>
<p>旧的内存模型允许volatile变量的写操作和非volaitle变量的读写操作一起进行重排序，这和大多数的开发人员对于volatile变量的直观感受是不一致的，因此会造成迷惑。</p>
<p>最后，我们将看到的是，程序员对于程序没有被正确同步的情况下将会发生什么的直观感受通常是错误的。JSR-133的目的之一就是要引起这方面的注意。</p>
<p>There were several serious problems with the old memory model. It was difficult to understand, and therefore widely violated. For example, the old model did not, in many cases, allow the kinds of reorderings that took place in every JVM. This confusion about the implications of the old model was what compelled the formation of JSR-133.</p>
<p>One widely held belief, for example, was that if final fields were used, then synchronization between threads was unnecessary to guarantee another thread would see the value of the field. While this is a reasonable assumption and a sensible behavior, and indeed how we would want things to work, under the old memory model, it was simply not true. <strong>Nothing in the old memory model treated final fields differently from any other field — meaning synchronization was the only way to ensure that all threads see the value of a final field that was written by the constructor.</strong> As a result, it was possible for a thread to see the default value of the field, and then at some later time see its constructed value. This means, for example, that immutable objects like String can appear to change their value — a disturbing prospect indeed.</p>
<p>The old memory model allowed for volatile writes to be reordered with nonvolatile reads and writes, which was not consistent with most developers intuitions about volatile and therefore caused confusion.</p>
<p>Finally, as we shall see, programmers’ intuitions about what can occur when their programs are incorrectly synchronized are often mistaken. One of the goals of JSR-133 is to call attention to this fact.</p>
<h1 id="没有正确同步的含义是什么"><a href="#没有正确同步的含义是什么" class="headerlink" title="没有正确同步的含义是什么"></a>没有正确同步的含义是什么</h1><p>没有正确同步的代码对于不同的人来说可能会有不同的理解。在Java内存模型这个语义环境下，我们谈到“没有正确同步”，我们的意思是：</p>
<ol>
<li>一个线程中有一个对变量的写操作，</li>
<li>另外一个线程对同一个变量有读操作，</li>
<li>而且写操作和读操作没有通过同步来保证顺序。</li>
</ol>
<p>当这些规则被违反的时候，我们就说在这个变量上有一个“数据竞争”(data race)。一个有数据竞争的程序就是一个没有正确同步的程序。</p>
<p>Incorrectly synchronized code can mean different things to different people. When we talk about incorrectly synchronized code in the context of the Java Memory Model, we mean any code where</p>
<ol>
<li>there is a write of a variable by one thread,</li>
<li>there is a read of the same variable by another thread and</li>
<li>the write and read are not ordered by synchronization</li>
</ol>
<p>When these rules are violated, we say we have a <em>data race</em> on that variable. <strong>A program with a data race is an incorrectly synchronized program.</strong></p>
<h1 id="同步会干些什么呢"><a href="#同步会干些什么呢" class="headerlink" title="同步会干些什么呢"></a>同步会干些什么呢</h1><p>同步有几个方面的作用。最广为人知的就是互斥 ——一次只有一个线程能够获得一个监视器，因此，在一个监视器上面同步意味着一旦一个线程进入到监视器保护的同步块中，其他的线程都不能进入到同一个监视器保护的块中间，除非第一个线程退出了同步块。</p>
<p>但是同步的含义比互斥更广。同步保证了一个线程在同步块之前或者在同步块中的一个内存写入操作以可预知的方式对其他有相同监视器的线程可见。当我们退出了同步块，我们就<strong>释放</strong>了这个监视器，这个监视器有刷新缓冲区到主内存的效果，因此该线程的写入操作能够为其他线程所见。<strong>在我们进入一个同步块之前，我们需要获取监视器，监视器有使本地处理器缓存失效的功能，因此变量会从主存重新加载，于是其它线程对共享变量的修改对当前线程来说就变得可见了。</strong></p>
<p>依据缓存来讨论同步，可能听起来这些观点仅仅会影响到多处理器的系统。但是，重排序效果能够在单一处理器上面很容易见到。对编译器来说，在获取之前或者释放之后移动你的代码是不可能的。当我们谈到在缓冲区上面进行的获取和释放操作，我们使用了简述的方式来描述大量可能的影响。</p>
<p>新的内存模型语义在内存操作（读取字段，写入字段，锁，解锁）以及其他线程的操作（start 和 join）中创建了一个部分排序，在这些操作中，一些操作被称为<em>happen before</em>其他操作。当一个操作在另外一个操作之前发生，第一个操作保证能够排到前面并且对第二个操作可见。这些排序的规则如下：</p>
<ul>
<li>线程中的每个操作<em>happens before</em>该线程中在程序顺序上后续的每个操作。</li>
</ul>
<ul>
<li>解锁一个监视器的操作<em>happens before</em>随后对<strong>相同</strong>监视器进行锁的操作。</li>
</ul>
<ul>
<li>对volatile字段的写操作<em>happens **before</em>后续对<strong>相同</strong>volatile字段的读取操作。</li>
</ul>
<ul>
<li>线程上调用start()方法<em>happens **before</em>这个线程启动后的任何操作。</li>
</ul>
<ul>
<li>一个线程中所有的操作都<em>happens before</em>从这个线程join()方法成功返回的任何其他线程。（注意思是其他线程等待一个线程的jion()方法完成，那么，这个线程中的所有操作<em>happens **before</em>其他线程中的所有操作）</li>
</ul>
<p>这意味着：任何内存操作，这个内存操作在退出一个同步块前对一个线程是可见的，对任何线程在它进入一个被相同的监视器保护的同步块后都是可见的，因为所有内存操作happens before释放监视器以及释放监视器happens before获取监视器。</p>
<p>其他如下模式的实现被一些人用来强迫实现一个内存屏障的，不会生效：</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (<span class="keyword">new</span> <span class="keyword">Object</span>()) &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码其实不会执行任何操作，你的编译器会把它完全移除掉，因为编译器知道没有其他的线程会使用相同的监视器进行同步。要看到其他线程的结果，你必须为一个线程建立happens before关系。</p>
<p><strong>重点注意</strong>：对两个线程来说，为了正确建立happens before关系而在相同监视器上面进行同步是非常重要的。以下观点是错误的：当线程A在对象X上面同步的时候，所有东西对线程A可见，线程B在对象Y上面进行同步的时候，所有东西对线程B也是可见的。释放监视器和获取监视器必须匹配（也就是说要在相同的监视器上面完成这两个操作），否则，代码就会存在“数据竞争”。</p>
<p>Synchronization has several aspects. The most well-understood is mutual exclusion — only one thread can hold a monitor at once, so synchronizing on a monitor means that once one thread enters a synchronized block protected by a monitor, no other thread can enter a block protected by that monitor until the first thread exits the synchronized block.</p>
<p>But there is more to synchronization than mutual exclusion. Synchronization ensures that memory writes by a thread before or during a synchronized block are made visible in a predictable manner to other threads which synchronize on the same monitor. <u>After we exit a synchronized block, we <strong>release </strong>the monitor, which has the effect of flushing the cache to main memory, so that writes made by this thread can be visible to other threads.</u> <strong>Before we can enter a synchronized block, we acquire the monitor, which has the effect of invalidating the local processor cache so that variables will be reloaded from main memory.</strong> We will then be able to see all of the writes made visible by the previous release.</p>
<p>Discussing this in terms of caches, it may sound as if these issues only affect multiprocessor machines. However, the reordering effects can be easily seen on a single processor. It is not possible, for example, for the compiler to move your code before an acquire or after a release. When we say that acquires and releases act on caches, we are using shorthand for a number of possible effects.</p>
<p>The new memory model semantics create a partial ordering on memory operations (read field, write field, lock, unlock) and other thread operations (start and join), where some actions are said to <em>happen before</em> other operations. When one action happens before another, the first is guaranteed to be ordered before and visible to the second. The rules of this ordering are as follows:</p>
<ul>
<li>Each action in a thread happens before every action in that thread that comes later in the program’s order.</li>
<li>An <strong>unlock</strong> on a monitor happens before every subsequent <strong>lock</strong> on <strong>that same</strong> monitor.</li>
<li>A <strong>write to a volatile</strong> field happens before every subsequent <strong>read</strong> of <strong>that same</strong> volatile.</li>
<li>A call to <code>start()</code> on a thread happens before any actions in the started thread.</li>
<li>All actions in a thread happen before any other thread successfully returns from a <code>join()</code>on that thread.</li>
</ul>
<p>This means that any memory operations which were visible to a thread before exiting a synchronized block are visible to any thread after it enters a synchronized block protected by the same monitor, since all the memory operations happen before the release, and the release happens before the acquire.</p>
<p>Another implication is that the following pattern, which some people use to force a memory barrier, doesn’t work:</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (<span class="keyword">new</span> <span class="keyword">Object</span>()) &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>This is actually a no-op, and your compiler can remove it entirely, because the compiler knows that no other thread will synchronize on the same monitor. You have to set up a happens-before relationship for one thread to see the results of another.</p>
<p><strong>Important Note:</strong> Note that it is important for both threads to synchronize on the same monitor in order to set up the happens-before relationship properly. It is not the case that everything visible to thread A when it synchronizes on object X becomes visible to thread B after it synchronizes on object Y. The release and acquire have to “match” (i.e., be performed on the same monitor) to have the right semantics. Otherwise, the code has a data race.</p>
<h1 id="在新的Java内存模型中，final字段是如何工作的"><a href="#在新的Java内存模型中，final字段是如何工作的" class="headerlink" title="在新的Java内存模型中，final字段是如何工作的"></a>在新的Java内存模型中，final字段是如何工作的</h1><h1 id="How-can-final-fields-appear-to-change-their-values"><a href="#How-can-final-fields-appear-to-change-their-values" class="headerlink" title="How can final fields appear to change their values?"></a>How can final fields appear to change their values?</h1><p>One of the best examples of how final fields’ values can be seen to change involves one particular implementation of the <code>String</code> class.</p>
<p>A <code>String</code> can be implemented as an object with three fields — a character array, an offset into that array, and a length. The rationale for implementing <code>String</code> this way, instead of having only the character array, is that it lets multiple <code>String</code> and <code>StringBuffer</code>objects share the same character array and avoid additional object allocation and copying. So, for example, the method <code>String.substring()</code> can be implemented by creating a new string which shares the same character array with the original <code>String</code> and merely differs in the length and offset fields. For a <code>String</code>, these fields are all final fields.</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">String </span><span class="built_in">s1</span> = <span class="string">"/usr/tmp"</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">String </span><span class="built_in">s2</span> = <span class="built_in">s1</span>.<span class="keyword">substring(4);</span></span><br></pre></td></tr></table></figure>
<p>The string <code>s2</code> will have an offset of 4 and a length of 4. But, under the old model, it was possible for another thread to see the offset as having the default value of 0, and then later see the correct value of 4, it will appear as if the string “/usr” changes to “/tmp”.</p>
<p>The original Java Memory Model allowed this behavior; several JVMs have exhibited this behavior. The new Java Memory Model makes this illegal.</p>
<p>一个对象的final字段值是在它的构造方法里面设置的。假设对象被正确的构造了，一旦对象被构造，在构造方法里面设置给final字段的的值在没有同步的情况下对所有其他的线程都会可见。另外，引用这些final字段的对象或数组都将会看到final字段的最新值。</p>
<p>对一个对象来说，被正确的构造是什么意思呢？简单来说，它意味着这个正在构造的对象的引用在构造期间没有被允许逸出。（参见<a href="http://www.ibm.com/developerworks/java/library/j-jtp0618/index.html" target="_blank" rel="external">安全构造技术</a>）。换句话说，不要让其他线程在其他地方能够看见一个构造期间的对象引用。不要指派给一个静态字段，不要作为一个listener注册给其他对象等等。这些操作应该在构造方法之后完成，而不是构造方法中来完成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FinalFieldExample</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> x;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">static</span> FinalFieldExample f;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">FinalFieldExample</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    x = <span class="number">3</span>;</span><br><span class="line">    y = <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    f = <span class="keyword">new</span> FinalFieldExample();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (f != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">int</span> i = f.x;</span><br><span class="line">      <span class="keyword">int</span> j = f.y;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的类展示了final字段应该如何使用。一个正在执行reader方法的线程保证看到f.x的值为3，因为它是final字段。它不保证看到f.y的值为4，因为f.y不是final字段。如果FinalFieldExample的构造方法像这样：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FinalFieldExample</span>(<span class="params"></span>) </span>&#123; <span class="comment">// bad!</span></span><br><span class="line">  x = <span class="number">3</span>;</span><br><span class="line">  y = <span class="number">4</span>;</span><br><span class="line">  <span class="comment">// bad construction - allowing this to escape</span></span><br><span class="line">  <span class="keyword">global</span>.obj = <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么，从global.obj中读取this的引用线程不会保证读取到的x的值为3。</p>
<p>能够看到字段的正确的构造值固然不错，但是，如果字段本身就是一个引用，那么，你还是希望你的代码能够看到引用所指向的这个对象（或者数组）的最新值。如果你的字段是final字段，那么这是能够保证的。因此，当一个final指针指向一个数组，你不需要担心线程能够看到引用的最新值却看不到引用所指向的数组的最新值。重复一下，这儿的“正确的”的意思是“对象构造方法结尾的最新的值”而不是“最新可用的值”。</p>
<p>现在，在讲了如上的这段之后，如果在一个线程构造了一个不可变对象之后（对象仅包含final字段），你希望保证这个对象被其他线程正确的查看，你仍然需要使用同步才行。例如，没有其他的方式可以保证不可变对象的引用将被第二个线程看到。使用final字段的程序应该仔细的调试，这需要深入而且仔细的理解并发在你的代码中是如何被管理的。</p>
<p>如果你使用JNI来改变你的final字段，这方面的行为是没有定义的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/03/05/mac-中文版man安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/05/mac-中文版man安装/" itemprop="url">mac 中文版man安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-05T10:23:19+08:00">
                2018-03-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/运维/" itemprop="url" rel="index">
                    <span itemprop="name">运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/05/mac-中文版man安装/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/03/05/mac-中文版man安装/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  906
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  3
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Mac-10-13-安装中文版-man-命令"><a href="#Mac-10-13-安装中文版-man-命令" class="headerlink" title="Mac 10.13 安装中文版 man 命令"></a>Mac 10.13 安装中文版 man 命令</h1><p>本文参考于 《<a href="http://www.jianshu.com/p/5e35202fc59c" target="_blank" rel="external">Mac 安装man命令中文文档</a>》，但原文提供的链接以及安装的版本比较老旧。因此重新整理新版在这边提供给大家。</p>
<h2 id="为什么需要-man-以及-man-怎么使用"><a href="#为什么需要-man-以及-man-怎么使用" class="headerlink" title="为什么需要 man 以及 man 怎么使用"></a>为什么需要 man 以及 man 怎么使用</h2><p><code>linux</code> 或者 <code>mac</code> 系统的命令行工具非常多，可是我们不能记住所有的这些命令，通常只能记住一些我们常用的。遇到不常用的我们需要来查询一下这个命令是怎么使用的。这时候我们就需要使用到 <code>man</code> 命令了。</p>
<p>使用方法也非常简单，例如我们不清楚 <code>ls</code> 这个命令的使用方法，我们就可以在命令行中输入</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">man</span> ls1</span><br></pre></td></tr></table></figure>
<p>来查看这个命令的详情。</p>
<p>但是默认情况下，输出的内容是英文的。可能很多英文不好的朋友希望有中文版本的 <code>man</code> ，这篇博文就是告诉大家，如何在 <code>mac</code>上安装中文版本的的 <code>man</code>。</p>
<p>至于 <code>linux</code> 系统则非常简单，查看 <a href="https://github.com/man-pages-zh/manpages-zh" target="_blank" rel="external">https://github.com/man-pages-zh/manpages-zh</a> 中对应的版本，即可用简单的命令安装。</p>
<h2 id="下载-manpages-zh-编辑安装"><a href="#下载-manpages-zh-编辑安装" class="headerlink" title="下载 manpages-zh 编辑安装"></a>下载 manpages-zh 编辑安装</h2><p>首先，我们打开上面的 <code>github</code> 地址，点击 <code>releases</code> 下载最新版本的 <code>tar.gz</code> 源码包。目前我下载到的是 <code>1.6.3.2</code> 版本的。</p>
<p>因为需要编译安装，所以你电脑上需要有编译工具，运行下面两个命令安装</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">brew </span><span class="keyword">install </span>automake</span><br><span class="line"><span class="keyword">brew </span><span class="keyword">install </span>opencc12</span><br></pre></td></tr></table></figure>
<p>我这边是需要安装这两个编译工具，如果你下面编译出错，会提示你需要安装说明编辑工具的。利用 <code>brew</code> 安装即可。</p>
<p>如果你电脑没有安装 <code>brew</code> 工具，请参考 <a href="http://blog.csdn.net/FungLeo/article/details/57567538" target="_blank" rel="external">http://blog.csdn.net/FungLeo/article/details/57567538</a> 这篇博文安装</p>
<p>好，准备工作做好，我们接着来。</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 进入下载目录</span></span><br><span class="line">cd ~/Downloads/</span><br><span class="line"><span class="meta"># 下载最新版本的源码包</span></span><br><span class="line">wget https:<span class="comment">//github.com/man-pages-zh/manpages-zh/archive/v1.6.3.2.tar.gz</span></span><br><span class="line"><span class="meta"># 解压源码包(atool命令，推荐安装这个工具，统一所有压缩文档的命令）</span></span><br><span class="line">atool -x v1<span class="number">.6</span><span class="number">.3</span><span class="number">.2</span>.tar.gz</span><br><span class="line"><span class="meta"># 或者使用这个命令解压</span></span><br><span class="line">tar zxvf v1<span class="number">.6</span><span class="number">.3</span><span class="number">.2</span>.tar.gz</span><br><span class="line"><span class="meta"># 进入源码包文件夹</span></span><br><span class="line">cd manpages-zh<span class="number">-1.6</span><span class="number">.3</span><span class="number">.2</span>/</span><br><span class="line"><span class="meta"># 编译安装 1</span></span><br><span class="line">autoreconf --install --force</span><br><span class="line"><span class="meta"># 编译安装 2</span></span><br><span class="line">./configure</span><br><span class="line"><span class="meta"># 编译安装 3</span></span><br><span class="line">make</span><br><span class="line"><span class="meta"># 编译安装 4</span></span><br><span class="line">sudo make install</span><br><span class="line"><span class="meta"># 配置别名</span></span><br><span class="line">echo <span class="string">"alias cman='man -M /usr/local/share/man/zh_CN'"</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"><span class="meta"># 使别名生效</span></span><br><span class="line">. ~/.bash_profile12345678910111213141516171819202122</span><br></pre></td></tr></table></figure>
<p>这样，我们就安装上了中文版本的 <code>man</code> 工具了。我们可以使用</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cman <span class="keyword">ls</span>1</span><br></pre></td></tr></table></figure>
<p>来查看中文版本的解释了。但是由于 <code>mac</code> 上的 <code>groff</code> 工具比较老，所以中文会出现乱码。我们来解决一下这个问题。</p>
<h2 id="安装-groff-新版本解决中文乱码的问题"><a href="#安装-groff-新版本解决中文乱码的问题" class="headerlink" title="安装 groff 新版本解决中文乱码的问题"></a>安装 groff 新版本解决中文乱码的问题</h2><p>首先，我们到 <a href="http://git.savannah.gnu.org/cgit/groff.git" target="_blank" rel="external">http://git.savannah.gnu.org/cgit/groff.git</a> 这个页面下载 <code>1.22</code> 版本的 <code>groff</code> 安装包。我这边用命令行下载，你如果直接复制我的命令，不能下载，请到上面的地址去看看下载地址是否发生变化。</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 进入下载目录</span></span><br><span class="line">cd ~/Downloads/</span><br><span class="line"><span class="meta"># 下载1.22版本的源码包</span></span><br><span class="line">wget http:<span class="comment">//git.savannah.gnu.org/cgit/groff.git/snapshot/groff-1.22.tar.gz</span></span><br><span class="line"><span class="meta"># 解压</span></span><br><span class="line">atool -x groff<span class="number">-1.22</span>.tar.gz</span><br><span class="line"><span class="meta"># 进入目录</span></span><br><span class="line">cd groff<span class="number">-1.22</span></span><br><span class="line"><span class="meta"># 编译安装</span></span><br><span class="line">./configure</span><br><span class="line">sudo make</span><br><span class="line">sudo make install</span><br><span class="line"><span class="meta"># 添加配置</span></span><br><span class="line">sudo vim /etc/man.conf1234567891011121314</span><br></pre></td></tr></table></figure>
<p>进入编辑之后，在文件末尾添加</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NROFF preconv -e UTF8 | <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>nroff -Tutf8 -mandoc -c1</span><br></pre></td></tr></table></figure>
<p>最后 <code>:wq</code> 保存退出</p>
<p>然后，我们在输入</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cman <span class="keyword">ls</span>1</span><br></pre></td></tr></table></figure>
<p>就可以看到中文版本的命令介绍了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/02/07/jmc使用方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/07/jmc使用方法/" itemprop="url">JFR使用方法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-07T18:02:17+08:00">
                2018-02-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/线上故障排查/" itemprop="url" rel="index">
                    <span itemprop="name">线上故障排查</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/07/jmc使用方法/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/02/07/jmc使用方法/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  281
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="JFR使用方式"><a href="#JFR使用方式" class="headerlink" title="JFR使用方式"></a>JFR使用方式</h3><p>按照下面三个步骤操作；</p>
<ul>
<li>选定一台机器，登陆上去，并找到要监控的进程PID</li>
<li>将附件文件(<em>*</em>.jfc)放入到 /usr/install/java/jdk1.8.0_60/jre/lib/jfr 目录，注意，这个配置文件是在官方配置上增加了对异常数据的采集。推荐使用。</li>
<li>执行下列命令，其中<pid>请自行替换：</pid></li>
<li>这样就好了，如上，等待2分钟＋20秒，/tmp/pid.jfr文件就生成好了，这个文件直接导入JMC工具即可</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">jcmd &lt;pid&gt; VM.unlock_commercial_features #先解锁技能</span><br><span class="line">jcmd &lt;pid&gt; JFR.start <span class="attribute">name</span>=myrec <span class="attribute">settings</span>=tongdun <span class="attribute">delay</span>=20s <span class="attribute">duration</span>=2m <span class="attribute">filename</span>=/tmp/pid.jfr</span><br><span class="line"></span><br><span class="line"><span class="comment">#其中，delay参数表示profile延迟启动时间，duration表示持续采集时间，这里设置为2分钟</span></span><br><span class="line"><span class="comment">#settings表示使用哪种采集配置，这里用的就是第二步中放入的tongdun.jfc配置，它默认有一个名为profile的配置，如果不想采集异常信息，也可以直接用它。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#注意，采集数据生成后请执行下列命令移除这个采集</span></span><br><span class="line">jcmd &lt;pid&gt; JFR.stop <span class="attribute">name</span>=myrec</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/02/07/jdk之线上高内存占用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/07/jdk之线上高内存占用/" itemprop="url">jdk之线上高内存占用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-07T11:14:49+08:00">
                2018-02-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/线上故障排查/" itemprop="url" rel="index">
                    <span itemprop="name">线上故障排查</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/07/jdk之线上高内存占用/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/02/07/jdk之线上高内存占用/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  8
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#找到占用内存高的java进程</span></span><br><span class="line">top</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看堆使用情况</span></span><br><span class="line">jmp -heap [<span class="keyword">pid</span>]</span><br><span class="line"><span class="comment">#查看占用内存高的对象</span></span><br><span class="line">jmp -histo:live [<span class="keyword">pid</span>] | head -n <span class="number">100</span></span><br><span class="line"><span class="comment">#查看占用内存高的对象,dump成文件，线下分析</span></span><br><span class="line">jmap -dump:live,<span class="keyword">format</span>=b,<span class="keyword">file</span>=xxx.xxx [<span class="keyword">pid</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看进程的线程情况</span></span><br><span class="line">ps p [<span class="keyword">pid</span>] -L -o pcpu,pmem,<span class="keyword">pid</span>,tid,<span class="keyword">time</span>,tname,cmd</span><br><span class="line"></span><br><span class="line"><span class="comment">#线程id打印成16进制</span></span><br><span class="line">printf <span class="string">"%x\n"</span> [tid]</span><br><span class="line"></span><br><span class="line"><span class="comment">#输出java进程堆栈到文件</span></span><br><span class="line">jstack -l [<span class="keyword">pid</span>] &gt; jstack.log</span><br><span class="line"></span><br><span class="line"><span class="comment">#vim 查找16进制的tid， runnable正常状态，WAITING一直等那个条件发生，TIMED_WAITING定时的那个条件不到来也将定时唤醒自己</span></span><br><span class="line">vim jstack.log</span><br></pre></td></tr></table></figure>
<p>jmap命令有下面几种常用的用法：</p>
<p>•jmap [pid]</p>
<p>•jmap -histo:live [pid] &gt;a.log</p>
<p>•jmap -dump:live,format=b,file=xxx.xxx [pid]</p>
<p>用得最多是后面两个。其中，jmap -histo:live [pid] 可以查看当前Java进程创建的活跃对象数目和占用内存大小。</p>
<p>jmap -dump:live,format=b,file=xxx.xxx [pid] 则可以将当前Java进程的内存占用情况导出来，方便用专门的内存分析工具（例如：MAT）来分析。</p>
<p>这个命令对于分析是否有内存泄漏很有帮助。具体怎么使用可以查看本博的另一篇文章：利用Eclipse Memory Analyzer Tool（MAT）分析内存泄漏</p>
<p>首先看一下一个java进程的jmap输出：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[lex@chou ~]$ jmap -heap <span class="number">837</span></span><br><span class="line">Attaching to process ID <span class="number">837</span>, please wait...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is <span class="number">20.10</span>-b01</span><br><span class="line"></span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Parallel GC <span class="keyword">with</span> <span class="number">2</span> thread(s)</span><br><span class="line"></span><br><span class="line">Heap Configuration:</span><br><span class="line">   <span class="attr">MinHeapFreeRatio</span> = <span class="number">40</span></span><br><span class="line">   <span class="attr">MaxHeapFreeRatio</span> = <span class="number">70</span></span><br><span class="line">   <span class="attr">MaxHeapSize</span>      = <span class="number">4294967296</span> (<span class="number">4096.0</span>MB)</span><br><span class="line">   <span class="attr">NewSize</span>          = <span class="number">1310720</span> (<span class="number">1.25</span>MB)</span><br><span class="line">   <span class="attr">MaxNewSize</span>       = <span class="number">17592186044415</span> MB</span><br><span class="line">   <span class="attr">OldSize</span>          = <span class="number">5439488</span> (<span class="number">5.1875</span>MB)</span><br><span class="line">   <span class="attr">NewRatio</span>         = <span class="number">2</span></span><br><span class="line">   <span class="attr">SurvivorRatio</span>    = <span class="number">8</span></span><br><span class="line">   <span class="attr">PermSize</span>         = <span class="number">21757952</span> (<span class="number">20.75</span>MB)</span><br><span class="line">   <span class="attr">MaxPermSize</span>      = <span class="number">85983232</span> (<span class="number">82.0</span>MB)</span><br><span class="line"></span><br><span class="line">Heap Usage:</span><br><span class="line">PS Young Generation</span><br><span class="line">Eden Space:</span><br><span class="line">   <span class="attr">capacity</span> = <span class="number">41025536</span> (<span class="number">39.125</span>MB)</span><br><span class="line">   <span class="attr">used</span>     = <span class="number">18413552</span> (<span class="number">17.560531616210938</span>MB)</span><br><span class="line">   <span class="attr">free</span>     = <span class="number">22611984</span> (<span class="number">21.564468383789062</span>MB)</span><br><span class="line">   <span class="number">44.883147900858624</span>% used</span><br><span class="line">From Space:</span><br><span class="line">   <span class="attr">capacity</span> = <span class="number">4325376</span> (<span class="number">4.125</span>MB)</span><br><span class="line">   <span class="attr">used</span>     = <span class="number">3702784</span> (<span class="number">3.53125</span>MB)</span><br><span class="line">   <span class="attr">free</span>     = <span class="number">622592</span> (<span class="number">0.59375</span>MB)</span><br><span class="line">   <span class="number">85.60606060606061</span>% used</span><br><span class="line">To Space:</span><br><span class="line">   <span class="attr">capacity</span> = <span class="number">4521984</span> (<span class="number">4.3125</span>MB)</span><br><span class="line">   <span class="attr">used</span>     = <span class="number">0</span> (<span class="number">0.0</span>MB)</span><br><span class="line">   <span class="attr">free</span>     = <span class="number">4521984</span> (<span class="number">4.3125</span>MB)</span><br><span class="line">   <span class="number">0.0</span>% used</span><br><span class="line">PS Old Generation</span><br><span class="line">   <span class="attr">capacity</span> = <span class="number">539820032</span> (<span class="number">514.8125</span>MB)</span><br><span class="line">   <span class="attr">used</span>     = <span class="number">108786168</span> (<span class="number">103.74657440185547</span>MB)</span><br><span class="line">   <span class="attr">free</span>     = <span class="number">431033864</span> (<span class="number">411.06592559814453</span>MB)</span><br><span class="line">   <span class="number">20.152302906758376</span>% used</span><br><span class="line">PS Perm Generation</span><br><span class="line">   <span class="attr">capacity</span> = <span class="number">85983232</span> (<span class="number">82.0</span>MB)</span><br><span class="line">   <span class="attr">used</span>     = <span class="number">60770232</span> (<span class="number">57.95500946044922</span>MB)</span><br><span class="line">   <span class="attr">free</span>     = <span class="number">25213000</span> (<span class="number">24.04499053955078</span>MB)</span><br><span class="line">   <span class="number">70.67684080542588</span>% used</span><br></pre></td></tr></table></figure>
<p>然后再用ps看看：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[lex@chou ~]$ ps -p <span class="number">837</span> -o vsz,rss</span><br><span class="line">   VSZ   RSS</span><br><span class="line"><span class="number">7794992</span> <span class="number">3047320</span></span><br></pre></td></tr></table></figure>
<p>关于这里的几个generation网上资料一大把就不细说了，这里算一下求和可以得知前者总共给Java环境分配了644M的内存，而ps输出的VSZ和RSS分别是7.4G和2.9G，这到底是怎么回事呢？<br>前面jmap输出的内容里，MaxHeapSize 是在命令行上配的，-Xmx4096m，这个java程序可以用到的最大堆内存。<br>VSZ是指已分配的线性空间大小，这个大小通常并不等于程序实际用到的内存大小，产生这个的可能性很多，比如内存映射，共享的动态库，或者向系统申请了更多的堆，都会扩展线性空间大小，要查看一个进程有哪些内存映射，可以使用 pmap 命令来查看：</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[lex@chou ~]$ pmap -x 837</span><br><span class="line">837:   java</span><br><span class="line">Address           Kbytes     RSS   Dirty Mode   Mapping</span><br><span class="line">0000000040000000     <span class="number"> 36 </span>     <span class="number"> 4 </span>     <span class="number"> 0 </span>r-x--  java</span><br><span class="line">0000000040108000      <span class="number"> 8 </span>     <span class="number"> 8 </span>     <span class="number"> 8 </span>rwx--  java</span><br><span class="line">00000000418c9000  <span class="number"> 13676 </span> <span class="number"> 13676 </span> <span class="number"> 13676 </span>rwx--    [ anon ]</span><br><span class="line">00000006fae00000  <span class="number"> 83968 </span> <span class="number"> 83968 </span> <span class="number"> 83968 </span>rwx--    [ anon ]</span><br><span class="line">0000000700000000 <span class="number"> 527168 </span><span class="number"> 451636 </span><span class="number"> 451636 </span>rwx--    [ anon ]</span><br><span class="line">00000007202d0000 <span class="number"> 127040 </span>     <span class="number"> 0 </span>     <span class="number"> 0 </span>-----    [ anon ]</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">00007f55ee124000      <span class="number"> 4 </span>     <span class="number"> 4 </span>     <span class="number"> 0 </span>r-xs-  az.png</span><br><span class="line">00007fff017ff000      <span class="number"> 4 </span>     <span class="number"> 4 </span>     <span class="number"> 0 </span>r-x--    [ anon ]</span><br><span class="line">ffffffffff600000      <span class="number"> 4 </span>     <span class="number"> 0 </span>     <span class="number"> 0 </span>r-x--    [ anon ]</span><br><span class="line">----------------  ------  ------  ---<span class="yaml"><span class="meta">---</span></span></span><br><span class="line"><span class="yaml"><span class="string">total</span> <span class="string">kB</span>         <span class="number">7796020</span> <span class="number">3037264</span> <span class="number">3023928</span></span></span><br></pre></td></tr></table></figure>
<p>这里可以看到很多anon，这些表示这块内存是由mmap分配的。</p>
<p>RSZ是Resident Set Size，常驻内存大小，即进程实际占用的物理内存大小， 在现在这个例子当中，RSZ和实际堆内存占用差了2.3G，这2.3G的内存组成分别为：</p>
<ol>
<li>JVM本身需要的内存，包括其加载的第三方库以及这些库分配的内存</li>
<li>NIO的DirectBuffer是分配的native memory</li>
<li>内存映射文件，包括JVM加载的一些JAR和第三方库，以及程序内部用到的。上面 pmap 输出的内容里，有一些静态文件所占用的大小不在Java的heap里，因此作为一个Web服务器，赶紧把静态文件从这个Web服务器中人移开吧，放到nginx或者CDN里去吧。</li>
<li>JIT， JVM会将Class编译成native代码，这些内存也不会少，如果使用了Spring的AOP，CGLIB会生成更多的类，JIT的内存开销也会随之变大，而且Class本身JVM的GC会将其放到Perm Generation里去，很难被回收掉，面对这种情况，应该让JVM使用ConcurrentMarkSweep GC，并启用这个GC的相关参数允许将不使用的class从Perm Generation中移除， 参数配置： -XX:+UseConcMarkSweepGC -X:+CMSPermGenSweepingEnabled -X:+CMSClassUnloadingEnabled，如果不需要移除而Perm Generation空间不够，可以加大一点： -X:PermSize=256M -X:MaxPermSize=512M</li>
<li>JNI，一些JNI接口调用的native库也会分配一些内存，如果遇到JNI库的内存泄露，可以使用valgrind等内存泄露工具来检测</li>
<li>线程栈，每个线程都会有自己的栈空间，如果线程一多，这个的开销就很明显了</li>
<li>jmap/jstack 采样，频繁的采样也会增加内存占用，如果你有服务器健康监控，记得这个频率别太高，否则健康监控变成致病监控了。</li>
</ol>
<p>关于JVM的几个GC堆和GC的情况，可以用jstat来监控，例如监控进程837每隔1000毫秒刷新一次，输出20次：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[lex@chou ~]$ jstat -gcutil <span class="number">837</span> <span class="number">1000</span> <span class="number">20</span></span><br><span class="line">  S0     S1     E      O      P     YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line">  <span class="number">0.00</span>  <span class="number">80.43</span>  <span class="number">24.62</span>  <span class="number">87.44</span>  <span class="number">98.29</span>   <span class="number">7101</span>  <span class="number">119.652</span>    <span class="number">40</span>   <span class="number">19.719</span>  <span class="number">139.371</span></span><br><span class="line">  <span class="number">0.00</span>  <span class="number">80.43</span>  <span class="number">33.14</span>  <span class="number">87.44</span>  <span class="number">98.29</span>   <span class="number">7101</span>  <span class="number">119.652</span>    <span class="number">40</span>   <span class="number">19.719</span>  <span class="number">139.371</span></span><br></pre></td></tr></table></figure>
<p>几个字段分别含义如下：</p>
<table>
<thead>
<tr>
<th>S0</th>
<th>年轻代中第一个survivor（幸存区）已使用的占当前容量百分比</th>
</tr>
</thead>
<tbody>
<tr>
<td>S1</td>
<td>年轻代中第二个survivor（幸存区）已使用的占当前容量百分比</td>
</tr>
<tr>
<td>E</td>
<td>年轻代中Eden（伊甸园）已使用的占当前容量百分比</td>
</tr>
<tr>
<td>O</td>
<td>old代已使用的占当前容量百分比</td>
</tr>
<tr>
<td>P</td>
<td>perm代已使用的占当前容量百分比</td>
</tr>
<tr>
<td>YGC</td>
<td>从应用程序启动到采样时年轻代中gc次数</td>
</tr>
<tr>
<td>YGCT</td>
<td>从应用程序启动到采样时年轻代中gc所用时间(s)</td>
</tr>
<tr>
<td>FGC</td>
<td>从应用程序启动到采样时old代(全gc)gc次数</td>
</tr>
<tr>
<td>FGCT</td>
<td>从应用程序启动到采样时old代(全gc)gc所用时间(s)</td>
</tr>
<tr>
<td>GCT</td>
<td>从应用程序启动到采样时gc用的总时间(s)</td>
</tr>
</tbody>
</table>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>因此如果正常情况下jmap输出的内存占用远小于 RSZ，可以不用太担心，除非发生一些严重错误，比如PermGen空间满了导致OutOfMemoryError发生，或者RSZ太高导致引起系统公愤被OOM Killer给干掉，就得注意了，该加内存加内存，没钱买内存加交换空间，或者按上面列的组成部分逐一排除。<br>这几个内存指标之间的关系是：VSZ &gt;&gt; RSZ &gt;&gt; Java程序实际使用的堆大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol>
<li><p>使用top命令查看系统资源的使用情况，<strong>命令：</strong> <strong>top</strong></p>
<p><img src="http://s1.51cto.com/images/20171205/1512456083123634.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_100,g_se,x_10,y_10,shadow_90,type_ZmFuZ3poZW5naGVpdGk=" alt="blob.png"></p>
<p>如图可以看到java的进程内存使用率较高，java进程的内存使用率达到了70%+</p>
</li>
</ol>
<p>2.定位线程问题（通过命令查看9718进程的线程情况），<strong>命令：</strong> <strong>ps p 9718 -L -o pcpu,pmem,pid,tid,time,tname,cmd</strong></p>
<p>  <img src="http://s1.51cto.com/images/20171205/1512456639489566.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_100,g_se,x_10,y_10,shadow_90,type_ZmFuZ3poZW5naGVpdGk=" alt="blob.png"></p>
<p> 由此可以看到这PID：9718的进程产生了很多线程。接下来就可以通过jstack查看内存使用的堆栈。</p>
<ol>
<li>查看内存使用的堆栈：在这里我们挑选了TID=9720的线程进行分析，首先需要将9731这个id转换为16进制。需输入如下命令，</li>
</ol>
<p> <strong>printf “%x\n” 9731</strong></p>
<hr>
<p><img src="http://s1.51cto.com/images/20171205/1512457511632355.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_100,g_se,x_10,y_10,shadow_90,type_ZmFuZ3poZW5naGVpdGk=" alt="blob.png"></p>
<p> 接下需要使用16进制的2603</p>
<ol>
<li>将PID为9718的堆栈信息打印到jstack.log中，<strong>命令：</strong> <strong>jstack -l 9718 &gt; jstack.log</strong></li>
</ol>
<hr>
<p><strong>   <img src="http://s1.51cto.com/images/20171205/1512457331172686.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_100,g_se,x_10,y_10,shadow_90,type_ZmFuZ3poZW5naGVpdGk=" alt="blob.png"></strong></p>
<hr>
<p><strong>5. 查看堆栈信息文件，命令：vim jstack.log</strong></p>
<hr>
<p><strong>   在进行搜索TID为2603的相关信息。如图：</strong></p>
<hr>
<p><strong>   <img src="http://s1.51cto.com/images/20171205/1512457632695909.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_100,g_se,x_10,y_10,shadow_90,type_ZmFuZ3poZW5naGVpdGk=" alt="blob.png"></strong></p>
<p>   可以看到这个线程状态为：WAITING。通过查看文件分析 看到大量 Java Thread State。</p>
<p>   说明它在等待另一个条件的发生，来把自己唤醒，或者干脆它是调用了 sleep(N)。</p>
<p>   此时线程状态大致为以下几种：</p>
<p>   java.lang.Thread.State: WAITING (parking)：一直等那个条件发生；</p>
<p>   java.lang.Thread.State: TIMED_WAITING (parking或sleeping)：定时的，那个条件不到来，也将定时唤醒自己。</p>
<p>6.代码优化：将文件发送给开发。优化下线程</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/01/30/kubernetes之使用minikube本地部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/30/kubernetes之使用minikube本地部署/" itemprop="url">kubernetes之使用minikube本地部署</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-30T22:27:54+08:00">
                2018-01-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/运维/" itemprop="url" rel="index">
                    <span itemprop="name">运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/30/kubernetes之使用minikube本地部署/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/30/kubernetes之使用minikube本地部署/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  9
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>目录</strong></p>
<ul>
<li>kubernetes 介绍</li>
<li>环境、软件准备</li>
<li>kubectl 安装</li>
<li>minikube 安装</li>
<li>部署运行实例</li>
</ul>
<p><strong>1、kubernetes 介绍</strong></p>
<blockquote>
<p>Kubernetes 是 Google 开源的容器集群管理系统，它构建在目前流行的 Docker 技术之上，为容器化的应用提供资源调度、部署运行、服务发现、扩容缩容等一整套功能。而就在日前 DockerCon 欧洲大会上， Docker 宣布拥抱支持 Kubernetes，Docker 公司计划提供一个无缝平台，同时支持包含 Swarm 和 Kubernetes 集群的异构部署。minikube 是一个使我们很容易在本地运行 kubernetes 的工具，他是通过在本机 VM 里运行一个单节点集群，大大方便学习和使用 kubernetes。</p>
</blockquote>
<p><strong>2、环境、软件准备</strong></p>
<p>本次演示环境，我是在本机 MAC OS 以及虚拟机 Linux Centos7 上操作，以下是安装的软件及版本：</p>
<ol>
<li>Docker: version 17.09.0-ce</li>
<li>Oracle VirtualBox: version 5.1.20 r114628 (Qt5.6.2)</li>
<li>Minikube: version v0.22.2</li>
<li>Kuberctl:<ul>
<li>Client Version: v1.8.1</li>
<li>Server Version: v1.7.5</li>
</ul>
</li>
</ol>
<p>注意：Minikube 启动的单节点 k8s Node 实例是需要运行在本机的 VM 虚拟机里面，所以需要提前安装好 VM，这里我选择 Oracle VirtualBox。k8s 运行底层使用 Docker 容器，所以本机需要安装好 Docker 环境，这里忽略 Docker、VirtualBox 的安装过程，着重介绍下 Minikube 和 Kuberctl 的安装。</p>
<p><strong>3、 kubectl 安装</strong></p>
<p>kubectl 是 Kubernetes 的命令行工具，我们可以使用该工具查看集群资源，创建、更新、删除各个组件等等，同时提供了非常详细的使用文档，非常方便，那我们在本机 Mac 上安装一下。</p>
<p>安装方式有两种：</p>
<p>一、通过 curl 安装</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1、安装最新版</span><br><span class="line">curl -LO https://storage.googleapis.com/kubernetes-<span class="keyword">release</span>/<span class="keyword">release</span>/<span class="string">`curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt`</span>/<span class="keyword">bin</span>/darwin/amd64/kubectl</span><br><span class="line"></span><br><span class="line"># 安装指定版本，例如 v1<span class="number">.8</span><span class="number">.0</span></span><br><span class="line">curl -LO https://storage.googleapis.com/kubernetes-<span class="keyword">release</span>/<span class="keyword">release</span>/v1<span class="number">.8</span><span class="number">.0</span>/<span class="keyword">bin</span>/darwin/amd64/kubectl</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、赋二进制文件执行权限</span><br><span class="line">chmod +x ./kubectl</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、将二进制文件移到 <span class="keyword">PATH</span> 中</span><br><span class="line">sudo mv ./kubectl /usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/kubectl1234567891011</span><br></pre></td></tr></table></figure>
<p>二、通过 Homebrew 安装</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">brew </span><span class="keyword">install </span>kubectl1</span><br></pre></td></tr></table></figure>
<p>安装完毕后，执行 <code>kubectl version</code> 查看版本以及是否安装成功。我们可以通过 <code>kubectl help</code> 查看说明文档。</p>
<p><strong>4、minikube 安装</strong></p>
<p>minikube 是一个使我们很容易在本地运行 kubernetes 的工具，他是通过在本机 VM 里运行一个单节点 kubernetes 集群，这对于新手想了解和学习 kubernetes 提供了很大的帮助。所以在安装 minikube 之前我们需要在本机先安装 VM，这里我选择 VirtualBox 忽略安装过程，以下是可选 VM 列表：</p>
<ul>
<li>OS X: <a href="https://git.k8s.io/minikube/docs/drivers.md#xhyve-driver" target="_blank" rel="external">xhyve driver</a>, <a href="https://www.virtualbox.org/wiki/Downloads" target="_blank" rel="external">VirtualBox</a>, <a href="https://www.vmware.com/products/fusion" target="_blank" rel="external">VMware Fusion</a>.</li>
<li>Linux: <a href="https://www.virtualbox.org/wiki/Downloads" target="_blank" rel="external">VirtualBox</a>, <a href="http://www.linux-kvm.org/" target="_blank" rel="external">KVM</a></li>
<li>Windows: <a href="https://www.virtualbox.org/wiki/Downloads" target="_blank" rel="external">VirtualBox</a>, <a href="https://msdn.microsoft.com/en-us/virtualization/hyperv_on_windows/quick_start/walkthrough_install" target="_blank" rel="external">Hyper-V</a></li>
</ul>
<p>minikube 的安装也很简单。</p>
<p>1、curl 方式安装</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">OSX 系统：</span><br><span class="line">curl -Lo minikube https:<span class="regexp">//</span>storage.googleapis.com<span class="regexp">/minikube/</span>releases<span class="regexp">/v0.22.3/mi</span>nikube-darwin-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span></span><br><span class="line"></span><br><span class="line">Linux 系统：</span><br><span class="line">curl -Lo minikube https:<span class="regexp">//</span>storage.googleapis.com<span class="regexp">/minikube/</span>releases<span class="regexp">/v0.22.3/mi</span>nikube-linux-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span><span class="number">12345</span></span><br></pre></td></tr></table></figure>
<p>2、若上边地址被墙了，可以去 GitHub 上下载安装包，在执行。</p>
<p>下载最新版安装包，各系统对应地址如下：</p>
<ul>
<li><a href="https://github.com/kubernetes/minikube/releases/download/v0.22.3/minikube-darwin-amd64" target="_blank" rel="external">minikube-darwin-amd64</a></li>
<li><a href="https://github.com/kubernetes/minikube/releases/download/v0.22.3/minikube-linux-amd64" target="_blank" rel="external">minikube-linux-amd64</a></li>
<li><a href="https://github.com/kubernetes/minikube/releases/download/v0.22.3/minikube-installer.exe" target="_blank" rel="external">minikube-installer.exe</a></li>
</ul>
<p>然后执行 <code>chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/</code>，即可完成安装。安装完毕后，执行 <code>minikube version</code> 查看版本以及是否安装成功。我们可以通过 <code>minikube help</code> 查看说明文档。</p>
<p><strong>5、部署运行实例</strong></p>
<p>好了，环境我们已经安装完毕，现在来演示运行一个实例，这里我已 tomcat 镜像为例，演示部署服务，发布服务，扩容缩容服务等操作。</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、创建并启动 minikube 虚拟机</span><br><span class="line"><span class="symbol">$</span> minikube start</span><br><span class="line"><span class="function"><span class="title">Starting</span></span> local Kubernetes cluster...</span><br><span class="line"><span class="function"><span class="title">Running</span></span> pre-create checks...</span><br><span class="line"><span class="function"><span class="title">Creating</span></span> machine...</span><br><span class="line"><span class="function"><span class="title">Starting</span></span> local Kubernetes cluster...</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、创建 hello-minikube 部署</span><br><span class="line"><span class="symbol">$</span> kubectl run hello-minikube --image=tomcat:<span class="number">8.0</span> --port=<span class="number">8080</span></span><br><span class="line">deployment <span class="string">"hello-minikube"</span> created</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、发布服务 hello-minikube</span><br><span class="line"><span class="symbol">$</span> kubectl expose deployment hello-minikube --type=NodePort</span><br><span class="line">service <span class="string">"hello-minikube"</span> exposed</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、查看 pods</span><br><span class="line"><span class="symbol">$</span> kubectl get pods</span><br><span class="line">NAME                             READY     STATUS              RESTARTS   AGE</span><br><span class="line">hello-minikube<span class="number">-598805112</span><span class="number">-3</span>bzmf   <span class="number">1</span>/<span class="number">1</span>       ContainerCreating   <span class="number">0</span>          <span class="number">5</span>s</span><br><span class="line">注意：刚开始时，pod 没有完全创建好的时候，状态是 ContainerCreating，当部署完成后，状态就变成 Running。</span><br><span class="line"></span><br><span class="line"><span class="symbol">$</span> kubectl get pods</span><br><span class="line">NAME                             READY     STATUS    RESTARTS   AGE</span><br><span class="line">hello-minikube<span class="number">-598805112</span><span class="number">-3</span>bzmf   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">25</span>s</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>、获取服务地址</span><br><span class="line"><span class="symbol">$</span> minikube service hello-minikube --url</span><br><span class="line">http:<span class="comment">//192.168.99.102:30724</span></span><br><span class="line"><span class="symbol">$</span> minikube service hello-minikube 将直接打开地址到默认浏览器上。</span><br><span class="line"></span><br><span class="line"><span class="number">6</span>、停止 minikube 虚拟机</span><br><span class="line"><span class="symbol">$</span> minikube stop</span><br><span class="line"><span class="function"><span class="title">Stopping</span></span> local Kubernetes cluster...</span><br><span class="line">Stopping <span class="string">"minikube"</span>..<span class="number">.12345678910111213141516171819202122232425262728293031323334</span></span><br></pre></td></tr></table></figure>
<p>注意：在部署过程中可能会出现问题，大部分跟网络相关，下载 images 时会超时报错，解决办法是一安装翻墙工具，二是替代需要翻墙下载的 images。以下是我本机实验遇到的问题，以及解决方法。</p>
<p>问题一：命令行下载 tomcat:8.0 镜像，执行 <code>docker pull tomcat:8.0</code> 没有任何反应，初步分析可能是 minikube 虚拟机里没有连接到本地 docker 服务。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ minikube docker-env</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">DOCKER_TLS_VERIFY</span>=<span class="string">"1"</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">DOCKER_HOST</span>=<span class="string">"tcp://192.168.99.102:2376"</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">DOCKER_CERT_PATH</span>=<span class="string">"/Users/wanyang3/.minikube/certs"</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">DOCKER_API_VERSION</span>=<span class="string">"1.23"</span>12345</span><br></pre></td></tr></table></figure>
<p>执行 <code>eval $(minikube docker-env)</code>，即设置 minikube 虚拟机的 docker 环境变量即可。</p>
<p>问题二：执行完毕上边 2 和 3 步骤后，发现 hello-minikube 服务并没有成功启动。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">NAME                             READY     STATUS              RESTARTS   AGE</span><br><span class="line">hello-minikube<span class="number">-598805112</span><span class="number">-3</span>bzmf   <span class="number">0</span>/<span class="number">1</span>       ContainerCreating   <span class="number">0</span>          <span class="number">15</span>s123</span><br></pre></td></tr></table></figure>
<p>发现 hello-minikube 的状态一直是 ContainerCreating，并且 READY 为 0/1，通过 <code>minikube logs</code> 查看日志可以看出，有一个镜像 <code>gcr.io/google_containers/pause-amd64:3.0</code> 显示拉取失败，分析原因应该是 gcr.io 这个地址被墙了。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 替换镜像</span></span><br><span class="line">$ docker pull visenzek8s/pause-amd64:3.0</span><br><span class="line">$ docker tag visenzek8s/pause-amd64:3.0 gcr.io/google_containers/pause-amd64:3.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显式设置拉取策略为 IfNotPresent</span></span><br><span class="line">$ kubectl <span class="builtin-name">run</span> hello-minikube <span class="attribute">--image</span>=tomcat:8.0 <span class="attribute">--port</span>=8080 <span class="attribute">--image-pull-policy</span>=IfNotPresent 123456</span><br></pre></td></tr></table></figure>
<p>方案就是替换该镜像，然后可以设置拉取策略为优先本地获取，本地没有再去远程获取。因为这里服务启动策略为 always，会定时自动重新拉取，所以一旦本地拉取该镜像后，我们会发现上边 hello-minikube 一会就启动成功了。</p>
<p>下边介绍一下 kubectl 一些其他常用操作。</p>
<p>1、创建资源的两种方式</p>
<p>1.1 通过 Yaml 或 Json 文件创建</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f &lt;file_path&gt;<span class="string">/xxx.yaml</span> | &lt;file_path&gt;<span class="string">/xxx.json</span> --[options]</span><br><span class="line">eg：kubectl create -f <span class="string">./redis.yaml12</span></span><br></pre></td></tr></table></figure>
<p>简单的 <code>redis.yaml</code> 示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">hello-redis</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">my-kube</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        group:</span> <span class="string">hello-scm</span></span><br><span class="line"><span class="attr">        my-kube:</span> <span class="string">hello-redis</span></span><br><span class="line"><span class="attr">        k8s-app:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">redis:latest</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">hello-scm</span></span><br><span class="line">    <span class="string">kubernetes.io/cluster-service:</span> <span class="string">'true'</span></span><br><span class="line">    <span class="string">kubernetes.io/name:</span> <span class="string">hello-redis</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">hello-redis</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">my-kube</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">6379</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">6379</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">redis123456789101112131415161718192021222324252627282930313233</span></span><br></pre></td></tr></table></figure>
<p>yaml 文件要符合 kubernetes 的规范，可以参考官网对 yaml 语法定义，可以自学一下，这里就不展开来说了。</p>
<p>1.2 指定镜像启动</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="builtin-name">run</span> <span class="attribute">--image</span>=xxxx:xx --[options]</span><br><span class="line">eg: kubectl <span class="builtin-name">run</span> hello-minikube <span class="attribute">--image</span>=tomcat:8.0 <span class="attribute">--port</span>=8080 12</span><br></pre></td></tr></table></figure>
<p>2、复制多个部署 pod</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl scale <span class="attribute">--replicas</span>=3 deployment/hello-minikube</span><br><span class="line">deployment <span class="string">"hello-minikube"</span> scaled</span><br><span class="line">$ kubectl <span class="builtin-name">get</span> pods</span><br><span class="line">NAME                             READY     STATUS    RESTARTS   AGE</span><br><span class="line">hello-minikube-598805112-3bzmf   1/1       Running   1          1d</span><br><span class="line">hello-minikube-598805112-vrskz   1/1       Running   1          1d</span><br><span class="line">hello-minikube-598805112-xwq55   1/1       Running   1          1d</span><br><span class="line"></span><br><span class="line">也可以在启动时，指定复制数量</span><br><span class="line">$ kubectl <span class="builtin-name">run</span> hello-minikube <span class="attribute">--image</span>=tomcat:8.0 <span class="attribute">--port</span>=8080 <span class="attribute">--replicas</span>=312345678910</span><br></pre></td></tr></table></figure>
<p>3、暴露 pod (po), service (svc), replicationcontroller (rc), deployment (deploy), replicaset (rs) 成新的服务</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl expose po | svc | rc | delpoy | rs --[options]</span><br><span class="line">eg：kubectl expose deployment hello-minikube <span class="attribute">--type</span>=NodePort # 暴露名称为 hello-minikube 部署为类型为 NodePort 的服务</span><br><span class="line">eg：kubectl expose rc hello-nginx <span class="attribute">--port</span>=80 <span class="attribute">--target-port</span>=8000 <span class="attribute">--type</span>=NodePort # 暴漏名称为 nginx 的副本为指定服务端口80，连接该服务端口8000，类型为 NodePort 的服务</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="builtin-name">get</span> service</span><br><span class="line">NAME            <span class="built_in"> TYPE </span>       CLUSTER-IP   EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">hello-minikube   NodePort    10.0.0.176   &lt;none&gt;        8080:30724/TCP   1d</span><br><span class="line">hello-nginx      NodePort    10.0.0.94    &lt;none&gt;        80:8000/TCP      1d</span><br><span class="line">kubernetes       ClusterIP   10.0.0.1     &lt;none&gt;        443/TCP          1d123456789</span><br></pre></td></tr></table></figure>
<p>4、重新加载某个资源</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">apply</span> -f &lt;file_path&gt;/xxx.yaml | <span class="type">&lt;file_path</span>&gt;/xxx.json --[options]</span><br><span class="line">eg：kubectl <span class="built_in">apply</span> -f ./redis.yaml12</span><br></pre></td></tr></table></figure>
<p>5、查看 pod, service, replicationcontroller, deployment, replicaset 各种类型资源信息列表</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get po | <span class="type">svc</span> | <span class="type">rc</span> | <span class="type">deploy</span> | <span class="type">rs</span> # 查看默认 namespace 下各类型资源信息列表</span><br><span class="line">$ kubectl get po | <span class="type">svc</span> | <span class="type">rc</span> | <span class="type">deploy</span> | <span class="type">rs</span> --all-namespaces # 查看所有 namespace 下各类型资源信息列表<span class="number">12</span></span><br></pre></td></tr></table></figure>
<p>6、查看 pod, service, replicationcontroller, deployment, replicaset 各种类型资源日志信息或描述信息</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl logs <span class="params">&lt;resource_type&gt;</span>/<span class="params">&lt;resource_name&gt;</span> [options]</span><br><span class="line">eg：kubectl logs -f po/hello-minikube<span class="number">-598805112</span><span class="number">-3</span>bzmf <span class="meta"># 查看指定 pod 的日志</span></span><br><span class="line">eg：kubectl logs deploy/hello-nginx -n my-kube <span class="meta"># 查看指定 delpoy 和 namespace 的日志</span></span><br><span class="line"></span><br><span class="line">$ kubectl describe <span class="params">&lt;resource_type&gt;</span>/<span class="params">&lt;resource_name&gt;</span> [options]</span><br><span class="line">eg：kubectl describe pods <span class="meta"># 查看所有 pod 的描述信息</span></span><br><span class="line">eg：kubectl describe po/hello-minikube<span class="number">-598805112</span><span class="number">-3</span>bzmf <span class="meta"># 查看指定 pod 的描述信息</span></span><br><span class="line">eg：kubectl describe deploy/hello-nginx -n my-kube <span class="meta"># 查看指定 delpoy 和 namespace 的描述信息12345678</span></span><br></pre></td></tr></table></figure>
<p>7、查看集群信息</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl cluster<span class="literal">-inf</span>o</span><br><span class="line">Kubernetes <span class="keyword">master</span> <span class="title">is</span> running at https://<span class="number">192.168</span>.<span class="number">99.102</span>:<span class="number">844312</span></span><br></pre></td></tr></table></figure>
<p>好了，先介绍这么多，下一篇继续介绍下通过 minikube 安装 Kubernetes Dashboard 并集成 Heapster 插件。</p>
<p><strong>参考资料</strong></p>
<ul>
<li><a href="https://kubernetes.io/docs/getting-started-guides/minikube/" target="_blank" rel="external">Running Kubernetes Locally via Minikube</a></li>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-minikube/" target="_blank" rel="external">Install Minikube</a></li>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_blank" rel="external">Install and Set Up kubectl</a></li>
<li><a href="https://github.com/kubernetes/minikube/releases" target="_blank" rel="external">github minikube</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/01/27/docker运维与kubernates实战/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/27/docker运维与kubernates实战/" itemprop="url">docker运维与kubernates实战</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-27T12:22:54+08:00">
                2018-01-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/运维/" itemprop="url" rel="index">
                    <span itemprop="name">运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/27/docker运维与kubernates实战/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/27/docker运维与kubernates实战/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  9
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h1><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li>官方文档  <a href="https://docs.docker.com" target="_blank" rel="external">https://docs.docker.com</a></li>
</ul>
<blockquote>
<p><a href="https://docs.docker.com/docker-for-mac/#explore-the-application-and-run-examples" target="_blank" rel="external">https://docs.docker.com/docker-for-mac/#explore-the-application-and-run-examples</a></p>
</blockquote>
<h2 id="中文镜像配置"><a href="#中文镜像配置" class="headerlink" title="中文镜像配置"></a>中文镜像配置</h2><p><strong>1. 下载Docker for Mac。</strong></p>
<p>官方下载链接：<a href="https://download.docker.com/mac/stable/Docker.dmg" target="_blank" rel="external">https://download.docker.com/mac/stable/Docker.dmg</a></p>
<p><strong>2. 安装Docker for Mac并启动。</strong></p>
<p><strong>3. 检查版本信息。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker --version1</span></span><br></pre></td></tr></table></figure>
<p><strong>配置</strong></p>
<ol>
<li>进入<a href="https://cr.console.aliyun.com/?spm=5176.100239.blogcont29941.12.R6mUIX" target="_blank" rel="external">阿里云容器Hub服务</a>的控制台，并申请成为开发者。</li>
<li>点击左侧的<strong>加速器</strong>帮助页面就会显示<strong>您的专属加速器地址</strong>。</li>
<li>复制地址您的专属加速器地址，将地址填入Docker的配置中，路径如下：<strong>Preferences–&gt;Daemon–&gt;Basic–&gt;Registry mirrors</strong>，然后重启。</li>
</ol>
<p><strong>确认Docker是否安装成功</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="bash"> hello-world</span></span><br></pre></td></tr></table></figure>
<h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><h3 id="镜像命令"><a href="#镜像命令" class="headerlink" title="镜像命令"></a>镜像命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 信息</span></span><br><span class="line">docker info</span><br><span class="line"><span class="meta">#</span><span class="bash"> 版本</span></span><br><span class="line">docker version</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 帮助，通过帮助命令学习其他命令</span></span><br><span class="line">docker --help</span><br><span class="line">docker COMMAND --help</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看镜像列表, -a所有信息， -q静默信息， --digests摘要信息</span></span><br><span class="line">docker images</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">搜索镜像 -s 10 标星数</span></span><br><span class="line">docker search nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">下载镜像</span></span><br><span class="line">docker pull nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">删除镜像</span></span><br><span class="line">docker rmi nginx:latest</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">删除正在运行的镜像</span></span><br><span class="line">docker rmi $&#123;docker ps&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">删除全部镜像</span></span><br><span class="line">docker rmi -f $(docker images -q)</span><br><span class="line"></span><br><span class="line">docker run -d -p 80:80 --name webserver nginx</span><br><span class="line">docker stop webserver</span><br><span class="line">docker start webserver</span><br><span class="line">docker ps -a</span><br><span class="line"><span class="meta">#</span><span class="bash">删除容器 stop and remove the running container</span></span><br><span class="line">docker rm -f webserver</span><br></pre></td></tr></table></figure>
<h3 id="容器命令"><a href="#容器命令" class="headerlink" title="容器命令"></a>容器命令</h3><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#新建并启动容器 </span></span><br><span class="line"><span class="meta">#options:(-d后台运行 -i交互方式 -t启动为终端)</span></span><br><span class="line"><span class="meta">#options:(-p指定端口(宿主机:容器)映射 -P随机端口映射)</span></span><br><span class="line"><span class="meta">#options:(--name 为容器指定名称)</span></span><br><span class="line"><span class="meta">#options:(-v 数据卷挂载)</span></span><br><span class="line">docker run [OPTIONS] IMAGE [COMMAND] [ARG...]</span><br><span class="line">docker run -it ee48881b3e82</span><br><span class="line">docker run -d -p <span class="number">7777</span>:<span class="number">8080</span> --name mytomcat ee48881b3e82</span><br><span class="line">docker run -d -p <span class="number">8888</span>:<span class="number">8080</span> --name tomcat-docs2 tomcat2:<span class="number">2.0</span></span><br><span class="line">docker run -it -v ~/mydata:/datacontainer centos</span><br><span class="line"></span><br><span class="line"><span class="meta">#列出容器（-l最近一次 -n 3最近n次 -a全部）</span></span><br><span class="line">docker ps</span><br><span class="line">docker ps -n <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#查看日志，排查错误</span></span><br><span class="line">docker logs [OPTIONS] CONTAINER [flags]</span><br><span class="line"></span><br><span class="line"><span class="meta">#退出并停止容器</span></span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line"><span class="meta">#退出不停止容器</span></span><br><span class="line">ctrl + p + q</span><br><span class="line"></span><br><span class="line"><span class="meta">#启动容器</span></span><br><span class="line">docker start [OPTIONS] CONTAINER [CONTAINER...]</span><br><span class="line">docker start e5fbd89ce11b</span><br><span class="line"></span><br><span class="line"><span class="meta">#重启容器</span></span><br><span class="line">docker restart [OPTIONS] CONTAINER [CONTAINER...]</span><br><span class="line"></span><br><span class="line"><span class="meta">#停止容器</span></span><br><span class="line">docker stop 容器id 或容器名称</span><br><span class="line"></span><br><span class="line"><span class="meta">#强制停止容器</span></span><br><span class="line">docker kill 容器id 或容器名称</span><br><span class="line"></span><br><span class="line"><span class="meta">#删除容器</span></span><br><span class="line">docker rm 容器id</span><br><span class="line"></span><br><span class="line"><span class="meta">#删除多个容器</span></span><br><span class="line">docker rm -f $(docker ps -a -q)</span><br><span class="line"><span class="meta">#可变参数删除</span></span><br><span class="line">docker ps -a -q | xargs docker rm</span><br><span class="line"></span><br><span class="line"><span class="meta">#进入容器，不产生新的进程</span></span><br><span class="line">docker attach [OPTIONS] CONTAINER</span><br><span class="line"></span><br><span class="line"><span class="meta">#容器中执行命令</span></span><br><span class="line">docker exec [OPTIONS] CONTAINER COMMAND [ARG...]</span><br><span class="line">docker exec -it <span class="number">7220e09</span>b7c04 /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="meta">#从容器中创建镜像,OPTIONS:(-a作者 -m消息)</span></span><br><span class="line">docker commit [OPTIONS] CONTAINER [REPOSITORY[:TAG]]</span><br><span class="line">docker commit -a=<span class="string">"xiaowu"</span> -m=<span class="string">"hello,world"</span> <span class="number">98696</span>deb2879 <span class="string">"tomcat2:2.0"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#文件复制，从容器到宿主机</span></span><br><span class="line">docker cp [OPTIONS] CONTAINER:SRC_PATH DEST_PATH</span><br><span class="line">docker cp <span class="number">2</span>b8b669f4f45:/usr/local/tomcat/CONTRIBUTING.md ~/test/</span><br><span class="line"></span><br><span class="line"><span class="meta">#文件复制，从宿主机到容器</span></span><br><span class="line">docker cp [OPTIONS] SRC_PATH|- CONTAINER:DEST_PATH</span><br></pre></td></tr></table></figure>
<h2 id="docker数据卷"><a href="#docker数据卷" class="headerlink" title="docker数据卷"></a>docker数据卷</h2><p>比喻：U盘就是数据卷</p>
<h3 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h3><ul>
<li>数据持久化</li>
<li>容器间共享数据</li>
</ul>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">run</span> -<span class="keyword">it</span> -v ~/mydata:/datacontainer centos</span><br></pre></td></tr></table></figure>
<h2 id="数据容器卷"><a href="#数据容器卷" class="headerlink" title="数据容器卷"></a>数据容器卷</h2><ul>
<li>通过容器挂载数据卷</li>
<li>只要有一个容器在使用数据卷，就不会回收</li>
</ul>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">run</span> -<span class="keyword">it</span> <span class="comment">--name n1 --volumes-from distracted_galileo centos</span></span><br></pre></td></tr></table></figure>
<h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><ul>
<li>用来构建镜像的构建文件</li>
<li>docker hub 搜索，查看Dockerfile文件</li>
</ul>
<p>参考 <a href="https://github.com/docker-library/tomcat/blob/7cdbab2ce07c1593fc657fd6fac7821a5472dfd2/9.0/jdk8/openjdk/Dockerfile" target="_blank" rel="external">https://github.com/docker-library/tomcat/blob/7cdbab2ce07c1593fc657fd6fac7821a5472dfd2/9.0/jdk8/openjdk/Dockerfile</a></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> 当前新镜像基于哪个镜像</span><br><span class="line">CONTAINER 维护者</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> 镜像构建时需要运行的命令</span></span><br><span class="line"><span class="bash">WORKDIR 工作目录</span></span><br><span class="line"><span class="bash">EXPOSE 当前容器对外暴露的端口</span></span><br><span class="line"><span class="bash">ENV 环境变量</span></span><br><span class="line"><span class="bash">ADD 宿主机的文件copy到镜像，会自动解压</span></span><br><span class="line"><span class="bash">COPY 复制</span></span><br><span class="line"><span class="bash">COLUME 容器数据卷，用于保存和持久化</span></span><br></pre></td></tr></table></figure>
<ul>
<li>CMD</li>
</ul>
<p>CMD 指定容器启动过程中，运行的命令</p>
<p><strong>坑：多条CMD只有最后一条生效。CMD命令会被docker run 之后的参数替换。</strong></p>
<ul>
<li>ENTRYPOINT</li>
</ul>
<p>会把docker run 命令的参数追加到后面</p>
<h3 id="tomcat9案例"><a href="#tomcat9案例" class="headerlink" title="tomcat9案例"></a>tomcat9案例</h3><ul>
<li>Dockerfile</li>
</ul>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">MAINTAINER</span> xiaowu&lt;zhouxiaowu.<span class="number">12345</span>@<span class="number">163</span>.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> test.txt /usr/<span class="built_in">local</span>/testincontainer.txt</span></span><br><span class="line"><span class="bash">ADD apache-tomcat-9.0.24.tar.gz /usr/<span class="built_in">local</span>/</span></span><br><span class="line"><span class="bash">ADD jre-8u201-linux-x64.tar.gz /usr/<span class="built_in">local</span>/</span></span><br><span class="line"><span class="bash">RUN yum -y install vim</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">ENV MYPATH /usr/<span class="built_in">local</span></span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">WORKDIR <span class="variable">$MYPATH</span></span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">ENV JAVA_HOME /usr/<span class="built_in">local</span>/jre1.8.0_201</span></span><br><span class="line"><span class="bash">ENV CLASSPATH <span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span></span><br><span class="line"><span class="bash">ENV CATALINA_HOME /usr/<span class="built_in">local</span>/apache-tomcat-9.0.24</span></span><br><span class="line"><span class="bash">ENV CATALINA_BASE /usr/<span class="built_in">local</span>/apache-tomcat-9.0.24</span></span><br><span class="line"><span class="bash">ENV PATH <span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$CATALINA_HOME</span>/lib:<span class="variable">$CATALINA_HOME</span>/bin</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">EXPOSE 8080</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">CMD /usr/<span class="built_in">local</span>/apache-tomcat-9.0.24/bin/startup.sh &amp;&amp; tail -F /usr/<span class="built_in">local</span>/apache-tomcat-9.0.24/logs/catalina.out</span></span><br></pre></td></tr></table></figure>
<ul>
<li>构建镜像</li>
</ul>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">build</span> [OPTIONS] <span class="keyword">PATH</span> | URL | -</span><br><span class="line">docker <span class="keyword">build</span> -f Dockerfile -t mytomcat9 .</span><br></pre></td></tr></table></figure>
<ul>
<li>启动容器</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p <span class="number">9092</span>:<span class="number">8080</span> --name mytomcat92 \</span><br><span class="line">-v <span class="regexp">/Users/</span>zhouxiaowu<span class="regexp">/Dropbox/</span>Dockerfile<span class="regexp">/tomcat/</span><span class="string">app1:</span><span class="regexp">/usr/</span>local<span class="regexp">/apache-tomcat-9.0.24/</span>webapps/app1 \</span><br><span class="line">-v <span class="regexp">/Users/</span>zhouxiaowu<span class="regexp">/Dropbox/</span>Dockerfile<span class="regexp">/tomcat/</span><span class="string">logs:</span><span class="regexp">/usr/</span>local<span class="regexp">/apache-tomcat-9.0.24/</span>webapps/logs \</span><br><span class="line">mytomcat9</span><br></pre></td></tr></table></figure>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>docker没有内核，交给宿主机</p>
<h1 id="docker体系架构"><a href="#docker体系架构" class="headerlink" title="docker体系架构"></a>docker体系架构</h1><p>CS</p>
<p>docker Server</p>
<p>reset</p>
<p>client</p>
<p>数据卷</p>
<p>network</p>
<p>镜像</p>
<p>rootfs 文件和元数据的集合</p>
<p>分层的文件系统</p>
<p>同层共享</p>
<p>kernel -&gt; centos -&gt; jdk -&gt; tomcat</p>
<h2 id="quick-start"><a href="#quick-start" class="headerlink" title="quick start"></a>quick start</h2><h3 id="docker-container"><a href="#docker-container" class="headerlink" title="docker container"></a>docker container</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">docker build -t friendlyhello .  <span class="comment"># Create image using this directory's Dockerfile</span></span><br><span class="line">docker run -p <span class="number">4000</span>:<span class="number">80</span> friendlyhello  <span class="comment"># Run "friendlyname" mapping port 4000 to 80</span></span><br><span class="line">docker run -d -p <span class="number">4000</span>:<span class="number">80</span> friendlyhello         <span class="comment"># Same thing, but in detached mode</span></span><br><span class="line">docker container ls                                <span class="comment"># List all running containers</span></span><br><span class="line">docker container ls -a             <span class="comment"># List all containers, even those not running</span></span><br><span class="line">docker container <span class="literal">stop</span> <span class="tag">&lt;hash&gt;</span>           <span class="comment"># Gracefully stop the specified container</span></span><br><span class="line">docker container kill <span class="tag">&lt;hash&gt;</span>         <span class="comment"># Force shutdown of the specified container</span></span><br><span class="line">docker container rm <span class="tag">&lt;hash&gt;</span>        <span class="comment"># Remove specified container from this machine</span></span><br><span class="line">docker container rm $(docker container ls -a -q)         <span class="comment"># Remove all containers</span></span><br><span class="line">docker image ls -a                             <span class="comment"># List all images on this machine</span></span><br><span class="line">docker image rm <span class="tag">&lt;image id&gt;</span>            <span class="comment"># Remove specified image from this machine</span></span><br><span class="line">docker image rm $(docker image ls -a -q)   <span class="comment"># Remove all images from this machine</span></span><br><span class="line">docker login             <span class="comment"># Log in this CLI session using your Docker credentials</span></span><br><span class="line">docker <span class="keyword">tag</span> <span class="title">&lt;image</span>&gt; username/repository:<span class="keyword">tag</span>  <span class="title"># Tag</span> <span class="tag">&lt;image&gt;</span> for upload to registry</span><br><span class="line">docker push username/repository:<span class="keyword">tag</span>            <span class="title"># Upload</span> tagged image to registry</span><br><span class="line">docker run username/repository:<span class="keyword">tag</span>                   <span class="title"># Run</span> image from a registry</span><br></pre></td></tr></table></figure>
<h3 id="docker-service"><a href="#docker-service" class="headerlink" title="docker service"></a>docker service</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker stack ls                                            # List stacks <span class="keyword">or</span> apps</span><br><span class="line">docker stack deploy -c &lt;composefile&gt; &lt;appname&gt;  # <span class="builtin-name">Run</span> the specified Compose file</span><br><span class="line">docker<span class="built_in"> service </span>ls                 # List running services associated with an app</span><br><span class="line">docker<span class="built_in"> service </span>ps &lt;service&gt;                  # List tasks associated with an app</span><br><span class="line">docker inspect &lt;task <span class="keyword">or</span> container&gt;                   # Inspect task <span class="keyword">or</span> container</span><br><span class="line">docker container ls -q                                      # List container IDs</span><br><span class="line">docker stack rm &lt;appname&gt;                             # Tear down an application</span><br><span class="line">docker swarm leave --force      # Take down a single node swarm <span class="keyword">from</span> the manager</span><br></pre></td></tr></table></figure>
<p>需要<a href="https://api.github.com/repos/boot2docker/boot2docker/releases/latest" target="_blank" rel="external">https://api.github.com/repos/boot2docker/boot2docker/releases/latest</a> 下载，”html_url”: “<a href="https://github.com/boot2docker/boot2docker/releases/tag/v17.07.0-ce" target="_blank" rel="external">https://github.com/boot2docker/boot2docker/releases/tag/v17.07.0-ce</a>“</p>
<h3 id="swarm集群"><a href="#swarm集群" class="headerlink" title="swarm集群"></a>swarm集群</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">docker-machine create --virtualbox-boot2docker-url ~/.docker/machine/cache/boot2docker.iso manager1</span><br><span class="line"></span><br><span class="line">mv boot2docker.iso /Users/zhouxiaowu/.docker/machine/cache/</span><br><span class="line">docker-machine create --virtualbox-boot2docker-url ~/.docker/machine/cache/boot2docker.iso  myvm1</span><br><span class="line">docker-machine create --virtualbox-boot2docker-url ~/.docker/machine/cache/boot2docker.iso  myvm2</span><br><span class="line"></span><br><span class="line"><span class="number">10513</span>  docker-machine ssh myvm1 <span class="string">"docker swarm init --advertise-addr 192.168.99.101"</span></span><br><span class="line"></span><br><span class="line"><span class="number">10514</span>  docker-machine ls</span><br><span class="line"></span><br><span class="line"><span class="number">10515</span>  docker-machine ssh myvm2 <span class="string">"    docker swarm join --token SWMTKN-1-13x2fyyubrz6b0k0p86bpt0rjydu59ze8a7g4q6n4yn1aip7so-96zlikwtz3h7mmpa18ilu0i6g 192.168.99.101:2377"</span></span><br><span class="line"></span><br><span class="line"><span class="number">10516</span>  docker-machine ssh myvm1 <span class="string">"docker node ls"</span></span><br><span class="line"></span><br><span class="line"><span class="number">10520</span>  docker-machine env myvm1</span><br><span class="line"><span class="number">10521</span>  eval $(docker-machine env myvm1)</span><br><span class="line"></span><br><span class="line"><span class="number">10526</span>  docker stack deploy -c docker-compose.yml getstartedlab</span><br><span class="line"><span class="number">10527</span>  docker stack ls</span><br><span class="line"></span><br><span class="line"><span class="number">10529</span>  docker stack ps getstartedlab</span><br><span class="line"></span><br><span class="line"><span class="number">10530</span>  docker container ls</span><br><span class="line"></span><br><span class="line"><span class="number">10569</span>  docker stack ls</span><br><span class="line"><span class="number">10570</span>  docker stack rm getstartedlab</span><br><span class="line"><span class="number">10571</span>  docker-machine env -u</span><br><span class="line"></span><br><span class="line"><span class="number">10572</span>  eval $(docker-machine env -u)</span><br></pre></td></tr></table></figure>
<h1 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h1><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find</span> name</span><br><span class="line"></span><br><span class="line">lsof</span><br><span class="line"></span><br><span class="line">lsof -<span class="keyword">p</span> <span class="number">2951</span></span><br><span class="line"><span class="keyword">view</span></span><br><span class="line">ulimit -n <span class="number">1000</span></span><br><span class="line"><span class="keyword">cd</span> var/<span class="built_in">log</span></span><br><span class="line">minikube logs &gt;aa</span><br><span class="line"><span class="keyword">vim</span> aa</span><br><span class="line">kubectl <span class="built_in">get</span> pods --<span class="keyword">all</span>-namespaces</span><br></pre></td></tr></table></figure>
<h1 id="minikube命令"><a href="#minikube命令" class="headerlink" title="minikube命令"></a>minikube命令</h1><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动虚拟机</span></span><br><span class="line">minikube <span class="literal">start</span></span><br><span class="line"></span><br><span class="line">minikube <span class="literal">stop</span></span><br></pre></td></tr></table></figure>
<h1 id="k8s命令"><a href="#k8s命令" class="headerlink" title="k8s命令"></a>k8s命令</h1><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">kubectl pod</span><br><span class="line"></span><br><span class="line">kubectl <span class="built_in">get</span> pod</span><br><span class="line">kubectl <span class="built_in">get</span> pod XXX &gt; aa</span><br><span class="line">vim aa</span><br><span class="line"></span><br><span class="line">kubectl <span class="built_in">get</span> pod hello-minikube-5df766f774-ws8fk -o yaml</span><br><span class="line">kubectl edit  pod hello-minikube-5df766f774-ws8fk</span><br><span class="line"></span><br><span class="line">kubectl <span class="built_in">describe</span> pod XXX   //结合pod和event</span><br><span class="line"></span><br><span class="line">kubectl <span class="built_in">get</span> event</span><br><span class="line"></span><br><span class="line">kubectl <span class="built_in">get</span> services</span><br><span class="line">kubectl <span class="built_in">get</span> services hello-minikube -o yaml</span><br><span class="line"></span><br><span class="line">kubectl <span class="built_in">get</span> rs</span><br><span class="line">kubectl <span class="built_in">describe</span> rs</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">rename</span>-<span class="built_in">context</span> mini minikube2</span><br><span class="line"></span><br><span class="line">kubectl create -f .<span class="comment">/**.yaml -f ***.yaml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">wget https://.../k8s.tar.gz</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">example guestbook</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">sudo docker images</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">front-images  换成nginx</span></span><br></pre></td></tr></table></figure>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1 api<span class="built_in"> service </span>、2etcd 步 create_timestamp</span><br><span class="line">3 schedule -&gt; api service</span><br><span class="line"></span><br><span class="line">6 启动docker</span><br><span class="line"></span><br><span class="line">1. 3 node 1node down</span><br><span class="line">  load balancer -&gt; api<span class="built_in"> server </span>分发到另外两台</span><br><span class="line">  etcd</span><br><span class="line"></span><br><span class="line">2. scheduler/CM</span><br><span class="line">   死的node主，需要选举</span><br><span class="line"></span><br><span class="line">3. kubelet</span><br><span class="line">  		sysmtem 进程死掉自动拉起</span><br><span class="line"></span><br><span class="line">vimdiff aa bb</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl <span class="builtin-name">get</span> rs</span><br><span class="line">kubectl <span class="builtin-name">get</span> deployment</span><br><span class="line"><span class="comment">##扩容或缩容</span></span><br><span class="line">kubectl scale <span class="attribute">--replicas</span>=2 deployment/frontend</span><br><span class="line"></span><br><span class="line">sudo docker <span class="builtin-name">run</span> XXX</span><br><span class="line"></span><br><span class="line">kubectl <span class="builtin-name">get</span> pod --all-name-space</span><br><span class="line"></span><br><span class="line">kubectl logs xxx</span><br><span class="line"></span><br><span class="line"><span class="comment">##寻取帮助</span></span><br><span class="line">kubectl logs -h</span><br><span class="line"></span><br><span class="line"><span class="comment">## busybox终端</span></span><br><span class="line">kubectl <span class="builtin-name">run</span> -i --tty busybox</span><br><span class="line"></span><br><span class="line">kubectl attach XXX -i</span><br><span class="line"></span><br><span class="line">kubectl top pod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl delete deployment XXX</span><br><span class="line">kubectl delete pod XXX</span><br><span class="line"></span><br><span class="line">用于查错s</span><br><span class="line">kubectl cluster-<span class="builtin-name">info</span> dump <span class="attribute">--out-directory</span>=tmp</span><br></pre></td></tr></table></figure>
<h1 id="k8s"><a href="#k8s" class="headerlink" title="k8s"></a>k8s</h1><ol>
<li><p>安装docker <a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/" target="_blank" rel="external">https://docs.docker.com/install/linux/docker-ce/ubuntu/</a></p>
</li>
<li><p>从github上下载minikube二进制 <a href="https://github.com/kubernetes/minikube/releases" target="_blank" rel="external">https://github.com/kubernetes/minikube/releases</a></p>
</li>
<li><p>墙内安装kubectl <a href="https://www.kubernetes.org.cn/installkubectl" target="_blank" rel="external">https://www.kubernetes.org.cn/installkubectl</a></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bin dpkg-<span class="keyword">deb</span> -<span class="keyword">x</span> kubelet.<span class="keyword">deb</span> tmp</span><br><span class="line"><span class="keyword">cd</span> tmp</span><br><span class="line"><span class="keyword">cp</span> ./usr/bin/kubectl /usr/local/bin</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动minikube，绕过gcr.io下无法下载镜像的问题</p>
</li>
</ol>
<ul>
<li>  观察日志/var/lib/localkube/*.err</li>
<li>  docker pull kubernetes/pause</li>
<li>  docker pull grrywlsn/kubernetes-addon-manager:v1.8.0</li>
</ul>
<p>Kubectl、Kubeadm国内下载地址：</p>
<p><a href="https://mirrors.ustc.edu.cn/kubernetes/apt/pool/" target="_blank" rel="external">https://mirrors.ustc.edu.cn/kubernetes/apt/pool/</a></p>
<p>安装和设置kubectl</p>
<p><a href="https://www.kubernetes.org.cn/installkubectl" target="_blank" rel="external">https://www.kubernetes.org.cn/installkubectl</a></p>
<h1 id="Kubectl-客户端的下载和配置"><a href="#Kubectl-客户端的下载和配置" class="headerlink" title="Kubectl 客户端的下载和配置"></a>Kubectl 客户端的下载和配置</h1><p><a href="http://blog.csdn.net/csdn_duomaomao/article/details/76159874" target="_blank" rel="external">http://blog.csdn.net/csdn_duomaomao/article/details/76159874</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhouxiaowu.coding.me/2018/01/15/mybatis中-和-的区别/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/15/mybatis中-和-的区别/" itemprop="url">mybatis中#和$的区别</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-15T10:29:33+08:00">
                2018-01-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/15/mybatis中-和-的区别/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/15/mybatis中-和-的区别/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  553
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  2
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>　　今天在工作中有个点击排序的功能调试了许久，终寻因，总结之。<br>　　需求是这样的，页面有个table，有一列的上下箭头可点击并排序。对于这种需求，我的mybatis.xml的sql配置写成了如下：</p>
<if test="map.ColumnNameSort!=null and map.ColumnNameSort!=''"><br>　　ORDER BY columnName #{map.ColumnNameSort}<br></if>

<p>　　ColumnNameSort即前端传的排序方式，asc或者desc。</p>
<p>　　然后，预计它的输出应该是类似于下面这样的</p>
<p>ORDER BY columnName desc</p>
<p>　　但是，真正跑起来时，排序的效果一直没出现，经常一番查找，发现是mybatis 的’#{}’传值的问题，它将sql语句编译成了如下</p>
<p>ORDER BY columnName ‘desc’ 或者 ORDER BY columnName ‘asc’</p>
<p>　　这样，desc或者asc就成了字符串而不是关键字，sql语句的意思是columnName的别名是desc或者asc，没加排序关键字时默认是正序排序，成了如下</p>
<p>ORDER BY columnName “desc” asc 或者 ORDER BY columnName “asc” asc</p>
<p>　　排序没效果的问题找到原因了，解决之，mybatis提供了另一种绑定参数的方式–${param}，将sql配置改为</p>
<p>ORDER BY columnName ${map.ColumnNameSort}</p>
<p>　　这样一来，mybatis会直接将ColumnNameSort的值加入sql中，不会转义。正确结果：</p>
<p>ORDER BY columnName desc</p>
<p>　　<strong>最后，对于mybatis中#和$绑定参数的区别做个总结，避免以后类似的问题发生。</strong></p>
<ul>
<li>＃{}将传入的数据都当成一个字符串，会对自动传入的数据加一个双引号。如：order by #{id}，如果传入的值是111,那么解析成sql时的值为order by “111”, 如果传入的值是id，则解析成的sql为order by “id”。</li>
<li>${}将传入的数据直接显示生成在sql中。如：order by ${id}，如果传入的值是111,那么解析成sql时的值为order by 111, 如果传入的值是id，则解析成的sql为order by id。</li>
</ul>
<ul>
<li>‘#’方式 能够很大程度防止sql注入。</li>
</ul>
<ul>
<li>$方式无法防止Sql注入。</li>
<li>$方式一般用于传入数据库对象，例如传入表名.</li>
<li>一般能用#的就别用$.</li>
</ul>
<p>ps:在使用mybatis中还遇到&lt;![CDATA[]]&gt;的用法，在该符号内的语句，将不会被当成字符串来处理，而是直接当成sql语句，比如要执行一个存储过程。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/11/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/13/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/xiaowu_avatar.jpg"
                alt="周小伍 Joey" />
            
              <p class="site-author-name" itemprop="name">周小伍 Joey</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">150</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">周小伍 Joey</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">276.8k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    
      <script id="dsq-count-scr" src="https://joeyblog.disqus.com/count.js" async></script>
    

    

  




	





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
