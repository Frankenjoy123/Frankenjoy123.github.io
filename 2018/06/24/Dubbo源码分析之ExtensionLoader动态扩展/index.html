<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Dubbo," />










<meta name="description" content="1. 相关注解SPI定义一个扩展点，service provider interface Adaptive自适应扩展点，在{@link ExtensionLoader}生成Extension的Adaptive Instance时，为{@link ExtensionLoader}提供信息。 Activate自动激活加载扩展点 在这个源码中可以看到有两个注 解，一个是在类级别上的@SPI(“dubbo">
<meta name="keywords" content="Dubbo">
<meta property="og:type" content="article">
<meta property="og:title" content="Dubbo源码分析之ExtensionLoader动态扩展">
<meta property="og:url" content="http://yoursite.com/2018/06/24/Dubbo源码分析之ExtensionLoader动态扩展/index.html">
<meta property="og:site_name" content="xiaowu&#39;s blog">
<meta property="og:description" content="1. 相关注解SPI定义一个扩展点，service provider interface Adaptive自适应扩展点，在{@link ExtensionLoader}生成Extension的Adaptive Instance时，为{@link ExtensionLoader}提供信息。 Activate自动激活加载扩展点 在这个源码中可以看到有两个注 解，一个是在类级别上的@SPI(“dubbo">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://oz3qait0p.bkt.clouddn.com/ExtensionLoader%E6%97%B6%E5%BA%8F%E5%9B%BE.png">
<meta property="og:updated_time" content="2019-08-22T02:51:07.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Dubbo源码分析之ExtensionLoader动态扩展">
<meta name="twitter:description" content="1. 相关注解SPI定义一个扩展点，service provider interface Adaptive自适应扩展点，在{@link ExtensionLoader}生成Extension的Adaptive Instance时，为{@link ExtensionLoader}提供信息。 Activate自动激活加载扩展点 在这个源码中可以看到有两个注 解，一个是在类级别上的@SPI(“dubbo">
<meta name="twitter:image" content="http://oz3qait0p.bkt.clouddn.com/ExtensionLoader%E6%97%B6%E5%BA%8F%E5%9B%BE.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/06/24/Dubbo源码分析之ExtensionLoader动态扩展/"/>





  <title>Dubbo源码分析之ExtensionLoader动态扩展 | xiaowu's blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3da41265a1a0042eebe5413c0d6c76f5";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">xiaowu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/24/Dubbo源码分析之ExtensionLoader动态扩展/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周小伍 Joey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xiaowu_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaowu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Dubbo源码分析之ExtensionLoader动态扩展</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-24T10:36:57+08:00">
                2018-06-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Dubbo/" itemprop="url" rel="index">
                    <span itemprop="name">Dubbo</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/06/24/Dubbo源码分析之ExtensionLoader动态扩展/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/06/24/Dubbo源码分析之ExtensionLoader动态扩展/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3.8k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  19
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="1-相关注解"><a href="#1-相关注解" class="headerlink" title="1. 相关注解"></a>1. 相关注解</h1><h2 id="SPI"><a href="#SPI" class="headerlink" title="SPI"></a>SPI</h2><p>定义一个扩展点，service provider interface</p>
<h2 id="Adaptive"><a href="#Adaptive" class="headerlink" title="Adaptive"></a>Adaptive</h2><p><strong>自适应扩展点</strong>，在{@link ExtensionLoader}生成Extension的Adaptive Instance时，为{@link ExtensionLoader}提供信息。</p>
<h2 id="Activate"><a href="#Activate" class="headerlink" title="Activate"></a>Activate</h2><p>自动激活加载扩展点</p>
<p>在这个源码中可以看到有两个注 解，一个是在类级别上的@SPI(“dubbo”), 另一个是 @Adaptive<br>@SPI 表示当前这个接口是一个扩展点，可以实现自己的 扩展实现，默认的扩展点是 DubboProtocol。<br>@Adaptive 表示一个自适应扩展点，在方法级别上，会动态拼接字符串生成一个适配器类。在类上，则不会。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SPI</span>(<span class="string">"dubbo"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Protocol</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getDefaultPort</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Adaptive</span></span><br><span class="line">    &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(Invoker&lt;T&gt; invoker)</span> <span class="keyword">throws</span> RpcException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Adaptive</span></span><br><span class="line">    &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-getAdaptiveExtension获取自适应的扩展点流程"><a href="#2-getAdaptiveExtension获取自适应的扩展点流程" class="headerlink" title="2. getAdaptiveExtension获取自适应的扩展点流程"></a>2. getAdaptiveExtension获取自适应的扩展点流程</h1><h2 id="时序图如下："><a href="#时序图如下：" class="headerlink" title="时序图如下："></a>时序图如下：</h2><p><img src="http://oz3qait0p.bkt.clouddn.com/ExtensionLoader%E6%97%B6%E5%BA%8F%E5%9B%BE.png" alt="http://oz3qait0p.bkt.clouddn.com/ExtensionLoader%E6%97%B6%E5%BA%8F%E5%9B%BE.png"></p>
<h2 id="getExtensionLoader"><a href="#getExtensionLoader" class="headerlink" title="getExtensionLoader"></a>getExtensionLoader</h2><p>不存在，new一个<br><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ExtensionLoader&lt;T&gt; getExtensionLoader(Class&lt;T&gt; <span class="class"><span class="keyword">type</span>) &#123;</span></span><br><span class="line"><span class="comment">//异常null处理省略。。。</span></span><br><span class="line">        ExtensionLoader&lt;T&gt; loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(<span class="class"><span class="keyword">type</span>);</span></span><br><span class="line">        <span class="keyword">if</span> (loader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            EXTENSION_LOADERS.putIfAbsent(<span class="class"><span class="keyword">type</span>, <span class="title">new</span> <span class="title">ExtensionLoader</span>&lt;T&gt;</span>(<span class="class"><span class="keyword">type</span>));</span></span><br><span class="line">            loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(<span class="class"><span class="keyword">type</span>);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> loader;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ExtensionLoader(Class&lt;?&gt; <span class="class"><span class="keyword">type</span>) &#123;//<span class="title">Protocol</span>.<span class="title">class</span></span></span><br><span class="line">    this.<span class="keyword">type</span> = <span class="class"><span class="keyword">type</span>;</span></span><br><span class="line">    objectFactory = (<span class="class"><span class="keyword">type</span> </span>== ExtensionFactory.<span class="keyword">class</span> ? <span class="keyword">null</span> :</span><br><span class="line">            ExtensionLoader.getExtensionLoader(ExtensionFactory.<span class="keyword">class</span>).</span><br><span class="line">                    getAdaptiveExtension());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="getAdaptiveExtension"><a href="#getAdaptiveExtension" class="headerlink" title="getAdaptiveExtension"></a>getAdaptiveExtension</h2><p>这个方法里面主要做几个事情:</p>
<ol>
<li>从 cacheAdaptiveInstance 这个内存缓存中获得一个对<br>象实例</li>
<li>如果实例为空，说明是第一次加载，则通过双重检查锁的方式去创建一个适配器扩展点<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public T getAdaptiveExtension() &#123;</span><br><span class="line">    Object<span class="built_in"> instance </span>= cachedAdaptiveInstance.<span class="builtin-name">get</span>();</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(createAdaptiveInstanceError == <span class="literal">null</span>) &#123;</span><br><span class="line">            synchronized (cachedAdaptiveInstance) &#123;</span><br><span class="line">               <span class="built_in"> instance </span>= cachedAdaptiveInstance.<span class="builtin-name">get</span>();</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                       <span class="built_in"> instance </span>= createAdaptiveExtension();</span><br><span class="line">                        cachedAdaptiveInstance.<span class="builtin-name">set</span>(instance);</span><br><span class="line">                    &#125; catch (Throwable t) &#123;</span><br><span class="line">                        createAdaptiveInstanceError = t;</span><br><span class="line">                        throw new IllegalStateException(<span class="string">"fail to create adaptive instance: "</span> + t.toString(), t);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return (T) instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="createAdaptiveExtension"><a href="#createAdaptiveExtension" class="headerlink" title="createAdaptiveExtension"></a>createAdaptiveExtension</h2><p>这段代码里面有两个结构，一个是 injectExtension. 另一 个是 getAdaptiveExtensionClass()</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> T createAdaptiveExtension() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//可以实现扩展点的注入</span></span><br><span class="line">        <span class="keyword">return</span> injectExtension((T) getAdaptiveExtensionClass().<span class="keyword">new</span><span class="type">Instance</span>());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalStateException</span>(<span class="string">"Can not create adaptive extenstion "</span> + type + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="getAdaptiveExtensionClass"><a href="#getAdaptiveExtensionClass" class="headerlink" title="getAdaptiveExtensionClass"></a>getAdaptiveExtensionClass</h2><p>从类名来看，是获得一个适配器扩展点的类。 在这段代码中，做了两个事情</p>
<ol>
<li>getExtensionClasses() 加载所有路径下的扩展点</li>
<li>createAdaptiveExtensionClass() 动态创建一个扩展点 cachedAdaptiveClass 这里有个判断，用来判断当前 Protocol 这个扩展点是否存在一个自定义的适配器，如果 有，则直接返回自定义适配器，否则，就动态创建，这个值 是在 getExtensionClasses 中赋值的，这块代码我们稍后再看<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Class&lt;?&gt; getAdaptiveExtensionClass() &#123;</span><br><span class="line">    getExtensionClasses();</span><br><span class="line">    <span class="keyword">if</span> (cachedAdaptiveClass != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> cachedAdaptiveClass; <span class="comment">//AdaptiveCompiler</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cachedAdaptiveClass = createAdaptiveExtensionClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="createAdaptiveExtensionClass"><a href="#createAdaptiveExtensionClass" class="headerlink" title="createAdaptiveExtensionClass"></a>createAdaptiveExtensionClass</h2><p>动态生成适配器代码，以及动态编译</p>
<ol>
<li>createAdaptiveExtensionClassCode, 动态创建一个字节码文件。返回 code 这个字符串</li>
<li>通过 compiler.compile 进行编译(默认情况下使用的是javassist)</li>
<li>通过 ClassLoader 加载到 jvm 中<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建一个适配器扩展点。（创建一个动态的字节码文件）</span></span><br><span class="line">private Class&lt;?&gt; createAdaptiveExtensionClass() &#123;</span><br><span class="line">    <span class="comment">//生成字节码代码</span></span><br><span class="line">    <span class="keyword">String</span> <span class="built_in">code</span> = createAdaptiveExtensionClassCode();</span><br><span class="line">    <span class="comment">//获得类加载器</span></span><br><span class="line">    ClassLoader classLoader = findClassLoader();</span><br><span class="line">    com.alibaba.dubbo.common.compiler.Compiler compiler = ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.common.compiler.Compiler.class).getAdaptiveExtension();</span><br><span class="line">    <span class="comment">//动态编译字节码</span></span><br><span class="line">    <span class="keyword">return</span> compiler.<span class="keyword">compile</span>(<span class="built_in">code</span>, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>code的字节码内容<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Protocol</span>$<span class="title">Adaptive</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">alibaba</span>.<span class="title">dubbo</span>.<span class="title">rpc</span>.<span class="title">Protocol</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"method public abstract void com.alibaba.dubbo.rpc.Protocol.destroy() of interface com.alibaba.dubbo.rpc.Protocol is not adaptive method!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDefaultPort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"method public abstract int com.alibaba.dubbo.rpc.Protocol.getDefaultPort() of interface com.alibaba.dubbo.rpc.Protocol is not adaptive method!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> com.alibaba.dubbo.rpc.<span class="function">Invoker <span class="title">refer</span><span class="params">(java.lang.Class arg0, com.alibaba.dubbo.common.URL arg1)</span> <span class="keyword">throws</span> com.alibaba.dubbo.rpc.RpcException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (arg1 == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"url == null"</span>);</span><br><span class="line">        com.alibaba.dubbo.common.URL url = arg1;</span><br><span class="line">        String extName = (url.getProtocol() == <span class="keyword">null</span> ? <span class="string">"dubbo"</span> : url.getProtocol());</span><br><span class="line">        <span class="keyword">if</span> (extName == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Fail to get extension(com.alibaba.dubbo.rpc.Protocol) name from url("</span> + url.toString() + <span class="string">") use keys([protocol])"</span>);</span><br><span class="line">        com.alibaba.dubbo.rpc.Protocol extension = (com.alibaba.dubbo.rpc.Protocol) ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.rpc.Protocol.class).getExtension(extName);</span><br><span class="line">        <span class="keyword">return</span> extension.refer(arg0, arg1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> com.alibaba.dubbo.rpc.<span class="function">Exporter <span class="title">export</span><span class="params">(com.alibaba.dubbo.rpc.Invoker arg0)</span> <span class="keyword">throws</span> com.alibaba.dubbo.rpc.RpcException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (arg0 == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"com.alibaba.dubbo.rpc.Invoker argument == null"</span>);</span><br><span class="line">        <span class="keyword">if</span> (arg0.getUrl() == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"com.alibaba.dubbo.rpc.Invoker argument getUrl() == null"</span>);</span><br><span class="line">        com.alibaba.dubbo.common.URL url = arg0.getUrl();</span><br><span class="line">        String extName = (url.getProtocol() == <span class="keyword">null</span> ? <span class="string">"dubbo"</span> : url.getProtocol());</span><br><span class="line">        <span class="keyword">if</span> (extName == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Fail to get extension(com.alibaba.dubbo.rpc.Protocol) name from url("</span> + url.toString() + <span class="string">") use keys([protocol])"</span>);</span><br><span class="line">        com.alibaba.dubbo.rpc.Protocol extension = (com.alibaba.dubbo.rpc.Protocol) ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.rpc.Protocol.class).getExtension(extName);</span><br><span class="line">        <span class="keyword">return</span> extension.export(arg0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Protocol$Adaptive 的主要功能</p>
<ol>
<li>从 url 或扩展接口获取扩展接口实现类的名称;</li>
<li>根 据 名 称 ， 获 取 实 现 类 ExtensionLoader.getExtensionLoader( 扩 展 接 口 类).getExtension(扩展接口实现类名称)，然后调用实现类 的方法。<br>需要明白一点 dubbo 的内部传参基本上都是基于 Url 来实 现的，也就是说 Dubbo 是基于 URL 驱动的技术 所以，适配器类的目的是在运行期获取扩展的真正实现来调用，解耦接口和实现，这样的话不要我们自己实现适配器类，而这些都是通过 Adpative 来实现。<br>到目前为止，我们的 AdaptiveExtension 的主线走完了，可 以简单整理一下他们的调用关系如下</li>
</ol>
<h2 id="getExtensionClasses"><a href="#getExtensionClasses" class="headerlink" title="getExtensionClasses"></a>getExtensionClasses</h2><p>这段代码主要做如下几个事情</p>
<ol>
<li>从 cachedClasses 中获得一个结果，这个结果实际上就 是所有的扩展点类，key 对应 name，value 对应 class</li>
<li>通过双重检查锁进行判断</li>
<li>调用 loadExtensionClasses，去加载左右扩展点的实现</li>
</ol>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//加载扩展点的实现类</span></span><br><span class="line">private <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, Class&lt;?&gt;&gt; getExtensionClasses() &#123;</span><br><span class="line"></span><br><span class="line">       <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, Class&lt;?&gt;&gt; classes = cachedClasses.<span class="keyword">get</span>();</span><br><span class="line">       <span class="keyword">if</span> (classes == <span class="keyword">null</span>) &#123;</span><br><span class="line">           synchronized (cachedClasses) &#123;</span><br><span class="line">               classes = cachedClasses.<span class="keyword">get</span>();</span><br><span class="line">               <span class="keyword">if</span> (classes == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   classes = loadExtensionClasses();</span><br><span class="line">                   cachedClasses.<span class="keyword">set</span>(classes);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> classes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="loadExtensionClasses"><a href="#loadExtensionClasses" class="headerlink" title="loadExtensionClasses"></a>loadExtensionClasses</h2><p>从不同目录去加载扩展点的实现，META-INF/dubbo ; META-INF/internal ; META- INF/ser vices<br>主要逻辑</p>
<ol>
<li>获得当前扩展点的注解，也就是 Protocol.class 这个类的 注解，@SPI</li>
<li>判断这个注解不为空，则再次获得@SPI 中的 value 值</li>
<li>如果 value 有值，也就是@SPI(“dubbo”)，则讲这个 dubbo 的值赋给 cachedDefaultName。这就是为什么<br>我们能够通过 ExtensionLoader.getExtensionLoader(Protocol.class).getDefaultExtension() ,能够获得 DubboProtocol 这个扩 展点的原因</li>
<li>最后，通过 loadFile 去加载指定路径下的所有扩展点。 也 就 是 META-INF/dubbo;META-INF/internal;META-INF/services</li>
</ol>
<p>读取<code>com.alibaba.dubbo.common.extension.ExtensionFactory</code>的文件内容，按行读取，文件采用 name=value 方式<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adaptive=com<span class="selector-class">.alibaba</span><span class="selector-class">.dubbo</span><span class="selector-class">.common</span><span class="selector-class">.extension</span><span class="selector-class">.factory</span><span class="selector-class">.AdaptiveExtensionFactory</span></span><br><span class="line">spi=com<span class="selector-class">.alibaba</span><span class="selector-class">.dubbo</span><span class="selector-class">.common</span><span class="selector-class">.extension</span><span class="selector-class">.factory</span><span class="selector-class">.SpiExtensionFactory</span></span><br><span class="line">spring=com<span class="selector-class">.alibaba</span><span class="selector-class">.dubbo</span><span class="selector-class">.config</span><span class="selector-class">.spring</span><span class="selector-class">.extension</span><span class="selector-class">.SpringExtensionFactory</span></span><br></pre></td></tr></table></figure></p>
<h3 id="1-Adaptive注解在类上"><a href="#1-Adaptive注解在类上" class="headerlink" title="1.Adaptive注解在类上"></a>1.Adaptive注解在类上</h3><p>Apaptive注解在类上，比如<code>AdaptiveExtensionFactory</code>是<code>ExtensionFactory</code>的实现，则直接<code>cachedAdaptiveClass = clazz</code>。因为<code>`cachedAdaptiveClass</code>已经不为null，不会去再执行动态拼接字节码。</p>
<p>@Adaptive如果是加在类上， 表示当前类是一个自定义的自适应扩展点 。如果是加在方<br>法级别上，表示需要动态创建一个自适应扩展点，也就是Protocol$Adaptive</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (clazz.isAnnotationPresent(Adaptive.class)) &#123;</span><br><span class="line">    <span class="keyword">if</span>(cachedAdaptiveClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">        cachedAdaptiveClass = clazz;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (! cachedAdaptiveClass.equals(clazz)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"More than 1 adaptive class found: "</span>+ 			      cachedAdaptiveClass.getClass().getName()+ <span class="string">", "</span> + clazz.getClass().getName());</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Class&lt;?&gt; getAdaptiveExtensionClass() &#123;</span><br><span class="line">    getExtensionClasses();</span><br><span class="line">    <span class="comment">//如果cachedAdaptiveClass已经赋值，直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (cachedAdaptiveClass != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> cachedAdaptiveClass;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cachedAdaptiveClass = createAdaptiveExtensionClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-类没有Adaptive注解"><a href="#2-类没有Adaptive注解" class="headerlink" title="2.类没有Adaptive注解"></a>2.类没有Adaptive注解</h3><p>如果类没有<code>Adaptive</code>注解，比如<code>SpringExtensionFactory</code>，不存在（ExtensionFactory）的构造函数，走catch的逻辑，<code>spring=com.alibaba.dubbo.config.spring.extension.SpringExtensionFactory</code>，最后分别向<code>cachedNames</code>和<code>extensionClasses</code>存入key value : 字符串spring和SpringExtensionFactory的class字节码。</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        clazz.getConstructor(<span class="class"><span class="keyword">type</span>);</span></span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; wrappers = cachedWrapperClasses;</span><br><span class="line">        <span class="keyword">if</span> (wrappers == <span class="keyword">null</span>) &#123;</span><br><span class="line">            cachedWrapperClasses = <span class="keyword">new</span> ConcurrentHashSet&lt;Class&lt;?&gt;&gt;();</span><br><span class="line">            wrappers = cachedWrapperClasses;</span><br><span class="line">        &#125;</span><br><span class="line">        wrappers.add(clazz);</span><br><span class="line">    &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">    <span class="comment">//SpringExtensionFactory不存在（ExtensionFactory）的构造函数</span></span><br><span class="line">        clazz.getConstructor();</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            name = findAnnotationName(clazz);</span><br><span class="line">            <span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (clazz.getSimpleName().length() &gt; <span class="class"><span class="keyword">type</span>.<span class="title">getSimpleName</span></span>().length()</span><br><span class="line">                        &amp;&amp; clazz.getSimpleName().endsWith(<span class="class"><span class="keyword">type</span>.<span class="title">getSimpleName</span></span>())) &#123;</span><br><span class="line">                    name = clazz.getSimpleName().substring(<span class="number">0</span>, clazz.getSimpleName().length() - <span class="class"><span class="keyword">type</span>.<span class="title">getSimpleName</span></span>().length()).toLowerCase();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    throw <span class="keyword">new</span> IllegalStateException(<span class="string">"No such extension name for the class "</span> + clazz.getName() + <span class="string">" in the config "</span> + url);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] names = NAME_SEPARATOR.split(name);</span><br><span class="line">        <span class="keyword">if</span> (names != <span class="keyword">null</span> &amp;&amp; names.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            Activate activate = clazz.getAnnotation(Activate.<span class="keyword">class</span>);</span><br><span class="line">            <span class="keyword">if</span> (activate != <span class="keyword">null</span>) &#123;</span><br><span class="line">                cachedActivates.put(names[<span class="number">0</span>], activate);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (String n : names) &#123;</span><br><span class="line">                <span class="keyword">if</span> (! cachedNames.containsKey(clazz)) &#123;</span><br><span class="line">                    cachedNames.put(clazz, n);</span><br><span class="line">                &#125;</span><br><span class="line">                Class&lt;?&gt; c = extensionClasses.get(n);</span><br><span class="line">                <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    extensionClasses.put(n, clazz);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c != clazz) &#123;</span><br><span class="line">                    throw <span class="keyword">new</span> IllegalStateException(<span class="string">"Duplicate extension "</span> + <span class="class"><span class="keyword">type</span>.<span class="title">getName</span></span>() + <span class="string">" name "</span> + n + <span class="string">" on "</span> + c.getName() + <span class="string">" and "</span> + clazz.getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-存在构造函数"><a href="#3-存在构造函数" class="headerlink" title="3.存在构造函数"></a>3.存在构造函数</h3><p><code>ProtocolListenerWrapper</code>存在构造函数<code>ProtocolListenerWrapper(Protocol protocol)</code>，则向wrappers集合中添加clazz</p>
<p>如果没有 Adaptive 注解，则判断当前类是否带有参数是 type 类型的构造函数，如果有，则认为是wrapper 类。这个 wrapper 实际上就是对扩展类进行装 饰.<br>可 以在 dubbo-rpc-api/internal 下找到 Protocol 文件，发现 Protocol 配置了 3 个装饰<br>分别是,filter/listener/mock. 所以 Protocol 这个实 例来说，会增加对应的装饰器</p>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">clazz.getConstructor(type);</span><br><span class="line">    Set&lt;<span class="class"><span class="keyword">Class</span>&lt;?&gt;&gt; <span class="title">wrappers</span> = <span class="title">cachedWrapperClasses</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (wrappers == <span class="literal">null</span>) &#123;</span><br><span class="line">        cachedWrapperClasses = <span class="keyword">new</span> ConcurrentHashSet&lt;<span class="class"><span class="keyword">Class</span>&lt;?&gt;&gt;();</span></span><br><span class="line">        wrappers = cachedWrapperClasses;</span><br><span class="line">    &#125;</span><br><span class="line">    wrappers.add(clazz);</span><br></pre></td></tr></table></figure>
<h1 id="3-ExtensionFactory"><a href="#3-ExtensionFactory" class="headerlink" title="3. ExtensionFactory"></a>3. ExtensionFactory</h1><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ExtensionLoader.getExtensionLoader(ExtensionFactory.class).</span><br><span class="line"><span class="function"><span class="title">getAdaptiveExtension</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p>Object object = objectFactory.getExtension(pt, property); objectFactory =&gt; AdaptiveExtensionFactory</p>
<ul>
<li>AdaptiveExtensionFactory<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; T getExtension(Class&lt;T&gt; <span class="class"><span class="keyword">type</span>, <span class="title">String</span> <span class="title">name</span>) &#123;</span></span><br><span class="line">    <span class="keyword">for</span> (ExtensionFactory factory : factories) &#123;</span><br><span class="line">        T extension = factory.getExtension(<span class="class"><span class="keyword">type</span>, <span class="title">name</span>);</span></span><br><span class="line">        <span class="keyword">if</span> (extension != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> extension;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">registry</span>://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2181</span>/com.alibaba.dubbo.<span class="keyword">registry</span>.RegistryService?application=dubbo-client&amp;dubbo=<span class="number">2.5</span><span class="number">.3</span>&amp;owner=joey&amp;<span class="keyword">pid</span>=<span class="number">57644</span>&amp;<span class="keyword">registry</span>=zookeeper&amp;timestamp=<span class="number">1529844392952</span></span><br></pre></td></tr></table></figure>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">            <span class="built_in">if</span> (urls.<span class="built_in">size</span>() == <span class="number">1</span>) &#123;</span><br><span class="line">                invoker = refprotocol.refer(interfaceClass, urls.<span class="built_in">get</span>(<span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//这里invoker为           MockClusterInvoker</span></span><br></pre></td></tr></table></figure>
<figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public com.alibaba.dubbo.rpc.Invoker refer(java.lang.Class arg0, com.alibaba.dubbo.common.URL arg1) &#123;</span><br><span class="line">    <span class="keyword">if</span> (arg1 == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"url == null"</span>);</span><br><span class="line">    com.alibaba.dubbo.common.URL <span class="built_in">url</span> = arg1;</span><br><span class="line">    <span class="built_in">String</span> extName = ( <span class="built_in">url</span>.getProtocol() == <span class="literal">null</span> ? <span class="string">"dubbo"</span> : <span class="built_in">url</span>.getProtocol() );</span><br><span class="line">    <span class="keyword">if</span>(extName == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Fail to get extension(com.alibaba.dubbo.rpc.Protocol) name from url("</span> + <span class="built_in">url</span>.toString() + <span class="string">") use keys([protocol])"</span>);</span><br><span class="line">    com.alibaba.dubbo.rpc.Protocol extension = (com.alibaba.dubbo.rpc.Protocol)ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.rpc.Protocol.class).getExtension(extName);</span><br><span class="line">    <span class="keyword">return</span> extension.refer(arg0, arg1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; Invoker&lt;T&gt; refer(Class&lt;T&gt; <span class="keyword">type</span>, URL url) throws RpcException &#123;</span><br><span class="line">       url = url.setProtocol(url.getParameter(Constants.REGISTRY_KEY, Constants.DEFAULT_REGISTRY)).removeParameter(Constants.REGISTRY_KEY);</span><br><span class="line">       <span class="comment">//获得注册中心</span></span><br><span class="line">       Registry registry = registryFactory.getRegistry(url);</span><br><span class="line">       <span class="keyword">if</span> (RegistryService.class.<span class="keyword">equals</span>(<span class="keyword">type</span>)) &#123;</span><br><span class="line">       	<span class="keyword">return</span> proxyFactory.getInvoker((T) registry, <span class="keyword">type</span>, url);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// group="a,b" or group="*"</span></span><br><span class="line">       <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; qs = StringUtils.parseQueryString(url.getParameterAndDecoded(Constants.REFER_KEY));</span><br><span class="line">       <span class="built_in">String</span> <span class="keyword">group</span> = qs.get(Constants.GROUP_KEY);</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">group</span> != <span class="built_in">null</span> &amp;&amp; <span class="keyword">group</span>.length() &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">           <span class="keyword">if</span> ( ( Constants.COMMA_SPLIT_PATTERN.split( <span class="keyword">group</span> ) ).length &gt; <span class="number">1</span></span><br><span class="line">                   || <span class="string">"*"</span>.<span class="keyword">equals</span>( <span class="keyword">group</span> ) ) &#123;</span><br><span class="line">               <span class="keyword">return</span> doRefer( getMergeableCluster(), registry, <span class="keyword">type</span>, url );</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> doRefer(cluster, registry, <span class="keyword">type</span>, url);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">private</span> &lt;<span class="type">T</span>&gt; <span class="type">Invoker</span>&lt;<span class="type">T</span>&gt; doRefer(<span class="type">Cluster</span> cluster, <span class="type">Registry</span> registry, <span class="type">Class</span>&lt;<span class="type">T</span>&gt; <span class="class"><span class="keyword">type</span>, <span class="type">URL</span> url) &#123;</span></span><br><span class="line"><span class="class">    <span class="type">RegistryDirectory</span>&lt;<span class="type">T</span>&gt; <span class="title">directory</span> = <span class="title">new</span> <span class="type">RegistryDirectory</span>&lt;<span class="type">T</span>&gt;(<span class="title">type</span>, <span class="title">url</span>);</span></span><br><span class="line"><span class="class">    <span class="title">directory</span>.<span class="title">setRegistry</span>(<span class="title">registry</span>);</span></span><br><span class="line"><span class="class">    <span class="title">directory</span>.<span class="title">setProtocol</span>(<span class="title">protocol</span>);</span></span><br><span class="line"><span class="class">    <span class="type">URL</span> <span class="title">subscribeUrl</span> = <span class="title">new</span> <span class="type">URL</span>(<span class="type">Constants</span>.<span class="type">CONSUMER_PROTOCOL</span>, <span class="type">NetUtils</span>.<span class="title">getLocalHost</span>(), 0, <span class="title">type</span>.<span class="title">getName</span>(), <span class="title">directory</span>.<span class="title">getUrl</span>().<span class="title">getParameters</span>());</span></span><br><span class="line"><span class="class">    <span class="title">if</span> (! <span class="type">Constants</span>.<span class="type">ANY_VALUE</span>.<span class="title">equals</span>(<span class="title">url</span>.<span class="title">getServiceInterface</span>())</span></span><br><span class="line"><span class="class">            &amp;&amp; <span class="title">url</span>.<span class="title">getParameter</span>(<span class="type">Constants</span>.<span class="type">REGISTER_KEY</span>, <span class="title">true</span>)) &#123;</span></span><br><span class="line"><span class="class">            //将消费者的地址注册到<span class="title">zk</span></span></span><br><span class="line"><span class="class">        <span class="title">registry</span>.<span class="title">register</span>(<span class="title">subscribeUrl</span>.<span class="title">addParameters</span>(<span class="type">Constants</span>.<span class="type">CATEGORY_KEY</span>, <span class="type">Constants</span>.<span class="type">CONSUMERS_CATEGORY</span>,</span></span><br><span class="line"><span class="class">                <span class="type">Constants</span>.<span class="type">CHECK_KEY</span>, <span class="type">String</span>.<span class="title">valueOf</span>(<span class="title">false</span>)));</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line">    directory.subscribe(subscribeUrl.addParameter(<span class="type">Constants</span>.<span class="type">CATEGORY_KEY</span>,</span><br><span class="line">            <span class="type">Constants</span>.<span class="type">PROVIDERS_CATEGORY</span></span><br><span class="line">            + <span class="string">","</span> + <span class="type">Constants</span>.<span class="type">CONFIGURATORS_CATEGORY</span></span><br><span class="line">            + <span class="string">","</span> + <span class="type">Constants</span>.<span class="type">ROUTERS_CATEGORY</span>));</span><br><span class="line">    return cluster.join(directory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">directory</span><span class="selector-class">.subscribe</span>(<span class="selector-tag">subscribeUrl</span><span class="selector-class">.addParameter</span>(<span class="selector-tag">Constants</span><span class="selector-class">.CATEGORY_KEY</span>,</span><br><span class="line">        <span class="selector-tag">Constants</span><span class="selector-class">.PROVIDERS_CATEGORY</span></span><br><span class="line">        + "," + <span class="selector-tag">Constants</span><span class="selector-class">.CONFIGURATORS_CATEGORY</span></span><br><span class="line">        + "," + <span class="selector-tag">Constants</span><span class="selector-class">.ROUTERS_CATEGORY</span>));</span><br></pre></td></tr></table></figure>
<p>url = zookeeper://127.0.0.1:2181/com.alibaba.dubbo.registry.RegistryService?application=dubbo-client&amp;dubbo=2.5.3&amp;owner=joey&amp;pid=57644&amp;refer=application%3Ddubbo-client%26dubbo%3D2.5.3%26interface%3Dcom.joey.hello.IhelloService%26methods%3DsayHello%26owner%3Djoey%26pid%3D57644%26side%3Dconsumer%26timestamp%3D1529844387888&amp;timestamp=1529844392952</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mock=com<span class="selector-class">.alibaba</span><span class="selector-class">.dubbo</span><span class="selector-class">.rpc</span><span class="selector-class">.cluster</span><span class="selector-class">.support</span><span class="selector-class">.wrapper</span><span class="selector-class">.MockClusterWrapper</span></span><br><span class="line">failover=com<span class="selector-class">.alibaba</span><span class="selector-class">.dubbo</span><span class="selector-class">.rpc</span><span class="selector-class">.cluster</span><span class="selector-class">.support</span><span class="selector-class">.FailoverCluster</span></span><br><span class="line">failfast=com<span class="selector-class">.alibaba</span><span class="selector-class">.dubbo</span><span class="selector-class">.rpc</span><span class="selector-class">.cluster</span><span class="selector-class">.support</span><span class="selector-class">.FailfastCluster</span></span><br><span class="line">failsafe=com<span class="selector-class">.alibaba</span><span class="selector-class">.dubbo</span><span class="selector-class">.rpc</span><span class="selector-class">.cluster</span><span class="selector-class">.support</span><span class="selector-class">.FailsafeCluster</span></span><br><span class="line">failback=com<span class="selector-class">.alibaba</span><span class="selector-class">.dubbo</span><span class="selector-class">.rpc</span><span class="selector-class">.cluster</span><span class="selector-class">.support</span><span class="selector-class">.FailbackCluster</span></span><br><span class="line">forking=com<span class="selector-class">.alibaba</span><span class="selector-class">.dubbo</span><span class="selector-class">.rpc</span><span class="selector-class">.cluster</span><span class="selector-class">.support</span><span class="selector-class">.ForkingCluster</span></span><br><span class="line">available=com<span class="selector-class">.alibaba</span><span class="selector-class">.dubbo</span><span class="selector-class">.rpc</span><span class="selector-class">.cluster</span><span class="selector-class">.support</span><span class="selector-class">.AvailableCluster</span></span><br><span class="line">mergeable=com<span class="selector-class">.alibaba</span><span class="selector-class">.dubbo</span><span class="selector-class">.rpc</span><span class="selector-class">.cluster</span><span class="selector-class">.support</span><span class="selector-class">.MergeableCluster</span></span><br><span class="line">broadcast=com<span class="selector-class">.alibaba</span><span class="selector-class">.dubbo</span><span class="selector-class">.rpc</span><span class="selector-class">.cluster</span><span class="selector-class">.support</span><span class="selector-class">.BroadcastCluster</span></span><br></pre></td></tr></table></figure>
<p>MockClusterWrapper存在MockClusterWrapper(Cluster cluster)，所以会将FailfastCluster等进行包装，是失败降级用的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MockClusterWrapper</span> <span class="keyword">implements</span> <span class="title">Cluster</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Cluster cluster;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MockClusterWrapper</span><span class="params">(Cluster cluster)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.cluster = cluster;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">join</span><span class="params">(Directory&lt;T&gt; directory)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> MockClusterInvoker&lt;T&gt;(directory,</span><br><span class="line">				<span class="keyword">this</span>.cluster.join(directory));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ProxyFactory$Adaptive</p>
<p>StubProxyFactoryWrapper存在构造函数，是wrapper，会把JavassistProxyFactory包装</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">StubProxyFactoryWrapper</span><span class="params">(ProxyFactory proxyFactory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.proxyFactory = proxyFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终还是JavassistProxyFactory</p>
<h2 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h2><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create Proxy class.</span></span><br><span class="line"><span class="keyword">String</span> fcn = Proxy.class.getName() + id;</span><br><span class="line">ccm = ClassGenerator.<span class="keyword">new</span><span class="type">Instance</span>(cl);</span><br><span class="line">ccm.setClassName(fcn);</span><br><span class="line">ccm.addDefaultConstructor();</span><br><span class="line">ccm.setSuperClass(Proxy.class);</span><br><span class="line">ccm.addMethod(<span class="string">"public Object newInstance("</span> + InvocationHandler.class.getName() + <span class="string">" h)&#123; return new "</span> + pcn + <span class="string">"($1); &#125;"</span>);</span><br><span class="line">Class&lt;?&gt; pc = ccm.toClass();</span><br><span class="line">proxy = (Proxy)pc.<span class="keyword">new</span><span class="type">Instance</span>();</span><br></pre></td></tr></table></figure>
<p> ccm method debug的结果</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> java.lang.<span class="keyword">String</span> sayHello(java.lang.<span class="keyword">String</span> arg0)&#123;</span><br><span class="line"><span class="keyword">Object</span>[] args = <span class="keyword">new</span> <span class="keyword">Object</span>[<span class="number">1</span>]; args[<span class="number">0</span>] = ($w)$<span class="number">1</span>;</span><br><span class="line"><span class="keyword">Object</span> ret = handler.invoke(<span class="keyword">this</span>, methods[<span class="number">0</span>], args);</span><br><span class="line"><span class="keyword">return</span> (java.lang.<span class="keyword">String</span>)ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> java.lang.<span class="keyword">Object</span> $echo(java.lang.<span class="keyword">Object</span> arg0)&#123;<span class="keyword">Object</span>[] args = <span class="keyword">new</span> <span class="keyword">Object</span>[<span class="number">1</span>]; args[<span class="number">0</span>] = ($w)$<span class="number">1</span>; <span class="keyword">Object</span> ret = handler.invoke(<span class="keyword">this</span>, methods[<span class="number">1</span>], args); <span class="keyword">return</span> (java.lang.<span class="keyword">Object</span>)ret;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Proxy0</li>
<li>hander</li>
<li>invoker :interface com.joey.hello.IhelloService -&gt; zookeeper://127.0.0.1:2181/com.alibaba.dubbo.registry.RegistryService?anyhost=true&amp;application=dubbo-client&amp;check=false&amp;dubbo=2.5.3&amp;interface=com.joey.hello.IhelloService&amp;methods=sayHello&amp;owner=joey&amp;pid=57718&amp;side=consumer&amp;timestamp=1529847722831,directory: com.alibaba.dubbo.registry.integration.RegistryDirectory@3cfdd820</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">List</span>&lt;URL&gt; urls = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">String</span> path : toCategoriesPath(url)) &#123;</span><br><span class="line">    ConcurrentMap&lt;NotifyListener, ChildListener&gt; listeners = zkListeners.<span class="keyword">get</span>(url);</span><br><span class="line">    <span class="keyword">if</span> (listeners == <span class="keyword">null</span>) &#123;</span><br><span class="line">        zkListeners.putIfAbsent(url, <span class="keyword">new</span> ConcurrentHashMap&lt;NotifyListener, ChildListener&gt;());</span><br><span class="line">        listeners = zkListeners.<span class="keyword">get</span>(url);</span><br><span class="line">    &#125;</span><br><span class="line">    ChildListener zkListener = listeners.<span class="keyword">get</span>(listener);</span><br><span class="line">    <span class="keyword">if</span> (zkListener == <span class="keyword">null</span>) &#123;</span><br><span class="line">        listeners.putIfAbsent(listener, <span class="keyword">new</span> ChildListener() &#123;</span><br><span class="line">            public <span class="keyword">void</span> childChanged(<span class="built_in">String</span> parentPath, <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; currentChilds) &#123;</span><br><span class="line">            	ZookeeperRegistry.<span class="keyword">this</span>.notify(url, listener, toUrlsWithEmpty(url, parentPath, currentChilds));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        zkListener = listeners.<span class="keyword">get</span>(listener);</span><br><span class="line">    &#125;</span><br><span class="line">    zkClient.create(path, <span class="keyword">false</span>);</span><br><span class="line">    <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; children = zkClient.addChildListener(path, zkListener);</span><br><span class="line">    <span class="keyword">if</span> (children != <span class="keyword">null</span>) &#123;</span><br><span class="line">    	urls.addAll(toUrlsWithEmpty(url, path, children));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">notify(url, listener, urls);</span><br></pre></td></tr></table></figure>
<h2 id="AbstractRegistry"><a href="#AbstractRegistry" class="headerlink" title="AbstractRegistry"></a>AbstractRegistry</h2><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Map.<span class="keyword">Entry</span>&lt;String, List&lt;URL&gt;&gt; <span class="keyword">entry</span> : <span class="type">result.entrySet</span>()) &#123;</span><br><span class="line">    String category = <span class="keyword">entry</span>.getKey();</span><br><span class="line">    List&lt;URL&gt; categoryList = <span class="keyword">entry</span>.getValue();</span><br><span class="line">    categoryNotified.put(category, categoryList);</span><br><span class="line">    saveProperties(url);</span><br><span class="line">    listener.notify(categoryList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据invokerURL列表转换为invoker列表。转换规则如下：</span></span><br><span class="line"><span class="comment"> * 1.如果url已经被转换为invoker，则不在重新引用，直接从缓存中获取，注意如果url中任何一个参数变更也会重新引用</span></span><br><span class="line"><span class="comment"> * 2.如果传入的invoker列表不为空，则表示最新的invoker列表</span></span><br><span class="line"><span class="comment"> * 3.如果传入的invokerUrl列表是空，则表示只是下发的override规则或route规则，需要重新交叉对比，决定是否需要重新引用。</span></span><br><span class="line"><span class="comment"> * @param invokerUrls 传入的参数不能为null</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> void refreshInvoker(List&lt;URL&gt; invokerUrls)&#123;</span><br><span class="line">    <span class="keyword">if</span> (invokerUrls != <span class="literal">null</span> &amp;&amp; invokerUrls.size() == <span class="number">1</span> &amp;&amp; invokerUrls.<span class="keyword">get</span>(<span class="number">0</span>) != <span class="literal">null</span></span><br><span class="line">            &amp;&amp; Constants.EMPTY_PROTOCOL.equals(invokerUrls.<span class="keyword">get</span>(<span class="number">0</span>).getProtocol())) &#123;</span><br><span class="line">        <span class="built_in">this</span>.forbidden = <span class="literal">true</span>; <span class="comment">// 禁止访问</span></span><br><span class="line">        <span class="built_in">this</span>.methodInvokerMap = <span class="literal">null</span>; <span class="comment">// 置空列表</span></span><br><span class="line">        destroyAllInvokers(); <span class="comment">// 关闭所有Invoker</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.forbidden = <span class="literal">false</span>; <span class="comment">// 允许访问</span></span><br><span class="line">        Map&lt;<span class="keyword">String</span>, Invoker&lt;T&gt;&gt; oldUrlInvokerMap = <span class="built_in">this</span>.urlInvokerMap; <span class="comment">// local reference</span></span><br><span class="line">        <span class="keyword">if</span> (invokerUrls.size() == <span class="number">0</span> &amp;&amp; <span class="built_in">this</span>.cachedInvokerUrls != <span class="literal">null</span>)&#123;</span><br><span class="line">            invokerUrls.addAll(<span class="built_in">this</span>.cachedInvokerUrls);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.cachedInvokerUrls = <span class="keyword">new</span> <span class="type">HashSet</span>&lt;URL&gt;();</span><br><span class="line">            <span class="built_in">this</span>.cachedInvokerUrls.addAll(invokerUrls);<span class="comment">//缓存invokerUrls列表，便于交叉对比</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (invokerUrls.size() ==<span class="number">0</span> )&#123;</span><br><span class="line">        	<span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;<span class="keyword">String</span>, Invoker&lt;T&gt;&gt; <span class="keyword">new</span><span class="type">UrlInvokerMap</span> = toInvokers(invokerUrls) ;<span class="comment">// 将URL列表转成Invoker列表</span></span><br><span class="line">        Map&lt;<span class="keyword">String</span>, List&lt;Invoker&lt;T&gt;&gt;&gt; <span class="keyword">new</span><span class="type">MethodInvokerMap</span> = toMethodInvokers(<span class="keyword">new</span><span class="type">UrlInvokerMap</span>); <span class="comment">// 换方法名映射Invoker列表</span></span><br><span class="line">        <span class="comment">// state change</span></span><br><span class="line">        <span class="comment">//如果计算错误，则不进行处理.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span><span class="type">UrlInvokerMap</span> == <span class="literal">null</span> || <span class="keyword">new</span><span class="type">UrlInvokerMap</span>.size() == <span class="number">0</span> )&#123;</span><br><span class="line">            logger.error(<span class="keyword">new</span> <span class="type">IllegalStateException</span>(<span class="string">"urls to invokers error .invokerUrls.size :"</span>+invokerUrls.size() + <span class="string">", invoker.size :0. urls :"</span>+invokerUrls.toString()));</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.methodInvokerMap = multiGroup ? toMergeMethodInvokerMap(<span class="keyword">new</span><span class="type">MethodInvokerMap</span>) : <span class="type">newMethodInvokerMap</span>;</span><br><span class="line">        <span class="built_in">this</span>.urlInvokerMap = <span class="keyword">new</span><span class="type">UrlInvokerMap</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            destroyUnusedInvokers(oldUrlInvokerMap,<span class="keyword">new</span><span class="type">UrlInvokerMap</span>); <span class="comment">// 关闭未使用的Invoker</span></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.warn(<span class="string">"destroyUnusedInvokers error. "</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>filter(listener(dubboProtocol))</p>
<p>DubboProtocol</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public <span class="params">&lt;T&gt;</span> Invoker<span class="params">&lt;T&gt;</span> refer(Class<span class="params">&lt;T&gt;</span> serviceType, URL url) throws <span class="class">RpcException </span>&#123;</span><br><span class="line">    <span class="comment">// create rpc invoker.</span></span><br><span class="line">    DubboInvoker<span class="params">&lt;T&gt;</span> invoker = new DubboInvoker<span class="params">&lt;T&gt;</span>(serviceType, url, getClients(url), invokers);</span><br><span class="line">    invokers.add(invoker);</span><br><span class="line">    return invoker;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;<span class="keyword">String</span>, Invoker&lt;T&gt;&gt; <span class="keyword">new</span><span class="type">UrlInvokerMap</span> = toInvokers(invokerUrls) ;<span class="comment">// 将URL列表转成Invoker列表</span></span><br><span class="line">Map&lt;<span class="keyword">String</span>, List&lt;Invoker&lt;T&gt;&gt;&gt; <span class="keyword">new</span><span class="type">MethodInvokerMap</span> = toMethodInvokers(<span class="keyword">new</span><span class="type">UrlInvokerMap</span>); <span class="comment">// 换方法名映射Invoker列表</span></span><br></pre></td></tr></table></figure>
<p>MockClusterInvoker invoke -&gt;</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">MockClusterInvoker</span></span><br></pre></td></tr></table></figure>
<h1 id="4-dubbo-SPI机制"><a href="#4-dubbo-SPI机制" class="headerlink" title="4.dubbo SPI机制"></a>4.dubbo SPI机制</h1><p>大部分的思想都是和 SPI 是一样，只是下面两个地方有差 异。</p>
<ol>
<li>需要在 resource 目录下配置 META-INF/dubbo 或者 META-INF/dubbo/internal 或者 META-INF/services，并基 于 SPI 接口去创建一个文件</li>
<li>文件名称和接口名称保持一致，文件内容和 SPI 有差异， 内容是 KEY 对应 Value</li>
<li>如果类没有<code>Adaptive</code>注解，比如<code>SpringExtensionFactory</code>，不存在（ExtensionFactory）的构造函数，走catch的逻辑，<code>spring=com.alibaba.dubbo.config.spring.extension.SpringExtensionFactory</code>，最后分别向<code>cachedNames</code>和<code>extensionClasses</code>存入key value : 字符串spring和SpringExtensionFactory的class字节码。</li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Dubbo/" rel="tag"># Dubbo</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/06/21/TCP协议详解/" rel="next" title="TCP协议详解">
                <i class="fa fa-chevron-left"></i> TCP协议详解
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/06/24/Dubbo源码分析之服务发布过程/" rel="prev" title="Dubbo源码分析之服务发布过程">
                Dubbo源码分析之服务发布过程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/xiaowu_avatar.jpg"
                alt="周小伍 Joey" />
            
              <p class="site-author-name" itemprop="name">周小伍 Joey</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">150</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">43</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-相关注解"><span class="nav-number">1.</span> <span class="nav-text">1. 相关注解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SPI"><span class="nav-number">1.1.</span> <span class="nav-text">SPI</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Adaptive"><span class="nav-number">1.2.</span> <span class="nav-text">Adaptive</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Activate"><span class="nav-number">1.3.</span> <span class="nav-text">Activate</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-getAdaptiveExtension获取自适应的扩展点流程"><span class="nav-number">2.</span> <span class="nav-text">2. getAdaptiveExtension获取自适应的扩展点流程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#时序图如下："><span class="nav-number">2.1.</span> <span class="nav-text">时序图如下：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getExtensionLoader"><span class="nav-number">2.2.</span> <span class="nav-text">getExtensionLoader</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getAdaptiveExtension"><span class="nav-number">2.3.</span> <span class="nav-text">getAdaptiveExtension</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createAdaptiveExtension"><span class="nav-number">2.4.</span> <span class="nav-text">createAdaptiveExtension</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getAdaptiveExtensionClass"><span class="nav-number">2.5.</span> <span class="nav-text">getAdaptiveExtensionClass</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createAdaptiveExtensionClass"><span class="nav-number">2.6.</span> <span class="nav-text">createAdaptiveExtensionClass</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getExtensionClasses"><span class="nav-number">2.7.</span> <span class="nav-text">getExtensionClasses</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#loadExtensionClasses"><span class="nav-number">2.8.</span> <span class="nav-text">loadExtensionClasses</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Adaptive注解在类上"><span class="nav-number">2.8.1.</span> <span class="nav-text">1.Adaptive注解在类上</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-类没有Adaptive注解"><span class="nav-number">2.8.2.</span> <span class="nav-text">2.类没有Adaptive注解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-存在构造函数"><span class="nav-number">2.8.3.</span> <span class="nav-text">3.存在构造函数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-ExtensionFactory"><span class="nav-number">3.</span> <span class="nav-text">3. ExtensionFactory</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Proxy"><span class="nav-number">3.1.</span> <span class="nav-text">Proxy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AbstractRegistry"><span class="nav-number">3.2.</span> <span class="nav-text">AbstractRegistry</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-dubbo-SPI机制"><span class="nav-number">4.</span> <span class="nav-text">4.dubbo SPI机制</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">周小伍 Joey</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">270.1k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    
      <script id="dsq-count-scr" src="https://joeyblog.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://yoursite.com/2018/06/24/Dubbo源码分析之ExtensionLoader动态扩展/';
          this.page.identifier = '2018/06/24/Dubbo源码分析之ExtensionLoader动态扩展/';
          this.page.title = 'Dubbo源码分析之ExtensionLoader动态扩展';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://joeyblog.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  










  





  

  

  

  

  

  

</body>
</html>
